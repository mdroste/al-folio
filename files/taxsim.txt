c                                                                               
c  main subroutine statax                                                       
c                                                                               
      subroutine statax(data,lawyr,comnew)                                      
      implicit double precision (A-H,O-Z)                                       
      parameter(lastat=2021)                                                    
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common /xndxac/ xndxa(1981:2023)                                          
      dimension data(255),comnew(255)                                           
      dimension ds(255),coms(255)                                               
c DO NOT FORGET TO UPDATE parameter(lastat=2021) EVERY YEAR                     
      agi=0.                                                                    
      exemp =0.                                                                 
      stded =0.                                                                 
      xitded=0.                                                                 
      taxinc=0.                                                                 
      pcred =0.                                                                 
      chcr  =0.                                                                 
      earncr=0.                                                                 
      credit=0.                                                                 
      stax=0.                                                                   
      rt=0.                                                                     
      hy=data(159)                                                              
      rent=data(160)                                                            
      comnew(74)=0.                                                             
      id=int(abs(data(6)))                                                           
                                                                                
      if(id.le.0.or.id.gt.51) return                                            
                                                                                
      if(lawyr.lt.1977) then                                                    
        write(0,*) 'State Tax Calculator available for years 1977+'              
        return                                                                   
      endif                                                                     
                                                                                
      if(lawyr.eq.-99) then                                                     
         lawyr=lastat                                                           
         return                                                                 
      endif                                                                     
                                                                                
      flate = 1.                                                                
      law = lawyr                                                               
      if(extnd(21).gt.0) law = int(extnd(21))                                        
      if(law.gt.lastat) then                                                    
        flate = xndxa(law)/xndxa(lastat)                                        
        law = lastat                                                            
      endif                                                                     
                                                                                
                                                                                
      do 100 i=1,255                                                            
         ds(i) = data(i)                                                        
         coms(i) = comnew(i)                                                    
100   continue                                                                  
                                                                                
      do 200 i=11,99                                                            
         ds(i) = data(i)/flate                                                  
         ds(i+100) = data(i+100)/flate                                          
200   continue                                                                  
      do 300 i=1,98                                                             
         if(i.ne.26.and.i.ne.65.and.i.ne.72.and.i.ne.73)                        
     &   coms(i) = comnew(i)/flate                                              
300   continue                                                                  
                                                                                
                                                                                
      go to (1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,                
     @  21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,            
     @  41,42,43,44,45,46,47,48,49,50,51),id                                    
    1 continue                                                                  
      call altax(ds,coms,stax,law)                                              
      go to 80                                                                  
    2 continue                                                                  
      call aktax(ds,coms,stax,law)                                              
      go to 80                                                                  
    3 continue                                                                  
      call aztax(ds,coms,stax,law)                                              
      go to 80                                                                  
    4 continue                                                                  
      call artax(ds,coms,stax,law)                                              
      go to 80                                                                  
    5 continue                                                                  
      call catax(ds,coms,stax,law)                                              
      go to 80                                                                  
    6 continue                                                                  
      call cotax(ds,coms,stax,law)                                              
      go to 80                                                                  
    7 continue                                                                  
      call cttax(ds,coms,stax,law)                                              
      go to 80                                                                  
    8 continue                                                                  
      call detax(ds,coms,stax,law)                                              
      go to 80                                                                  
    9 continue                                                                  
      call dctax(ds,coms,stax,law)                                              
      go to 80                                                                  
   10 continue                                                                  
      go to 80                                                                  
   11 continue                                                                  
      call gatax(ds,coms,stax,law)                                              
      go to 80                                                                  
   12 continue                                                                  
      call hitax(ds,coms,stax,law)                                              
      go to 80                                                                  
   13 continue                                                                  
      call idtax(ds,coms,stax,law)                                              
      go to 80                                                                  
   14 continue                                                                  
      call iltax(ds,coms,stax,law)                                              
      go to 80                                                                  
   15 continue                                                                  
      call intax(ds,coms,stax,law)                                              
      go to 80                                                                  
   16 continue                                                                  
      call iatax(ds,coms,stax,law)                                              
      go to 80                                                                  
   17 continue                                                                  
      call kstax(ds,coms,stax,law)                                              
      go to 80                                                                  
   18 continue                                                                  
      call kytax(ds,coms,stax,law)                                              
      go to 80                                                                  
   19 continue                                                                  
      call latax(ds,coms,stax,law)                                              
      go to 80                                                                  
   20 continue                                                                  
      call metax(ds,coms,stax,law)                                              
      go to 80                                                                  
   21 continue                                                                  
      call mdtax(ds,coms,stax,law)                                              
      go to 80                                                                  
   22 continue                                                                  
      call matax(ds,coms,stax,law)                                              
      go to 80                                                                  
   23 continue                                                                  
      call mitax(ds,coms,stax,law)                                              
      go to 80                                                                  
   24 continue                                                                  
      call mntax(ds,coms,stax,law)                                              
      go to 80                                                                  
   25 continue                                                                  
      call mstax(ds,coms,stax,law)                                              
      go to 80                                                                  
   26 continue                                                                  
      call motax(ds,coms,stax,law)                                              
      go to 80                                                                  
   27 continue                                                                  
      call mttax(ds,coms,stax,law)                                              
      go to 80                                                                  
   28 continue                                                                  
      call netax(ds,coms,stax,law)                                              
      go to 80                                                                  
   29 continue                                                                  
      goto 80                                                                   
   30 continue                                                                  
      call nhtax(ds,coms,stax,law)                                              
      go to 80                                                                  
   31 continue                                                                  
      call njtax(ds,coms,stax,law)                                              
      go to 80                                                                  
   32 continue                                                                  
      call nmtax(ds,coms,stax,law)                                              
      go to 80                                                                  
   33 continue                                                                  
      call nytax(ds,coms,stax,law)                                              
      go to 80                                                                  
   34 continue                                                                  
      call nctax(ds,coms,stax,law)                                              
      go to 80                                                                  
   35 continue                                                                  
      call ndtax(ds,coms,stax,law)                                              
      go to 80                                                                  
   36 continue                                                                  
      call ohtax(ds,coms,stax,law)                                              
      go to 80                                                                  
   37 continue                                                                  
      call oktax(ds,coms,stax,law)                                              
      go to 80                                                                  
   38 continue                                                                  
      call ortax(ds,coms,stax,law)                                              
      go to 80                                                                  
   39 continue                                                                  
      call patax(ds,coms,stax,law)                                              
      go to 80                                                                  
   40 continue                                                                  
      call ritax(ds,coms,stax,law)                                              
      go to 80                                                                  
   41 continue                                                                  
      call sctax(ds,coms,stax,law)                                              
      go to 80                                                                  
   42 continue                                                                  
      goto 80                                                                   
   43 continue                                                                  
      call tntax(ds,coms,stax,law)                                              
      goto 80                                                                   
   44 continue                                                                  
      go to 80                                                                  
   45 continue                                                                  
      call uttax(ds,coms,stax,law)                                              
      go to 80                                                                  
   46 continue                                                                  
      call vttax(ds,coms,stax,law)                                              
      go to 80                                                                  
   47 continue                                                                  
      call vatax(ds,coms,stax,law)                                              
      go to 80                                                                  
   48 continue                                                                  
      goto 80                                                                   
   49 continue                                                                  
      call wvtax(ds,coms,stax,law)                                              
      go to 80                                                                  
   50 continue                                                                  
      call witax(ds,coms,stax,law)                                              
      go to 80                                                                  
   51 continue                                                                  
   80 continue                                                                  
      comnew(74) = stax*flate                                                   
      return                                                                    
      end                                                                       
c                                                                               
c  Subroutines from Statutil                                                    
c                                                                               
      double precision function socsec(data,comnew,law)                         
      implicit double precision (A-H,O-Z)                                       
      dimension data(255),comnew(255),rate(1977:2025),ceil(1977:2029)           
      data rate                                                                 
     *      /      .0585d0,.0605d0,.0613d0,.0613d0,                             
     *     .0665d0,.0670d0,.0670d0,.0700d0,.0705d0,                             
     *     .0715d0,.0715d0,.0751d0,.0751d0,21*.0765d0,                          
     *       2*.0565d0,13*.0765d0/                                              
      data ceil                                                                 
     *     /       16500.d0, 17700.d0, 22900.d0, 25900.d0,                      
     *   29700.d0, 32400.d0, 35700.d0, 37800.d0, 39600.d0,                      
     *   42000.d0, 43800.d0, 45000.d0, 48000.d0, 51300.d0,                      
     *   53400.d0, 55500.d0, 57600.d0, 60600.d0, 61200.d0,                      
     *   62700.d0, 65400.d0, 68400.d0, 72600.d0, 76200.d0,                      
     *   80400.d0, 84900.d0, 87000.d0, 87900.d0, 90000.d0,                      
     *   94200.d0, 97500.d0,102000.d0,106800.d0,106800.d0,                      
     *  106800.d0,110100.d0,113700.d0,117000.d0,118500.d0,                      
     *  118500.d0,127200.d0,128700.d0,132900.d0,137700.d0,                      
     *  142800.d0,147000.d0,153600.d0,159300.d0,165300.d0,                      
     *  171300.d0,177300.d0,183600.d0,190200.d0/                                
c actual amounts through 2022 (03.21.2022)                                      
      mst = int(data(2))                                                             
      if(mst.eq.2) then                                                         
         fica =  (min(data(85),ceil(law))+min(data(86),ceil(law)))*             
     &              rate(law)                                                   
         if(data(85).gt.ceil(law))                                              
     &   fica = fica + (data(85)-ceil(law))*.0145                               
         if(data(86).gt.ceil(law))                                              
     &   fica = fica + (data(86)-ceil(law))*.0145                               
      else                                                                      
         fica = min(data(11),ceil(law))*rate(law)                               
         if(data(11).gt.ceil(law))                                              
     &   fica = fica + (data(11)-ceil(law))*.0145                               
      endif                                                                     
c      socsec =  fica + data(43)+data(44)                                       
c c175 = setax in sstax                                                         
       socsec =  fica + comnew(175)+data(44)                                    
c Additional 0.9% Medicare Tax on Earned Income                                 
       if(law.ge.2013) socsec = socsec + comnew(180)                            
      return                                                                    
      end                                                                       
                                                                                
      double precision function xjobs(data,law)                                 
      implicit double precision (A-H,O-Z)                                       
      dimension data(100),rate1(1977:1994),rate2(1977:1994)                     
      data rate1/10*.5d0,3*.4d0,5*0.0d0/                                        
      data rate2/10*.25d0,8*0.0d0/                                              
      amt1=0.                                                                   
      amt2=0.                                                                   
      xjobs=0.                                                                  
      if(law.le.1986) then                                                      
          amt1=data(37)*2/3                                                     
          amt2=amt1/2                                                           
          xjobs=min(12000.0d0,(amt1/rate1(law))+(amt2/rate2(law)))              
      elseif(law.ge.1987.and.law.le.1989) then                                  
          amt1=data(37)                                                         
          amt2=0.                                                               
          xjobs=min(6000.0d0,(amt1/rate1(law)))                                 
      elseif(law.ge.1990) then                                                  
          xjobs=0.                                                              
      endif                                                                     
      return                                                                    
      end                                                                       
c                                                                               
      subroutine look(table,y,ntab,n,statax,aif,data2,rt,data)                  
      implicit double precision (A-H,O-Z)                                       
      common/times/z,p,txrate,h                                                 
      dimension table(2,ntab),data(255)                                         
      integer d2,d209                                                           
      d209 = int(data(209))                                                          
      d2 = int(data2)                                                                
c negative data2 is signal that separate filing is allowed.                     
      h=0.                                                                      
c     ntab=25                                                                   
      call look2(table,y,ntab,n,statax,aif,dabs(data2),rt,data)                 
      if(d2.eq.-2) then                                                         
         yh= max(data(85),data(86))+(y-data(11))/2.                             
         yw=y-yh                                                                
         h=2                                                                    
         call look2(table,yw,ntab,n,taxw,aif,1.0d0,rt,data)                     
         h=1                                                                    
         call look2(table,yh,ntab,n,taxh,aif,1.0d0,rt,data)                     
         if(taxw+taxh.gt.statax.and.d209.eq.2) then                             
c91234 write(*,*) 'should not file jointly',data(6),data(100),data(101)         
           continue                                                             
         endif                                                                  
         statax=min(statax,taxw+taxh)                                           
      endif                                                                     
      return                                                                    
      end                                                                       
                                                                                
      subroutine look2(table,y,ntab,n,statax,aif,data2,rt,data)                 
      implicit double precision (A-H,O-Z)                                       
c aif=annual inflation factor if indexed,otherwise 1.                           
      common/times/z,p,txrate,h                                                 
      common/x/ct                                                               
c data2=marital status if joint filing is allowed,otherwise 0.                  
      dimension table(2,ntab),data(255)                                         
      integer d2                                                                
      d2 = int(data2)                                                                
                                                                                
c This line is in here to avoid unused variable errors                          
      if(d2.eq.543) then                                                        
         write(0,*) n,'unused var'                                                 
      continue                                                                  
      endif                                                                     
      ajnt=1.                                                                   
      if(d2.eq.2.or.d2.eq.5)ajnt=2                                              
      y1=max(y/aif/ajnt,0.0d0)                                                  
      statax=0.                                                                 
      rt=0.                                                                     
      yleft=y1                                                                  
      rate=table(2,1)/100.                                                      
      if(y1.lt.table(1,1)) goto 99                                              
      statax=table(1,1)*table(2,1)/100.                                         
      do 10 i=2,ntab                                                            
       if(table(1,i).lt.table(1,i-1).or.table(2,i).lt..1) then                  
        if(table(2,i).gt.0) then                                                
          d101 = data(101)                                                      
          d100 = data(100)                                                      
          write(0,2) 'in look2',                                                    
     & table(1,i),table(1,i-1),table(2,i),d101,data(6),d100                     
        endif                                                                   
       endif                                                                    
       yleft=y1-table(1,i-1)                                                    
       rate=table(2,i)/100.                                                     
           if(y1.lt.table(1,i)) goto 99                                         
           statax=statax+(table(1,i)-table(1,i-1))*rate                         
c1     format(1x,8f8.2)                                                         
c2     format(' error in look2:',3f8.2,f6.0,f4.0,f12.0)                         
2     format(3f8.2,f6.0,f4.0,f12.0)                                             
10    continue                                                                  
      yleft=y1-table(1,ntab)                                                    
99    continue                                                                  
      statax=aif*ajnt*(yleft*rate+statax)                                       
c     calculating marginal tax rate                                             
      rt=rate                                                                   
c      if(ct.eq.1) then                                                         
c        write(*,*)                                                             
c      endif                                                                    
      return                                                                    
      end                                                                       
      double precision function disap(y,alow,ahigh)                             
      implicit double precision (A-H,O-Z)                                       
      if(ahigh.le.alow) then                                                    
         write(6,100) 'in disap',alow,ahigh                                        
      continue                                                                  
      endif                                                                     
100   format(' error in disap',2g12.5)                                          
      disap=1.-min(max(((y-alow)/ahigh-alow),0.0d0),1.0d0)                      
      return                                                                    
      end                                                                       
      double precision function xif(logic,real)                                 
      implicit double precision (A-H,O-Z)                                       
      logical logic                                                             
      xif=0.                                                                    
      if(logic) xif=real                                                        
      return                                                                    
      end                                                                       
                                                                                
      double precision function tablk(table,n,y,data)                           
      implicit double precision (A-H,O-Z)                                       
      dimension table(2,n),data(100)                                            
      do 200 j=1,n                                                              
      num=j                                                                     
      if(j+1.ge.n) goto 2                                                       
      if(table(1,j+1).le.table(1,j)) then                                       
        write(6,100)table(1,j),table(1,j+1),data(6)                               
      endif                                                                     
100   format(' error in tablk',3g12.5)                                          
   2  if(y.lt.table(1,j)) go to 210                                             
  200 continue                                                                  
      tablk=0.                                                                  
  210 tablk=table(2,num)                                                        
      return                                                                    
      end                                                                       
                                                                                
      double precision function tablki(table,n,y,data)                          
      implicit double precision (A-H,O-Z)                                       
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      dimension table(2,n),data(100)                                            
      do 200 j=1,n                                                              
      num=j                                                                     
      if(j+1.ge.n) goto 2                                                       
      if(table(1,j+1).le.table(1,j)) then                                       
        write(6,100) ' in tablki',table(1,j),table(1,j+1),data(6)                 
      endif                                                                     
  100 format(' error in tablki',3g12.5)                                         
   2  if(y.lt.table(1,j)) go to 210                                             
  200 continue                                                                  
  210 if(num.eq.1) then                                                         
         tablki = table(2,num)                                                  
      else if(num.lt.n) then                                                    
         w = (y-table(1,num-1))/(table(1,num)-table(1,num-1))                   
         if(table(2,num).gt.table(2,num-1)) then                                
           tablki = w*table(2,num-1) + (1-w)*table(2,num)                       
         else                                                                   
           tablki = w*table(2,num) + (1-w)*table(2,num-1)                       
         endif                                                                  
      else if(num.eq.n) then                                                    
         tablki=table(2,num)                                                    
      endif                                                                     
      if(extnd(88).gt.0.d0) tablki = table(2,num)                               
      return                                                                    
      end                                                                       
                                                                                
      function lastk()                                                          
      implicit double precision (A-H,O-Z)                                       
      lastk=13                                                                  
      return                                                                    
      end                                                                       
      double precision function sorm(mart,a,b)                                  
      implicit double precision (A-H,O-Z)                                       
c     this soubroutine determines married or single status                      
      sorm=a                                                                    
      if(mart.eq.2.or.mart.eq.3.or.mart.eq.6)sORM=b                             
      return                                                                    
      end                                                                       
                                                                                
      block data inpc87                                                         
      implicit double precision (A-H,O-Z)                                       
      common/pce96/gnpd(1973:1999)                                              
      data gnpd                                                                 
     * /        34.02d0,36.96d0, 40.37d0, 42.79d0, 45.59d0, 48.75d0,            
     *  52.70d0,57.38d0,62.70d0, 66.51d0, 69.24d0, 71.80d0, 74.05d0,            
     *  75.66d0,77.84d0,80.46d0, 83.56d0, 86.83d0, 89.76d0, 91.70d0,            
     *  94.16d0,96.14d0,98.19d0,100.00d0,101.66d0,102.86d0,104.37d0/            
      end                                                                       
c                                                                               
      double precision function keoles(data,comnew,lawyr)                       
      implicit double precision (A-H,O-Z)                                       
c     adjusts keogh deductions to requested year levels                         
      dimension data(255),comnew(255)                                           
      double precision keogh, kghmax,kghlim                                     
      kghmax = 7500.                                                            
      if (lawyr.eq.1982.or.lawyr.eq.1983) kghmax = 15000.                       
      if (lawyr.ge.1984) kghmax = 30000.                                        
      bus = data(17)+data(75)+data(79)-data(80)                                 
      retlim = max(0.0d0,.15*bus)                                               
      kghlim = min(retlim,kghmax)                                               
      keogh = min(data(28),kghlim)                                              
      keoles=max(0.0d0,comnew(14)-keogh)                                        
      return                                                                    
      end                                                                       
c                                                                               
      double precision function irales(data,comnew,lawyr)                       
      implicit double precision (A-H,O-Z)                                       
c     adjusts ira deductions tp requested year levels                           
      dimension data(255),comnew(255)                                           
      double precision iramax, iralim, ira                                           
      integer sep                                                               
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      iramax = 3000.d0/sep                                                      
      if (lawyr.ge.1981) iramax = 4000.d0/sep                                   
      if(mst.eq.1.or.mst.eq.4.or.mst.eq.7)iramax = iramax/2.                    
      bus = data(17)+data(75)+data(79)-data(80)                                 
      busnet = max(0.0d0,bus-comnew(14))                                        
      iralim = min(data(11)+busnet,iramax)                                      
      ira = min(data(29),iralim)                                                
      irales=max(0.0d0,comnew(12)-ira)                                          
      return                                                                    
      end                                                                       
c                                                                               
      double precision function divexc(data,comnew,law)                         
      implicit double precision (A-H,O-Z)                                       
c     computes the amount of the federal div (int) excl                         
      dimension data(255), comnew(255)                                          
      divexc=0.                                                                 
      diff=0.                                                                   
      if(law.ne.1981) diff= data(12) - comnew(4)                                
      if(law.eq.1981) diff= data(12) + data(14) - comnew(4)                     
c3     format(' error in divexc, year:',i5,'divs:',f8.0,'int:',f8.0,            
c     + 'divs net of exc (from fed prg):',f8.0)                                 
      divexc=diff                                                               
      return                                                                    
      end                                                                       
c                                                                               
      double precision function disab(data,comnew,law)                          
      implicit double precision (A-H,O-Z)                                       
c     computes amount of federal disability exclusion                           
      dimension data(255),comnew(255)                                           
      disab=0.                                                                  
      if(law.ge.1981.and.law.le.1985) then                                      
           disab=data(25)                                                       
        else                                                                    
           disab=max(0.0d0,data(25)-comnew(16))                                 
      endif                                                                     
      return                                                                    
      end                                                                       
c                                                                               
      double precision function trent(foreac,diff,                              
     & starty,stamnt,sign,tabby,tmax)                                           
      implicit double precision (A-H,O-Z)                                       
      integer sign                                                              
      trent=0.                                                                  
      over=max(0.0d0,tabby-starty)                                              
      if(over.gt.0) then                                                        
         trent=stamnt                                                           
         iplus=int(over/foreac)                                                
         if(sign.eq.1)trent=trent+(iplus*diff)                                  
         if(sign.eq.-1)trent=trent-(iplus*diff)                                 
         trent=max(0.0d0,min(trent,tmax))                                       
      endif                                                                     
      return                                                                    
      end                                                                       
c                                                                               
c                                                                               
      double precision function renter(data,comnew)                             
      implicit double precision (A-H,O-Z)                                       
c     determines whether a return with no property tax is likely to             
c     pay rent                                                                  
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255), comnew(255)                                          
      renter=0.                                                                 
c      agi=max(0.0d0,comnew(2))                                                 
      y=data(11)+data(23)                                                       
      y=y+comnew(84)                                                            
      if(data(51).lt.1.and.data(160).gt.0.) renter=1.                           
      return                                                                    
      end                                                                       
c  ALABAMA                                                                      
c  State 01                                                                      
c  Updated through 2021                                                         
      subroutine altax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
c     common/opts/intnet                                                        
      common/newshr/ cala(255)                                                  
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension tab(2,4),tab82(2,3)                                             
c     tab arrays hold data on tax increments and rates                          
      dimension data(255), comnew(255)                                          
      data tab /1000.0d0,1.5d0,3000.0d0,3.0d0,5000.0d0,4.5d0,                   
     & 1.e20,5.0d0/                                                             
      data tab82/500.0d0, 2.0d0, 3000.0d0, 4.0d0, 1.e20, 5.0d0/                 
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      ided = int(data(4))                                                            
c AGI                                                                           
c no dividend exclusion                                                         
c Unemployment income is exempt from state taxes                                
c state tax refund is not taxable                                               
      agi=comnew(2)+divexc(data,comnew,law)-comnew(78)-data(22)                 
c      if(law.eq.2011.or.law.eq.2012) then                                      
c         if(data(43).le.14204.) then                                           
c           agi = agi + .5751*(data(43)+data(44))                               
c          else                                                                 
c          agi = agi + .5*(data(43)+data(44)) + 1067                            
c         endif                                                                 
c      else                                                                     
c         agi = agi + .5*(data(43)+data(44))                                    
c      endif                                                                    
      if(law.eq.2011.or.law.eq.2012) then                                       
         if(comnew(175).le.14204.) then                                         
           agi = agi + .5751*(comnew(175)+data(44))                             
          else                                                                  
           agi = agi + .5*(comnew(175)+data(44)) + 1067                         
          endif                                                                 
      else                                                                      
         agi = agi + .5*(comnew(175)+data(44))                                  
      endif                                                                     
c The Capital Gains are treated similar to Federal Taxes,                       
c except that all gains are taxable and all losses are deductible in the year in
      if(comnew(6).lt.0) agi = agi + comnew(5) - comnew(6)                      
      if(law.le.1981) then                                                      
        alimon=data(23)+data(62)                                                
        agi=agi-alimon                                                          
        agi=agi+comnew(12)+comnew(14)                                           
      endif                                                                     
      if(law.ge.1982.and.law.le.1986) agi=agi+comnew(32)                        
c All social security income is exempt from state taxes                         
      if(law.ge.1984)agi=agi-comnew(79)                                         
      if(law.ge.1987) agi=agi-data(26)                                          
      if(law.le.1981) then                                                      
        stded=twn(.1*agi,0.0d0,data(7)*1000.d0)                                 
      else if(law.ge.1982.and.law.le.2006) then                                 
        stded=twn(.2*agi,0.0d0,data(7)*2000.d0)                                 
      else if(law.ge.2007) then                                                 
c New Standard Deduction since 2007                                             
        if(law.le.2018) then                                                    
          agimin = 20500.d0/sep                                                 
          agimax = 30000.d0/sep                                                 
        else                                                                    
          agimin = 23500.d0/sep                                                 
          agimax = 33000.d0/sep                                                 
        endif                                                                   
        stmin = 2000.d0*data(7)                                                 
        if(mst.eq.1) then                                                       
           stmax = 2500.d0                                                      
        else if(mst.eq.4.or.mst.eq.7) then                                      
           stmax = 4700.d0                                                      
        else                                                                    
           stmax = 7500.d0/sep                                                  
        endif                                                                   
        excess = max(0.d0,agi-agimin)                                           
c tga - tangens of the angle                                                    
        tga = (stmax-stmin)/(agimax-agimin)                                     
        stded = max(stmin,stmax-excess*tga)                                     
        stded = stmax - min(excess,agimax-agimin)*tga                           
      endif                                                                     
c XITDED                                                                        
      ag=max(0.0d0,agi)                                                         
      if(law.le.1982) then                                                      
        xitded = data(56)+data(57)+comnew(23)+data(61)                          
     &  +max(0.0d0,data(63)-.02*ag)+data(66)                                    
      else                                                                      
        xitded = data(56)+data(57)+comnew(23)+max(0.0d0,data(61)-.1*ag)         
     &  +max(0.0d0,data(63)-.02*ag)+data(66)                                    
      endif                                                                     
      if(law.le.1991) then                                                      
         xitded=xitded+max(0.0d0,max(0.0d0,data(48)-.01*ag)+                    
     &       data(49)+min(150.0d0,data(47))-.03*ag)                             
      else if(law.ge.1992) then                                                 
         xitded=xitded+max(0.0d0,data(49)-.04*ag)                               
      endif                                                                     
      if(law.ge.1982) xitded=xitded+data(51)+data(54)                           
c      if(law.ge.1982) xitded=xitded+socsec(data,comnew,law)+                   
c     & data(51)+data(54)                                                       
c socsec replaced by c75(fica) and c180(addmtx) and c175(setax)                 
      if(law.ge.1982) then                                                      
         fica = .5*(comnew(75)-comnew(175))+comnew(180)                         
         setax = comnew(175)                                                    
         xitded=xitded+fica+setax                                               
      endif                                                                     
      if(law.le.1981)xitded=xitded-max(0.0d0,comnew(23)-ag*.15)                 
c   accounts for deduction of fed inc tax                                       
c   tax based on withholding; don't count for credits                           
c      if(law.le.1999)fedtax=max(comnew(52)-comnew(58),0.0d0)                   
      if(law.le.1999)fedtax=max(comnew(1),0.0d0)                                
      if(law.ge.2000.and.law.le.2008)fedtax =                                   
     & max(comnew(52)+comnew(70)-comnew(58),0.0d0)                              
c 2009+ Federal Income Tax deduction worksheet                                  
c      if(law.ge.2009) fedtax =                                                 
c     &max(0.0d0,comnew(154)-comnew(94)-comnew(59)-comnew(93)-comnew(92))       
c      if(law.ge.2009.and.law.ne.2021) fedtax = max(0.0d0,                      
      if(law.ge.2009) fedtax = max(0.0d0,                                       
     & comnew(154)+comnew(173)-comnew(59)-comnew(93))                           
      if(law.eq.2021) then                                                      
c Child Tax credit, child care credit, eic recomputed for 2020                  
        d101 = law                                                              
        d103 = law                                                              
        data(101) = 2020                                                        
        data(103) = 2020                                                        
        call nlaw(data,2020)                                                    
        chcare = cala(53)                                                       
        chcred = cala(81)                                                       
        eitc = cala(59)                                                         
c        write(0,*) '2020chcare chcred eitc',chcare,chcred,eitc                 
c        write(16,4) (data(j),j=1,190)                                          
c        write(16,4) (cala(j),j=1,190)                                          
c4       format(19(10f9.0/)////////)                                             
                                                                                
        data(101) = d101                                                        
        data(103) = d103                                                        
        call nlaw(data,2021)                                                    
        fedtax = max(0.0d0,                                                     
     &  comnew(52)+comnew(173)-eitc-chcred-chcare)                              
c      write(0,*) 'fedtax c52 chcare chcred',fedtax,comnew(52),chcare,chcred    
                                                                                
      endif                                                                     
      deduc=max(stded,xitded)+fedtax                                            
c     EXEMPTIONS                                                                
      if(mst.eq.4.or.mst.eq.7.or.mst.eq.2.or.mst.eq.5) then                     
        exemp=3000.                                                             
      else                                                                      
        exemp=1500.                                                             
      endif                                                                     
c Dependent Exemptions                                                          
      if(law.le.2006) exemp=exemp+300*data(8)                                   
      if(law.ge.2007) then                                                      
c smoothing of exemptions                                                       
c AL AGI 0-20k, exemp = $1000                                                   
c AL AGI 20-100k, exemp = $500                                                  
c AL AGI over 100k, exemp = $300                                                
        tga = (1000.d0 - 500.d0)/20000.d0                                       
        tgb = (500.d0 - 300.d0)/80000.d0                                        
        excesa = min(20000.d0,max(0.d0,agi))                                    
        excesb = min(80000.d0,max(0.d0,agi - 20000.d0))                         
        xmpdep = 1000.d0 - excesa*tga - excesb*tgb                              
        exemp=exemp + xmpdep*data(8)                                            
      endif                                                                     
      taxinc = max(0.0d0,agi-deduc-exemp)                                       
c      write(0,*) 'taxinc agi deduc exemp',taxinc,agi,deduc,exemp               
      if(law.le.1981) then                                                      
        call look(tab, taxinc,4,n,statax,1.0d00,0.0d0,rt,data)                  
      else if(law.ge.1982) then                                                 
        taxy = taxinc                                                           
        if(mst.eq.2) taxy = taxinc/2                                            
        call look(tab82,taxy,3,n,stat,1.0d00, 0.0d0,rt,data)                    
        statax = stat                                                           
        if(mst.eq.2) statax =stat*2                                             
      endif                                                                     
c deduction for solar energy credit; non-refundable                             
      solcrd=0.                                                                 
      if(law.ge.1981.and.law.le.1986)solcrd=data(38)                            
      statax=max(0.0d0,statax-solcrd)                                           
      credit = solcrd                                                           
      return                                                                    
      end                                                                       
c  ALASKA                                                                      
c  State 02                                                                     
c                                                                               
c                                                                               
c                                                                               
c   EAC revised Summer 1994                                                     
c                                                                               
c     tax abolished for 1979 on                                                 
c     maximum tax on earned income not included                                 
c     alternative tax on captial gains not included                             
c     aktab (x,1) for single people                                             
c     aktab (x,2) for married filing jointly, surviving spouses                 
c     aktab (x,3) for heads of household                                        
c                                                                               
      subroutine aktax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      dimension aktab1(2,25),aktab2(2,25),aktab3(2,25),cred(1977:1988)          
      data aktab1 /      2000.0d0, 3.0d0,  4000.0d0, 3.5d0,                     
     &  6000.0d0, 4.0d0,  8000.0d0, 5.0d0, 10000.0d0, 2.5d0,                    
     & 12000.0d0, 6.0d0, 14000.0d0, 7.0d0, 16000.0d0, 7.5d0,                    
     & 18000.0d0, 8.0d0, 20000.0d0, 8.5d0, 22000.0d0, 9.0d0,                    
     & 26000.0d0, 9.5d0, 32000.0d0,10.0d0, 38000.0d0,10.5d0,                    
     & 44000.0d0,11.0d0, 50000.0d0,11.5d0, 60000.0d0,12.0d0,                    
     & 70000.0d0,12.5d0, 80000.0d0,13.0d0, 90000.0d0,13.5d0,                    
     &100000.0d0,14.0d0,150000.0d0,14.0d0, 1.e20, 14.5d0,                       
     &      0.0d0,  0.0d0,       0.0d0,  0.0d0 /                                
      data aktab2/                                                              
     &   4000.0d0, 3.0d0,  8000.0d0, 3.5d0, 12000.0d0, 4.0d0,                   
     &  16000.0d0, 5.0d0, 20000.0d0, 5.5d0, 24000.0d0, 6.0d0,                   
     &  28000.0d0, 7.0d0, 32000.0d0, 7.5d0, 36000.0d0, 8.0d0,                   
     &  40000.0d0, 8.5d0, 44000.0d0, 9.0d0, 52000.0d0, 9.5d0,                   
     &  64000.0d0,10.0d0, 76000.0d0,10.5d0, 88000.0d0,11.0d0,                   
     & 100000.0d0,11.5d0,120000.0d0,12.0d0,140000.0d0,12.5d0,                   
     & 160000.0d0,13.0d0,180000.0d0,13.5d0,200000.0d0,14.0d0,                   
     & 300000.0d0,14.0d0,1.e20, 14.5d0,0.0d0,0.0d0,0.0d0,0.0d0 /                
      data aktab3 /                                                             
     &    2000.0d0, 3.0d0,   4000.0d0, 3.5d0,  6000.0d0, 4.0d0,                 
     &    8000.0d0, 4.5d0,  10000.0d0, 5.0d0, 12000.0d0, 5.5d0,                 
     &   14000.0d0, 6.0d0,  16000.0d0, 6.5d0, 18000.0d0, 7.0d0,                 
     &   20000.0d0, 7.0d0,  22000.0d0, 7.5d0, 24000.0d0, 8.0d0,                 
     &   28000.0d0, 8.5d0,  32000.0d0, 9.0d0, 38000.0d0, 9.5d0,                 
     &   44000.0d0, 10.0d0, 50000.0d0,10.5d0, 60000.0d0,11.0d0,                 
     &   70000.0d0, 11.5d0, 80000.0d0,12.0d0, 90000.0d0,12.5d0,                 
     &  100000.0d0, 13.0d0,150000.0d0,13.5d0,200000.0d0,14.0d0,                 
     &  1.e20, 14.5d0 /                                                         
      data cred/0.0d0,100.0d0,200.0d0,300.0d0,8*0.0d0/                          
      statax=0.                                                                 
      rt=0.                                                                     
      mst = int(data(2))                                                             
c Personal income tax repealed in 1980 after the oil boom.                      
      if(law.gt.1979)return                                                     
      agi = comnew (2)                                                          
c 1978 0 bracket used instead of 1974                                           
      stded=2200.                                                               
      m = 1                                                                     
      if(mst.eq.2.or.mst.eq.5) then                                             
        stded=3200.                                                             
        m = 2                                                                   
      endif                                                                     
      if(mst.eq.3.or.mst.eq.6) stded=1600.                                      
      if(mst.eq.7.or.mst.eq.4) m = 3                                            
      deduc=stded                                                               
      taxinc = agi - deduc                                                      
      if (m.eq.1)                                                               
     &call look(aktab1,taxinc, 23,n, statax,1.0d00,0.0d0,rt,data)               
      if (m.eq.2)                                                               
     &call look(aktab2,taxinc, 23,n, statax,1.0d00,0.0d0,rt,data)               
      if (m.eq.3)                                                               
     &call look(aktab3,taxinc, 25,n, statax,1.0d00,0.0d0,rt,data)               
c   minimum tax                                                                 
      statax=statax+.16*.15*data(81)                                            
      txcred=cred(law)                                                          
      if(mst.eq.2)  txcred=txcred*2.                                            
      credit=min(50.0d0,data(35))                                               
      statax=max(0.0d0,statax-credit-txcred)                                    
c1     format(1x,10f8.0)                                                        
      return                                                                    
      end                                                                       
c  ARIZONA                                                                   
c  State 03                                                                   
c    Updated through 2021                                                       
      subroutine aztax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255),tab(2,7),proptb(2,22),pr90tb(2,22)        
      dimension t9093s(2,5) , t9093h(2,5)                                       
      dimension tab94s(2,5) , tab94h(2,5)                                       
      dimension tab95s(2,5) , tab95h(2,5)                                       
      dimension tab97s(2,5) , tab97h(2,5)                                       
      dimension tab98s(2,5) , tab98h(2,5)                                       
      dimension tab99s(2,5) , tab99h(2,5)                                       
      dimension tab06s(2,5) , tab06h(2,5)                                       
      dimension tab07s(2,5) , tab07h(2,5)                                       
      dimension tab19(2,4)                                                      
      dimension ex(1995:2021),fag98m(4),fag98h(5)                               
      dimension aif(1977:2021),rtab(1977:1994),rfrac(1977:1994)                 
      dimension brkif(1977:1994), ptab(2,22),std(1990:2021),                    
     & xmps(1997:2021),xmph(1997:2021)                                          
      dimension aif92(1992:2012),aif13(2013:2017),aif15(2015:2018),             
     &aif19(2019:2021)                                                          
      data xmps/20*2100.d0,2150.d0,2200.d0,3*0.d0/                              
      data xmph/20*3150.d0,3225.d0,3300.d0,3*0.d0/                              
      data aif19/1.0d0,1.029132d0,1.04935849d0/                                 
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data aif15/1.0163d0,1.01785d0,1.0346d0,1.0602d0/                          
      data aif92/                                                               
     &  1.0525d0, 1.0845d0, 1.118d0 , 1.147d0 , 1.1795d0,  1.212d0,             
     &  1.245d0 , 1.266d0 , 1.2895d0, 1.3295d0, 1.373d0 ,  1.395d0,             
     &  1.427d0 , 1.4595d0, 1.505d0 , 1.564d0 , 1.5995d0,  1.668d0,             
     &2*1.6955d0, 1.7365d0/                                                     
      data proptb /  1750.0d0, 225.0d0, 1850.0d0, 215.0d0, 1950.0d0,            
     &      206.0d0, 2050.0d0, 250.0d0, 2150.0d0, 185.0d0, 2250.0d0,            
     &      175.0d0, 2350.0d0, 165.0d0, 2450.0d0, 155.0d0, 2550.0d0,            
     &      145.0d0, 2650.0d0, 135.0d0, 2750.0d0, 125.0d0, 2850.0d0,            
     &      115.0d0, 2950.0d0, 105.0d0, 3050.0d0,  95.0d0, 3150.0d0,            
     &       86.0d0, 3250.0d0,  75.0d0, 3350.0d0,  65.0d0, 3450.0d0,            
     &       55.0d0, 3550.0d0,  45.0d0, 3650.0d0,  35.0d0, 3750.0d0,            
     &       25.0d0, 1.e20,   0.0d0/                                            
      data pr90tb /                                                             
     &0.d0,502.d0,0.d0,479.d0,0.d0,457.d0,0.d0,435.d0,0.d0,412.d0,              
     &0.d0,390.d0,0.d0,368.d0,0.d0,345.d0,0.d0,323.d0,0.d0,301.d0,              
     &0.d0,279.d0,0.d0,256.d0,0.d0,234.d0,0.d0,212.d0,0.d0,189.d0,              
     &0.d0,167.d0,0.d0,145.d0,0.d0,123.d0,0.d0,100.d0,0.d0, 78.d0,              
     &0.d0, 56.d0,0.d0,  0.d0/                                                  
      data ptab/                                                                
     &1750.d0,0.d0,1850.d0,0.d0,1950.d0,0.d0,2050.d0,0.d0,2150.d0,0.d0,         
     &2250.d0,0.d0,2350.d0,0.d0,2450.d0,0.d0,2550.d0,0.d0,2650.d0,0.d0,         
     &2750.d0,0.d0,2850.d0,0.d0,2950.d0,0.d0,3050.d0,0.d0,3150.d0,0.d0,         
     &3250.d0,0.d0,3350.d0,0.d0,3450.d0,0.d0,3550.d0,0.d0,3650.d0,0.d0,         
     &3750.d0,0.d0,  1.e20,0.d0/                                                
      data tab/ 1000.0d0,  2.0d0, 2000.0d0,  3.0d0, 3000.0d0, 4.0d0,            
     &          4000.0d0,  5.0d0, 5000.0d0,  6.0d0, 6000.0d0, 7.0d0,            
     &          1.e20,  8.0d0/                                                  
      data t9093s/      10000.0d0,   3.8d0, 25000.0d0,   4.40d0,                
     &                  50000.0d0, 5.250d0,150000.0d0,   6.50d0,                
     &                  1.e20,    7.0d0/                                        
      data t9093h/      20000.0d0,   3.80d0, 50000.0d0,   4.40d0,               
     & 100000.0d0,   5.250d0, 300000.0d0,  6.50d0,  1.e20,7.0d0/                
      data tab94s/      10000.0d0,  3.250d0, 25000.0d0,   4.0d0,                
     & 50000.0d0, 5.050d0,150000.0d0, 6.40d0, 1.e20, 6.90d0/                    
      data tab94h/      20000.0d0,  3.250d0, 50000.0d0,   4.0d0,                
     & 100000.0d0, 5.050d0, 300000.0d0, 6.40d0, 1.e20, 6.90d0/                  
      data tab95s/      10000.0d0,  3.0d0, 25000.0d0,  3.50d0,                  
     & 50000.0d0, 4.20d0, 150000.0d0, 5.20d0, 1.e20, 5.60d0/                    
      data tab95h/      20000.0d0,  3.0d0, 50000.0d0,  3.50d0,                  
     & 100000.0d0, 4.20d0, 300000.0d0, 5.20d0, 1.e20, 5.60d0/                   
      data tab97s/         10000.0d0,  2.90d0, 25000.0d0,  3.30d0,              
     & 50000.0d0, 3.90d0, 150000.0d0,  4.80d0, 1.e20, 5.170d0/                  
      data tab97h/      20000.0d0,  2.90d0, 50000.0d0,  3.30d0,                 
     & 100000.0d0, 3.90d0,300000.0d0, 4.80d0, 1.e20, 5.170d0/                   
      data tab98s/      10000.0d0,  2.880d0, 25000.0d0,  3.240d0,               
     & 50000.0d0, 3.820d0,150000.0d0, 4.740d0, 1.e20, 5.10d0/                   
      data tab98h/      20000.0d0,  2.880d0, 50000.0d0,  3.240d0,               
     & 100000.0d0, 3.820d0,300000.0d0, 4.740d0, 1.e20, 5.10d0/                  
      data tab99s/      10000.0d0,  2.870d0, 25000.0d0,  3.20d0,                
     & 50000.0d0, 3.740d0,150000.0d0, 4.720d0, 1.e20, 5.040d0/                  
      data tab99h/      20000.0d0,  2.870d0, 50000.0d0,  3.20d0,                
     & 100000.0d0, 3.740d0, 300000.0d0, 4.720d0, 1.e20, 5.040d0/                
      data tab06s/      10000.0d0,  2.730d0, 25000.0d0, 3.040d0,                
     & 50000.0d0, 3.550d0,150000.0d0, 4.480d0, 1.e20, 4.790d0/                  
      data tab06h/      20000.0d0,  2.730d0, 50000.0d0, 3.040d0,                
     & 100000.0d0, 3.550d0, 300000.0d0, 4.480d0, 1.e20, 4.790d0/                
      data tab07s/      10000.0d0,  2.590d0, 25000.0d0, 2.880d0,                
     & 50000.0d0, 3.360d0, 150000.0d0, 4.240d0, 1.e20, 4.540d0/                 
      data tab07h/      20000.0d0,  2.590d0, 50000.0d0, 2.880d0,                
     & 100000.0d0, 3.360d0,300000.0d0, 4.240d0, 1.e20, 4.540d0/                 
      data tab19/      26500.0d0,  2.590d0, 53000.0d0, 3.340d0,                 
     & 159000.0d0, 4.170d0, 1.e20, 4.50d0/                                      
                                                                              
      data fag98m/     20000.0d0,  23600.0d0, 27300.0d0, 31000.0d0/             
      data fag98h/     20000.0d0,  20135.0d0, 23800.0d0, 25200.0d0,             
     & 26575.0d0/                                                               
      data rtab/50.0d0,83.0d0,92.0d0,107.0d0,120.0d0,130.0d0,132.0d0,           
     & 4*100.0d0,85.0d0,6*70.0d0/                                               
      data aif/1.00d0, 1.1010d0, 1.2260d0, 1.4220d0, 1.5890d0,                  
     & 1.7290d0, 1.7590d0, 1.8340d0,1.9410d0, 1.9960d0, 2.0450d0,               
     &2.1250d0, 2.2290d0, 32*1.0d0/                                             
      data rfrac/7*.10d0,11*.050d0/                                             
      data brkif/6*1.0d0, 1.10170d0, 1.0610d0, 1.1230d0, 1.1550d0,              
     & 1.1830d0, 1.2290d0, 1.290d0, 5*1.0d0/                                    
      data ex/ 3*30.0d0,24*40.0d0/                                              
      data std/5*3500.d0,6*3600.d0,4*4050.d0,4125.d0,4247.d0,                   
     & 4373.d0,4521.d0,2*4677.d0,4703.d0,4833.d0,4945.d0,5009.d0,               
     & 5091.d0,5099.d0,  5183.d0,5312.d0, 12200.d0,12400.d0,12550.d0/           
c Tax Law is the same for 1995 and 1996                                         
c indexing covers everything.                                                   
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rt=0.                                                                     
      credit = 0.d0                                                             
      phas92=100000.d0/sep                                                      
      reduce = 0.d0                                                             
      if(law.ge.1992.and.law.le.2012)phas92=100000.*aif92(law)/sep              
      if(law.ge.2013.and.law.le.2017)                                           
     &phas92 = filing(mst,250000.,300000.,275000.,150000.)*aif13(law)           
c AGI                                                                           
      agi=comnew(2)-data(22)                                                    
c      write(0,*) '1 agi',agi                                                   
      if(law.le.1980)agi=agi+divexc(data,comnew,law)                            
      if(law.ge.1982.and.law.le.1986) agi=agi+comnew(32)                        
      if(law.ge.1984)agi=agi-comnew(79)                                         
c      write(0,*) '2 agi',agi                                                   
                                                                                
c     federal tax deduction is only for withholding and estimated               
c     tax payments; don't include credits for this reason                       
c     fedtax=max(0.,comnew(1)-comnew(64)+comnew(59)+comnew(58))                 
      fedtax=max(0.0d0,comnew(1)+comnew(59)+comnew(58))                         
      if(law.le.1989)agi=agi-fedtax                                             
c EXEMP                                                                         
      txp = data(7)                                                             
      if(mst.eq.4.or.mst.eq.7)txp = txp+1                                       
      nchild = int(data(8))                                                          
c 2019+ repeal of dependent exemptions                                          
      if(law.ge.2019) nchild = 0                                                
      exemp = 0.d0                                                              
      if(law.le.1989)then                                                       
         exemp=((txp+data(9))*1000+nchild*600.d0+data(10)*500)*aif(law)         
         if(law.le.1978)exemp = exemp - xif(mst.eq.4.or.mst.eq.7,               
     &   min(data(8),1.0d0)*600.*aif(law))                                      
      else if(law.eq.1990.or.law.eq.1991) then                                  
         exemp=(txp+nchild)*2000.d0+(data(9)+data(10))*1500                     
      else if(law.eq.1992) then                                                 
         exemp=(txp+nchild)*2100.+data(9)*1750.+data(10)*1500                   
      else if(law.ge.1993.and.law.le.1996) then                                 
         exemp=(txp+data(9))*2100+nchild*2300.d0+data(10)*1500                  
      else if(law.ge.1997.and.law.le.2019) then                                 
c 2019+ repeal of dependent exemptions                                          
        exemp = txp*xmps(law)                                                   
        if((mst.eq.2.or.sep.eq.2).and.nchild.gt.0)                              
     &          exemp = txp*xmph(law)                                           
        exemp = exemp+data(9)*2100+data(10)*1500+nchild*2300.d0                 
      else if(law.ge.2020) then                                                 
c 2020+                                                                         
        exemp = data(9)*2100+data(10)*1500+nchild*2300.d0                       
      endif                                                                     
c DEDUCTIONS                                                                    
      if(law.le.1983) then                                                      
        fctr=nint(aif(law)*10.)/10.                                             
      else if(law.eq.1984.or.law.eq.1985) then                                  
        fctr=nint(aif(law)*100.)/100.                                           
      else if(law.ge.1986) then                                                 
        fctr=aif(law)                                                           
      endif                                                                     
      if(law.le.1989) then                                                      
         stded=twn(.1d0*fctr*agi,0.0d0,txp*500.d0*aif(law))                     
      else if(law.ge.1990.and.law.le.2018) then                                 
         stded = txp * std(law)                                                 
      else                                                                      
         coef = 1.d0                                                            
         if(mst.eq.4.or.mst.eq.7) coef = 1.5d0                                  
         if(mst.eq.2) coef = 2.d0                                               
         stded = coef*std(law)                                                  
      endif                                                                     
      ag=max(0.0d0,comnew(2))                                                   
c what is the difference here between this & medical expenses--see 1992?        
      health = data(47)+data(48)+data(49)                                       
      if(law.le.1990) then                                                      
        xitded = comnew(30)+health-data(50)-comnew(20)                          
     &    +min(data(63),.02*ag)+data(54)+data(55)                               
        if(law.ge.1980)xitded = xitded+min(100.*data(7),data(65))               
c Child Care Deduction--                                                        
        if(data(159).lt.6000.d0/sep)                                            
     &           xitded = xitded+min(data(64),1200.0d0)                         
c ----------------------                                                        
        if(law.le.1979)xitded = xitded-data(60)                                 
        char = data(58)+data(59)+data(60)                                       
        if(law.le.1981)xitded = xitded-max(char-(.2*ag),0.0d0)                  
c itemized deduction=federal itemized deduct                                    
      else                                                                      
        xitded=comnew(30)                                                       
c       write(0,*) 'agi phas92 xitded law',agi,phas92,xitded,law                
        if(agi.gt.phas92.and.law.ge.1991.and.law.le.2017) then                  
          reduce = min(.8*xitded,.03*(agi-phas92))                              
          if(law.eq.2006.or.law.eq.2007) reduce = 2*reduce/3                    
          if(law.eq.2008.or.law.eq.2009) reduce = reduce/3                      
          if(law.ge.2010.and.law.le.2012) reduce = 0.d0                         
          xitded = xitded-reduce                                                
        endif                                                                   
        if(law.eq.1992)xitded = xitded+                                         
     &   max(0.0d0,health -.06*comnew(2)-comnew(20))                            
        if(law.eq.1993)xitded = xitded+                                         
     &   max(0.0d0,health -.04*comnew(2)-comnew(20))                            
        if(law.eq.1994)xitded = xitded+                                         
     &   max(0.0d0,health -.02*comnew(2)-comnew(20))                            
        if(law.ge.1994)xitded = xitded+max(0.0d0,-comnew(20)+health)            
      endif                                                                     
c state income tax is an allowable deduction after 1980                         
      aiflk=1.                                                                  
      if(law.ge.2015.and.law.le.2018) aiflk = aif15(law)                        
      if(law.ge.2019) aiflk = aif19(law)                                        
      if(law.le.2018) then                                                      
        deduc=max(stded,xitded)                                                 
      else if(law.eq.2020) then                                                 
        fedchr = min(300.d0/sep,data(58))                                       
        char = max(0.d0,.25*(comnew(23)-fedchr))*(1-comnew(26))                 
        deduc = max(stded+char,xitded)                                          
      else if(law.ge.2021.or.law.eq.2019) then                                  
        deduc = max(stded+.25*comnew(23),xitded)                                
      endif                                                                     
      taxinc=max(agi - deduc - exemp,0.0d0)                                     
c      write(0,*) 'deduc exemp agi taxinc',deduc,exemp,agi,taxinc               
      if(law.le.1989) then                                                      
       call look(tab,taxinc,7,n,statax,brkif(law),0.d0,rt,data)                 
      else if(law.ge.1990.and.law.le.1993)then                                  
       if(mst.eq.4.or.mst.eq.7.or.mst.eq.2) then                                
        call look(t9093h,taxinc,5,n,statax,brkif(law),0.d0,rt,data)             
       else                                                                     
        call look(t9093s,taxinc,5,n,statax,brkif(law),0.d0,rt,data)             
       endif                                                                    
      else if(law.eq.1994) then                                                 
       if(mst.eq.4.or.mst.eq.7.or.mst.eq.2) then                                
        call look(tab94h,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       else                                                                     
        call look(tab94s,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       endif                                                                    
      else if(law.eq.1995.or.law.eq.1996) then                                  
       if(mst.eq.4.or.mst.eq.7.or.mst.eq.2) then                                
        call look(tab95h,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       else                                                                     
        call look(tab95s,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       endif                                                                    
      else if(law.eq.1997) then                                                 
       if(mst.eq.4.or.mst.eq.7.or.mst.eq.2) then                                
        call look(tab97h,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       else                                                                     
        call look(tab97s,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       endif                                                                    
      else if(law.eq.1998) then                                                 
       if(mst.eq.4.or.mst.eq.7.or.mst.eq.2) then                                
        call look(tab98h,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       else                                                                     
        call look(tab98s,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       endif                                                                    
      else if(law.ge.1999.and.law.le.2005) then                                 
       if(mst.eq.4.or.mst.eq.7.or.mst.eq.2) then                                
        call look(tab99h,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       else                                                                     
        call look(tab99s,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       endif                                                                    
      else if(law.eq.2006) then                                                 
       if(mst.eq.4.or.mst.eq.7.or.mst.eq.2) then                                
        call look(tab06h,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       else                                                                     
        call look(tab06s,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       endif                                                                    
      else if(law.ge.2007.and.law.le.2018) then                                 
       if(mst.eq.4.or.mst.eq.7.or.mst.eq.2) then                                
        call look(tab07h,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       else                                                                     
        call look(tab07s,taxinc,5,n,statax,aiflk,0.d0,rt,data)                  
       endif                                                                    
      else if(law.ge.2019) then                                                 
        taxy = taxinc                                                           
        if(mst.eq.2.or.mst.eq.4.or.mst.eq.7) taxy = taxinc/2                    
        call look(tab19,taxy,4,n,stat,aiflk,0.d0,rt,data)                       
        statax = stat                                                           
        if(mst.eq.2.or.mst.eq.4.or.mst.eq.7) statax = stat*2                    
      endif                                                                     
c      write(0,*) 'taxinc statax',taxinc,statax                                 
c res energy credit; non-refundable;  appears to follow approx fed %            
      solcrd=min(data(38),1000.0d0)                                             
      statax=max(0.0d0,statax-solcrd)                                           
c refundable property tax credit                                                
c after 1989 no longer indexes                                                  
      pcred=0.                                                                  
      rcred=0.                                                                  
      more=0                                                                    
      pens=data(72)+data(20)+data(91)                                           
      if(mst.ne.1.or.data(8).gt.0.)more=1                                       
      if(data(9).gt.0.and.pens.gt.0) then                                       
          do 20 i=1,21                                                          
             ptab(1,i)=proptb(1,i) + (750.*more)                                
             if(law.le.1989) then                                               
                ptab(2,i)=proptb(2,i)*aif(law)                                  
             else                                                               
                ptab(2,i)=pr90tb(2,i)                                           
             endif                                                              
20        continue                                                              
          pcred=tablki(ptab,22,data(159),data)                                  
      endif                                                                     
c renters credit; changes after 1989                                            
      if(law.le.1989)rcred=twn(rfrac(law)*data(160),0.0d0,rtab(law))            
      if(law.ge.1990.and.law.le.1991.and.agi.le.25000.)                         
     &       rcred=min(twn(rfrac(law)*data(160),0.0d0,rtab(law)),55.0d0)        
      credit=max(pcred,rcred)                                                   
c Family income Credit since 1995 --  non-refundable                            
      famcr=0.                                                                  
      if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                                 
        fagi   = 10000.                                                         
        famlim = 60.                                                            
        if(law.ge.1998) famlim = 120.                                           
      else                                                                      
        fagi   = 20000.                                                         
        famlim = 120.                                                           
        if(law.ge.1998) famlim = 240.                                           
      endif                                                                     
      if(mst.eq.2.and.law.ge.1998) then                                         
        if(data(8).le.1) fagi = fag98m(1)                                       
        if(data(8).eq.2) fagi = fag98m(2)                                       
        if(data(8).eq.3) fagi = fag98m(3)                                       
        if(data(8).ge.4) fagi = fag98m(4)                                       
      else if((mst.eq.4.or.mst.eq.7).and.law.ge.1998) then                      
        if(data(8).le.1) fagi = fag98h(1)                                       
        if(data(8).eq.2) fagi = fag98h(2)                                       
        if(data(8).eq.3) fagi = fag98h(3)                                       
        if(data(8).eq.4) fagi = fag98h(4)                                       
        if(data(8).ge.5) fagi = fag98h(5)                                       
      endif                                                                     
      if(law.ge.1995.and.agi.le.fagi)                                           
     &   famcr=min(famlim,(data(8)+data(7))*ex(law))                            
c 2019+ Dependent Tax Credit --  non-refundable                                 
      ctc = 0.d0                                                                
      if(law.ge.2019) then                                                      
        ctc = 100*data(208) + 25*(data(8)-data(208))                            
        cphase = 200000.d0*data(7)                                              
        if(comnew(2).gt.cphase) then                                            
          excess = comnew(2)-cphase                                             
          reduc = (excess/1000.)*50.                                            
          ctc = max(0.d0,ctc - reduc)                                           
        endif                                                                   
      endif                                                                     
      statax = max(0.0d0,statax-famcr-ctc)                                      
c Credit For Increased Excise Taxes  2001+  refunadable                         
      excise = 0.                                                               
      if(law.ge.2001.and.data(105).lt.1.d0) then                                
        numb = int(data(7))                                                          
        if(mst.eq.4.or.mst.eq.7) numb = 2                                       
        if(comnew(2).le.12500*numb)                                             
     &  excise = min(25.0d0*(data(7)+data(8)),100.0d0)                          
      endif                                                                     
      credit = credit + excise                                                  
      statax = statax-credit                                                    
      credit = credit + famcr + ctc                                             
      return                                                                    
      end                                                                       
c  ARKANSAS                                                                     
c  State 04                                                                      
c  Updated through 2021 (updated 02.15.2022)                                    
      subroutine artax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      dimension tab(2,6),tab99(5),tab00(5),tab01(5),tab02(5),                   
     &tab03(5),tab04(5),tab05(5),tab06(5),tab07(5),tab08(5),                    
     &tab09(5),tab10(5),tab11(5),tab12(5),tab14(5),tab15(5),                    
     &tab16(2,8),tbase(2,6)                                                     
      dimension tab17t(12,3),tab18t(12,3),tab19t(12,3),tab20t(12,3),            
     &tab21t(12,3)                                                              
      dimension tabst1(2,10),tabst2(2,12),std(1998:2021),                       
     & aif13(2013:2017)                                                         
      dimension aif92(1992:2016),pcr(1987:2021),pcrcg(1999:2021)                     
      integer sep                                                               
      data pcrcg/16*.7d0,.55d0,6*.5d0/                                          
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data std/17*2000.0d0,7*2200.0d0/                                          
      data tab17t/ 4399.d0, 8699.d0, 13099.d0,21699.d0,36299.d0,                
     &            77400.d0,78400.d0, 79400.d0,80600.d0,81600.d0,                
     &             82600.d0, 1.e20,                                             
     2             0.9d0, 2.4d0, 3.4d0,  4.4d0, 5.0d0,6.0d0,6*6.9d0,            
     3             0.d0,65.99d0,152.98d0, 283.97d0,396.86d0,759.85d0,           
     3          1380.54d0,1280.54d0,1180.54d0,1080.54d0,980.54d0,               
     3          940.54d0/                                                       
      data tab18t/ 4499.d0, 8899.d0, 13399.d0,22199.d0,37199.d0,                
     &            79300.d0,80300.d0, 81300.d0,82500.d0,83600.d0,                
     &             84600.d0, 1.e20,                                             
     2             0.9d0, 2.4d0, 3.4d0,  4.4d0, 5.0d0,6.0d0,6*6.9d0,            
     3             0.d0,67.49d0,156.48d0, 290.47d0,405.96d0,777.95d0,           
     3          1402.74d0,1302.74d0,1202.74d0,1102.74d0,1002.74d0,              
     3          982.74d0/                                                       
      data tab19t/ 4599.d0, 9099.d0, 13699.d0,22599.d0,37899.d0,                
     &            80800.d0,81800.d0, 82800.d0,84100.d0,85200.d0,                
     &            86200.d0, 1.e20,                                              
     2             0.d0, 2.d0, 3.d0,  3.4d0, 5.0d0,6.0d0,6*6.9d0,               
     3             0.d0,91.98d0,182.97d0, 237.77d0,421.46d0,800.45d0,           
     3          1421.64d0,1321.64d0,1221.64d0,1121.64d0,1021.64d0,              
     3          981.64d0/                                                       
      data tab20t/ 4699.d0, 9199.d0, 13899.d0,22899.d0,38499.d0,                
     &            82000.d0,83000.d0, 84000.d0,85300.d0,86400.d0,                
     &            87500.d0, 1.e20,                                              
     2             0.d0, 2.d0, 3.d0,  3.4d0, 5.0d0,5.9d0,6*6.6d0,               
     3             0.d0,93.98d0,185.97d0, 241.57d0,427.71d0,774.2d0,            
     3          1255.7d0,1155.7d0,1055.7d0,955.7d0,855.7d0, 815.7d0/            
      data tab21t/ 4799.d0, 9499.d0, 14299.d0,23599.d0,39699.d0,                
     &            84500.d0,85500.d0, 86500.d0,87900.d0,89000.d0,                
     &            90100.d0, 1.e20,                                              
     2             0.d0, 2.d0, 3.d0,  3.4d0, 5.0d0,7*5.9d0,                     
     3             0.d0,95.98d0,190.97d0,248.17d0,439.96d0,797.25d0,            
     3          687.5d0,587.5d0,487.5d0 ,387.5d0 ,287.5d0 ,247.5d0/             
c aif92 is real variable                                                        
      data aif92/                                                               
     &  1.0525, 1.0845, 1.1180, 1.1470, 1.1795, 1.2120,                         
     &  1.2450, 1.2660, 1.2895, 1.3295, 1.3730, 1.3950,                         
     &  1.4270, 1.4595, 1.5050, 1.5640, 1.5995, 1.6680,                         
     &2*1.6955, 1.7365, 1.   ,  1.0168, 1.033 , 1.0376/                        
      data tbase / 3000.0d0, 1.0d0, 6000.0d0, 2.50d0, 9000.0d0, 3.50d0,         
     & 15000.0d0, 4.50d0,  25000.0d0, 6.0d0, 1.e20, 7.0d0 /                     
      data tab99 /3100.0d0,6100.0d0, 9200.0d0,15300.0d0,25400.0d0/              
      data tab00 /3100.0d0,6200.0d0, 9300.0d0,15500.0d0,25900.0d0/              
      data tab01 /3200.0d0,6400.0d0, 9600.0d0,16000.0d0,26700.0d0/              
      data tab02 /3300.0d0,6600.0d0, 9900.0d0,16500.0d0,27500.0d0/              
      data tab03 /3300.0d0,6700.0d0,10000.0d0,16700.0d0,27900.0d0/              
      data tab04 /3400.0d0,6800.0d0,10300.0d0,17100.0d0,28500.0d0/              
      data tab05 /3500.0d0,7000.0d0,10500.0d0,17500.0d0,29200.0d0/              
      data tab06 /3600.0d0,7200.0d0,10800.0d0,18000.0d0,30100.0d0/              
      data tab07 /3700.0d0,7400.0d0,11100.0d0,18600.0d0,31000.0d0/              
      data tab08 /3800.0d0,7600.0d0,11400.0d0,18900.0d0,31700.0d0/              
      data tab09 /3900.0d0,7800.0d0,11700.0d0,19600.0d0,32600.0d0/              
      data tab10 /3900.0d0,7800.0d0,11800.0d0,19600.0d0,32700.0d0/              
      data tab11 /4000.0d0,8000.0d0,11900.0d0,19900.0d0,33200.0d0/              
      data tab12 /4100.0d0,8200.0d0,12200.0d0,20400.0d0,34000.0d0/              
      data tab14 /4200.0d0,8300.0d0,12400.0d0,20700.0d0,34600.0d0/              
      data tab15 /4300.0d0,8400.0d0,12700.0d0,21100.0d0,35300.0d0/              
      data tab16/ 4300.d0, 0.9d0, 8500.d0, 2.4d0, 12700.d0, 3.4d0,              
     &           21200.d0, 4.4d0,35100.d0, 5.0d0, 75000.d0, 6.0d0,              
     &           80000.d0,16.9d0,    1.e20, 6.9d0/                              
      data tabst1 /       3000.0d0,  .90d0, 4000.0d0, 1.70d0,                   
     & 5000.0d0, 2.20d0 , 6000.0d0, 2.30d0, 7000.0d0, 2.50d0,                   
     &10000.0d0, 3.150d0,16000.0d0, 4.50d0,17000.0d0, 5.90d0,                   
     &25000.0d0, 6.0d0  , 1.e20, 7.0d0/                                         
      data tabst2 / 3000.0d0,.90d0 , 4000.0d0,1.70d0, 5000.0d0,2.20d0,          
     & 6000.0d0, 2.50d0, 7000.0d0, 3.0d0 , 9000.0d0,3.50d0,                     
     &10000.0d0, 3.90d0,15000.0d0, 4.50d0,16000.0d0,5.20d0,                     
     &24000.0d0, 6.0d0 ,25000.0d0, 6.50d0, 1.e20, 7.0d0/                        
c Personal Credit   (data for years 1987-2006) -- real variable                 
      data pcr/18*20.,21.,22.,6*23.,7*26.,2*29./                                
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep =2                                           
      ided = int(data(4))                                                            
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012) phas92=100000.*aif92(law)/sep             
      if(law.ge.2013.and.law.le.2017)                                           
     &phas92 = filing(mst,250000.,300000.,275000.,150000.)*aif13(law)           
c AGI                                                                           
      if(law.le.1998) then                                                      
        capgn = comnew(6)                                                       
        if(law.le.1990.and.capgn.lt.0) capgn = comnew(5)                        
      else if(law.ge.1999) then                                                 
        if(comnew(6).gt.0) then                                                 
          if(data(68).lt.0) then                                                
            capgn = pcrcg(law)*(data(70) + data(68))                            
          else                                                                  
            capgn = pcrcg(law)*data(70) + data(68)                              
c 2015 has 50% on Jan. and 55% on Feb.- Dec. I take 55%                         
c 2016 has 55% for a half-year and 50% for another half. I take 50%             
          endif                                                                 
        else                                                                    
          capgn = comnew(6)                                                     
        endif                                                                   
        if(law.ge.2014) capgn = min(capgn,10000000.0d0)                         
c Separate returns                                                              
c       capgn = capgn/sep                                                       
      endif                                                                     
      divs=data(12)-comnew(4)                                                   
      intinc=int(min(xif(law.le.1986,150.*data(7)),data(14)))                        
      alimon=data(62)-data(23)                                                  
      pnsion=data(20)+data(72)                                                  
      if(law.le.2017) then                                                      
         pendis=pnsion+comnew(82)                                               
      else                                                                      
         pendis = pnsion                                                        
      endif                                                                     
c      agi=comnew(2)-comnew(6)+capgn+divs-intinc-data(22)+data(26)-             
c     & comnew(78)-comnew(79)+.5*(comnew(175)+data(44))                         
      agi = data(11)+data(12)+data(14)+data(23)+data(17)+capgn                  
     &+comnew(8)+data(21)-data(26)-data(124)-comnew(14)-data(62)                
     &+data(20)+data(72)+data(24)+data(19)                                      
      agi = data(11)+data(12)+data(14)+data(23)+data(17)+                       
     & data(20)+data(72)+data(24)+data(19)                                      
      agi = agi+data(21)-data(26)-data(124)-data(62)                            
      agi = agi+capgn+comnew(8)-comnew(14)                                      
c 2018+ qbi income                                                              
      agi = agi+data(211)+data(214)+data(212)+data(215)+data(213)               
c 2018+ Unemployment Compensation is subject to the income tax                  
c Act 154 exempts unemployment benefits from income tax for 2020 and 2021       
      if(law.ge.2018.and.law.le.2019) agi=agi+data(82)                          
      if(law.eq.1982) then                                                      
        agi=agi+max((comnew(12)-1500.-xif(mst.eq.2,875.0d0)),0.0d0)             
        agi=agi+max((comnew(14)-7500.),0.0d0)                                   
      endif                                                                     
      if(law.lt.1983) agi=agi+alimon                                            
      if(law.ge.1989) agi=agi-data(26)                                          
      if(law.eq.1983)agi=agi-min(1000.0d0,pnsion)                               
      if(law.eq.1984)agi=agi-min(2000.*data(7),pnsion)                          
      if(law.ge.1985.and.law.le.1989)agi=agi-min(6000.*data(7),pendis)          
      if(law.ge.1990)then                                                       
c        penexc = min(pendis,data(7)*6000.)                                     
        penexc = min(pendis,data(9)*6000.)                                      
        agi = agi - penexc                                                      
c        agi=agi+xif(pendis.ge.6000.,pendis-6000.)                              
      endif                                                                     
c Act 817 of 1999 extended the $6,000 exemption from income tax for benefits    
c paid from an employer sponsored retirement plan to distributions from an IRA. 
c This exemption will be available to calendar year 2000 State of Arkansas      
c Individual Income Tax returns. The aggregate exclusion may not exceed $6,000  
c for all retirement plans for each taxpayer. The taxpayer must be 59 ? years of
c age at the time of the distribution unless the distribution is because of     
c disability or death of the taxpayer.                                          
c DEDUCTIONS                                                                    
      if (law.ge.1998) then                                                     
          stded=std(law)*data(7)                                                
      else if (law.ge.1987.and.law.le.1997) then                                
          stded=twn(.1d0*agi,0.0d0,2000.d0*data(7)/sep)                         
      else                                                                      
          stded=twn(.1d0*agi,0.0d0,4000.d0*data(7)/sep)                         
      endif                                                                     
c non-itemizer charitable contribution                                          
      if(law.ge.1983.and.law.le.1986)stded=stded+comnew(81)                     
      xitded = max(0.0d0,comnew(30)-data(50))
c      write(0,*) '1 xitded',xitded
c Arkansas has not conformed to certain provisions in TCJA                      
      if(law.ge.2018) then                                                      
        agix = max(0.d0,agi)                                                    
        edical = max(0.0d0,data(47)+data(48)+data(49)-.1*agix)                  
        tmisc = max(0.0d0,data(63)-.02*agix)                                    
        xitded = edical+data(51)+data(54)+data(56)+comnew(23)+tmisc             
      endif                                                                     
      if(agi.gt.phas92.and.law.ge.1991.and.law.le.2017) then                    
        reduce = min(.8*xitded,.03*(agi-phas92))                                
c AR doesn't have 1/3 and 2/3 decreasing of "reduce" in 2006-2008               
        if(law.eq.2009) then                                                    
          reduce = min(.8*xitded,.01*(agi-phas92))                              
        else if(law.ge.2010.and.law.le.2012) then                               
          reduce = 0.                                                           
        endif                                                                   
        xitded = xitded-reduce                                                  
      endif
      if(ided.eq.-2) xitded=0                                                   
      deduc = max(stded,xitded)                                                 
c      if(law.le.1997.and.stded.gt.xitded) deduc = 0.                           
      taxinc=max(0.0d0,agi-deduc)                                               
c      write(0,*) 'agi deduc taxinc',agi,deduc,taxinc                          
      if(mst.eq.2.and.agi.gt.0) then                                            
        agih = max(data(85),data(86))+.5*(agi - data(11))                       
        agiw = agi-agih                                                         
        xitdh = xitded*agih/agi                                                 
        xitdw = xitded-xitdh                                                    
        dedh = max(.5*stded,xitdh)                                              
        dedw = max(.5*stded,xitdw)                                              
c        stdh = stded*agih/agi                                                  
c        stdw = stded - stded*agih/agi                                          
c        dedh = max(stdh,xitdh)                                                 
c        dedw = max(stdw,xitdw)                                                 
        taxinh=max(0.0d0,agih-dedh)                                             
        taxinw=max(0.0d0,agiw-dedw)                                             
      endif                                                                     
      do 999 i=1,6                                                              
      do 998 j=1,2                                                              
        tab(j,i) = tbase(j,i)                                                   
998   continue                                                                  
999   continue                                                                  
      if(law.le.1997) then                                                      
        if(stded.ge.xitded.and.ided.ne.-1) then                                 
c For taxpayers who take standard deductions before 1998                        
          if(sep.eq.1) then                                                     
            call look(tabst1,agi,10,n,statax,1.0d00,-data(2),rt,data)           
          else                                                                  
            call look(tabst2,agi,12,n,statax,1.0d00,-data(2),rt,data)           
          endif                                                                 
        else                                                                    
c For taxpayers who take itemized deductions before 1998                        
          call look(tab,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                  
          if(mst.eq.2.and.agi.gt.0) then                                        
           call look(tab,taxinh,6,n,stath,1.0d0,0.0d0,rt,data)                  
           call look(tab,taxinw,6,n,statw,1.0d0,0.0d0,rt,data)                  
           statax = min(statax,stath+statw)                                     
          endif                                                                 
        endif                                                                   
      else if(law.ge.1998.and.law.le.2015) then                                 
        if(law.eq.1999) then                                                    
          do 1999 i=1,5                                                         
          tab(1,i) = tab99(i)                                                   
1999      continue                                                              
        else if(law.eq.2000) then                                               
          do 2000 i=1,5                                                         
          tab(1,i) = tab00(i)                                                   
2000      continue                                                              
        else if(law.eq.2001) then                                               
          do 2001 i=1,5                                                         
          tab(1,i) = tab01(i)                                                   
2001      continue                                                              
        else if(law.eq.2002) then                                               
          do 2002 i=1,5                                                         
          tab(1,i) = tab02(i)                                                   
2002      continue                                                              
        else if(law.eq.2003) then                                               
          do 2003 i=1,5                                                         
          tab(1,i) = tab03(i)                                                   
2003      continue                                                              
        else if(law.eq.2002) then                                               
          do 2004 i=1,5                                                         
          tab(1,i) = tab04(i)                                                   
2004      continue                                                              
        else if(law.eq.2005) then                                               
          do 2005 i=1,5                                                         
          tab(1,i) = tab05(i)                                                   
2005      continue                                                              
        else if(law.eq.2006) then                                               
          do 2006 i=1,5                                                         
          tab(1,i) = tab06(i)                                                   
2006      continue                                                              
        else if(law.eq.2007) then                                               
          do 2007 i=1,5                                                         
          tab(1,i) = tab07(i)                                                   
2007      continue                                                              
        else if(law.eq.2008) then                                               
          do 2008 i=1,5                                                         
          tab(1,i) = tab08(i)                                                   
2008      continue                                                              
        else if(law.eq.2009) then                                               
          do 2009 i=1,5                                                         
          tab(1,i) = tab09(i)                                                   
2009      continue                                                              
        else if(law.eq.2010) then                                               
          do 2010 i=1,5                                                         
          tab(1,i) = tab10(i)                                                   
2010      continue                                                              
        else if(law.eq.2011) then                                               
          do 2011 i=1,5                                                         
          tab(1,i) = tab11(i)                                                   
2011      continue                                                              
        else if(law.eq.2012.or.law.eq.2013) then                                
          do 2012 i=1,5                                                         
          tab(1,i) = tab12(i)                                                   
2012      continue                                                              
        else if(law.eq.2014) then                                               
          do 2014 i=1,5                                                         
          tab(1,i) = tab14(i)                                                   
2014      continue                                                              
        else if(law.eq.2015) then                                               
          do 2015 i=1,5                                                         
          tab(1,i) = tab15(i)                                                   
2015      continue                                                              
        endif                                                                   
        if(law.ge.2014) tab(2,1) = .9d0                                         
        if(law.eq.2015) then                                                    
           tab(2,2) = 2.4d0                                                     
           tab(2,3) = 3.4d0                                                     
           tab(2,4) = 4.4d0                                                     
        endif                                                                   
        call look(tab,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                    
        if(mst.eq.2.and.agi.gt.0) then                                          
           call look(tab,taxinh,6,n,stath,1.0d0,0.0d0,rt,data)                  
           call look(tab,taxinw,6,n,statw,1.0d0,0.0d0,rt,data)                  
           statax = min(statax,stath+statw)                                     
        endif                                                                   
      else if(law.eq.2016) then                                                 
        call look(tab16,taxinc,8,n,statax,1.0d0,0.0d0,rt,data)                  
        if(mst.eq.2.and.agi.gt.0) then                                          
           call look(tab16,taxinh,8,n,stath,1.0d0,0.0d0,rt,data)                
           call look(tab16,taxinw,8,n,statw,1.0d0,0.0d0,rt,data)                
           statax = min(statax,stath+statw)                                     
        endif                                                                   
      else if(law.eq.2017) then                                                 
         do 10 i=1,12                                                           
           if(taxinc.lt.tab17t(i,1)) go to 20                                   
10       continue                                                               
20      statax = tab17t(i,2)*taxinc/100 - tab17t(i,3)                           
         if(mst.eq.2.and.agi.gt.0) then                                         
            do 11 i=1,12                                                        
              if(taxinh.lt.tab17t(i,1)) go to 21                                
11          continue                                                            
21          stath = tab17t(i,2)*taxinh/100 - tab17t(i,3)                        
            do 12 i=1,12                                                        
              if(taxinw.lt.tab17t(i,1)) go to 22                                
12          continue                                                            
22          statw = tab17t(i,2)*taxinw/100 - tab17t(i,3)                        
            statax = min(statax,stath+statw)                                    
         endif                                                                  
      else if(law.eq.2018) then                                                 
         do 100 i=1,12                                                          
           if(taxinc.lt.tab18t(i,1)) go to 200                                  
100       continue                                                              
200      statax = tab18t(i,2)*taxinc/100 - tab18t(i,3)                          
         if(mst.eq.2.and.agi.gt.0) then                                         
            do 110 i=1,12                                                       
             if(taxinh.lt.tab18t(i,1)) go to 210                                
110          continue                                                           
210          stath = tab18t(i,2)*taxinh/100 - tab18t(i,3)                       
            do 120 i=1,12                                                       
              if(taxinw.lt.tab18t(i,1)) go to 220                               
120         continue                                                            
220         statw = tab18t(i,2)*taxinw/100 - tab18t(i,3)                        
            statax = min(statax,stath+statw)                                    
         endif                                                                  
      else if(law.eq.2019) then                                                 
         do 130 i=1,12                                                          
           if(taxinc.lt.tab19t(i,1)) go to 140                                  
130      continue                                                               
140      statax = tab19t(i,2)*taxinc/100 - tab19t(i,3)                          
         if(mst.eq.2.and.agi.gt.0) then                                         
            do 150 i=1,12                                                       
             if(taxinh.lt.tab19t(i,1)) go to 160                                
150         continue                                                            
160         stath = tab19t(i,2)*taxinh/100 - tab19t(i,3)                        
            do 170 i=1,12                                                       
              if(taxinw.lt.tab19t(i,1)) go to 180                               
170         continue                                                            
180         statw = tab19t(i,2)*taxinw/100 - tab19t(i,3)                        
            statax = min(statax,stath+statw)                                    
         endif                                                                  
      else if(law.eq.2020) then                                                 
         do 131 i=1,12                                                          
           if(taxinc.lt.tab20t(i,1)) go to 141                                  
131      continue                                                               
141      statax = tab20t(i,2)*taxinc/100 - tab20t(i,3)                          
         if(mst.eq.2.and.agi.gt.0) then                                         
            do 151 i=1,12                                                       
             if(taxinh.lt.tab20t(i,1)) go to 161                                
151         continue                                                            
161         stath = tab20t(i,2)*taxinh/100 - tab20t(i,3)                        
            do 171 i=1,12                                                       
              if(taxinw.lt.tab20t(i,1)) go to 181                               
171         continue                                                            
181         statw = tab20t(i,2)*taxinw/100 - tab20t(i,3)                        
            statax = min(statax,stath+statw)                                    
         endif                                                                  
      else if(law.eq.2021) then                                                 
         do 132 i=1,12                                                          
           if(taxinc.lt.tab21t(i,1)) go to 142                                  
132      continue                                                               
142      statax = tab21t(i,2)*taxinc/100 - tab21t(i,3)                          
         if(mst.eq.2.and.agi.gt.0) then                                         
            do 152 i=1,12                                                       
             if(taxinh.lt.tab21t(i,1)) go to 162                                
152         continue                                                            
162         stath = tab21t(i,2)*taxinh/100 - tab21t(i,3)                        
            do 172 i=1,12                                                       
              if(taxinw.lt.tab21t(i,1)) go to 182                               
172         continue                                                            
182         statw = tab21t(i,2)*taxinw/100 - tab21t(i,3)                        
            statax = min(statax,stath+statw)                                    
         endif                                                                  
                                                                                
      endif                                                                     
c For tax years 2003-2004, the act imposes a 3% income tax surcharge            
      if(law.ge.2003.and.law.le.2004) statax = 1.03*statax                      
c 1998 - 2002 Working Taxpayer Credit                                           
      work = 0.                                                                 
      work86 = 0.                                                               
      work85 = 0.                                                               
      if(law.ge.1998.and.law.le.2002) then                                      
        if(data(85).gt.0.and.data(86).gt.0) then                                
           winc85 = max(data(85),data(86))+data(21)+data(17)                    
           winc86 = min(data(85),data(86))                                      
           if(winc85.gt.400.) work85 = min(50.0d0,.00125*winc85)                
           if(winc86.gt.400.) work86 = min(50.0d0,.00125*winc86)                
           work = work85+work86                                                 
        else                                                                    
           winc = data(11)+data(21)+data(17)                                    
           if(winc.gt.400.) work = min(50.0d0,.00125*winc)                      
        endif                                                                   
      endif                                                                     
      statax=max(statax-work,0.0d0)                                             
c LOW INCOME TAX TABLE                                                          
c Taxpayers who use the Low Income Table do not qualify for                     
c the Working Taxpayer Credit                                                   
c low income tax table before 1991                                              
      if(law.le.1990)then                                                       
          if(mst.eq.1.and.agi.le.3100.) then                                    
            statax=aint((agi-2990.)/10)                                         
            if(agi.lt.3010.)statax=0.                                           
          else if(mst.eq.2.and.data(8).lt.1.and.agi.le.4100.) then              
            statax=aint(((agi-3990.)/10))*1.2                                   
            if(agi.lt.4008.)statax=0.                                           
          else if(mst.eq.2.or.mst.eq.4.or.mst.eq.7) then                        
            if(data(8).le.1.and.agi.le.4600.) then                              
              statax=aint(((agi-4490.)/10))*1.7                                 
              if(agi.lt.4505.)statax=0.                                         
            endif                                                               
            if(data(8).ge.2.and.agi.le.5100.) then                              
              statax=aint(((agi-4990.)/10))*1.1                                 
              if(agi.lt.5004.)statax=0.                                         
            endif                                                               
          endif                                                                 
      endif                                                                     
c low income tax table after 1991:numbers approximate w/in $10                  
c for years 1998-2002 NOTE: The standard deduction and                          
c the working taxpayer credit are incorporated into                             
c the low income tax table.                                                     
      if(sep.eq.1.and.law.ge.1991)then                                          
        if(mst.eq.1) then                                                       
c 1997 and before single                                                        
         if(law.le.1997) then                                                   
          if(agi.le.5500) statax=0.                                             
          if(agi.gt.5500.and.agi.le.8400)statax = 26 + (agi-5500)*.01           
          if(agi.gt.8400.and.agi.lt.11400)statax = 106 + (agi-8400)*.02         
c 1998 - 2006 single                                                            
         else if(law.ge.1998.and.law.le.2006) then                              
          if(agi.le.7800) statax = 0.                                           
          if(agi.gt.7800.and.agi.le.11400)statax = 21. + (agi-7800)*.034        
c 2007 single                                                                   
         else if(law.eq.2007) then                                              
          if(agi.le.10200) statax = 0.                                          
          if(agi.gt.10200.and.agi.le.13500)statax = 29.+                        
     &    (agi-10200)*.073939394                                                
c 2008 single                                                                   
         else if(law.eq.2008) then                                              
          if(agi.le.10506) statax = 0.                                          
          if(agi.gt.10506.and.agi.le.13900)statax = 33. +                       
     &    (agi-10506)*.07424867                                                 
c 2009 single                                                                   
         else if(law.eq.2009) then                                              
          if(agi.le.10526) statax = 0.                                          
          if(agi.gt.10526.and.agi.le.13800)statax = 32. +                       
     &    (agi-10526)*.068                                                      
c 2010 single                                                                   
         else if(law.eq.2010) then                                              
          if(agi.le.10681) statax = 0.                                          
          if(agi.gt.10681.and.agi.le.14000)statax = 33. +                       
     &    (agi-10681)*.075                                                      
c 2011 single                                                                   
         else if(law.eq.2011) then                                              
          if(agi.le.10940) statax = 0.                                          
          if(agi.gt.10940.and.agi.le.14400)statax = 35. +                       
     &    (agi-10940)*.075                                                      
c 2012 single                                                                   
         else if(law.eq.2012) then                                              
          if(agi.le.11220) statax = 0.                                          
          if(agi.gt.11220.and.agi.le.14800)statax = 36. +                       
     &    (agi-11220)*.075                                                      
c 2013 single                                                                   
         else if(law.eq.2013) then                                              
          if(agi.le.11410) statax = 0.                                          
          if(agi.gt.11410.and.agi.le.15100)statax = 37. +                       
     &    (agi-11410)*.075                                                      
c 2014 single                                                                   
         else if(law.eq.2014) then                                              
          if(agi.le.11591) statax = 0.                                          
          if(agi.gt.11591.and.agi.le.15200)statax = 36. +                       
     &    (agi-11591)*.076                                                      
c 2015 single                                                                   
         else if(law.eq.2015) then                                              
          if(agi.le.11643) statax = 0.                                          
          if(agi.gt.11643.and.agi.le.15100)statax = 35. +                       
     &    (agi-11643)*.073                                                      
c 2016 single                                                                   
         else if(law.eq.2016) then                                              
          if(agi.le.11736) statax = 0.                                          
          if(agi.gt.11736.and.agi.le.15200)statax = 35. +                       
     &    (agi-11736)*.073                                                      
c 2017 single                                                                   
         else if(law.eq.2017) then                                              
          if(agi.lt.11970) statax = 0.                                          
          if(agi.ge.11970.and.agi.le.15500)statax = 36. +                       
     &    (agi-11970)*.07365                                                    
c 2018 single                                                                   
         else if(law.eq.2018) then                                              
          if(agi.lt.12260) statax = 0.                                          
          if(agi.ge.12260.and.agi.le.15900)statax = 37. +                       
     &    (agi-12260)*.0739                                                     
c 2019 single                                                                   
         else if(law.eq.2019) then                                              
          if(agi.lt.12492) statax = 0.                                          
          if(agi.ge.12492.and.agi.le.14900)statax = 25. +                       
     &    (agi-12492)*.0692                                                     
c 2020 single                                                                   
         else if(law.eq.2020) then                                              
          if(agi.lt.12675) statax = 0.                                          
          if(agi.ge.12675.and.agi.le.15200)statax = 26. +                       
     &    (agi-12675)*.0693                                                     
c 2021 single                                                                   
         else if(law.eq.2021) then                                              
          if(agi.lt.13054) statax = 0.                                          
          if(agi.ge.13054.and.agi.le.15700)statax = 27. +                       
     &    (agi-13054)*.0688                                                     
                                                                                
         endif                                                                  
        else if(mst.eq.2.or.mst.eq.5) then                                      
c 1997 and before married                                                       
         if(law.le.1997) then                                                   
          if(agi.le.10000) statax = 0.                                          
          if(agi.gt.10000.and.agi.le.13000)statax = 71. +                       
     &    (agi-10000)*.01467                                                    
          if(agi.gt.13000.and.agi.le.16200)statax = 230. +                      
     &    (agi-13000)*.03                                                       
c 1998 - 2006 married                                                           
         else if(law.ge.1998.and.law.le.2006) then                              
           if(agi.le.15500) then                                                
              statax = 0.                                                       
           else if(agi.le.16000..and.agi.gt.15500) then                         
              statax = 78.5+(agi-15500)*.015                                    
           else if(agi.le.16200..and.agi.gt.16000) then                         
              statax = 114.+(agi-16000)*.02                                     
           endif                                                                
c 2007 married                                                                  
         else if(law.eq.2007) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.17200) then                                              
                statax = 0.                                                     
             else if(agi.gt.17200.and.agi.le.21400) then                        
                statax = 66. + (agi-17200.)*.1121412857                         
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.20700.) then                                             
                statax = 0.                                                     
             else if(agi.gt.20700..and.agi.le.26700) then                       
                statax = 97. + (agi-20700)*.123333                              
             endif                                                              
           endif                                                                
c 2008 married                                                                  
         else if(law.eq.2008) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.17716.) then                                             
                statax = 0.                                                     
             else if(agi.gt.17716.and.agi.le.22000) then                        
                statax = 74. + (agi-17716)*.112745098                           
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.21321.) then                                             
                statax = 0.                                                     
             else if(agi.gt.21321..and.agi.le.27400) then                       
                statax = 107. + (agi-21321)*.124198                             
             endif                                                              
           endif                                                                
c 2009 married                                                                  
         else if(law.eq.2009) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.17749.) then                                             
                statax = 0.                                                     
             else if(agi.gt.17749..and.agi.le.21900) then                       
                statax = 73. + (agi-17749.)*.113                                
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.21362.) then                                             
                statax = 0.                                                     
             else if(agi.gt.21362..and.agi.le.27400) then                       
                statax = 107. + (agi-21362.)*.1235                              
             endif                                                              
           endif                                                                
c 2010 married                                                                  
         else if(law.eq.2010) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.18011.) then                                             
                statax = 0.                                                     
             else if(agi.gt.18011..and.agi.le.22400) then                       
                statax = 76. + (agi-18011.)*.11255                              
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.21676.) then                                             
                statax = 0.                                                     
             else if(agi.gt.21676.and.agi.le.27800) then                        
                statax = 108. + (agi-21676)*.124755                             
             endif                                                              
           endif                                                                
c 2011 married                                                                  
         else if(law.eq.2011) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.18448.) then                                             
                statax = 0.                                                     
             else if(agi.gt.18448.and.agi.le.22400) then                        
                statax = 78. + (agi-18448.)*.1137                               
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.22202) then                                              
                statax = 0.                                                     
             else if(agi.gt.22202.and.agi.le.27800) then                        
                statax = 112. + (agi-22202)*.1243                               
             endif                                                              
           endif                                                                
c 2012 married                                                                  
         else if(law.eq.2012) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.18992.) then                                             
                statax = 0.                                                     
             else if(agi.gt.18922.and.agi.le.23600) then                        
                statax = 81. + (agi-18922.)*.113                                
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.22773) then                                              
                statax = 0.                                                     
             else if(agi.gt.22773.and.agi.le.29400) then                        
                statax = 116. + (agi-22773)*.1257                               
             endif                                                              
           endif                                                                
c 2013 married                                                                  
         else if(law.eq.2013) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.19242.) then                                             
                statax = 0.                                                     
             else if(agi.gt.19243.and.agi.le.24000) then                        
                statax = 83. + (agi-19243.)*.115                                
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.23159) then                                              
                statax = 0.                                                     
             else if(agi.gt.23159.and.agi.le.29900) then                        
                statax = 118. + (agi-23159)*.115                                
             endif                                                              
           endif                                                                
c 2014 married                                                                  
         else if(law.eq.2014) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.19547.) then                                             
                statax = 0.                                                     
             else if(agi.gt.19547.and.agi.le.24400) then                        
                statax = 84. + (agi-19547.)*.114                                
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.23525) then                                              
                statax = 0.                                                     
             else if(agi.gt.23525.and.agi.le.30400) then                        
                statax = 120. + (agi-23525.)*.125                               
             endif                                                              
           endif                                                                
c 2015 married                                                                  
         else if(law.eq.2015) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.19635.) then                                             
                statax = 0.                                                     
             else if(agi.gt.19635.and.agi.le.24200) then                        
                statax = 79. + (agi-19635.)*.112                                
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.23631) then                                              
                statax = 0.                                                     
             else if(agi.gt.23631.and.agi.le.30200) then                        
                statax = 114. + (agi-23631.)*.1267                              
             endif                                                              
           endif                                                                
c 2016 married                                                                  
         else if(law.eq.2016) then                                              
           if(data(8).le.1) then                                                
             if(agi.le.19793.) then                                             
                statax = 0.                                                     
             else if(agi.gt.19793.and.agi.le.24300) then                        
                statax = 80. + (agi-19793.)*.1138                               
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.le.23821) then                                              
                statax = 0.                                                     
             else if(agi.gt.23821.and.agi.le.30500) then                        
                statax = 116. + (agi-23821.)*.12                                
             endif                                                              
           endif                                                                
c 2017 married                                                                  
         else if(law.eq.2017) then                                              
           if(data(8).le.1) then                                                
             if(agi.lt.20187) then                                              
                statax = 0.                                                     
             else if(agi.ge.20187.and.agi.le.24800) then                        
                statax = 82. + (agi-20187.)*.1136                               
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.lt.24295) then                                              
                statax = 0.                                                     
             else if(agi.ge.24295.and.agi.le.31000) then                        
                statax = 118. + (agi-24295.)*.121                               
             endif                                                              
           endif                                                                
c 2018 married                                                                  
         else if(law.eq.2018) then                                              
           if(data(8).le.1) then                                                
             if(agi.lt.20675) then                                              
                statax = 0.                                                     
             else if(agi.ge.20675.and.agi.le.25500) then                        
                statax = 85. + (agi-20675.)*.11337                              
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.lt.24882) then                                              
                statax = 0.                                                     
             else if(agi.ge.24882.and.agi.le.31800) then                        
                statax = 122. + (agi-24882.)*.1208                              
             endif                                                              
           endif                                                                
c 2019 married                                                                  
         else if(law.eq.2019) then                                              
           if(data(8).le.1) then                                                
             if(agi.lt.21067) then                                              
                statax = 0.                                                     
             else if(agi.ge.21067.and.agi.le.24800) then                        
                statax = 66. + (agi-21067.)*.102                                
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.lt.25355) then                                              
                statax = 0.                                                     
             else if(agi.ge.25355.and.agi.le.30800) then                        
                statax = 95. + (agi-25355.)*.1465                               
             endif                                                              
           endif                                                                
c 2020 married                                                                  
         else if(law.eq.2020) then                                              
           if(data(8).le.1) then                                                
             if(agi.lt.21375) then                                              
                statax = 0.                                                     
             else if(agi.ge.21375.and.agi.le.25200) then                        
                statax = 67. + (agi-21375.)*.1033                               
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.lt.25726) then                                              
                statax = 0.                                                     
             else if(agi.ge.25726.and.agi.le.31300.) then                       
                statax = 97. + (agi-25726.)*.1464                               
             endif                                                              
           endif                                                                
c 2021 married                                                                  
         else if(law.eq.2021) then                                              
           if(data(8).le.1) then                                                
             if(agi.lt.22016) then                                              
                statax = 0.                                                     
             else if(agi.ge.22016.and.agi.le.26100) then                        
                statax = 70. + (agi-22016.)*.1018                               
             endif                                                              
           else if(data(8).ge.2) then                                           
             if(agi.lt.26496) then                                              
                statax = 0.                                                     
             else if(agi.ge.26496.and.agi.le.32200.) then                       
                statax = 100. + (agi-26496.)*.148                               
             endif                                                              
           endif                                                                
                                                                                
                                                                                
         endif                                                                  
        else if(mst.eq.4.or.mst.eq.7) then                                      
c 1997 and before hoh                                                           
         if(law.le.1997) then                                                   
           if(agi.le.7200.) then                                                
             statax=0.                                                          
           else if(agi.le.11600..and.agi.gt.7200) then                          
             statax=42.+max(0.0d0,agi-7400)*.0119                               
           else if(agi.le.16200..and.agi.gt.11600) then                         
             statax=189.+(agi-11600)*.03                                        
           endif                                                                
c 1998-2006 hoh                                                                 
         else if (law.ge.1998.and.law.le.2006) then                             
           if(agi.le.12100.) then                                               
              statax = 0.                                                       
           else if(agi.le.13000..and.agi.gt.12100) then                         
              statax = 41.+(agi-12100)*.01                                      
           else if(agi.le.15200.and.agi.gt.13000) then                          
               statax = 82.5+(agi-13000)*.015                                   
           else if(agi.le.16100.and.agi.gt.15200) then                          
               statax = 200.5+(agi-15200)*.025                                  
           endif                                                                
c 2007 hoh                                                                      
         else if (law.eq.2007) then                                             
           if(agi.le.14500.) then                                               
              statax = 0.                                                       
           else if(agi.gt.14500..and.agi.le.19000) then                         
              statax = 59. + (agi-14500.)*.102666                               
           endif                                                                
c 2008 hoh                                                                      
         else if (law.eq.2008) then                                             
           if(agi.le.14935.) then                                               
              statax = 0.                                                       
           else if(agi.gt.14935..and.agi.le.19400) then                         
              statax = 67. + (agi-14935.)*.103471                               
           endif                                                                
c 2009 hoh                                                                      
         else if (law.eq.2009) then                                             
           if(agi.le.14963.) then                                               
              statax = 0.                                                       
           else if(agi.gt.14963..and.agi.le.19300) then                         
              statax = 66. + (agi-14963.)*.104                                  
           endif                                                                
c 2010 hoh                                                                      
         else if (law.eq.2010) then                                             
           if(agi.le.15184) then                                                
              statax = 0.                                                       
           else if(agi.gt.15184..and.agi.le.19600) then                         
              statax = 67. + (agi-15184)*.1046                                  
           endif                                                                
c 2011 hoh                                                                      
         else if (law.eq.2011) then                                             
           if(data(8).le.1) then                                                
             if(agi.le.15552) then                                              
                statax = 0.                                                     
             else if(agi.gt.15552.and.agi.le.20200) then                        
                statax = 70. + (agi-15552)*.104                                 
             endif                                                              
           else                                                                 
             if(agi.le.18539.) then                                             
                statax = 0.                                                     
             else if(agi.gt.18539..and.agi.le.22900) then                       
                statax = 97. + (agi-18540)*.1365                                
             endif                                                              
           endif                                                                
c 2012 hoh                                                                      
         else if (law.eq.2012) then                                             
           if(data(8).le.1) then                                                
             if(agi.le.15952.) then                                             
                statax = 0.                                                     
             else if(agi.gt.15952.and.agi.le.20800) then                        
                statax = 72. + (agi-15952)*.104                                 
             endif                                                              
           else                                                                 
             if(agi.le.19016) then                                              
                statax = 0.                                                     
             else if(agi.gt.19016.and.agi.le.23500) then                        
                statax = 100. + (agi-19016)*.136                                
             endif                                                              
           endif                                                                
c 2013 hoh                                                                      
         else if (law.eq.2013) then                                             
           if(data(8).le.1) then                                                
             if(agi.le.16223.) then                                             
                statax = 0.                                                     
             else if(agi.gt.16223.and.agi.le.21200) then                        
                statax = 74. + (agi-16223)*.105                                 
             endif                                                              
           else                                                                 
             if(agi.le.19338) then                                              
                statax = 0.                                                     
             else if(agi.gt.19338.and.agi.le.23900) then                        
                statax = 102. + (agi-19338)*.135                                
             endif                                                              
           endif                                                                
c 2014 hoh                                                                      
         else if (law.eq.2014) then                                             
           if(data(8).le.1) then                                                
             if(agi.le.16479.) then                                             
                statax = 0.                                                     
             else if(agi.gt.16479.and.agi.le.21400) then                        
                statax = 74. + (agi-16479)*.104                                 
             endif                                                              
           else                                                                 
             if(agi.le.19644) then                                              
                statax = 0.                                                     
             else if(agi.gt.19644.and.agi.le.24200) then                        
                statax = 103. + (agi-19644)*.137                                
             endif                                                              
           endif                                                                
c 2015 hoh                                                                      
         else if (law.eq.2015) then                                             
           if(data(8).le.1) then                                                
             if(agi.le.16553.) then                                             
                statax = 0.                                                     
             else if(agi.gt.16553.and.agi.le.21300) then                        
                statax = 71. + (agi-16553)*.103                                 
             endif                                                              
           else                                                                 
             if(agi.le.19733) then                                              
                statax = 0.                                                     
             else if(agi.gt.19733.and.agi.le.24200) then                        
                statax = 99. + (agi-19733)*.139                                 
             endif                                                              
           endif                                                                
c 2016 hoh                                                                      
         else if (law.eq.2016) then                                             
           if(data(8).le.1) then                                                
             if(agi.le.16686.) then                                             
                statax = 0.                                                     
             else if(agi.gt.16686.and.agi.le.21400) then                        
                statax = 72. + (agi-16686)*.105                                 
             endif                                                              
           else                                                                 
             if(agi.le.19891) then                                              
                statax = 0.                                                     
             else if(agi.gt.19891.and.agi.le.24300) then                        
                statax = 100. + (agi-19891)*.139                                
             endif                                                              
           endif                                                                
c 2017 hoh                                                                      
         else if (law.eq.2017) then                                             
           if(data(8).le.1) then                                                
             if(agi.lt.17019) then                                              
                statax = 0.                                                     
             else if(agi.ge.17019.and.agi.le.22000) then                        
                statax = 74. + (agi-17019)*.1024                                
             endif                                                              
           else                                                                 
             if(agi.lt.20287) then                                              
                statax = 0.                                                     
             else if(agi.ge.20287.and.agi.le.24800) then                        
                statax = 102. + (agi-20287)*.139                                
             endif                                                              
           endif                                                                
c 2018 hoh                                                                      
         else if (law.eq.2018) then                                             
           if(data(8).le.1) then                                                
             if(agi.lt.17430) then                                              
                statax = 0.                                                     
             else if(agi.ge.17430.and.agi.le.22500) then                        
                statax = 76. + (agi-17430)*.1026                                
             endif                                                              
           else                                                                 
             if(agi.lt.20777) then                                              
                statax = 0.                                                     
             else if(agi.ge.20777.and.agi.le.25400) then                        
                statax = 105. + (agi-20777)*.138                                
             endif                                                              
           endif                                                                
c 2019 hoh                                                                      
         else if (law.eq.2019) then                                             
           if(data(8).le.1) then                                                
             if(agi.lt.17761.) then                                             
                statax = 0.                                                     
             else if(agi.ge.17761.and.agi.le.21600) then                        
                statax = 58. + (agi-17761)*.093                                 
             endif                                                              
           else                                                                 
             if(agi.lt.21172.) then                                             
                statax = 0.                                                     
             else if(agi.ge.21172.and.agi.le.24800) then                        
                statax = 81. + (agi-21172)*.123                                 
             endif                                                              
           endif                                                                
c 2020 hoh                                                                      
         else if (law.eq.2020) then                                             
           if(data(8).le.1) then                                                
             if(agi.lt.18021.) then                                             
                statax = 0.                                                     
             else if(agi.ge.18021.and.agi.le.22000.) then                       
                statax = 59. + (agi-18021)*.0922                                
             endif                                                              
           else                                                                 
             if(agi.lt.21482) then                                              
                statax = 0.                                                     
             else if(agi.ge.21482.and.agi.le.25100) then                        
                statax = 83. + (agi-21482)*.123                                 
             endif                                                              
           endif                                                                
c 2021 hoh                                                                      
         else if (law.eq.2021) then                                             
           if(data(8).le.1) then                                                
             if(agi.lt.18561) then                                              
                statax = 0.                                                     
             else if(agi.ge.18561.and.agi.le.22600.) then                       
                statax = 62. + (agi-18561)*.093                                 
             endif                                                              
           else                                                                 
             if(agi.lt.22125) then                                              
                statax = 0.                                                     
             else if(agi.ge.22125.and.agi.le.26000) then                        
                statax = 86. + (agi-22125)*.17                                  
             endif                                                              
           endif                                                                
                                                                                
                                                                                
         endif                                                                  
        endif                                                                   
      endif                                                                     
c Arkansas Capital Gains and Losses Adjustment AR1000DGW                        
      if(law.le.1998.and.law.ge.1991.and.taxinc.gt.25000) statax =              
     & statax -  .01*min(taxinc-25000,15000.0d0,max(0.0d0,comnew(6)))           
c Total Personal Credits                                                        
      if(law.le.1986) then                                                      
        gcred=17.50*(data(7)+data(9)+data(10))+6.*data(8)                       
      else                                                                      
        gcred= pcr(law)*(data(7)+data(9)+data(10)+data(8))                      
        if(mst.eq.4.or.mst.eq.7) gcred=gcred+pcr(law)                           
        if(data(20)+data(72).eq.0.d0.and.data(9).gt.0.d0)                       
     &  gcred = gcred + pcr(law)                                                
      endif                                                                     
c Child Care Credit                                                             
      dep = min(data(8),2.0d0)                                                  
      child = min(comnew(53),max(0.0d0,comnew(52)-data(34)))                    
      if(law.ge.1998) then                                                      
         chcr = max(0.0d0,.2*child)                                             
      else                                                                      
         chcr = max(0.0d0,.1*child)                                             
      endif                                                                     
      if(law.eq.1982)chcr=min(chcr,40.*dep)                                     
      credit=chcr+gcred                                                         
      statax=max(statax-credit,0.0d0)                                           
      credit=credit+work                                                        
      return                                                                    
      end                                                                       
c  CALIFORNIA                                                                  
c  State 05                                                                     
c                                                                               
c   Updated to 2021 (updated 02/18/2022)                                        
      subroutine catax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255),aif(1977:2021)                            
      dimension tab77s(2,11),tab77h(2,11),tab87s(2,6),tab87h(2,6)               
      dimension tab82s(2,12),tab82h(2,12),tab3s(2,12),tab3h(2,12)               
      dimension tab1s(2,11), tab1h(2,11), tab2s(2,6), tab2h(2,6)                
      dimension rtabm(1977:1992),rtabs(1977:1992), xmpaif(1977:2021)            
      dimension xmpdep(1998:2021),aiftab(1977:2012),aifrent(1998:2021)          
      double precision lowtab(2,6), ltab2(2,6)                                  
      dimension  amtaxh(2,12), amtaxs(2,12), aiflow(1977:1994),                 
     & aifren(1991:1992),aif1(1994:1998),amtrt(1987:2021),                      
     & aif2(1991:1998),ak(1994:1998),aifded(1991:2021),aif12(2012:2021)         
      dimension tab91h(2,8), tab91s(2,8), tab4h(2,8), tab4s(2,8)                
      dimension tab96h(2,6), tab96s(2,6), tab5h(2,6), tab5s(2,6),               
     &tab9h(2,6), tab9s(2,6),tab11h(2,6), tab11s(2,6),                          
     &tab12(2,9),ts12(8),th12(8)                                                
      double precision ira,iralim,iramax,iratax,keogh,kghlim,kghmax,            
     &lowcr,noncr                                                               
      dimension dylim(2015:2021),crmax(2015:2021,0:3),                          
     & amax(2015:2021,0:3),ym(0:3,2017:2021),em(0:3,2017:2021),                 
     & amax17(0:3,2017:2021)                                                    
      integer sep,hoh                                                           
      data amtrt/9*.085d0,12*.07d0,3*.0725d0,11*.07d0/                          
      data ym/                                                                  
     7  5320.d0,9434.d0,13723.d0,13805.d0,                                      
     8  5625.d0,9875.d0,14375.d0,14425.d0,                                      
     9  4350.d0,9350.d0,14100.d0,14350.d0,                                      
     &  4350.d0,9350.d0,14100.d0,14350.d0,                                      
     1  4600.d0,8600.d0,14950.d0,15150.d0/                                      
      data em/                                                                  
     7 100.d0,248.d0,249.d0,269.d0,                                             
     8 102.d0,256.d0,254.d0,255.d0,                                             
     9 200.d0,506.d0,509.d0,502.d0,                                             
     & 200.d0,506.d0,509.d0,502.d0,                                             
     1 212.d0,536.d0,535.d0,534.d0/                                             
      data dylim /3400.d0,3471.d0,3561.d0,3699.d0,3828.d0,3882.d0,              
     & 4053.d0/                                                                 
      data crmax/  214.d0, 217.d0, 223.d0,232.d0,240.d0,243.d0,255.d0,          
     1            1428.d0,1452.d0,1495.d0,1554.d0,1605.d0,1626.d0,              
     1            1698.d0,                                                      
     2            2358.d0,2406.d0,2467.d0,2559.d0,2651.d0,2691.d0,              
     2            2809.d0,                                                      
     3            2653.d0,2706.d0,2775.d0,2879.d0,2982.d0,3027.d0,              
     3            3160.d0/                                                      
      data amax / 6580.d0,   6718.d0, 6858.d0, 7150.d0,3*7510.d0,               
     1            9880.d0,  10088.d0,10298.d0,11108.d0,3*11128.d0,              
     2           13870.d0,  14162.d0,14458.d0,15594.d0,3*15622.d0,              
     3           13870.d0,  14162.d0,14458.d0,15592.d0,3*15622.d0/              
c 2020 amax,em,ym actual amounts are not found yet (02.23.2021 inna)            
      data amax17/                                                              
     7  15008.d0,22322.d0,22309.d0,22302.d0,                                    
     8  16750.d0,24950.d0,24950.d0,24950.d0,                                    
     9  30000.d0,30000.d0,30000.d0,30000.d0,                                    
     &  30000.d0,30000.d0,30000.d0,30000.d0,                                    
     1  30000.d0,30000.d0,30000.d0,30000.d0/                                    
                                                                                
      data aif12 / 1.0d0,1.017d0,1.0394d0,1.0529d0,1.075d0,1.103d0,             
     &   1.1461d0, 1.1814d0, 1.198d0, 1.25d0/                                   
      data aifrent/   1.0d0     ,  1.026d0  ,  1.063960d0,  1.12036d0,          
     &1.137160d0,     1.162160d0,  1.19820d0,  1.231760d0,  1.29088d0,          
     &1.330880d0,     1.357440d0,  1.37648d0,  1.388880d0,2*1.42636d0,          
     &1.478200d0,     1.510720d0,  1.53036d0,  1.562480d0,  1.60312d0,          
     &1.665640d0,     1.717280d0,  2*1.74132d0/                                 
      data aifded/  1.0d0    ,  1.0360d0 ,  1.06190d0,  1.07464d0,              
     &1.09936d0,    1.11695d0,  1.14152d0,  1.16777d0,  1.19813d0,              
     &1.24246d0,    1.30831d0,  1.32793d0,  1.35714d0,  1.39921d0,              
     &1.43839d0,    1.50743d0,  1.55416d0,  1.63187d0,  1.60739d0,              
     &1.62185d0,    1.66565d0,  1.69730d0,  1.72615d0,  1.76413d0,              
     &1.78706d0,    1.82459d0,  1.87203d0,  1.94504d0,  2.00534d0,              
     &2.03341d0,    2.12288d0/                                                  
c need to multiply tax brackets by infl. adj. factor                            
      data tab77s/2000.0d0,  1.0d0,  3500.0d0,  2.0d0,5000.0d0,3.0d0,           
     & 6500.0d0,  4.0d0, 8000.0d0,  5.0d0,  9500.0d0,  6.0d0,                   
     &11000.0d0,  7.0d0,12500.0d0,  8.0d0, 14000.0d0,  9.0d0,                   
     &15500.0d0, 10.0d0,  1.e20, 11.0d0/                                        
      data tab77h/4000.0d0,  1.0d0,  6000.0d0,  2.0d0,7500.0d0,3.0d0,           
     & 9000.0d0,  4.0d0,10500.0d0,  5.0d0, 12000.0d0,6.0d0, 13500.0d0,          
     &7.0d0, 15000.0d0,  8.0d0, 16500.0d0,  9.0d0, 18000.0d0, 10.0d0,           
     &1.e20, 11.0d0/                                                            
      data tab82s/1580.0d0, 0.0d0, 4680.0d0, 1.0d0, 7080.0d0, 2.0d0,            
     & 9380.0d0, 3.0d0, 11680.0d0, 4.0d0, 14080.0d0,5.0d0,16480.0d0,            
     & 6.0d0, 18680.0d0, 7.0d0, 21180.0d0, 8.0d0,23380.0d0, 9.0d0,              
     &25780.0d0, 10.0d0, 1.e20, 11.0d0/                                         
      data tab82h/3070.0d0, 0.0d0, 9270.0d0,1.0d0,12270.0d0,2.0d0,              
     & 14670.0d0, 3.0d0, 16970.0d0,4.0d0,19270.0d0,5.0d0,21570.0d0,             
     &6.0d0, 23970.0d0, 7.0d0, 26170.0d0, 8.0d0,28570.0d0, 9.0d0,               
     &30870.0d0, 10.0d0, 1.e20, 11.0d0/                                         
      data tab87s/3650.0d0,1.0d0,8650.0d0,2.0d0,13650.0d0,4.0d0,                
     & 18950.0d0,6.0d0,24050.0d0,8.0d0,1.e20, 9.30d0/                           
      data tab87h/7300.0d0,1.0d0,17300.0d0,2.0d0,22300.0d0,4.0d0,               
     & 27600.0d0,6.0d0,32599.0d0,8.0d0,1.e20,9.30d0/                            
      data tab91s/4394.0d0,1.0d0,10414.0d0,2.0d0,16435.0d0,4.0d0,               
     & 22816.0d0,6.0d0,28835.0d0, 8.0d0, 100000.0d0, 9.30d0,                    
     &200000.0d0, 10.0d0, 1.e20, 11.0d0/                                        
      data tab91h/8789.0d0, 1.0d0, 20829.0d0, 2.0d0, 26848.0d0, 4.0d0,          
     & 33229.0d0, 6.0d0,39249.0d0, 8.0d0, 136115.0d0, 9.30d0,                   
     &272230.0d0,10.0d0, 1.e20, 11.0d0/                                         
      data tab96s/4908.0d0, 1.0d0, 11632.0d0, 2.0d0, 18357.0d0, 4.0d0,          
     & 25484.0d0, 6.0d0, 32207.0d0, 8.0d0,  1.e20, 9.30d0/                      
      data tab96h/9817.0d0, 1.0d0, 23264.0d0, 2.0d0, 29988.0d0, 4.0d0,          
     & 37114.0d0, 6.0d0, 43839.0d0, 8.0d0, 1.e20,  9.30d0/                      
      data lowtab/10900.0d0,1.0d0,12600.0d0,.80d0,14300.0d0,.60d0,              
     & 16000.0d0,.40d0,17700.0d0,.20d0,  1.e20,  0.0d0/                         
      data ltab2/0.0d0, 1.0d0,0.0d0, .80d0,0.0d0, .60d0,0.0d0,  .40d0,          
     &                0.0d0, .20d0,  1.e20,  0.0d0/                             
      data tab1s/0.0d0, 1.0d0,0.0d0, 2.0d0,0.0d0, 3.0d0,0.0d0, 4.0d0,           
     & 0.0d0, 5.0d0, 0.0d0, 6.0d0, 0.0d0,7.0d0, 0.0d0, 8.0d0, 0.0d0,            
     & 9.0d0, 0.0d0,10.0d0, 1.e20,11.0d0/                                       
      data tab1h/0.0d0, 1.0d0, 0.0d0, 2.0d0, 0.0d0, 3.0d0, 0.0d0, 4.0d0,        
     & 0.0d0, 5.0d0, 0.0d0, 6.0d0, 0.0d0, 7.0d0,                                
     & 0.0d0, 8.0d0, 0.0d0, 9.0d0, 0.0d0,10., 1.e20,11.0d0/                     
      data tab3s/0.0d0, 0.0d0, 0.0d0, 1.0d0, 0.0d0, 2.0d0, 0.0d0, 3.0d0,        
     & 0.0d0, 4.0d0, 0.0d0, 5.0d0, 0.0d0,6.0d0,0.0d0,7.0d0,0.0d0, 8.0d0,        
     & 0.0d0,9.0d0, 0.0d0, 10.0d0, 1.e20, 11.0d0/                               
      data tab3h/0.0d0, 0.0d0, 0.0d0, 1.0d0, 0.0d0, 2.0d0, 0.0d0, 3.0d0,        
     & 0.0d0, 4.0d0, 0.0d0, 5.0d0, 0.0d0,6.0d0, 0.0d0, 7.0d0, 0.0d0,            
     & 8.0d0, 0.0d0, 9.0d0, 0.0d0, 10.0d0, 1.e20, 11.0d0/                       
      data tab2s/0.0d0, 1.0d0, 0.0d0, 2.0d0, 0.0d0, 4.0d0, 0.0d0,               
     & 6.0d0, 0.0d0, 8.0d0, 1.e20, 9.30d0/                                      
      data tab2h/0.0d0, 1.0d0, 0.0d0,2.0d0, 0.0d0, 4.0d0, 0.0d0, 6.0d0,         
     & 0.0d0, 8.0d0, 1.e20, 9.30d0/                                             
      data tab4s/0.0d0, 1.0d0, 0.0d0, 2.0d0, 0.0d0, 4.0d0, 0.0d0, 6.0d0,        
     & 0.0d0, 8.0d0, 0.0d0, 9.30d0, 0.0d0,10.0d0,1.e20,11.0d0/                  
      data tab4h/                                                               
     & 0.d0,1.d0,0.d0,2.d0,0.d0,4.d0,0.d0,6.d0,0.d0,8.d0,0.d0,9.3d0,            
     & 0.d0,10.d0,1.e20,11.d0/                                                  
      data tab5s/                                                               
     & 0.d0,1.d0,0.d0,2.d0,0.d0,4.d0,0.d0,6.d0,0.d0,8.d0,1.e20,9.3d0/           
      data tab5h/                                                               
     & 0.d0,1.d0,0.d0,2.d0,0.d0,4.d0,0.d0,6.d0,0.d0,8.d0,1.e20,9.3d0/           
      data tab9s/                                                               
     & 0.d0,1.25d0,0.d0,2.25d0,0.d0,4.25d0,0.d0,6.25d0,0.d0,8.25d0,             
     & 1.e20,9.55d0/                                                            
      data tab9h/                                                               
     & 0.d0,1.25d0,0.d0,2.25d0,0.d0,4.25d0,0.d0,6.25d0,0.d0,8.25d0,             
     & 1.e20,9.55d0/                                                            
      data tab11s/                                                              
     & 0.d0,1.d0,0.d0,2.d0,0.d0,4.d0,0.d0,6.d0,0.d0,8.d0,1.e20,9.3d0/           
      data tab11h/                                                              
     & 0.d0,1.d0,0.d0,2.d0,0.d0,4.d0,0.d0,6.d0,0.d0,8.d0,1.e20,9.3d0/           
c 2012 CA tax rate schedule -- 9 bracket rates                                  
      data tab12/                                                               
     &     0.d0, 1.d0 , 0.d0, 2.d0 , 0.d0, 4.d0,                                
     &     0.d0, 6.d0 , 0.d0, 8.d0 , 0.d0, 9.3d0,                               
     &     0.d0,10.3d0, 0.d0,11.3d0, 1.e20,12.3d0/                              
      data ts12/  7455.0d0, 17676.0d0, 27897.0d0, 38726.0d0, 48942.0d0,         
     &          250000.0d0,300000.0d0,500000.0d0/                               
      data th12/ 14920.0d0, 35351.0d0, 45571.0d0,  56400.0d0, 66618.0d0,        
     &          340000.0d0,408000.0d0,680000.0d0/                               
c                                                                               
      data rtabm/2*37.d0,11*137.d0,3*120.d0/                                    
      data rtabs/2*37.d0,14* 60.d0/                                             
      data xmpdep/253.d0,227.d0,235.d0,247.d0,251.d0,257.d0,                    
     &     265.d0,272.d0,285.d0,294.d0,309.d0,98.0d0,99.d0,315.d0,              
     &     321.d0,326.d0,333.d0,337.d0,344.d0,353.d0,367.d0,378.d0,             
     &     383.d0,400.d0/                                                       
      data xmpaif/10*0.0d0, 1.020d0, 1.040d0, 1.10d0, 1.160d0, 1.20d0,          
     & 1.240d0, 1.280d0, 1.30d0, 1.320d0,1.340d0,1.360d0,1.40d0,1.440d0,        
     & 1.50d0,1.580d0,1.60d0,1.640d0,1.70d0,1.740d0,1.820d0,1.880d0,            
     & 1.98d0,1.960d0,1.980d0,2.040d0,2.08d0,2.12d0,2.160d0,2.180d0,            
     & 2.22d0,2.28d0,2.36d0,2.44d0,2.48d0,2.58d0/                               
c     in order to get correct revenue estimates, must take account of           
c     the fact that the inflation factors vary slightly                         
      data aif/  1.0d0,   1.052d0, 1.10d0,  1.290d0, 1.40d0,  1.53d0,           
     & 1.510d0,  1.580d0, 1.650d0, 1.710d0, 1.880d0, 1.996d0, 2.07d0,           
     & 2.1690d0, 2.262d0, 2.343d0, 2.402d0, 2.431d0,                            
     & 2.4870d0, 2.527d0, 2.583d0, 2.642d0, 2.711d0,                            
     & 2.8110d0, 2.960d0, 3.004d0, 3.070d0, 3.165d0,                            
     & 3.2540d0, 3.410d0, 3.516d0, 3.692d0, 3.637d0,                            
     & 3.670d0,  3.769d0, 3.841d0, 3.906d0, 3.992d0,                            
     & 4.044d0,  4.129d0, 4.236d0, 4.401d0, 4.537d0,                            
     & 4.601d0,  4.803d0/                                                       
      data aiftab/ 1.0d0, 1.0520d0, 1.10d0, 1.3190d0, 1.430d0, 1.0d0,           
     & .9870d0, 1.0320d0, 1.08570d0, 1.1250d0, 1.0d0,1.0480d0,                  
     &1.10140d0,1.1530d0, 1.0d0,1.0360d0,1.0620d0, 1.0750d0,                    
     &1.09945380d0,1.0d0, 1.02180d0,1.04540d0,1.0720d0,1.1120d0,                
     &1.1710d0,1.18867150d0,1.2150d0,1.2530d0,1.28740d0,1.3490d0,               
     &1.39120d0,1.460470d0,1.4390d0,1.45150d0,1.4910d0,1.520d0/                 
      data aiflow/8*0.0d0, 1.0d0, 1.0350d0, 1.0720d0, 1.120d0,                  
     & 6*1.180d0/                                                               
      data aif1/3*1.0d0, 1.1250d0,1.43150d0/                                    
      data ak/2*.0850d0,3*.070d0/                                               
      data aif2/0.90d0,5*1.0d0, 1.14520d0,1.16780d0/                            
      data amtaxh/8000.0d0, 0.0d0, 10000.0d0,                                   
     & 0.50d0, 11500.0d0, 1.00d0, 13000.0d0, 1.50d0,                            
     & 14500.0d0, 2.0d0, 16000.0d0, 2.50d0, 17500.0d0, 3.0d0,                   
     & 19000.0d0, 3.50d0,20500.0d0, 4.0d0,  22000.0d0, 4.50d0,                  
     & 23500.0d0, 5.00d0,  1.e20, 5.50d0/                                       
      data amtaxs/4000.0d0, 0.0d0,  5500.0d0, 0.50d0,  7000.0d0, 1.0d0,         
     & 8500.0d0, 1.50d0,10000.0d0, 2.0d0, 11500.0d0, 2.50d0, 13000.0d0,         
     & 3.0d0, 14500.0d0, 3.50d0,16000.0d0, 4.0d0, 17500.0d0, 4.50d0,            
     &19000.0d0, 5.0d0,  1.e20, 5.50d0/                                         
      data aifren/1.0d0, 1.0360d0/                                              
c                                                                               
c     standard deduction, exemptions and tax barackets are indexed              
c                                                                               
      rt=0.                                                                     
      mst = int(data(2))                                                             
      dep = data(8)                                                             
      nfile = int(filing(mst,1.,2.,3.,2.))                                      
      txp = data(7)                                                             
      ided = int(data(4))                                                            
      if(mst.eq.4.or.mst.eq.5.or.mst.eq.7)txp=2.                                
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      if(law.le.1978) then                                                      
        stded=1000.*txp                                                         
      else                                                                      
        stded=1000.*aif(law)*txp                                                
        if(law.ge.1988.and.data(105).gt.0.)                                     
     &    stded = min(stded, max(comnew(37),500.                                
     & +xif(law.ge.1991,50.0d0)+xif(law.ge.1992,50.0d0)                         
     & +xif(law.ge.1995,50.0d0)+xif(law.ge.1998,50.0d0)                         
     & +xif(law.ge.2001,50.0d0)+xif(law.ge.2004,50.0d0)                         
     & +xif(law.ge.2006,50.0d0)+xif(law.ge.2008,50.0d0)                         
     & +xif(law.ge.2009,50.0d0)+xif(law.ge.2013,50.0d0)                         
     & +xif(law.ge.2015,50.0d0)+xif(law.ge.2019,50.0d0)))                       
      endif                                                                     
      if(law.le.1986) then                                                      
c AGI                                                                           
        totinc=data(11)+data(14)+data(12)+data(73)+data(74)+data(75)+           
     &  data(77)-data(78)+data(21)+data(20)+data(23)+data(24)+data(19)+         
     &  xif(law.le.1982,data(71))+data(79)-data(80)+data(17)                    
        kghmax=2500.                                                            
        einc=data(17)+data(75)+data(79)-data(80)+data(24)+data(21)+             
     &   data(11)                                                               
        kghlim=min(.1*einc,kghmax)                                              
        if(law.le.1978) then                                                    
          iralim=min(.1*einc,2500.0d0)                                          
        else if(law.le.1981) then                                               
          iralim=min(.15*einc,2500.0d0)                                         
        else                                                                    
          iramax=(1500.+xif(nfile.eq.2,250.0d0))/sep                            
          iralim=min(.15*einc,iramax)                                           
        endif                                                                   
        ira=min(data(29),iralim)                                                
        keogh=min(data(28),kghlim)                                              
        adj=data(25)+data(26)+data(27)+data(30)+data(62)+ira+keogh+             
     &   xif(law.ge.1979,data(22)+comnew(78))                                   
c  Deductions                                                                   
c        xitded=max(comnew(3),comnew(30))-data(50)                              
        xitded = 0.                                                             
        if(comnew(24).gt.0.and.comnew(30).gt.0)                                 
     &  xitded = comnew(24) - data(50)*comnew(24)/comnew(30)                    
        deduc=max(stded,xitded)                                                 
        if(stded.gt.xitded) then                                                
          char = data(58) + data(59) + data(60)                                 
          charni = 0.                                                           
          if(law.eq.1986) then                                                  
            charni = min(char,.2d0*agi)                                         
          else if(law.eq.1985) then                                             
            charni = min(.5*char,.2d0*agi)                                      
          else if(law.eq.1984) then                                             
            charni = .25*min(300.0d0/sep,char)                                  
          else if(law.eq.1982.or.law.eq.1983) then                              
            charni = .25*min(100.0d0/sep,char)                                  
          endif                                                                 
          deduc = stded + charni                                                
        endif                                                                   
        deduc = deduc - xif(law.ge.1982,stded)                                  
        cg=data(68)+.65*(data(70)+xif(law.ge.1983,data(71)))-data(67)-          
     &   data(69)                                                               
        if(cg.lt.0.) then                                                       
          taxy=totinc-adj-deduc-1510.*txp                                       
          cg=-1.*min(abs(cg),taxy,1000.0d0/sep)                                 
        endif                                                                   
        if(law.eq.1985.or.law.eq.1986) then                                     
          oldex = max(1000.*data(9)-.5*max(totinc-adj-25000.*data(9)/           
     &     sep,0.0d0),0.0d0)                                                    
          adj = adj+oldex                                                       
        endif                                                                   
        totinc = totinc + cg                                                    
        agi = max(totinc - adj,0.0d0)                                           
c Taxable Income                                                                
        taxinc = max(agi - deduc,0.0d0)                                         
      else                                                                      
        reduce = 0.d0                                                           
        agi = comnew(2)                                                         
        addit = 0.d0                                                            
c Social Security Benefits are not taxable in California                        
        subtra = data(22)+comnew(78)+comnew(79)                                 
        if(law.eq.2011.or.law.eq.2012) then                                     
c Effective Jan 1,2011, federal law increased the amount of adj.                
c CA does not confirm.                                                          
c 2011-2012 -- 5.65% instead of 7.65%                                           
          if(comnew(175).le.14204) then                                         
            subtra = subtra - (.5751-.5)*comnew(175)                            
          else                                                                  
            subtra = subtra - 1067                                              
          endif                                                                 
        endif                                                                   
c        cg = data(68)+data(70)-data(67)-data(69)                               
c        if(cg.lt.0.) then                                                      
c          cacg = -1*min(abs(cg),3000.d0/sep)                                   
c        else                                                                   
c          cacg = cg                                                            
c        endif                                                                  
c        adjcg = max(0.0d0,comnew(6))-cacg                                      
c         if(adjcg.gt.0.) then                                                  
c          subtra = subtra+adjcg                                                
c        else                                                                   
c          addit = addit+adjcg                                                  
c        endif                                                                  
        agi = agi+addit-subtra                                                  
        xitded= max(0.d0,comnew(30)-data(50)+data(27))                          
        if(mst.eq.1.or.sep.eq.2) then                                           
          phaded=100000.                                                        
          if(law.ge.1992) phaded=100000.*aifded(law)                            
        else if(mst.eq.4.or.mst.eq.7) then                                      
          phaded=100000.*1.5                                                    
          if(law.ge.1992) phaded=100000.*aifded(law)*1.5                        
        else if(mst.eq.2.or.mst.eq.5) then                                      
          phaded=100000.*2.                                                     
          if(law.ge.1992) phaded=100000.*aifded(law)*2.                         
        endif                                                                   
        if(law.ge.1991.and.comnew(2).gt.phaded) then                            
          reduce = min(.8*xitded,.06*(comnew(2)-phaded))                        
          xitded = xitded-reduce                                                
        endif                                                                   
        if(ided.eq.-2.and.law.eq.1999) xitded=0                                 
        deduc=max(stded,xitded)                                                 
        taxinc=max(0.0d0,agi-deduc)                                             
      endif                                                                     
      ajnt=1.                                                                   
      if(mst.eq.2.or.mst.eq.5)ajnt=2.                                           
      hoh = 0                                                                   
      if(mst.eq.4.or.mst.eq.7) hoh = 1                                          
      if(law.le.1981) then                                                      
        do 20 i=1,10                                                            
          tab1s(1,i)=nint(tab77s(1,i)*aiftab(law)/10)*10.*ajnt                  
          tab1h(1,i)=nint(tab77h(1,i)*aiftab(law)/10)*10.                       
20      continue                                                                
      else if(law.le.1986.and.law.ge.1982) then                                 
        do 25 i=1,11                                                            
          tab3s(1,i)=tab82s(1,i)*aiftab(law)*ajnt                               
          tab3h(1,i)=tab82h(1,i)*aiftab(law)                                    
25      continue                                                                
      else if(law.ge.1987.and.law.le.1990) then                                 
        do 30 i=1,5                                                             
          tab2s(1,i)=tab87s(1,i)*aiftab(law)*ajnt                               
          tab2h(1,i)=tab87h(1,i)*aiftab(law)                                    
30      continue                                                                
      else if(law.ge.1991.and.law.le.1995) then                                 
        do 35 i=1,7                                                             
          tab4s(1,i)=tab91s(1,i)*aiftab(law)*ajnt                               
          tab4h(1,i)=tab91h(1,i)*aiftab(law)                                    
35      continue                                                                
      else if(law.ge.1996.and.law.le.2008) then                                 
        do 40 i=1,5                                                             
          tab5s(1,i)=tab96s(1,i)*aiftab(law)*ajnt                               
          tab5h(1,i)=tab96h(1,i)*aiftab(law)                                    
40      continue                                                                
      else if(law.ge.2009.and.law.le.2010) then                                 
        do 45 i=1,5                                                             
          tab9s(1,i)=tab96s(1,i)*aiftab(law)*ajnt                               
          tab9h(1,i)=tab96h(1,i)*aiftab(law)                                    
45      continue                                                                
      else if(law.eq.2011) then                                                 
        do 50 i=1,5                                                             
          tab11s(1,i)=tab96s(1,i)*aiftab(law)*ajnt                              
          tab11h(1,i)=tab96h(1,i)*aiftab(law)                                   
50      continue                                                                
      else if(law.ge.2012) then                                                 
        do 55 i=1,8                                                             
           if(hoh.ne.1) then                                                    
              tab12(1,i) = aif12(law)*ts12(i)*ajnt                              
           else                                                                 
              tab12(1,i) = aif12(law)*th12(i)                                   
           endif                                                                
55      continue                                                                
      endif                                                                     
      if(law.le.1981) then                                                      
        if(hoh.ne.1)                                                            
     &  call look(tab1s,taxinc,11,n,statax,1.0d0,0.0d0,rt,data)                 
        if(hoh.eq.1)                                                            
     &  call look(tab1h,taxinc,11,n,statax,1.0d0,0.0d0,rt,data)                 
      else if(law.ge.1982.and.law.le.1986) then                                 
        if(hoh.ne.1)                                                            
     &  call look(tab3s,taxinc,12,n,statax,1.0d0,0.0d0,rt,data)                 
        if(hoh.eq.1)                                                            
     &  call look(tab3h,taxinc,12,n,statax,1.0d0,0.0d0,rt,data)                 
      else if(law.ge.1987.and.law.le.1990) then                                 
        if(hoh.ne.1)                                                            
     &  call look(tab2s,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                  
        if(hoh.eq.1)                                                            
     &  call look(tab2h,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.ge.1991.and.law.le.1995) then                                 
        if(hoh.ne.1)then                                                        
          call look(tab4s,taxinc,8,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
          call look(tab4h,taxinc,8,n,statax,1.0d0,0.0d0,rt,data)                
        endif                                                                   
      else if(law.ge.1996.and.law.le.2008) then                                 
        if(hoh.ne.1)then                                                        
          call look(tab5s,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
          call look(tab5h,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                
        endif                                                                   
      else if(law.ge.2009.and.law.le.2010) then                                 
        if(hoh.ne.1)then                                                        
          call look(tab9s,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
          call look(tab9h,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                
        endif                                                                   
      else if(law.eq.2011) then                                                 
        if(hoh.ne.1)then                                                        
          call look(tab11s,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)               
        else                                                                    
          call look(tab11h,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)               
        endif                                                                   
      else if(law.ge.2012) then                                                 
          call look(tab12,taxinc,9,n,statax,1.0d0,0.0d0,rt,data)                
      endif                                                                     
      taxbc = statax                                                            
c                                                                               
c Tax Credits                                                                   
      if(law.le.1986) then                                                      
        if(mst.eq.4.or.mst.eq.7.or.mst.eq.5)dep=max(0.0d0,dep-1.)               
        blnd=data(10)                                                           
        excrd=(nint(25.*aif(law))*txp)                                          
        excrd=excrd + (nint(8.*aif(law))*(dep+blnd))                            
        if(law.eq.1978)excrd=(100*txp) + (8*(dep+blnd))                         
      else if(law.ge.1987.and.law.le.1997) then                                 
        excrd=50.*xmpaif(law)*(data(7)+data(9)+data(10)+dep)                    
      else                                                                      
c In 1998:$253;1999:$227;2000:$235;2001:$247;2004:$265 for each dependent       
        excrd=50.*xmpaif(law)*(data(7)+data(9)+data(10))+                       
     &   dep*xmpdep(law)                                                        
      endif                                                                     
      if(law.ge.1991) then                                                      
c limiting the exemption credit by federal AGI                                  
        if(comnew(2).gt.phaded) then                                            
         if(law.lt.1998) then                                                   
           if((comnew(2)-phaded).gt.25000.*aif2(law)/sep) then                  
              excrd = 0.                                                        
           else                                                                 
              excrd=max(0.0d0,excrd - (dep + txp + data(9) + data(10))          
     &                *6.*(comnew(2)-phaded)/2500.d0/sep)                       
           endif                                                                
         else                                                                   
           num = int(1 + (comnew(2)-phaded)/(2500.d0/sep))                      
           excrd = max(0.0d0,excrd - (dep+txp+data(9)+data(10))*6*num)          
         endif                                                                  
        else                                                                    
c since 1994 there are two limitations on exemption credits :                   
c a federal AGI limitation and  a California limitation computed                
c on Schedule P(540)in 1994 or California tentative min tax later.              
         if(law.ge.1994.and.law.le.1998) then                                   
             if(mst.eq.4.or.mst.eq.7.or.mst.eq.1) then                          
                exc     =30000.*aif1(law)                                       
             else                                                               
                exc     =20000.*aif1(law)*sep                                   
             endif                                                              
             if(mst.eq.4.or.mst.eq.7) then                                      
                excess  = 150000.*aif2(law)                                     
             else                                                               
                excess  = 100000.*aif2(law)*sep                                 
             endif                                                              
             if(agi.gt.phaded) then                                             
               if(agi.lt.excess) then                                           
                 if(stded.gt.xitded.and.ided.ne.-1) then                        
                   excrd=min(statax-ak(law)*min(0.0d0,agi-exc),excrd)           
                 else                                                           
                   excrd= min(statax -ak(law)*(min(.025*comnew(2),              
     &   data(49))+ data(54) +data(56) +data(66) + taxinc -exc),excrd)          
                 endif                                                          
               endif                                                            
             endif                                                              
         endif                                                                  
        endif                                                                   
      endif                                                                     
      if(data(105).gt.0.d0) excrd = 0.d0                                        
c     low income credit; starts out as an amnt, later a % of tax                
c the credits for taxpayers with income under $22,841, military income          
c and for the elderly and disabled have expired and may no longer be claimed    
c since 1992                                                                    
      lowcr=0.                                                                  
      if(law.le.1983) then                                                      
        if(data(159).le.(10000*txp).and.data(81).lt.1) then                     
          lowcr=40.*xif(law.ge.1979,aif(law))                                   
          lowcr=nint(max(0.0d0,lowcr-((agi-5000.)*.5)))                         
        endif                                                                   
      else if(law.ge.1985.and.law.le.1991) then                                 
        div=1.                                                                  
        if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)div=2.                              
        do 450 i=1,5                                                            
           ltab2(1,i)=(lowtab(1,i)*aiflow(law))/div                             
450      continue                                                               
        lowcr=statax*tablki(ltab2,6,agi,data)                                   
      endif                                                                     
      if(data(105).gt.0.d0) lowcr = 0.d0                                        
                                                                                
c     child care credit                                                         
c the credit for child and dependent care expenses has expired                  
c and may no longer be claimed for 1993 - 1999                                  
c New in 2000 : Child and dependent care expenses credit                        
      chcr=0.                                                                   
      fagi=comnew(2)                                                            
c comnew(176) = total amount of the federal cccr before avail                   
      if(law.le.1984) then                                                      
        chmax=min(2000.*data(8),4000.0d0)                                       
        chwage=max(0.0d0,data(11)+data(17))                                     
        chcr=.03*min(chmax,chwage,data(64))                                     
      else if(law.eq.1985.or.law.eq.1986) then                                  
        chcr=.1*comnew(53)                                                      
        if(agi.ge.20000)chcr=.05*comnew(53)                                     
      else if(law.ge.1987.and.law.le.1990) then                                 
        chcr=.3*comnew(53)                                                      
      else if(law.ge.1991.and.law.le.1992) then                                 
        if(fagi.le.40000.)chcr=.3*comnew(53)                                    
        if(fagi.gt.40000..and.fagi.le.70000.)chcr=comnew(53)/4                  
        if(fagi.gt.70000..and.fagi.le.100000.)chcr=comnew(53)/5                 
        if(fagi.gt.100000.)chcr=.15*comnew(53)                                  
      else if(law.ge.2000.and.law.le.2002) then                                 
        if(fagi.le.40000.) chcr = .63*comnew(176)                               
        if(fagi.gt.40000.and.fagi.le.70000.) chcr = .53*comnew(176)             
        if(fagi.gt.70000.and.fagi.le.100000.) chcr = .42*comnew(176)            
      else if(law.ge.2003) then                                                 
        if(fagi.le.40000.) chcr = .50*comnew(176)                               
        if(fagi.gt.40000.and.fagi.le.70000.) chcr = .43*comnew(176)             
        if(fagi.gt.70000.and.fagi.le.100000.) chcr = .34*comnew(176)            
      endif                                                                     
c     credit for elderly                                                        
      eld=0.                                                                    
      if(law.ge.1978.and.law.le.1983) then                                      
        eld=min(data(32),comnew(54))                                            
      else if(law.ge.1984.and.law.le.1991) then                                 
        eld=.5*min(data(32),comnew(54))                                         
      endif                                                                     
      polcr=0.                                                                  
      if(law.ge.1987)polcr=min(.25*data(65),25.*txp)                            
c     energy credit; not related to federal credit, but d38 was best            
c       estimate                                                                
      encred=data(38)                                                           
      noncr=excrd+lowcr+eld+polcr+encred                                        
c     none of these credits are refundable                                      
      statax=max(0.0d0,statax-noncr)                                            
      iratax = data(42)/4                                                       
c alternative minimum tax(87+),minimum tax on preference income(1979-86)        
      amt=0.                                                                    
      if(law.ge.1979.and.law.le.1986) then                                      
       prefs=max(0.0d0,data(81)+min(data(17),0.0d0)+data(80)+data(116))         
       pref2=prefs/ajnt                                                         
       if(hoh.eq.1)call look(amtaxh,prefs,12,n,amt,1.0d0,0.0d0,art,             
     & data)                                                                    
       if(hoh.eq.0)call look(amtaxs,pref2,12,n,amt,1.0d0,0.0d0,art,             
     & data)                                                                    
       amt=amt*ajnt                                                             
       amt=max(0.0d0,amt-statax)                                                
      endif                                                                     
      if(law.ge.1987) then                                                      
c  alminy = comnew(69) - data(50) + data(22)(commented out 05.31.2019           
c  after testing testact18_10.for)                                              
        if(xitded.gt.stded) then                                                
           agix = max(0.d0,agi)                                                 
           addprf = min(.025*agix,comnew(20))+data(51)+data(52)+data(54)        
        else                                                                    
           addprf = stded                                                       
        endif                                                                   
        totprf = addprf + data(81) - data(116)                                  
        alminy = totprf + taxinc - (max(0.0d0,data(17)) +                       
     &  max(0.0d0,data(21)) + max(0.0d0,comnew(8)) + reduce)                    
c Exclusion amount(maximum)                                                     
        if(law.le.1997) excl = comnew(49)                                       
        if(law.eq.1998) excl = filing(mst,42945.,57260.,42945.,28630.)          
        if(law.eq.1999) excl = filing(mst,44062.,58749.,44062.,29374.)          
        if(law.eq.2000) excl = filing(mst,45692.,60923.,45692.,30461.)          
        if(law.eq.2001) excl = filing(mst,48114.,64152.,45692.,30461.)          
        if(law.eq.2002) excl = filing(mst,48836.,65114.,48836.,32556.)          
        if(law.eq.2003) excl = filing(mst,49910.,66547.,49910.,33272.)          
        if(law.eq.2004) excl = filing(mst,51457.,68610.,51457.,34303.)          
        if(law.eq.2005) excl = filing(mst,52898.,70531.,52898.,35263.)          
        if(law.eq.2006) excl = filing(mst,55437.,73916.,55437.,36956.)          
        if(law.eq.2007) excl = filing(mst,57156.,76207.,57156.,38102.)          
        if(law.eq.2008) excl = filing(mst,60014.,80017.,60014.,40007.)          
        if(law.eq.2009) excl = filing(mst,59114.,78817.,59114.,39407.)          
        if(law.eq.2010) excl = filing(mst,59646.,79526.,59646.,39672.)          
        if(law.eq.2011) excl = filing(mst,61256.,81673.,61256.,40836.)          
        if(law.eq.2012) excl = filing(mst,62420.,83225.,62420.,41612.)          
        if(law.eq.2013) excl = filing(mst,63481.,84640.,63481.,42319.)          
        if(law.eq.2014) excl = filing(mst,64878.,86502.,64878.,43250.)          
        if(law.eq.2015) excl = filing(mst,65721.,87627.,65721.,43812.)          
        if(law.eq.2016) excl = filing(mst,67101.,89467.,67101.,44732.)          
        if(law.eq.2017) excl = filing(mst,68846.,91793.,68846.,45895.)          
        if(law.eq.2018) excl = filing(mst,71531.,95373.,71531.,44685.)          
        if(law.eq.2019) excl = filing(mst,73748.,98330.,73748.,49163.)          
        if(law.eq.2020) excl = filing(mst,74777.,99702.,74777.,49851.)          
        if(law.ge.2021) excl = filing(mst,78070.,104094.,78070.,52044.)         
                                                                                
c Phase-out                                                                     
        phase = filing(mst,112500.,150000.,112500.,75000.)                      
        if(law.eq.1998)phase=filing(mst,161044.,214725.,161044.,107362.)        
        if(law.eq.1999)phase=filing(mst,165231.,220308.,165231.,110153.)        
        if(law.eq.2000)phase=filing(mst,171345.,228459.,171345.,114229.)        
        if(law.eq.2001)phase=filing(mst,180426.,240567.,180426.,120283.)        
        if(law.eq.2002)phase=filing(mst,183132.,244176.,183132.,122087.)        
        if(law.eq.2003)phase=filing(mst,187161.,249548.,187161.,124773.)        
        if(law.eq.2004)phase=filing(mst,192963.,257284.,192963.,128641.)        
        if(law.eq.2005)phase=filing(mst,198366.,264488.,198366.,132243.)        
        if(law.eq.2006)phase=filing(mst,207888.,277183.,207888.,138591.)        
        if(law.eq.2007)phase=filing(mst,214333.,285776.,214333.,142887.)        
        if(law.eq.2008)phase=filing(mst,225050.,300065.,225050.,150031.)        
        if(law.eq.2009)phase=filing(mst,221674.,295564.,221674.,147781.)        
        if(law.eq.2010)phase=filing(mst,223669.,298224.,223669.,149111.)        
        if(law.eq.2011)phase=filing(mst,229708.,306276.,229708.,153137.)        
        if(law.eq.2012)phase=filing(mst,234072.,312095.,234072.,156047.)        
        if(law.eq.2013)phase=filing(mst,238051.,317401.,238051.,158700.)        
        if(law.eq.2014)phase=filing(mst,243288.,324384.,243288.,162191.)        
        if(law.eq.2015)phase=filing(mst,246451.,328601.,246451.,164299.)        
        if(law.eq.2016)phase=filing(mst,251626.,335502.,251626.,167749.)        
        if(law.eq.2017)phase=filing(mst,258168.,344225.,258168.,172110.)        
        if(law.eq.2018)phase=filing(mst,268237.,357650.,268237.,178822.)        
        if(law.eq.2019)phase=filing(mst,276552.,368737.,276552.,184365.)        
        if(law.eq.2020)phase=filing(mst,280419.,373892.,280419.,186946.)        
        if(law.ge.2021)phase=filing(mst,292763.,390351.,292763.,195172.)        
                                                                                
c Exclusion Phase-out                                                           
        phaout = .25*max(0.0d0,alminy-phase)                                    
        exclnt = max(0.0d0,excl-phaout)                                         
        alminc = max(0.0d0,alminy-exclnt)                                       
        amt = alminc*amtrt(law)                                                 
        amt=max(0.0d0,amt-statax)                                               
      endif                                                                     
      statax=statax+iratax+amt                                                  
c rent cred independent of income or rent paid                                  
c Due to a tax law change, renter's credit was eliminated in 1993.              
c 1998 -- a credit is back                                                      
      rcred = 0.                                                                
      if(law.ge.1977.and.law.le.1978) then                                      
         rcred = rtabs(law)*renter(data,comnew)                                 
      else if(law.ge.1979.and.law.le.1990) then                                 
         if (mst.eq.1) then                                                     
             rcred = rtabs(law) * renter(data,comnew)                           
         else                                                                   
             rcred = rtabm(law) * renter(data,comnew)/sep                       
         endif                                                                  
      else if(law.ge.1991.and.law.le.1992) then                                 
       if(mst.eq.1.or.sep.eq.2) then                                            
         if(agi.le.20500.*aifren(law).and.agi.gt.20000.*aifren(law))            
     &          rcred = .5 * rtabs(law) * renter(data,comnew)                   
         if(agi.le.20000.*aifren(law))                                          
     &          rcred =      rtabs(law) * renter(data,comnew)                   
       else                                                                     
         if(agi.le.41000.*aifren(law).and.agi.gt.40000.*aifren(law))            
     &          rcred = .5 * rtabm(law) * renter(data,comnew)                   
         if(agi.le.40000.*aifren(law))                                          
     &          rcred =      rtabm(law) * renter(data,comnew)                   
       endif                                                                    
      else if(law.ge.1998) then                                                 
          jrent = 2                                                             
          if(data(2).eq.1.or.sep.eq.2) jrent = 1                                
          if(agi.le.25000.d0*jrent*aifrent(law))                                
     &    rcred = jrent*60.*renter(data,comnew)                                 
      endif                                                                     
      statax = max(0.0d0,statax-rcred)                                          
c 2011+ the child and dependent care expense credit is nonrefundable.           
      if(law.le.2010) then                                                      
         statax = statax - chcr                                                 
      else if (law.ge.2011) then                                                
         statax = max(0.d0,statax - chcr)                                       
      endif                                                                     
      credit = noncr + rcred + chcr                                             
c 2005+ Additional Mental Health Services Tax for taxinc>1.e6                   
      if(law.ge.2005) statax = statax + .01*max(0.0d0,taxinc-1000000)           
c 2015+ refundable California Earned Income Tax Credit(EITC)                    
      earncr = 0.d0                                                             
      young = 0.d0                                                              
      if(law.ge.2015) then                                                      
c California does not allow the credit for self-employment income 2015-2016     
          if(law.le.2016) then                                                  
            earned = data(11)                                                   
          else                                                                  
            earned = comnew(37)                                                 
          endif                                                                 
          ieic = int(max(0.0d0,                                                 
     &    min(data(8)-data(209),data(8)-data(107)-data(108),3.0d0)))            
          if(data(203).gt.0) ieic = int(min(3.0d0,data(203)))                        
          disqy =  max(0.0d0,comnew(6))+comnew(4)+data(14)+                     
     &    max(0.0d0,data(73))+max(0.0d0,data(74))+max(0.0d0,data(75))+          
     &    max(0.0d0,data(76))+max(0.0d0,data(77))+max(0.0d0,data(78))+          
     &    max(0.0d0,data(79))+max(0.0d0,data(19))                               
          am = amax(law,ieic)                                                   
          cr = crmax(law,ieic)                                                  
          posagi = max(0.0d0,comnew(2))                                         
          if(earned.lt..5*am) base = earned                                     
          if(earned.ge..5*am) base = max(0.0d0,am - earned)                     
          if(earned.gt.0.d0)  earncr = base*cr/(.5*am)                          
          if(posagi.ge..5*am) then                                              
             base = max(0.0d0,am - posagi)                                      
             earncr = min(earncr,base*cr/(.5*am))                               
          endif                                                                 
c 2017+ expanded EIC; amax17 - expanded (new);                                  
          if(law.ge.2017) then                                                  
            ym1 = ym(ieic,law)                                                  
            em1 = em(ieic,law)                                                  
            if(earned.gt.ym1.or.posagi.gt.ym1) then                             
              tgbeta = em1/(amax17(ieic,law)-ym1)                               
c em1 - amount of EIC based on ym1 earned income                                
              base2 = max(0.0d0,amax17(ieic,law) - max(posagi,earned))          
              if(earned.gt.0.d0) earncr = base2 * tgbeta                        
            endif                                                               
          endif                                                                 
c         write(0,*) '2 earncr',earncr                                          
c         write(0,*) 'ym1 em1 amax17',ym1,em1,amax17(ieic,law)                  
                                                                                
          if(disqy.ge.dylim(law)) earncr = 0.                                   
c no CA eitc for separate returns                                               
          if(sep.eq.2) earncr = 0.                                              
c no CA eitc for dependent returns                                              
          if(data(105).gt.0.d0) earncr = 0.                                     
c          write(16,*) ' earned earncr',int(data(11)),int(earncr)               
c Young Child Tax Credit 2019+; d210=number of children under 6 y.o.            
          if(law.ge.2019) then                                                  
           if(earncr.gt.0.d0.and.data(203).gt.0.d0) then                        
            if(earned.le.25000) then                                            
               young = 1000.d0*data(210)                                        
            else                                                                
               young = max(0.d0,1000.d0 - .2*(earned-25000.d0))                 
            endif                                                               
           endif                                                                
          endif                                                                 
      endif                                                                     
      statax = statax - earncr - young                                          
      credit = credit + earncr + young                                          
      return                                                                    
      end                                                                       
c  COLORADO                                                                     
c  State 06                                                                      
c                                                                               
c  Updated through 2021 (revised 02.18.2022)                                    
      subroutine cotax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      double precision foodcr,foody,fuelcr,minex,itc                            
      integer ym,dm,sep                                                         
      dimension data(255), comnew(255), crtab(2,3)                              
      dimension pmax(1977:1997,4),ylim(1977:1997,2),fmax(1977:1997,4),          
     & pnsion(1977:2021)                                                        
      dimension tab77(2,11),aif(1977:1986),tab79(2,11),tab84(2,11)              
      dimension surtax(1977:1986),subtr(2000:2001),xmar(2000:2002)              
c child care credit                                                             
      dimension ch96(2,4),ch99(2,2),ch00(2,2)                                   
c sales tax refund                                                              
      dimension ref97(2,3),ref98(2,4),ref99(2,6),ref00(2,6),ref01(2,6),         
     &ref15(2,6),ref21(2,6)                                                     
      data ch96/25000.d0,.5d0,35000.d0,.3d0,60000.d0,.1d0,1.e20,0.d0/           
      data ch99/60000.d0,.5d0, 1.e20,0.d0/                                      
      data ch00/64000.d0,.7d0, 1.e20,0.d0/                                      
      data ref97/15000.d0, 37.d0,100000.d0, 60.d0,   1.e20, 80.d0/              
      data ref98/20000.d0,142.d0, 50000.d0,195.d0,95000.d0,276.d0,              
     & 1.e20,384.d0/                                                            
      data ref99/25000.d0,159.d0, 50000.d0,212.d0,75000.d0,244.d0,              
     &          100000.d0,290.d0,125000.d0,312.d0,   1.e20,502.d0/              
      data ref00/26000.d0,182.d0, 53000.d0,245.d0,78000.d0,288.d0,              
     &          103000.d0,325.d0,126000.d0,363.d0,   1.e20,574.d0/              
      data ref01/27000.d0,144.d0, 56000.d0,187.d0,83000.d0,220.d0,              
     &          110000.d0,252.d0,135000.d0,283.d0,   1.e20,451.d0/              
      data ref15/36000.d0, 13.d0, 77000.d0, 18.d0,120000.d0,21.d0,              
     &          163000.d0, 23.d0,204000.d0, 24.d0,   1.e20, 41.d0/              
      data ref21/44000.d0, 37.d0, 88000.d0, 49.d0,139000.d0,56.d0,              
     &          193000.d0, 68.d0,246000.d0, 74.d0,   1.e20,117.d0/              
      data subtr/ 1200.0d0,1500.0d0/                                            
      data xmar/ 8800.0d0,9100.0d0,9400.0d0/                                    
      data tab77/  1000.0d0, 2.50d0, 2000.0d0, 3.0d0,                           
     & 3000.0d0, 3.50d0, 4000.0d0, 4.00d0, 5000.0d0, 4.50d0,                    
     & 6000.0d0, 5.0d0, 7000.0d0, 5.50d0, 8000.0d0, 6.0d0,                      
     & 9000.0d0, 6.50d0,10000.0d0,7.0d0, 1.e20, 7.50d0/                         
      data tab79/  1000.0d0, 2.50d0, 2000.0d0, 3.0d0,                           
     & 3000.0d0, 3.50d0, 4000.0d0, 4.0d0, 5000.0d0, 4.50d0,                     
     & 6000.0d0, 5.0d0, 6500.0d0, 5.50d0, 8000.0d0, 6.0d0,                      
     & 9000.0d0, 6.50d0,10000.0d0,7.50d0, 1.e20, 8.0d0/                         
      data tab84/  1000.0d0, 3.0d0, 2000.0d0, 3.50d0, 3000.0d0, 4.0d0,          
     & 4000.0d0, 4.50d0,5000.0d0, 5.0d0, 6000.0d0, 5.50d0, 6500.0d0,            
     & 6.0d0, 8000.0d0, 6.50d0, 9000.0d0, 7.0d0, 10000.0d0,7.50d0,              
     &1.e20, 8.0d0/                                                             
      data surtax/2*1.0d0,.90d0,.80d0,.840d0,5*1.0d0/                           
      data aif/1.0d0,1.060d0,1.13420d0,1.2362780d0,1.335180d0,                  
     &4*1.4152910d0,1.420d0/                                                    
c pmax,fmax,ylim,aif,pnsion, and surtax not used after 1986                     
c pmax contains variables used in computing the property tax credit:            
c   max credit, income exemption for married & single, rent percent             
      data pmax/3*410.0d0,18*500.0d0, 4300.0d0,2*6700.0d0,18*8700.0d0,          
     & 3000.0d0,2*3300.0d0, 18*5000.0d0,  3*.10d0,18*.20d0/                     
c fmax contains the same for fuel tax credit                                    
      data fmax/21*160.0d0, 4300.0d0,2*6700.0d0,18*8700.0d0,3000.0d0,           
     & 2*3300.0d0,18*5000.0d0, .04d0,20*.064d0/                                 
c ylim contains income limits for the property tax & fuel credit                
      data ylim/8300.0d0,2*10800.0d0,18*11200.0d0,3*7300.0d0,                   
     & 18*7500.0d0/                                                             
      data crtab / 3000.0d0, 16.0d0, 4000.0d0, 11.0d0, 1.e20, 7.0d0 /           
      data pnsion/3000.d0,4000.d0,3*5000.d0,18*20000.d0,22*24000.d0/            
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      txp = data(7)                                                             
      if(law.le.1986) then                                                      
c indexing from 1978 to 1982. legislative discretion.                           
        rt=0.                                                                   
c AGI                                                                           
        agi=comnew(2)-data(22)                                                  
c alimony                                                                       
        if(law.le.1979)agi=agi-(6.65*data(38))                                  
c res energy                                                                    
c      if(law.ge.1978)agi=agi-comnew(76)                                        
        if(law.ge.1979.and.law.le.1983)agi=agi-xjobs(data,law)                  
        if(law.ge.1982.and.law.le.1986)agi=agi+comnew(32)                       
c interest and dividend income exclusions                                       
        if(law.ge.1980) then                                                    
          agi=agi+divexc(data,comnew,law)                                       
          agi=agi-twn(data(14),0.0d0,200.d0*data(7))                            
          agi=agi-twn(data(12),0.0d0,200.d0*data(7))                            
        endif                                                                   
c pnsion exclusions                                                             
        if(data(9).gt.0) agi=agi-                                               
     & twn(data(20)+data(72)+comnew(79),0.0d0,data(2)*pnsion(law))              
        fedded=max(comnew(52) - comnew(58) - comnew(59),0.0d0)                  
        taxmax=fedded                                                           
        if(agi.gt.0.and.comnew(2).gt.0) then                                    
          fedded=twn(fedded*(agi/comnew(2)),0.0d0,taxmax)                       
        endif                                                                   
c  Standard Deduction                                                           
        ag=max(0.0d0,agi)                                                       
        if(law.le.1979) then                                                    
            if(mst.ne.3.and.mst.ne.6) then                                      
                minex=(1000.0d0*aif(law))/sep                                   
                stded=min(.1*ag,(1000.0d0*aif(law))/sep)                        
                sub=(comnew(68)*100.0d0)                                        
                sub=sub+.5*max(0.0d0,(ag-(1000.0d0+comnew(68)*750.0d0)))        
                sub=max(0.0d0, 800.0d0-sub)                                     
                allow = 200.0d0 +(100.0d0*comnew(68))+sub                       
                allow=min(1000.0d0*aif(law),allow)                              
                stded=max(stded,allow)                                          
            elseif(mst.eq.3.or.mst.eq.6) then                                   
                allow=aif(law)*min(500.0d0,100.0d0+(comnew(68)*100.0d0))        
                minex=500.0d0*aif(law)                                          
                stded = min(500.0d0*aif(law),.1d0*ag)                           
                stded=max(stded,allow)                                          
           endif                                                                
        elseif(law.ge.1980) then                                                
           stded=(1000.0d0*aif(law))/sep                                        
           minex=stded                                                          
        endif                                                                   
c state and loc var left out on purpose                                         
        xitded = 0.d0                                                           
        if(comnew(30).gt.0.and.comnew(26).gt.0)                                 
     &  xitded = comnew(24)-data(50)*comnew(24)/comnew(30)                      
c gasoline tax: arbitary distance assumed                                       
        xitded=xitded+(49*data(7))+(26*data(8))                                 
        deduc=max(xitded,stded)                                                 
c       Exemptions                                                              
        if(law.eq.1977) then                                                    
            exemp = 750.0d0*comnew(68)                                          
        else                                                                    
            exemp = 850.0d0*aif(law)*comnew(68)                                 
        endif                                                                   
        minex=minex+exemp                                                       
        taxinc = max(0.0d0,agi - deduc - exemp - fedded)                        
                                                                                
        if(law.le.1978)call look(tab77,taxinc,11,n,statax,aif(law),             
     &     0.0d0,rt,data)                                                       
        if(law.gt.1978.and.law.le.1983) call look(tab79,taxinc,11,n,            
     &   statax,aif(law),0.0d0,rt,data)                                         
        if(law.ge.1984.and.law.le.1986) call look(tab84,taxinc,11,n,            
     &   statax,aif(law),0.0d0,rt,data)                                         
c  surtax                                                                       
        statax=statax*surtax(law)                                               
        if(law.le.1978) then                                                    
         statax=statax+.02*max(data(12)+data(14)-5000.0d0*data(7),0.0d0)        
        elseif(law.ge.1979) then                                                
        statax=statax+.02*max(data(12)+data(14)-15000.0d0*data(7),0.0d0)        
        endif                                                                   
      else if(law.ge.1987) then                                                 
         agi = comnew(2)                                                        
         taxinc = max(0.0d0,comnew(29)-data(22))                                
c unemployment compensation if fully taxable in 2020                            
         if(law.eq.2020) then                                                   
            taxinc = max(0.0d0,comnew(29)-data(22)+data(82)-comnew(78))         
         endif                                                                  
c additions to federal taxable income: state income tax claimed as              
c a deduction on Schedule A , federal form 1040                                 
c (if a person did itemized deductions on his federal  return, he must add back 
c to income on your Colorado return any state income tax included in his total  
c federal itemized deduction.)                                                  
        if(comnew(26).gt.0.and.law.ge.1992) then                                
          taxinc= taxinc + min(data(50),comnew(24)-comnew(3))                   
        endif                                                                   
c subractions to federal taxable income: pnsion exclusions                      
        penexc=twn(data(20)+data(72)+comnew(79),0.0d0,pnsion(law)*txp)          
        if(data(9).gt.0) taxinc=max(0.0d0,taxinc-penexc)                        
c       write(0,*) 'taxinc penexc',taxinc,penexc                                
c 2000-2001 interest, dividend and capital gain subtraction                     
c        if(law.ge.2000.and.law.le.2001)                                        
c     &          taxinc=max(0.0d0,taxinc-min(subtr(law)*data(7),                
c     &                        data(12)+data(14)+max(0.0d0,comnew(06))))        
c cg subtr were commented out on 03.11.2022 because it should be CO cgains      
c 2000-2002 Marrige Penalty Subtraction                                         
        if(mst.eq.2.and.law.ge.2000.and.law.le.2002) then                       
          if(comnew(26).lt.1.) taxinc =                                         
     &                max(0.0d0,taxinc-(xmar(law)-comnew(3)))                   
          if(comnew(26).gt.0..and.comnew(24).gt.comnew(3)) taxinc =             
     &       max(0.0d0,taxinc-max(0.0d0,(xmar(law)-comnew(24))))                
          if(law.ge.2001.and.data(9)+data(10).gt.0)  taxinc =                   
     &       max(0.0d0,taxinc-900*(data(9)+data(10)))                           
        endif                                                                   
c 2001+ Qualifying Charitable Contributions                                     
        if(law.gt.2001.and.comnew(26).lt.1..and.comnew(23).gt.0)                
     &      taxinc = max(0.0d0,taxinc-max(0.0d0,comnew(23)-500))                
        if(law.le.1998) then                                                    
           statax = taxinc*.05                                                  
           rt = .05                                                             
        else if(law.eq.1999) then                                               
c The income tax rate was reduced from 5% to 4.75% in 1999                      
           statax = taxinc*.0475                                                
           rt = .0475                                                           
        else if(law.ge.2000.and.law.le.2018) then                               
c The income tax rate was reduced from 4.75% to 4.63% in 2000                   
           statax = taxinc*.0463                                                
           rt = .0463                                                           
        else if(law.eq.2019.or.law.ge.2021) then                                
c The income tax rate was reduced from 4.63% to 4.5% in 2019                    
           statax = taxinc*.045                                                 
           rt = .045                                                            
        else if(law.eq.2020) then                                               
           statax = taxinc*.0455                                                
           rt = .0455                                                           
        endif                                                                   
        if(law.le.1999) then                                                    
          altax=.0375*max(0.0d0,comnew(69)-comnew(40))                          
        else                                                                    
          altax=.0347*max(0.0d0,comnew(69)-comnew(40))                          
        endif                                                                   
        statax=statax + max(altax-statax,0.0d0)                                 
      endif                                                                     
c     Credits                                                                   
      credit=0.                                                                 
      fuelcr=0.                                                                 
      foodcr=0.                                                                 
      foody=0.                                                                  
      propcr=0.                                                                 
      encr=0.                                                                   
      itc=0.                                                                    
      cr=0.                                                                     
      if(law.le.1986) then                                                      
        ag=max(0.0d0,agi)                                                       
        foody=(ag/(data(7)+data(8)))                                            
        mst = int(data(2))                                                             
        if(law.le.1979) then                                                    
          foodcr=(data(7)+data(8))*nint(tablki(crtab,3,foody,data)*             
     &     aif(law))                                                            
          if(law.ge.1978) then                                                  
            if(mst.eq.3.or.mst.eq.6)foodcr=crtab(2,3)*(data(7)+data(8))         
          endif                                                                 
        endif                                                                   
        if(law.ge.1980.and.law.le.1986)encr=min(data(38),3400.0d0)              
        itc=.1*data(33)                                                         
        if(law.le.1978) then                                                    
          itc=0.                                                                
        else if(law.eq.1979) then                                               
          itc=min(itc,5000.d0/sep)                                              
        else if(law.eq.1980.or.law.eq.1981) then                                
          if(law.eq.1981)itc=.15*data(33)                                       
          itc=min(itc,37000.d0/sep)                                             
        else if(law.ge.1982.and.law.le.1986) then                               
          itc=min(itc,10000.d0/sep)                                             
        endif                                                                   
        ym=0                                                                    
        dm=0                                                                    
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5) then                   
          dm= 3                                                                 
          ym=2                                                                  
        else if(mst.eq.2.or.mst.eq.3.or.mst.eq.6) then                          
          dm=2                                                                  
          ym=1                                                                  
        endif                                                                   
c  income for property credit purposes is larger than agi                       
        if(data(9).gt.0.or.data(10).gt.0.or.mst.eq.5) then                      
          hhy = data(159)                                                       
          if(mst.eq.3.or.mst.eq.6) hhy=hhy*2.                                   
          if(hhy.le.ylim(law,ym)) then                                          
            propcr=max(pmax(law,1)-max(0.0d0,(hhy-pmax(law,dm)))*               
     &       pmax(law,4),0.0d0)                                                 
            propcr=min(propcr,(data(51)+.2*data(160)))                          
            if(law.eq.1977)propcr=propcr+.1*(data(51)+.15*data(160))            
c           rent used as proxy for heat expense.                                
            if(law.ge.1979.and.law.le.1986)then                                 
              fuelcr=max(fmax(law,1)-(hhy-fmax(law,dm))*                        
     &         fmax(law,4),0.0d0)                                               
              fuelcr=min(fuelcr,(.1*data(160)))                                 
            endif                                                               
         endif                                                                  
        endif                                                                   
      endif                                                                     
c 1997-2001 and 2005, 2015 State Sales Tax Refund                               
c Modified CO AGI includes Gross SSB                                            
      coagi = comnew(2) - comnew(79) + data(91)                                 
      if(law.eq.1997)  then                                                     
        cr = tablki(ref97,3,coagi,data)                                         
      else if (law.eq.1998)  then                                               
        cr = tablki(ref98,4,coagi,data)                                         
      else if (law.eq.1999)  then                                               
        cr = tablki(ref99,6,coagi,data)                                         
      else if (law.eq.2000)  then                                               
        cr = tablki(ref00,6,coagi,data)                                         
      else if (law.eq.2001)  then                                               
        cr = tablki(ref01,6,coagi,data)                                         
      else if (law.eq.2015)  then                                               
        cr = tablki(ref15,6,coagi,data)                                         
      else if (law.eq.2021)  then                                               
        cr = tablki(ref21,6,coagi,data)                                         
      else if (law.eq.2005)  then                                               
        cr = 15.d0                                                              
      endif                                                                     
      cr = cr * data(07)                                                        
c Colorado Child Care Credit 1996+ refundable                                   
      chcr = 0.                                                                 
      chcare = min(comnew(53),max(0.0d0,comnew(52)-data(34)))                   
      agix = max(0.d0,comnew(2))                                                
      if(law.eq.1996.or.law.eq.1997.or.law.ge.2002) then                        
        chcr = chcare* tablki(ch96,4,agix,data)                                 
      elseif(law.eq.1998) then                                                  
         chcr = .5*chcare                                                       
      elseif(law.eq.1999) then                                                  
         chcr = chcare* tablki(ch99,2,agix,data)                                
      elseif(law.ge.2000.and.law.le.2001) then                                  
         chcr = max(0.0d0,chcare*tablki(ch00,2,agix,data)-300*data(8))          
      endif                                                                     
c 1999-2001 Colorado Child Tax Credit                                           
      child = 0.                                                                
c child credit only for children under age 5                                    
c we assume that children are older than 5 y.o.                                 
c      if(law.eq.1999.and.comnew(2).le.60000.and.comnew(1).gt.0)                
c     & child = 200.*data(8)                                                    
c      if(law.eq.2000.and.comnew(2).le.64000.and.comnew(1).gt.0)                
c     & child = 300.*data(8)                                                    
c     if(law.eq.2001.and.comnew(2).le.64000.                                    
c    &   and.comnew(81)+comnew(93).gt.0)                                        
c    &  child = min(comnew(81)+comnew(93),300.*data(8))                         
c ---------------------------------------------------------                     
c Earned Income Credit 1999-2001 and 2015+                                      
      earncr = 0.                                                               
      if(law.eq.1999) then                                                      
           earncr = .085*comnew(59)                                             
      else if((law.ge.2000.and.law.le.2001).or.law.ge.2015) then                
           earncr = .1*comnew(59)                                               
      endif                                                                     
c ---------------------------------------------------------                     
      credit = propcr+fuelcr+foodcr+itc+encr                                    
                                                                                
      statax=max(0.0d0,statax-credit)-cr-earncr-chcr-child                      
      credit = credit + cr + earncr + chcr + child                              
c      write(0,*) 'c59 earncr',comnew(59),earncr                                
c1     format(6(1x,f8.0))                                                       
c2     format(6(1x,a8))                                                         
      return                                                                    
      end                                                                       
c  CONNECTICUT                                                                  
c  State 07                                                                      
c  Updated through 2021 (02.22.2022)                                            
c  until 1991 Connecticut just had tax on cap gains,interest & dividends.       
c  In 1991 Connecticut enacted a flat rate income tax                           
      subroutine cttax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension tab(2,10),tab84(2,6),tab85(2,13),tab86(2,12),                   
     & tab89(2,14), tab91(2,14),reic(2011:2025),                                
     & tab96s(2,2),tab96h(2,2),tab96m(2,2),                                     
     & tab97s(2,2),tab97h(2,2),tab97m(2,2),                                     
     & tab98s(2,2),tab98h(2,2),tab98m(2,2),                                     
     & tab99s(2,2),tab99h(2,2),tab99m(2,2),                                     
     & tab03s(2,2),tab03h(2,2),tab03m(2,2),                                     
     & tab09s(2,3),tab09h(2,3),tab09m(2,3),                                     
     & tab11s(2,6),tab11h(2,6),tab11m(2,6),                                     
     & tab15s(2,7),tab15h(2,7),tab15m(2,7)                                      
c Tax Recapture                                                                 
      dimension rmaxh(2011:2021),rmaxs(2011:2021),                              
     &          ragih(2011:2021),ragis(2011:2021),                              
     &          rateh(2011:2021),rates(2011:2021)                               
      dimension xmps(2008:2021),                                                
     & phses(1997:2025),phseh(1997:2025),phsej(1997:2025),prop2(2,8)            
     &,prop(1996:2025),ssblim(1985:2021,2)                                      
     &,penlim(2019:2025,2),pded(2019:2025)                                      
      dimension Bsin(2,6),Bhead(2,6),Bjoin(2,6)                                 
      dimension B95(2,29),B95s(29),B95h(29),B95j(29),B00s(29),B01s(29),         
     &B04s(29),B07s(29),B08s(29),B12s(29),B13s(29),B14s(29),B16s(29)            
      dimension data(255),comnew(255)                                           
      double precision inctax                                                   
      integer sep                                                               
      data pded/.14d0,.28d0,.42d0,.56d0,.70d0,.84d0,1.d0/                       
      data ssblim/                                                              
     s  34*50000.d0,3* 75000.d0,                                                
     m  34*60000.d0,3*100000.d0/                                                
      data penlim/                                                              
     1  7* 75000.d0,                                                            
     2  7*100000.d0/                                                            
      data prop2 /                                                              
     &    0.0d0, .00d0, 0.0d0, .15d0, 0.0d0,.30d0,  0.0d0, .45d0,               
     &    0.0d0, .60d0, 0.0d0, .75d0, 0.0d0,.90d0,   1.e20,1.00d0/              
                                                                                
      data phses /3*52500.d0,53500.d0,3*54500.d0,3*55000.d0, 55500.d0,          
     &         5*56500.d0,60500.d0,  62500.d0,  47500.d0,10*49500.0d0/          
      data phseh /19* 78500.d0,10*54500.0d0/                                    
      data phsej /19*100500.d0,10*70500.0d0/                                    
      data xmps /4*13000.d0,13500.d0,14000.d0,2*14500.d0,6*15000.d0/            
      data rmaxs/4*2250.d0,7*3150.d0/                                           
      data rmaxh/4*3600.d0,7*4920.d0/                                           
      data ragis/11*200000.d0/                                                  
      data ragih/11*320000.d0/                                                  
      data rateh/4*.015d0,7*.0175d0/                                            
      data rates/4*.015d0,7*.0180d0/                                            
c arrays for Tax Table B through 1994 :Personal Tax Credit Percentages          
      data Bsin/12001.0d0,1.0d0, 15001.0d0,.75d0,20001.0d0,.35d0,               
     &          25001.0d0,.15d0, 48001.0d0,.10d0,1.e20,.0d0/                    
      data Bhead/19001.0d0,1.0d0,24001.0d0,.75d0,34001.0d0,.35d0,               
     &           44001.0d0,.15d0,74001.0d0,.10d0,1.e20,.0d0/                    
      data Bjoin/24001.0d0,1.0d0, 30001.0d0,.75d0,40001.0d0,.35d0,              
     &           50001.0d0,.15d0, 96001.0d0,.10d0,1.e20,.0d0/                   
c arrays for Tax Table B since 1995 :Personal Tax Credit Percentages            
      data B95/0.d0,1.d0 ,0.d0,.75d0,0.d0,.7d0 ,0.d0,.65d0,0.d0,.6d0 ,          
     &         0.d0,.55d0,0.d0,.5d0 ,0.d0,.45d0,0.d0,.4d0 ,0.d0,.35d0,          
     &         0.d0,.3d0 ,0.d0,.25d0,0.d0,.2d0 ,0.d0,.15d0,0.d0,.14d0,          
     &         0.d0,.13d0,0.d0,.12d0,0.d0,.11d0,0.d0,.1d0 ,0.d0,.09d0,          
     &         0.d0,.08d0,0.d0,.07d0,0.d0,.06d0,0.d0,.05d0,0.d0,.04d0,          
     &         0.d0,.03d0,0.d0,.02d0,0.d0,.01d0,1.e20,0.d0 /                    
      data B95s/12001.d0,15001.d0,15501.d0,16001.d0,16501.d0,                   
     &          17001.d0,17501.d0,18001.d0,18501.d0,20001.d0,                   
     &          20501.d0,21001.d0,21501.d0,25001.d0,25501.d0,                   
     &          26001.d0,26501.d0,27001.d0,48001.d0,48501.d0,                   
     &          49001.d0,49501.d0,50001.d0,50501.d0,51001.d0,                   
     &          51501.d0,52001.d0,52501.d0,1.e20/                               
      data B95h/19001.d0,24001.d0,24501.d0,25001.d0,25501.d0,                   
     &          26001.d0,26501.d0,27001.d0,27501.d0,34001.d0,                   
     &          34501.d0,35001.d0,35501.d0,44001.d0,44501.d0,                   
     &          45001.d0,45501.d0,46001.d0,74001.d0,74501.d0,                   
     &          75001.d0,75501.d0,76001.d0,76501.d0,77001.d0,                   
     &          77501.d0,78001.d0,78501.d0,1.e20/                               
      data B95j/24001.d0,30001.d0,30501.d0,31001.d0,31501.d0,                   
     &          32001.d0,32501.d0,33001.d0,33501.d0,40001.d0,                   
     &          40501.d0,41001.d0,41501.d0,50001.d0,50501.d0,                   
     &          51001.d0,51501.d0,52001.d0,96001.d0,96501.d0,                   
     &          97001.d0,97501.d0,98001.d0,98501.d0,99001.d0,                   
     &          99501.d0,100001.d0,100501.d0,1.e20/                             
      data B00s/12251.d0,15301.d0,15801.d0,16301.d0,16801.d0,                   
     &          17301.d0,17801.d0,18301.d0,18801.d0,20401.d0,                   
     &          20901.d0,21401.d0,21901.d0,25501.d0,26001.d0,                   
     &          26501.d0,27001.d0,27501.d0,49001.d0,49501.d0,                   
     &          50001.d0,50501.d0,51001.d0,51501.d0,52001.d0,                   
     &          52501.d0,53001.d0,53501.d0,1.e20/                               
      data B01s/12501.d0,15601.d0,16101.d0,16601.d0,17101.d0,                   
     &          17601.d0,18101.d0,18601.d0,19101.d0,20801.d0,                   
     &          21301.d0,21801.d0,22301.d0,26001.d0,26501.d0,                   
     &          27001.d0,27501.d0,28001.d0,50001.d0,50501.d0,                   
     &          51001.d0,51501.d0,52001.d0,52501.d0,53001.d0,                   
     &          53501.d0,54001.d0,54501.d0,1.e20/                               
      data B04s/12626.d0,15751.d0,16251.d0,16751.d0,17251.d0,                   
     &          17751.d0,18251.d0,18751.d0,19251.d0,21051.d0,                   
     &          21551.d0,22051.d0,22551.d0,26301.d0,26801.d0,                   
     &          27301.d0,27801.d0,28301.d0,50501.d0,51001.d0,                   
     &          51501.d0,52001.d0,52501.d0,53001.d0,53501.d0,                   
     &          54001.d0,54501.d0,55001.d0,1.e20/                               
      data B07s/12751.d0,15901.d0,16401.d0,16901.d0,17401.d0,                   
     &          17901.d0,18401.d0,18901.d0,19401.d0,21301.d0,                   
     &          21801.d0,22301.d0,22801.d0,26601.d0,27101.d0,                   
     &          27601.d0,28101.d0,28601.d0,51001.d0,51501.d0,                   
     &          52001.d0,52501.d0,53001.d0,53501.d0,54001.d0,                   
     &          54501.d0,55001.d0,55501.d0,1.e20/                               
      data B08s/13001.d0,16301.d0,16801.d0,17301.d0,17801.d0,                   
     &          18301.d0,18801.d0,19301.d0,19801.d0,21701.d0,                   
     &          22201.d0,22701.d0,23201.d0,27101.d0,27601.d0,                   
     &          28101.d0,28601.d0,29101.d0,52001.d0,52501.d0,                   
     &          53001.d0,53501.d0,54001.d0,54501.d0,55001.d0,                   
     &          55501.d0,56001.d0,56501.d0,1.e20/                               
      data B12s/13501.d0,16901.d0,17401.d0,17901.d0,18401.d0,                   
     &          18901.d0,19401.d0,19901.d0,20401.d0,22501.d0,                   
     &          23001.d0,23501.d0,24001.d0,28101.d0,28601.d0,                   
     &          29101.d0,29601.d0,30101.d0,54001.d0,54501.d0,                   
     &          55001.d0,55501.d0,56001.d0,56501.d0,57001.d0,                   
     &          57501.d0,58001.d0,58501.d0,1.e20/                               
      data B13s/14001.d0,17501.d0,18001.d0,18501.d0,19001.d0,                   
     &          19501.d0,20001.d0,20501.d0,21001.d0,23301.d0,                   
     &          23801.d0,24301.d0,24801.d0,29201.d0,29701.d0,                   
     &          30201.d0,30701.d0,31201.d0,56001.d0,56501.d0,                   
     &          57001.d0,57501.d0,58001.d0,58501.d0,59001.d0,                   
     &          59501.d0,60001.d0,60501.d0,1.e20/                               
      data B14s/14501.d0,18101.d0,18601.d0,19101.d0,19601.d0,                   
     &          20101.d0,20601.d0,21101.d0,21601.d0,24201.d0,                   
     &          24701.d0,25201.d0,25701.d0,30201.d0,30701.d0,                   
     &          31201.d0,31701.d0,32201.d0,58001.d0,58501.d0,                   
     &          59001.d0,59501.d0,60001.d0,60501.d0,61001.d0,                   
     &          61501.d0,62001.d0,62501.d0,1.e20/                               
      data B16s/15001.d0,18801.d0,19301.d0,19801.d0,20301.d0,                   
     &          20801.d0,21301.d0,21801.d0,22301.d0,25001.d0,                   
     &          25501.d0,26001.d0,26501.d0,31301.d0,31801.d0,                   
     &          32301.d0,32801.d0,33301.d0,60001.d0,60501.d0,                   
     &          61001.d0,61501.d0,62001.d0,62501.d0,63001.d0,                   
     &          63501.d0,64001.d0,64501.d0,1.e20/                               
c  for 1996 year                                                                
      data tab96s/2250.0d0,3.0d0,1.e20,4.50d0/                                  
      data tab96h/3500.0d0,3.0d0,1.e20,4.50d0/                                  
      data tab96m/4500.0d0,3.0d0,1.e20,4.50d0/                                  
c  for 1997 year                                                                
      data tab97s/ 6250.0d0,3.0d0,1.e20,4.50d0/                                 
      data tab97h/10000.0d0,3.0d0,1.e20,4.50d0/                                 
      data tab97m/12500.0d0,3.0d0,1.e20,4.50d0/                                 
c  for 1998 year                                                                
      data tab98s/ 7500.0d0,3.0d0,1.e20,4.50d0/                                 
      data tab98h/12000.0d0,3.0d0,1.e20,4.50d0/                                 
      data tab98m/15000.0d0,3.0d0,1.e20,4.50d0/                                 
c  for 1999 year                                                                
      data tab99s/10000.0d0,3.0d0,1.e20,4.50d0/                                 
      data tab99h/16000.0d0,3.0d0,1.e20,4.50d0/                                 
      data tab99m/20000.0d0,3.0d0,1.e20,4.50d0/                                 
c  for 2003-2008 year                                                           
      data tab03s/10000.0d0,3.0d0,1.e20,5.0d0/                                  
      data tab03h/16000.0d0,3.0d0,1.e20,5.0d0/                                  
      data tab03m/20000.0d0,3.0d0,1.e20,5.0d0/                                  
c  for 2009-2010 year                                                           
      data tab09s/10000.0d0,3.0d0, 500000.0d0,5.0d0,1.e20,6.50d0/               
      data tab09h/16000.0d0,3.0d0, 800000.0d0,5.0d0,1.e20,6.50d0/               
      data tab09m/20000.0d0,3.0d0,1000000.0d0,5.0d0,1.e20,6.50d0/               
c  for 2011-2014 year                                                           
      data tab11s/10000.0d0,3.0d0, 50000.0d0,5.0d0,100000.0d0,5.50d0,           
     &           200000.0d0,6.0d0,250000.0d0,6.5d0,1.e20,6.7d0    /             
      data tab11h/16000.0d0,3.0d0, 80000.0d0,5.0d0,160000.0d0,5.50d0,           
     &           320000.0d0,6.0d0,400000.0d0,6.5d0,1.e20,6.7d0    /             
      data tab11m/20000.0d0,3.0d0,100000.0d0,5.0d0,200000.0d0,5.5d0,            
     &           400000.0d0,6.0d0,500000.0d0,6.5d0,1.e20,6.7d0   /              
c  for 2015+ year                                                               
      data tab15s/10000.0d0,3.0d0, 50000.0d0,5.0d0,100000.0d0,5.50d0,           
     &           200000.0d0,6.0d0,250000.0d0,6.5d0,500000.0d0,6.90d0,           
     &                1.e20,6.99d0    /                                         
      data tab15h/16000.0d0,3.0d0, 80000.0d0,5.0d0,160000.0d0,5.50d0,           
     &           320000.0d0,6.0d0,400000.0d0,6.5d0,800000.0d0,6.90d0,           
     &                1.e20,6.99d0    /                                         
      data tab15m/20000.0d0,3.0d0,100000.0d0,5.0d0, 200000.0d0,5.5d0,           
     &           400000.0d0,6.0d0,500000.0d0,6.5d0,1000000.0d0,6.9d0,           
     &                1.e20,6.99d0   /                                          
c maximum property tax credit allowed                                           
      data prop/100.0d0,  215.0d0,350.0d0,425.0d0,3*500.0d0,3*350.0d0,          
     &        5*500.0d0,5*300.0d0,10*200.0d0/                                   
c  arrays for conn cap gains,interest,& dividends                               
      data tab/  19999.0d0, 0.0d0, 21999.0d0, .01d0 ,                           
     &           23999.0d0, .02d0, 27999.0d0, .03d0 ,                           
     &           29999.0d0, .04d0, 34999.0d0, .05d0 ,                           
     &           39999.0d0, .06d0, 49999.0d0, .075d0,                           
     &           99999.0d0, .08d0,    1.e20 , .09d0 /                           
      data tab84/49999.0d0, 0.0d0, 59999.0d0, .06d0 ,                           
     &           69999.0d0, .08d0, 79999.0d0, .1d0  ,                           
     &           99999.0d0, .12d0,     1.e20, .13d0 /                           
      data tab85/49999.0d0, 0.0d0, 53999.0d0, .01d0,                            
     &           57999.0d0, .02d0, 61999.0d0, .03d0,                            
     &           65999.0d0, .04d0, 69999.0d0, .05d0,                            
     &           73999.0d0, .06d0, 77999.0d0, .07d0,                            
     &           81999.0d0, .08d0, 85999.0d0, .09d0,                            
     &           89999.0d0, .10d0, 99999.0d0, .12d0,                            
     &           1.e20    , .13d0/                                              
      data tab86/53999.0d0, 0.0d0, 57999.0d0, .01d0,                            
     &           61999.0d0, .02d0, 65999.0d0, .03d0,                            
     &           69999.0d0, .04d0, 73999.0d0, .05d0,                            
     &           77999.0d0, .06d0, 81999.0d0, .07d0,                            
     &           85999.0d0, .08d0, 89999.0d0, .09d0,                            
     &           99999.0d0, .11d0,  1.e20   , .12d0/                            
      data tab89/53999.0d0, 0.0d0,  55999.0d0, .01d0,                           
     &           57999.0d0, .02d0,  59999.0d0, .03d0,                           
     &           61999.0d0, .04d0,  65999.0d0, .05d0,                           
     &           69999.0d0, .06d0,  73999.0d0, .07d0,                           
     &           77999.0d0, .08d0,  81999.0d0, .09d0,                           
     &           85999.0d0, .10d0,  89999.0d0, .11d0,                           
     &           99999.0d0, .13d0,  1.e20    , .14d0/                           
      data tab91/53999.0d0, 0.0d0  , 55999.0d0, .0075d0,                        
     &           57999.0d0, .015d0 , 59999.0d0, .020d0 ,                        
     &           61999.0d0, .0275d0, 65999.0d0, .035d0 ,                        
     &           69999.0d0, .04d0  , 73999.0d0, .0475d0,                        
     &           77999.0d0, .055d0 , 81999.0d0, .06d0  ,                        
     &           85999.0d0, .0675d0, 89999.0d0, .075d0 ,                        
     &           99999.0d0, .0875d0,  1.e20   , .095d0/                         
      data reic/2*.3d0,.25d0,3*.275d0,4 *.23d0,5*.305d0/                        
      rt  = 0.                                                                  
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
c  AGI                                                                          
      subrac=data(22)+xif(law.le.1993,data(26))                                 
      agi=comnew(2)                                                             
c      write(0,*) '1 agi',agi                                                   
      if(law.ge.1991)agi=agi-subrac                                             
c 2019+,deduction of the portion of retirement income included in fed AGI,      
c if federal AGI is below: $75k for mst = 1,3,4,6,7 and $100k for mst = 2,5     
      pension = data(72)+data(20)                                               
      npens = 1                                                                 
      if(mst.eq.2.or.mst.eq.5) npens = 2                                        
      if(pension.gt.0.and.law.ge.2019) then                                     
        if(law.le.2025) then                                                    
           lawpen = law                                                         
        else                                                                    
           lawpen = 2025                                                        
        endif                                                                   
        plim = penlim(lawpen,npens)                                             
        perp = pded(lawpen)                                                     
        perpen = twn(1.d0-(agi-plim)/plim,0.d0,1.d0)*perp                       
        agi = agi - perpen*pension                                              
c        write(0,*) '2 agi',agi,perpen*pension                                  
      endif                                                                     
c Social Security Benefits are not taxable for                                  
c mst = 2,5,4,7 and comnew(2)< $60K; (100k for 2019)                            
c mst = 1,3,6 and comnew(2)< $50K (75k for 2019)                                
c if comnew(2) is above , ssb are phased out.                                   
      nssb = 1                                                                  
      if(mst.eq.2.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5) nssb = 2                 
      if(comnew(79).gt.0.and.law.ge.1985) then                                  
        ssbmax = ssblim(law,nssb)                                               
        if (agi.lt.ssbmax) then                                                 
            agi=agi-comnew(79)                                                  
        else if(agi.ge.ssbmax) then                                             
           if(mst.eq.1.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5) then                
              excl = 25000.                                                     
           elseif(mst.eq.2) then                                                
              excl = 32000.                                                     
           elseif(mst.eq.3.or.mst.eq.6) then                                    
              excl = 0.                                                         
           endif                                                                
           if(law.le.1999) then                                                 
               agi = agi -  max(0.0d0,comnew(79) - 0.5*                         
     &            min(0.5*max(0.0d0,data(159)-.5*data(91)-                      
     &                        comnew(17)- excl),.5*data(91)))                   
           else                                                                 
               if(excl.gt.0) then                                               
                  agi = agi - (comnew(79) - .25 * min(data(91),excl))           
               endif                                                            
           endif                                                                
        endif                                                                   
      endif                                                                     
c            write(0,*) '3 agi',agi                                             
c Exemptions                                                                    
      if(law.le.1990)exemp=(data(7)+data(9)+data(10))*100.                      
c exemptions after 1991 based on agi and marital status                         
c  single exemption 1991                                                        
      if(law.ge.1991) then                                                      
        if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)then                                
          if(law.le.1999) then                                                  
             exemp=twn(12000.d0-(agi-24000.d0),0.0d0,12000.0d0)                 
          else if(law.eq.2000.and.mst.eq.1) then                                
             exemp=twn(12250.d0-(agi-24500.d0),0.0d0,12250.0d0)                 
          else if(law.eq.2001.and.mst.eq.1) then                                
             exemp=twn(12750.d0-(agi-25500.d0),0.0d0,12750.0d0)                 
          else if(law.eq.2002.and.mst.eq.1) then                                
             exemp=twn(12500.d0-(agi-25000.d0),0.0d0,12500.0d0)                 
          else if(law.ge.2003.and.law.le.2006.and.mst.eq.1) then                
             exemp=twn(12625.d0-(agi-25250.d0),0.0d0,12625.0d0)                 
          else if(law.eq.2007.and.mst.eq.1) then                                
             exemp=twn(12750.d0-(agi-25500.d0),0.0d0,12750.0d0)                 
c Singles 2008+                                                                 
          else if(law.ge.2008.and.mst.eq.1) then                                
            xmp = xmps(law)                                                     
            exemp = twn(xmp-(agi-2*xmp),0.0d0,xmp)                              
          else if(law.ge.2000.and.sep.eq.2) then                                
            exemp=twn(12000.d0-(agi-24000.d0),0.0d0,12000.0d0)                  
                                                                                
          endif                                                                 
c head of household exemption 1991                                              
        elseif(mst.eq.4.or.mst.eq.7)then                                        
          exemp=twn(19000.d0-(agi-38000.d0),0.0d0,19000.0d0)                    
c  married filing jointly or widower exemption 1991                             
        else                                                                    
          exemp=twn(24000.d0-(agi-48000.d0),0.0d0,24000.0d0)                    
        endif                                                                   
      endif                                                                     
                                                                                
c The scheduled increases will resume beginning with the 2012 taxable year      
c (for Personal Exemptions and Credits)                                         
c                                                                               
c Cap Gains, Dividends, and Interest Liability                                  
      gain = max(comnew(6),0.0d0)                                               
c 1987-1988 Long-Term Capital Gains are reported at 100% in Federal tax returns,
c a 60% deduction is allowed at CT tax returns                                  
      if(law.eq.1987.or.law.eq.1988) then                                       
         if(data(68).le.0.and.gain.gt.0)gain=gain-.6*(data(70)+data(68))        
         if(data(68).gt.0.and.data(70).gt.0) gain = gain - .6*data(70)          
      endif                                                                     
      gain = gain +data(18)                                                     
      if(law.le.1990) then                                                      
        cgtax=max(0.0d0,(gain-exemp)*.07)                                       
      else if(law.eq.1991) then                                                 
        cgtax=max(0.0d0,min(.034*agi,                                           
     &               (gain-100.*(data(7)+data(9)+data(10)))*.0475))             
      endif                                                                     
      divint=data(12)+data(14)                                                  
c Calculation of Tax                                                            
      if(law.lt.1983) then                                                      
         call cttab(tab  ,10,agi,data(12),divtax,rt)                            
         taxinc = gain + divint                                                 
         statax=cgtax+divtax                                                    
      else if(law.eq.1983) then                                                 
         call cttab(tab  ,10,agi,divint,divtax,rt)                              
         taxinc = gain + divint                                                 
         statax=cgtax+divtax                                                    
      else if(law.eq.1984) then                                                 
         call cttab(tab84,6,agi,divint,divtax,rt)                               
         taxinc = gain + divint                                                 
         statax=cgtax+divtax                                                    
      else if(law.eq.1985) then                                                 
         call cttab(tab85,13,agi,divint,divtax,rt)                              
         taxinc = gain + divint                                                 
         statax=cgtax+divtax                                                    
      else if(law.ge.1986.and.law.le.1988) then                                 
         call cttab(tab86,12,agi,divint,divtax,rt)                              
         taxinc = gain + divint                                                 
         statax=cgtax+divtax                                                    
      else if(law.ge.1989.and.law.le.1990) then                                 
         call cttab(tab89,14,agi,divint,divtax,rt)                              
         taxinc = gain + divint                                                 
         statax=cgtax+divtax                                                    
      else                                                                      
         taxinc= max(0.0d0,agi - exemp)                                         
         if(law.ge.1991.and.law.le.1995)then                                    
            rt=0.045                                                            
            if(law.eq.1991) then                                                
              call cttab(tab91,14,agi,divint,divtax,rt)                         
              rt=0.015                                                          
            endif                                                               
            xtax = taxinc * rt                                                  
         elseif(law.eq.1996) then                                               
            if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)                                
     & call look(tab96s,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.4.or.mst.eq.7)                                            
     & call look(tab96h,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.5.or.mst.eq.2)                                            
     & call look(tab96m,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
         elseif(law.eq.1997) then                                               
            if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)                                
     & call look(tab97s,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.4.or.mst.eq.7)                                            
     & call look(tab97h,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.5.or.mst.eq.2)                                            
     & call look(tab97m,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
         elseif(law.eq.1998) then                                               
            if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)                                
     & call look(tab98s,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.4.or.mst.eq.7)                                            
     & call look(tab98h,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.5.or.mst.eq.2)                                            
     & call look(tab98m,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
         elseif(law.ge.1999.and.law.le.2002) then                               
            if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)                                
     & call look(tab99s,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.4.or.mst.eq.7)                                            
     & call look(tab99h,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.5.or.mst.eq.2)                                            
     & call look(tab99m,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
         elseif(law.ge.2003.and.law.le.2008) then                               
            if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)                                
     & call look(tab03s,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.4.or.mst.eq.7)                                            
     & call look(tab03h,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.5.or.mst.eq.2)                                            
     & call look(tab03m,taxinc,2,n,xtax,1.0d00,0.0d0,rt,data)                   
         elseif(law.ge.2009.and.law.le.2010) then                               
            if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)                                
     & call look(tab09s,taxinc,3,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.4.or.mst.eq.7)                                            
     & call look(tab09h,taxinc,3,n,xtax,1.0d00,0.0d0,rt,data)                   
            if(mst.eq.5.or.mst.eq.2)                                            
     & call look(tab09m,taxinc,3,n,xtax,1.0d00,0.0d0,rt,data)                   
         elseif(law.ge.2011) then                                               
            if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                           
              if(law.le.2014) then                                              
       call look(tab11s,taxinc,6,n,xtax,1.0d00,0.0d0,rt,data)                   
              else                                                              
       call look(tab15s,taxinc,7,n,xtax,1.0d00,0.0d0,rt,data)                   
              endif                                                             
c 2011 3% tax rate phase out add-back - stax                                    
              if(mst.eq.1) then                                                 
        stax = min(200.0d0,.03*1000*max(0.0d0,agi - 56500.d0)/5000.d0)          
              else                                                              
        stax = min(200.0d0,.03*1000*max(0.0d0,agi - 50250.d0)/2500.d0)          
              endif                                                             
c 2011+ Tax Recapture for Taxpayers with Higher AGI - rtax                      
        rtax = min(rates(law)*max(0.d0,agi-ragis(law)),rmaxs(law))              
            endif                                                               
            if(mst.eq.4.or.mst.eq.7) then                                       
              if(law.le.2014) then                                              
                call look(tab11h,taxinc,6,n,xtax,1.0d00,0.0d0,rt,data)          
              else                                                              
                call look(tab15h,taxinc,7,n,xtax,1.0d00,0.0d0,rt,data)          
              endif                                                             
c 2011 3% tax rate phase out add-back - stax                                    
        stax = min(320.d0,.03*1600*max(0.0d0,agi - 78500.d0)/4000.d0)           
c 2011 Tax Recapture for Taxpayers with Higher AGI - rtax                       
        rtax = min(rateh(law)*max(0.d0,agi-ragih(law)),rmaxh(law))              
            endif                                                               
            if(mst.eq.5.or.mst.eq.2) then                                       
              if(law.le.2014) then                                              
                call look(tab11m,taxinc,6,n,xtax,1.0d00,0.0d0,rt,data)          
              else                                                              
                call look(tab15m,taxinc,7,n,xtax,1.0d00,0.0d0,rt,data)          
              endif                                                             
c 2011 3% tax rate phase out add-back - stax                                    
              stax = min(400.0d0,.03*2000*max(0.0d0,agi - 100500)/5000)         
c 2011 Tax Recapture for Taxpayers with Higher AGI - rtax                       
              rtax = min(rates(law)*max(0.0d0,agi-2*ragis(law)),                
     &       2*rmaxs(law))                                                      
            endif                                                               
            xtax = xtax + stax + rtax                                           
         endif                                                                  
      endif                                                                     
c      write(0,*) 'taxinc xtax',taxinc,xtax                                     
c Personal Tax Credits                                                          
c credp - percentage rate---                                                    
      credp = 0.                                                                
      if(law.ge.1991) then                                                      
       if(law.ge.1991.and.law.le.1994) then                                     
        if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)                                    
     &    credp=tablki(Bsin,6,agi,data)                                         
        if(mst.eq.4.or.mst.eq.7) credp=tablki(Bhead,6,agi,data)                 
        if(mst.eq.2.or.mst.eq.5) credp=tablki(Bjoin,6,agi,data)                 
       elseif(law.ge.1995) then                                                 
        do 1995 i = 1,29                                                        
c          if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                            
          if(mst.eq.1) then                                                     
            if(law.le.1999) B95(1,i) = B95s(i)                                  
            if(law.eq.2000) B95(1,i) = B00s(i)                                  
            if(law.ge.2001.and.law.le.2003) B95(1,i) = B01s(i)                  
            if(law.ge.2004.and.law.le.2006) B95(1,i) = B04s(i)                  
            if(law.eq.2007) B95(1,i) = B07s(i)                                  
            if(law.ge.2008.and.law.le.2011) B95(1,i) = B08s(i)                  
            if(law.eq.2012) B95(1,i) = B12s(i)                                  
            if(law.eq.2013) B95(1,i) = B13s(i)                                  
            if(law.eq.2014.or.law.eq.2015) B95(1,i) = B14s(i)                   
            if(law.ge.2016) B95(1,i) = B16s(i)                                  
          else if(mst.eq.4.or.mst.eq.7) then                                    
            B95(1,i) = B95h(i)                                                  
          else                                                                  
            B95(1,i) = B95j(i)/sep                                              
          endif                                                                 
1995    continue                                                                
        credp=tablki(B95,29,agi,data)                                           
       endif                                                                    
                                                                                
       ytax=xtax*credp                                                          
       inctax=xtax-ytax                                                         
       statax=inctax                                                            
      endif                                                                     
      if(law.eq.1991) statax = statax + cgtax + divtax                          
c      write(0,*) 'statax',statax                                               
c---------------------------                                                    
      amcred =0.                                                                
      if(law.ge.1993.and.comnew(70).gt.0.d0) then                               
         xprefs=comnew(69)-subrac                                               
         if(mst.eq.3.or.mst.eq.6.and.xprefs.gt.165000.) then                    
           if(xprefs.gt.255000.)then                                            
             xprefs=xprefs+22500.                                               
           else                                                                 
             xprefs=xprefs+.25*(xprefs-165000.)                                 
           endif                                                                
         endif                                                                  
         xemp=sorm(mst,33750.0d0,45000.0d0/sep)                                 
         xln9=max(0.0d0,xprefs-sorm(mst,112500.0d0,150000.0d0/sep))*.25         
         xemp=max(0.0d0,xemp-xln9)                                              
         xln11=max(0.0d0,xprefs-xemp)                                           
         if(xln11.gt.0.) then                                                   
           if(xln11.gt.(175000.d0/sep)) then                                    
             xln12=(45500.d0/sep)+(xln11-175000.d0/sep)*.28 -                   
     &       xif(law.ge.1994,3500.0d0/sep)                                      
           else                                                                 
             xln12=xln11*.26                                                    
           endif                                                                
           if(law.le.1993) then                                                 
             amt=max((xln12*.23)-statax,0.0d0)                                  
           else if(law.ge.1994) then                                            
c             amt=max(min(xln12*.19,xprefs*.05)-inctax,0.0d0)                   
             amt=max(min(xln12*.19,xprefs*.05)-statax,0.0d0)                    
c amcred - Adjusted Net Connecticut Minimum Tax Credit since 1994               
c line 7 Form CT-1040 in 1994                                                   
             amcred = min(xln12*.19,max((-amt),0.0d0))                          
             if(law.gt.2012) then                                               
              d22 = data(22)                                                    
              data(22) = 0.d0                                                   
              call nlaw(data,law)                                               
              data(22) = d22                                                    
              tamt = comnew(88) + comnew(89)                                    
              amt1 = .19*(tamt - data(163))                                     
              amt2 = .055*comnew(69)                                            
              amtfin = min(amt1,amt2)                                           
              amt = max(0.d0,statax-amtfin)                                     
              amcred = min(xln12*.19,amt)                                       
             endif                                                              
           endif                                                                
         else                                                                   
           amt=0.                                                               
         endif                                                                  
         statax = max(statax - amcred,0.0d0)                                    
         statax=  max(statax + amt   ,0.0d0)                                    
      endif                                                                     
c      write(0,*) 'amt statax',amt,statax                                       
c Credit for property taxes paid on your primary residence and/or               
c motor vehicle : since 1996 year and not more than $100                        
c $500 in 2000, $425 in 1999, $350 in 1998, $215 in 1997                        
      pcred = 0.d0                                                              
      if(law.ge.1996)  then                                                     
       pcred = min(prop(law),data(51))                                          
c Credit for property taxes paid is subject to limitations since 1997           
       if(law.ge.1997) then                                                     
        if(mst.eq.1) then                                                       
           phse = phses(law)                                                    
        else if(mst.eq.4.or.mst.eq.7) then                                      
           phse = phseh(law)                                                    
        else                                                                    
           phse = phsej(law)/sep                                                
        endif                                                                   
        agix = max(0.0d0,agi)                                                   
        do 1001 i = 1,7                                                         
        prop2(1,i) = phse + (i-1)*10000                                         
1001    continue                                                                
        pct = tablki(prop2,8,agix,data)                                         
c Property Tax Credit Limitation                                                
        pcred = pcred - pct*pcred                                               
       endif                                                                    
c 2017+ The property tax credit can not be claimed if you were not 65+,         
c or if you did not claim at least 1 dependent on our federal return.           
       if(law.ge.2017) then                                                     
         if(data(8).lt.1.d0.and.data(9).lt.1.d0) pcred = 0.d0                   
       endif                                                                    
      endif                                                                     
      statax=max(0.0d0,statax-pcred)                                            
c New in 2011 - Connecticut EITC                                                
      earncr = 0.                                                               
      if(law.ge.2011) then                                                      
         earncr = reic(law)*comnew(59)                                          
      endif                                                                     
      statax = statax - earncr                                                  
      credit = pcred + amcred + earncr                                          
      return                                                                    
      end                                                                       
c                                                                               
      subroutine cttab(tab,n,agi,div,statax,rate)                               
      implicit double precision (A-H,O-Z)                                       
      dimension tab(2,n)                                                        
      statax=0.                                                                 
      do 10 i=1,n                                                               
      rt=tab(2,i)                                                               
      if(rt.ge..15) then                                                        
        write(0,*)'TAX RATE ERROR IN CTTAX'                                       
      continue                                                                  
      endif                                                                     
      if(agi .le. tab(1,i)) goto 20                                             
10    continue                                                                  
      i=n                                                                       
20    continue                                                                  
      statax=statax+(rt*div)                                                    
      rate=rt                                                                   
      return                                                                    
      end                                                                       
c                                                                               
c  DELAWARE                                                                  
c  State 08                                                                   
c                                                                               
c     Updated through 2021 (updated 02.23.2022)                                 
      subroutine detax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
c      dimension tab99(8,2),tab00(7,2),tab98(7,2)                               
      dimension tab99(7,2),tab00(6,2),tab98(6,2),tab09(7,2),tab12(7,2)          
      dimension tab(2,17),tab77(17),tab79(17),tab80(17),tab14(7,2)              
      dimension tab85(17),tab86(17),tab87(17),tab88(17),tab96(17)               
      dimension data(255),comnew(255),xmp(1977:2021,3),ded(1977:1986),          
     & xcoef(1991:1997),aif92(1992:2012),chlim(1999:2021),pns(1977:2021)        
     &,aif13(2013:2017)                                                         
      data pns/22*3000.0d0,5000.0d0,22*12500.0d0/                               
      data chlim/4*720.0d0,18*1050.0d0,4000.d0/                                 
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data aif92/                                                               
     &  1.0525d0, 1.0845d0, 1.118d0 , 1.147d0 , 1.1795d0, 1.2120d0,             
     &  1.2450d0, 1.2660d0, 1.2895d0, 1.3295d0, 1.3730d0, 1.3950d0,             
     &  1.4270d0, 1.4595d0, 1.5050d0, 1.5640d0, 1.5995d0, 1.6680d0,             
     &2*1.6955d0, 1.7365d0/                                                     
      data xcoef/1.,1.05250d0,1.08450d0,1.1180d0,1.1470d0,1.17950d0,            
     & 1.2120d0/                                                                
c Rates change, brackets don't.  Later these rates will be substituted          
c  into the "tab" array(up to 1998).                                            
      data tab / 1000.0d0, 0.0d0,  2000.0d0, 0.0d0, 3000.0d0, 0.0d0,            
     &           4000.0d0, 0.0d0,  5000.0d0, 0.0d0, 6000.0d0, 0.0d0,            
     &           8000.0d0, 0.0d0, 10000.0d0, 0.0d0,15000.0d0, 0.0d0,            
     &          20000.0d0, 0.0d0, 25000.0d0, 0.0d0,30000.0d0, 0.0d0,            
     &          40000.0d0, 0.0d0, 50000.0d0, 0.0d0,75000.0d0, 0.0d0,            
     &         100000.0d0, 0.0d0,     1.e20, 0.0d0/                             
c     data tab98 /   2000., 0.,  5000., 3.1, 10000., 4.86,                      
c    & 20000., 5.8, 25000., 6.2,30000., 6.44,                                   
c    & 1.e20, 6.9/                                                              
c     data tab99 /   2000., 0.,  3000., 2.5,  5000., 2.6,                       
c    & 10000., 4.3, 20000., 5.2, 25000., 5.6, 60000., 5.95,                     
c    & 1.e20, 6.4/                                                              
c     data tab00 /   2000., 0.,   5000., 2.2,                                   
c    & 10000., 3.9, 20000., 4.8, 25000., 5.2, 60000., 5.55,                     
c    & 1.e20, 5.95/                                                             
c 1977                                                                          
      data tab77/1.6d0,2.2d0,3.3d0, 4.4d0, 5.5d0, 6.6d0, 7.7d0,                 
     &         3*8.8d0,9.3d0,9.9d0,12.1d0,13.2d0,15.4d0,16.5d0, 19.8d0/         
c 1979                                                                          
      data tab79/1.5d0 , 2.1d0, 3.15d0, 4.3d0, 5.35d0, 6.4d0 ,                  
     &           7.45d0, 8.4d0, 8.5d0 , 8.6d0, 9.05d0, 9.65d0,                  
     &          11.55d0,12.8d0,14.45d0,15.5d0,16.65d0/                          
c 1980                                                                          
      data tab80/1.4d0, 2.0d0,3.0d0,4.2d0,5.2d0, 6.2d0, 7.2d0,                  
     &           8.0d0, 8.2d0,8.4d0,8.8d0,9.4d0,11.0d0,12.2d0,                  
     &        3*13.5d0/                                                         
c 1985                                                                          
c      data tab85/1.3d0,1.8d0,2.6d0,3.8d0,4.7d0,5.6d0, 6.5d0,                   
c     &           7.2d0,7.4d0,7.6d0,7.9d0,8.5d0,9.9d0,11.0d0,                   
c     &        3*12.2d0/                                                        
c 1985                                                                          
      data tab85/1.3d0,1.8d0,2.6d0,3.8d0,4.7d0,5.6d0, 6.5d0,                    
     &           7.2d0,7.4d0,7.6d0,7.9d0,8.5d0,9.9d0,                           
     &        4*10.7d0/                                                         
c 1986                                                                          
      data tab86/1.2d0,1.6d0,2.4d0,3.5d0,4.3d0,5.1d0,  5.9d0,                   
     &           6.6d0,6.7d0,6.9d0,7.2d0,7.7d0,9.0d0,4*9.7d0/                   
c 1987                                                                          
      data tab87/1.0d0,1.4d0,2.2d0,3.2d0,3.9d0,4.6d0,  5.4d0,                   
     &           6.0d0,6.1d0,6.3d0,6.5d0,7.0d0,8.2d0,4*8.8d0/                   
c 1988                                                                          
      data tab88/2*0.0d0,3.1d0,2*3.2d0,3*5.0d0,2*6.0d0,                         
     &             6.6d0,7.0d0,  7.6d0,4*7.7d0/                                 
c 1996                                                                          
      data tab96/0.0d0,0.0d0 , 3.1d0,2*3.2d0,3*5.0d0,2*6.0d0,                   
     &           6.4d0,6.66d0, 7.1d0,4*7.1d0/                                   
c 1998                                                                          
      data tab98 /   3000.0d0, 3.10d0, 8000.0d0, 4.860d0,                       
     & 18000.0d0, 5.80d0, 23000.0d0, 6.20d0,28000.0d0, 6.440d0,                 
     & 1.e20, 6.90d0/                                                           
c 1999                                                                          
      data tab99 /   1000.0d0, 2.50d0,  3000.0d0, 2.60d0, 8000.0d0,             
     & 4.30d0, 18000.0d0, 5.20d0, 23000.0d0, 5.60d0, 58000.0d0,                 
     & 5.950d0,1.e20, 6.40d0/                                                   
c 2000                                                                          
      data tab00 /   3000.0d0, 2.20d0,  8000.0d0, 3.90d0,18000.0d0,             
     & 4.80d0, 23000.0d0, 5.20d0, 58000.0d0, 5.550d0, 1.e20, 5.950d0/           
c 2009-2011                                                                     
      data tab09 /   2000.0d0, 0.0d0,  5000.0d0, 2.20d0,10000.0d0,              
     & 3.90d0, 20000.0d0, 4.80d0, 25000.0d0, 5.20d0,60000.0d0,                  
     & 5.550d0,1.e20, 6.950d0/                                                  
c 2012-2013                                                                     
       data tab12 /   2000.0d0, 0.0d0,  5000.0d0, 2.20d0,10000.0d0,             
     & 3.90d0, 20000.0d0, 4.80d0, 25000.0d0, 5.20d0,60000.0d0,                  
     & 5.550d0,1.e20, 6.750d0/                                                  
c 2014+                                                                         
       data tab14 /   2000.0d0, 0.0d0,  5000.0d0, 2.20d0,10000.0d0,             
     & 3.90d0, 20000.0d0, 4.80d0, 25000.0d0, 5.20d0,60000.0d0,                  
     & 5.550d0,1.e20, 6.60d0/                                                   
      data xmp/8*600.0d0,800.0d0,2*1000.0d0,8*1250.0d0,26*0.0d0,                
     &                   11*1.0d0,34*0.0d0,                                     
     &                   10*0.0d0,2*.250d0,33*.50d0/                            
      data ded/10*.20d0/                                                        
      do 20 i=1,17                                                              
         if(law.eq.1977.or.law.eq.1978) tab(2,i)=tab77(i)                       
         if(law.eq.1979) tab(2,i)=tab79(i)                                      
         if(law.ge.1980.and.law.le.1984) tab(2,i)=tab80(i)                      
         if(law.eq.1985) tab(2,i)=tab85(i)                                      
         if(law.eq.1986) tab(2,i)=tab86(i)                                      
         if(law.eq.1987) tab(2,i)=tab87(i)                                      
         if(law.ge.1988.and.law.le.1995) tab(2,i)=tab88(i)                      
         if(law.eq.1996) tab(2,i)=tab96(i)                                      
20    continue                                                                  
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)phas92=100000.*aif92(law)/sep              
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c   AGI                                                                         
c    can't add fed tax refund or subtract interest on US obligations            
c    adjustment for poor and elderly/can't calculate for disabled               
      agi=comnew(2)                                                             
c Social Security Benefits and State Tax refund are not taxable                 
      agi=agi-comnew(79)-data(22)                                               
c unemployment compensation is not taxable in 2021                              
      if(law.eq.2021) agi = agi - data(82)                                      
      texp=data(7)                                                              
      bexp=data(9)+data(10)                                                     
      penson=data(20)+data(72)                                                  
      penexc = 0.                                                               
      if(data(9).lt.1.) then                                                    
c under 60 pnsion exclusion (line 34 in 2006)                                   
       penexc = min(data(7)*2000.0d0,penson)                                    
      else if(data(9).eq.1) then                                                
       penexc = min(pns(law),penson+.5*(data(14)+data(12)+                      
     &  max(0.0d0,comnew(6))+                                                   
     &  max(0.0d0,data(73))))                                                   
c 60 or over pension exclusion (line 34 in 2006)                                
      else                                                                      
       penexc = min(2*pns(law),penson+data(14)+data(12)+                        
     &  max(0.0d0,comnew(6))+ max(0.0d0,data(73)))                              
      endif                                                                     
      penexc = max(0.0d0,penexc)                                                
      agi = agi - penexc                                                        
c exclusion for those 60 and over  (line 39 in 2006)                            
      if(law.ge.1984.and.data(9).gt.0.and.comnew(37).lt.2500*data(9)            
     &.and.agi.le.10000*data(9))  agi= agi - 2000.*data(9)                      
c     DEDUCTIONS                                                                
c     when 1987 data is in use; after 1988 separate filers are allowed          
c     different passive real estate losses than fed                             
      if(law.le.1987) then                                                      
        stded=min(data(7)*1000.d0/sep,.1*max(0.0d0,agi))                        
      else if(law.ge.1988.and.law.le.1998) then                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.5.or.mst.eq.7) then                   
          stded=1300.d0                                                         
        else                                                                    
          stded=1600.d0/sep                                                     
        endif                                                                   
      else if(law.eq.1999) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.5.or.mst.eq.7) then                   
          stded=3250.d0                                                         
        else                                                                    
          stded=4000.d0/sep                                                     
        endif                                                                   
      else if(law.ge.2000) then                                                 
        stded = 3250.*data(7)                                                   
      endif                                                                     
c additional standard deduction for old people or blind                         
      if(law.ge.1987.and.law.le.1998) then                                      
         stded=stded+(bexp*1000.)                                               
      elseif (law.ge.1999) then                                                 
         stded=stded+(bexp*2500.)                                               
      endif                                                                     
c Itemized deductions                                                           
      if(law.le.2017) then                                                      
        xitded = max(0.0d0,comnew(30)-data(50))                                 
      else if(law.eq.2018) then                                                 
        sttax = min(10000.d0/sep,data(51)+data(50)+data(54))                    
        xitded = comnew(30) - min(data(50),sttax - (data(51)+data(54)))         
      else if(law.ge.2019) then                                                 
c        sttax = min(10000.d0/sep,data(51)+data(50)+data(54))                   
        xitded = comnew(30)                                                     
      endif                                                                     
      if(law.ge.1981) xitded = xitded+data(34)                                  
      if(law.le.1986) then                                                      
          ylimi = ded(law)                                                      
          char = data(58)+data(59)+data(60)                                     
          xitded = xitded-max(char-ylimi*max(0.0d0,agi),0.0d0)                  
      endif                                                                     
      if(law.eq.1987) xitded = xitded * 1.12                                    
      if(law.ge.1991.and.law.le.2017) then                                      
          if(agi.gt.phas92) then                                                
            reduce = min(.8*xitded,.03*(agi-phas92))                            
            if(law.eq.2006.or.law.eq.2007) reduce = 2*reduce/3                  
            if(law.eq.2008.or.law.eq.2009) reduce = reduce/3                    
            if(law.ge.2010.and.law.le.2012) reduce = 0                          
            xitded = xitded-reduce                                              
          endif                                                                 
      endif                                                                     
      ided = int(data(4))                                                            
      if(ided.eq.-2.and.law.eq.1999) xitded=0                                   
      deduc = max(stded,xitded)                                                 
c A taxpayer can elect to use the standard deduction even he uses               
c itemized deductions in the Federal law.                                       
c EXEMPTIONS                                                                    
      num=int(comnew(68))                                                            
      if(law.eq.1989)num=num+int(data(9))                                            
      exemp = 0.                                                                
      if(law.le.1987) then                                                      
       exemp=(num*xmp(law,1))+twn(comnew(1),0.0d0,300.d0*texp)                  
c since 1996 only personal exemption credit exists, no exemptions               
      else if(law.ge.1988.and.law.le.1995) then                                 
        exemp=(num*xmp(law,1))                                                  
      endif                                                                     
      taxinc = max(0.0d0,agi - deduc - exemp)                                   
c      write(0,*) 'taxinc agi deduc exemp',taxinc,agi,deduc,exemp               
c According to the Tax Table, taxes for taxable income 0-$2000 are 0            
c for all income levels                                                         
      if(law.ge.1997.and.law.le.2008) taxinc = max(0.0d0,taxinc - 2000)         
      if(mst.eq.2.and.agi.gt.0) then                                            
        agih = max(data(85),data(86))+.5*(agi - data(11))                       
        agiw = agi-agih                                                         
c        xitdh = xitded*agih/agi                                                
c        xitdw = xitded-xitdh                                                   
c        dedh = max(.5*stded,xitdh)                                             
c        dedw = max(.5*stded,xitdw)                                             
         dedh = deduc*agih/agi                                                  
         dedw = deduc - dedh                                                    
        taxinh=max(0.0d0,agih-dedh-.5*exemp)                                    
        taxinw=max(0.0d0,agiw-dedw-.5*exemp)                                    
        if(law.ge.1997.and.law.le.2008) then                                    
          taxinh=max(0.0d0,taxinh- 2000.)                                       
          taxinw=max(0.0d0,taxinw -2000.)                                       
        endif                                                                   
      endif                                                                     
      if(law.le.1996) then                                                      
          call look(tab,taxinc,17,n,statax,1.0d00,0.0d0,rt,data)                
          if(mst.eq.2.and.agi.gt.0) then                                        
            call look(tab,taxinh,17,n,stath,1.0d00,0.0d0,rt,data)               
            call look(tab,taxinw,17,n,statw,1.0d00,0.0d0,rt,data)               
            statax = min(statax,stath+statw)                                    
          endif                                                                 
      else if(law.eq.1997.or.law.eq.1998) then                                  
          call look(tab98,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                
          if(mst.eq.2.and.agi.gt.0) then                                        
            call look(tab98,taxinh,6,n,stath,1.0d0,0.0d0,rt,data)               
            call look(tab98,taxinw,6,n,statw,1.0d0,0.0d0,rt,data)               
            statax = min(statax,stath+statw)                                    
          endif                                                                 
      else if(law.eq.1999) then                                                 
           call look(tab99,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)               
           if(mst.eq.2.and.agi.gt.0) then                                       
             call look(tab99,taxinh,7,n,stath,1.0d0,0.0d0,rt,data)              
             call look(tab99,taxinw,7,n,statw,1.0d0,0.0d0,rt,data)              
             statax = min(statax,stath+statw)                                   
           endif                                                                
      else if(law.ge.2000.and.law.le.2008) then                                 
          call look(tab00,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                
          if(mst.eq.2.and.agi.gt.0) then                                        
            call look(tab00,taxinh,6,n,stath,1.0d0,0.0d0,rt,data)               
            call look(tab00,taxinw,6,n,statw,1.0d0,0.0d0,rt,data)               
            statax = min(statax,stath+statw)                                    
          endif                                                                 
      else if(law.ge.2009.and.law.le.2011) then                                 
          call look(tab09,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                
          if(mst.eq.2.and.agi.gt.0) then                                        
            call look(tab09,taxinh,7,n,stath,1.0d0,0.0d0,rt,data)               
            call look(tab09,taxinw,7,n,statw,1.0d0,0.0d0,rt,data)               
            statax = min(statax,stath+statw)                                    
          endif                                                                 
      else if(law.ge.2012.and.law.le.2013) then                                 
          call look(tab12,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                
          if(mst.eq.2.and.agi.gt.0) then                                        
            call look(tab12,taxinh,7,n,stath,1.0d0,0.0d0,rt,data)               
            call look(tab12,taxinw,7,n,statw,1.0d0,0.0d0,rt,data)               
             statax = min(statax,stath+statw)                                   
          endif                                                                 
      else if(law.ge.2014) then                                                 
          call look(tab14,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                
          if(mst.eq.2.and.agi.gt.0) then                                        
            call look(tab14,taxinh,7,n,stath,1.0d0,0.0d0,rt,data)               
            call look(tab14,taxinw,7,n,statw,1.0d0,0.0d0,rt,data)               
            statax = min(statax,stath+statw)                                    
          endif                                                                 
      endif                                                                     
c Child Care Credit since 1987                                                  
      chcr=comnew(53)*xmp(law,3)                                                
      if(law.ge.1999) chcr = min(chcr,chlim(law))                               
      cred = 0.                                                                 
      if(law.ge.1977)cred = min(5.*data(38),200.0d0)                            
c- since-1996-personal exemption credit----                                     
      pecred = 0.                                                               
      if(law.ge.1996.and.law.le.1999) then                                      
         pecred = (num + data(9))*100.                                          
      else if(law.ge.2000) then                                                 
         pecred = (num + data(9))*110.                                          
      endif                                                                     
      credit = chcr + cred + pecred                                             
      statax=max(0.0d0,statax-credit)                                           
c since 2006, EITC - non-refundable                                             
      earncr = 0.                                                               
      if(law.ge.2006.and.law.le.2020) then                                      
         earncr = .2*comnew(59)                                                 
         statax=max(0.0d0,statax-earncr)                                        
      else if(law.ge.2021) then                                                 
c ref crdt of 4.5% of the fed eic or a nonref crdt of 20% of the fed eic        
         if(.045*comnew(59).gt.statax) then                                     
            earncr = .045*comnew(59)                                            
            statax = statax - earncr                                            
         else                                                                   
            earncr = .2*comnew(59)                                              
            statax=max(0.0d0,statax-earncr)                                     
         endif                                                                  
      endif                                                                     
      credit = credit + earncr                                                  
      return                                                                    
      end                                                                       
c                                                                               
c  DISTRICT OF COLUMBIA                                                         
c  State 09                                                                      
c  Status: Updated through 2021(02.24.2022)                                     
      subroutine dctax(data,comnew, statax,law)                                 
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/times/zitem,ptax,txrate,h                                          
      common /fed/ zbrack(3,1987:2022),exem(1987:2022)                          
      dimension prop1(2,7), prop2(2,5), xmp(1977:2021)                          
c  ylowj,ylows,ylowh through 2017(2018+ Low Income tax crd eliminated)          
      dimension ylowj(0:4,1987:2017),xtra(1987:2017)                            
      dimension ylows(0:2,1987:2017), ylowh(0:2,1987:2017)                      
      dimension data(255),comnew(255),aif92(1992:2012)                          
      dimension tab77(2,10), tab87(2,3), tab88(2,3)                             
     &,tab00(2,3),tab01(2,3),tab05(2,3),tab06(2,3),tab07(2,3),tab12(2,4)        
     &,tab15(2,5),tab16(2,6)                                                    
      dimension crmaxd(2015:2021),amaxd(2015:2021),ymaxd(2015:2021),            
     & dyd(2015:2021)                                                           
      dimension prop(2014:2021),pagi(2014:2021),prlim(2014:2021)                
      dimension bbrack(3,2018:2021),zbrmin(2018:2021)                           
      integer dx2,sep                                                           
      data crmaxd /  503.d0,506.d0,510.d0,519.d0,529.d0,538.d0,1502.d0/         
      data amaxd/24040.d0,24254.d0, 24630.d0,24982.d0,25477.d0,25833.d0,        
     & 37455.d0/                                                                
      data ymaxd/18111.d0,18292.d0, 18622.d0,18862.d0,19239.d0,19489.d0,        
     & 19743.d0/                                                                
      data dyd /2*3400.d0,3450.d0,3500.d0,3600.d0,3650.d0,10000.d0/             
      data bbrack /1600.d0,1300.d0,1600.d0,1650.d0,1300.d0,1650.d0,             
     &             1650.d0,1300.d0,1650.d0,1700.d0,1350.d0,1700.d0/             
      data zbrmin/1050.d0,3*1100.d0/                                            
      data prop/2*40000.d0,50000.d0,50500.d0,51000.d0,55000.d0,55700.d0,        
     &            56200.d0/                                                     
      data pagi  /3*60000.d0,61900.d0,62600.d0,75000.d0,75900.d0,               
     & 76700.d0/                                                                
      data prlim  /3*1000.d0,2*1025.d0,2*1200.d0,1225.d0/                       
      data tab77 /  1000.0d0, 2.0d0,  2000.0d0, 3.0d0,  3000.0d0, 4.0d0,        
     & 4000.0d0,  5.0d0,                                                        
     &  5000.0d0, 6.0d0, 10000.0d0, 7.0d0, 13000.0d0, 8.0d0, 17000.0d0,         
     & 9.0d0, 25000.0d0, 10.0d0,                                                
     &  1.e20, 11.0d0/                                                          
      data tab87/  10000.0d0, 6.0d0, 20000.0d0, 8.0d0, 1.e20, 10.0d0/           
      data tab88/  10000.0d0, 6.0d0, 20000.0d0, 8.0d0, 1.e20, 9.50d0/           
      data tab00/  10000.0d0, 5.0d0, 20000.0d0, 7.5d0, 1.e20, 9.50d0/           
      data tab01/  10000.0d0, 5.0d0, 30000.0d0, 7.5d0, 1.e20, 9.30d0/           
      data tab05/  10000.0d0, 5.0d0, 30000.0d0, 7.5d0, 1.e20, 9.00d0/           
      data tab06/  10000.0d0, 4.5d0, 40000.0d0, 7.0d0, 1.e20, 8.70d0/           
      data tab07/  10000.0d0, 4.0d0, 40000.0d0, 6.0d0, 1.e20, 8.50d0/           
      data tab12/  10000.0d0, 4.0d0, 40000.0d0, 6.0d0,                          
     &            350000.0d0, 8.5d0,     1.e20, 8.95d0/                         
      data tab15/  10000.0d0, 4.0d0, 40000.0d0, 6.0d0, 60000.0d0, 7.0d0,        
     &            350000.0d0, 8.5d0,     1.e20, 8.95d0/                         
      data tab16/  10000.0d0, 4.0d0, 40000.0d0, 6.0d0, 60000.0d0, 6.5d0,        
     &            350000.0d0, 8.5d0,      1.e6, 8.75d0,   1.e20, 8.95d0/        
      data aif92/                                                               
     &   1.0525d0, 1.0845d0, 1.118d0 , 1.147d0 , 1.1795d0, 1.212d0,             
     &   1.2450d0, 1.2660d0, 1.2895d0, 1.3295d0, 1.3730d0, 1.395d0,             
     &   1.4270d0, 1.4595d0, 1.5050d0, 1.5640d0, 1.5995d0, 1.668d0,             
     & 2*1.6955d0, 1.7365d0/                                                    
c 2018+ personal exemptions eliminated                                          
      data xmp/                                                                 
     &   10*750.0d0,  885.0d0, 1025.0d0, 1160.0d0, 1270.0d0,15*1370.0d0,        
     &   2*1500.0d0,6*1675.d0, 1725.0d0, 3*1775.0d0,4*0.d0/                     
      data prop1 /                                                              
     &    3000.0d0, .015d0, 5000.0d0, .02d0 ,  7000.0d0, .025d0,                
     &   10000.0d0, .030d0,15000.0d0, .035d0, 20000.0d0, .040d0,                
     &       1.e20,1.0d0/                                                       
      data prop2 /                                                              
     &    5000.0d0, .010d0, 10000.0d0, .015d0, 15000.0d0,.020d0,                
     &   20000.0d0, .025d0,     1.e20,1.0d0/                                    
c     starting points for low income credit                                     
c low income credit numbers for 1998 are only guessed                           
c 2018+ low income credit is eliminated                                         
      data ylowj/                                                               
     & 227.4d0,284.7d0,267.6d0,250.5d0,233.40d0,293.0d0,266.0d0,                
     & 242.0d0,215.0d0,191.0d0,293.0d0,260.0d0,227.0d0,194.0d0,                 
     & 158.0d0,302.0d0,263.0d0,227.0d0,191.0d0,152.0d0,                         
     & 317.0d0,272.0d0,230.0d0,188.0d0,143.0d0,353.0d0,311.0d0,                 
     & 272.0d0,233.0d0,191.0d0,371.0d0,329.0d0,290.0d0,251.0d0,                 
     & 209.0d0,392.0d0,353.0d0,317.0d0,281.0d0,242.0d0,410.0d0,                 
     & 371.0d0,335.0d0,299.0d0,260.0d0,425.0d0,389.0d0,356.0d0,                 
     & 323.0d0,287.0d0,449.0d0,413.0d0,380.0d0,347.0d0,311.0d0,                 
     &           455.0d0,  430.0d0,   397.0d0,  366.0d0,  332.0d0,              
     &           479.0d0,  446.0d0,   415.0d0,  386.0d0,  353.0d0,              
     &           411.0d0,  384.0d0,   359.0d0,  334.0d0,  306.0d0,              
     &           434.0d0,  409.0d0,   386.0d0,  364.0d0,  339.0d0,              
     &           434.0d0,  409.0d0,   386.0d0,  364.0d0,  339.0d0,              
     &           566.0d0,  532.0d0,   502.0d0,  481.0d0,  459.0d0,              
     &           566.0d0,  532.0d0,   502.0d0,  481.0d0,  459.0d0,              
     &           626.0d0,  596.0d0,   569.0d0,  543.0d0,  513.0d0,              
     &           550.0d0,  515.0d0,   480.0d0,  447.0d0,  424.0d0,              
     &           520.0d0,  493.0d0,   466.0d0,  439.0d0,  412.0d0,              
     &           435.0d0,  397.0d0,   373.0d0,  347.0d0,  323.0d0,              
     &           481.0d0,  447.0d0,   412.0d0,  386.0d0,  363.0d0,              
     &           483.0d0,  447.0d0,   414.0d0,  385.0d0,  363.0d0,              
     &           495.0d0,  459.0d0,   426.0d0,  393.0d0,  371.0d0,              
     &           531.0d0,  498.0d0,   468.0d0,  435.0d0,  405.0d0,              
     &           555.0d0,  525.0d0,   498.0d0,  468.0d0,  441.0d0,              
     &           355.0d0,  321.0d0,   301.0d0,  279.0d0,  258.0d0,              
     &           349.0d0,  327.0d0,   307.0d0,  285.0d0,  265.0d0,              
     &           353.0d0,  331.0d0,   311.0d0,  289.0d0,  269.0d0,              
     &           279.0d0,  259.0d0,   237.0d0,  217.0d0,  195.0d0/              
                                                                                
      data ylows/93.30d0,112.8d0,104.70d0,116.0d0,101.0d0, 83.0d0,              
     & 116.0d0, 92.00d0,  68.0d0,  122.0d0,  95.0d0,  65.0d0,                   
     & 131.0d0, 101.0d0,  68.0d0,  152.0d0, 125.0d0,  95.0d0,                   
     & 161.0d0, 134.0d0, 104.0d0,  173.0d0, 149.0d0, 122.0d0,                   
     & 182.0d0, 158.0d0, 131.0d0,  191.0d0, 170.0d0, 146.0d0,                   
     & 206.0d0, 185.0d0, 161.0d0,  211.0d0, 181.0d0, 164.0d0,                   
     & 221.0d0, 203.0d0, 182.0d0,  191.0d0, 179.0d0, 164.0d0,                   
     & 204.0d0, 191.0d0, 176.0d0,  204.0d0, 191.0d0, 176.0d0,                   
     & 221.0d0, 211.0d0, 199.0d0,  221.0d0, 211.0d0, 199.0d0,                   
     & 241.0d0, 236.0d0, 229.0d0,  201.0d0, 190.0d0, 179.0d0,                   
     & 183.0d0, 182.0d0, 174.0d0,  131.0d0, 119.0d0, 105.0d0,                   
     & 148.0d0, 137.0d0, 126.0d0,  147.0d0, 137.0d0, 125.0d0,                   
     & 151.0d0, 141.0d0, 129.0d0,  163.0d0, 155.0d0, 145.0d0,                   
     & 169.0d0, 163.0d0, 155.0d0,  171.0d0, 165.0d0, 157.00d0,                  
     & 133.0d0, 125.0d0, 115.0d0,  133.0d0, 127.0d0, 117.0d0,                   
     & 119.0d0, 111.0d0, 101.0d0/                                               
      data ylowh/40.2d0,143.7d0,135.6d0,140.0d0,122.0d0,107.0d0,                
     & 134.0d0, 110.0d0, 86.0d0,  137.0d0, 107.0d0,  80.0d0,                    
     & 146.0d0, 113.0d0, 83.0d0,  170.0d0, 140.0d0, 113.0d0,                    
     & 185.0d0, 155.0d0,128.0d0,  200.0d0, 173.0d0, 149.0d0,                    
     & 212.0d0, 185.0d0,161.0d0,  224.0d0, 200.0d0, 179.0d0,                    
     & 239.0d0, 215.0d0,194.0d0,  248.0d0, 218.0d0, 200.0d0,                    
     & 263.0d0, 242.0d0,224.0d0,  226.0d0, 211.0d0, 199.0d0,                    
     & 241.0d0, 226.0d0,214.0d0,  241.0d0, 226.0d0, 214.0d0,                    
     & 266.0d0, 254.0d0,244.0d0,  266.0d0, 254.0d0, 244.0d0,                    
     & 289.0d0, 281.0d0,276.0d0,  242.0d0, 231.0d0, 219.0d0,                    
     & 230.0d0, 222.0d0,214.0d0,  167.0d0, 153.0d0, 141.0d0,                    
     & 187.0d0, 176.0d0,165.0d0,  189.0d0, 177.0d0, 167.0d0,                    
     & 195.0d0, 183.0d0,173.0d0,  207.0d0, 197.0d0, 189.0d0,                    
     & 217.0d0, 209.0d0,203.0d0,  219.0d0, 211.0d0, 205.0d0,                    
     & 129.0d0, 119.0d0,111.0d0,  133.0d0, 123.0d0, 115.0d0,                    
     &  83.0d0,  73.0d0, 65.0d0/                                                
c ylowrt for 1989 should be 51                                                  
      data xtra/ 60.9d0,   54.0d0,   51.0d0,  45.0d0, 48.0d0, 57.0d0,           
     &           57.0d0,   63.0d0,   69.0d0,  72.0d0, 78.0d0, 85.0d0,           
     &           86.0d0,   84.0d0, 2*77.0d0,2*85.0d0, 93.0d0, 81.0d0,           
     &         114.0d0,2*119.0d0,2*120.0d0,126.0d0,3*109.0d0,2*92.0d0/          
c disqualified income limit for the eitc                                        
                                                                                
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      nfile = int(filing(mst,1.,2.,3.,2.))                                      
      blind = data(09)+data(10)                                                 
C  AGI                                                                          
      if(law.le.1981) then                                                      
        addit=divexc(data,comnew,law)+comnew(12)+comnew(14)+data(30)            
        subtra=comnew(78)+data(22)+data(26)                                     
        agi=comnew(2)+addit-subtra                                              
      else                                                                      
        agi=comnew(2)-data(22)                                                  
        if(law.ge.1982.and.law.le.1986) agi = agi + comnew(32)                  
        if(law.ge.1984)agi=agi-comnew(79)                                       
c  government employee pension exclusion                                        
c (TaxSim does not use this exclusion if a pension is                           
c  specifically from government)                                                
c     if(law.ge.1986) agi = agi - min(3000.*data(9),data(72)+data(20))          
      endif                                                                     
c For 2021+ unemployment provided by the federal government/DC/any other state, 
c are excluded in the computation of District gross income.                     
      agi = agi - data(82)                                                      
c  Standard Deduction                                                           
      if(law.le.1981) then                                                      
        stded = twn(.1d0*agi,0.0d0,1000.d0/sep)                                 
      else if(law.ge.1982.and.law.le.1986) then                                 
        stded = 1000.d0/sep                                                     
      else if(law.ge.1987.and.law.le.2005) then                                 
        stded = 2000.d0/sep                                                     
      else if(law.eq.2006.or.law.eq.2007) then                                  
        stded = 2500.d0/sep                                                     
      else if(law.eq.2008.or.law.eq.2009) then                                  
        stded = 4000.d0/sep + min(data(51),data(7)*500.)                        
      else if(law.ge.2010.and.law.le.2012) then                                 
        stded = 4000.d0/sep                                                     
      else if(law.eq.2013) then                                                 
        stded = 4100.d0/sep                                                     
      else if(law.eq.2014) then                                                 
        stded = 4150.d0/sep                                                     
      else if(law.ge.2015.and.law.le.2016) then                                 
        if(mst.eq.2.or.mst.eq.5) then                                           
          stded = 8350.                                                         
        else if(mst.eq.4.or.mst.eq.7) then                                      
          stded = 6500.                                                         
        else                                                                    
          stded = 5200.                                                         
        endif                                                                   
      else if(law.eq.2017) then                                                 
        if(mst.eq.2.or.mst.eq.5) then                                           
          stded = 10275.                                                        
        else if(mst.eq.4.or.mst.eq.7) then                                      
          stded = 7800.                                                         
        else                                                                    
          stded = 5650.                                                         
        endif                                                                   
      else if(law.ge.2018) then                                                 
        stded = (zbrack(nfile,law)/sep+bbrack(nfile,law)*blind)                 
        if(data(105).gt.0) then                                                 
c   stded calculations for dependent returns                                    
           earnkd = data(11)+max(0.0d0,data(17)-data(124))                      
           earnkd = earnkd + 350.d0                                             
           stded = min(stded,max(zbrmin(law),earnkd))                           
        endif                                                                   
      endif                                                                     
      deduc = stded                                                             
c  Itemized Deductions                                                          
      xitded = 0.                                                               
      if(comnew(26).gt.0..and.comnew(30).gt.0) then                             
       if(law.le.1981) then                                                     
        xitded=comnew(24)-max(comnew(23)-.15*max(agi,0.0d0),0.0d0)              
     &   -data(60)-data(65)                                                     
       else if (law.ge.1982.and.law.le.2017) then                               
        xitded=max(0.0d0,comnew(24)-data(50)*comnew(24)/comnew(30))             
       else if (law.ge.2018) then                                               
        sttax = min(10000.d0/sep,data(51)+data(50)+data(54))                    
        xitded = comnew(30) - min(data(50),sttax - (data(51)+data(54)))                                                                         
       endif  
c allowable itemized deductions for agi>200k/sep                                
       if(agi.gt.200000.d0/sep) then                                           
          excess = agi-200000.d0/sep                                            
          casu = max(0.0d0,data(61)-100.)                                       
          casu = max(0.0d0,casu-.1*agi)                                         
          xitded = comnew(20)+casu+                                             
     &    max(0.d0,xitded-comnew(20)-casu-.05*excess)                           
       endif 
       deduc = xitded                                                           
      endif                                                                     
c  Taxpayer MUST itemize deductions if he itemized on his Fed Return            
      ided = int(data(4))                                                            
      if(ided.eq.-2.and.law.eq.1999) xitded=0                                   
c  Exemptions                                                                   
c  exemptions equal to exemptions of irs code with modifications                
      amnt=xmp(law)                                                             
      exemp=(data(7)+data(8)+data(9)+data(10))*amnt                             
      if(mst.eq.4.or.mst.eq.7)exemp= exemp+ amnt                                
      if(data(105).gt.0) exemp = 0.d0                                           
c 2015-2017 Exemption phaseout                                                  
      if(law.ge.2015.and.law.le.2017) then                                      
         exmphl = 150000.                                                       
         ratio = 0.                                                             
         if(agi.gt.275000.d0) ratio = 1.                                        
         if(agi.gt.exmphl.and.agi.le.275000.d0)                                 
     &      ratio = min(1.0d0,.02*max(0.0d0,agi-exmphl)/(2500.d0/sep))          
         amphs =  ratio * exemp                                                 
         exemp = exemp - amphs                                                  
      endif                                                                     
c  Taxable Income                                                               
      taxinc=max(0.0d0,agi-deduc-exemp)                                         
c       write(0,*) 'agi deduc exemp taxinc',agi,deduc,exemp,taxinc               
      if(law.le.1986) then                                                      
        call look(tab77,taxinc,10,n,statax,1.0d0,0.0d0,rt,data)                 
      else if(law.eq.1987) then                                                 
        call look(tab87,taxinc,3,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.ge.1988.and.law.le.1999) then                                 
        call look(tab88,taxinc,3,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.eq.2000) then                                                 
        call look(tab00,taxinc,3,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.ge.2001.and.law.le.2004) then                                 
        call look(tab01,taxinc,3,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.eq.2005) then                                                 
        call look(tab05,taxinc,3,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.eq.2006) then                                                 
        call look(tab06,taxinc,3,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.ge.2007.and.law.le.2011) then                                 
        call look(tab07,taxinc,3,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.ge.2012.and.law.le.2014) then                                 
        call look(tab12,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.eq.2015) then                                                 
        call look(tab15,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.ge.2016) then                                                 
        call look(tab16,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                  
      endif                                                                     
c      write(0,*) '1 statax',statax                                             
      if(mst.eq.2.and.agi.gt.0) then                                            
        agih = max(data(85),data(86)) + (agi-data(11))/2.                       
        agiw = agi-agih                                                         
        exemph=exemp*agih/agi                                                   
        exempw=exemp-exemph                                                     
        stdedh=stded*agih/agi                                                   
        stdedw=stded - stdedh                                                   
        xitdh= xitded*agih/agi                                                  
        xitdw= xitded-xitdh                                                     
c        xitdh= .5*xitded                                                       
c        xitdw= .5*xitded                                                       
        if(stded.ge.xitded) then                                                
      call dcstax(law,agih,agiw,stdedh,stdedw,exemph,exempw,taxbc,data)         
        else                                                                    
      call dcstax(law,agih,agiw,xitdh,xitdw,exemph,exempw,taxbc,data)           
        endif                                                                   
        statax = min(statax,taxbc)                                              
      endif                                                                     
c            write(0,*) 'taxinc statax',statax,taxinc                           
                                                                                
c  Credits                                                                      
      credit = 0.                                                               
c  Credit for D.C. campaign contributions through 1988                          
      polcr=0.                                                                  
      if(law.le.1982) then                                                      
        polcr=twn(.5d0*comnew(25),0.0d0,25.d0*data(7))                          
      elseif(law.ge.1983.and.law.le.1988) then                                  
        polcr=twn(.5d0*comnew(25),0.0d0,50.d0*data(7))                          
      endif                                                                     
c  Credit for child care expenses 6% of employment related expenses             
c  for years ..-1980,                                                           
c  30% of the credit allowed on the Federal form for 1981-1988                  
c  32% of the credit allowed on the Federal form for 1989-1999                  
      chcr = 0.                                                                 
c  if(law.le.1981) chcr = .06*comnew(76)                                        
      if(law.ge.1982.and.law.le.1988) then                                      
         chcr = comnew(176)*.3                                                  
      else                                                                      
         chcr = comnew(176)*.32                                                 
      endif                                                                     
c  refund credit  property tax credit                                           
      pcred = 0.                                                                
      ptax = 0.                                                                 
      nqu = 0                                                                   
      if(data(9)+data(10).gt.0.d0) nqu = 1                                      
                                                                                
      if(law.le.2013.and.hy.le.20000) then                                      
           ptax=max(.15*data(160),data(51))                                     
           if(nqu.gt.0) then                                                    
c          pcred=max(0.0d0,                                                     
c     &     (ptax-tablki(prop2,5,hy,data)*hy))                                  
c to avoid notches we interpolate % of household income                         
             pcred = max(0.0d0,ptax - hy*(1 + hy/20000)/100)                    
           else if(nqu.eq.0) then                                               
c          pcred=max(0.0d0,                                                     
c     &     (ptax-tablki(prop1,7,data(159),data)*data(159)))                    
             pcred = max(0.0d0,ptax - hy*(1.5 + hy/8000)/100)                   
             if(hy.lt.3000.d0) then                                             
               pcred=.95*pcred                                                  
             else                                                               
               pcred=.75*pcred                                                  
             endif                                                              
           endif                                                                
           pcred = min(750.0d0,pcred)                                           
      else if(law.ge.2014) then                                                 
           ptax=max(.2*data(160),data(51))                                      
           agix = max(0.0d0,comnew(2))                                          
           pagix = pagi(law)                                                    
           if((nqu.eq.1.and.agix.le.pagix).or.                                  
     &        (nqu.eq.0.and.agix.lt.25000.0d0))                                 
     &          pcred = max(0.0d0,ptax - .03*agix)                              
           if(nqu.eq.0.and.agix.ge.25000.0d0) then                              
              if(law.le.2018) then                                              
                if(agix.le.prop(law))pcred = max(0.0d0,ptax - .04*agix)         
              else                                                              
                if(agix.lt.52000.d0) then                                       
                  pcred = max(0.0d0,ptax - .04*agix)                            
                else if(agix.le.prop(law)) then                                 
                  pcred = max(0.0d0,ptax - .05*agix)                            
                else                                                            
                  pcred = 0.d0                                                  
                endif                                                           
              endif                                                             
           endif                                                                
           pcred = min(prlim(law),pcred)                                        
      endif                                                                     
c if you are under 65 and not climed as a dependent on another return,          
c you are eligible for pcred                                                    
      if(data(9).lt.1.d0.and.data(105).gt.0.d0) pcred = 0.d0                    
c  low income tax credit in DC 1987-2017                                        
      ycr = 0.                                                                  
      if(comnew(52).eq.0.and.(law.ge.1987.and.law.le.2017)                      
     &                             .and.data(105).lt.1) then                    
        allow = data(8)+data(10)+data(9)                                        
        dx2 = int(data(9)+data(10))                                                  
        if(mst.ne.2) dx2 = int(min(data(9)+data(10),2.0d0))                          
        if(mst.eq.2.or.mst.eq.3.or.mst.eq.6) then                               
          ycr = ylowj(dx2,law)/sep                                              
          ycr = ycr + xtra(law)*allow                                           
        else if(mst.eq.1) then                                                  
c  Low Income Credit for Single Taxpayers                                       
          ycr = ylows(dx2,law) + xtra(law)*allow                                
        else                                                                    
          ycr = ylowh(dx2,law) + xtra(law)*allow                                
        endif                                                                   
      else if(comnew(52).eq.0.and.(law.ge.1987.and.law.le.2017)                 
     &.and.comnew(3)-stded.gt.0.and.data(105).gt.0) then                        
       if(law.eq.1987) then                                                     
        call look(tab87,comnew(3)-stded,3,n,ycr,1.0d00,-data(2),rt,data)        
       else if(law.ge.1988.and.law.le.1999) then                                
        call look(tab88,comnew(3)-stded,3,n,ycr,1.0d00,-data(2),rt,data)        
       else if(law.ge.2000) then                                                
        call look(tab00,comnew(3)-stded,3,n,ycr,1.0d00,-data(2),rt,data)        
       else if(law.ge.2001.and.law.le.2004) then                                
        call look(tab01,comnew(3)-stded,3,n,ycr,1.0d0,-data(2),rt,data)         
       else if(law.eq.2005) then                                                
        call look(tab05,comnew(3)-stded,3,n,ycr,1.0d0,-data(2),rt,data)         
       else if(law.eq.2006) then                                                
        call look(tab06,comnew(3)-stded,3,n,ycr,1.0d0,-data(2),rt,data)         
       else if(law.ge.2007.and.law.le.2011) then                                
        call look(tab07,comnew(3)-stded,3,n,ycr,1.0d0,-data(2),rt,data)         
       else if(law.ge.2012.and.law.le.2014) then                                
        call look(tab12,comnew(3)-stded,4,n,ycr,1.0d0,-data(2),rt,data)         
       else if(law.eq.2015) then                                                
        call look(tab15,comnew(3)-stded,5,n,ycr,1.0d0,-data(2),rt,data)         
       else if(law.ge.2016.and.law.le.2017) then                                
        call look(tab16,comnew(3)-stded,6,n,ycr,1.0d0,-data(2),rt,data)         
       endif                                                                    
c Calculation of eligibility of the low income credit:                          
c the credit is not allowable if federal agi exceeds                            
c the federal minimum income requirements                                       
       if(comnew(2).gt.comnew(3) + exem(law)*data(7)) ycr = 0.                  
      endif                                                                     
      credit = credit + chcr + polcr                                            
      statax=max(0.0d0,statax-credit)                                           
      stat1 =max(0.0d0,statax-ycr)                                              
c New in 2000 + earned income credit                                            
      earncr = 0                                                                
      earned = comnew(37)                                                       
      agimax = max(earned,comnew(2))                                            
      if(law.eq.2000) earncr = .1*comnew(59)                                    
      if(law.ge.2001.and.law.le.2004) earncr = .25*comnew(59)                   
      if(law.ge.2005.and.law.le.2007) earncr = .35*comnew(59)                   
      if(law.ge.2008.and.law.le.2014) earncr = .4*comnew(59)                    
      if(law.ge.2015.and.data(8).gt.0.d0) earncr = .4*comnew(59)                
c 2015+ special rule for childless people                                       
      if(law.ge.2015.and.data(8).lt.1.d0) then                                  
         am = amaxd(law)                                                        
         cr = crmaxd(law)                                                       
         ym = ymaxd(law)                                                        
         if(law.le.2020) then                                                   
           if(agimax.le.am)                                                     
     &       earncr = min(cr,.0765*earned)-.0848*max(0.0d0,agimax - ym)         
         else if(law.eq.2021)then                                               
           if(agimax.le.am)                                                     
     &       earncr = min(cr,.153*earned)-.0848*max(0.0d0,agimax - ym)          
         endif                                                                  
c disqy is comnew(159) from fed18c.for                                          
         dylim = dyd(law)                                                       
         if(comnew(159).gt.dylim) earncr = 0.                                   
         if(data(105).gt.0) earncr = 0.                                         
         if(sep.eq.2) earncr = 0.                                               
         if(law.ne.2021.and.data(9).ge.data(7)) earncr = 0.                     
c Childless people younger than 25 y.o. are not eligible for the EITC           
c n205 -- the age of the older taxpayer                                         
c n206 -- the age of the younger taxpayer                                       
         n205 = int(data(205))                                                       
         n206 = int(data(206))                                                       
         if((n205.lt.25.and.n205.gt.0).or.                                      
     &       (n205.gt.65.and.n206.lt.25.and.n206.gt.0)) earncr = 0              
      endif                                                                     
      stat2 = statax - earncr                                                   
c Taxpayer may not claim both the Low Income Credit and the EITC.               
      statax = min(stat1,stat2)                                                 
c      write(0,*) '2 statax earncr stat2',statax,earncr,stat2                   
                                                                                
      if(statax.eq.stat1) then                                                  
         credit = credit + ycr + pcred                                          
       else if (statax.eq.stat2) then                                           
         credit = credit + earncr + pcred                                       
       endif                                                                    
c  Property tax credit is a refund                                              
      statax = statax - pcred                                                   
c       write(0,*) '3 statax pcred',statax,pcred                                
                                                                                
      return                                                                    
      end                                                                       
      subroutine dcstax(law,agih,agiw,dedh,dedw,exemph,exempw,tax,data)         
      implicit double precision (A-H,O-Z)                                       
      dimension tab77(2,10),tab87(2,3),tab88(2,3),tab08(2,3),tab12(2,4),        
     &tab00(2,3),tab01(2,3),tab05(2,3),tab06(2,3),tab07(2,3),tab15(2,5),        
     &data(255),tab16(2,6)                                                      
      data tab77 /  1000.0d0, 2.0d0,  2000.0d0, 3.0d0,  3000.0d0, 4.0d0,        
     &              4000.0d0, 5.0d0,  5000.0d0, 6.0d0, 10000.0d0, 7.0d0,        
     &             13000.0d0, 8.0d0, 17000.0d0, 9.0d0, 25000.0d0,10.0d0,        
     &                 1.e20,11.0d0/                                            
      data tab87/  10000.0d0, 6.0d0, 20000.0d0, 8.0d0, 1.e20, 10.0d0/           
      data tab88/  10000.0d0, 6.0d0, 20000.0d0, 8.0d0, 1.e20,  9.5d0/           
      data tab00/  10000.0d0, 5.0d0, 20000.0d0, 7.5d0, 1.e20,  9.5d0/           
      data tab01/  10000.0d0, 5.0d0, 30000.0d0, 7.5d0, 1.e20,  9.3d0/           
      data tab05/  10000.0d0, 5.0d0, 30000.0d0, 7.5d0, 1.e20,  9.0d0/           
      data tab06/  10000.0d0, 4.5d0, 40000.0d0, 7.0d0, 1.e20,  8.7d0/           
      data tab07/  10000.0d0, 4.5d0, 40000.0d0, 7.0d0, 1.e20,  8.5d0/           
      data tab08/  10000.0d0, 4.0d0, 40000.0d0, 6.0d0, 1.e20,  8.5d0/           
      data tab12/  10000.0d0, 4.0d0, 40000.0d0, 6.0d0,                          
     &            350000.0d0, 8.5d0,     1.e20, 8.95d0/                         
      data tab15/  10000.0d0, 4.0d0, 40000.0d0, 6.0d0, 60000.0d0, 7.0d0,        
     &            350000.0d0, 8.5d0,     1.e20, 8.95d0/                         
      data tab16/  10000.0d0, 4.0d0, 40000.0d0, 6.0d0, 60000.0d0, 6.5d0,        
     &            350000.0d0, 8.5d0,      1.e6, 8.75d0,   1.e20, 8.95d0/        
      taxyh=max(0.0d0,agih-dedh-exemph)                                         
      taxyw=max(0.0d0,agiw-dedw-exempw)                                         
      if(law.le.1986) then                                                      
            call look2(tab77,taxyh,10,n,taxh,1.0d0,0.0d0,rt,data)               
            call look2(tab77,taxyw,10,n,taxw,1.0d0,0.0d0,rt,data)               
      else if(law.eq.1987) then                                                 
            call look2(tab87,taxyh,3,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab87,taxyw,3,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.ge.1988.and.law.le.1999) then                                 
            call look2(tab88,taxyh,3,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab88,taxyw,3,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.eq.2000) then                                                 
            call look2(tab00,taxyh,3,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab00,taxyw,3,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.ge.2001.and.law.le.2004) then                                 
            call look2(tab01,taxyh,3,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab01,taxyw,3,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.eq.2005) then                                                 
            call look2(tab05,taxyh,3,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab05,taxyw,3,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.eq.2006) then                                                 
            call look2(tab06,taxyh,3,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab06,taxyw,3,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.eq.2007) then                                                 
            call look2(tab07,taxyh,3,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab07,taxyw,3,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.ge.2008.and.law.le.2011) then                                 
            call look2(tab08,taxyh,3,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab08,taxyw,3,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.ge.2012.and.law.le.2014) then                                 
            call look2(tab12,taxyh,4,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab12,taxyw,4,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.eq.2015) then                                                 
            call look2(tab15,taxyh,5,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab15,taxyw,5,n,taxw,1.0d0,0.0d0,rt,data)                
      else if(law.ge.2016) then                                                 
            call look2(tab16,taxyh,6,n,taxh,1.0d0,0.0d0,rt,data)                
            call look2(tab16,taxyw,6,n,taxw,1.0d0,0.0d0,rt,data)                
                                                                                
      endif                                                                     
c      write(0,*) 'taxyh taxh',taxyh,taxh                                       
c      write(0,*) 'taxyw taxw',taxyw,taxw                                       
      tax=taxh+taxw                                                             
      return                                                                    
      end                                                                       
c  Georgia                                                                      
c  State 11                                                                     
c  Updated through 2021 (updated 02.24.2022)                                    
c                                                                               
      subroutine gatax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      dimension tabs(2,6),tabm(2,6),gmp(7),fmp(7),rtmax(1977:2021)              
      dimension xmp(1977:2021),stold(1987:2021),std(1987:2021,2),               
     &perch(2006:2021)                                                          
      dimension tabs19(2,6),tabm19(2,6)                                         
      double precision lic(6,2)                                                 
      data perch/0.1d0,0.2d0,14*0.3d0/                                          
      data lic/6000.d0,26.d0,8000.d0,20.d0,10000.d0,14.d0,15000.d0,8.d0,        
     & 20000.d0,5.d0,1.e20,0.d0/                                                
      data stold/11*700.d0,24*1300.d0/                                          
      data std/                                                                 
     1 31*2300.d0,4*4600.d0,                                                    
     2 31*3000.d0,4*6000.d0/                                                    
      data tabs/   750.d0,   1.d0,  2250.d0,  2.d0,  3750.d0,                   
     & 3.d0,  5250.d0,  4.d0, 7000.d0, 5.d0, 1.e20,  6.d0/                      
      data tabm/  1000.d0,   1.d0,  3000.d0,  2.d0,  5000.d0,                   
     & 3.d0,  7000.d0,  4.d0, 10000.d0, 5.d0, 1.e20,  6.d0/                     
      data tabs19/   750.d0,   1.d0,  2250.d0,  2.d0,  3750.d0,                 
     & 3.d0,  5250.d0,  4.d0, 7000.d0, 5.d0, 1.e20,  5.75d0/                    
      data tabm19/  1000.d0,   1.d0,  3000.d0,  2.0d0,  5000.d0,                
     & 3.d0,  7000.d0,  4.d0, 10000.d0, 5.d0, 1.e20,  5.75d0/                   
c Georgia unemployment income limits                                            
      data gmp/ 20000.0d0, 25000.0d0, 3*20000.0d0, 0.0d0, 20000.0d0/            
c Federal unemployment income limits                                            
      data fmp/ 12000.0d0, 18000.0d0, 3*20000.0d0, 0.0d0, 12000.0d0/            
c Retirement exclusion                                                          
      data rtmax/ 5*0.0d0, 4*2000.0d0, 3*4000.0d0,4*8000.0d0,                   
     & 10000.0d0,11000.0d0,4*12000.0d0,                                         
     & 13000.0d0,13500.0d0,14000.0d0,14500.0d0,3*15000.0d0,25000.0d0,           
     & 30000.0d0,4*35000.0d0,10*65000.0d0/                                      
c exemptions for dependents, age and blindness,& + for hohs w/ deps             
      data xmp/10*700.d0, 7*1500.d0, 2000.d0,3*2500.d0,24*2700.d0/              
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      nfile = int(filing(mst,1.,2.,3.,2.))                                      
c AGI                                                                           
      agi=comnew(2)                                                             
      if(law.le.1988)agi=agi-data(22)                                           
c 2020 unemployment compension is taxable                                       
      if(law.eq.2020) then                                                      
        agi = agi + data(82) - comnew(78)                                       
      endif                                                                     
c 2021 please add back you up to $300 cash contributions if cded eq 0           
      if(law.eq.2021.and.comnew(26).eq.0.d0.and.data(58).gt.0.d0) then          
         agi = agi + min(300.d0*data(7),data(58))                               
      endif                                                                     
c for years 1982-1986 (inclusive) Georgia used 1981 federal law                 
      if(law.ge.1982.and.law.le.1986) then                                      
         stira = min(max(data(29)-(comnew(11)-500.),0.0d0),500.0d0)             
         stklim = min(data(28),7500.0d0)                                        
         if(law.eq.1985.or.law.eq.1986)stklim=min(stklim,.15*comnew(37))        
         stkeo = max(comnew(14)-stklim,0.0d0)                                   
         agi = agi + stira + stkeo                                              
         agi = agi + comnew(32)                                                 
         if(law.eq.1982) then                                                   
           agi = agi - twn(data(13),0.0d0,200.d0/sep)                           
         endif                                                                  
         gemp = gmp(mst)                                                        
         femp = fmp(mst)                                                        
         stutx = min(.5*max(data(82)+agi-gemp,0.0d0),data(82))                  
         fdutx = min(.5*max(data(82)+agi-femp,0.0d0),data(82))                  
         agi = agi+(stutx-fdutx)                                                
         if(data(9).gt.0) then                                                  
           if(data(71).ge.100000.d0/sep) then                                   
             glim = 25000.d0/sep                                                
             flim = data(71)-(100000.d0/sep)                                    
             agi = agi+twn(flim,0.0d0,glim)                                     
           endif                                                                
         endif                                                                  
      endif                                                                     
      old = data(9) + data(10)                                                  
      rtexc = 0.                                                                
      if(old.gt.0) then                                                         
        rtexc = max(0.0d0,min(comnew(2),rtmax(law)*old))                        
        if(law.ge.1986.and.law.le.1988) then                                    
          if(comnew(37).gt.(1200.d0*data(7))) rtexc = 0.                        
        endif                                                                   
c Retirement Income Exclusion                                                   
        if(law.ge.1989.and.data(9).gt.0) then                                   
          rhy = max(0.0d0,data(14)+data(12)+data(23)+                           
     &    data(20)+ data(72)+ comnew(8)+data(24))                               
          if(comnew(6).ge.0) then                                               
             rhy = rhy + comnew(6)/sep                                          
          else                                                                  
             rhy = rhy +.5*comnew(6)/sep                                        
          endif                                                                 
          if(data(7).lt.2.and.data(7).gt.0) then                                
            rter=min(comnew(37),4000.0d0)                                       
            rtexc=min(rtmax(law),rter+rhy)                                      
          elseif (data(7).gt.1) then                                            
            hearn = max(data(85),data(86)) + .5*max(0.0d0,data(17))             
            wearn = min(data(85),data(86)) + .5*max(0.0d0,data(17))             
            if(law.ge.2018) then                                                
              hearn = hearn+data(211)+data(214)                                 
              wearn = wearn+data(212)+data(215)                                 
            endif                                                               
            rterw = min(wearn,4000.0d0)                                         
            rterh = min(hearn,4000.0d0)                                         
            if(data(9).lt.2) then                                               
               rhyw = .5*(data(14)+data(12)+data(23)+comnew(8))                 
     &         +data(20)+data(72)                                               
               if(comnew(6).ge.0) then                                          
                  rhyw = rhyw + .5*comnew(6)/sep                                
               else                                                             
                  rhyw = rhyw +.25*comnew(6)/sep                                
               endif                                                            
               rtexc=min(rtmax(law),rterw+rhyw)+rterh                           
            else                                                                
c                   write(0,*) 'rterw rterh',rterw,rterh                        
c                   write(0,*) 'rhy',rhy                                        
               rtexc=min(rtmax(law),rterw+.5*rhy)+                              
     &         min(rtmax(law),rterh+.5*rhy)                                     
            endif                                                               
          endif                                                                 
        endif                                                                   
        agi=agi-rtexc                                                           
c       write(0,*) agi,rtexc                                                    
      endif                                                                     
c  Social Security Benefits (taxable portion)                                   
      if(law.ge.1988)agi = agi - comnew(79)                                     
c  EXEMPTIONS                                                                   
c If you are a dependent on someone's federal return,                           
c you should claim one exemption for yourself on your Georgia return.           
      if(law.le.1986) then                                                      
       exemp=data(7)*1500.d0+(data(8)+old)*xmp(law)                             
       if(law.le.1986.and.nfile.eq.3.and.data(8).gt.0)                          
     &  exemp = exemp + 800.d0                                                  
      else if(law.ge.1987.and.law.le.1993.) then                                
       exemp=xmp(law)*(data(7)+data(8))                                         
      else if(law.ge.1994.and.law.le.1997) then                                 
       exemp=data(7)*1500.d0 + data(8)*xmp(law)                                 
      else if(law.ge.1998.and.law.le.2002) then                                 
       exemp=xmp(law)*(data(7) + data(8))                                       
      else if(law.ge.2003.and.law.le.2012) then                                 
       exemp=xmp(law)*data(7) + data(8)*3000.d0                                 
      else if(law.ge.2013) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
           exemp=xmp(law)*data(7) + data(8)*3000.d0                             
        else                                                                    
           exemp=3700.d0*data(7) + data(8)*3000.d0                              
        endif                                                                   
      endif                                                                     
c Standard Deductions                                                           
      if(law.le.1982) then                                                      
        stded=twn(.15*agi,1300.d0/sep,2000.d0/sep)                              
      else if(law.ge.1983.and.law.le.1986) then                                 
        if(nfile.ne.2) then                                                     
           stded=twn(.15*agi,1500.0d0,2000.0d0)                                 
        else                                                                    
          stded=twn(.18*agi,1700.d0/sep,3000.d0/sep)                            
        endif                                                                   
      else                                                                      
        if(nfile.ne.2) then                                                     
          stded = std(law,1)                                                    
        else                                                                    
          stded = std(law,2)/sep                                                
        endif                                                                   
        stded = stded + old*stold(law)                                          
      endif                                                                     
c ITEMIZED DEDUCTIONS                                                           
      xitded=(comnew(24)-data(50))*comnew(26)                                   
c      xitded=comnew(24)*comnew(26)                                             
      if(law.le.1986) then                                                      
        schedA=data(50)+data(55)                                                
        xitded=(comnew(24)-schedA)*comnew(26)                                   
c GA uses 1982 fed medical and casualty provisions, 1983-86                     
        agix=max(agi,0.0d0)                                                     
        gins=min(.5*data(47),150.0d0)                                           
        gmed=((data(48)-(.01*agix))+data(47)-gins+data(49)-(.03*agix))+         
     &    gins                                                                  
        gxit=max((gmed-comnew(20)),0.0d0)                                       
        if(law.ge.1983)xitded=xitded+gxit                                       
      endif                                                                     
      ided = int(data(4))                                                            
      if(law.eq.1999.and.ided.eq.-2) xitded=0                                   
      deduc = max(xitded,stded)                                                 
      taxinc = max(0.0d0,agi-deduc-exemp)                                       
c      write(0,*) 'agi deduc exemp taxinc',agi,deduc,exemp,taxinc               
      if(law.le.2018) then                                                      
        if(nfile.eq.1) then                                                     
          call look(tabs,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)                
        else                                                                    
c do not use -data(2) in look for GA -- Inna Shapiro 04.19.2019                 
          taxy = taxinc*sep                                                     
          call look(tabm,taxy,6,n,stat,1.0d00,0.0d0,rt,data)                    
          statax = stat/sep                                                     
        endif                                                                   
      else                                                                      
        if(nfile.eq.1) then                                                     
          call look(tabs19,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)              
        else                                                                    
c do not use -data(2) in look for GA -- Inna Shapiro 04.19.2019                 
          taxy = taxinc*sep                                                     
          call look(tabm19,taxy,6,n,stat,1.0d00,0.0d0,rt,data)                  
          statax = stat/sep                                                     
        endif                                                                   
      endif                                                                     
c Credits                                                                       
      credit=0.                                                                 
c Child Care Credit is not allowable in 1987-2005                               
      chcr=0.                                                                   
      if(law.ge.1978.and.law.le.1986) then                                      
        chmax=twn(data(8)*2000.d0,2000.0d0,4000.0d0)                            
        chexp=min(data(64),chmax,(max(data(11)+data(17),0.0d0)))                
        chcr=chexp*.02                                                          
        if(chcr.gt.80.) then                                                    
           write(0,*)'Ga child care credit out of range.'                            
        endif                                                                   
      else if(law.ge.2006) then                                                 
        chcare = min(comnew(53),max(0.0d0,comnew(52) - data(34)))               
        chcr = perch(law)*chcare                                                
      endif                                                                     
c Low-Income Credit does not exist 1987-1991                                    
      ycred=0.                                                                  
      if(law.le.1986) then                                                      
       if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                                
         txp=1.d0                                                               
       else                                                                     
         txp=2.d0                                                               
       endif                                                                    
       ycred=max(0.0d0,min((15.*txp),(15.*txp-(comnew(2)-(3000.*txp)))))        
      else if(law.ge.1992) then                                                 
        ycred = tablki(lic,6,comnew(2),data)*(data(7)+data(8)+old)              
      endif                                                                     
c      write(0,*) 'ycred',ycred                                                 
      if(data(105).gt.0.d0) ycred = 0.d0                                        
      solar=0.                                                                  
      solar=min(data(38),1000.0d0)                                              
      if(law.le.2009) then                                                      
        statax=max(0.0d0,statax - chcr - solar) - ycred                         
      else                                                                      
        statax=max(0.0d0,statax - chcr - solar - ycred)                         
      endif                                                                     
      credit = chcr + solar + ycred                                             
c      write(0,*) 'statax',statax                                               
      return                                                                    
      end                                                                       
c                                                                               
c  HAWAII                                                                      
c  State 12                                                                    
c  Updated through 2021 (updated 02.24.2022)                                   
      subroutine hitax(data,comnew, statax,law)                                 
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension stab77(2,12),stab87(2,8),stab88(2,8), stab89(2,8)               
      dimension htab77(2,12),htab87(2,8),htab88(2,8), htab89(2,8)               
      dimension htab99(2,9),stab99(2,9)                                         
      dimension ex77(2,12),ex80(2,12),ex88(2,8)                                 
      dimension htab01(2,9),stab01(2,9)                                         
      dimension htab02(2,9),stab02(2,9)                                         
      dimension htab07(2,9),stab07(2,9)                                         
      dimension htab09(2,12),stab09(2,12)                                       
      dimension htab16(2,9),stab16(2,9)                                         
      dimension htab18(2,12),stab18(2,12)                                       
      dimension food(1977:1998),emed(2017:2021)                                 
      dimension food08(2,8),fd16(2,8),fds16(2,6)                                
      double precision lowcr                                                    
c    all are Ok,  except hh(pre 1987) -I kept the old value in                  
      dimension data(255), comnew(255), std(1977:2021,7),                       
     &   xmp(1977:2021),gencrd(1977:1995),rtab(1977:2021)                       
      data emed/4*.1d0,.075d0/                                                  
      data hiphas /166800./                                                     
c   separate tax rates for single&married and heads of households               
      data stab77/   500.0d0,  2.25d0, 1000.0d0, 3.25d0,                        
     &              1500.0d0,  4.5d0 , 2000.0d0, 5.0d0 ,                        
     &              3000.0d0,  6.5d0 , 5000.0d0, 7.5d0 ,                        
     &             10000.0d0,  8.5d0 ,14000.0d0, 9.5d0 ,                        
     &             20000.0d0, 10.0d0 ,30000.0d0,10.5d0 ,                        
     &            100000.0d0, 11.0d0 ,    1.e20,11.0d0/                         
      data stab87/  1000.0d0, 2.23d0,  2000.0d0, 4.25d0,                        
     &              3000.0d0, 6.25d0,  5000.0d0, 7.25d0,                        
     &             10000.0d0, 8.25d0, 14000.0d0, 9.25d0,                        
     &             20000.0d0, 9.75d0,     1.e20, 10.0d0/                        
      data stab88/  1200.0d0, 2.25d0,  2200.0d0, 4.25d0,                        
     &              3200.0d0, 6.25d0,  5200.0d0, 7.25d0,                        
     &             10200.0d0, 8.25d0, 14200.0d0, 9.25d0,                        
     &             20200.0d0, 9.75d0,     1.e20, 10.0d0/                        
      data stab89/  1500.0d0, 2.0d0 ,  2500.0d0, 4.0d0 ,                        
     &              3500.0d0, 6.0d0 ,  5500.0d0, 7.25d0,                        
     &             10500.0d0, 8.0d0 , 15500.0d0, 8.75d0,                        
     &             20500.0d0, 9.5d0 ,     1.e20,10.0d0/                         
      data stab99/  2000.0d0, 1.6d0 ,  4000.0d0, 3.9d0,                         
     &              8000.0d0, 6.8d0 , 12000.0d0, 7.2d0,                         
     &             16000.0d0, 7.5d0 , 20000.0d0, 7.8d0,                         
     &             30000.0d0, 8.2d0 , 40000.0d0, 8.5d0,                         
     &                 1.e20, 8.75d0/                                           
      data stab01/  2000.0d0, 1.5d0 ,  4000.0d0, 3.7d0,                         
     &              8000.0d0, 6.4d0 , 12000.0d0, 6.9d0,                         
     &             16000.0d0, 7.3d0 , 20000.0d0, 7.6d0,                         
     &             30000.0d0, 7.9d0 , 40000.0d0, 8.2d0,                         
     &                 1.e20, 8.5d0/                                            
      data stab02/  2000.0d0, 1.4d0 ,  4000.0d0, 3.2d0,                         
     &              8000.0d0, 5.5d0 , 12000.0d0, 6.4d0,                         
     &             16000.0d0, 6.8d0 , 20000.0d0, 7.2d0,                         
     &             30000.0d0, 7.6d0 , 40000.0d0, 7.9d0,                         
     &                 1.e20, 8.25d0/                                           
      data stab07/  2400.0d0, 1.4d0 ,  4800.0d0, 3.2d0,                         
     &              9600.0d0, 5.5d0 , 14400.0d0, 6.4d0,                         
     &             19200.0d0, 6.8d0 , 24000.0d0, 7.2d0,                         
     &             36000.0d0, 7.6d0 , 48000.0d0, 7.9d0,                         
     &                 1.e20, 8.25d0/                                           
      data stab09/  2400.0d0, 1.4d0 ,  4800.0d0, 3.2d0,                         
     &              9600.0d0, 5.5d0 , 14400.0d0, 6.4d0,                         
     &             19200.0d0, 6.8d0 , 24000.0d0, 7.2d0,                         
     &             36000.0d0, 7.6d0 , 48000.0d0, 7.9d0,                         
     &            150000.0d0, 8.25d0,175000.0d0, 9.0d0,                         
     &            200000.0d0,10.0d0,      1.e20,11.0d0/                         
      data stab16/  2400.0d0, 1.4d0 ,  4800.0d0, 3.2d0,                         
     &              9600.0d0, 5.5d0 , 14400.0d0, 6.4d0,                         
     &             19200.0d0, 6.8d0 , 24000.0d0, 7.2d0,                         
     &             36000.0d0, 7.6d0 , 48000.0d0, 7.9d0,                         
     &                 1.e20, 8.25d0/                                           
      data stab18/  2400.0d0, 1.4d0 ,  4800.0d0, 3.2d0,                         
     &              9600.0d0, 5.5d0 , 14400.0d0, 6.4d0,                         
     &             19200.0d0, 6.8d0 , 24000.0d0, 7.2d0,                         
     &             36000.0d0, 7.6d0 , 48000.0d0, 7.9d0,                         
     &            150000.0d0, 8.25d0,175000.0d0, 9.0d0,                         
     &            200000.0d0,10.0d0 ,     1.e20,11.0d0/                         
      data htab77/   500.0d0, 2.25d0, 1000.0d0,  2.75d0,                        
     &              1500.0d0, 3.9d0 , 2000.0d0,  4.10d0,                        
     &              3000.0d0, 5.5d0 , 5000.0d0,  6.60d0,                        
     &             10000.0d0, 7.9d0 ,20000.0d0,  9.15d0,                        
     &             30000.0d0,10.05d0,40000.0d0, 10.50d0,                        
     &             60000.0d0,10.750d0,   1.e20, 11.0d0/                         
      data htab87/  1000.0d0, 2.25d0,  2000.0d0, 3.25d0,                        
     &              3000.0d0, 5.25d0,  5000.0d0, 6.25d0,                        
     &             10000.0d0, 7.25d0, 20000.0d0, 8.90d0,                        
     &             40000.0d0, 9.80d0,     1.e20, 10.0d0/                        
      data htab88/  1200.0d0, 2.25d0,  2200.0d0, 3.25d0,                        
     &              3200.0d0, 5.25d0,  5200.0d0, 6.25d0,                        
     &             10400.0d0, 7.25d0, 20400.0d0, 8.90d0,                        
     &             40400.0d0, 9.80d0,     1.e20,10.0d0/                         
      data htab89/  1500.0d0, 2.0d0 ,  2500.0d0, 3.0d0,                         
     &              3500.0d0, 4.5d0 ,  5500.0d0, 5.9d0,                         
     &             11000.0d0, 7.25d0, 21000.0d0, 8.6d0,                         
     &             41000.0d0, 9.60d0,     1.e20,10.0d0/                         
      data htab99/  3000.0d0, 1.6d0 ,  6000.0d0, 3.9d0,                         
     &             12000.0d0, 6.8d0 , 18000.0d0, 7.2d0,                         
     &             24000.0d0, 7.5d0 , 30000.0d0, 7.8d0,                         
     &             45000.0d0, 8.2d0 , 60000.0d0, 8.5d0,                         
     &                 1.e20, 8.75d0/                                           
      data htab01/  3000.0d0,  1.5d0,  6000.0d0,  3.7d0,                        
     &             12000.0d0,  6.4d0, 18000.0d0,  6.9d0,                        
     &             24000.0d0,  7.3d0, 30000.0d0,  7.6d0,                        
     &             45000.0d0,  7.9d0, 60000.0d0,  8.2d0,                        
     &                 1.e20,  8.5d0/                                           
      data htab02/  3000.0d0,  1.4d0,  6000.0d0,  3.2d0,                        
     &             12000.0d0,  5.5d0, 18000.0d0,  6.4d0,                        
     &             24000.0d0,  6.8d0, 30000.0d0,  7.2d0,                        
     &             45000.0d0,  7.6d0, 60000.0d0,  7.9d0,                        
     &                 1.e20,  8.25d0/                                          
      data htab07/  3600.0d0,  1.4d0,  7200.0d0,  3.2d0,                        
     &             14400.0d0,  5.5d0, 21600.0d0,  6.4d0,                        
     &             28800.0d0,  6.8d0, 36000.0d0,  7.2d0,                        
     &             54000.0d0,  7.6d0, 72000.0d0,  7.9d0,                        
     &                 1.e20,  8.25d0/                                          
      data htab09/  3600.0d0,  1.4d0 ,  7200.0d0,  3.2d0,                       
     &             14400.0d0,  5.5d0 , 21600.0d0,  6.4d0,                       
     &             28800.0d0,  6.8d0 , 36000.0d0,  7.2d0,                       
     &             54000.0d0,  7.6d0 , 72000.0d0,  7.9d0,                       
     &            225000.0d0,  8.25d0,262500.0d0,  9.0d0,                       
     &            300000.0d0, 10.0d0 ,     1.e20, 11.0d0/                       
      data htab16/  3600.0d0,  1.4d0 ,  7200.0d0,  3.2d0,                       
     &             14400.0d0,  5.5d0 , 21600.0d0,  6.4d0,                       
     &             28800.0d0,  6.8d0 , 36000.0d0,  7.2d0,                       
     &             54000.0d0,  7.6d0 , 72000.0d0,  7.9d0,                       
     &                 1.e20,  8.25d0/                                          
      data htab18/  3600.0d0, 1.4d0 ,  7200.0d0, 3.2d0,                         
     &             14400.0d0, 5.5d0 , 21600.0d0, 6.4d0,                         
     &             28800.0d0, 6.8d0 , 36000.0d0, 7.2d0,                         
     &             54000.0d0, 7.6d0 , 72000.0d0, 7.9d0,                         
     &            225000.0d0, 8.25d0,262500.0d0, 9.0d0,                         
     &            300000.0d0,10.0d0 ,     1.e20,11.0d0/                         
c arrays for changing excise tax exemption amounts                              
      data ex77/    5000.0d0, 40.0d0,   6000.0d0,  32.0d0,                      
     &              7000.0d0, 28.0d0,   8000.0d0,  26.0d0,                      
     &              9000.0d0, 22.0d0,  10000.0d0,  20.0d0,                      
     &             11000.0d0, 17.0d0,  12000.0d0,  14.0d0,                      
     &             13000.0d0, 11.0d0,  14000.0d0,   8.0d0,                      
     &             20000.0d0,  6.0d0,      1.e20,   0.0d0/                      
      data ex80/    5000.0d0, 48.0d0,   6000.0d0,  39.0d0,                      
     &              7000.0d0, 34.0d0,   8000.0d0,  32.0d0,                      
     &              9000.0d0, 27.0d0,  10000.0d0,  24.0d0,                      
     &             11000.0d0, 20.0d0,  12000.0d0,  17.0d0,                      
     &             13000.0d0, 14.0d0,  14000.0d0,  10.0d0,                      
     &             20000.0d0,  8.0d0,      1.e20,   0.0d0 /                     
       data ex88/   6000.0d0, 55.0d0,   8000.0d0,  45.0d0,                      
     &             10000.0d0, 35.0d0,  12000.0d0,  25.0d0,                      
     &             15000.0d0, 20.0d0,  20000.0d0,  15.0d0,                      
     &             30000.0d0, 10.0d0,      1.e20,   0.0d0/                      
       data food08/  5000.0d0, 85.0d0,  10000.0d0, 75.0d0,                      
     &              15000.0d0, 65.0d0,  20000.0d0, 55.0d0,                      
     &              30000.0d0, 45.0d0,  40000.0d0, 35.0d0,                      
     &              50000.0d0, 25.0d0,      1.e20, 0.0d0/                       
       data fd16/   4999.0d0, 110.0d0,   9999.0d0, 100.0d0,                     
     &             14999.0d0,  85.0d0,  19999.0d0,  70.0d0,                     
     &             29999.0d0,  55.0d0,  39999.0d0,  45.0d0,                     
     &             49999.0d0,  35.0d0,      1.e20,   0.0d0/                     
       data fds16/  4999.0d0, 110.0d0,   9999.0d0, 100.0d0,                     
     &             14999.0d0,  85.0d0,  19999.0d0,  70.0d0,                     
     &             29999.0d0,  55.0d0,      1.e20,   0.0d0/                     
c Standard deduction for each marital status                                    
c each line is for each marital status and all years                            
      data std/                                                                 
     1   5*1000.0d0, 5* 800.0d0, 2*1000.0d0,18*1500.0d0, 6*2000.0d0,            
     1   9*2200.0d0,                                                            
     2  10*1000.0d0, 2*1700.0d0,18*1900.0d0, 6*4000.0d0, 9*4400.0d0,            
     3  10* 500.0d0, 2* 850.0d0,18* 950.0d0, 6*2000.0d0, 9*2200.0d0,            
     4   5*1000.0d0, 5* 800.0d0, 2*1500.0d0,18*1650.0d0, 6*2920.0d0,            
     4   9*3212.0d0,                                                            
     5  10*1000.0d0, 2*1700.0d0,18*1900.0d0, 6*4000.0d0, 9*4400.0d0,            
     6  10* 500.0d0, 2* 850.0d0,18* 950.0d0, 6*2000.0d0, 9*2200.0d0,            
     7   5*1000.0d0, 5* 800.0d0, 2*1500.0d0,18*1650.0d0, 6*2920.0d0,            
     7   9*3212.0d0/                                                            
      data xmp   /3* 750.0d0, 5*1000.0d0,28*1040.0d0,9*1144.0d0/                
      data gencrd/4*   0.0d0,    100.0d0,     25.0d0,                           
     &            6*   1.0d0,    125.0d0,     60.0d0,                           
     &            5*   1.0d0/                                                   
      data rtab/  4*   20.0d0, 41*50.0d0/                                       
      data food/ 10*    0.0d0,  3*45.0d0,5* 55.0d0,4*27.0d0/                    
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      reduce = 0.                                                               
c     AGI                                                                       
c Hawaii does not tax Social Security Benefits and                              
c some kinds of pensions taxed federally                                        
c      agi = data(11) + max(0.0d0,data(12)-data(13)) + data(14)+                
c     & data(62)+data(17)+data(21)                                              
c      agi = comnew(2) - comnew(79)-data(20)                                    
      agi = comnew(2) - comnew(79) - data(22)                                   
c 2020-2021 full unemployment compensation is taxable                           
      if(law.eq.2020.or.law.eq.2021) agi = agi+data(82)-comnew(78)              
c (02.23.2017 change) Pensions are not taxable in HI                            
      agi = agi - data(72)                                                      
c 2019+ alimony received is no longer included in the income                    
c divorced papers finalized after Jan 1,2019                                    
c      if(law.ge.2019) agi = agi - data(23)                                     
c EXEMPTIONS                                                                    
      exemp=(data(7)+data(8)+data(9))*xmp(law)                                  
      exema = exemp                                                             
c 2009-2015 personal exemption phaseout                                         
      if(law.ge.2009.and.law.le.2015) then                                      
        phex = 119963.                                                          
        if(mst.eq.1) then                                                       
          phex = phex                                                           
        else if(mst.eq.4.or.mst.eq.7) then                                      
          phex = 1.25*phex                                                      
        else                                                                    
          phex = 1.5*phex/sep                                                   
        endif                                                                   
c------------------                                                             
c for exact amount -- just in case                                              
        if(agi.gt.phex) then                                                    
         ln6 = int(1+ (agi-phex)/(2500.d0/sep))                                 
         exemp = exema - exema*.02*ln6                                          
        endif                                                                   
c-------------------                                                            
c for smooth function                                                           
c        ratio = 0.02*max(0.0d0,(agi-phex)/(2500.d0/sep))                       
c        exemp = max(exema*(1.-ratio),0.0d0)                                    
      endif                                                                     
c disability exemption is exclusive of other exemptions                         
      n10 = int(data(10))                                                            
      n9 = int(data(9))                                                              
      if(n10.gt.0.) then                                                        
        exemp=7000.*data(10)                                                    
        if(n10.eq.1.and.n9.eq.2)exemp=9080.                                     
        if(n10.eq.1.and.n9.eq.1)exemp=8040.                                     
      endif                                                                     
      if(data(105).gt.0.d0) exemp = 0.d0                                        
c DEDUCTIONS                                                                    
      stded=std(law,mst)                                                        
      if(law.eq.1980) stded=min(max(0.0d0,.1*agi),stded)                        
      if(law.le.1984.and.law.ge.1983) stded=stded                               
     & + (data(58)+data(59))*.25                                                
      if(law.eq.1985) stded=stded + (data(58)+data(59))*.5                      
      if(law.eq.1986) stded=stded + data(58)+data(59)                           
c For tax years beginning after 1986, the zero bracket amount                   
c has been replaced by the standard deduction                                   
      xitded = comnew(30)                                                       
c 2011+ you can claim State (and Local General Sales Taxes) deduction           
c if your Federal AGI is less than $100,000(single or separately;               
c or less than $150,000 (head of household);                                    
c or less than $200,000 (married filing jointly or a qualifying widow(er).)     
      if(law.ge.2011) then                                                      
        if(mst.eq.4.or.mst.eq.7) then                                           
           phfagi = 150000.                                                     
        else if(mst.eq.1.or.sep.eq.2) then                                      
           phfagi = 100000.                                                     
        else                                                                    
           phfagi = 200000.                                                     
        endif                                                                   
        sttax = data(50)                                                        
        if(law.le.2013) sttax = max(sttax,data(52))                             
        if(comnew(2).gt.phfagi) xitded = max(0.d0,xitded - sttax)               
      endif                                                                     
c 2017-8 65 y.o and older taxpayers are subject to 10% threshold                
c for the item. deduction for medical expenses                                  
c                                                                               
c 2019+ All taxpayers are subject to 10% for medical expenses                   
      if(law.ge.2017.and.comnew(20).gt.0) then                                  
         posagi = max(0.d0,comnew(2))                                           
         edical = data(47)+data(48)+data(49)                                    
         if((law.le.2018.and.data(9).gt.0).or.law.ge.2019) then                 
            xitded =                                                            
     &max(0.d0,xitded-comnew(20)+max(0.0d0,edical-emed(law)*posagi))            
         endif                                                                  
      endif                                                                     
      if(agi.gt.100000.d0/sep.and.law.ge.1991.and.law.le.2010) then             
       reduce = min(.8*xitded,.03*(agi-100000.d0/sep))                          
       if(law.ge.2006.and.law.le.2007) reduce = 2*reduce/3.                     
       if(law.ge.2008.and.law.le.2009) reduce = reduce/3.                       
       if(law.eq.2010) reduce = 0.                                              
       xitded = xitded-reduce                                                   
      endif                                                                     
c hiphas($166,800) -- limitation for the HI AGI                                 
      if(law.ge.2011.and.agi.gt.hiphas/sep) then                                
         reduce = min(.8*xitded,.03*(agi-hiphas/sep))                           
         xitded = xitded-reduce                                                 
      endif                                                                     
c phas92 -- limitation for the Federal AGI                                      
      phas92=100000*data(7)                                                     
      if(mst.eq.4.or.mst.eq.7) phas92=150000.                                   
c 2016+ xitded no longer capped if c(2) < a certain amount                      
      if(law.ge.2011.and.law.le.2015) then                                      
         if(comnew(2).gt.phas92.and.(mst.eq.4.or.mst.eq.7))                     
     &     xitded = min(37500.0d0,xitded)                                       
         if(comnew(2).gt.phas92.and.                                            
     &   (mst.eq.1.or.mst.eq.2.or.mst.eq.3.or.mst.eq.6))                        
     &   xitded = min(25000*data(7),xitded)                                     
      endif                                                                     
      if(law.le.1986.and.law.ge.1982) then                                      
           xitded=max(0.0d0,max(0.0d0,comnew(30)-std(law,mst)))                 
           stded =max(0.0d0,stded -std(law,mst))                                
      endif                                                                     
c For years before 1987 std(law,mst) is the zero bracket amount                 
      ided = int(data(4))                                                            
      if(ided.eq.-2.and.law.eq.1999) xitded=0                                   
      deduc=max(xitded,stded)                                                   
c 2020 take up to $300/sep cash contributions if you take stded                 
c 2021 take up to $600/sep cash contributions if you take stded                 
      if(stded.gt.xitded.and.law.ge.2020) then                                  
         casmax = 300.d0                                                        
         if(law.ge.2021) casmax = 600.d0                                      
         agi  = agi - min(casmax/sep,data(58))                                  
      endif                                                                     
      taxinc=max(0.0d0,agi - exemp - deduc)                                     
c      write(0,*) 'agi exemp deduc taxinc',agi,exemp,deduc,taxinc               
      if (mst.eq.4.or.mst.eq.7) then                                            
             if(law.le.1986)then                                                
              call look(htab77,taxinc,12,n,statax,1.0d00,0.0d0,rt,data)         
             else if(law.eq.1987) then                                          
              call look(htab87,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)          
             elseif(law.eq.1988) then                                           
              call look(htab88,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.1989.and.law.le.1998) then                           
              call look(htab89,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.1999.and.law.le.2000) then                           
              call look(htab99,taxinc,9,n,statax,1.0d00,0.0d0,rt,data)          
             elseif(law.eq.2001) then                                           
              call look(htab01,taxinc,9,n,statax,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.2002.and.law.le.2006) then                           
              call look(htab02,taxinc,9,n,statax,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.2007.and.law.le.2008) then                           
              call look(htab07,taxinc,9,n,statax,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.2009.and.law.le.2015) then                           
              call look(htab09,taxinc,12,n,statax,1.0d00,0.0d0,rt,data)         
             elseif(law.eq.2016.or.law.eq.2017) then                            
              call look(htab16,taxinc,9,n,statax,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.2018) then                                           
              call look(htab18,taxinc,12,n,statax,1.0d00,0.0d0,rt,data)         
             endif                                                              
      elseif(mst.ne.4.and.mst.ne.7) then                                        
             taxy = taxinc                                                      
             if(mst.eq.2)taxy=taxinc/2                                          
             if(law.le.1986)then                                                
              call look(stab77,taxy,12,n,statax,1.0d00,0.0d0,rt,data)           
             else if(law.eq.1987) then                                          
              call look(stab87,taxy,8,n,statax,1.0d00,0.0d0,rt,data)            
             else if(law.eq.1988) then                                          
              call look(stab88,taxy,8,n,statax,1.0d00,0.0d0,rt,data)            
             else if(law.ge.1989.and.law.le.1998) then                          
              call look(stab89,taxy,8,n,statax,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.1999.and.law.le.2000) then                           
              call look(stab99,taxy,9,n,statax,1.0d00,0.0d0,rt,data)            
             elseif(law.eq.2001) then                                           
              call look(stab01,taxy,9,n,statax,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.2002.and.law.le.2006) then                           
              call look(stab02,taxy,9,n,statax,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.2007.and.law.le.2008) then                           
              call look(stab07,taxy,9,n,statax,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.2009.and.law.le.2015) then                           
              call look(stab09,taxy,12,n,statax,1.0d00,0.0d0,rt,data)           
             elseif(law.eq.2016.or.law.eq.2017) then                            
              call look(stab16,taxy,9,n,statax,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.2018) then                                           
              call look(stab18,taxy,12,n,statax,1.0d00,0.0d0,rt,data)           
             endif                                                              
             if(mst.eq.2)statax=statax*2.                                       
      endif                                                                     
c      if(max(comnew(6),0.0d0)+data(176).gt.0) then                             
      if(max(comnew(6),0.0d0).gt.0) then                                        
           if (mst.eq.4.or.mst.eq.7) then                                       
              brack = 36000.                                                    
           else                                                                 
              brack = 24000. * data(7)                                          
           endif                                                                
c non-gain taxable income                                                       
c           taxyng = max(0.0d0,taxinc - max(comnew(6),0.0d0)+data(176))         
           taxyng = max(0.0d0,taxinc - max(comnew(6),0.0d0))                    
           taxyng = max(brack,taxyng)                                           
c amount of net capital gains eligible for alternative tax                      
           taxycg = max(0.0d0,taxinc - taxyng)                                  
c The Hawaii capital gains tax on real estate is 7.25%                          
           if (mst.eq.4.or.mst.eq.7) then                                       
             if(law.le.1986)then                                                
              call look(htab77,taxyng,12,n,statng,1.0d00,0.0d0,rt,data)         
             else if(law.eq.1987) then                                          
              call look(htab87,taxyng,8,n,statng,1.0d00,0.0d0,rt,data)          
             elseif(law.eq.1988) then                                           
              call look(htab88,taxyng,8,n,statng,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.1989.and.law.le.1998) then                           
              call look(htab89,taxyng,8,n,statng,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.1999.and.law.le.2000) then                           
              call look(htab99,taxyng,9,n,statng,1.0d00,0.0d0,rt,data)          
             elseif(law.eq.2001) then                                           
              call look(htab01,taxyng,9,n,statng,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.2002.and.law.le.2006) then                           
              call look(htab02,taxyng,9,n,statng,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.2007.and.law.le.2008) then                           
              call look(htab07,taxyng,9,n,statng,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.2009.and.law.le.2015) then                           
              call look(htab09,taxyng,12,n,statng,1.0d00,0.0d0,rt,data)         
             elseif(law.eq.2016.or.law.eq.2017) then                            
              call look(htab16,taxyng,9,n,statng,1.0d00,0.0d0,rt,data)          
             elseif(law.ge.2018) then                                           
              call look(htab18,taxyng,12,n,statng,1.0d00,0.0d0,rt,data)         
             endif                                                              
           elseif(mst.ne.4.and.mst.ne.7) then                                   
             taxy = taxyng                                                      
             if(mst.eq.2)taxy=taxyng/2                                          
             if(law.le.1986)then                                                
              call look(stab77,taxy,12,n,statng,1.0d00,0.0d0,rt,data)           
             else if(law.eq.1987) then                                          
              call look(stab87,taxy,8,n,statng,1.0d00,0.0d0,rt,data)            
             else if(law.eq.1988) then                                          
              call look(stab88,taxy,8,n,statng,1.0d00,0.0d0,rt,data)            
             else if(law.ge.1989.and.law.le.1998) then                          
              call look(stab89,taxy,8,n,statng,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.1999.and.law.le.2000) then                           
              call look(stab99,taxy,9,n,statng,1.0d00,0.0d0,rt,data)            
             elseif(law.eq.2001) then                                           
              call look(stab01,taxy,9,n,statng,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.2002.and.law.le.2006) then                           
              call look(stab02,taxy,9,n,statng,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.2007.and.law.le.2008) then                           
              call look(stab07,taxy,9,n,statng,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.2009.and.law.le.2015) then                           
              call look(stab09,taxy,12,n,statng,1.0d00,0.0d0,rt,data)           
             elseif(law.eq.2016.or.law.eq.2017) then                            
              call look(stab16,taxy,9,n,statng,1.0d00,0.0d0,rt,data)            
             elseif(law.ge.2018) then                                           
              call look(stab18,taxy,12,n,statng,1.0d00,0.0d0,rt,data)           
             endif                                                              
             if(mst.eq.2)statng=statng*2.                                       
           endif                                                                
           statcg = taxycg * .0725                                              
           statax = min(statax,statng + statcg)                                 
      endif                                                                     
c      write(0,*) 'taxbc',statax                                                
c   CREDITS                                                                     
c Child care credit                                                             
      if(law.le.2015) then                                                      
         child = min(data(64),2400.*min(data(8),2.0d0))                         
      else                                                                      
         child = min(data(64),2500.*min(data(8),2.0d0))                         
      endif                                                                     
      if(mst.eq.2) child = min(child,data(85),data(86))                         
      if(law.le.1989) then                                                      
        chr=.01*max(10.0d0,15.-max((agi- 21000.)/2000.,0.0d0))                  
      else if(law.ge.1990.and.law.le.2015) then                                 
        chr=.01*max(15.0d0,25.-max((agi- 22000.)/2000.,0.0d0))                  
      else if(law.ge.2016) then                                                 
        chr=.01*max(15.0d0,25.-max((agi- 25000.)/5000.,0.0d0))                  
      endif                                                                     
      chcr = chr*child                                                          
c The General Income Tax Credit is not available in 1996+                       
      gencr = 0.                                                                
      if(law.le.1995) then                                                      
c       gencr = (gencrd(law)*(data(7)+data(8))) + child                         
        gencr = gencrd(law)*(data(7)+data(8))                                   
        if(law.ge.1979) gencr = gencr + data(34)                                
        if(law.le.1979) gencr = gencr + .5*data(35)                             
        if(law.ge.1981.and.law.le.1986) gencr = gencr+(.6*data(38))             
      endif                                                                     
c The General Income Tax Credit in 2001:fixed amount of $1 per                  
c qualified exemption                                                           
      if((law.ge.2001.and.law.le.2006).or.(law.ge.2008.and.law.le.2009))        
     & gencr =  1.*(data(7)+data(8))                                            
c---------------------------------------------------------                      
c A General Income Tax Credit for 2007 based on                                 
c the taxpayer's filing status and amount of federal agi                        
      if(law.eq.2007) then                                                      
        if(mst.eq.4.or.mst.eq.7)  then                                          
c inna made linear function for the table in instructions                       
           if(comnew(2).lt.60000) gencr = 140.-70.*comnew(2)/60000.             
        else if(mst.eq.2.or.mst.eq.5) then                                      
           if(comnew(2).lt.60000) gencr = 160.-90.*comnew(2)/60000.             
        else                                                                    
           if(comnew(2).lt.30000) gencr = 65.-25.*comnew(2)/30000.              
        endif                                                                   
      endif                                                                     
c----------------------------------------------------------                     
c not able to calc energy conservation credit (1990):not in PC Tax files        
c not able to calc new employee credit(1990):not in PC Tax files                
c   credits which can be included in a refund                                   
c   actual law treats surviving spouse as joint return                          
      rcred=0.                                                                  
      xnum=data(7)+data(8)+data(9)                                              
      if((data(160).ge.1000.).and.                                              
     &   ((law.le.1988.and.agi.lt.20000).or.                                    
     &    (law.ge.1989.and.agi.lt.30000)))rcred= rtab(law)*xnum                 
c renters credit 30% of fed credit (1990)                                       
      rcred=rcred*max(data(9),1.0d0)                                            
c The Excise Credit  is repealed in 1995                                        
      exc=0.                                                                    
      if(law.le.1979)then                                                       
          exc=tablki(ex77,12,agi,data)*max(data(9),1.0d0)*data(7)               
      else if(law.ge.1980.and.law.le.1987) then                                 
          exc=tablki(ex80,12,agi,data)*max(data(9),1.0d0)*data(7)               
      elseif(law.ge.1988.and.law.le.1994) then                                  
          exc=tablki(ex88,8,agi,data)*max(data(9),1.0d0)*data(7)                
      endif                                                                     
c The Food Tax Credit is no longer available since 1999                         
      foodcr = 0.                                                               
      if(law.le.1998) foodcr=food(law)*(data(7)+data(8))                        
c Low income refundable tax credit is provided                                  
c taxpayers with AGI=< $20k  in 1999                                            
      lowcr = 0.                                                                
      if(law.ge.1999.and.law.le.2007) then                                      
         if(agi.lt.10000) lowcr = (data(7)+data(8))*35                          
         if(agi.ge.10000.and.agi.lt.15000) lowcr = (data(7)+data(8))*25         
         if(agi.ge.15000.and.agi.le.20000) lowcr = (data(7)+data(8))*10         
      endif                                                                     
      fedagi = max(0.0d0,comnew(2))                                             
      if(law.ge.2008.and.law.le.2015) then                                      
c Refundable Food/Excise Credit in 2008                                         
        exc = (data(8)+data(7))*tablki(food08,8,fedagi,data)                    
      elseif(law.ge.2016) then                                                  
c The Refundable Food/Excise Tax Credit is amended for 2016+                    
        if(mst.ne.1) then                                                       
            exc = (data(8)+data(7))*tablki(fd16,8,fedagi,data)                  
        else                                                                    
            exc = (data(8)+data(7))*tablki(fds16,6,fedagi,data)                 
        endif                                                                   
      endif                                                                     
c Nearly every full time resident of Hawaii                                     
c who files a tax return, is not a dependent,                                   
c and earns less than $50k per year                                             
c ($30k for those filing single or separately),                                 
c is eligible.                                                                  
      if(data(105).gt.0.d0) then                                                
        exc = 0.d0                                                              
        foodcr = 0.d0                                                           
      endif                                                                     
      credit = gencr+rcred+exc+foodcr+chcr+lowcr                                
c      write(0,*) 'gencr+rcred+exc+foodcr+chcr+lowcr',                          
c     & gencr,rcred,exc,foodcr,chcr,lowcr                                       
      statax = statax-credit                                                    
c 2018-2022 a new nonrefundable EITC equal to 20% of fed EITC                   
      earncr = 0.d0                                                             
      if(law.ge.2018.and.law.le.2022) then                                      
        earncr =  .2d0*comnew(59)                                               
        earncr = min(earncr,max(0.d0,statax))                                   
      endif                                                                     
c      write(0,*) 'earncr statax',earncr,statax                                 
      credit = credit + earncr                                                  
      statax = statax - earncr                                                  
c1     format(1x,10f8.0)                                                        
      return                                                                    
      end                                                                       
c                                                                               
c  IDAHO                                                                        
c  State 13                                                                     
c  Updated through 2021                                                         
      subroutine idtax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255),xmp(1977:2012),gr(2008:2021)              
      dimension tab77(2,6),tab87(2,8),tab00(2,8),tab01(2,8),tab12(2,7),         
     & aif01(2001:2021),tab18(2,7),tab21(2,5),                                  
     & ageded(1993:2021,2), dedj(1993:2021),deds(1993:2021),                    
     & dedh(1993:2021),dedw(1999:2021)                                          
      double precision itc,lim                                                  
      integer sep                                                               
      dimension aif92(1992:2012),aif13(2013:2017),dstded(1987:2021)             
      data dstded   /4*500.d0,550.d0,3*600.d0,3*650.d0,3*700.d0,                
     &  3*750.d0,2*800.d0,3*850.d0,900.d0,3*950.d0,2*1000.d0,4*1050.d0,         
     &  3*1100.d0/                                                              
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
c enter taxinc > $1000 value                                                    
      data gr/30.d0,40.d0,50.d0,60.d0,70.d0,80.d0,90.d0,7*100.d0/               
      data aif01/                                                               
     &           2*1.0d0, 2*1.086d0  ,   1.104d0,1.159d0,2*1.198d0,             
     &           1.272d0,   1.32288d0,   1.338d0,1.38d0 ,  1.409d0,             
     &           1.429d0,   1.452d0  ,   1.454d0,1.472d0,  1.504d0,             
     &           1.541d0,   1.567d0  ,   1.588d0/                               
      data aif92/                                                               
     &         1.0525d0, 1.0845d0, 1.118d0,  1.147d0 , 1.1795d0,                
     &         1.2120d0, 1.2450d0, 1.266d0,  1.2895d0, 1.3295d0,                
     &         1.3730d0, 1.3950d0, 1.427d0,  1.4595d0, 1.505d0 ,                
     &         1.5640d0, 1.5995d0, 1.668d0,2*1.6955d0, 1.7365d0/                
      data ageded/                                                              
     s       900.0d0, 2*950.0d0, 2*1000.0d0, 2*1050.0d0, 2*1100.0d0,            
     s    2*1150.0d0,  1200.0d0, 2*1250.0d0,   1300.0d0,   1350.0d0,            
     s    2*1400.0d0,2*1450.0d0,   1500.0d0, 4*1550.0d0,   1600.0d0,            
     s    2*1650.0d0,  1700.0d0,                                                
     j       700.0d0, 2*750.0d0,  2*800.0d0,  3*850.0d0,  2*900.0d0,            
     j     2*950.0d0,2*1000.0d0, 2*1050.0d0, 2*1100.0d0, 2*1150.0d0,            
     j     2*1200.d0,3*1250.0d0, 3*1300.0d0,   1350.0d0/                        
c standard deductions                                                           
      data dedj/                                                                
     &       6200.0d0,   6350.0d0,  6550.0d0,  6700.0d0,  6900.0d0,             
     &       7100.0d0,   7350.0d0,  8800.0d0,  9100.0d0,  9400.0d0,             
     &       9500.0d0,   9700.0d0, 10000.0d0, 10300.0d0, 10700.0d0,             
     &      10900.0d0,2*11400.0d0, 11600.0d0, 11900.0d0, 12200.0d0,             
     &      12400.0d0,2*12600.0d0, 12700.0d0, 24000.0d0, 24400.0d0,             
     &      24800.0d0,  25100.0d0/                                              
      data deds/                                                                
     &       3700.0d0,  3800.0d0,  3900.0d0,  4000.0d0,  4150.0d0,              
     &       4250.0d0,  4300.0d0,  4400.0d0,  4550.0d0,  4700.0d0,              
     &       4750.0d0,  4850.0d0,  5000.0d0,  5150.0d0,  5350.0d0,              
     &       5450.0d0,2*5700.0d0,  5800.0d0,  5950.0d0,  6100.0d0,              
     &       6200.0d0,2*6300.0d0,  6350.0d0, 12000.0d0, 12200.0d0,              
     &      12400.0d0, 12500.0d0/                                               
      data dedh/                                                                
     &       5450.0d0,  5600.0d0,  5750.0d0,  5900.0d0,  6050.0d0,              
     &       6250.0d0,  6350.0d0,  6450.0d0,  6650.0d0,  6900.0d0,              
     &       7000.0d0,  7150.0d0,  7300.0d0,  7550.0d0,  7850.0d0,              
     &       8000.0d0,  8350.0d0,  8400.0d0,  8500.0d0,  8700.0d0,              
     &       8950.0d0,  9100.0d0,  9250.0d0,  9300.0d0,  9350.0d0,              
     &      18000.0d0, 18350.0d0, 18650.0d0,  18800.0d0/                        
      data dedw/                                                                
     &       7200.0d0,  7350.0d0,  7600.0d0,  7850.0d0,  9500.0d0,              
     &       9700.0d0, 10000.0d0, 10300.0d0, 10700.0d0, 10900.0d0,              
     &    2*11400.0d0, 11600.0d0, 11900.0d0, 12200.0d0, 12400.0d0,              
     &    2*12600.0d0, 12700.0d0, 24000.0d0, 24400.0d0, 24800.0d0,              
     &      25500.0d0/                                                          
c  XYZ rate tables                                                              
      data tab77 /                                                              
     &       1000.0d0, 2.0d0, 2000.0d0, 4.0d0, 3000.0d0, 4.5d0,                 
     &       4000.0d0, 5.5d0, 5000.0d0, 6.5d0,    1.e20, 7.5d0 /                
      data tab87 /                                                              
     &       1000.0d0, 2.0d0, 2000.0d0, 4.0d0, 3000.0d0, 4.5d0,                 
     &       4000.0d0, 5.5d0, 5000.0d0, 6.5d0, 7500.0d0, 7.5d0,                 
     &      20000.0d0, 7.8d0,    1.e20, 8.2d0/                                  
      data tab00 /                                                              
     &       1000.0d0, 1.9d0, 2000.0d0, 3.9d0, 3000.0d0, 4.4d0,                 
     &       4000.0d0, 5.4d0, 5000.0d0, 6.4d0, 7500.0d0, 7.4d0,                 
     &      20000.0d0, 7.7d0,    1.e20, 8.1d0/                                  
      data tab01 /                                                              
     &       1000.0d0,  1.6d0, 2000.0d0, 3.6d0, 3000.0d0, 4.1d0,                
     &       4000.0d0,  5.1d0, 5000.0d0, 6.1d0, 7500.0d0, 7.1d0,                
     &      20000.0d0,  7.4d0,    1.e20, 7.8d0/                                 
      data tab12 /                                                              
     &       1000.0d0,  1.6d0, 2000.0d0, 3.6d0, 3000.0d0, 4.1d0,                
     &       4000.0d0,  5.1d0, 5000.0d0, 6.1d0, 7500.0d0, 7.1d0,                
     &          1.e20,  7.4d0/                                                  
      data tab18 /                                                              
     &       1000.0d0,  1.125d0, 2000.0d0, 3.125d0, 3000.0d0, 3.625d0,          
     &       4000.0d0,  4.625d0, 5000.0d0, 5.625d0, 7500.0d0, 6.625d0,          
     &          1.e20,  6.925d0/                                                
      data tab21 /                                                              
     &       1000.0d0, 1.d0, 3000.0d0, 3.1d0, 4000.0d0,  4.5d0,                 
     &       5000.0d0, 5.5d0,  1.e20,  6.5d0/                                   
                                                                                
      data xmp/                                                                 
     &        3* 750.0d0, 5*1000.0d0, 1040.0d0, 1080.0d0, 2*1900.0d0,           
     &          2000.0d0,   2050.0d0, 2150.0d0, 2300.0d0,   2350.0d0,           
     &          2450.0d0,   2500.0d0, 2550.0d0, 2650.0d0,   2700.0d0,           
     &          2750.0d0,   2800.0d0, 2900.0d0, 3000.0d0,   3050.0d0,           
     &          3100.0d0,   3200.0d0, 3300.0d0, 3400.0d0,   3500.0d0,           
     &        2*3650.0d0,   3700.0d0, 3800.0d0/                                 
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rt=0.                                                                     
      nblage = int(data(9)+data(10))                                                   
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)phas92=100000.*aif92(law)/sep              
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c     AGI                                                                       
c Basically federal agi definition                                              
      agi=comnew(2)                                                             
      if(law.ge.1978) then                                                      
c state tax refunds,alt energy costs                                            
        agi = agi-data(22)-data(38)                                             
c Child and dependent care expenses                                             
        if(law.le.2002)                                                         
     &agi = agi - min(data(64),comnew(37),2400.*min(2.0d0,data(8)))             
        if(law.ge.2003)                                                         
     &agi = agi - min(data(64),comnew(37),3000.*min(2.0d0,data(8)))             
c Wages from jobs credit                                                        
        if(law.ge.1979.and.law.le.1986) agi=agi-xjobs(data,law)                 
        if(law.ge.1984)agi=agi-comnew(79)                                       
      endif                                                                     
c 2020 unemployment compensation taxes in full                                  
      if(law.eq.2020) agi = agi+data(82)-comnew(78)                             
c Deductions                                                                    
c State Tax Declaration Phaseout                                                
      xitded=max(0.d0,comnew(30)-data(50))                                      
      if(law.ge.1991.and.law.le.2017) then                                      
         if(agi.gt.phas92.and.comnew(30).gt.0)                                  
     &   xitded= max(0.d0,comnew(24)-data(50)*comnew(24)/comnew(30))            
      endif                                                                     
c Standard deduction equals fed standard deduction most years                   
      if(law.eq.1977) then                                                      
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
          stded=twn(.16*agi,1700.0d0,2400.0d0)                                  
        else                                                                    
          stded=twn(.16*agi,2100.0d0,2800.0d0)                                  
        endif                                                                   
      else if(law.ge.1978.and.law.le.1992) then                                 
        stded=comnew(3)                                                         
        if(law.ge.1982.and.law.le.1986)stded=stded+comnew(23)                   
        if(sep.eq.2) then                                                       
          if(law.ge.1988.and.law.le.1989) then                                  
             stded= stded-150.*nblage                                           
          elseif(law.eq.1990) then                                              
             stded= stded-150.*nblage+25.                                       
          elseif(law.ge.1991.and.law.le.1992) then                              
             stded= stded-200.*nblage                                           
          endif                                                                 
        endif                                                                   
      else if(law.ge.1993.and.law.le.1998) then                                 
        if(mst.eq.1) then                                                       
           stded=deds(law)                                                      
        else if(mst.eq.4.or.mst.eq.7) then                                      
           stded=dedh(law)                                                      
        else                                                                    
           stded=dedj(law)/sep                                                  
        endif                                                                   
      else if(law.ge.1999) then                                                 
        if(mst.eq.1) then                                                       
           stded=deds(law)                                                      
        else if(mst.eq.4.or.mst.eq.7) then                                      
           stded=dedh(law)                                                      
        else if(mst.eq.2) then                                                  
           stded=dedj(law)                                                      
        else                                                                    
           stded=dedw(law)/sep                                                  
        endif                                                                   
        if(law.ge.2008.and.law.le.2009) stded =                                 
     &  stded + min(500.*data(7),data(51))                                      
      endif                                                                     
c nblage- number of age and blind exemptions                                    
      if(nblage.ge.1.and.law.eq.1987) then                                      
           if(mst.eq.1) then                                                    
              stded=3750.+750.*(nblage-1)                                       
           else if(mst.eq.2.or.mst.eq.5) then                                   
              stded=5600.+600.*(nblage-1)                                       
           else if(mst.eq.3.or.mst.eq.6) then                                   
              stded=3100.+600.*(nblage-1)                                       
           else                                                                 
              stded=5100.+800.*(nblage-1)                                       
           endif                                                                
      elseif(nblage.ge.1.and.law.ge.1993) then                                  
           if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                            
              nmst=1                                                            
           else                                                                 
              nmst=2                                                            
           endif                                                                
           stded=stded+ageded(law,nmst)*nblage                                  
      endif                                                                     
      if(data(105).gt.0.and.law.ge.1987) then                                   
         stded = min(stded,max(dstded(law),comnew(37)+350.))                    
      endif                                                                     
      deduc=max(xitded,stded)                                                   
c Your Idaho exemption amount should be the same as your                        
c federal exemption amount                                                      
      exemp = comnew(83)                                                        
c Taxable income                                                                
      taxinc=max(0.0d0,agi-deduc-exemp)                                         
c 2018+ Qualified business income deduction                                     
      if(law.ge.2018) taxinc = max(0.0d0,taxinc-comnew(181))                    
c Tax before credits calculation                                                
c Married filing jointly and Head of households have the same tax rate schedule 
      txp = 1                                                                   
      if(mst.eq.4.or.mst.eq.7.or.mst.eq.2.or.mst.eq.5) txp = 2                  
      tinc = taxinc/txp                                                         
      if(law.le.1986) then                                                      
        call look(tab77,tinc,6,n,stat,1.0d00,0.0d0,rt,data)                     
      else if(law.ge.1987.and.law.le.1999) then                                 
        call look(tab87,tinc,8,n,stat,1.0d00,0.0d0,rt,data)                     
      else if(law.eq.2000) then                                                 
        call look(tab00,tinc,8,n,stat,1.0d00,0.0d0,rt,data)                     
      else if(law.ge.2001.and.law.le.2011) then                                 
         call look(tab01,tinc,8,n,stat,aif01(law),0.0d0,rt,data)                
      else if(law.ge.2012.and.law.le.2017) then                                 
         call look(tab12,tinc,7,n,stat,aif01(law),0.0d0,rt,data)                
      else if(law.ge.2018.and.law.le.2020) then                                 
c all tax rates decreased by 0.475%                                             
         call look(tab18,tinc,7,n,stat,aif01(law),0.0d0,rt,data)                
      else if(law.ge.2021) then                                                 
         call look(tab21,tinc,5,n,stat,aif01(law),0.0d0,rt,data)                
      endif                                                                     
      statax = stat * txp                                                       
c New voluntary donation to the American Red Cross                              
c      if(law.ge.2006) statax = statax + 10*data(7)                             
c  Credits                                                                      
c nonref Child Tax Credit 2018+                                                 
      ctcred = 0.d0                                                             
      if(law.ge.2018) then                                                      
         ctcred = 205.d0*data(208)                                              
      endif                                                                     
      ctcred = min(ctcred,statax)                                               
c  Grocery credit                                                               
      grcred = 0.d0                                                             
      if(law.eq.1977) then                                                      
         grcred = (data(7)+data(8))*15 + data(9)*5                              
      else if(law.gt.1977.and.law.le.2000) then                                 
         grcred=(data(7)+data(8)+data(9))*15                                    
      else if(law.gt.2000.and.law.le.2007) then                                 
         grcred=(data(7)+data(8))*20+data(9)*15                                 
      else if(law.gt.2007) then                                                 
         grcred = (data(7)+data(8))*gr(law)                                     
         if(taxinc.le.1000.and.law.le.2014) then                                
           if(law.le.2013)grcred = grcred + (data(7)+data(8))*20                
           if(law.eq.2014)grcred = grcred + (data(7)+data(8))*10                
         endif                                                                  
         grcred = grcred + data(9)*20                                           
c 2012-2016(?) young separate returns are not eligible                          
         if(law.ge.2012.and.law.le.2016) then                                   
           if(sep.eq.2.and.data(9).lt.1.d0) grcred = 0.d0                       
         endif                                                                  
      endif                                                                     
c no grocery credit for dependent returns                                       
      if(data(105).gt.0.d0) grcred = 0.d0                                       
c Investment credit                                                             
      itc=min(data(33),.5*statax)                                               
      polc=0.                                                                   
      if(law.ge.1979)polc=min(.5*data(65),5.*data(7))                           
c  Permanent builing fund tax                                                   
      lim=0.                                                                    
      if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                                 
        lim=2300.+xif(law.ge.1981,1000.0d0)+(data(9)*1000.)                     
      else if(mst.eq.2.or.mst.eq.5) then                                        
        lim=3400.+xif(law.ge.1981,2000.0d0)+(data(9)*1000.)                     
      else if(mst.eq.3.or.mst.eq.6) then                                        
        lim=750.+xif(law.ge.1981,250.0d0)                                       
      endif                                                                     
      if(law.ge.1978) then                                                      
        if(hy.gt.lim.and.data(10).le.0.0d0)statax = statax + 10.                
      endif                                                                     
      credit = itc+polc+grcred+ctcred                                           
      statax = statax-credit                                                    
      return                                                                    
      end                                                                       
c                                                                               
c  ILLINOIS                                                                    
c  State 14                                                                    
c                                                                               
c   Updated through 2021 (updated 03.02.2022)                                   
      subroutine iltax(data,comnew, statax,law)                                 
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      dimension rate(1977:2021),xmp(1977:2021),eirt(2000:2021)                  
      data eirt/12*0.05d0,0.075d0,4*0.1d0,0.14d0,4*0.18d0/                      
      data rate/6*.0250d0,.030d0,.02750d0,4*.0250d0,.02750d0,                   
     & 21*.030d0,4*.050d0,2*.0375d0,.043549d0,4*.0495d0/                        
      data xmp/21*1000.0d0,1300.0d0,1650.0d0,12*2000.0d0,2050.d0,               
     & 2100.d0,2125.d0,2150.d0,2*2175.d0,2225.d0,2275.d0,2325.d0,               
     & 2375.d0/                                                                 
      rt=rate(law)                                                              
c AGI                                                                           
c Illinois agi does not include federal div or cap gns exclusions               
      agi=comnew(2)+divexc(data,comnew,law)+comnew(7)                           
c Illinois does not tax retirement plans                                        
      penson=data(20)+data(72)                                                  
c     if(law.ge.1982)agi=agi-penson                                             
      agi=agi-penson                                                            
      if(law.ge.1986)agi=agi-data(22)                                           
c Social Security benefits are not taxable in Illinois                          
      agi = agi - comnew(79)                                                    
c Exemptions                                                                    
      if(law.le.1989) then                                                      
        exemp=comnew(68)*xmp(law)                                               
      else if(law.ge.1990) then                                                 
        exemp = xmp(law)*comnew(68)+1000.*(data(9)+data(10))                    
      endif                                                                     
      if(data(105).gt.0.d0) then                                                
c If d105>0 and your Illinois agi=<$2175, your exemption allowance is $2175.    
c If income is greater than $2175, your exemption allowance is 0.               
         if(agi.le.xmp(law)) then                                               
            exemp = xmp(law)                                                    
         else                                                                   
            exemp = 0.d0                                                        
         endif                                                                  
      endif                                                                     
      ptax=0.                                                                   
      if(law.ge.1983.and.law.le.1990) then                                      
         ptax=data(51)                                                          
c note: for tax years 1989 and 1990 you can take twice the property tax         
c subtraction to which you would normally be entitled.                          
         if(law.ge.1989) ptax=ptax*2                                            
      endif                                                                     
      taxinc=max(0.0d0,agi-exemp-ptax)                                          
      statax=taxinc*rate(law)                                                   
c Since 1991 Tax credit for Illinois property tax paid                          
      pcred=0.                                                                  
      if(law.ge.1991) then                                                      
         pcred=min(statax,.05*data(51))                                         
c  2017+ comnew(2) should be le $250000.*data(7)                                
         if(law.ge.2017.and.comnew(2).gt.250000.*data(7)) pcred = 0.            
      endif                                                                     
      statax=statax-pcred                                                       
      gcred=data(34)                                                            
      statax=max(0.0d0,statax-gcred)                                            
c Since 2000 Education Expense Credit - non-refundable                          
      edcred = 0.                                                               
      if(law.ge.2000) then                                                      
        edcred = .25*max(0.0d0,data(143)+data(144) - 250.)                      
        if(law.le.2016) edcred = min(500.0d0,edcred)                            
        if(law.ge.2017.and.comnew(2).le.250000.*data(7)) then                   
          edcred = min(750.0d0,edcred)                                          
        endif                                                                   
      endif                                                                     
      statax = max(0.0d0,statax-edcred)                                         
c grant for elderly's property taxes allowed?                                   
c Taxpayers who claimed EITC in federal return may claim 5% since 2000          
      earncr = 0                                                                
      if(law.ge.2000.and.law.le.2002)                                           
     & earncr = max(0.0d0,min(eirt(law)*comnew(59),statax-pcred))               
      if(law.ge.2003) earncr = eirt(law)*comnew(59)                             
      statax = statax - earncr                                                  
      credit = pcred + gcred + earncr + edcred                                  
      return                                                                    
      end                                                                       
c                                                                               
c  INDIANA                                                                      
c  State 15                                                                     
c                                                                               
c  Updated through 202(updated 03.02.2022)                                     
      subroutine intax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
c      real modagi                                                              
      integer sep                                                               
      double precision modagi                                                   
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255),eld1(2,4), eld2(2,4)                      
      dimension ptab(2,8),rate(1977:2021)                                       
      dimension  crmax(2011:2021,0:2), ymax(2011:2021,0:2)                      
      dimension rtbase(2011:2021,0:2), rtless(2011:2021,0:2)                    
c EITC parameters 2011+                                                         
      data crmax/                                                               
     &  42.0d0,  43.0d0,  44.0d0,2*45.0d0,2*46.0d0,47.d0,2*48.d0,49.d0,         
     1   279.0d0, 285.0d0, 293.0d0,297.0d0,302.d0,304.d0,306.d0,311.d0,         
     1   317.0d0, 323.0d0,326.d0,                                               
     2   460.0d0, 471.0d0, 483.0d0,491.0d0,499.d0,501.d0,505.d0,514.d0,         
     2   525.0d0, 533.0d0,538.d0/                                               
      data ymax/                                                                
     &  7600.0d0, 7800.0d0, 8000.0d0, 8200.0d0,3* 8400.d0,8500.d0,              
     &  8650.0d0, 8900.0d0,8950.d0,                                             
     1 16750.0d0,17150.0d0,17550.0d0,17900.0d0,2*18200.d0,18350.d0,             
     1 18750.0d0,19100.0d0,19350.0d0,19550.d0,                                  
     2 16750.0d0,17150.0d0,17600.0d0,17950.0d0,2*18200.d0,18400.d0,             
     2 18700.0d0,19050.0d0,19350.0d0,19550.d0/                                  
        data rtbase/                                                            
     & 11*.0066660d0,                                                           
     1 11*.03042850d0,                                                          
     2 11*.03585710d0/                                                          
      data rtless/                                                              
     & 11*.006880d0,                                                            
     1 11*.01440d0,                                                             
     2 11*.0190d0/                                                              
c                                                                               
      data eld1/ 1000.0d0, 65.0d0,3000.0d0, 35.0d0,10000.0d0,                   
     & 25.0d0,1.e20,0.0d0/                                                      
      data eld2/ 1000.0d0,100.0d0,3000.0d0, 50.0d0,10000.0d0,                   
     & 40.0d0,1.e20,0.0d0/                                                      
      data ptab/ 500.0d0, .750d0, 1000.0d0, .70d0, 1500.0d0, .50d0,             
     & 2000.0d0, .40d0, 2500.0d0,.30d0, 3000.0d0, .250d0, 4000.0d0,             
     &.20d0, 5000.0d0, .10d0 /                                                  
      data rate/3*.02d0,3*.019d0,4*.03d0,.032d0,27*.034d0,2*.033d0,             
     & 5*.0323d0/                                                               
      rt = rate(law)                                                            
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
c AGI                                                                           
      agi = max(0.0d0,comnew(2)-data(22))                                       
c Social Security Benefits are not taxable in Indiana                           
      agi = agi - comnew(79)                                                    
c 2020 unemployment compensation                                                
      if(law.eq.2020) agi = agi + data(82) - comnew(78)                         
c 2020 fed. stded+ cash $300 contribution                                       
      if(law.eq.2020.and.comnew(26).lt.1.d0)                                    
     & agi = agi + min(300.d0,data(58))                                         
      if(law.eq.1981) agi=agi+divexc(data,comnew,law)-min(data(12),100.*        
     & data(7))                                                                 
c 2009 you must add back the unemployment compensation                          
c not included on your federal tax return                                       
      if(law.eq.2009.and.data(82).gt.0.0d0)                                     
     & agi = agi + min(data(82),data(7)*2400.0d0)                               
c Nontaxable portion of unemployment compensation                               
      if(data(82).gt.0.0d0) then                                                
         untax = 12000.                                                         
         if(mst.eq.2) untax = 18000.                                            
         if(law.le.2008) then                                                   
           xlin6 = min(comnew(78),.5*max(0.0d0,comnew(2)-untax))                
           unded = comnew(78) - xlin6                                           
         else                                                                   
           xlin7 = .5*max(0.0d0,comnew(2)+data(82)-comnew(78)-untax)            
           unded = max(0.0d0,data(82) - xlin7)                                  
         endif                                                                  
         agi = agi - unded                                                      
      endif                                                                     
c Rent deduction                                                                
      dedr = 0.                                                                 
      if(law.ge.1979.and.law.le.1998) then                                      
         dedr = min(data(160),1500.0d0)                                         
      else if(law.ge.1999.and.law.le.2002) then                                 
         dedr = min(data(160),2000.0d0)                                         
      else if(law.ge.2003.and.law.le.2007) then                                 
         dedr = min(data(160),2500.0d0)                                         
      else if(law.ge.2008) then                                                 
         dedr = min(data(160),3000.0d0)                                         
      endif                                                                     
      if(sep.eq.2) dedr = dedr/sep                                              
c New in 1999 Homeowners Residential Property Tax Deduction                    
      dedown = 0.                                                               
      if(law.ge.1999) dedown = min(data(51),2500.0d0)                           
      if(sep.eq.2) dedown = dedown/sep                                          
c New 1997-1998 , an earned income tax deduction if agi<$12,000.                
      dedei = 0.                                                                
      if((law.eq.1997.or.law.eq.1998).and.data(8).gt.0.and.                     
     &    agi.lt.12000.and.                                                     
     &    .8*max(0.0d0,agi).lt.data(11)+data(17))                               
     &           dedei = 12000. - max(0.0d0,agi)                                
c Deductions                                                                    
      deduc = dedr + dedei+dedown                                               
c Exemptions                                                                    
      exemp=0.                                                                  
c Additional exemptions for elderly are correct                                 
      if(law.le.1979) then                                                      
        exemp=(data(7)+data(9))*1000.+(data(8)+data(10))*500.                   
      else if(law.ge.1980.and.law.le.1984) then                                 
        exemp=(comnew(68)+data(9))*500.                                         
        if(mst.eq.2) then                                                       
          xtra1=twn((agi/3)-500.d0,0.0d0,500.0d0)                               
          xtra2=twn(((agi*2)/3)-500.d0,0.0d0,500.0d0)                           
          xtra=xtra1+xtra2                                                      
        else if(mst.ne.2) then                                                  
          xtra=twn(agi-500.d0,0.0d0,500.0d0)                                    
        endif                                                                   
        exemp=exemp+xtra                                                        
      else if(law.eq.1985.or.law.eq.1986) then                                  
        exemp=comnew(68)*1000.d0                                                
      else if(law.ge.1987) then                                                 
        exemp=(data(105)+comnew(68)+data(9)+data(10))*1000.d0                   
c Beginning in 1997 , an additional exemption of $500 is allowed for            
c For 1999,an additional exemption of $500 for elder with fedagi < $40k         
        if(law.ge.1999) exemp = exemp+                                          
     &      xif(comnew(2).lt.40000.,500.0d0)*data(9)                            
      endif                                                                     
c 1997-1998 additional exemption for Dependent child $500 and $1500 in 1999     
      if(law.eq.1997.or.law.eq.1998) then                                       
         exemp = exemp + 500.*data(8)                                           
      elseif(law.ge.1999) then                                                  
         exemp = exemp + 1500.*data(8)                                          
      endif                                                                     
c Calculation of Tax                                                            
      taxinc=max(0.0d0,agi-deduc-exemp)                                         
c      write(0,*) 'agi deduc exemp taxinc',agi,deduc,exemp,taxinc               
      statax=taxinc*rate(law)                                                   
      if(law.eq.1979)statax=statax*.85                                          
c Credits                                                                       
c Credit before 1981                                                            
      ptax=data(51)+.2*data(160)                                                
      pcred=0.                                                                  
      if(law.le.1980.and.data(9).gt.0)pcred=twn(tablki(ptab,8,                  
     &               data(159),data)*ptax,0.0d0,500.0d0)                        
c Elderly credits for all years                                                 
      ecred=0.                                                                  
      if(data(9).gt.0.and.comnew(2).lt.10000) then                              
        if(law.le.1980)ecred=xif(data(159).lt.15000.,25.0d0)                    
        if(law.le.1979)ecred=ecred+2./15.*comnew(54)                            
        if(law.eq.1980)ecred=ecred+19./150.*comnew(54)                          
        if(law.ge.1981.and.law.le.1984) then                                    
          ecred=tablki(eld1,4,comnew(2),data)                                   
          if(data(9).gt.1..and.mst.eq.2) ecred=ecred+25.                        
        endif                                                                   
        if(law.ge.1985) then                                                    
          ecred=tablki(eld2,4,comnew(2),data)                                   
          if(data(9).gt.1.and.mst.eq.2)ecred=ecred + 40.                        
        endif                                                                   
      endif                                                                     
c 60    continue                                                                
c Since 1999, Earned Income Credit: Schedule IN-EIC.                            
      earncr = 0.                                                               
      if(law.ge.1999.and.law.le.2002                                            
     &   . and.data(8).gt.0.and.(comnew(37).ge..8*comnew(65)                    
     &   .or.comnew(65).lt.1.d0)                                                
     &   .and.comnew(65).lt.12000)                                              
     &       earncr = .034*(12000.-max(0.0d0,comnew(65)))                       
c 2003 - Indiana's earned income has changed.                                   
      if(law.ge.2003.and.law.le.2008.and.comnew(59).ge.9.0d0)                   
     & earncr =  .06*comnew(59)                                                 
c 2009 - Indiana's earned income has changed.                                   
      if(law.ge.2009.and.comnew(59).ge.6.0d0) then                              
         if(law.eq.2009.or.law.eq.2010) then                                    
           d8 = data(8)                                                         
           if(d8.gt.2) then                                                     
             data(8) = 2                                                        
             call nlaw(data,law)                                                
             data(8) = d8                                                       
           endif                                                                
         endif                                                                  
         earncr =  .09*comnew(59)                                               
c Earned income credit change 2011                                              
         if(law.ge.2011) then                                                   
            ieic = int(min(2.0d0,data(8)))                                           
            crm = crmax(law,ieic)                                               
            ym = ymax(law,ieic)                                                 
            rtbs = rtbase(law,ieic)                                             
            rtlw = rtless(law,ieic)                                             
            earny = comnew(37)                                                  
c           modagi = max(0.0d0,agi)                                             
            modagi = max(0.d0,comnew(2) + abs(min(0.d0,comnew(6))))             
            eic11 = min(rtbs*earny,crm)                                         
            if (modagi.gt.ym.or.earny.gt.ym) then                               
              eicpo =  rtlw*max(0.0d0,max(modagi,earny)- ym)                    
              eic11= min(eic11,max(0.0d0,crm - eicpo))                          
            endif                                                               
            earncr=min(earncr,eic11)                                            
         endif                                                                  
      endif                                                                     
      credit = pcred + ecred + earncr                                           
c  negative tax is refunded; 2/13/91 new accounting for refundable crdt         
      statax = statax - credit                                                  
c 2012 year only -- Automatic Taxpayer Refund Credit                            
      if(law.eq.2012.and.statax.gt.0) then                                      
         credit = credit + 111*data(7)                                          
         statax = statax - 111*data(7)                                          
      endif                                                                     
      if(law.ge.1980.and.law.le.1994)                                           
     & statax = statax-min(data(38),max(statax,0.0d0))                          
c The Solar and Wind Energy Carry-Over Credit has been repealed since 1995.     
c Therefore, no additional carryover credits are allowed.                       
      return                                                                    
      end                                                                       
c                                                                               
c  IOWA                                                                         
c  State 16                                                                     
c                                                                               
c  Updated through 2021 (updated 03/01/2022)                                    
c                                                                               
      subroutine iatax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension tab(2,13),tab87(2,9),tab98(2,9),tab19(2,9),                     
     &chcr90(2,8),chcr93(2,6),chcr06(2,7),eicr(1977:2021,2)                     
      dimension aif(1977:2021),xmp(1977:2021)                                   
      dimension alt1(7),alt2(7),rat(1985:2021)                                  
      dimension data(255),comnew(255),stnd(1977:2021,3)                         
     &,exy(1977:2021,2),ssbp(2007:2013),pen(1995:2021)                          
      dimension aif92(1992:2012),aif13(2013:2021),exyr(1998:2021)               
      integer sep                                                               
      data exyr/21*.0898,3*.0853/                                               
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0,1.067d0,               
     & 3*1.0d0 /                                                                
      data aif92/                                                               
     &       1.0525d0, 1.0845d0, 1.118d0,  1.147d0 , 1.1795d0,                  
     &       1.212d0 , 1.2450d0, 1.266d0,  1.2895d0, 1.3295d0,                  
     &       1.373d0 , 1.3950d0, 1.427d0,  1.4595d0, 1.5050d0,                  
     &       1.564d0 , 1.5995d0, 1.668d0,2*1.6955d0, 1.7365d0/                  
      data ssbp /   2*.68d0,  .57d0,   .55d0, .67d0, .77d0, .89d0/              
      data pen /    3*3000.0d0,3*5000.0d0,21*6000.0d0/                          
      data alt1 /   26000.0d0,  35000.0d0,  17500.0d0,2*26000.0d0,              
     &              17500.0d0,  26000.0d0 /                                     
      data alt2 /  112500.0d0, 150000.0d0,  75000.0d0,2*112500.0d0,             
     &              75000.0d0, 112500.0d0 /                                     
      data rat / 0.09d0,12*0.075d0, 0.068d0, 23*.067d0 /                        
      data eicr /13*1.e20, 20264.0d0 , 21250.0d0, 22370.0d0, 23050.0d0,         
     1           28*1.e20,                                                      
     2           13*0.   ,      .05d0,  .06d0,  15*.065d0,6*.07d0,              
     2            .14d0 ,8*.15d0/                                               
      data tab /  1000.0d0,   .5d0,  2000.0d0, 1.25d0, 3000.0d0, 2.75d0,        
     &            4000.0d0,  3.5d0,  7000.0d0, 5.0d0 , 9000.0d0, 6.0d0 ,        
     &           15000.0d0,  7.0d0, 20000.0d0, 8.0d0 ,25000.0d0, 9.0d0 ,        
     &           30000.0d0, 10.0d0, 40000.0d0,11.0d0 ,75000.0d0,12.0d0 ,        
     &               1.e20, 13.0d0/                                             
      data tab87/ 1000.0d0,  .4d0 ,  2000.0d0,  .8d0,  4000.0d0,2.7d0,          
     &            9000.0d0, 5.0d0 , 15000.0d0, 6.8d0, 20000.0d0,7.2d0,          
     &           30000.0d0, 7.55d0, 45000.0d0, 8.8d0,     1.e20,9.98d0/         
c in 1998 tax rate was reduced on 10%                                           
      data tab98/ 1000.0d0,  .36d0, 2000.0d0, .72d0,  4000.0d0,2.43d0,          
     &            9000.0d0, 4.5d0 ,15000.0d0,6.12d0, 20000.0d0,6.48d0,          
     &           30000.0d0, 6.8d0 ,45000.0d0,7.92d0,     1.e20,8.98d0/          
c in 2019 tax rate was reduced                                                  
      data tab19/ 1000.0d0,  .33d0, 2000.0d0, .67d0,  4000.0d0,2.25d0,          
     &            9000.0d0, 4.14d0 ,15000.0d0,5.63d0,20000.0d0,5.96d0,          
     &           30000.0d0, 6.25d0 ,45000.0d0,7.44d0,    1.e20,8.53d0/          
      data chcr90/10000.0d0, .75d0, 20000.0d0, .65d0, 25000.0d0,.55d0,          
     &            35000.0d0, .50d0, 40000.0d0, .40d0, 45000.0d0,.30d0,          
     &            50000.0d0, .20d0,     1.e20,  .10d0/                          
      data chcr93/10000.0d0, .75d0, 20000.0d0, .65d0, 25000.0d0,.55d0,          
     &            35000.0d0, .50d0, 40000.0d0, .40d0,     1.e20,.0d0/           
      data chcr06/10000.0d0, .75d0, 20000.0d0, .65d0, 25000.0d0,.55d0,          
     &            35000.0d0, .50d0, 40000.0d0, .40d0, 45000.0d0,.30d0,          
     &                1.e20, .0d0/                                              
      data xmp/2*10.0d0,11.0d0,12.0d0,13.0d0,14.0d0,12*15.0d0,                  
     &        27*40.0d0/                                                        
      data aif/                                                                 
     &         2*1.0d0  , 8*1.023d0, 2*1.0d0, 1.016d0, 1.038d0,                 
     &         4*1.060d0,   1.068d0, 1.089d0, 1.112d0, 1.136d0,                 
     &           1.148d0,   1.162d0, 1.185d0, 1.211d0, 1.224d0,                 
     &           1.242d0,   1.269d0, 1.30d0 , 1.343d0, 1.379d0,                 
     &           1.407d0,   1.428d0, 1.439d0, 1.469d0, 1.494d0,                 
     &           1.515d0,   1.539d0, 1.554d0, 1.573d0, 1.598d0,                 
     &           1.638d0,   1.666d0, 1.676d0/                                   
      data stnd/ 2*.10d0,    8*.150d0,  35*1.0d0,                               
     s         2*1000.0d0, 8*1200.0d0, 3*1230.0d0, 1260.0d0, 1280.0d0,          
     i           1310.0d0,   1330.0d0,   1340.0d0, 1360.0d0, 1380.0d0,          
     n           1410.0d0,   1440.0d0,   1460.0d0, 1470.0d0, 1500.0d0,          
     g           1540.0d0,   1550.0d0,   1580.0d0, 1610.0d0, 1650.0d0,          
     l           1700.0d0,   1750.0d0,   1780.0d0, 1810.0d0, 1830.0d0,          
     e           1860.0d0,   1900.0d0,   1920.0d0, 1950.0d0, 1970.0d0,          
     &           2000.0d0,   2030.0d0,   2080.0d0, 2110.0d0, 2130.0d0,          
     m         2*1000.0d0, 8*3000.0d0, 3*3030.0d0, 3100.0d0, 3160.0d0,          
     a           3220.0d0,   3270.0d0,   3310.0d0, 3350.0d0, 3400.0d0,          
     r           3480.0d0,   3550.0d0,   3590.0d0, 3630.0d0, 3700.0d0,          
     r           3780.0d0,   3830.0d0,   3880.0d0, 3970.0d0, 4060.0d0,          
     i           4200.0d0,   4310.0d0,   4390.0d0, 4460.0d0, 4500.0d0,          
     e           4590.0d0,   4670.0d0,   4740.0d0, 4810.0d0, 4860.0d0,          
     &           4920.0d0,   5000.0d0,   5120.0d0, 5210.0d0, 5240.0d0/          
c y levels for other and single filers which exempt them from taxes             
      data exy/                                                                 
     &         2*4000.0d0, 13*5000.0d0,  7500.0d0, 29*9000.0d0,                 
     &         2*4000.0d0,  8*5000.0d0,5*7500.0d0,   11500.0d0,                 
     &       29*13500.0d0/                                                      
c only income brackets and a pnsion exclusion are indexed pre-1987.             
c indexing is contingent on a general fund surplus.                             
      xlin3 = 0.                                                                
      xlin5 = 0.                                                                
      rt = 0.                                                                   
      addph = 0.                                                                
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      nfile = int(filing(mst,1.,2.,3.,2.))                                      
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)phas92=100000.*aif92(law)/sep              
      if(law.ge.2013)                                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c     AGI                                                                       
      agi=comnew(2)+.5*comnew(175)                                              
c 2020 up to $300 cash contribution is added back                               
      if(law.eq.2020.and.comnew(26).lt.1.d0)agi=agi+min(300.d0,data(58))        
c federal tax refunds are included in agi, but are not in the program           
      agi = agi - data(22)                                                      
c Iowa doesn't tax Social Security benefits in the same manner as IRS           
      pha = 0.                                                                  
      if(sep.eq.1) pha = 25000.                                                 
      if(mst.eq.2) pha = 32000.                                                 
      agi = agi - comnew(79)                                                    
c 2014+ Iowa will fully exempt ssb                                              
      if(law.le.2013.and.data(91).gt.0.d0) then                                 
         exc = max(0.0d0,agi)                                                   
         ssb = min(.5* max(0.0d0,.5*data(91)+exc-pha),.5*data(91))              
c 2007-2013 -- Social Security Phase-out                                        
         if(law.ge.2007.and.law.le.2013) ssb = ssb - ssbp(law)*ssb              
         agi = agi + ssb                                                        
         addph = comnew(79) - ssb                                               
      endif                                                                     
      if(law.le.1987)agi = agi-xjobs(data,law)                                  
      if(law.ge.1982.and.law.le.1984)agi = agi+comnew(32)                       
      txp = data(7)                                                             
      if (law.eq.1981) then                                                     
        agi = agi+divexc(data,comnew,law)-twn(data(12)+data(14),0.0d0,          
     &   100.0d0*txp)                                                           
      endif                                                                     
c Pension/retirement income exclusion starts in 1995                            
c Effective for tax years beginning 1998, the pension/retirement                
c income exclusion has increased to up to $5000 for individuals                 
c and to up to $10000 for married taxpayers who file a joint return             
      penexc = 0.                                                               
      if(data(9).gt.0.and.law.ge.1995) penexc =                                 
     & min(data(7)*pen(law),data(20)+data(72))                                  
c          & min(data(9)*pen(law),data(20)+data(72))                            
      agi = agi - penexc                                                        
c 2009 Iowa doesn't couples with the exclusion of the first $2,400 of           
c unemployment compensation                                                     
      if(law.eq.2009.and.data(82).gt.0) then                                    
         agi = agi + min(data(82),data(7)*2400)                                 
      endif                                                                     
c Federal tax is a deduction                                                    
      fedded = max(0.0d0,comnew(1))                                             
c 2019+ Iowa permits a deduction for 25% of your federal QBI deduction          
      dedbus = 0.d0                                                             
      if(law.ge.2019.and.law.le.2020) dedbus = .25*comnew(181)                  
      if(law.eq.2021) dedbus = .5*comnew(181)                                   
      xlin35 = agi - fedded +comnew(175)-dedbus                                 
c Standard Deduction                                                            
      if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                                 
        stded = twn(stnd(law,1)*agi,0.0d0,stnd(law,2))                          
      else                                                                      
        stded = twn(stnd(law,1)*agi,0.0d0,stnd(law,3))                          
      endif                                                                     
c      write(0,*) 'stded',stded                                                 
c charitable contribution deduction for non-itemizers                           
      if(law.ge.1984.and.law.le.1986) then                                      
        stded = stded+twn(.25*(data(58)+data(59)+data(60)),0.0d0,75.0d0)        
      endif                                                                     
c Itemized Deduct                                                               
      xitded=max(0.0d0,comnew(30)-data(50))                                     
      if(agi.gt.phas92.and.(law.ge.1991.and.law.le.2017).and.                   
     & comnew(26).gt.0.) then                                                   
       xlin3=comnew(24)-comnew(20)-data(57)-max(0.0d0,data(61)-.1*agi)          
       xlin5=comnew(30)-comnew(20)-data(57)-max(0.0d0,data(61)-.1*agi)          
       if(xlin5.gt.0)xitded = max(0.d0,comnew(24)-data(50)*xlin3/xlin5)         
      endif                                                                     
      if(law.le.1985)xitded = xitded+min(.05*data(65),100.*data(7))             
      if(law.ge.2018.and.law.le.2019) then                                      
c Itemized Deductions                                                           
         agix = max(0.d0,agi)                                                   
         cash = data(58)                                                        
         asset = data(59)+data(60)                                              
         alim50 = .5*agix                                                       
         unchar = 0.                                                            
         if (agi.lt.0.) then                                                    
            cash = 0.                                                           
            asset = 0.                                                          
         else                                                                   
            if (cash.gt.alim50) then                                            
             cash = alim50                                                      
             asset = 0.                                                         
            else                                                                
              unchar = alim50 - cash                                            
            endif                                                               
         endif                                                                  
         asset = min(.3*agix,asset)                                             
         char = max(0.0d0,min(alim50,cash+asset))                               
         tmisc = max(0.0d0,data(63)-.02*agix)                                   
         edical = max(0.0d0,data(47)+data(48)+data(49)-.1*agix)                 
         casu = max(0.0d0,max(0.0d0,data(61)-100.)-.1*agix)                     
         persin = min(data(57),2000.0d0)                                        
         busint = max(0.0d0,data(57)-persin)                                    
         xid = max(0.0d0,data(12)+data(14)+comnew(6))                           
         dedint = min(xid,busint)                                               
         deduc1 = char+data(51)+data(54)+data(56)+                              
     &   tmisc+busint+persin+data(66)+data(26)                                  
         dedint = data(56)+busint+persin                                        
         deduc2 = casu+edical+data(53)                                          
         deducp = deduc1+deduc2                                                 
         dlim1 = .03*max(0.0d0,agi-phas92)                                      
         dlim2 = .8*max(0.0d0,deduc1-data(57)-data(168))                        
         dedphs = min(dlim1,dlim2)                                              
         deduc1 = deduc1 - dedphs                                               
         xitded = max(0.0d0,deduc1+deduc2)                                      
      endif                                                                     
      if(law.ge.2020) xitded = comnew(30)                                       
c Deductions                                                                    
      ided = int(data(4))                                                            
      if(ided.eq.-2) xitded = 0                                                 
      deduc = max(stded,xitded)                                                 
c Taxable Income                                                                
      yad1 = agi + comnew(175)                                                  
c      write(0,*) 'yad1 agi c175',yad1,agi,comnew(175)                          
      yad = yad1 - fedded - dedbus                                              
c      write(0,*) 'yad1 fedded dedbus',yad1,fedded,dedbus                       
      taxinc = max(0.0d0,yad - deduc)                                           
c      write(0,*) 'taxinc yad deduc',taxinc,yad,deduc                           
c Tax Calculation                                                               
      if(mst.eq.2.and.agi.gt.0) then                                            
        agih = max(data(85),data(86))+.5*(agi - data(11))                       
        agiw = agi-agih                                                         
        if(agiw.gt.0) then                                                      
         stdedh = twn(stnd(law,1)*agi,0.0d0,stnd(law,2))                        
         stdedw = stdedh                                                        
         xitdh = xitded*agih/agi                                                
         xitdw = xitded-xitdh                                                   
         dedw = max(stdedw,xitdw)                                               
         if(stdedw.ge.xitdw) then                                               
            dedh = stdedh                                                       
         else                                                                   
            dedh = xitdh                                                        
         endif                                                                  
         feddh = fedded*agih/agi                                                
         feddw = fedded - feddh                                                 
         taxinh=max(0.0d0,agih-dedh+.5*.5*comnew(175)-feddh-.5*dedbus)          
         taxinw=max(0.0d0,agiw-dedw+.5*.5*comnew(175)-feddw-.5*dedbus)          
        else                                                                    
         stdedh = stded                                                         
         stdedw = 0                                                             
         xitdh = xitded                                                         
         xitdw = 0                                                              
         dedh = max(stdedh,xitdh)                                               
         dedw = 0                                                               
         taxinh=taxinc                                                          
         taxinw=0                                                               
        endif                                                                   
      endif                                                                     
      if(law.le.1986) then                                                      
        call look(tab,taxinc,13,n,statax,aif(law),0.0d0,rt,data)                
        if(agi.gt.0.and.mst.eq.2) then                                          
        taxinh=max(0.0d0,agih-dedh+comnew(175)*agih/agi-fedded*agih/agi)        
        taxinw=max(0.0d0,agiw-dedw+comnew(175)*agiw/agi-fedded*agiw/agi)        
          call look(tab,taxinh,13,n,stath,aif(law),0.0d0,rt,data)               
          call look(tab,taxinw,13,n,statw,aif(law),0.0d0,rt,data)               
          statax = min(statax,stath+statw)                                      
        endif                                                                   
      else if(law.ge.1987.and.law.le.1997) then                                 
        call look(tab87,taxinc,9,n,statax,aif(law),0.0d0,rt,data)               
        if(agi.gt.0.and.mst.eq.2) then                                          
          call look(tab87,taxinh,9,n,stath,aif(law),0.0d0,rt,data)              
          call look(tab87,taxinw,9,n,statw,aif(law),0.0d0,rt,data)              
          statax = min(statax,stath+statw)                                      
        endif                                                                   
      else if(law.ge.1998.and.law.le.2018) then                                 
        call look(tab98,taxinc,9,n,statax,aif(law),0.0d0,rt,data)               
        if(agi.gt.0.and.mst.eq.2) then                                          
          call look(tab98,taxinh,9,n,stath,aif(law),0.0d0,rt,data)              
          call look(tab98,taxinw,9,n,statw,aif(law),0.0d0,rt,data)              
          statax = min(statax,stath+statw)                                      
        endif                                                                   
      else                                                                      
c new rates in 2019                                                             
        call look(tab19,taxinc,9,n,statax,aif(law),0.0d0,rt,data)               
        if(agi.gt.0.and.mst.eq.2) then                                          
          call look(tab19,taxinh,9,n,stath,aif(law),0.0d0,rt,data)              
          call look(tab19,taxinw,9,n,statw,aif(law),0.0d0,rt,data)              
          statax = min(statax,stath+statw)                                      
        endif                                                                   
      endif                                                                     
c                                                                                
c Alternate Tax may reduce tax liability                                        
      if(law.ge.1987.and.mst.ne.1) then                                         
        if(law.le.1997) then                                                    
           altax = max(0.0d0,(agi-exy(law,2))*.0998)                            
        else                                                                    
           subtr = exy(law,2)                                                   
           if(data(9).gt.0.and.law.ge.2007) then                                
              if(law.le.2008) subtr = 24000.                                    
              if(law.ge.2009) subtr = 32000.                                    
           endif                                                                
           if(law.ge.2014.and.data(91).gt.0.d0)then                             
c Reportable Social Security Benefits Worksheet                                 
             xl2 = data(91)/2                                                   
             xl7 = comnew(2) - comnew(79) + data(41) + xl2                      
             xl9 = max(0.d0,xl7 - pha)                                          
             addph = min(xl2,xl9/2.d0)                                          
           endif                                                                
           altax = max(0.0d0,(agi + penexc + addph-subtr)*exyr(law))            
        endif                                                                   
        statax = min(statax,altax)                                              
      endif

c extra lump-sum distribution tax can not be calculated                         
c Credits                                                                       
c Personal Exemption Credit                                                     
      if(law.le.1994) then                                                      
         gcred = (xmp(law)+5.)*(data(7)+data(9)+data(10))+                      
     &   xmp(law)*data(8)                                                       
         if(nfile.eq.3)gcred = gcred+xmp(law)+5.                                
      else if(law.ge.1995.and.law.le.1997) then                                 
         gcred = (xmp(law)/2.)*(data(7)+data(9)+data(10))+                      
     &   (xmp(law)*data(8))                                                     
         if(nfile.eq.3)gcred = gcred+xmp(law)/2                                 
      else                                                                      
         gcred = (xmp(law)/2)*(data(9)+data(10))+                               
     &   (xmp(law)*(data(8)+data(7)))                                           
         if(nfile.eq.3)gcred = gcred+xmp(law)                                   
      endif                                                                     
c dependents filing their own returns: You may claim a $40 exemp crd even       
c if you are claimed as a dependent on another person's Iowa return             
      gcred = gcred+data(34)                                                    
      statax = max(0.0d0,statax - gcred)                                        
c alternative minimum tax                                                       
      if(law.le.1981) then                                                      
         alty = 0.                                                              
      else if(law.eq.1982) then                                                 
         alty = comnew(70)*.25                                                  
      else if(law.eq.1983.or.law.eq.1984) then                                  
         alty = comnew(70)*.7                                                   
c for years 1985+ min tax is calculated using Form 6251                         
c rat(law) is only a guess for 1986-1995 because of the absence                 
c of the form  6251 for these years                                             
      else if(law.ge.1985) then                                                 
c       alty = max(0.0d0,max(0.0d0,rat(law)*                                    
c    &     (max(0.0d0,comnew(69)-alt1(mst))+                                    
c    &     .25*max(0.0d0,(comnew(69)-alt2(mst))))-statax))                      
       addprf = data(51)+comnew(20)+comnew(97)+data(81)-comnew(34)                   
       alminy = taxinc + addprf   
c       write(0,*) 'alminy addprf',alminy,addprf
       if(xlin5.gt.0) alminy = alminy - data(50)*xlin3/xlin5                    
       exclnt = alt1(mst)                                                       
       if(alminy.gt.alt2(mst))                                                  
     &  exclnt = max(0.0d0,alt1(mst) - .25*(alminy-alt2(mst)))                  
       alty = max(0.0d0,rat(law)*(alminy-exclnt) - statax)                      
c       write(0,*) 'alty',alty

      endif 
      
      if((mst.eq.1.and.data(9).lt.1.d0.and.agi.le.exy(law,1)).or.               
     &   (mst.eq.1.and.data(9).gt.0.d0.and.agi.le.24000.d0).or.                 
     &   (mst.ne.1.and.data(9).lt.1.d0.and.agi.le.exy(law,2)).or.               
     &   (mst.ne.1.and.data(9).gt.0.d0.and.agi.le.32000.d0)) alty = 0.d0        
      statax = statax + alty
c      write(0,*) 'statax alty',statax,alty

c child care credit is refundable for 1990+                                     
      posagi = max(agi,0.d0)                                                    
      if(law.le.1981) then                                                      
        chcr = comnew(176)*.05                                                  
      else if(law.ge.1982.and.law.le.1985) then                                 
        chcr = data(64)*.1                                                      
      else if(law.ge.1986.and.law.le.1989) then                                 
        chcr = comnew(176)*.45                                                  
      else if(law.ge.1990.and.law.le.1992) then                                 
        chcr = comnew(176)*tablki(chcr90,8,comnew(2),data)                      
      else if(law.ge.1993.and.law.le.2005) then                                 
c Only taxpayers <$40,000 of net income are eligible for  1993-2005             
        chcr = comnew(176)*tablki(chcr93,6,posagi,data)                         
      else if(law.ge.2006) then                                                 
c Only taxpayers with <$45,000 of net income are eligible for 2006+             
        chcr = comnew(176)*tablki(chcr06,7,posagi,data)                         
      endif                                                                     
c Earned Income Credit started in 1990                                          
      earncr = 0.                                                               
      earned = comnew(37)                                                       
      if(comnew(2).lt.eicr(law,1)) earncr = eicr(law,2)*comnew(59)              
c worksheet if additional calculation required                                  
      if(law.eq.2009.and.mst.eq.2.and.earncr.gt.0) then                         
         if(data(8).eq.0) xlin2 = 10590.                                        
         if(data(8).ge.1.and.data(8).le.2) xlin2 = 19540.                       
         if(data(8).ge.3) xlin2 = 16420.                                        
         xlin3 = max(0.0d0,earned - xlin2)                                      
         if(data(8).eq.0) xlin5 = max(0.0d0,457. - xlin3*.0765)                 
         if(data(8).eq.1) xlin5 = max(0.0d0,3043. - xlin3*.1598)                
         if(data(8).ge.2) xlin5 = max(0.0d0,5028. - xlin3*.2106)                
         earncr = .07*xlin5                                                     
      endif                                                                     
c Taxpayers may be eligible for Federal EITC, but not eligible for IA           
      if(law.eq.2010.and.mst.eq.2.and.earncr.gt.0) then                         
          if(data(8).lt.1.and.                                                  
     &  (earned.gt.16590.or.agi.gt.16590)) earncr = 0                           
                if(data(8).eq.1.and.                                            
     &  (earned.gt.38665.or.agi.gt.38665)) earncr = 0                           
                if(data(8).ge.2.and.                                            
     &  (earned.gt.43493.or.agi.gt.43493)) earncr = 0                           
       else                                                                     
                if(data(8).lt.1.and.                                            
     &  (earned.gt.13460.or.agi.gt.13460)) earncr = 0                           
                if(data(8).eq.1.and.                                            
     &  (earned.gt.35535.or.agi.gt.35535)) earncr = 0                           
                if(data(8).ge.2.and.                                            
     &  (earned.gt.40363.or.agi.gt.40363)) earncr = 0                           
      endif                                                                     
      credit = gcred + chcr + earncr                                            
      if(law.le.1989) statax = max(0.0d0, statax-chcr-earncr)                   
      if(law.ge.1990.and.law.le.2006)                                           
     &  statax = max(0.0d0,statax-earncr)-chcr                                  
c Tax reducing income for single taxpayers                                      
      if(mst.eq.1) statax = max(min(agi-exy(law,1),statax),0.0d0)               
c Starting 2007 EIC  is refundable at 7% of the Federal EIC                     
      if(law.ge.2007) statax = statax - earncr - chcr                           
c low income have 0 tax 1992+                                                   
      if(statax.gt.0.and.law.ge.1992) then                                      
         if(mst.eq.1.and.comnew(2).le.exy(law,1)) statax = 0.                   
         if(mst.gt.1.and.comnew(2).le.exy(law,2)) statax = 0.                   
      endif                                                                     
      return                                                                    
      end                                                                       
c  KANSAS                                                                       
c  State 17                                                                     
c  Updated through 2021 (updated 03/02/2022)                                    
      subroutine kstax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/temp/ct                                                            
      dimension tab(2,8),                                                       
     & tabs88(2,2), tabj88(2,2)                                                 
      dimension tabs90(2,2), tabj90(2,2), tabs92(2,3), tabj92(2,3),             
     &tabs97(2,3),tabs98(2,3),aif(1991:2009),eicr(1998:2021)                    
      dimension tab13(2,2),tab14(2,2),tab15(2,2),tab17(2,3),tab18(2,3)          
      dimension socmax(1977:1997),selfmx(1977:1997)                             
      dimension data(255),comnew(255),xmp(1977:2021),child(2,11)                
      dimension ftabm(2,4), ftabs(2,5)                                          
      dimension agimax(1998:2021), food(1998:2021),aifit(2013:2021)             
      dimension prc(2008:2021),hyprc(2008:2021),prop(1997:2021),                
     & hom08(2,22), hom98(2,23),pt(1997:2021)                                   
      double precision fedded,fedtax                                            
      integer sep                                                               
      data pt/10*600.d0,15*700.d0/                                              
      data prc/3*.45d0,11*.75d0/                                                
      data hyprc/16800.d0,2*17500.d0,17700.d0,18200.d0,18600.d0,                
     &           18900.d0,  19100.d0,19200.d0,19500.d0,19800.d0,                
     &           20300.d0,  20700.d0,20900.d0/                                  
      data prop/7*25001.d0,26301.d0,27001.d0,28001.d0,29101.d0,                 
     &              29701.d0,31301.d0,30801.d0,31201.d0,32401.d0,               
     &              32901.d0,33401.d0,34001.d0,34101.d0,34451.d0,               
     &              35000.d0,35700.d0,36300.d0,36600.d0/                        
      data hom08/                                                               
     &          6000.0d0, 1.0d0 , 7000.0d0, .96d0,  8000.0d0, .92d0,            
     &          9000.0d0,  .88d0,10000.0d0, .84d0, 11000.0d0, .80d0,            
     &         12000.0d0,  .76d0,13000.0d0, .72d0, 14000.0d0, .68d0,            
     &         15000.0d0,  .64d0,16000.0d0, .60d0, 17000.0d0, .55d0,            
     &         18000.0d0,  .50d0,19000.0d0, .45d0, 20000.0d0, .40d0,            
     &         21000.0d0,  .35d0,22000.0d0, .30d0, 23000.0d0, .25d0,            
     &         24000.0d0,  .20d0,25000.0d0, .15d0, 26000.0d0, .10d0,            
     &             1.e20,  .05d0/                                               
      data hom98/                                                               
     &          3001.0d0, 1.0d0 , 4001.0d0, .88d0,  5001.0d0, .84d0,            
     &          6001.0d0,  .8d0 , 7001.0d0, .76d0,  8001.0d0, .72d0,            
     &          9001.0d0,  .68d0,10001.0d0, .64d0, 11001.0d0, .60d0,            
     &         12001.0d0,  .56d0,13001.0d0, .52d0, 14001.0d0, .48d0,            
     &         15001.0d0,  .44d0,16001.0d0, .40d0, 17001.0d0, .36d0,            
     &         18001.0d0,  .32d0,19001.0d0, .28d0, 20001.0d0, .24d0,            
     &         21001.0d0,  .20d0,22001.0d0, .16d0, 23001.0d0, .12d0,            
     &         24001.0d0,  .08d0,    1.e20, .04d0/                              
      data aifit/.7d0,.65d0,4*.5d0,.75d0,2*1.d0/                                
      data agimax/                                                              
     &           5*12500.0d0,13150.0d0,13450.0d0,13800.0d0,                     
     &             14300.0d0,14850.0d0,15150.0d0,15950.0d0,                     
     &           2*17500.0d0,18350.0d0,9*30615.0d0/                             
      data food/ 5*30.0d0,3*36.0d0,37.0d0, 38.0d0,39.0d0,                       
     &             41.0d0,2*45.0d0,47.0d0,9*125.0d0/                            
c EIC rate 1998+                                                                
      data eicr/                                                                
     &          4*.1d0, 5*.15d0, 3*.17d0,3*.18d0,9*.17d0/                       
      data aif  /   1.0d0, 1.05250d0, 1.08450d0, 1.1180d0, 1.1470d0,            
     &          1.17950d0, 1.2120d0 ,  1.2450d0, 1.2660d0, 1.28950d0,           
     &          1.32950d0, 1.3730d0 ,  1.3950d0, 1.4270d0, 1.45950d0,           
     &          1.5050d0, 1.5640d0,    1.59950d0,  1.6680d0 /                   
      data tab /                                                                
     &          2000.0d0, 2.0d0,   3000.0d0, 3.5d0,  5000.0d0, 4.0d0,           
     &          7000.0d0, 5.0d0,  10000.0d0, 6.5d0, 20000.0d0, 7.5d0,           
     &         25000.0d0, 8.5d0,      1.e20, 9.0d0 /                            
      data tabs88/                                                              
     &            27500.0d0, 4.8d0,   1.e20, 6.1d0/                             
      data tabj88/                                                              
     &            35000.0d0, 4.05d0,  1.e20, 5.3d0/                             
      data tabs90/                                                              
     &            27500.0d0, 4.50d0,   1.e20, 5.95d0/                           
      data tabj90/                                                              
     &            35000.0d0, 3.65d0,  1.e20, 5.15d0/                            
      data tabs92/                                                              
     &            20000.0d0, 4.4d0, 30000.0d0, 7.5d0,  1.e20,  7.75d0/          
      data tabj92/                                                              
     &            30000.0d0, 3.5d0, 60000.0d0, 6.25d0, 1.e20,  6.45d0/          
      data tabs97/                                                              
     &            20000.0d0, 4.1d0, 30000.0d0, 7.50d0, 1.e20,  7.75d0/          
      data tabs98/                                                              
     &            15000.0d0, 3.5d0, 30000.0d0, 6.25d0, 1.e20,  6.45d0/          
      data tab13/ 15000.0d0, 3.0d0, 1.e20, 4.9d0 /                              
      data tab14/ 15000.0d0, 2.7d0, 1.e20, 4.8d0 /                              
      data tab15/ 15000.0d0, 2.7d0, 1.e20, 4.6d0 /                              
      data tab17/ 15000.0d0, 2.9d0, 30000.0d0, 4.90d0, 1.e20, 5.2d0/            
      data tab18/ 15000.0d0, 3.1d0, 30000.0d0, 5.25d0, 1.e20, 5.7d0/            
      data ftabm/                                                               
     &            20000.0d0, 4.75d0, 35000.0d0,5.0d0, 45000.0d0, 8.5d0,         
     &                1.e20, 8.75d0/                                            
      data ftabs/                                                               
     &             2000.0d0, 4.75d0, 10000.0d0,5.6d0, 20000.0d0,5.75d0,         
     &            30000.0d0, 8.50d0,     1.e20,8.75d0/                          
      data xmp/2*750.0d0,9*1000.0d0,1950.0d0,9*2000.0d0,24*2250.0d0/            
      data child/                                                               
     &         5000.0d0, 1.0d0,  6000.0d0, .9d0,  7000.0d0, .8d0,               
     &         8000.0d0, .7d0 ,  9000.0d0, .6d0, 10000.0d0, .5d0,               
     &        11000.0d0, .4d0 , 12000.0d0, .3d0, 13000.0d0, .2d0,               
     &        14000.0d0, .1d0 ,     1.e20, .0d0/                                
      data socmax/                                                              
     &         965.25d0, 1070.8d0, 1403.8d0, 1587.7d0, 1975.05d0,               
     &        2170.8d0 , 2391.9d0, 2532.6d0, 13*1.e20/                          
      data selfmx/                                                              
     &         1303.5d0, 1433.7d0 , 1854.9d0, 2097.9d0,  2405.7d0,              
     &         3029.4d0, 3337.95d0, 4271.4d0,  13*1.e20/                        
      rt=0.                                                                     
      mst = int(data(2))                                                             
      txp = 1                                                                   
      if(mst.eq.2) txp = 2                                                      
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
c AGI                                                                           
      agi = comnew(2)-data(22)                                                  
      if(law.le.1987)agi=agi-xjobs(data,law)                                    
c New in 2007 -- Social Security Benefits are not taxable                       
      if(law.eq.2007.and.comnew(2).le.50000.d0) agi = agi - comnew(79)          
      if(law.ge.2008.and.comnew(2).le.75000.d0) agi = agi - comnew(79)          
c 2013-2016 Schedule S Part A -- income modifications                           
      if(law.ge.2013.and.law.le.2016) then                                      
        agi = agi + .5*comnew(175) - comnew(8) - data(17) - data(21)            
      endif                                                                     
c Standard Deduction                                                            
      if(law.le.1987) then                                                      
        if(mst.ne.2.and.mst.ne.3.and.mst.ne.6) then                             
          stded=twn(.16*agi,1700.0d0,2400.0d0)                                  
        else if(mst.eq.2.or.mst.eq.3.or.mst.eq.6) then                          
          stded=twn(.16*agi,2100.d0/sep,2800.d0/sep)                            
        endif                                                                   
      else if(law.ge.1988.and.law.le.1997) then                                 
        stded=filing(mst,3000.,5000.,4400.,2500.)                               
        xstd=data(9)+data(10)                                                   
        xstd=xstd*sorm(mst,750.0d0,600.0d0)                                     
        stded=stded+xstd                                                        
      else if(law.ge.1998) then                                                 
        stded = filing(mst,3000.,6000.,4500.,3000.)                             
        if(law.ge.2013.and.law.le.2020)                                         
     &  stded = filing(mst,3000.,7500.,5500.,3750.)                             
        if(law.ge.2021) stded = filing(mst,3500.,7800.,6000.,4000.)             
c Standard Deduction for Dependents                                             
        if(data(105).gt.0.) stded = min(stded,max(500.0d0,comnew(37)))          
c Standard Deduction for People 65 or Older and/or Blind                        
        nxstd = int(data(9)+data(10))                                                
        xstd = nxstd*sorm(mst,850.0d0,700.0d0)                                  
        stded = stded+xstd                                                      
      endif                                                                     
c Federal tax deduction                                                         
c the $5000/$10000 special tax limitation on the federal tax income deduction   
c expired on December 31,1984.                                                  
c in 1987 all taxpayers are allowed to deduct their federal income tax          
      fedtax=max(0.0d0,comnew(1))                                               
      if(law.le.1982.or.(law.ge.1987.and.law.le.1988)) then                     
        fedded=fedtax                                                           
      else if(law.eq.1983.or.law.eq.1984) then                                  
        if(fedtax.le.5000.*data(7)) then                                        
           fedded=fedtax                                                        
        else if(fedtax.gt.5000*data(7).and.fedtax.le.10000*data(7)) then        
           fedded=5000.*data(7)                                                 
        else                                                                    
           fedded=.5*fedtax                                                     
        endif                                                                   
      else if(law.ge.1985.and.law.le.1986) then                                 
        fedded=fedtax*max(agi,0.0d0)/max(comnew(2),1.0d0)                       
      else if(law.ge.1989) then                                                 
        fedded=0.                                                               
      endif                                                                     
c Itemized Deductions                                                           
c if you did not itemize your deductions on your federal return,                
c you must take the stded on your Kansas return(through 2020)                   
      xitded = 0.                                                               
      ag = max(0.0d0,agi)                                                       
      if(comnew(26).gt.0.and.law.le.2020) then                                  
        if(law.le.1987) then                                                    
          edm=max(0.0d0,data(49)+data(48)+data(47)-50.)                         
          soc=twn(socsec(data,comnew,law),0.0d0,socmax(law)*data(7))            
          addtx=twn(comnew(175)+data(44),0.0d0,selfmx(law)*data(7))             
          xitded=max(0.d0,comnew(24)-data(50)-comnew(20)+edm+soc+addtx)         
          if(law.ge.1979.and.law.le.1986)                                       
     &      xitded=xitded+min(comnew(25),100.*data(7))                          
        else if(law.ge.1988.and.law.le.1990) then                               
          xitded=max(0.d0,comnew(24)-data(50))                                  
        else if(law.ge.1991.and.law.le.2009) then                               
          if(comnew(2).le.100000.*aif(law)/sep) then                            
             xitded=max(0.d0,comnew(24)-data(50))                               
          else                                                                  
             fline3 = max(0.0d0,                                                
     &  comnew(24)-comnew(20)-max(data(61)-.1*ag,0.0d0))                        
             if(fline3.gt.0.) then                                              
               fline9 = min(.03*max(comnew(2)-100000.*aif(law),0.0d0),          
     &           .8 *fline3)                                                    
               sline1 = fline9/fline3                                           
c fline3,fline9 - lines 3 and 9 of the federal it.ded. worksheet                
c sline1        - the first line of the state it. ded. worksheet                
               xitded = max(0.d0,comnew(24) -data(50)*(1-sline1))               
             else                                                               
               xitded=max(0.d0,comnew(24)-data(50))                             
             endif                                                              
          endif                                                                 
        else if(law.ge.2010.and.law.le.2012) then                               
             xitded = max(comnew(24)-data(50),0.0d0)                            
        else if(law.ge.2013.and.law.le.2017) then                               
             xitded = aifit(law)*                                               
     &       max(comnew(30)-data(50)-comnew(23),0.0d0)                          
     &    + comnew(23) 
          
        else if(law.ge.2018) then                                               
          txpaid = data(51)+data(54)                                            
          xitded = aifit(law)*(comnew(20)+txpaid+data(56))+comnew(23)           
        endif                                                                   
      endif                                                                     
      if(law.eq.2021) then                                                      
        edical = max(0.d0,data(47)+data(48)+data(49)-.075*ag)                   
        xitded = edical + data(51)+data(54)+comnew(23)+data(56)                 
      endif                                                                     
      deduc=max(stded,xitded)                                                   
c      write(0,*) 'stded xitded',stded,xitded                                   
c Exemptions                                                                    
      exemps = comnew(68)                                                       
      if(mst.eq.4.or.mst.eq.7) exemps = exemps+1                                
      exemp = exemps*xmp(law)                                                   
c Taxable Income                                                                
      taxinc=max(0.0d0,agi-deduc-exemp-fedded)                                  
c      write(0,*) 'taxinc agi deduc exemp fedded',                              
c     &taxinc,agi,deduc,exemp,fedded                                            
c Calculation of Tax                                                            
      if (law.le.1987) then                                                     
       call look(tab,taxinc,8,n,statax,1.0d00,-data(2),rt,data)                 
      else if(law.eq.1988.or.law.eq.1989)then                                   
       if(mst.ne.2)                                                             
     &  call look(tabs88,taxinc,2,n,statax,1.0d00,0.0d0,rt,data)                
       if(mst.eq.2)                                                             
     &  call look(tabj88,taxinc,2,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.eq.1990.or.law.eq.1991) then                                  
       if(mst.ne.2)                                                             
     &  call look(tabs90,taxinc,2,n,statax,1.0d00,0.0d0,rt,data)                
       if(mst.eq.2)                                                             
     &  call look(tabj90,taxinc,2,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.ge.1989.and.law.le.1991) then                                 
c if claiming a deduct for fed inc tax....only lasts through 1991               
        taxy=max(0.0d0,taxinc-fedtax)                                           
        if(mst.ne.2)                                                            
     &   call look(ftabs,taxy,5,n,ftax,1.0d00,0.0d0,rt,data)                    
        if(mst.eq.2)                                                            
     &   call look(ftabm,taxy,4,n,ftax,1.0d00,0.0d0,rt,data)                    
        statax=min(statax,ftax)                                                 
      else if(law.ge.1992.and.law.le.2012) then                                 
        if(mst.ne.2) then                                                       
           if(law.le.1996) then                                                 
             call look(tabs92,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)           
           else if(law.eq.1997) then                                            
             call look(tabs97,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)           
           else if(law.ge.1998) then                                            
             call look(tabs98,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)           
           endif                                                                
        else                                                                    
           call look(tabj92,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)             
        endif                                                                   
      else if(law.eq.2013) then                                                 
       call look(tab13,taxinc,2,n,statax,1.0d00,-data(2),rt,data)               
      else if(law.eq.2014) then                                                 
       call look(tab14,taxinc,2,n,statax,1.0d00,-data(2),rt,data)               
      else if(law.eq.2015.or.law.eq.2016) then                                  
       call look(tab15,taxinc,2,n,statax,1.0d00,-data(2),rt,data)               
       if(mst.ne.2.and.taxinc.le.5000.0d0) statax = 0.                          
       if(mst.eq.2.and.taxinc.le.12500.0d0)statax = 0.                          
      else if(law.eq.2017) then                                                 
       call look(tab17,taxinc,3,n,statax,1.0d00,-data(2),rt,data)               
       if(mst.ne.2.and.taxinc.le.5000.0d0) statax = 0.                          
       if(mst.eq.2.and.taxinc.le.12500.0d0)statax = 0.                          
      else if(law.ge.2018) then                                                 
       call look(tab18,taxinc,3,n,statax,1.0d00,-data(2),rt,data)               
       if(mst.ne.2.and.taxinc.le.2500.0d0) statax = 0.                          
       if(mst.eq.2.and.taxinc.le.5000.0d0) statax = 0.                          
      endif                                                                     
c Credits                                                                       
c child care credit                                                             
      chcr = 0.d0                                                               
      chcare = min(comnew(53),max(0.0d0,comnew(52)-data(34)))                   
      if(law.le.1987) then                                                      
         chcr=chcare*tablki(child,11,agi,data)                                  
      else if((law.ge.1988.and.law.le.2012).or.law.ge.2020) then                
         chcr=.25*chcare                                                        
      else if(law.eq.2019) then                                                 
         chcr=.1875*chcare                                                      
      endif                                                                     
c federal and kansas solar energy credits expire after 1986, but                
c carryover should still be counted by data(38)                                 
c the credit was limited to $1500. per dwelling for tax years 1984 and 1985     
c the solar energy credit expired as December 31,1985                           
      if(law.le.1979) then                                                      
         encred=min(1000.0d0,data(38))                                          
      else if(law.ge.1980.and.law.le.1985) then                                 
         encred=min(1500.0d0,data(38))                                          
      else                                                                      
         encred=0.                                                              
      endif                                                                     
c Homestead and Food Sales Tax                                                  
c food credit                                                                   
      pcred=0                                                                   
      if(law.eq.1977.or.law.eq.1978) then                                       
        if(law.eq.1977) then                                                    
           bound=8150.                                                          
        else                                                                    
           bound=9200.                                                          
        endif                                                                   
        if(data(159).le.bound) then                                             
         pr1=data(51)+.12*data(160)                                             
         if(data(159).le.3400.) then                                            
            pcred = pr1                                                         
         else if(data(159).gt.3400) then                                        
            if(data(159).le.4200.) then                                         
               claw =max(0.0d0,(data(159)-3400.)*.02)                           
            else if(data(159).gt.4200.and.data(159).le.4600.)then               
               claw = 16.+ max(0.0d0,(data(159)-4200)*.04)                      
            else                                                                
               claw = 32.+ max(0.0d0,(data(159)-4600)*.045)                     
            endif                                                               
            pcred=max(0.0d0,min(395.0d0,pr1-claw))                              
c            if(pcred.lt.5.) pcred=0.                                           
         endif                                                                  
        endif                                                                   
c formulas interpolate the table in the booklet                                 
      else if(law.ge.1979.and.law.le.1988.and.data(159).le.12800.)then          
         pr1=data(51)+.15*data(160)                                             
         if(data(159).le.3400.) then                                            
            pcred = pr1                                                         
         else if(data(159).gt.3400) then                                        
            if(data(159).le.3500.) then                                         
               claw =max(0.0d0,(data(159)-3400.)*.01)                           
            else if(data(159).gt.3500.and.data(159).le.4000.)then               
               claw = 1. + max(0.0d0,(data(159)-3500.)*.02)                     
            else if(data(159).gt.4000.and.data(159).le.4600.)  then             
               claw = 11.+ max(0.0d0,(data(159)-4000.)*.03)                     
            else if(data(159).gt.4600.and.data(159).le.8600.)  then             
               claw = 29.+ max(0.0d0,(data(159)-4600.)*.04)                     
            else                                                                
               claw = 189.+ max(0.0d0,(data(159)-8600.)*.05)                    
            endif                                                               
c            pcred=max(0.0d0,min(395.0d0,int(pr1/5)*5.)-claw)                   
c using int doesn't give us a monotone function                                 
            pcred=max(0.0d0,min(395.0d0,pr1)-claw)                              
c            if(pcred.lt.5.) pcred=0.                                           
         endif                                                                  
      else if(law.ge.1989.and.law.le.1994.and.data(159).le.15000.)then          
         pr1=data(51)+.15*data(160)                                             
         if(data(159).le.3400.) then                                            
            pcred = pr1                                                         
         else if(data(159).gt.3400) then                                        
            if(data(159).le.4200.) then                                         
               claw =max(0.0d0,(data(159)-3400.)*.02)                           
            else if(data(159).gt.4200.and.data(159).le.4600.)  then             
               claw = 16.+ max(0.0d0,(data(159)-4200)*.04)                      
            else                                                                
               claw = 32.+ max(0.0d0,(data(159)-4600)*.045)                     
            endif                                                               
c            pcred=max(0.0d0,min(490.0d0,int(pr1/10)*10.)-claw)                 
            pcred=max(0.0d0,min(490.0d0,pr1)-claw)                              
c            if(pcred.lt.5.) pcred=0.                                           
         endif                                                                  
c Homestead refund                                                              
      else if(law.eq.1996.or.law.eq.1995.and.data(159).le.17200.)then           
         pr1=data(51)+.15*data(160)                                             
         if(data(159).le.3400.) then                                            
            pcred = pr1                                                         
         else if(data(159).gt.3400) then                                        
            if(data(159).le.4200.) then                                         
               claw =max(0.0d0,(data(159)-3400.)*.02)                           
            else if(data(159).gt.4200.and.data(159).le.4600.)  then             
               claw = 16.+ max(0.0d0,(data(159)-4200)*.04)                      
            else                                                                
               claw = 32.+ max(0.0d0,(data(159)-4600)*.045)                     
            endif                                                               
c            pcred=max(0.0d0,min(590.0d0,int(pr1/10)*10.)-claw)                 
            pcred=max(0.0d0,min(590.0d0,pr1)-claw)                              
c            if(pcred.lt.5.) pcred=0.                                           
         endif                                                                  
      else if(law.ge.1997) then                                                 
c Kansas provides a homestead refund                                            
         if(law.le.2007) then                                                   
            ptax = min(pt(law),data(51)+.2*data(160))                           
         else if(law.ge.2008.and.law.le.2012) then                              
            ptax = min(pt(law),data(51)+.15*data(160))                          
         else                                                                   
            ptax = min(pt(law),data(51))                                        
         endif                                                                  
         if(law.le.2005) then                                                   
            hhy = hy                                                            
         else                                                                   
            hhy = agi + comnew(59) + .5*data(91)                                
         endif                                                                  
         pmax = prop(law)                                                       
         if(hhy.lt.pmax) then                                                   
           if(law.le.2004) pcred = ptax*tablki(hom98,23,hhy,data)               
           if(law.ge.2005) pcred = ptax*tablki(hom08,22,hhy,data)               
         endif                                                                  
c Kansas Property Tax Relief Claim for Low Income Seniors 2008+                 
c Claimants who receive this property tax refund cannot claim a Homestead refund
         if(data(9).gt.0.d0.and.data(51).gt.0.d0.and.law.ge.2008) then          
           if(hy.lt.hyprc(law)) pcred = prc(law)*data(51)                       
         endif                                                                  
      endif                                                                     
c Kansas food sales tax refund                                                  
      fd=0.                                                                     
      if(law.le.1985) then                                                      
       if(data(159).le.10000.)                                                  
     &      fd=20.*twn(data(9)+data(10),0.0d0,data(7)+data(8))                  
      else if(law.ge.1986.and.law.le.1997) then                                 
       if(data(159).lt.5000.)                                                   
     &      fd=40.+30.*(data(7)+data(8)-1.)                                     
       if(data(159).ge.5000..and.data(159).lt.10000.)                           
     &      fd=30.+25.*(data(7)+data(8)-1.)                                     
       if(data(159).ge.10000..and.data(159).le.13000.)                          
     &      fd=20.+15.*(data(7)+data(8)-1.)                                     
      else if(law.ge.1998.and.data(8)+data(9)+data(10).gt.0.) then              
       if(law.le.2012) then                                                     
         if(agi.le.agimax(law)) then                                            
          fd = 2*food(law)*exemps                                               
         else if(agi.le.2*agimax(law)) then                                     
          fd = food(law)*exemps                                                 
         endif                                                                  
        else if(law.ge.2013) then                                               
          if(comnew(2).le.agimax(law))fd = food(law)*comnew(68)                 
        endif                                                                   
      endif                                                                     
c Earned Income Credit  - new in 1998                                           
c Kansas allows a State Earned Income Credit based on                           
c a percentage of the federal EIC                                               
      earncr = 0.                                                               
      if(law.ge.1998) earncr = eicr(law)*comnew(59)                             
      credit = chcr + encred + pcred + fd + earncr                              
      if(law.le.2012) then                                                      
        statax = max(0.0d0,statax - encred-chcr)-fd-earncr-pcred                
      else if(law.ge.2013) then                                                 
c 2013 Food Sales tax credit is non-refundable in 2013+                         
        statax = max(0.0d0,statax - encred-chcr-fd)-earncr-pcred                
      endif                                                                     
                                                                                
      return                                                                    
      end                                                                       
c  KENTUCKY                                                                     
c  State 18                                                                     
c  Updated 2021 (updated 03/04/2022)                                            
      subroutine kytax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      double precision lowcrd,modagi                                            
      integer count,sep                                                         
      dimension gap1(2,11),gap2(2,11),gap3(2,11)                                
      dimension tab(2,5),ch(1982:1986,2),ded(1977:2021),                        
     & retire(1995:2021,2),tab05(2,6)                                           
      dimension fam051(2,11),fam052(2,11), fam053(2,11), fam054(2,11)           
c Beginning with 1995 , part of most types of pension and                       
c retirement income is excluded from tax by Kentucky.                           
c     Year            Percent          Up to                                    
c                     excluded       Maximum of                                 
c     1995               25            $6250                                    
c     1996               50            $12500                                   
c     1997               75            $18750                                   
c     1998               100           $35000                                   
c     1999               100           $35700                                   
c     2000               100           $36414                                   
c     2001               100           $37500                                   
c     2002               100           $38775                                   
c     2003               100           $39400                                   
c     2004               100           $40200                                   
c     2005-2017          100           $41110                                   
c     2018-2021         100           $31110                                    
      dimension aif92(1992:2017),aiff1(2005:2021),aiff2(2005:2021),             
     &aiff3(2005:2021),aiff4(2005:2021),aif13(2013:2017)                        
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data aif92/                                                               
     &           1.0525d0, 1.0845d0, 1.118d0,  1.1470d0, 1.1795d0,              
     &           1.2120d0, 1.2450d0, 1.266d0,  1.2895d0, 1.3295d0,              
     &           1.3730d0, 1.3950d0, 1.427d0,  1.4595d0, 1.5050d0,              
     &           1.5640d0, 1.5995d0, 1.668d0,2*1.6955d0, 1.7365d0,              
     &           1.7815d0, 1.8115d0, 1.840d0,  1.8485d0, 1.8635d0/              
      data aiff1/                                                               
     &              1.0d0,1.024d0,1.067d0,1.087d0,2*1.132d0,1.138d0,            
     &     1.1567d0, 1.2d0, 1.220d0,1.230d0,1.2413793d0,1.260188d0,             
     &     1.2685475d0,1.305d0,1.333d0,1.346d0/                                 
      data aiff2/                                                               
     &              1.0d0,1.029d0,1.067d0,1.091d0,2*1.136d0,1.1465d0,           
     &     1.179d0, 1.2d0, 1.226d0,1.242d0,1.248636d0,1.2657833d0,              
     &     1.2829306d0,1.318d0,1.344d0,1.358d0/                                 
      data aiff3/                                                               
     &              1.0d0,1.0317d0,1.067d0,1.0938d0,2*1.138d0,1.1516d0,         
     &     1.1865d0,1.214d0, 1.23d0 ,1.249d0,1.2529521d0,1.2691112d0,           
     &     1.2914853d0,1.326d0,1.3499d0,1.365d0/                                
      data aiff4/                                                               
     &              1.0d0,1.0336d0,1.067d0,1.0996d0,2*1.13953d0,1.155d0,        
     &     1.191d0,1.217d0, 1.23d0 ,1.253d0,1.2558139d0,1.2713178d0,            
     &     1.2971d0,1.331d0,1.354d0,1.369d0/                                    
      data tab/                                                                 
     &           3000.0d0,2.0d0,4000.0d0,3.0d0,5000.0d0,4.0d0,                  
     &           8000.0d0,5.0d0,   1.e20,6.0d0/                                 
      data tab05/                                                               
     &           3000.0d0,2.0d0, 4000.0d0,3.0d0,5000.0d0,4.0d0,                 
     &           8000.0d0,5.0d0,75000.0d0,5.80d0,  1.e20,6.0d0/                 
      data retire/                                                              
     1           6250.0d0, 12500.0d0, 18750.0d0, 35000.0d0, 35700.0d0,          
     1          36414.0d0, 37500.0d0, 38775.0d0, 39400.0d0, 40200.0d0,          
     1        13*41110.0d0,4*31110.d0,                                          
     2               .25d0,     .5d0,      .75d0,  24*1.0d0/                    
c contains rates and limits for non-itemizer charitable deduction               
      data ch/                                                                  
     &           3*.25d0, 2*.5d0,  2*50.0d0, 75.0d0,  2*1.e20/                  
      data ded/                                                                 
     &        20* 650.0d0,  900.0d0, 1200.0d0, 1500.0d0, 1700.0d0,              
     &           1750.0d0, 1800.0d0, 1830.0d0, 1870.0d0, 1910.0d0,              
     &           1970.0d0, 2050.0d0, 2100.0d0, 2190.0d0, 2210.0d0,              
     &           2240.0d0, 2290.0d0, 2360.0d0, 2400.0d0, 2440.0d0,              
     &           2460.0d0, 2480.0d0, 2530.0d0, 2590.0d0, 2650.0d0,              
     &           2690.0d0/                                                      
      data fam051 /                                                             
     &            9570.0d0, 1.0d0, 9953.0d0, .9d0, 10336.0d0, .8d0,             
     &           10718.0d0, .70d0,11101.0d0, .6d0, 11484.0d0, .5d0,             
     &           11867.0d0, .40d0,12154.0d0, .3d0, 12441.0d0, .2d0,             
     &           12728.0d0, .10d0,    1.e20, .0d0/                              
      data fam052 /                                                             
     &           12830.0d0, 1.0d0,13343.0d0, .9d0, 13856.0d0, .8d0,             
     &           14370.0d0, .70d0,14883.0d0, .6d0, 15396.0d0, .5d0,             
     &           15909.0d0, .40d0,16294.0d0, .3d0, 16679.0d0, .2d0,             
     &           17064.0d0, .10d0,    1.e20, .0d0/                              
      data fam053 /                                                             
     &           16090.0d0, 1.0d0,16734.0d0, .9d0, 17377.0d0, .8d0,             
     &           18021.0d0, .70d0,18664.0d0, .6d0, 19308.0d0, .5d0,             
     &           19952.0d0, .40d0,20434.0d0, .3d0, 20917.0d0, .2d0,             
     &           21400.0d0, .10d0,    1.e20, .0d0/                              
      data fam054 /                                                             
     &           19350.0d0, 1.0d0,20124.0d0, .9d0, 20898.0d0, .8d0,             
     &           21672.0d0, .70d0,22446.0d0, .6d0, 23220.0d0, .5d0,             
     &           23994.0d0, .40d0,24575.0d0, .3d0, 25155.0d0, .2d0,             
     &           25736.0d0, .10d0,    1.e20, .0d0/                              
      data gap1 /                                                               
     &            9570.0d0,  0.d0, 9953.0d0, 11.d0, 10336.0d0, 20.d0,           
     &           10718.0d0, 29.d0,11101.0d0, 37.d0, 11484.0d0, 45.d0,           
     &           11867.0d0, 51.d0,12154.0d0, 58.d0, 12441.0d0, 64.d0,           
     &           12728.0d0, 69.d0,    1.e20, .0d0/                              
      data gap2 /                                                               
     &           12830.0d0,  0.d0,13343.0d0,  7.d0, 13856.0d0, 13.d0,           
     &           14370.0d0, 18.d0,14883.0d0, 22.d0, 15396.0d0, 24.d0,           
     &           15909.0d0, 26.d0,16294.0d0, 27.d0, 16679.0d0, 28.d0,           
     &           17064.0d0, 28.d0,    1.e20, .0d0/                              
      data gap3 /                                                               
     &           16090.0d0, 0.d0,16734.0d0, 3.d0, 17377.0d0, 6.d0,              
     &           18021.0d0, 6.d0,18664.0d0, 6.d0, 19308.0d0, 4.d0,              
     &           19952.0d0, 0.d0,20434.0d0, 0.d0, 20917.0d0, 0.d0,              
     &           21400.0d0, 0.d0,    1.e20, .0d0/                               
      excli=.15*twn(data(14)-data(57),0.0d0,450*data(7))                        
      fedtax=max(0.0d0,comnew(1)-comnew(175)-                                   
     & max(0.0d0,comnew(70)-comnew(28)))                                        
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      phas92 = 100000.d0/sep                                                    
      if(law.ge.1992.and.law.le.2017) phas92 = 100000.*aif92(law)/sep           
c      if(law.ge.2013)                                                          
c     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                    
c     AGI                                                                       
c ky agi becomes more like fed agi in 1990                                      
c self-employed health ins deduction is an addition to federal agi              
      addit=data(124)                                                           
      subtra=data(22)                                                           
      if(law.eq.1990) subtra=subtra+comnew(1)                                   
      if(law.le.1989) agi=comnew(2)-fedtax-xif(law.eq.1985,excli)               
      if(law.ge.1990) agi=comnew(2)+addit-subtra                                
c 2009 KY has not adopted federal $2400 for unemployment                        
      if(law.eq.2009.or.law.eq.2020) agi = agi - comnew(78) + data(82)          
      if(law.eq.2020.and.comnew(26).lt.1.d0)                                    
     & agi = agi + min(300.d0,data(58))                                         
      if(law.ge.1984) agi=agi-comnew(79)                                        
c fed also has $100 dividend exclusion before 1986;                             
c ky keeps after 86 through 1989                                                
      if(law.ge.1987.and.law.le.1989) agi=agi-divexc(data,comnew,law)           
      if(law.le.1997) agi=agi-twn(data(12),0.0d0,100.*data(7))                  
      if(law.ge.1982.and.law.le.1986)agi=agi+comnew(32)                         
c ira contributions are not subject to federal limits after 1986                
      if(law.ge.1987)agi=agi-max(data(29),0.0d0)                                
c Retirement income exclusion                                                   
      retexc = 0.                                                               
      if(law.ge.1995) retexc =                                                  
     & min(retire(law,2)*(data(20)+data(72)),retire(law,1))                     
      agi = agi - retexc                                                        
c 1987-1989 KY gives a 60% exclusion for long term capital gains                
      if(law.ge.1987.and.law.le.1989.and.comnew(6).gt.0) then                   
        agi = agi - .6*max(0.0d0,min(data(70),data(70)+data(60)))               
      endif                                                                     
c Deductions                                                                    
c Standard deduction                                                            
      stded = ded(law)*data(7)                                                  
c     if(law.ge.1997) stded=2*ded(law)                                          
      if(law.ge.1982.and.law.le.1986) then                                      
        char=data(58)+data(59)                                                  
        stded=stded+min(char*ch(law,1),ch(law,2))                               
      endif                                                                     
c Itemized Deduction                                                            
      if(law.le.2017) then                                                      
        xitded=max(0.d0,comnew(30)-data(50))                                    
        if(agi.gt.phas92.and.law.ge.1991.and.law.le.2017) then                  
          reduce = min(.8*xitded,.03*(agi-phas92))                              
          if(law.ge.2006.and.law.le.2007) reduce = 2*reduce/3                   
          if(law.ge.2008.and.law.le.2009) reduce = reduce/3                     
          if(law.eq.2010.and.law.le.2012) reduce = 0.d0                         
          xitded = xitded-reduce                                                
        endif                                                                   
        if(law.le.1989)then                                                     
          child=0                                                               
          ytest=agi+fedtax                                                      
          if(ytest.le.44600.) then                                              
            if(data(8).gt.0..and.data(8).lt.2.) then                            
              child=min(2400.0d0,comnew(53))                                    
            else if(data(8).gt.1.and.data(8).lt.3.) then                        
              child=min(3600.0d0,comnew(53))                                    
            else if(data(8).gt.2.) then                                         
              child=min(4800.0d0,comnew(53))                                    
            endif                                                               
            if(ytest.ge.35000.)child=max(0.0d0,child-((ytest-35000)/2.))        
          endif                                                                 
          xitded=xitded+child                                                   
        endif                                                                   
      else if(law.ge.2018) then                                                 
        xitded = data(56) + comnew(23)+data(66)                                 
      endif                                                                     
      ided = int(data(4))                                                            
      if(ided.eq.-2.and.law.eq.1999) xitded=0                                   
      deduc=max(stded,xitded)                                                   
c   ignore additional deduc. for separate returns w/ dep. spouse y=0.           
c Taxable Income                                                                
      taxinc=max(0.0d0,agi-deduc)                                               
      if(mst.eq.2.and.agi.gt.0.and.law.le.2017) then                            
           agih = max(data(85),data(86))+.5*(agi - data(11))                    
           agiw = agi-agih                                                      
           xitdh = xitded*agih/agi                                              
           xitdw = xitded-xitdh                                                 
           dedh = max(stded,xitdh)                                              
           dedw = max(stded,xitdw)                                              
           taxinh=max(0.0d0,agih-dedh)                                          
           taxinw=max(0.0d0,agiw-dedw)                                          
      endif                                                                     
      if(law.le.2004) then                                                      
        call look(tab,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                    
        if(mst.eq.2.and.agi.gt.0) then                                          
           call look(tab,taxinh,5,n,stath,1.0d0,0.0d0,rt,data)                  
           call look(tab,taxinw,5,n,statw,1.0d0,0.0d0,rt,data)                  
           statax = min(statax,stath+statw)                                     
        endif                                                                   
      else if(law.ge.2005.and.law.le.2017) then                                 
         call look(tab05,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                 
         if(mst.eq.2.and.agi.gt.0) then                                         
           call look(tab05,taxinh,6,n,stath,1.0d0,0.0d0,rt,data)                
           call look(tab05,taxinw,6,n,statw,1.0d0,0.0d0,rt,data)                
           statax = min(statax,stath+statw)                                     
        endif                                                                   
      else if(law.ge.2018) then                                                 
c TAX RATE?For 2018+, the individual income tax rate is a flat 5%.              
         statax = .05d0*taxinc                                                  
      endif                                                                     
      gcred = 0.                                                                
      lowcrd = 0.                                                               
      chcr = 0.                                                                 
      credit = 0.                                                               
      if(law.le.1989) then                                                      
        if(law.ge.1984.and.law.le.1986)  credit=min(data(38),1500.0d0)          
        statax=max(statax-credit,0.0d0)                                         
      else                                                                      
c elderly and blind get 2 credits for each condition (Personal Credits)         
        if(law.lt.2004) then                                                    
           count=int(data(7)+data(8)+2.d0*(data(9)+data(10)))                           
           gcred=20.*count                                                      
        else if(law.ge.2014.and.law.le.2017) then                               
           gcred = 10.d0*(data(7) + data(8)) + 40.d0*(data(9)+data(10))         
        else if(law.ge.2018) then                                               
c 2018+ PERSONAL TAX CREDITS?if you are 65 or over, blind.                      
c All other personal tax credits were repealed.                                 
           gcred = 4*(data(9)+data(10))*10.d0                                   
        endif                                                                   
        statax=max(statax-gcred,0.0d0)                                          
c low income credit                                                             
        chcr = comnew(176)*.2                                                   
        if(law.ge.1990.and.law.le.2004) then                                    
             if(agi.le.5000.)lowcrd=statax*1.                                   
             if(agi.gt.5000..and.agi.le.10000.)lowcrd=statax*.5                 
             if(agi.gt.10000..and.agi.le.15000.)lowcrd=statax*.25               
             if(agi.gt.15000..and.agi.le.20000.)lowcrd=statax*.15               
             if(agi.gt.20000..and.agi.le.25000.)lowcrd=statax*.05               
             credit=chcr+lowcrd                                                 
             statax=max(statax-credit,0.0d0)                                    
             credit = credit + gcred                                            
        elseif(law.ge.2005) then                                                
c Family Size Credit  and Personal tax credit 2005+                             
c You may qualify for the Family Size Tax Credit even if you are claimed as a de
             famcr = 0.                                                         
             perc = 0.                                                          
             num = int(min(data(7)+data(8)+data(9),4.0d0))                           
             modagi = max(agi,comnew(2))                                        
             if(num.eq.1) perc=tablki(fam051,11,modagi/aiff1(law),data)         
             if(num.eq.2) perc=tablki(fam052,11,modagi/aiff2(law),data)         
             if(num.eq.3) perc=tablki(fam053,11,modagi/aiff3(law),data)         
             if(num.eq.4) perc=tablki(fam054,11,modagi/aiff4(law),data)         
             famcr = statax * perc                                              
c 2019-2020 Income Gap Tax Credit for taxpayers who are eligible for Family tax 
c and have family size of three or less                                         
             gapcr = 0.d0                                                       
             if((law.ge.2019.and.law.le.2020).and.famcr.gt.0.d0) then           
              if(num.eq.1) gapcr=tablki(gap1,11,modagi/aiff1(law),data)         
              if(num.eq.2) gapcr=tablki(gap2,11,modagi/aiff2(law),data)         
              if(num.eq.3) gapcr=tablki(gap3,11,modagi/aiff3(law),data)         
             endif                                                              
             credit = credit + famcr + chcr + gcred + gapcr                     
             statax = max(0.0d0,statax - famcr - chcr)                          
        endif                                                                   
      endif                                                                     
      return                                                                    
      end                                                                       
c  LOUISIANA                                                                 
c  State 20                                                                  
c     Updated through 2021 (updated 03/13/2022)                                 
c                                                                               
      subroutine latax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common /fed/ zbrack(3,1987:2022),exem(1987:2022)                          
      dimension data(255),comnew(255),tab77(2,3),eicr(2008:2021)                
      dimension tab80(2,3),stxmp(1977:2021,2),xmpd(1977:2021)                   
c      real tab83(2,3)                                                          
      dimension tab83s(2,5), tab83m(2,5),tab03m(2,3),tab03s(2,3),               
     &tab03h(2,3),tab02h(2,3),tab09m(2,3),tab09s(2,3),tab09h(2,3)               
      integer txp,sep                                                           
      data eicr/11*.035d0,3*.05d0/                                              
      data tab77/                                                               
     &          7500.0d0, 2.0d0,50000.0d0, 4.0d0,1.e20, 6.0d0/                  
      data tab80/                                                               
     &         10000.0d0, 2.0d0,50000.0d0, 4.0d0,1.e20, 6.0d0/                  
      data tab83s/                                                              
     &          5000.0d0, 2.0d0, 6000.0d0, 3.3d0, 45000.0d0, 4.0d0,             
     &         46000.0d0, 5.3d0,    1.e20, 6.0d0/                               
      data tab83m/                                                              
     &         10500.0d0, 2.0d0,11500.0d0, 3.3d0, 90500.0d0, 4.0d0,             
     &         91500.0d0, 5.3d0,    1.e20, 6.0d0/                               
      data tab03m/                                                              
     &         16000.0d0, 2.0d0,41000.0d0, 4.0d0,     1.e20, 6.0d0/             
      data tab09m/                                                              
     &         16000.0d0, 2.0d0,91000.0d0, 4.0d0,     1.e20, 6.0d0/             
      data tab03s/                                                              
     &          8000.0d0, 2.0d0,20000.0d0, 4.0d0,     1.e20, 6.0d0/             
      data tab09s/                                                              
     &          7500.0d0, 2.0d0,45500.0d0, 4.0d0,     1.e20, 6.0d0/             
      data tab03h/                                                              
     &          3750.0d0, 2.0d0,17000.0d0, 4.0d0,     1.e20, 6.0d0/             
      data tab09h/                                                              
     &          3500.0d0, 2.0d0,41000.0d0, 4.0d0,     1.e20, 6.0d0/             
      data tab02h/                                                              
     &          2000.0d0, 2.75d0,41000.0d0,4.0d0,     1.e20, 6.0d0/             
c Louisiana combines standard deduction and exemptions                          
      data stxmp/                                                               
     &             3*3500.0d0,3* 6000.0d0,39*4500.0d0,                          
     &             3*6000.0d0,3*12000.0d0,39*9000.0d0/                          
      data xmpd/                                                                
     &             3*400.0d0,42*1000.0d0/                                       
      rt=0.                                                                     
      mst=int(data(2))                                                               
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
c AGI                                                                           
      agi = comnew(2)                                                           
c Annual retirement income exemption for taxpayers 65 and over.                 
      penexc = 0.                                                               
      if(law.ge.1981)penexc = twn(data(20)+data(72),0.0d0,6000.*data(9))        
c Taxable social security benefits                                              
      ssi = 0                                                                   
      if(law.ge.1985) ssi = comnew(79)                                          
      subtr = ssi + penexc                                                      
c      write(0,*) 'ssi penexc',ssi,penexc                                       
c federal tax applicable to exempt income Schedule E                            
      ftadd = 0                                                                 
      fedtax = comnew(1)                                                        
c c186 - CARES stimulus package                                                 
      if(law.ge.2020) fedtax=comnew(1)+comnew(186)                              
      if(comnew(2).gt.0.d0.and.fedtax.gt.0.d0.and.subtr.gt.0.d0)then            
         if(subtr.le.50000.d0) then                                             
           ftadd1 = .25*max(0.d0,subtr-15000.d0)                                
         else                                                                   
           ftadd1 = 8750.d0 + .4*(subtr - 50000.d0)                             
         endif                                                                  
         perc = min(1.d0,subtr/comnew(2))                                       
         ftadd2 = fedtax*perc                                                   
         ftadd = min(ftadd1,ftadd2)                                             
      endif                                                                     
c (subtr-ftadd) <-- exempt income                                               
c      write(0,*) 'agi subtr ftadd',agi,subtr,ftadd                             
      agi = agi - (subtr - ftadd)                                               
      deduc = 0.                                                                
      ided = int(data(4))                                                            
      if(ided.eq.-2.and.law.eq.1999) comnew(26)=0.                              
c Excess federal Itemized deductions                                            
      if(comnew(26).gt.0.and.law.ge.1980) then                                  
        if(mst.eq.1) then                                                       
          nfile = 1                                                             
        else if(mst.eq.4.or.mst.eq.7) then                                      
          nfile = 3                                                             
        else                                                                    
          nfile = 2                                                             
        endif                                                                   
        if(law.ge.1987) then                                                    
           fedbas = zbrack(nfile,law)/sep                                       
        else                                                                    
           fedbas = comnew(3)                                                   
        endif                                                                   
        if((law.ge.1980.and.law.le.1999).or.law.ge.2009) then                   
              deduc = max(0.0d0,comnew(24)-fedbas)                              
        else if(law.ge.2000.and.law.le.2001) then                               
              deduc = .5*max(0.0d0,comnew(24)-fedbas)                           
        else if(law.eq.2002) then                                               
              deduc = .57*max(0.0d0,comnew(24)-fedbas)                          
        else if(law.eq.2007) then                                               
              deduc = .575*max(0.0d0,comnew(24) - fedbas)                       
        else if(law.eq.2008) then                                               
              pded = 0.d0                                                       
              if(data(51).gt.0) pded = min(500.*data(7),data(51))               
              deduc = .65 *max(0.0d0,comnew(24) - (fedbas+pded))                
        endif                                                                   
      endif                                                                     
c Federal income tax deduction                                                  
      if(law.le.1979) then                                                      
         fedtax = max(0.0d0,comnew(28))                                         
c      else if (law.eq.2020) then                                               
c         fedtax = max(0.0d0,comnew(1))                                         
      else                                                                      
         fedtax = (max(0.0d0,comnew(52)-comnew(58))+comnew(70))                 
      endif                                                                     
      taxinc = max(0.0d0,agi - deduc - fedtax)                                  
c      write(0,*) '1taxinc agi deduc fedtax',taxinc,agi,deduc,fedtax            
c Exemptions                                                                    
c      txp = data(7)                                                            
c      if(mst.eq.4.or.mst.eq.7) txp = data(7)+1                                 
      txp = 1                                                                   
      if(mst.eq.2.or.mst.eq.4.or.mst.eq.7) txp = 2                              
      taxinc = max(0.0d0,taxinc - stxmp(law,txp))                               
      exemp = stxmp(law,txp)                                                    
c      write(0,*) '2taxinc exemp', taxinc,exemp                                 
c tax calculation                                                               
      if(law.ge.1977.and.law.le.1979) then                                      
           call look(tab77,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)              
      else if(law.ge.1980.and.law.le.1982) then                                 
           call look(tab80,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)              
      else                                                                      
         if(mst.eq.1.or.sep.eq.2) then                                          
          if(law.le.2002)                                                       
     &  call look(tab83s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
          if(law.ge.2003.and.law.le.2008)                                       
     &  call look(tab03s,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                
          if(law.ge.2009)                                                       
     &  call look(tab09s,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                
         statax=max(0.0d0,                                                      
     &  statax-.02*xmpd(law)*(data(8)+data(9)+data(10)))                        
         else if(mst.eq.2.or.mst.eq.5) then                                     
          if(law.le.2002)                                                       
     &  call look(tab83m,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
          if(law.ge.2003.and.law.le.2008)                                       
     &  call look(tab03m,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                
           if(law.ge.2009)                                                      
     &  call look(tab09m,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                
         statax=max(0.0d0,                                                      
     &  statax-.02*xmpd(law)*(data(8)+data(9)+data(10)))                        
         else                                                                   
c 1983-2002 ,hoh                                                                
          if(law.le.2002) then                                                  
           call look(tab02h,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)             
           statax=max(0.0d0,                                                    
     &     statax-xmpd(law)*(.02*min(1.0d0,data(8)+data(9)+data(10))+           
     & .04*max(0.0d0,data(8)+data(9)+data(10)-1)))                              
          endif                                                                 
c 2003+ , hoh                                                                   
          if(law.ge.2003) then                                                  
           if(law.le.2008)                                                      
     & call look(tab03h,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                 
           if(law.ge.2009)                                                      
     & call look(tab09h,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                 
           statax=max(0.0d0,                                                    
     &     statax-xmpd(law)*(.02*min(3.0d0,data(8)+data(9)+data(10))+           
     & .03*min(1.0d0,max(0.0d0,data(8)+data(9)+data(10)-4))+                    
     & .04*max(0.0d0,data(8)+data(9)+data(10)-5)))                              
          endif                                                                 
         endif                                                                  
      endif                                                                     
c Credits                                                                       
c credit for child education                                                    
      edcr=0.                                                                   
      if(((law.ge.1979.and.law.le.1985).or.                                     
     &    (law.ge.1996.and.law.le.1999)).and.data(8).ge.1) then                 
       edcr=25*data(8)                                                          
      endif                                                                     
      if((law.eq.2015.or.law.eq.2016).and.data(8).ge.1) edcr=18*data(8)         
c 2017+ education credit is no longer available                                 
c 10% of federal credits given                                                  
      if(law.le.1979) then                                                      
         fedcr=0.                                                               
      else                                                                      
         fedcr=.1*(data(34)+comnew(53)+comnew(54))                              
      endif                                                                     
      if(law.ge.1986)fedcr=min(fedcr,25.0d0)                                    
c credits for blindness and other disabilties                                   
      bcr=data(10)*100.                                                         
c child care credit since 2003                                                  
      chcr = 0.                                                                 
      chcref = 0.                                                               
      if(law.ge.2003) then                                                      
        base = max(0.0d0,comnew(2))                                             
        if(base.le.25000) chcref = .5*comnew(53)                                
        if(base.gt.25000.and.base.le.35000) chcr = .3*comnew(53)                
        if(base.gt.35000.and.base.le.60000) chcr = .1*comnew(53)                
        if(base.gt.60000) chcr = min(.1*comnew(53),25.0d0)                      
      endif                                                                     
c credits can not exceed tax amounts - non-refundable                           
      credit = fedcr+edcr+bcr+chcr                                              
      statax=max(statax-credit,0.0d0)                                           
c Earned income credit --  refundable and  since 2008                           
      earncr = 0.                                                               
      if(law.ge.2008) earncr = eicr(law) * comnew(59)                           
      credit = credit + earncr + chcref                                         
      statax = statax - earncr - chcref                                         
c1     format(1x,10f8.0)                                                        
c next line is only for chcr comparison                                         
      if(law.ge.2003.and.chcref.gt.0) chcr = chcref                             
      return                                                                    
      end                                                                       
c  MAINE                                                                        
c  State 20                                                                     
c                                                                               
c  Updated through 2021 (updated on 03.13.2022)                                 
      subroutine metax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/temp/count                                                         
      integer txp,sep                                                           
      dimension data(255), comnew(255), std(7),aif93(1993:2012)                 
      dimension xmp(1977:2021),hylim(1977:1994,2),child(1977:2021)              
     &,aif17(2017:2021),xmp18(2018:2021)                                        
c     real yindx(3),fed(7),aif(1977:1993)                                       
      dimension tab88(2,4),tab89(2,4),tab91(2,5),eicr(2000:2021)                
      dimension tab(2,8),tab93(2,4),tab13(2,3),tab16(2,3),tab17(2,3),           
     & stdm(2003:2017), old(2003:2017),olds(2016:2017),xitd(2013:2021),         
     & tab77(2,8)                                                               
c no need to make a change in stdm in 2012 because state std = federal std      
      dimension pended(2000:2021),sft(1:3,2016:2021),sfcr(1:4,2016:2021)        
      double precision mxmp(2,3), sxmp(2,3), hxmp(2,3),iratax                   
      data eicr/3*.05d0,3*.0492d0,3*.05d0,2*.04d0,9*.05d0,.12d0,.2d0/           
      data aif17/1.d0, 1.015d0, 1.035d0, 1.052d0, 1.063d0/                      
      data xmp18/1.d0, 1.018d0,1.03625d0,1.048125d0/                            
      data sft/20000.d0,30000.d0,40000.d0,                                      
     7         20050.d0,30100.d0,40100.d0,                                      
     8         20350.d0,30550.d0,40750.d0,                                      
     9         20750.d0,31100.d0,41500.d0,                                      
     &         21100.d0,31650.d0,42200.d0,                                      
     1         21350.d0,32000.d0,42700.d0/                                      
      data sfcr/  100.d0,140.d0,160.d0,180.d0,                                  
     7            125.d0,175.d0,200.d0,225.d0,                                  
     8            125.d0,175.d0,200.d0,225.d0,                                  
     9            125.d0,175.d0,200.d0,225.d0,                                  
     &            125.d0,180.d0,205.d0,230.d0,                                  
     1            130.d0,180.d0,205.d0,235.d0/                                  
      data pended/14*6000.d0,8*10000.d0/                                        
      data xitd/27500.d0,27950.d0,28350.d0,28450.d0,28600.d0,29050.d0,          
     & 29550.d0,30050.d0,30400.d0/                                              
      data aif93/                                                               
     &        9*1.0375d0,1.05d0  ,1.0625d0,1.0875d0,1.125d0,                    
     &          1.1375d0,1.1875d0,1.2125d0,1.2625d0,1.2375d0,                   
     &          1.25d0  ,1.275d0 /                                              
c Standard Deductions for married couples 2003+                                 
      data stdm/                                                                
     &        7950.d0, 8150.d0, 8300.d0, 8600.d0, 8900.d0,                      
     &        9100.d0, 9500.d0, 9550.d0, 9650.d0,2*10150.d0,                    
     &       12400.d0,12600.d0,2*23200.d0/                                      
      data old/4*1000.d0,2*1050.d0,2*1100.d0,1150.d0,3*1200.d0,                 
     &         3*1250.d0/                                                       
      data olds/2*1550.d0/                                                      
c 1977 year                                                                     
      data tab77/2000.d0,1.d0,4000.d0,2.d0,6000.d0,4.d0,8000.d0,6.d0,           
     & 10000.d0,7.d0,15000.d0,8.d0,25000.d0,9.d0,1.e20,10.d0/                   
c 1988 year                                                                     
      data tab88/6000.d0,2.d0,10000.d0,4.d0,16250.d0,6.d0,1.e20,8.0d0/          
c 1989-1990 years                                                               
      data tab89/4000.d0,2.d0,8000.d0,4.5d0,16000.d0,7.d0,1.e20,8.5d0/          
c 1991-1992 years                                                               
      data tab91/4150.d0,2.1d0,8250.d0,4.725d0,16500.d0,7.35d0,                 
     & 37500.d0,8.925d0,1.e20,9.89d0/                                           
c 1993 +                                                                        
      data tab93/4000.d0,2.d0,8000.d0,4.5d0,16000.d0,7.d0,1.e20,8.5d0/          
c 2013                                                                          
      data tab13 / 5200.0d0, 0.0d0,  20900.0d0, 6.5d0, 1.e20, 7.95d0/           
c 2016                                                                          
      data tab16 /21050.0d0, 5.8d0,  37500.0d0, 6.75d0, 1.e20, 7.15d0/          
c 2017                                                                          
      data tab17 /21100.0d0, 5.8d0,  50000.0d0, 6.75d0, 1.e20, 7.15d0/          
c                                                                               
      data mxmp/ 40000.0d0, 55.0d0, 50000.0d0, 65.0d0, 1.e20, 30.0d0/           
      data sxmp/ 20000.0d0, 55.0d0, 25000.0d0, 65.0d0, 1.e20, 30.0d0/           
      data hxmp/ 30000.0d0, 55.0d0, 37500.0d0, 65.0d0, 1.e20, 30.0d0/           
      data std/60.0d0,100.0d0,50.0d0,88.0d0,100.0d0,50.0d0,88.0d0/              
      data xmp /                                                                
     &          1000.0d0, 1200.0d0,9*1000.0d0,     .0d0, 4*2000.0d0,            
     &        4*2100.0d0, 2150.0d0,  2400.0d0, 2750.0d0,13*2850.0d0,            
     &        5*0.d0,4150.d0,4200.d0,2*4300.d0/                                 
c    *** missing values for 85, 86 and 89: guessed                              
      data hylim/4500.0d0, 3*5000.0d0, 5600.0d0, 3*6200.0d0,                    
     & 3*7400.0d0,7*0.0d0, 5000.0d0, 3*6000.0d0, 6700.0d0,                      
     & 3*7400.0d0,3*9200.0d0,7*0.0d0/                                           
      data child/9*.15d0,.16d0,.2d0,15*.25d0,3*.215d0,16*.25d0/                 
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      txp=int(twn(data(7),1.0d0,2.0d0))                                              
c zero bracket amount for itemized deductions; 1988 law                         
      rt=0.                                                                     
c AGI                                                                           
      agi=comnew(2)                                                             
      if(law.ge.1979)agi=agi-data(22)                                           
      if(law.ge.1981)agi=agi-xjobs(data,law)                                    
c fed and maine have different div and int exclusions in 1981                   
      if(law.eq.1981) then                                                      
        agi=agi+divexc(data,comnew,law)                                         
        agi=agi-min(data(12),100.*data(7))                                      
      endif                                                                     
c Social Security benefits are not taxable in Maine                             
      if(law.ge.1984)agi=agi-comnew(79)                                         
c New in 2000 : Pension Benefits Income Deduction up to $6000                   
c for taxpayer and his spouse; 2014+ up to $10000                               
      if(law.ge.2000)  agi = agi -                                              
     & min(data(20)+data(72),max(0.0d0,pended(law)*txp-data(91)))               
c Standard Deductions and Exemptions                                            
      if(law.le.1982) then                                                      
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         stded=twn(.16*agi,1700.0d0,2400.0d0)                                   
        else                                                                    
         stded=twn(.16*agi,2100.0d0/sep,2800.0d0/sep)                           
        endif                                                                   
      else if(law.ge.1983.and.law.le.1987) then                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         stded=twn(.16*agi,1700.0d0,2500.0d0)                                   
        else if(mst.eq.2.or.mst.eq.5) then                                      
         stded=twn(.16*agi,2100.0d0,2900.0d0)                                   
        elseif(mst.eq.3.or.mst.eq.6) then                                       
         stded=twn(.16*agi,1100.0d0,1400.0d0)                                   
        endif                                                                   
      else if(law.eq.1988) then                                                 
c in 1988, the standard deduction becomes a credit                              
        stded=0.                                                                
      else                                                                      
        stded=comnew(3)                                                         
        if((law.ge.2003.and.law.le.2011).or.                                    
     &          (law.ge.2013.and.law.le.2017)) then                             
         if(mst.eq.5.or.mst.eq.2.or.sep.eq.2)                                   
     &     stded = stdm(law)/sep+(data(9)+data(10))*old(law)                    
        endif                                                                   
        if(law.ge.2016.and.law.le.2017) then                                    
          if(mst.eq.4.or.mst.eq.7)                                              
     &    stded = 17400+(data(9)+data(10))*olds(law)                            
          if(mst.eq.1) stded = 11600+(data(9)+data(10))*olds(law)               
        endif                                                                   
      endif                                                                     
c  no income taxes from ANY jurisdiction are allowed as itemized deds           
c  eventually decided not to subtract data(55)                                  
c Itemized Deductions                                                           
      if(comnew(26).gt.0.and.comnew(30).gt.0.d0) then                           
       if(law.le.1988) then                                                     
         xitded=max(0.d0,comnew(24)-data(50))                                   
c  since everyone takes the standard credit, must subtract                      
c  standard deduc from itemized deducs in 1988                                  
         if(law.eq.1988) xitded=max(0.0d0,xitded- comnew(3))                    
       else if(law.ge.1989.and.law.le.2012) then                                
          xitded=max(0.0d0,comnew(24)-data(50))                                 
       else if(law.ge.2013) then                                                
          statit = data(50)-data(50)*(comnew(30)-comnew(24))/comnew(30)         
          xitded = min(xitd(law),max(0.d0,comnew(24) - statit))                 
       endif                                                                    
       deduc = max(stded,xitded)                                                
      else                                                                      
       deduc = stded                                                            
      endif                                                                     
      if(law.ge.2016.and.law.le.2017) then                                      
c Phase out of standard/itemized deductions for 2016 and 2017                   
        if(mst.eq.4.or.mst.eq.7) then                                           
          phased = 105000.d0                                                    
          thrsh = 112500.d0                                                     
        else                                                                    
          phased = 70000*max(1.d0,data(7))                                      
          thrsh = 75000*max(1.d0,data(7))                                       
        endif                                                                   
        if(agi.gt.phased)                                                       
     &  deduc = max(0.0d0,deduc - deduc*(agi-phased)/thrsh)                     
      endif                                                                     
      if(law.ge.2018) then                                                      
c Phase out of standard/itemized deductions for 2018                            
         phased = filing(mst,80000.,160000.,120000.,80000.)*xmp18(law)          
         if(agi.ge.phased) then                                                 
           xl4 = filing(mst,75000.,150000.,112500.,75000.)                      
           deduc = deduc*(1.d0 - min(1.d0,(agi - phased)/xl4))                  
         endif                                                                  
      endif                                                                     
c  Exemptions                                                                   
c  exemptions are a credit in 1988; xmp(1988)=0                                 
      if(law.le.2012) then                                                      
         exemp=comnew(68)*xmp(law)+xif(law.eq.1988,((data(9)+data(10))          
     &    *xmp(law)))                                                           
      else if(law.ge.2013.and.law.le.2017) then                                 
         exemp = comnew(83)                                                     
      else if(law.ge.2018) then                                                 
         exemp = xmp(law)*txp                                                   
         phasex = filing(mst,266700.,320000.,293350.,160000.)*xmp18(law)        
         if(agi.gt.phasex) then                                                 
         exemp = exemp*(1.d0 - min(1.d0,(agi - phasex)/(125000.d0/sep)))        
         endif                                                                  
         if(data(105).gt.0.d0) exemp = 0.d0                                     
      endif                                                                     
      taxinc = max(0.0d0,agi - deduc - exemp)                                   
c before 1978, heads of household are taxed at the single rate                  
      if(law.ge.1977.and.law.le.1987) then                                      
         do 1000 i=1,8                                                          
         do  999 j=1,2                                                          
            tab(j,i) = tab77(j,i)                                               
999      continue                                                               
1000     continue                                                               
      endif                                                                     
      if(law.le.1987.and.law.ge.1978) then                                      
          if(law.eq.1978) then                                                  
             tab(2,3) = 3.5                                                     
             tab(2,7) = 9.1                                                     
          else if(law.ge.1979.and.law.le.1982) then                             
             tab(2,3) = 3.                                                      
             tab(2,7) = 9.2                                                     
          else if(law.eq.1983) then                                             
             tab(2,3) = 3.                                                      
             tab(2,4) = 5.85                                                    
             tab(2,5) = 6.85                                                    
             tab(2,6) = 7.96                                                    
             tab(2,7) = 9.16                                                    
          else if(law.eq.1984) then                                             
             tab(2,2) = 1.975                                                   
             tab(2,3) = 2.95                                                    
             tab(2,4) = 5.75                                                    
             tab(2,5) = 6.85                                                    
             tab(2,6) = 7.92                                                    
             tab(2,7) = 9.14                                                    
          else if(law.eq.1985) then                                             
             tab(2,3) = 2.9                                                     
             tab(2,4) = 5.6                                                     
             tab(2,5) = 6.75                                                    
             tab(2,6) = 7.88                                                    
             tab(2,7) = 9.1                                                     
          else if(law.eq.1986) then                                             
             tab(2,3) = 2.85                                                    
             tab(2,4) = 5.45                                                    
             tab(2,5) = 6.7                                                     
             tab(2,6) = 7.84                                                    
             tab(2,7) = 9.08                                                    
          else if(law.eq.1987) then                                             
             tab(2,3) = 2.8                                                     
             tab(2,4) = 5.3                                                     
             tab(2,5) = 6.65                                                    
             tab(2,6) = 7.82                                                    
             tab(2,7) = 9.05                                                    
          endif                                                                 
      endif                                                                     
      texp = 1.                                                                 
      if(mst.eq.4.or.mst.eq.7) texp = 1.5                                       
      if(mst.eq.2.or.mst.eq.5) texp = 2.                                        
      tinc = taxinc/texp                                                        
      if(law.ge.1977.and.law.le.1987) then                                      
        call look(tab,tinc,8,n,stat,1.0d00,0.0d0,rt,data)                       
      else if(law.eq.1988) then                                                 
        call look(tab88,tinc,4,n,stat,1.0d00,0.0d0,rt,data)                     
      else if(law.ge.1989.and.law.le.1990) then                                 
         call look(tab89,tinc,4,n,stat,1.0d00,0.0d0,rt,data)                    
      else if(law.ge.1991.and.law.le.1992) then                                 
         call look(tab91,tinc,5,n,stat,1.0d00,0.0d0,rt,data)                    
      else if(law.ge.1993.and.law.le.2012) then                                 
         call look(tab93,tinc,4,n,stat,aif93(law),0.0d0,rt,data)                
      else if(law.ge.2013.and.law.le.2015) then                                 
         call look(tab13,tinc,3,n,stat,1.0d0,0.0d0,rt,data)                     
      else if(law.eq.2016) then                                                 
         call look(tab16,tinc,3,n,stat,1.0d0,0.0d0,rt,data)                     
      else if(law.ge.2017) then                                                 
         call look(tab17,tinc,3,n,stat,aif17(law),0.0d0,rt,data)                
      endif                                                                     
c      if(law.ge.1989) statax = stat*texp                                       
      statax = stat*texp 
c      write(0,*) 'taxinc statax',taxinc,statax
c Low-Income Tax Credit 1997-2012                                               
      if((law.ge.1997.and.law.le.2002).and.taxinc.le.2000.) statax=0.           
c ---------------------------------------------------                           
c    Extra Tax                                                                  
      txm=0.                                                                    
      if(comnew(70).gt.0.) then                                                 
       if(law.le.1985) then                                                     
          txm=.15*max(0.0d0,comnew(70)-comnew(28))                              
       else if (law.ge.1986.and.law.le.1990) then                               
          txm=max(0.0d0,.03*comnew(69)-statax)                                  
       else if (law.ge.1991.and.law.le.2011) then 
c The Maine minimum tax on individuals is eliminated for tax years beginning after 2011. 
          txm=.27*max(0.0d0,comnew(70)-comnew(28))                              
       endif                                                                    
      endif                                                                     
      iratax=0.0d0                                                              
      if(law.ge.1986)iratax=.15*data(42)                                        
      statax=statax+txm+iratax   
c      write(0,*) '2 statax txm ',statax,txm
c  Credits                                                                      
c The Maine EITC is nonrefundable 2000-2015 and 2016+ refundable                
      earncr = 0.                                                               
      if((law.ge.2000.and.law.le.2019).or.law.ge.2021) then                     
         earncr = eicr(law)*comnew(59)                                          
      else if (law.eq.2020) then                                                
c 2020 Maine eic eligibility includes childless people 18-24 y.o.               
         earncr = eicr(law)*comnew(188)                                         
         if(data(203).lt.1) earncr = .25d0*comnew(188)                          
      endif                                                                     
c 2018+ a tax credit up to $300 for each qualifying child and dependent of the  
c taxpayer for whom the federal child tax credit (non-ref)                      
      depcrd = 0.d0                                                             
      if(law.ge.2018) depcrd = min(300.d0*data(208),statax)                     
c  Credit for elderly                                                           
      eldcr=0.                                                                  
c Credit for the elderly and disabled is repealed for 2016+                     
      if(law.ge.1978.and.law.le.2016)eldcr=.2*comnew(54)                        
c  Energy System Credit                                                         
      encred=0.                                                                 
      if(law.ge.1979.and.law.le.1988)encred=min(data(38)*1.3,100.0d0)           
c Child Care Credit (up to $500 refundable)                                     
      chcr=child(law)*min(comnew(53),max(0.0d0,comnew(52)-data(34)))            
c refundable part                                                               
      chcrr = min(500.0d0,chcr)                                                 
c non-refundable part                                                           
      chcrn = chcr - chcrr                                                      
      credit = eldcr + encred + chcrn + depcrd                                  
      if(law.ge.2000.and.law.le.2015) credit = credit + earncr                  
c Property tax credit                                                           
      pcred=0.                                                                  
      ptax=max(data(51),.25*data(160))                                          
      qual=0.                                                                   
      if(data(25).gt.0)qual=1.                                                  
      if(law.le.1987) then                                                      
        if(data(159).le.hylim(law,txp)) then                                    
          if(law.eq.1977) then                                                  
            pcred=twn(ptax-.1*max(0.0d0,data(159)-3000.),0.0d0,400.0d0)         
            pcred=pcred*twn(data(9),0.0d0,1.0d0)                                
          else if(law.ge.1978.and.law.le.1987) then                             
            pcred=twn(ptax,0.0d0,400.0d0)                                       
            pcred=pcred*twn(data(9)+data(10)+qual,0.0d0,1.0d0)                  
          endif                                                                 
        endif                                                                   
      else if(law.eq.1988) then                                                 
        if(data(9)+data(10).gt.0) then                                          
          if(txp.eq.1) then                                                     
            if(data(159).le.6800)pcred=min(400.0d0,ptax)                        
            if(data(159).gt.6800.and.data(159).le.7000)                         
     &                 pcred=min(300.0d0,.75*ptax)                              
            if(data(159).gt.7000.and.data(159).le.7200)                         
     &                 pcred=min(200.0d0,.50*ptax)                              
            if(data(159).gt.7200.and.data(159).le.7400)                         
     &                 pcred=min(100.0d0,.25*ptax)                              
          else if(txp.eq.2) then                                                
            if(data(159).le.8100)pcred=min(400.0d0,ptax)                        
            if(data(159).gt.8100.and.data(159).le.8500)                         
     &                 pcred=min(300.0d0,.75*ptax)                              
            if(data(159).gt.8500.and.data(159).le.8800)                         
     &                 pcred=min(200.0d0,.50*ptax)                              
            if(data(159).gt.8800.and.data(159).le.9200)                         
     &                 pcred=min(100.0d0,.25*ptax)                              
          endif                                                                 
        endif                                                                   
c          there is a table for people with hy.lt.28000                         
      else if(law.ge.1989) then                                                 
        pcred=0.                                                                
      endif                                                                     
      pcred=pcred*twn(data(9)+data(10),0.0d0,1.0d0)                             
c 2013+ Refundable Property Tax Fairness Credit (PTFC)                          
c      tix = max(0.d0,comnew(65)+data(91)-comnew(79)+data(41)                   
c     &  - min(0.d0,comnew(6))-min(0.d0,data(17))-min(0.d0,comnew(8)))          
      ti = max(0.d0,comnew(65)+data(91))                                        
      nexem = int(comnew(68))                                                        
      ptfc = 0.                                                                 
      if(law.eq.2013.and.nexem.gt.0) then                                       
         agix = max(0.d0,agi)                                                   
         bagix = .1*agix                                                        
         base = data(51) + .25*.85*data(160)                                    
         if(agix.le.40000.and.base.gt.bagix) then                               
           ptfc = min(300.d0/sep,.4*(base - bagix))                             
           if(data(9).gt.0) ptfc = min(400.d0/sep,.4*(base - bagix))            
         endif                                                                  
      else if((law.ge.2014.and.law.le.2017).and.nexem.gt.0) then                
         base = data(51) + .15*.85*data(160)                                    
         if(mst.eq.1) then                                                      
            base = min( 2000.0d0,base)                                          
            tix =  min(33333.d0/sep,ti)                                         
         else                                                                   
            if(nexem.le.2) then                                                 
               base = min( 2600.d0/sep,base)                                    
               tix =  min(43333.d0/sep,ti)                                      
            else                                                                
               base = min( 3200.d0/sep,base)                                    
               tix =  min(53333.d0/sep,ti)                                      
            endif                                                               
         endif                                                                  
         ptfc = min(600.d0/sep,.5*max(0.0d0,base-.06*tix))                      
         if(data(9).gt.0)                                                       
     &   ptfc = min(900.d0/sep,.5*max(0.0d0,base-.06*tix))                      
      else if(law.ge.2018.and.nexem.gt.0) then                                  
         base = data(51) + .15*.85*data(160)                                    
         if(mst.eq.1) then                                                      
            base = min( 2050.0d0,base)                                          
            tix =  min(34167.d0,ti)                                             
         else                                                                   
            if(nexem.le.2) then                                                 
               base = min( 2650.d0,base)                                        
               tix =  min(44167.d0,ti)                                          
            else                                                                
               base = min( 3250.d0,base)                                        
               tix =  min(54167.d0,ti)                                          
            endif                                                               
         endif                                                                  
         ptfc = min(750.d0,max(0.0d0,base-.06*tix))                             
         if(data(9).gt.0)                                                       
     &     ptfc = min(1200.d0,max(0.0d0,base-.06*tix))                          
      endif                                                                     
c 2017+ married filing separate are prohibited from claiming PTFC               
      if(law.ge.2017.and.sep.eq.2) ptfc = 0.                                    
c 2016+ refundable Sales Tax Fairness Credit ,not separate (STFC)               
      stfc = 0.                                                                 
      nmst = 0                                                                  
      tis=comnew(2)+comnew(17)+data(91)-comnew(79)-min(0.0d0,comnew(6))         
      if(law.eq.2020) then                                                      
        tis = tis + data(82) - comnew(78)                                       
      endif                                                                     
      if(mst.eq.1) then                                                         
           nmst = 1                                                             
      else if(mst.eq.4.or.mst.eq.7) then                                        
           nmst = 2                                                             
      else if(mst.eq.2.or.mst.eq.5) then                                        
           nmst = 3                                                             
      endif                                                                     
      if(data(105).gt.0.d0) nmst = 0                                            
c no separate returns for this credit (nmst = 0)                                
c total income; losses add-backs                                                
      if((law.ge.2016).and.nexem.gt.0.and.nmst.gt.0)                            
     & then                                                                     
         nexem = min(nexem,4)                                                   
         if(nmst.ge.1) stfc = max(0.0d0,                                        
     &   sfcr(nexem,law)-max((tis - sft(nmst,law))/50,.0d0))                    
      endif                                                                     
      if(law.eq.1987)credit=credit+(data(7)+data(8)+data(9)+data(10))*9.        
      if(law.eq.1978) then                                                      
        credit=credit+max(0.0d0,min(data(160),32.0d0),                          
     &   min(64.0d0,data(51)))                                                  
      endif                                                                     
c standard deduction credit for 1988                                            
      if(law.eq.1988) then                                                      
        credit=credit+twn(.02*comnew(37),10.0d0,std(mst))                       
        if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                               
          credit=credit+tablki(sxmp,3,agi,data)                                 
        else if(mst.eq.4.or.mst.eq.7) then                                      
          credit=credit+tablki(hxmp,3,agi,data)                                 
        else                                                                    
          credit=credit+tablki(mxmp,3,agi,data)                                 
        endif                                                                   
      endif                                                                     
      statax=max(0.0d0,statax-credit)                                           
c new accounting for refundable property tax credit                             
      statax=max(0.0d0,statax-pcred)                                            
      statax = statax - chcrr - ptfc - stfc                                     
      credit = credit + chcrr + ptfc + stfc + pcred                             
                                                                                
      if(law.ge.2016) then                                                      
c 2016+ the Earned Income Credit is refundable                                  
         statax = statax - earncr                                               
         credit = credit + earncr                                               
      endif  
c      write(0,*) '3 statax',statax

      return                                                                    
      end                                                                       
c                                                                               
c  MARYLAND                                                                    
c  State 21                                                                    
c                                                                               
c   Updated through 2021 (edited 03/14/2022)                                    
      subroutine mdtax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      dimension aif92(1992:2012),aif13(2013:2017)                               
     &,tab92(2,5),tab(2,4),tab95(2,4),tab08(2,8),tab12(2,8),tab9507(2,4)        
     &,tbase8(2,8),tbas12(2,8),tb92(2,5)                                        
     &,pov1(1997:2021),pov2(1997:2021)                                          
     &,stds(2,2019:2021),stdm(2,2019:2021)                                      
      dimension pex(1977:2021),xmp(1977:2021),eicr(1998:2021)                   
      integer sep                                                               
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data stds/                                                                
     1 1500.d0,2*1550.d0,                                                       
     2 2250.d0,2300.d0,2350.d0/                                                 
      data stdm/                                                                
     1 3050.d0,2*3100.d0,                                                       
     2 4550.d0,4650.d0,4700.d0/                                                 
      data eicr/                                                                
     &         2*.1d0,.15d0,2*.16d0,.18d0,4*.2d0,7*.25d0,.255d0,.26d0,          
     &         .27d0,2*.28d0,.45d0,.5d0/                                        
c tables for 1992-94                                                            
      data tb92/                                                                
     &        1000.0d0, 2.0d0, 2000.0d0, 3.0d0, 3000.0d0, 4.0d0,                
     &      150000.0d0, 5.0d0,    1.e20, 6.0d0/                                 
      data tab95/                                                               
     &        1000.0d0, 2.0d0, 2000.0d0, 3.0d0, 3000.0d0, 4.0d0,                
     &           1.e20, 5.0d0/                                                  
c Rates for 2008-2011                                                           
      data tbase8/                                                              
     &        1000.0d0, 2.0d0 , 2000.0d0, 3.0d0 , 3000.0d0, 4.0d0 ,             
     &            2.e5, 4.75d0,    35.e4, 5.0d0 ,     5.e5, 5.25d0,             
     &            1.e6, 5.50d0,    1.e20, 6.25d0/                               
c Rates for 2012+                                                               
      data tbas12/                                                              
     &        1000.0d0, 2.0d0 , 2000.0d0, 3.0d0 , 3000.0d0, 4.0d0 ,             
     &           15.e4, 4.75d0,   175.e3, 5.0d0 ,   225.e3, 5.25d0,             
     &            3.e5, 5.50d0,    1.e20, 5.75d0/                               
      data tab /                                                                
     &        1000.0d0, 2.0d0 , 2000.0d0, 3.0d0 , 3000.0d0, 4.0d0,              
     &           1.e20,5.0d0 /                                                  
      data aif92/                                                               
     &            1.0525d0, 1.0840d0, 1.118d0,  1.147d0 , 1.1795d0,             
     &            1.212d0 , 1.245d0 , 1.266d0,  1.2895d0, 1.3295d0,             
     &            1.373d0 , 1.395d0 , 1.427d0,  1.4595d0, 1.5050d0,             
     &            1.564d0 , 1.5995d0, 1.668d0,2*1.6955d0, 1.7365d0/             
c pnsion exclusion                                                              
      data pex/                                                                 
     &           3200.0d0,  5200.0d0,  5700.0d0,  6400.0d0,  7400.0d0,          
     &           8700.0d0,3*8500.0d0,  8600.0d0,  9100.0d0,  9500.0d0,          
     &          10100.0d0, 10800.0d0, 11800.0d0, 12300.0d0, 13100.0d0,          
     &          13600.0d0, 13800.0d0, 14400.0d0, 15000.0d0, 15900.0d0,          
     &          16100.0d0, 16500.0d0, 17300.0d0, 18500.0d0, 19900.0d0,          
     &          20700.0d0, 21500.0d0, 22600.0d0, 23600.0d0, 24000.0d0,          
     &          24500.0d0, 26100.0d0, 26300.0d0, 27100.0d0, 27800.0d0,          
     &          29000.0d0, 29200.0d0, 29400.0d0, 29900.0d0, 30600.0d0,          
     &          31100.0d0, 33100.0d0, 34300.0d0/                                
      data xmp/                                                                 
     &        10*800.0d0, 2*1000.0d0, 2*1100.0d0, 7*1200.0d0, 1750.0d0,         
     &        2*1850.0d0,   2100.0d0, 6*2400.0d0, 14*3200.0d0/                  
      data pov1/                                                                
     &          7890.0d0,   8050.0d0,   8240.0d0,   8350.0d0, 8590.0d0,         
     &          8860.0d0,   8980.0d0,   9310.0d0,   9570.0d0, 9800.0d0,         
     &         10210.0d0,  10400.0d0,2*10830.0d0,  10890.0d0,11170.0d0,         
     &         11490.0d0,  11670.0d0,  11770.0d0,  11880.0d0,12060.0d0,         
     &         12140.0d0,  12490.0d0,  12760.0d0,  12880.0d0/                   
      data pov2/                                                                
     &          2720.0d0,   2800.0d0,   2820.0d0,   2900.0d0,  3020.0d0,        
     &          3080.0d0,   3140.0d0,   3180.0d0,   3260.0d0,  3400.0d0,        
     &          3480.0d0,   3600.0d0, 2*3740.0d0,   3820.0d0,  3960.0d0,        
     &          4020.0d0,   4060.0d0,   4160.0d0,   4220.0d0,  4180.0d0,        
     &          4320.0d0,   4420.0d0,   4480.0d0,   4540.0d0/                   
      mst = int(data(2))                                                             
      txp = data(7)                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rt = 0.                                                                   
      phas92 = 100000.d0/sep                                                    
      if(law.ge.1992.and.law.le.2012)phas92=100000.*aif92(law)/sep              
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c     AGI                                                                       
c Taxable refunds                                                               
      agi = comnew(2)-data(22)                                                  
c Child and dependent care expenses                                             
c  subtraction from agi -- child care expenses                                  
      chnum = min(2.0d0,data(8))                                                
      chexp = 0.                                                                
      if(law.ge.1978.and.law.le.2002) chexp = min(2400.*chnum,data(64))         
      if(law.ge.2003)chexp = min(3000.*chnum,data(64))                          
      agi = agi - chexp                                                         
c Pension exclusion                                                             
      penmax = max(0.0d0,pex(law)*data(9)-data(91))                             
c      penexc = twn(data(20)+data(72),0.0d0,penmax)                             
c Pension exclusion -- does not include IRA as data(20) for the base            
      penexc = twn(data(72)+data(20),0.0d0,penmax)                              
      if(mst.eq.2.and.data(9).lt.2.and.data(9).gt.0) then                       
c         penmax = max(0.0d0,pex(law)-.5*data(91))                              
c         penexc = twn(.5*data(72),0.0d0,penmax)                                
         subh = 0.                                                              
         subw = penexc                                                          
      endif                                                                     
      agi = agi- penexc                                                         
c Taxable Social Security                                                       
      if(law.ge.1985)agi = agi-comnew(79)                                       
      if(law.le.1986) agi = agi+.5*max(comnew(36)-10000.*txp,0.0d0)             
     &                         +divexc(data,comnew,law)                         
      if(law.eq.1980)agi = agi-twn(data(14),0.0d0,200.*data(7))                 
      if(law.ge.1980.and.law.le.1986)agi=agi-min(comnew(25),50*data(7))         
c two-income married couple subraction                                          
      if(law.ge.1982.and.law.le.1986)agi = agi+comnew(32)                       
      if (mst.eq.2.and.comnew(2).gt.0.d0) then                                  
        twoear = 0.                                                             
        agih = data(85) + .5*(comnew(2)-data(11))                               
        agiw = data(86) + .5*(comnew(2)-data(11))                               
        subtr = data(22) + penexc + chexp + comnew(79)                          
        twoh = max(0.0d0,agih - .5*subtr)                                       
        twow = max(0.0d0,agiw - .5*subtr)                                       
        if(data(9).eq.1.and.penexc.gt.0)then                                    
          twoh = max(0.0d0,agih - .5*(data(22)+chexp+comnew(79))-subh)          
          twow = max(0.0d0,agiw - .5*(data(22)+chexp+comnew(79))-subw)          
        endif                                                                   
        if(law.ge.1992.and.agih*agiw.gt.0) then                                 
         if(law.le.1994)then                                                    
           if(comnew(2).le.150000.) twoear = 1200.                              
           if(comnew(2).gt.150000.) twoear = 1000.                              
           twoear = min(twoear,min(twoh,twow))                                  
         else if(law.ge.1995) then                                              
           twoear = 1200.                                                       
           if(law.eq.1998)  twoear = 1154.                                      
           twoear = min(twoear,min(twoh,twow))                                  
         endif                                                                  
        endif                                                                   
        agi = max(0.0d0,agi-twoear)                                             
      endif                                                                     
      if(law.ge.1984) agi = agi-xjobs(data,law)                                 
c 1985 is correct; not 1984:controller ask some to withhold until law           
c          is passed on ssagi & whether or not taxable                          
c capital gains stuff:discontinued in 1992                                      
      if(law.ge.1987.and.law.le.1990.and.comnew(5).gt.0)                        
     &  agi = agi-(.4*comnew(5))                                                
      if(law.eq.1991.and.comnew(5).gt.0)then                                    
        if(mst.eq.2) then                                                       
           astep = min(.3*comnew(5),15000.0d0)                                  
           bstep =max((comnew(2)-comnew(5))-100000.,0.0d0)*.5                   
        else                                                                    
           astep = min(.3*comnew(5),7500.0d0)                                   
           bstep = max((comnew(2)-comnew(5))-50000.,0.0d0)*.5                   
        endif                                                                   
        capded = max(astep-bstep,0.0d0)                                         
        agi = agi-capded                                                        
      endif                                                                     
c Standard Deduction                                                            
      txpded = txp                                                              
      if(mst.eq.4.or.mst.eq.7) txpded = txpded+1                                
      if(law.le.1978) then                                                      
        stded = min(txpded*500.,.1*max(0.0d0,agi))                              
      else if(law.ge.1979.and.law.le.1986) then                                 
        stded = min(txpded*1500.,.13*max(0.0d0,agi))                            
      else if(law.ge.1987.and.law.le.1989) then                                 
        stded = twn(.15*agi,txpded*1000.d0,txpded*2000.d0)                      
        stded = stded+(data(9)+data(10))*800.                                   
      else if(law.ge.1990.and.law.le.2017) then                                 
        stded = twn(.15*agi,txpded*1500.d0,txpded*2000.d0)                      
      else if(law.eq.2018) then                                                 
          stded = twn(.15*agi,txpded*1500.d0,txpded*2250.d0)                    
      else if(law.ge.2019) then                                                 
        if(mst.eq.4.or.mst.eq.7.or.mst.eq.2.or.mst.eq.5) then                   
          stded = twn(.15*agi,stdm(1,law),stdm(2,law))                          
        else                                                                    
          stded = twn(.15*agi,stds(1,law),stds(2,law))                          
        endif                                                                   
      endif                                                                     
c Itemized Deductions                                                           
      xitded = 0.                                                               
      if(comnew(26).gt.0..and.law.ge.1987.and.comnew(30).gt.0) then             
       xitded=max(0.d0,comnew(30)-data(50))                                     
       if(law.ge.1991.and.law.le.2017) then                                     
         if(agi.gt.phas92.and.comnew(30).gt.0)                                  
     &  xitded=max(0.d0,comnew(24)-data(50)*comnew(24)/comnew(30))              
       endif                                                                    
      else if(law.le.1986) then                                                 
        xitded = max(comnew(30)-data(50),comnew(3))                             
      endif                                                                     
      deduc = max(xitded,stded)                                                 
c Exemptions amount                                                             
      exemp = 0.                                                                
      if(law.le.1989)exemp = comnew(68)*xmp(law)                                
      if(law.ge.1990)then                                                       
        blage = (data(9)+data(10))*1000                                         
        exemp = blage +(data(7)+data(8))*xmp(law)                               
        if(data(105).lt.1) then                                                 
c 2008 Singles and separate exemptions phaseouts                                
          if(mst.eq.1.or.sep.eq.2) then                                         
c fed agi E ]100k,125k]                                                         
           if(comnew(2).gt.100000.and.comnew(2).le.125000.0d0) then             
c 2008-2011                                                                     
            if(law.ge.2008.and.law.le.2011) then                                
              exemp = blage +(data(7)+data(8))*2400                             
c 2012+                                                                         
            else if(law.ge.2012) then                                           
              exemp = blage +(data(7)+data(8))*1600                             
            endif                                                               
c fed agi E ]125k,150k]                                                         
           else if(comnew(2).gt.125000.and.comnew(2).le.150000.0d0) then        
c 2008-2011                                                                     
            if(law.ge.2008.and.law.le.2011) then                                
               exemp = blage +(data(7)+data(8))*1800                            
c 2012+                                                                         
            else if(law.ge.2012) then                                           
              exemp = blage +(data(7)+data(8))*800                              
            endif                                                               
c fed agi E ]150k,200k]                                                         
           else if(comnew(2).gt.150000.and.comnew(2).le.200000.0d0) then        
c 2008-2011                                                                     
            if(law.ge.2008.and.law.le.2011) then                                
              exemp = blage +(data(7)+data(8))*1200                             
            else if(law.ge.2012) then                                           
c 2012+                                                                         
              exemp = 0                                                         
            endif                                                               
c fed agi E ]200k,+[                                                            
           else if(comnew(2).gt.200000) then                                    
c 2008-2011                                                                     
            if(law.ge.2008.and.law.le.2011) then                                
              exemp = blage +(data(7)+data(8))*600                              
c 2012+                                                                         
            else if(law.ge.2012) then                                           
              exemp = 0                                                         
            endif                                                               
           endif                                                                
          else                                                                  
c 2008 Married and Head of Household exemptions phaseouts                       
           if(comnew(2).gt.150000.and.comnew(2).le.175000.0d0) then             
             if(law.ge.2008.and.law.le.2011) then                               
               exemp = blage +(data(7)+data(8))*2400                            
             else if(law.ge.2012) then                                          
               exemp = blage +(data(7)+data(8))*1600                            
             endif                                                              
           else if(comnew(2).gt.175000.and.comnew(2).le.200000.0d0) then        
             if(law.ge.2008.and.law.le.2011) then                               
               exemp = blage +(data(7)+data(8))*1800                            
             else if(law.ge.2012) then                                          
               exemp = blage +(data(7)+data(8))*800                             
             endif                                                              
           else if(comnew(2).gt.200000.and.comnew(2).le.250000.0d0) then        
             if(law.ge.2008.and.law.le.2011) then                               
               exemp = blage +(data(7)+data(8))*1200                            
             else if(law.ge.2012) then                                          
               exemp = 0                                                        
             endif                                                              
           else if(comnew(2).gt.250000) then                                    
             if(law.ge.2008.and.law.le.2011) then                               
               exemp = blage +(data(7)+data(8))*600                             
             else if(law.ge.2012) then                                          
               exemp = 0                                                        
             endif                                                              
           endif                                                                
          endif                                                                 
        else                                                                    
c dependent exemption                                                           
          if(law.ge.2008) exemp = 0.                                            
         endif                                                                  
      endif                                                                     
      taxinc = max(0.0d0,agi-deduc-exemp)                                       
c      write(0,*) 'taxinc agi deduc exemp',taxinc,agi,deduc,exemp               
c Tax Calcuation                                                                
      if(law.le.1991) then                                                      
          call look(tab,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)                  
      else if(law.ge.1992.and.law.le.1994) then                                 
          do 109 i=1,5                                                          
          do 108 j=1,2                                                          
          tab92(j,i) = tb92(j,i)                                                
108       continue                                                              
109       continue                                                              
          if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) tab92(1,4) = 100000.             
          call look(tab92,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                
      else if(law.ge.1995.and.law.le.2007) then                                 
          do 111 i=1,2                                                          
          do 110 j=1,4                                                          
          tab9507(i,j) = tab95(i,j)                                             
110       continue                                                              
111       continue                                                              
          if(law.eq.1998) tab9507(2,4) = 4.875                                  
          if(law.ge.1999.and.law.le.2000) tab9507(2,4) = 4.85                   
          if(law.eq.2001) tab9507(2,4) = 4.8                                    
          if(law.ge.2002.and.law.le.2007) tab9507(2,4) = 4.75                   
          call look(tab9507,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)              
      else if(law.ge.2008.and.law.le.2011) then                                 
          do 113 i=1,8                                                          
          do 112 j=1,2                                                          
            tab08(j,i) = tbase8(j,i)                                            
112       continue                                                              
113       continue                                                              
          if(mst.eq.1.or.sep.eq.2.or.data(105).gt.0) then                       
            tab08(1,4) = 1.5e5                                                  
            tab08(1,5) = 3.e5                                                   
          endif                                                                 
          call look(tab08,taxinc,8,n,statax,1.0d0,0.0d0,rt,data)                
      else if(law.ge.2012) then                                                 
          do 115 i=1,8                                                          
          do 114 j=1,2                                                          
            tab12(j,i) = tbas12(j,i)                                            
114       continue                                                              
115       continue                                                              
          if(mst.eq.1.or.sep.eq.2.or.data(105).gt.0) then                       
            tab12(1,4) = 1.e5                                                   
            tab12(1,5) = 1.25e5                                                 
            tab12(1,6) = 1.5e5                                                  
            tab12(1,7) = 2.5e5                                                  
          endif                                                                 
          call look(tab12,taxinc,8,n,statax,1.0d0,0.0d0,rt,data)                
      endif                                                                     
      taxbc = statax                                                            
c      write(0,*) 'taxbc',taxbc                                                 
c Credits                                                                       
c Earned Income Credit - non-refundable                                         
      earncr = 0.                                                               
      if(law.ge.1987) earncr = .5*comnew(59)                                    
      earncr = min(taxbc,earncr)                                                
      pretax = max(0.0d0,taxbc - earncr)                                        
c If you are a MD resident who qualifies for the state earncr,                  
c you may also qualify for a local earned income tax credit.                    
      statax = pretax                                                           
c      write(0,*) 'non-ref earncr statax',earncr,statax                         
c refundable Earned Income Credit                                               
      refcr = 0.                                                                
c      if(pretax.lt.1.and.data(8).gt.0.and.taxbc.gt.0.and.                      
c     & (law.ge.1998.and.law.le.2008))                                          
c     &         refcr = max(0.0d0,eicr(law)*comnew(59)-taxbc)                   
c      if(pretax.lt.1.and.law.ge.2009.and.taxbc.gt.0.d0)                        
c     &         refcr = max(0.0d0,eicr(law)*comnew(59)-taxbc)                   
      if(data(8).gt.0.d0.and.(law.ge.1998.and.law.le.2008))                     
     &         refcr = max(0.0d0,eicr(law)*comnew(59)-taxbc)                    
      if(law.ge.2009.and.law.le.2019)                                           
     &         refcr = max(0.0d0,eicr(law)*comnew(59)-taxbc)                    
      if(law.ge.2020.and.data(8).gt.0.d0)                                       
     &         refcr = max(0.0d0,eicr(law)*comnew(59)-taxbc)                    
      if(law.ge.2020.and.pretax.lt.1.d0.and.data(8).lt.1.d0) then               
         wl1 = taxbc                                                            
         wl2 = min(530.d0,comnew(59))                                           
         if(wl1.lt.wl2) refcr = wl2 - wl1                                       
      endif                                                                     
c      write(0,*) 'refcr',refcr                                                 
c Non-refundable Credit for Child and Dependent Care Expenses                   
      chr = 0.                                                                  
      if(law.eq.2000) then                                                      
       chr =.001*max(0.0d0,                                                     
     &   (250.-max((comnew(2)-30000.d0/sep)/(40.d0/sep),0.0d0)))                
      elseif(law.ge.2001.and.law.le.2018) then                                  
       chr =.0001*max(0.0d0,                                                    
     &(3250.-max((comnew(2)-41000.d0/sep)/(1000.d0/(325*sep)),0.0d0)))          
      elseif(law.ge.2019) then                                                  
        if(mst.eq.2) then                                                       
         chr=.01*max(0.0d0,32.-max((comnew(2)-50000.)/3000.,0.0d0))             
         fagim = 75000.d0                                                       
        else                                                                    
         chr=.01*max(0.0d0,32.-max((comnew(2)-30000.)/2000.,0.0d0))             
         fagim = 50000.d0                                                       
        endif                                                                   
      endif                                                                     
      chcr = chr*min(comnew(53),max(0.0d0,comnew(52)-data(34)))                 
      statax = max(0.0d0,statax-chcr)                                           
c      write(0,*) 'statax  non-ref chcr',statax,chcr                            
c Poverty Level credit since 1997 - nonrefundable                               
      ptcr = 0.                                                                 
      if(law.ge.1997.and.data(105).lt.1.) then                                  
        xlin3 = pov1(law)+pov2(law)*(comnew(68)-1)                              
        xlin4 = max(comnew(2),comnew(37))                                       
        if (xlin3.ge.xlin4) ptcr = .05*comnew(37)                               
      endif                                                                     
      if(law.le.1996) then                                                      
        statax = statax - ptcr                                                  
      else                                                                      
        statax = max(0.0d0,statax - ptcr)                                       
      endif                                                                     
      statax = statax-refcr                                                     
c 2019+ refunadable part of child care credit                                   
      chref = 0.d0                                                              
      if(law.ge.2019) then                                                      
        if(comnew(2).le.fagim) chref = max(0.d0,chcr - taxbc)                   
      endif                                                                     
      statax = statax - chref                                                   
c      write(0,*) 'ref child care statax',chref,statax                          
      credit = earncr + ptcr + refcr + chcr + chref                             
      earncr = earncr + refcr                                                   
      return                                                                    
      end                                                                       
c  MASSACHUSETTS                                                                
c  State 22                                                                     
      subroutine matax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/times/zitem,ptax,txrate,h                                          
      dimension data(255), comnew(255)                                          
      integer s, sep                                                            
      double precision blind, bus, ch, fica, rnt, scred, ntscr                  
      double precision ntsr, licrr,loss1,loss2                                  
      dimension xmps(1977:2023),xmplim(1977:2023),surtax(1977:2023)             
      dimension sec(1977:2023),xmpd(1977:2023), xmpo(1977:2023)                 
      dimension gnx(1977:2023),sslim(1977:2023),eicr(1997:2023)                 
      dimension tab89(1977:2023),add(1995:2023),txph(1994:2023)                 
      double precision nts(1977:2023,2),                                        
     &licrh(1995:2023),licrm(1995:2023)                                         
c federal poverty level, unemployment ded                                       
      dimension povert(2020:2023),uithrs(2020:2023)                             
c 2001+ Curcuit Breaker Credit d9>0, sep=1                                      
c cbmax,hymaxs,hymaxh,,hymaxm will have actual amounts for 2021-2023            
      dimension cbmax(2001:2023),                                               
     & hymaxs(2001:2023),hymaxh(2001:2023),hymaxm(2001:2023)                    
      data cbmax/385.d0, 790.d0, 810.d0, 820.d0, 850.d0, 870.d0, 900.d0,        
     &           930.d0, 960.d0, 970.d0, 980.d0,1000.d0,1030.d0,1050.d0,        
     &         2*1070.d0,1080.d0,1100.d0,1130.d0,1150.d0,1170.d0,
     &         2*1170.d0/                             
c do not forget to change cbmax,hymax(s),(m),(h) for years 2022 and 23                                                                              
      data povert/12760.d0,3*12880.d0/                                          
      data uithrs/4*10200.d0/                                                   
c                                                                               
      data hymaxs/41000.d0,42000.d0,43000.d0,44000.d0,45000.d0,                 
     &   46000.d0,48000.d0,49000.d0,2*51000.d0,52000.d0,                        
     &   53000.d0,55000.d0,56000.d0,3*57000.d0,                                 
     &   58000.d0,60000.d0,61000.d0,3*62000.d0/                                                   
      data hymaxh/51000.d0,53000.d0,54000.d0,55000.d0,56000.d0,                 
     &   58000.d0,60000.d0,62000.d0,2*64000.d0,65000.d0,                        
     &   67000.d0,69000.d0,70000.d0,2*71000.d0,72000.d0,                        
     &   73000.d0,75000.d0,76000.d0,3*78000.d0/                                                   
      data hymaxm/61000.d0,63000.d0,64000.d0,66000.d0,68000.d0,                 
     &   70000.d0,72000.d0,74000.d0,2*77000.d0,78000.d0,                        
     &   80000.d0,82000.d0,84000.d0,85000.d0,2*86000.d0,                        
     &   88000.d0,90000.d0,92000.d0,3*93000.d0/                                                   
c                                                                               
      data eicr/4*.1d0,15*.15d0,3*.23d0,5*.3d0/                                 
      data txph/2*3400.0d0,4520.0d0,4065.0d0,7385.0d0,3*6800.0d0,               
     & 3*5100.0d0,5525.0d0,5950.0d0,6375.0d0,16*6800.0d0/                       
      data licrh/19250.0d0,21210.0d0,20414.0d0,26224.0d0,                       
     & 3*25200.0d0,3*22225.0d0,22969.0d0,23713.0d0,24456.0d0,                   
     & 16*25200.0d0/                                                            
      data add/1000.0d0,1330.0d0,1195.0d0,2175.0d0,3*2000.0d0,                  
     & 1750.0d0,2*1500.0d0,1635.0d0,1750.0d0,1875.0d0,16*2000.0d0/              
      data licrm/21000.0d0,23536.0d0,22505.0d0,30030.0d0,                       
     & 3*28700.0d0,3*24850.0d0,25813.0d0,26775.0d0,27738.0d0,                   
     & 16*28700.0d0/                                                            
      data xmps/5*2000.d0,14*2200.d0,2925.d0,2630.d0,4780.d0,                   
     & 3*4400.d0,3*3300.d0,3575.d0,3850.d0,4185.d0,16*4400.d0/                  
      data xmpd/600.0d0, 9*700.0d0,37*1000.0d0/                                 
      data xmpo/600.0d0, 46*700.0d0/                                            
      data sec/600.0d0,700.0d0,3*800.0d0,5*1000.0d0,37*0.0d0/                   
      data xmplim/4400.0d0, 4500.0d0, 3*4600.0d0, 4800.0d0,                     
     & 13*4400.0d0,5850.0d0,5260.0d0,                                           
     &            9560.0d0,3*8800.0d0,3*6600.0d0,7150.0d0,                      
     & 7700.0d0,8250.0d0,16*8800.0d0/                                           
      data surtax/9*1.0750d0,38*1.0d0/                                          
      data gnx/3*0.0d0, .20d0, .40d0, .60d0, 14*.50d0,27*0.0d0/                 
      data sslim/5*1.e20, 2170.80d0, 41*2000.0d0/                               
      data nts/                                                                 
     s  7*3000.0d0, 3600.0d0, 4400.0d0,  6000.0d0, 37*8000.0d0,                 
     m  7*5000.0d0, 6100.0d0, 7200.0d0, 10000.0d0, 8*12000.0d0,                 
     m 11000.0d0,12120.0d0,11665.0d0,14965.0d0,3*14400.0d0,                     
     m 3*12700.0d0,13125.0d0,13550.0d0,13975.0d0,16*14400.0d0/                  
      data tab89/ 12*.05d0, .05375d0,.0595d0,.0625d0,8*.0595d0,                 
     & .0585d0,0.056d0,10*.053d0,2*.0525d0,.052d0, .0515d0,3*.051d0,            
     & .0505d0,4*.05d0/                                                         
c   condition for receiving extra exemptions                                    
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      blind=0.                                                                  
      bus=0.                                                                    
      ch=0.                                                                     
      fica=0.                                                                   
      ntscr=0.                                                                  
      rnt=0.                                                                    
      scred=0.                                                                  
      s=0                                                                       
      txcr=0.                                                                   
      rt=0.                                                                     
c  'x' is  marital status binary variable                                       
      x=0.                                                                      
      if(law.le.1984.and.mst.eq.2)x=1.                                          
      if(law.ge.1985.and.(mst.ne.3.or.mst.ne.6))x=1.                            
c Exemptions                                                                    
      txp=xmps(law)                                                             
      if(mst.eq.2) then                                                         
        if(law.le.1986) then                                                    
          spy=min(data(85),data(86))                                            
          txp=txp+(spy+sec(law))                                                
          txp=min(txp,xmplim(law))                                              
        else                                                                    
          txp=min(data(7)*xmps(law),xmplim(law))                                
        endif                                                                   
      endif                                                                     
      if(law.ge.1994) then                                                      
         if(mst.eq.4.or.mst.eq.7) txp=txph(law)                                 
      endif                                                                     
      edical=comnew(20)                                                         
      edxmp = edical*x                                                          
c Blind and Dependent Exemptions                                                
      blind=data(10)*2200.                                                      
      ageex = data(9)*xmpo(law)                                                 
      depex = data(8)*xmpd(law)                                                 
      exemp=(data(8)*xmpd(law))+(data(9)*xmpo(law))+txp+edxmp+blind             
                                                                                
c Income part MA Form 1                                                         
c  calculate B INCOME; taxed at approximately 5%                                
c  uses federal agi definitions (w/adjustments) from previous years             
      d17 = data(17)+data(211)+data(214)+data(212)+data(215)                    
      b1inc=data(11)+d17+data(21)                                               
                                                                                
      b2inc=data(72)+data(24)+data(23)+data(20)+data(19)                        
      if(law.eq.1977) then                                                      
        b1inc=b1inc+comnew(8)                                                   
        binc=b1inc+b2inc                                                        
      else if(law.ge.1978.and.law.le.1982) then                                 
        b1inc=b1inc+comnew(8)                                                   
        if(law.eq.1982)b2inc=b2inc+comnew(78)                                   
        binc=b1inc+b2inc                                                        
      else if(law.ge.1983.and.law.le.1985) then                                 
        b1inc=b1inc+comnew(8)                                                   
        b2inc=b2inc+comnew(78)                                                  
        binc=b1inc+b2inc                                                        
      else if(law.eq.1986.or.law.eq.1987) then                                  
        b1inc=b1inc+(comnew(8)-data(72))                                        
        b2inc=b2inc+comnew(78)                                                  
        binc=b1inc+b2inc                                                        
      else if(law.ge.1988.and.law.le.1989) then                                 
        b1inc=b1inc+comnew(8)                                                   
        b2inc=b2inc+comnew(78)                                                  
        binc=b1inc+b2inc                                                        
      else if(law.ge.1990) then                                                 
        binc = b1inc+b2inc+ comnew(8)+ comnew(78)                               
c       write(0,*) 'b1inc+b2inc',b1inc,b2inc                                    
        if(law.eq.2009) binc = binc - comnew(78) + data(82)                     
        if(law.ge.2020.and.data(82).gt.0) then                                  
c 2020+ CARES has $10200 unemployment exemption for a taxpayer(and spouse)      
c if modified AGI<2*poverty level*household sizelmtax                           
                                                                                
           nsize = 1                                                            
           if(mst.eq.2) nsize = 2                                               
           nsize = nsize + int(data(8))                                              
           ulevel = 2*povert(law)*nsize                                         
           hyun = comnew(2)+data(91)-comnew(79)+data(82)-comnew(78)             
           unded = 0.d0                                                         
           if(hyun.le.ulevel) then                                              
             unded = min(data(82)-data(180),uithrs(law))+                       
     &               min(data(180),uithrs(law))                                 
           endif                                                                
           binc = binc + data(82) - comnew(78) - unded                          
        endif                                                                   
        if(law.ge.1999) binc = binc + max(0.0d0,data(14)-100*data(7))           
                                                                                
      endif                                                                     
c Deducations part MA Form 1                                                    
c Amount paid to Soc. Sec , Medicare                                            
      fica=min(socsec(data,comnew,law),sslim(law))                              
      if(data(2).eq.2) then                                                     
c         data85 = data(85)                                                     
c         data86 = data(86)                                                     
c        temp85  = max(data(86),data(85))                                       
c         temp86  = min(data(86),data(85))                                      
c        data(85) = temp85                                                      
c         data(86) = 0.                                                         
c         fica85=min(socsec(data,comnew,law)-                                   
c     &  .5*(comnew(175)+data(44)),sslim(law))                                  
c         data(86) = temp86                                                     
c         data(85) = 0.                                                         
c         fica86=min(socsec(data,comnew,law)-                                   
c     &  .5*(comnew(175)+data(44)),sslim(law))                                  
c         data(85)=data85                                                       
c         data(86)=data86                                                       
          fica85=min(.5*comnew(183),sslim(law))                                 
          fica86=min(.5*comnew(184),sslim(law))                                 
          fica = fica85 + fica86                                                
      endif                                                                     
c dependents are less than 12 y.o. or over 65 y.o.                              
      ch = 0.d0                                                                 
      ch1 = 0.d0 
      chcred = 0.d0                                                             
      depcrd = 0.d0                                                             
c data(207) -- number of children eligible for the Child Care Credit            
c data(209) -- number of dependents not eligible for EIC                        
c data(203) -- number of children eligible for the EIC                          
c data(8)   -- number of dependents                                             
      ndep13 = int(min(data(207),2.0d0))                                             
      d209 = max(data(209),data(8) - data(203))                                 
      ndep = int(min(d209+ndep13,2.d0))                                              
      if(ndep.gt.0.d0) then                                                     
          if(law.le.1996) ch=600.                                               
          if(law.ge.1997.and.law.le.2000) ch=1200.                              
          if(law.eq.2001) ch=2400.*ndep13                                         
          if(law.ge.2002.and.law.le.2020) ch=3600.*ndep13                         
c 2021 ch deduction is 0, but there is chcred                                   
          if(law.eq.2021) ch = 0.d0                                             
          if(law.eq.1982) ch=min(ch,2000.*data(207))                            
          if(sep.eq.2) ch = 0.d0                                                
c dependent care expenses up to $4800 (2010+) for one child                     
          if(law.lt.2010) then                                                  
            ch1 = min(data(64),2400.d0*ndep13)                                  
          else if(law.eq.2010.and.law.le.2020) then                                                                 
            ch1 = min(data(64),4800.d0*ndep13) 
	  else if(law.ge.2021) then
	    chcred =  min(data(64),240.d0*ndep13)
          endif                                                                 
          earned = comnew(37)                                                   
          if(mst.ne.2) then                                                     
             ch1 = max(0.0d0,min(ch1,earned)) 
	     chcred = max(0.0d0,min(chcred,earned)) 
          else if(mst.eq.2) then                                                
            earnww = max(0.d0,earned - data(85) - data(86))                     
            earnh = data(85) + earnww/2                                         
            earnw = data(86) + earnww/2                                         
c qbi for primary taxpayer and spouse separate                                  
            if(d17.gt.0.d0) then                                                
              setax = comnew(175)                                               
              setaxh = setax*(data(211) + data(212))/d17                        
              setaxw = setax*(data(214) + data(215))/d17                        
              seleft = setax - setaxh - setaxw                                  
              earnww = max(0.0d0,data(17)+data(21)-.5*seleft)                   
              earnh = max(0.0d0,data(85)+data(211)+data(212)-.5*setaxh)         
     &        +earnww/2                                                         
              earnw = max(0.0d0,data(86)+data(214)+data(215)-.5*setaxw)         
     &        +earnww/2                                                         
            endif                                                               
            ch1 = max(0.0d0,min(ch1,earnh,earnw)) 
	    chcred = max(0.0d0,min(chcred,earnh,earnw))
          endif                                                                 
          ch = max(ch,ch1)      
      endif                                                                     
c  50% rental deduction                                                         
      if(law.eq.1981) rnt = data(160)*.5                                        
      if(law.ge.1982) rnt = min(data(160)*.5,2500.0d0)                          
      if(law.ge.1997.and.law.le.2001.and.(mst.eq.3.or.mst.eq.6))                
     & rnt=min(data(160)*.5,1250.0d0)                                           
      if(law.ge.2001)  rnt=min(data(160)*.5,3000.d0/sep)                        
c provision actually starts earlier;TAXSIM var does not until 1982              
      if(law.ge.1982)bus=data(27)                                               
      bded=fica+ch+rnt+bus+data(26)+data(30)+data(62)                           
c      write(0,*) 'fica ch rnt bus',int(fica),int(ch),int(rnt),int(bus)         
c Income after deductions                                                       
      tbinc1 = max(0.d0,binc - bded)                                            
c      write(0,*) 'binc bded tbinc1',binc,bded,tbinc1                           
c Income after exemptions                                                       
      tbinc2 = max(0.d0,tbinc1 - exemp)                                         
c      write(0,*) 'tbinc2 exemp tbinc1',tbinc2,exemp,tbinc1                     
                                                                                
                                                                                
c   calculate A INCOME; taxed at 10%; after 1990 taxed at 12%                   
      if(law.le.1996) then                                                      
        cg = 0.                                                                 
c   calculc cap gain using massachusetts exclusion,limit loss carryforward      
        cfd = 0.                                                                
        ccg = data(67)+data(69)                                                 
c   carryovers already included in gains figures                                
        if(law.le.1982)cg = data(70)-max(data(70)*gnx(law),0.0d0)               
     &   +data(68)+ccg                                                          
        if(law.ge.1983)cg = data(70)+data(68)                                   
     &    -max((data(70)+data(68))*gnx(law),0.0d0)+ccg                          
        if(ccg.le.cg) then                                                      
          cg = cg-ccg                                                           
          cfd = 0.                                                              
        else                                                                    
          cfd = min(1000.0d0,ccg-cg)                                            
          cg = max(0.0d0,cg-ccg)                                                
        endif                                                                   
        ainc = cg + max(0.0d0,data(14)+data(12)-cfd)                            
      else if(law.eq.1997.or.law.eq.1998) then                                  
        ainc = data(12) + data(14)                                              
      else                                                                      
        ainc = 0.                                                               
        if(data(68).gt.0.d0) ainc = data(68)                                    
      endif                                                                     
      ainc1 = ainc                                                              
      exded = 0.                                                                
      exdedc = 0.                                                               
                                                                                
                                                                                
                                                                                
c Specific order in which deductions/exemptions must be taken                   
      if(law.le.1989) then                                                      
       loss1=0.                                                                 
       loss2=0.                                                                 
       if(b1inc.lt.0.)loss1=b1inc                                               
       if(b2inc.lt.0.)loss2=b2inc                                               
       if(law.le.1988) then                                                     
         binc=max(0.0d0,binc-bded)                                              
         xtra=max(0.0d0,exemp-binc)                                             
         binc=max(0.0d0,binc-exemp)                                             
         ainc=max(0.0d0,ainc-(x*xtra))                                          
       else if(law.eq.1989) then                                                
c  calculate 5.375% taxable income                                              
         b1inc=max(0.0d0,b1inc+loss2)                                           
         xded=max(0.0d0,min(bded,bded-b1inc))                                   
         b1inc=max(0.0d0,b1inc-bded)                                            
         xex=max(0.0d0,exemp-b1inc)                                             
         b1inc=max(0.0d0,b1inc-exemp)                                           
c  calculate 5% taxable income                                                  
         b2inc=max(0.0d0,b2inc+loss1)                                           
         b2inc=max(0.0d0,b2inc-xded)                                            
         xex2=max(0.0d0,xex-b2inc)                                              
         b2inc=max(0.0d0,b2inc-xex)                                             
c  'x' is  marital status binary variable                                       
         ainc=max(0.0d0,ainc-(x*xex2))                                          
       endif                                                                    
      else if(law.ge.1990.and.law.le.1998) then                                 
        bagi = binc - bded                                                      
        if(bagi.lt.exemp.and.sep.eq.1) then                                     
           exded = exemp - bagi                                                 
           ainc=max(0.0d0,ainc-exded)                                           
        endif                                                                   
      endif                                                                     
                                                                                
                                                                                
c Interest(other than MA State) and Dividend income (MA Sch B)                  
c Applicable to tax years beginning on or after January 1,1999,                 
c the tax rate on dividends and interst (other than interst from                
c Massachusetts banks) is LOWERED from 12% to 5.95%                             
      binc1 = 0.d0                                                              
      tbinc3 = 0.d0                                                             
      divrec = max(data(12),data(176)+data(177))                                
      if(law.ge.1999) then                                                      
        if(comnew(6).ge.0) then                                                 
          binc1 = divrec                                                        
        else                                                                    
c Taxpayer has dividends&capital loss                                           
          xlin2 = min(divrec,2000.0d0)                                          
          xlin3 = abs(min(data(68),0.0d0))                                      
          xlin4 = max(0.0d0,xlin2 - xlin3)                                      
          xlin5 = abs(comnew(6))                                                
          xlin6 = min(xlin4,xlin5)                                              
          binc1 = divrec-xlin6                                                  
        endif                                                                   
c Excess exemptions from Basic Income from Part 1 MA Form 1                     
        excxmp = 0.                                                             
        if(binc-bded.lt.exemp.and.sep.eq.1)                                     
     &  excxmp = exemp - max(0.0d0,binc-bded)                                   
c        write(0,*) 'excxmp',excxmp                                             
c Excess exemptions for STCG income                                             
        if(binc1.lt.excxmp.and.sep.eq.1) then                                   
           exded = excxmp - binc1                                               
        endif                                                                   
c       write(0,*) 'exded',exded                                                
c Excess exemptions for LTCG income                                             
        if(ainc.lt.exded.and.sep.eq.1) then                                     
           exdedc = exded - ainc                                                
        endif                                                                   
c       write(0,*) 'exdedc',exdedc                                              
        ainc=max(0.0d0,ainc-exded)                                              
c Part 1 of MA Schedule B                                                       
        xl9 = max(data(12),data(176) + data(177))                               
c Schedule B through line 31                                                    
        xl19 = data(68)                                                         
        xl20 = 0.d0                                                             
        xl21 = 0.d0                                                             
        xl22 = 0.d0                                                             
        xl23 = 0.d0                                                             
        if(data(68).lt.0.d0) then                                               
c Taxpayer has dividends&capital loss                                           
          xl20 = min(2000.d0,min(divrec,abs(data(68))))                         
          xl21 = data(68) + xl20                                                
          if(xl21.lt.0.d0.and.data(70).gt.0.d0)                                 
     &    xl22 = min(abs(xl21),data(70))                                        
          xl23 = xl21 + xl22                                                    
        endif                                                                   
        xl24 = max(0.d0,xl19)                                                   
        xl25 = 0.d0                                                             
        if(data(68).gt.0.0d0.and.data(70).lt.0.d0)                              
     &  xl25 = min(data(68),abs(data(70)))                                      
        xl26 = xl24 - xl25                                                      
        xl27 = 0.d0                                                             
        xl28 = xl26                                                             
        xl29 = xl9                                                              
        xl30 = xl20                                                             
        xl31 = xl29 - xl30                                                      
c       write(0,*) 'xl9 xl19 xl24 ',int(xl9),int(xl19),int(xl24)                
c       write(0,*) 'xl25 xl26 xl27 xl28 xl29 xl30 xl31',                        
c     & int(xl25),int(xl26),int(xl27),int(xl28),int(xl29),                      
c     & int(xl30),int(xl31)                                                     
c Schedule D through line 15                                                    
        dxl13 = data(70)                                                        
        dxl14 = xl22                                                            
        if(dxl13.ge.0.0d0) then                                                 
            dxl15 = dxl13 - dxl14                                               
        else                                                                    
            dxl15 = dxl13 + dxl14                                               
        endif                                                                   
        xl32 = 0.d0                                                             
        xl33 = xl31 - xl32                                                      
        xl34 = xl28                                                             
        xl35  = xl33 + xl34                                                     
        if(xl31.gt.0.d0.and.dxl15.lt.0) then                                    
c Worksheet for xl32 and dxl16                                                  
          wxl1 = xl29                                                           
          wxl2 = min(2000.d0,wxl1)                                              
          wxl3 = xl30                                                           
c        write(0,*) 'wxl1 wxl2 wxl3',wxl1,wxl2,wxl3                             
          wxl4 = max(0.d0,wxl2 - wxl3)                                          
          wxl5 = abs(min(0.d0,data(70) - xl22))                                 
          if(wxl4.le.wxl5) then                                                 
            xl32 = wxl4                                                         
          else                                                                  
            xl32 = wxl5                                                         
          endif                                                                 
c       write(0,*) 'wxl4 wxl5 xl32',wxl4,wxl5,xl32                              
        endif                                                                   
        dxl16 = xl32                                                            
        dxl17 = dxl16 + dxl15                                                   
        dxl18 = 0.d0                                                            
        dxl19 = max(dxl17 - dxl18,0.d0)                                         
        wdxl1 = max(0.d0, xl35 )                                                
        wdxl2 = exemp                                                           
        wdxl3 = tbinc1                                                          
        wdxl4 = wdxl2 - wdxl3                                                   
        if(wdxl4.le.0.d0) then                                                  
           dxl20 = 0.d0                                                         
        else                                                                    
           if(wdxl1.gt.wdxl4) wdxl5 = wdxl4                                     
           if(wdxl4.ge.wdxl1) wdxl5 = wdxl1                                     
           wdxl6 = wdxl4 - wdxl5                                                
c       write(0,*) 'wdxl5 wdxl6 ',int(wdxl5),int(wdxl6)                         
           if(wdxl6.le.0.d0) then                                               
             dxl20 = 0.d0                                                       
           else                                                                 
             wdxl7 = max(0.d0,dxl19)                                            
c                   write(0,*) 'wdxl7 ',int(wdxl7)                              
             if(wdxl7.gt.wdxl6) dxl20 =  wdxl6                                  
             if(wdxl6.ge.wdxl6) dxl20 =  wdxl7                                  
           endif                                                                
        endif                                                                   
        xl33 = xl31 - xl32                                                      
        xl34 = xl28                                                             
c Part 4 of MA Schedule B (changes done 10/8/2020)                              
        xl35 = xl33 + xl34                                                      
c      write(0,*) 'xl33 xl34 xl35',                                             
c     & int(xl33),int(xl34),int(xl35)                                           
                                                                                
        xl36 = dxl20                                                            
        xl37 = max(0.d0,xl35 - excxmp)                                          
        if(xl37.ge.data(12)) then                                               
         xl38 = divrec                                                          
        else                                                                    
         xl38 = xl37                                                            
        endif                                                                   
        xl39 = xl37 - xl38                                                      
c       write(0,*) 'xl36 xl37 xl38 xl39 ',                                      
c     & int(xl36),int(xl37),int(xl38),int(xl39)                                 
        tbinc3 = xl38                                                           
c        write(0,*) 'tbinc2 tbinc3 ',tbinc2,tbinc3                              
        ainc = xl39                                                             
      endif                                                                     
c Total taxable B income                                                        
      taxbin = tbinc2 + tbinc3                                                  
      if(law.eq.2001) taxbin= max(0.0d0,taxbin-data(58)-data(59))               
c State Tax on B income (5%)                                                    
      if(law.ne.1989) then                                                      
        statxb=tab89(law)*taxbin                                                
      else                                                                      
        statxb=.05*b2inc+tab89(law)*max(0.0d0,b1inc)                            
      endif                                                                     
      rt=tab89(law)                                                             
c State Tax on  A income (12%)                                                  
      if(law.le.1989)statxa=.10*ainc                                            
      if(law.ge.1990)statxa=.12*ainc                                            
c Calculate C INCOME - long term capital gain income since 1997                 
      cinc = 0.                                                                 
c      if(law.ge.1997.and.data(70).ge.0) then                                   
      if(law.ge.1997.and.law.le.1998) cinc = comnew(15)                         
      if(law.ge.1999) then                                                      
         dxl13 = data(70)                                                       
         dxl14 = xl22                                                           
         if(dxl13.ge.0.0d0) then                                                
            dxl15 = dxl13 - dxl14                                               
         else                                                                   
            dxl15 = dxl13 + dxl14                                               
         endif                                                                  
         dxl16 = 0.d0                                                           
         if(dxl15.lt.0.d0) then                                                 
           wdxl1 = data(12)                                                     
           wdxl2 = min(wdxl1, 2000.d0)                                          
           wdxl3 = abs(min(data(68),0.d0))                                      
           wdxl4 = max(0.d0,wdxl2 - wdxl3)                                      
           wdxl5 = abs(min(data(70),0.d0))                                      
           wdxl6 = min(wdxl4,wdxl5)                                             
           dxl16 = wdxl6                                                        
         endif                                                                  
         dxl17 = dxl16 + dxl15                                                  
         dxl18 = 0.d0                                                           
         dxl19 = max(dxl17 - dxl18,0.d0)                                        
         wdxl1 = max(0.d0,xl35)                                                 
         wdxl2 = exemp                                                          
         wdxl3 = tbinc1                                                         
         wdxl4 = wdxl2 - wdxl3                                                  
         if(wdxl4.le.0.d0) then                                                 
           dxl20 = 0.d0                                                         
         else                                                                   
           if(wdxl1.gt.wdxl4) wdxl5 = wdxl4                                     
           if(wdxl4.ge.wdxl1) wdxl5 = wdxl1                                     
           wdxl6 = wdxl4 - wdxl5                                                
c       write(0,*) 'wdxl5 wdxl6 ',int(wdxl5),int(wdxl6)                         
           if(wdxl6.le.0.d0) then                                               
             dxl20 = 0.d0                                                       
           else                                                                 
             wdxl7 = max(0.d0,dxl19)                                            
c                   write(0,*) 'wdxl7 ',int(wdxl7)                              
                                                                                
             if(wdxl7.gt.wdxl6) dxl20 =  wdxl6                                  
             if(wdxl6.ge.wdxl6) dxl20 =  wdxl7                                  
           endif                                                                
                                                                                
         endif                                                                  
         dxl21 = max(0.d0,dxl19 - dxl20)                                        
         cinc = dxl21                                                           
         cinc1 = dxl13                                                          
c      write(0,*) 'wdxl1 wdxl2 wdxl3 wdxl4 ',                                   
c    & int(wdxl1),int(wdxl2),int(wdxl3),int(wdxl4)                              
                                                                                
c       write(0,*) 'dxl13 dxl14 dxl15 dxl16 ',                                  
c     & int(dxl13),int(dxl14),int(dxl15),int(dxl16)                             
c       write(0,*) 'dxl17 dxl18 dxl19 dxl20 dxl21',                             
c     & int(dxl17),int(dxl18),int(dxl19),int(dxl20),int(dxl21)                  
                                                                                
c      write(0,*) 'cinc cinc1',cinc,cinc1                                       
      endif                                                                     
                                                                                
c previous cinc lines do not work good                                          
c if(law.ge.1997.and.data(70).ge.0)cinc=max(0.d0,comnew(6)-exdedc)              
                                                                                
                                                                                
c State Tax on C income - long term capital gains income                        
      statxc = 0.                                                               
      if(law.ge.1997.and.law.le.2002) then                                      
        statxc = .05*max(0.0d0,cinc)                                            
      elseif(law.ge.2003.and.law.le.2011) then                                  
        statxc = .053*max(0.0d0,cinc)                                           
      elseif(law.ge.2012.and.law.le.2013) then                                  
        statxc = .0525*max(0.0d0,cinc)                                          
      elseif(law.eq.2014) then                                                  
        statxc = .052*max(0.0d0,cinc)                                           
      elseif(law.eq.2015) then                                                  
        statxc = .0515*max(0.0d0,cinc)                                          
      elseif(law.ge.2016.and.law.le.2018) then                                  
        statxc = .051*max(0.0d0,cinc)                                           
      elseif(law.eq.2019) then                                                  
        statxc = .0505*max(0.0d0,cinc)                                          
      elseif(law.ge.2020) then                                                  
        statxc = .05*max(0.0d0,cinc)                                            
      endif                                                                     
      if(law.ne.1984) then                                                      
        pretax=(statxa+statxb+statxc) * surtax(law) 
c	write(0,*) 'pretax statxb',pretax,statxb
      else                                                                      
        if(binc.gt.60000.) statxb = surtax(law)*statxb                          
        if(ainc.gt.60000.) statxa = surtax(law)*statxa                          
        pretax = statxa + statxb                                                
      endif                                                                     
c      write(0,*) 'statxb statxa statxc pretax',int(statxb),                    
c     & int(statxa),int(statxc), int(pretax)                                    
                                                                                
c only single and joint filers can receive credits                              
c for 1995 and on only single, joint and head of household                      
c can receive credits: No Tax Status or Limited Income Credit                   
      if (law.le.1994.and.law.ge.1984) then                                     
        if(mst.eq.1.or.mst.eq.7.or.mst.eq.4) then                               
          s=1                                                                   
        else if(mst.eq.2) then                                                  
          s=2                                                                   
        endif                                                                   
      elseif(law.ge.1995) then                                                  
        if(mst.eq.1) then                                                       
          s=1                                                                   
        elseif(mst.eq.2.or.mst.eq.7.or.mst.eq.4) then                           
          s=2                                                                   
        endif                                                                   
      endif                                                                     
c Massachusetts AGI                                                             
      agi = binc+binc1+data(68)+data(70)+min(data(14),100*data(7))              
                                                                                
c no tax status determination and sales tax credit                              
      agi = max(0.d0,agi)                                                       
      if(law.ge.1984.and.law.le.1994) then                                      
       if(s.eq.1) then                                                          
        if(agi.le.nts(law,1)) then                                              
          ntscr=pretax                                                          
        else if((agi.le.14000..and.agi.gt.nts(law,1)).and.                      
     &    (pretax.ge..1*(agi-nts(law,1))))  then                                
          txcr=max(pretax-((agi-nts(law,1))*.1),0.0d0)                          
        endif                                                                   
       else if(s.eq.2) then                                                     
        if(agi.le.nts(law,2)) then                                              
          ntscr=pretax                                                          
        else if(agi.le.21000..and.agi.gt.nts(law,2)) then                       
           txcr=max(pretax-((agi-nts(law,2))*.1),0.0d0)                         
        endif                                                                   
       endif                                                                    
      else if(law.ge.1995) then                                                 
       if(s.eq.1) then                                                          
          if(agi.le.nts(law,1))then                                             
             ntscr=pretax                                                       
          else if(agi.gt.nts(law,1).and.agi.le.14000.) then                     
             txcr=max(0.0d0,pretax - .1*(agi - nts(law,1)))                     
          endif                                                                 
       else if(s.eq.2) then                                                     
          numdep = int(data(8))                                                      
          if(mst.eq.7.or.mst.eq.4) then                                         
            ntsr  = nts  (law,2)                                                
            licrr = licrh(law)                                                  
          elseif (mst.eq.2) then                                                
            ntsr  = nts  (law,2) + add(law)                                     
            licrr = licrm(law)                                                  
          endif                                                                 
          if (agi.le.ntsr + numdep * 1000.) then                                
             ntscr = pretax                                                     
          else if(agi.gt.ntsr+numdep*1000.and.                                  
     &    agi.le.licrr+numdep*1750.)then                                        
             txcr=max(0.0d0,pretax-0.1*(agi - ntsr - numdep*1000.))             
          endif                                                                 
       endif                                                                    
      else                                                                      
         scred=(8.*data(7))+(4.*data(8))                                        
      endif                                                                     
c   tax can not reduce income below a certain point                             
c     Credits                                                                   
      credit=ntscr + txcr + scred + min(data(38),1000.0d0)                      
      statax=max(0.0d0,pretax-credit) 
c 1997-2000 State Earned Income Credit 10% of federal                           
c 2001-2015 State Earned Income Credit 15% of federal                           
c 2016+ State Earned Income Credit 23% of federal                               
      earncr = 0.d0                                                             
      if(law.ge.1997) then                                                      
        earncr = eicr(law)*comnew(59)                                           
        statax = statax - earncr                                                
        credit = credit + earncr                                                
      endif                                                                     
c 2021 dependent credit or child care credit refundable 
c      writE(0,*) 'statax chcred depcrd',int(statax),                           
c     & int(chcred),int(depcrd)
      if(law.ge.2021) then
        depcrd = ndep*180.d0                                                  
        credit = credit + max(chcred,depcrd)
        statax = statax - max(chcred,depcrd)                                         
c        writE(0,*) 'statax',int(statax)
        if(chcred.gt.depcrd) chcr = chcred      
      endif
c 2001+ certain not separate taxpayers age 65+ may be eligible for a ref crd    
      cbcred = 0.d0                                                             
      if(law.ge.2001.and.sep.eq.1.and.data(9).gt.0.d0) then                     
         hymax = 0.d0                                                           
         if(mst.eq.1) then                                                      
           hymax = hymaxs(law)                                                  
         else if(mst.eq.2.or.mst.eq.5) then                                     
           hymax = hymaxm(law)                                                  
         else if(mst.eq.4.or.mst.eq.7) then                                     
           hymax = hymaxh(law)                                                  
         endif                                                                  
         ptax = min(.1*hymax,max(data(51),.25*data(160)))                       
c         hycb = max(0.d0,binc - blind - ageex - depex)                         
c         hycb = max(0.d0,agi+data(91)-blind-ageex-depex)                       
         hycb = max(0.d0,agi+data(91)+data(41)-blind-ageex-depex)               
c        write(0,*) 'hycb ',hycb                                                
         if(hycb.le.hymax) then                                                 
           cbcred = max(0.d0,ptax - .1*hycb)                                    
         endif                                                                  
         cbcmax = cbmax(law)                                                    
         cbcred = min(cbcmax,cbcred)                                            
         statax = statax - cbcred                                               
         credit = credit + cbcred                                               
c       write(0,*) 'cbcred statax',cbcred,statax                                
      endif                                                                     
c      writE(0,*) 'statax ',int(statax)                                               
      taxinc = taxbin + ainc + cinc  
c      writE(0,*) 'taxinc taxbin ainc cinc',int(taxinc),taxbin,ainc,cinc                                               

      return                                                                    
      end                                                                       
c  MICHIGAN                                                                     
c  State 23                                                                     
c                                                                               
c  Updated through 2021 (03/14/2022)                                            
      subroutine mitax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     & earncr,credit,rt                                                         
      common/times/zitem,ptax,txrate,h                                          
      dimension data(255),comnew(255)                                           
      dimension proptb(2,5),prtb18(2,5),fuelc1(6),rate(1977:2021),              
     & cin(1977:1984)                                                           
      dimension xmp(1977:2021,2),pallow(1977:2021),fuelc2(6,1985:2005)          
      dimension flmax(1984:2021),altmax(3,1984:2010)                            
      dimension cin2(1985:2021),fuelc3(2006:2021),frt(1977:2021)                
      dimension oldded(1994:2021),pended(1994:2021),reic(2008:2021)             
      dimension pcra(2,11),pc18(2,11)                                           
      data reic/0.1d0,3*0.2d0,10*0.06d0/                                        
      data pcra /                                                               
     & 21001.d0, 1.d0,22001.d0,.96d0,23001.d0,.92d0,24001.d0,.88d0,             
     & 25001.d0,.84d0,26001.d0,.80d0,27001.d0,.76d0,28001.d0,.72d0,             
     & 29001.d0,.68d0,30001.d0,.64d0,50001.d0,.60d0/                            
      data pc18 /                                                               
     & 51001.d0, 1.d0,52001.d0,.9d0,53001.d0,.8d0,54001.d0,.7d0,                
     & 55001.d0, .6d0,56001.d0,.5d0,57001.d0,.4d0,58001.d0,.3d0,                
     & 59001.d0, .2d0,60001.d0,.1d0,1.e20,0.d0/                                 
      data pended/                                                              
     &        13125.0d0,  30945.0d0,  31920.0d0,  32880.0d0,                    
     &        33630.0d0,  34170.0d0,  34920.0d0,  36090.0d0,                    
     &        37110.0d0,  37710.0d0,  38550.0d0,  39570.0d0,                    
     &        40920.0d0,  42240.0d0,  43440.0d0,2*45120.0d0,                    
     &        45842.0d0,  47309.0d0,  48302.0d0,  49027.0d0,                    
     &        49811.0d0,  49861.0d0,  50509.0d0,  51570.0d0,                    
     &        52808.0d0,  53759.0d0,  54404.0d0/                                
      data oldded/ 250.d0, 1032.d0, 1064.d0,   3500.d0, 7500.d0,                
     &   7620.d0, 7785.d0, 8048.d0, 8273.d0,   8408.d0, 8595.d0,                
     &   8828.d0, 9128.d0, 9420.d0, 9690.d0,2*10058.d0,10218.d0,                
     &  10545.d0,10767.d0,10929.d0,11104.d0,  11115.d0,11259.d0,                
     &  11495.d0,11771.d0,11983.d0,12127.d0 /                                   
      data rate/                                                                
     &           5*.046d0, .051d0 ,  .0635d0,  .0585d0,  .0533d0,               
     &           8*.046d0, .0447d0,5*.044d0 ,2*.042d0 ,  .041d0 ,               
     &             .04d0 , .0395d0,2*.039d0 ,  .0401d0,4*.0435d0,               
     &             .0433d0,9*.0425d0/                                           
c 2012+ no longer special exemption for seniors age 65 or older                 
c 2012+ no longer spercial exemp for unemployment comp = at least .5*agi        
      data xmp/                                                                 
     1        10*1500.0d0,  1600.0d0,  1800.0d0,  2000.0d0, 5*2100.0d0,         
     1         2*2400.0d0,  2500.0d0,2*2800.0d0,2*2900.0d0,   3000.0d0,         
     1         2*3100.0d0,  3200.0d0,  3300.0d0,  3400.0d0,   3500.0d0,         
     1         2*3600.0d0,  3700.0d0,  3763.0d0,  3950.0d0, 4*4000.0d0,         
     1           4050.0d0,  4400.0d0,  4750.0d0,  4900.0d0,                     
     2            10*.0d0,  1400.0d0,  1200.0d0,  1000.0d0,  10*900.0d0,        
     2           1800.0d0,3*1900.0d0,2*2000.0d0,  2100.0d0,  2*2200.0d0,        
     2         2*2300.0d0,2400.0d0, 10*0.0d0/                                   
      data pallow/                                                              
     &                    5*1.e20,  65000.0d0,  68500.0d0,  70950.0d0,          
     &               27*73650.0d0,6*41000.0d0,  3*51000.0d0,51600.0d0/          
      data proptb /                                                             
     &          3000.0d0,      .0d0,   4000.0d0,     .01d0,                     
     &          5000.0d0,     .02d0,   6000.0d0,     .03d0,                     
     &             1.e20,    .035d0/                                            
      data prtb18 /                                                             
     &          3000.0d0,      .0d0,   4000.0d0,     .01d0,                     
     &          5000.0d0,     .02d0,   6000.0d0,     .03d0,                     
     &             1.e20,    .032d0/                                            
      data frt /0.d0,29*.76d0,.53d0,2*.65d0,2*.52d0,.48d0,.49d0,2*.5d0,         
     &         .67d0, 2*.75d0,.8d0,.85d0,1.d0/                                  
      data fuelc3 / 378.d0, 394.d0, 401.d0, 2*418.d0,420.d0, 431.d0,            
     &  443.d0, 2*450.d0, 458.d0, 465.d0, 468.d0,482.d0,492.d0,497.d0/          
      data fuelc1 /200.d0, 240.d0, 280.d0, 310.0d0, 340.0d0, 370.0d0/           
      data fuelc2/                                                              
     & 272.0d0, 326.0d0, 379.0d0, 421.0d0, 480.0d0, 550.0d0,                    
     & 272.0d0, 326.0d0, 379.0d0, 425.0d0, 497.0d0, 570.0d0,                    
     & 272.0d0, 326.0d0, 379.0d0, 433.0d0, 506.0d0, 579.0d0,                    
     & 272.0d0, 326.0d0, 379.0d0, 450.0d0, 525.0d0, 601.0d0,                    
     & 272.0d0, 326.0d0, 389.0d0, 467.0d0, 546.0d0, 624.0d0,                    
     & 272.0d0, 326.0d0, 408.0d0, 490.0d0, 573.0d0, 655.0d0,                    
     & 272.0d0, 326.0d0, 408.0d0, 490.0d0, 573.0d0, 655.0d0,                    
     & 272.0d0, 355.0d0, 447.0d0, 539.0d0, 630.0d0, 722.0d0,                    
     & 272.0d0, 365.0d0, 459.0d0, 554.0d0, 649.0d0, 743.0d0,                    
     & 285.0d0, 380.0d0, 476.0d0, 571.0d0, 667.0d0, 762.0d0,                    
     & 285.0d0, 380.0d0, 476.0d0, 571.0d0, 667.0d0, 762.0d0,                    
     & 285.0d0, 380.0d0, 476.0d0, 571.0d0, 667.0d0, 762.0d0,                    
     & 305.0d0, 410.0d0, 515.0d0, 619.0d0, 724.0d0, 829.0d0,                    
     & 312.0d0, 420.0d0, 528.0d0, 635.0d0, 743.0d0, 851.0d0,                    
     & 319.0d0, 428.0d0, 536.0d0, 645.0d0, 754.0d0, 862.0d0,                    
     & 323.0d0, 435.0d0, 547.0d0, 658.0d0, 770.0d0, 882.0d0,                    
     & 332.0d0, 448.0d0, 565.0d0, 681.0d0, 797.0d0, 914.0d0,                    
     & 342.0d0, 461.0d0, 579.0d0, 698.0d0, 816.0d0, 935.0d0,                    
     & 347.0d0, 468.0d0, 589.0d0, 709.0d0, 830.0d0, 951.0d0,                    
     & 359.0d0, 482.0d0, 604.0d0, 727.0d0, 849.0d0, 972.0d0,                    
     & 369.0d0, 495.0d0, 620.0d0, 746.0d0, 871.0d0, 997.0d0/                    
      data  altmax/                                                             
     &    6263.0d0, 8428.0d0, 9231.0d0,  6463.0d0, 8698.0d0,                    
     &    9108.0d0, 6569.0d0, 8840.0d0,  9315.0d0,                              
     &    6678.0d0, 9122.0d0, 9285.0d0,  7060.0d0, 9154.0d0,                    
     &    9154.0d0, 7420.0d0, 9986.0d0, 11218.0d0,                              
     &    7790.0d0,10485.0d0,11491.0d0,  7790.0d0,10485.0d0,                    
     &   11491.0d0, 8313.0d0,11190.0d0, 11718.0d0,                              
     &    8523.0d0,11473.0d0,11927.0d0,  8789.0d0,11831.0d0,                    
     &   11927.0d0, 8789.0d0,11831.0d0, 11927.0d0,                              
     &    8789.0d0,11831.0d0,11927.0d0,  9558.0d0,12755.0d0,                    
     &   12755.0d0, 9774.0d0,12764.0d0, 12764.0d0,                              
     &   10011.0d0,12873.0d0,12873.0d0, 10350.0d0,13209.0d0,                    
     &   13209.0d0,10703.0d0,13573.0d0, 13573.0d0,                              
     &   10922.0d0,14345.0d0,14346.0d0, 10922.0d0,14345.0d0,                    
     &   14346.0d0,10922.0d0,14345.0d0, 14346.0d0,                              
     &   10922.0d0,14345.0d0,14346.0d0, 12066.0d0,16230.0d0,                    
     &   20282.0d0,12263.0d0,16502.0d0, 20282.0d0,                              
     &   12590.0d0,16942.0d0,21298.0d0, 12590.0d0,16942.0d0,                    
     &   21298.0d0,12691.0d0,17078.0d0, 21469.0d0/                              
      data flmax/                                                               
     &          1200.0d0, 1184.0d0, 1211.0d0, 1207.0d0,  1190.0d0,              
     &          1234.0d0, 1264.0d0, 1264.0d0, 1289.0d0,3*1312.0d0,              
     &          1400.0d0, 1403.0d0, 1404.0d0, 1416.0d0,  1453.0d0,              
     &          1493.0d0, 1578.0d0, 1687.0d0, 1843.0d0,  2028.0d0,              
     &        2*2231.0d0, 2351.0d0, 2430.0d0,2*2506.d0,4*2598.0d0,              
     &          2642.0d0, 2737.0d0, 2*2741.0d0,2870.d0,  3047.0d0/              
c inflation factor for fuel credit; uneven in later years                       
      data cin/                                                                 
     &      .0d0,  2*1.0d0, 1.13d0, 1.16d0, 1.27d0, 2*1.36d0/                   
c alternate inflation factor for some backets, fuel credit                      
      data cin2/                                                                
     &      70.d0,  73.d0,  74.d0,  76.d0,  79.d0,  83.d0,                      
     &      86.d0,  92.d0,  95.d0,  96.d0,  99.d0, 102.d0,                      
     &     105.d0, 108.d0, 111.d0, 112.d0, 116.d0, 119.d0,                      
     &     121.d0, 122.d0, 126.d0, 131.d0, 134.d0, 139.d0,                      
     &   2*144.d0, 147.d0, 152.d0, 155.d0,2*156.d0,160.d0,                      
     &     161.d0, 166.d0, 170.d0, 173.d0,  175.d0  /                           
      mst=int(data(2))                                                               
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      nfile = int(filing(mst,1.,2.,3.,2.))                                      
      rt=rate(law)                                                              
      stded = 0.                                                                
c     AGI                                                                       
      agi=comnew(2)+min(data(65),data(7)*50.)                                   
      if(law.ge.1982.and.law.le.1986)agi=agi+comnew(32)                         
c Social Security benefits are not taxable in Michigan                          
      if(law.ge.1984) agi = agi-comnew(79)                                      
c Additions to income                                                           
      if(law.ge.1998.and.law.ne.2011.and.law.ne.2012)                           
     & agi = agi + .5*comnew(175)                                               
                                                                                
      if(law.eq.2011.or.law.eq.2012) then                                       
c 2011-2012 : 5.65% instead of 7.65%                                            
          if(comnew(175).le.14204.) then                                        
           agi = agi + .5751*comnew(175)                                        
          else                                                                  
           agi = agi + .5*comnew(175) + 1067                                    
          endif                                                                 
      endif                                                                     
c      write(0,*) '1 agi',agi                                                   
c Pensions Exclusion                                                            
      penexc = 0.                                                               
      if(law.le.1993) then                                                      
       if(nfile.ne.2)then                                                       
        penexc = min(data(20)+data(72),7500.0d0)                                
       else if(nfile.eq.2) then                                                 
        penexc = min(((data(20)+data(72))/sep),10000.0d0)                       
       endif                                                                    
      else                                                                      
         penexc = min(data(20)+data(72),pended(law)*data(7))                    
         if(law.eq.1994.and.mst.eq.2)                                           
     & penexc = min(data(20)+data(72),22500.0d0)                                
      endif                                                                     
      if(data(9).lt.1) penexc = 0.                                              
c 1994+ Senior citizens age 65+ who do not deduct retirement benefits           
c may deduct part of their dividend and interest income (+capgn for 1997+)      
      divded = 0.                                                               
      if(law.ge.1994.and.data(9).gt.0) then                                     
        if(law.le.1996) then                                                    
           unearned = data(12)+data(14)                                         
        else                                                                    
           unearned = data(12)+data(14)+max(0.0d0,comnew(6))                    
        endif                                                                   
        divded = min(unearned,oldded(law)*data(7))                              
      endif                                                                     
c Michigan standard deduction. If the older of you or your spouse               
c was born during the period 01/01/1946 through 01/01/1951(for 2017),           
c and reached the age of 67 on or before 12/01/2017,                            
c you may deduct $20,000 for single or married filing separately filers or      
c $40,000 for joint filers against all income,                                  
c rather than solely against retirement and pension income.                     
c Taxpayers that qualify for the Michigan Standard Deduction are not eligible   
c to deduct retirement and pension income on the Michigan Pension Schedule (Form
      pens = max(penexc,divded)                                                 
      if (law.ge.2013.and.data(9).gt.0.d0) then                                 
         stded = min(20000.0d0*data(9),data(20)+data(72))                       
         stded =  20000*data(9)                                                 
        pens = stded                                                            
      endif                                                                     
c Ignore standard deduction                                                     
c      agi = agi-pens                                                           
c Exemptions                                                                    
      num=int(data(7)+data(8)+data(9)+data(10))                                      
      old=data(9)+data(10)                                                      
      if(law.lt.1987) then                                                      
        exemp=num*xmp(law,1)                                                    
      else if(law.ge.1987) then                                                 
c extra exemption for the unemployed                                            
        ump=0.                                                                  
        if(data(82).ge.comnew(2)*.5)ump=1.                                      
        exemp=((num-old)*xmp(law,1))+((old+ump)*xmp(law,2))                     
        if(law.ge.2000.and.law.le.2011) exemp = exemp + data(8)*600             
        if((law.eq.1998.or.law.eq.1999).and.data(8).gt.0)                       
     &  exemp = exemp + 300*data(8)                                             
      endif                                                                     
      if(data(105).gt.0.d0) exemp = 1500.d0                                     
c  Computation of Taxable Income and Tax                                        
      taxinc=max(agi-pens-exemp,0.0d0)                                          
      regtax=rate(law)*taxinc                                                   
c      write(0,*) 'agi exemp taxinc regtax',agi,exemp,taxinc,regtax             
      if(data(105).gt.0.d0.and.agi.lt.1500.d0) then                             
         exemp  = 0.d0                                                          
         taxinc = 0.d0                                                          
         regtax = 0.d0                                                          
      endif                                                                     
c  solar energy credit                                                          
      solar=0.                                                                  
      if(law.ge.1979)solar=data(38)                                             
c  regular property tax credit is refundable                                    
      ptax=0.                                                                   
      pcred=0.                                                                  
c Non-negative total household resources                                        
      hhy = max(0.d0,data(159) - .5*comnew(175))                                
      all = 0.d0                                                                
      all = pallow(law)                                                         
      if(hhy.le.all+9000.d0) then                                               
        if(law.le.2017) then                                                    
           ptax=data(51)+xif(law.le.1993,.17*data(160))                         
     &          +xif(law.ge.1994,.2*data(160))                                  
        else                                                                    
           ptax=data(51)+.23d0*data(160)                                        
        endif                                                                   
        if(old.lt.1.) then                                                      
          if(law.le.2017) then                                                  
             pcred=.6*max(ptax-.035d0*hhy,0.0d0)                                
          else                                                                  
             pcred=.6*max(ptax-.032d0*hhy,0.0d0)                                
          endif                                                                 
c         write(0,*) 'hhy ptax pcred',hhy,ptax,pcred                            
        else if(data(9).gt.0.and.data(10).lt.1.) then                           
c special old age property tax credit                                           
c assume state equalized value of homestead less than r3500.                    
          if(law.lt.1980) then                                                  
            pcred=ptax                                                          
          else if(law.ge.1980) then                                             
            if(law.le.2017) then                                                
              tbl2 = tablki(proptb,5,hhy,data)                                  
            else                                                                
              tbl2 = tablki(prtb18,5,hhy,data)                                  
            endif                                                               
            pcred = max(ptax - tbl2*hhy,0.d0)                                   
            if(law.ge.2012) then                                                
c percentage for 2012+ for senior claimants                                     
              tbl1 = tablki(pcra,11,hhy,data)                                   
              pcred = pcred*tablki(pcra,11,hhy,data)                            
              a = tablki(pcra,11,hhy,data)                                      
              b = tablk(pcra,11,hhy,data)                                       
            endif                                                               
c alternative pcred for senior renters                                          
            if(data(160).gt.0) pcred = max(pcred,data(160)-.4*hhy)              
          endif                                                                 
        else if(data(10).gt.0) then                                             
c special blind or veteran's property tax credit                                
          pcred=ptax                                                            
        endif                                                                   
        if(law.le.2017) then                                                    
           pcred=min(pcred,1200.0d0)                                            
        else                                                                    
           pcred=min(pcred,1500.0d0)                                            
        endif                                                                   
c reduction of credit for hhy over a certain amount                             
        if(hhy.gt.all) then                                                     
          over=(max(hhy-all,0.0d0))/1000.                                       
          pcred=pcred*max(0.0d0,(1.-.1*over))                                   
        endif                                                                   
      endif                                                                     
c fuel credit - Home Heating Credit Claim                                       
      fuel = 0.                                                                 
c Standard Credit                                                               
      nexemp = 0                                                                
      amex = data(7)+data(8)+data(10)                                           
      if(data(105).gt.0.d0) amex = 0.d0                                         
c Looks like MI does not include elderly exemption in amex                      
      nexemp=int(min(amex,6.0d0))                                                    
      xemp=max(0.0d0,amex - 6.)                                                 
      if(nexemp.gt.0) then                                                      
        if(law.le.1984) then                                                    
         fuel=max(0.0d0,(fuelc1(nexemp)*cin(law))-.035*hy)                      
        else                                                                    
c fuel credits are unevenly adjusted 1985-2005                                  
         if(law.le.2005)fc=fuelc2(nexemp,law)+xemp*cin2(law)                    
         if(law.ge.2006)fc=fuelc3(law)+max(0.0d0,amex-1)*cin2(law)              
c        write(0,*) 'fc=',fc                                                    
         fuel=max(0.0d0,fc-.035*hy)                                             
c        write(0,*) '1 fuel',fuel                                               
        endif                                                                   
      endif                                                                     
c Alternate Credit                                                              
c      if(law.ge.1984) then                                                     
c         num = 2                                                               
c         if(amex.ge.3) then                                                    
c           num = 3                                                             
c         else if(amex.le.1) then                                               
c          num = 1                                                              
c         endif                                                                 
c         if(data(159).le.altmax(num,law)) then                                 
c           fuel  = max(fuel,.7 * max(0.0d0,flmax(law)-.11*hy))                 
c         endif                                                                 
c      endif                                                                    
c Home Heating Credit MI-1040CR-7                                               
      fuel = fuel*frt(law)                                                      
c      write(0,*) '2 fuel frt',fuel,frt(law)                                    
c Earned income credit since 2008                                               
      earncr = 0.                                                               
      if(law.ge.2008) then                                                      
         earncr = reic(law)*comnew(59)                                          
      endif                                                                     
c      write(0,*) 'earncr',earncr                                               
      credit=solar+fuel+pcred+earncr                                            
c changed for new accounting of refundable credits; solar was the               
c only regularly non-refundable credit                                          
      statax=max(0.0d0,regtax-solar)-pcred-fuel-earncr                          
c      write(0,*) 'statax fuel earncr pcred',statax,fuel,earncr,pcred           
c50     continue                                                                
       return                                                                   
       end                                                                      
c  MINNESOTA                                                                    
c  State 24                                                                     
c                                                                               
c  Updated through 2021(03/14/2022)                                             
      subroutine mntax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer deps,sep,txp                                                      
      common /fed/ zbrack(3,1987:2022),exem(1987:2022)                          
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      common/temp/count                                                         
c Schedule M1MT, Alternative Minimum Tax                                        
      dimension phase(3),excl(2001:2021,3),perc(2001:2021)                      
c stadd 2011-2013 only                                                          
      dimension aif01(2001:2008),stadd(2011:2013),aif91(2013:2021)              
      dimension wfc0(1999:2013,2),wfc1(1999:2013,4),wfc2(1999:2013,4)           
c wfcj for 2002-2013                                                            
      dimension wfcj(2002:2013,0:2)                                             
      dimension rwfc0(1999:2013),rwfc1(1999:2013,3),rwfc2(1999:2013,3)          
      dimension fc0(1999:2013),fc1(1999:2013,2),fc2(1999:2013,2)                
c working family credit 2014-2020                                               
      dimension wf0(2014:2021),w01(2014:2021),w02(2014:2021),                   
     &wj02(2014:2021)                                                           
      dimension wf1(2014:2021),w11(2014:2021),w12(2014:2021),                   
     &wj12(2014:2021)                                                           
      dimension wf2(2014:2021),w21(2014:2021),w22(2014:2021),                   
     &wj22(2014:2021)                                                           
      dimension wf3(2019:2021),w31(2019:2021),w32(2019:2021),                   
     &wj32(2019:2021)                                                           
c                                                                               
      dimension cred(1977:1986),plmax(1977:1986),cded(1977:2021)                
      dimension stnd(1988:2021,5),base(2),workcr(2)                             
      dimension stdaif(1977:1986), cmax(1977:2021,2), seless(1977:2021)         
      dimension pnsion (1977:1986,2),semax(1977:2021)                           
c cymax max hy for Child and Dependent Care credit Form M1CD                    
      dimension eld88(4,3),ylow(6,4),cymax(1977:2021,2),eld94(4,3),             
     &fuel(2009:2009,3), ph(2011:2021),phssb(2,2017:2021),                      
     &ssb17(2,2017:2021)                                                        
      double precision irales,keoles                                     
      data phssb/                                                               
     7      60200.d0,77000.d0,                                                  
     8      61400.d0,78530.d0,                                                  
     9      61080.d0,78180.d0,                                                  
     &      62090.d0,79480.d0,                                                  
     1      62710.d0,80270.d0/                                                  
      data ssb17/                                                               
     7      3500.d0,4500.d0,                                                    
     8      3500.d0,4500.d0,                                                    
     9      4020.d0,5150.d0,                                                    
     &      4090.d0,5240.d0,                                                    
     1      4130.d0,5950.d0/                                                    
      data aif91/1.7815d0, 1.8115d0, 1.84d0 ,  1.8485d0, 1.8635d0,              
     &           1.9050d0, 1.9465d0, 1.9785d0, 1.9985d0/                        
      data stadd/1950.0d0,2000.0d0,2050.0d0/                                    
      data ph /169550.d0,173650.d0,178150.d0,181150.d0,184000.d0,               
     &         184850.d0,186350.d0,190050.d0,194650.d0,197850.d0,               
     &         199850.d0/                                                       
      data fuel/ 22730.d0,33220.d0,27980.d0/                                    
      data perc/      .0d0,  .013d0,3* .01d0, 16* .0d0/                         
      data phase/112500.d0,150000.d0,112500.d0/                                 
c        2001  2002   2003   2004   2005   2006  2007   2008   2009             
      data excl /                                                               
     1        5*30000.0d0,   45000.0d0,    46760.0d0,  47830.0d0,               
     1          49860.0d0,   49960.0d0,    50700.0d0,  51930.0d0,               
     1          53260.0d0,   54160.0d0,    55020.0d0,  55270.0d0,               
     1          55710.0d0,   56820.0d0,    58190.0d0,  59150.0d0,               
     1          59750.0d0,                                                      
     2        5*40000.0d0,   60000.0d0,    62340.0d0,  63770.0d0,               
     2          66490.0d0,   66610.0d0,    67590.0d0,  69230.0d0,               
     2          71010.0d0,   72220.0d0,    73360.0d0,  73690.0d0,               
     2          74280.0d0,   75760.0d0,    77590.0d0,  78880.0d0,               
     2          79660.0d0,                                                      
     3        5*30000.0d0,   45000.0d0,    46760.0d0,  47830.0d0,               
     3          49960.0d0,   49960.0d0,    50700.0d0,  51930.0d0,               
     3          53260.0d0,   54160.0d0,    55020.0d0,  55270.0d0,               
     3          55710.0d0,   56820.0d0,    58190.0d0,  59150.0d0,               
     3          59750.0d0/                                                      
c year 1999     2000     2001     2002     2003     2004     2005               
      data wfc0/                                                                
     & 4540.0d0,4620.0d0,4760.0d0,4960.0d0,4960.0d0,5110.0d0,5230.0d0,          
     1 5390.0d0,5600.0d0,5730.0d0,5980.0d0,5990.0d0,6080.0d0,6220.0d0,          
     1 6380.0d0,                                                                
     & 5660.0d0,5770.0d0,5950.0d0,6150.0d0,6240.0d0,6390.0d0,6530.0d0,          
     2 6740.0d0,7000.0d0,7160.0d0,7460.0d0,7480.0d0,7590.0d0,7770.0d0,          
     2 7970.0d0/                                                                
c year 2002     2003     2004     2005     2006     2007     2008               
      data wfcj /                                                               
     & 7210.0d0,7240.0d0,7390.0d0,8530.0d0,8740.0d0,9000.0d0,10160.0d0,         
     1 10590.0d0,10610.0d0,12670.0d0,2*13310.0d0,                               
     & 17130.0d0,17320.0d0,17690.0d0,19070.0d0,19600.0d0,20290.0d0,             
     2 21710.0d0,22640.0d0,22670.0d0,24910.0d0,2*26170.0d0,                     
     & 20120.0d0,20360.0d0,20800.0d0,22250.0d0,22880.0d0,23700.0d0,             
     3 25190.0d0,26270.0d0,26310.0d0,28610.0d0,2*30060.0d0/                     
c year 1999        2000       2001       2002       2003      2004              
      data wfc1 /                                                               
     a  6790.0d0,  6920.0d0,  7140.0d0,  7370.0d0,  7490.0d0, 7660.0d0,         
     a  7830.0d0,  8080.0d0,  8390.0d0,  8580.0d0,  8950.0d0, 8970.0d0,         
     a  9100.0d0,  9320.0d0,  9560.0d0,                                         
     b 11850.0d0, 12060.0d0, 12460.0d0, 12870.0d0, 13080.0d0,13370.0d0,         
     b 13680.0d0, 14100.0d0, 14650.0d0, 14990.0d0, 15630.0d0,15650.0d0,         
     b 15890.0d0, 16270.0d0, 16690.0d0,                                         
     c 13210.0d0, 13450.0d0, 13870.0d0, 14320.0d0, 14560.0d0,14880.0d0,         
     c 15230.0d0, 15700.0d0, 16310.0d0, 16690.0d0, 17400.0d0,17430.0d0,         
     c 17690.0d0, 18120.0d0, 18580.0d0,                                         
     d 14810.0d0, 15080.0d0, 15550.0d0, 16060.0d0, 16320.0d0,16690.0d0,         
     d 17070.0d0, 17600.0d0, 18290.0d0, 18710.0d0, 19510.0d0,2*19540.0d0        
     d,20310.0d0, 20830.0d0/                                                    
      data wfc2 /                                                               
     a   9550.0d0, 9720.0d0, 10020.0d0, 10350.0d0, 10520.0d0, 10760.0d0,        
     a  11000.0d0,11350.0d0, 11790.0d0, 12060.0d0, 12570.0d0, 12600.0d0,        
     a  12780.0d0,13090.0d0, 13430.0d0,                                         
     b  14590.0d0,14860.0d0, 15320.0d0, 15830.0d0, 16100.0d0, 16440.0d0,        
     b  16820.0d0,17350.0d0, 18020.0d0, 18440.0d0, 19220.0d0, 19260.0d0,        
     b  19540.0d0,20020.0d0, 20530.0d0,                                         
     c  16500.0d0,16800.0d0, 17320.0d0, 17890.0d0, 18190.0d0, 18590.0d0,        
     c  19020.0d0,19610.0d0, 20380.0d0, 20840.0d0, 21730.0d0, 21770.0d0,        
     c  22090.0d0,22630.0d0, 23210.0d0,                                         
     d  17570.0d0,17890.0d0, 18450.0d0, 19050.0d0, 19360.0d0, 19800.0d0,        
     d  20250.0d0,20880.0d0, 21700.0d0, 22190.0d0, 23140.0d0, 23180.0d0,        
     d  23530.0d0,24100.0d0, 24720.0d0/                                         
      data rwfc0 /  .011475d0, 14*.019125d0/                                    
      data rwfc1 /  .07450d0,  14*.0850d0 ,                                     
     &              .0850d0 ,  14*.0850d0 ,                                     
     &              .05130d0,  14*.05730d0/                                     
      data rwfc2 /  .0880d0, 14*.10d0,                                          
     &                .20d0, 14*.20d0,                                          
     &             .09380d0, 14*.1030d0/                                        
      data fc0 /                                                                
     &        52.0d0,  88.0d0,  91.0d0,  94.0d0,  96.0d0,  98.0d0,              
     &       100.0d0, 103.0d0, 107.0d0, 110.0d0, 114.0d0, 115.0d0,              
     &       116.0d0, 119.0d0, 122.0d0/                                         
      data fc1 /                                                                
     &       505.0d0, 588.0d0, 607.0d0, 626.0d0, 637.0d0, 651.0d0,              
     &       665.0d0, 687.0d0, 713.0d0, 729.0d0, 761.0d0, 762.0d0,              
     &       774.0d0, 792.0d0, 820.0d0,                                         
     &       620.0d0, 706.0d0, 727.0d0, 750.0d0, 762.0d0, 779.0d0,              
     &       797.0d0, 823.0d0, 854.0d0, 874.0d0, 911.0d0, 914.0d0,              
     &       927.0d0, 949.0d0, 973.0d0/                                         
      data fc2 /                                                                
     &        840.0d0, 972.0d0,1002.0d0,1035.0d0,1052.0d0,1076.0d0,             
     &       1100.0d0,1135.0d0,1179.0d0,1206.0d0,1257.0d0,1260.0d0,             
     &       1278.0d0,1309.0d0,1343.0d0,                                        
     &       1222.0d0,1360.0d0,1402.0d0,1447.0d0,1472.0d0,1506.0d0,             
     &       1540.0d0,1587.0d0,1651.0d0,1686.0d0,1759.0d0,1762.0d0,             
     &       1788.0d0,1831.0d0,1879.0d0 /                                       
      data wf0 /  130.0d0,  132.0d0,  133.d0,  134.d0,  136.d0, 279.d0,         
     & 284.d0,286.d0/                                                           
      data w01 / 6180.0d0, 6280.0d0, 6310.d0, 6360.d0, 6480.d0,7150.d0,         
     & 7350.d0, 7340.d0 /                                                       
      data w02 / 8130.0d0, 8260.0d0, 8300.d0, 8360.d0, 8530.d0,8730.d0,         
     & 8870.d0, 8960.d0/                                                        
      data wj02/13560.0d0,13780.0d0,13840.d0,13950.d0,14230.d0,14570.d0,        
     & 14810.d0,14960.d0/                                                       
      data wf1 / 1040.0d0, 1057.0d0, 1061.d0, 1070.d0, 1091.d0,1117.d0,         
     & 1136.d0,1147.d0/                                                         
      data w11 /11120.0d0,11300.0d0,11350.d0,11440.d0,11670.d0,11950.d0,        
     & 12150.d0,12270.d0/                                                       
      data w12 /21190.0d0,21520.0d0,21620.d0,21800.d0,22230.d0,22770.d0,        
     & 23150.d0,23380.d0/                                                       
      data wj12/26620.0d0,27040.0d0,27160.d0,27390.d0,27930.d0,28610.d0,        
     & 29080.d0,29380.d0/                                                       
      data wf2 / 2006.0d0, 2038.0d0, 2047.d0, 2064.d0, 2104.d0,2156.d0,         
     & 2191.d0,2213.d0/                                                         
      data w21 /18240.0d0,18530.0d0,18610.d0,18760.d0,19130.d0,19600.d0,        
     & 19950.d0,20120.d0/                                                       
      data w22 /25130.0d0,25530.0d0,25640.d0,25850.d0,26360.d0,27000.d0,        
     & 27450.d0,27720.d0/                                                       
      data wj22/30560.0d0,31050.0d0,31180.d0,31440.d0,32060.d0,32840.d0,        
     & 33380.d0,33720.d0/                                                       
      data wf3 / 2500.0d0,2541.d0,2566.d0/                                      
      data w31 /20000.0d0, 20350.d0,20530.d0/                                   
      data w32 /27300.0d0, 27750.d0,28030.d0/                                   
      data wj32/33140.0d0, 33690.d0,34030.d0/                                   
                                                                                
      data stnd/                                                                
     1         3000.0d0,   3100.0d0, 3250.0d0,  3400.0d0,   3600.0d0,           
     1         3700.0d0,   3800.0d0, 3900.0d0,  4000.0d0,   4150.0d0,           
     1         4250.0d0,   4300.0d0, 4350.0d0,  4550.0d0,   4700.0d0,           
     1         4750.0d0,   4850.0d0, 5000.0d0,  5150.0d0,   5350.0d0,           
     1         5450.0d0, 2*5700.0d0, 5800.0d0,  5950.0d0,   6100.0d0,           
     1         6200.0d0, 2*6300.0d0, 6350.0d0,  6500.0d0,  12200.0d0,           
     1        12400.0d0,  12525.0d0,                                            
     2         5000.0d0,   5200.0d0, 5450.0d0,  5700.0d0,   6000.0d0,           
     2         6200.0d0,   6350.0d0, 6550.0d0,  6700.0d0,   6900.0d0,           
     2         7100.0d0,   7200.0d0, 7250.0d0,  7600.0d0,   7850.0d0,           
     2         9500.0d0,   9700.0d0,10000.0d0, 10300.0d0,  10700.0d0,           
     2        10900.0d0,2*11400.0d0, 9650.0d0,  9900.0d0,  10150.0d0,           
     2        12400.0d0,2*12600.0d0,12700.0d0, 13000.0d0,  24400.0d0,           
     2        24800.0d0,  25050.0d0,                                            
     3         4400.0d0,   4550.0d0, 4750.0d0,  5000.0d0,   5250.0d0,           
     3         5450.0d0,   5600.0d0, 5750.0d0,  5900.0d0,   6050.0d0,           
     3         6250.0d0,   6350.0d0, 6350.0d0,  6650.0d0,   6900.0d0,           
     3         7000.0d0,   7150.0d0, 7300.0d0,  7550.0d0,   7850.0d0,           
     3         8000.0d0,   8350.0d0, 8400.0d0,  8500.0d0,   8700.0d0,           
     3         8950.0d0,   9100.0d0, 9250.0d0,  9300.0d0,   9350.0d0,           
     3         9550.0d0,  12200.0d0,12400.0d0, 12525.0d0,                       
     4        2*750.0d0,    800.0d0,  850.0d0, 2*900.0d0,  2*950.0d0,           
     4       2*1000.0d0, 3*1050.0d0, 1100.0d0,2*1150.0d0,   1200.0d0,           
     4       2*1250.0d0,   1300.0d0, 1350.0d0,2*1400.0d0, 2*1450.0d0,           
     4         1500.0d0, 4*1550.0d0, 1600.0d0,3* 1650.0d0,                      
     5        2*600.0d0,  2*650.0d0,2* 700.0d0, 2*750.0d0,  2*800.0d0,          
     5        3*850.0d0,  2*900.0d0,2* 950.0d0,2*1000.0d0, 2*1050.0d0,          
     5       2*1100.0d0, 2*1150.0d0,2*1200.0d0,3*1250.0d0, 4*1300.0d0/          
      data ylow  /                                                              
     & 4400.d0,5200.d0,6000.d0, 6700.d0,  7300.d0, 7800.d0,                     
     & 4800.d0,5800.d0,6900.d0, 7800.d0,  8400.d0, 8900.d0,                     
     & 5500.d0,7000.d0,8000.d0, 8900.d0,  9600.d0,10000.d0,                     
     & 5800.d0,7400.d0,8800.d0,10000.d0, 10500.d0,11000.d0/                     
      data pnsion/                                                              
     & 0.d0,  7200.d0, 10000.d0, 7*11000.d0,                                    
     & 0.d0, 13000.d0, 8*17000.d0/                                              
      data eld88/35000.0d0, 32000.0d0, 28000.0d0, 17500.0d0,                    
     &           10000.0d0, 10000.0d0,  8000.0d0,  5000.0d0,                    
     &           15000.0d0, 12000.0d0, 12000.0d0,  7500.0d0/                    
      data eld94/42000.0d0, 38500.0d0, 33700.0d0, 21000.0d0,                    
     &           12000.0d0, 12000.0d0,  9600.0d0,  6000.0d0,                    
     &           18000.0d0, 14500.0d0, 14500.0d0,  9000.0d0/                    
      data seless/ 2*.75d0,   2*.76d0,   2*1.0d0,   3*.75d0,                    
     &               .60d0,  35*1.0d0/                                          
      data semax/  1.e20, 358.43d0, 445.18d0, 503.5d0, 41*1.e20/                
      data cred  /  21.0d0,  40.0d0,  55.0d0,  60.0d0,  66.0d0,                 
     & 67.0d0,  68.0d0, 2* 70.0d0,  73.0d0/                                     
      data plmax /  2*25.0d0,8*50.0d0/                                          
      data cded/                                                                
     &         4*12000.0d0, 2*15000.0d0, 14000.0d0, 5*10000.0d0,                
     &         5*13351.0d0,   15640.0d0, 16050.0d0,   16500.0d0,                
     &           16960.0d0,   17420.0d0, 17720.0d0,   18040.0d0,                
     &           18600.0d0,   19210.0d0, 19520.0d0,   19960.0d0,                
     &           20420.0d0,   21060.0d0, 21880.0d0,   22380.0d0,                
     &           23330.0d0,   23380.0d0, 23720.0d0,   24300.0d0,                
     &           24920.0d0,   25350.0d0, 25750.0d0,   25860.0d0,                
     &           50000.0d0,   50990.0d0, 52230.0d0,   53100.0d0,                
     &           53630.0d0/                                                     
      data cymax/ 4*18000.0d0, 2*23000.0d0, 6*24000.0d0,4*27000.0d0,            
     1 28830.0d0,29290.0d0,                                                     
     1  29700.0d0, 30150.0d0, 30610.0d0, 31070.0d0, 31370.0d0,                  
     1  31690.0d0, 32250.0d0, 32860.0d0,                                        
     1  33170.0d0, 33610.0d0, 34070.0d0, 34710.0d0, 35530.0d0,                  
     1  36030.0d0, 36980.0d0, 37030.0d0, 37370.0d0, 37950.0d0,                  
     1  38570.0d0, 39000.0d0, 39400.0d0, 39510.0d0, 62000.0d0,                  
     1  62990.0d0, 64230.0d0, 65100.0d0, 65630.0d0,                             
     &            4*15000.0d0, 2*31000.0d0, 6*24000.0d0,4*27000.0d0,            
     &  28830.0d0, 29290.0d0,                                                   
     &  29700.0d0, 30150.0d0, 30610.0d0, 31070.0d0, 31370.0d0,                  
     &  31690.0d0, 32250.0d0, 32860.0d0,                                        
     &  33170.0d0, 33610.0d0, 34070.0d0, 34710.0d0, 35530.0d0,                  
     &  36030.0d0, 36980.0d0, 37030.0d0, 37370.0d0, 37950.0d0,                  
     &  38570.0d0, 39000.0d0, 39400.0d0, 39510.0d0, 74000.0d0,                  
     &  74990.0d0, 76230.0d0, 77100.0d0, 77630.0d0/                             
      data cmax/ 4*150.0d0, 2*400.0d0, 480.0d0, 33* 720.0d0,5*600.d0,           
     &           4*300.0d0, 2*800.0d0, 960.0d0, 33*1440.0d0,5*1200.d0/          
      data stdaif/4*1.0d0,1.1030d0, 1.1250d0, 1.1350d0, 1.150d0,                
     & 1.20d0, 1.250d0/                                                         
      data aif01/1.0d0,1.020d0,1.040d0,1.060d0,1.090d0,1.1330d0,                
     & 1.170d0,1.21060d0/                                                       
c indexing covers brackets,standard deduction and general credit.               
      rt = 0.                                                                   
      mst = int(data(2))                                                             
      nfile = int(filing(mst,1.,2.,3.,2.))                                      
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      txp = int(data(7))                                                             
c  AGI                                                                          
      agi = comnew(2)-data(22)                                                  
c 2009 unemployment compensation is taxed in full                               
      if(law.eq.2009) agi = agi - comnew(78) + data(82)                         
c 2020 CARES act                                                                
      if(law.eq.2020) then                                                      
         agi = agi +data(82) - comnew(78)                                       
         if(comnew(26).lt.1.d0)agi = agi + min(300.d0,data(58))                 
      endif                                                                     
      if(law.le.1982)agi=agi-data(33)                                           
      if(law.le.1984)agi=agi-xjobs(data,law)                                    
c lower capital gains deduction                                                 
      if(law.ge.1979.and.law.le.1982)agi=agi + (.1*comnew(5))                   
      if(law.ge.1979.and.law.le.1986)agi=agi-comnew(78)                         
      if(law.ge.1982.and.law.le.1985)agi=agi+comnew(32)                         
c Looks like MN applies the state income tax to Social Security benefits        
c that are taxable at the federal level.                                        
c      if(law.eq.1984)agi=agi-comnew(79)                                        
c     pnsion exclusion                                                          
      if(law.le.1986) then                                                      
         taxpen=data(20)+data(72)                                               
         tlim=max(0.0d0,comnew(2)-pnsion(law,2))                                
         penexc=min(taxpen,max(0.0d0,pnsion(law,1) - tlim))                     
c     true after 1987**********************                                     
         if(law.eq.1985.or.law.eq.1986) then                                    
           if(data(9).lt.1..and.data(10).lt.1.)penexc=0.                        
         endif                                                                  
      else                                                                      
         penexc=0.                                                              
      endif                                                                     
      agi=agi-penexc                                                            
c     use old ira and keough limits for some years                              
      if(law.ge.1982.and.law.le.1984) then                                      
        agi=agi+keoles(data,comnew,1981)                                        
        agi=agi+irales(data,comnew,1981)                                        
      endif                                                                     
c federal tax deduction                                                         
      fedtax=max(0.0d0,comnew(1)-(comnew(175)*seless(law)))                     
      fedtax=max(0.0d0,fedtax-                                                  
     & max(((1.-seless(law))*comnew(175))-semax(law),0.0d0))                    
c prorated by minnesota agi / federal agi                                       
      if(comnew(2).gt.0.and.agi.ge.0) then                                      
        fedtax=fedtax*min(1.0d0,((agi+data(22))/comnew(2)))                     
      endif                                                                     
      if(law.le.1984)agi=agi-fedtax                                             
c  deduction for the elderly and disabled                                       
      eldded=0.                                                                 
      num=int(data(9)+data(10))                                                      
      if(mst.eq.2.and.num.ge.2)ndx=1                                            
      if(mst.eq.2.and.num.eq.1)ndx=2                                            
      if(mst.ne.2.and.mst.ne.3.and.mst.ne.6)ndx=3                               
      if(mst.eq.3.or.mst.eq.6)ndx=4                                             
      if((law.ge.1988..and.law.le.2016).and.num.gt.0) then                      
c income limits                                                                 
        if(law.le.1993) then                                                    
           if(comnew(2).le.eld88(ndx,1)) then                                   
             eldded=eld88(ndx,2)-(comnew(84)-comnew(79))                        
             yless=max(0.0d0,comnew(2)-eld88(ndx,3))/2.                         
             eldded=max(0.0d0,eldded-yless)                                     
           endif                                                                
        else                                                                    
           if(comnew(2).le.eld94(ndx,1)) then                                   
             eldded=eld94(ndx,2)-(comnew(84)-comnew(79))                        
             yless=max(0.0d0,comnew(2)-eld94(ndx,3))/2.                         
             eldded=max(0.0d0,eldded-yless)                                     
           endif                                                                
        endif                                                                   
      endif                                                                     
c   Since 1987 line 1 in Minnesota Form M-1 is Federal Taxable Income.          
c   Our code repeats calculations with Federal AGI in Federal Form ,and         
c   Minnesota taxinc is the same if it had been calculated from Fed. taxinc     
      exemp=0.                                                                  
      if(law.ge.1987.and.law.le.2012) exemp=comnew(83)                          
      if(law.ge.2013) then                                                      
c  exemptions before phaseout                                                   
        if(law.le.2018) exemp = comnew(68)*exem(law)                            
c 2019+ exemptions are only allowed for dependents                              
        if(law.ge.2019) exemp = exem(law)*data(8)                               
c  exemptions phaseout                                                          
        ph13 = 100000.d0*aif91(law)/sep                                         
        phded = ph13                                                            
        if(mst.eq.4.or.mst.eq.7) then                                           
             ph13 = 1.25*100000.d0*aif91(law)                                   
        else if(mst.eq.2.or.mst.eq.5.or.sep.eq.2) then                          
             ph13 = 1.5*100000.d0*aif91(law)/sep                                
        endif                                                                   
        excess = max(0.0d0,comnew(2)-ph13)                                      
        ratio = min(1.0d0,.02*excess/(2500.d0/sep))                             
        amphs =  ratio * exemp                                                  
        exemp = exemp - amphs                                                   
        if (data(105).gt.0.) exemp = 0.                                         
      endif                                                                     
c deductions                                                                    
      ag=max(0.0d0,agi)                                                         
      if(law.le.1978) then                                                      
        stded=min(1000.*stdaif(law),.1*ag)                                      
      else if(law.ge.1979.and.law.le.1984) then                                 
        stded=min(2000*stdaif(law),.1*ag)                                       
      else if(law.eq.1985.or.law.eq.1986) then                                  
        stded=min((2000*stdaif(law))/sep,.1*ag)                                 
      else if(law.ge.1987) then                                                 
        stded=comnew(3)                                                         
c MN doesn't adopt the federal increase (only for 2005)                         
c for the standard deduction for married taxpayers                              
       if(law.eq.2005.and.(mst.eq.2.or.mst.eq.3.or.mst.eq.6))                   
     &   stded = stded - 1300.d0/sep                                            
       if((law.eq.2008.or.law.eq.2009).and.data(51).gt.0) stded =               
     &  stded - min(data(51),500.d0*txp)                                        
       if(law.eq.2013.and.(mst.eq.2.or.mst.eq.3.or.mst.eq.6))                   
     &   stded = stded - 2050.d0/sep                                            
       if(law.eq.2012.and.(mst.eq.2.or.mst.eq.3.or.mst.eq.6))                   
     &   stded = stded - 2000.d0/sep                                            
       if(law.eq.2011.and.(mst.eq.2.or.mst.eq.3.or.mst.eq.6))                   
     &   stded = stded - 1950.d0/sep                                            
c 2014-2017 no difference between fed and MN State stded                        
       if(law.eq.2018) then                                                     
c 2018 stded calculation                                                        
         if(mst.eq.1.or.sep.eq.2) then                                          
           if(sep.eq.2) then                                                    
            stded = 6500.d0 + 1300.d0*(data(9)+data(10))                        
           else                                                                 
            stded = 6500.d0 + 1600.d0*(data(9)+data(10))                        
           endif                                                                
         else if(mst.eq.2.or.mst.eq.5) then                                     
            stded = 13000.d0 + 1300.d0*(data(9)+data(10))                       
         else if(mst.eq.4.or.mst.eq.7) then                                     
            stded = 9550.d0 + 1600.d0*(data(9)+data(10))                        
         endif                                                                  
         if(data(105).gt.0.d0)                                                  
     &   stded = min(stded,max(1050.d0,comnew(37) + 350.d0))                    
       endif                                                                    
       if(law.ge.2019) then                                                     
          if(nfile.eq.1) then                                                   
            stded = stnd(law,1)+ stnd(law,4)*(data(9)+data(10))                 
          else if(nfile.eq.2) then                                              
            stded = stnd(law,2)+ stnd(law,5)*(data(9)+data(10))                 
          else                                                                  
            stded = stnd(law,3)+ stnd(law,4)*(data(9)+data(10))                 
          endif                                                                 
          if(sep.eq.2) stded = stded/sep                                        
          if(data(105).gt.0.d0)                                                 
     &   stded = min(stded,max(1050.d0,comnew(37) + 350.d0))                    
       endif                                                                    
      endif                                                                     
c      write(0,*) 'stded',stded                                                 
c  Itemized Deductions                                                          
      if(law.le.1986) then                                                      
       xitded=max(0.0d0,comnew(24)-data(50))                                    
       if(law.le.1981)xitded=max(0.d0,xitded-                                   
     &     comnew(20)+data(47)+data(48)+data(49))                               
       if(law.le.1982)xitded=xitded + min(data(65),100.0d0*txp)                 
       if(law.le.1984)xitded=max(0.d0,                                          
     &  xitded-max(comnew(23)-.3*ag,0.0d0))                                     
      else if(law.ge.1987.and.law.le.2012) then                                 
       xitded=comnew(24)*comnew(26)                                             
c      write(16,*) 'c24 c26',comnew(24),comnew(26)                              
      else if(law.ge.2013.and.law.le.2017) then                                 
c       xitded = comnew(30)*comnew(26)                                          
c 2013+ differences between federal and state xitded ded phaseout               
       sttax = data(50)                                                         
       if(law.eq.2013) sttax = max(sttax,data(52))                              
       casu = max(0.0d0,data(61)-100.)                                          
       casu = max(0.0d0,casu-.1*max(0.d0,comnew(2)))                            
c       deduc1 = comnew(23)+sttax+data(51)+data(54)+data(56)+                   
       deduc1 = comnew(23)+data(51)+data(54)+data(56)+                          
     & comnew(97)+data(66)                                                      
       deduc2 = casu+comnew(20)+data(53)                                        
c       write(16,*) 'deduc1 deduc2',deduc1,deduc2                               
       dlim1 = .03*max(0.0d0,comnew(2)-ph13)                                    
       dlim2 = .8*max(0.0d0,deduc1-data(168))                                   
       dedphs = min(dlim1,dlim2)                                                
       deduc1 = deduc1 - dedphs                                                 
c      write(16,*) 'deduc1 after phaseout in stat',deduc1                       
       xitded = max(0.0d0,deduc1+deduc2)                                        
      else if(law.ge.2018.and.law.le.2019) then                                 
        salt = data(51) + data(50) + data(54)                                   
        xitded = comnew(30) - min(10000.d0/sep,salt) + salt                     
        disalt = min(max(0.d0,xitded - stded),data(50) + data(54))              
        disagi = 0.d0                                                           
        if(comnew(2).gt.phded) then                                             
          casu = max(0.0d0,data(61)-100.)                                       
          casu = max(0.0d0,casu-.1*max(0.d0,comnew(2)))                         
          dedphs = min(.8*(xitded-comnew(20)-casu),                             
     &                    .03*(comnew(2)-phded))                                
          alostd = disalt + dedphs                                              
          exces = max(0.0d0,xitded - stded)                                     
          if(alostd.le.exces) then                                              
             wxln16 = max(0.d0,xitded - dedphs)                                 
          else                                                                  
             wxln16 = xitded - max(0.d0,exces - disalt)                         
          endif                                                                 
          disagi = xitded - wxln16                                              
        endif                                                                   
        xitded = xitded - (disalt + disagi)                                     
      else if(law.ge.2020) then                                                 
        sttax = min(10000.d0/sep,data(51)+data(50)+data(54))                    
        stt = min(data(50),sttax - (data(51)+data(54)))                         
        subtr = stt                                                             
        xitded = comnew(30) - subtr                                             
c itemized deduction limitation                                                 
       if(comnew(2)-phded.gt.0.0d0) then                                        
          dedphs=min(.8*(comnew(30)-comnew(20)),.03*(comnew(2)-phded))          
          xitded = xitded - dedphs                                              
       endif                                                                    
      endif                                                                     
      deduc=max(stded,xitded)                                                   
      taxinc = agi-deduc-exemp                                                  
c      write(0,*) 'taxinc agi deduc exemp stded',int(taxinc),int(agi),          
c     & int(deduc),int(exemp),int(stded)                                        
c Form M1 -- line 2 state income tax addition for itemizers                     
      if(law.ge.1987) then                                                      
        old=data(9)+data(10)                                                    
        oldd = 0                                                                
        if(law.ge.1988) then                                                    
          oldd=stnd(law,5)*old                                                  
          if(nfile.eq.1.or.nfile.eq.3) oldd=old*stnd(law,4)                     
        endif                                                                   
      endif                                                                     
      add = 0.                                                                  
      if(comnew(26).gt.0.and.law.le.2017) then                                  
         if(law.ge.1988) then                                                   
           add=min(max(comnew(24)-stnd(law,nfile)/sep-oldd,0.0d0),              
     &      data(50))                                                           
         else if(law.lt.1988) then                                              
           add = data(50)                                                       
           if(comnew(24)-data(50).lt.comnew(3))                                 
     &       add = comnew(24) - comnew(3)                                       
         endif                                                                  
      endif                                                                     
                                                                                
c     subrac=data(22)+eldded                                                    
      subrac= eldded                                                            
c New charitable contribution subtraction for nonitemizers in MN in 1999        
c      if(law.ge.1999.and.comnew(26).lt.1.and.comnew(23).gt.0)                  
c     &      subrac = subrac + .5*max(0.0d0,comnew(23)-500.)                    
      if(law.ge.1999.and.stded.gt.xitded)                                       
     &   subrac = subrac + .5*max(0.0d0,comnew(21)+comnew(22)-500.)             
c Schedule M1M -- adiitions and subtractions to taxable income                  
      if(law.ge.2017.and.comnew(79).gt.0) then                                  
         xl13 = comnew(2) - comnew(79) + .5*data(91)                            
         if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                              
           xl14 = phssb(1,law)                                                  
           xl17 = ssb17(1,law)                                                  
         else                                                                   
           xl14 = phssb(2,law)/sep                                              
           xl17 = ssb17(2,law)/sep                                              
         endif                                                                  
         xl15 = max(0.d0,xl13 - xl14)                                           
         xl16 = .2*xl15                                                         
         xl18 = max(0.d0,xl17 -xl16)                                            
         subrac = subrac + min(comnew(79),xl18)                                 
      endif                                                                     
      taxinc = taxinc - subrac + add                                            
c      write(0,*) 'taxinc subrac add',taxinc,subrac,add                         
      if(law.ge.2011.and.law.le.2013) then                                      
c line 1 of 2011-2013 Schedule M1M                                              
c If you took standard deduction on your federal return and                     
c are filing married/sep or widow, you are required to add back                 
c $1950/sep in 2011 or $2000/sep on 2012 or $2050/sep in 2013                   
c looks like added 2000/sep and used an actual amount                           
c        if(comnew(26).eq.0.and.                                                
c     &   (mst.eq.2.or.mst.eq.3.or.mst.eq.6.or.mst.eq.5))                       
c     &   taxinc = taxinc + stadd(law)/sep                                      
c        write(0,*) 'taxinc stadd', taxinc,stadd(law)/sep                       
c line 2 of 2011-2012 Schedule M1M -- worksheet line-by-line                    
c if your AGI exceeds the applicable threshold, you are requered                
c to add back the amount that WOULD HAVE BEEN LIMITED under PRIOR               
c federal law for itemized deductions and exemptions                            
       if(comnew(26).eq.1.and.comnew(2).gt.ph(law)) then                        
        xl2 = comnew(20) + max(0.0d0,data(61) - .1*comnew(2))                   
        xl4 = .8*max(0.0d0,comnew(24) - xl2)                                    
        xl8 = .03*max(0.0d0,comnew(2) - ph(law)/sep)                            
        xl9 = min(xl4,xl8)                                                      
        xl10 = add                                                              
        xl11 = xl10 + xl9                                                       
        if(mst.eq.1) then                                                       
           stdmn = stnd(law,1)                                                  
        else if(mst.eq.4.or.mst.eq.7) then                                      
           stdmn = stnd(law,3)                                                  
        else                                                                    
           stdmn = stnd(law,2)/sep                                              
        endif                                                                   
        xl14 = max(0.0d0, comnew(24) - stdmn)                                   
        if(xl11.le.xl14) then                                                   
          xl15 = xl9                                                            
        else                                                                    
          xl15 = max(0.0d0,xl14-xl10)                                           
        endif                                                                   
        taxinc = taxinc + xl15                                                  
       endif                                                                    
c line 3 of 2011 Schedule M1M                                                   
       if(mst.eq.2.or.mst.eq.3.or.mst.eq.6) then                                
         phamex = 1.5*ph(law)/sep                                               
       else if(mst.eq.1) then                                                   
         phamex = ph(law)                                                       
       else                                                                     
         phamex = 1.25*ph(law)                                                  
       endif                                                                    
       if(comnew(2).gt.phamex) then                                             
        if(comnew(2) - phamex.le.122500.d0/sep) then                            
          xxxl7 = .02*(comnew(2) - phamex)/(2500.d0/sep)                        
          addxmp = xxxl7*comnew(83)                                             
        else                                                                    
          addxmp = comnew(83)                                                   
        endif                                                                   
        taxinc = taxinc + addxmp                                                
       endif                                                                    
      endif                                                                     
      taxinc = max(0.0d0, taxinc)                                               
                                                                                
c** the end of 2011-2012 taxinc additions *********                             
      call mnrate(mst,taxinc,fedtax,law,statax,rt,data)                         
c            write(0,*) 'taxinc taxbc ',taxinc,statax                           
                                                                                
                                                                                
c MARK                                                                          
      polcr=0.                                                                  
      if(law.le.1986) then                                                      
c       IGNORE this section if you are trying to get a simple idea of the       
c         minn tax system                                                       
c       calculate credit value of political contributions deduction; can        
c       take either deduction or credit                                         
        xitded=xitded+min(data(65),100.0d0*txp)                                 
        deduc=max(stded,xitded)                                                 
        taxinc=max(0.0d0,agi-deduc-exemp)                                       
c       calculate tax with political deduction                                  
        call mnrate(mst,taxinc,fedtax,law,poltax,prt,data)                      
c       credit value is difference between tax w/ & w/out the deduction         
        polcr1=max(0.0d0,statax-poltax)                                         
c       credit value can not be greater than statax                             
        polcr2=min(.5*data(65),plmax(law)*txp,statax)                           
c                                                                               
        if(polcr1.gt.polcr2) then                                               
          statax=poltax                                                         
        else if(polcr2.ge.polcr1) then                                          
          xitded=max(0.d0,xitded-min(data(65),100.0d0*txp))                     
          deduc=max(stded,xitded)                                               
          taxinc=max(0.0d0,agi-deduc-exemp)                                     
          call mnrate(mst,taxinc,fedtax,law,statax,rt,data)                     
          polcr=min(.5*data(65),plmax(law)*txp)                                 
        endif                                                                   
      endif                                                                     
c Since 2001, Alternative Minimum Tax (Schedule M1MT)                           
      almtax = 0.                                                               
      if(law.ge.2001) then                                                      
        char  = max(0.0d0,comnew(23) - perc(law)*(max(0.0d0,comnew(2))))        
        alminy = comnew(2) + min(.025*max(0.0d0,comnew(2)),comnew(20)) -        
     &  comnew(20) - data(53) - char -  data(61) - data(22)                     
        alminc = max(0.0d0,alminy - max(0.0d0,excl(law,nfile)/sep -             
     &   .25*max(alminy - phase(nfile)/sep,0.0d0)))                             
c        write(0,*) '1 alminc',alminc                                           
        xln21 = excl(law,nfile)/sep                                             
        xln22 = phase(nfile)/sep                                                
        xln23 = alminy - xln22                                                  
        xln24 = .25*xln23                                                       
        xln25 = xln21 - xln24                                                   
c       alminc = alminy - xln25                                                 
c       write(0,*) 'xln21,xln22,xln23,xln24,xln25',                             
c     & xln21,xln22,xln23,xln24,xln25                                           
c        write(0,*) 'alminy alminc',alminy,alminc                               
        if(law.le.2012) then                                                    
          almtax = max(0.0d0,.064*alminc - statax)                              
        else                                                                    
          almtax = max(0.0d0,.0675*alminc - statax)                             
        endif                                                                   
      endif                                                                     
      statax = statax + almtax                                                  
c      write(0,*) 'statax almtax',statax,almtax                                 
c Non-Refundable Credits                                                        
      if(law.eq.1977) then                                                      
        gcred=(data(7)+data(8)+data(9))*cred(law)                               
        gcred=gcred + (data(10)*25.)                                            
      else if(law.eq.1978) then                                                 
c taxpayer exemption is r40; additional taxpayer exemptions for                 
c age and blindness are r20 for the first exemption for each                    
c taxpayer, and r30 for the next exemption for each taxpayer.                   
c Dependent exemptions are r40 each.                                            
        gcred=(40.*data(7))+(20.*data(9))+(20*data(10))                         
        gcred=gcred+(10.*max(0.0d0,data(10)+data(9)-data(7)))                   
        gcred=gcred+(40.*data(8))                                               
      else if(law.ge.1979.and.law.le.1986) then                                 
        gcred=comnew(68)*cred(law)                                              
      else if(law.ge.1987) then                                                 
        gcred=0.                                                                
      endif                                                                     
c homemaker credit                                                              
c credit for homemakers with at least one dependent                             
      hcred=0.                                                                  
      if(law.ge.1978.and.law.le.1984) then                                      
        hcred=50.                                                               
        if(txp.eq.1) then                                                       
          if(data(11).gt.50.or.data(17).gt.0)hcred=0.                           
        endif                                                                   
        if(data(85).gt.50.or.data(86).gt.50)hcred=0.                            
        if(mst.eq.3.or.mst.eq.6)hcred=0.                                        
        if(data(8).lt.1)hcred=0.                                                
        if(comnew(2).gt.(25000.d0/sep))hcred=0.                                 
        if(data(105).lt.1.d0) hcred = 0.d0                                      
      endif                                                                     
c residential energy credit                                                     
      encred=0.                                                                 
      if(law.ge.1979.and.law.le.1984)encred=.7*data(38)                         
c credit for elderly and disabled                                               
      eldcr=0.                                                                  
      if(law.eq.1987)eldcr=comnew(54)*.4                                        
      credit=gcred+polcr+hcred+encred+eldcr                                     
c low income credit                                                             
      crlow=0.                                                                  
      if(law.le.1984.and.comnew(2).le.20000.and.data(105).lt.1) then            
        npop=int(min(data(7)+data(8),6.0d0))                                         
c        ndx=nint(min(law-1976.,4.0d0))                                         
        ndx=min(law-1976,4)                                                     
        ytest=max(0.0d0,.15*(data(159)-ylow(npop,ndx)))                         
        crlow=max(0.0d0,statax-credit-ytest)                                    
      endif                                                                     
      credit=credit+crlow                                                       
c 1999+ marriage credit                                                         
c crmarr1 smoothes the result , stat16c.for contains tables                     
      call crmarr1(data,comnew,taxinc,fedtax,statax,crmar,law)                  
      credit = credit + crmar                                                   
c 1991 credit for working family - refundable                                   
      earncr = 0.                                                               
      work = 0.                                                                 
      if(law.ge.1991.and.law.le.1992) then                                      
        work = .1 * comnew(59)                                                  
      else if(law.ge.1993.and.law.le.1997.and.comnew(59).gt.0) then             
        work = .15 * comnew(59)                                                 
c      else if(law.ge.1998.and.comnew(59).ge.5) then                            
      else if(((law.ge.1998.and.law.le.2018).and.comnew(59).ge.5).              
     & or.law.ge.2019) then                                                     
c Eligibility for the federal EIC causes the eligibility for                    
c the Minnesota Working Family Credit                                           
c 2019+ WFC does not depend of EIC eligiblity                                   
        base(1) = comnew(37)                                                    
        base(2) = comnew(2)                                                     
c 2020 Cares                                                                    
        if(law.eq.2020) base(2) = base(2) +data(82) - comnew(78)                
c       write(0,*) 'c2 c37',comnew(2),comnew(37)                                
        if(law.eq.1998) then                                                    
         if(data(8).lt.1) then                                                  
          do 95 i = 1,2                                                         
             workcr(i) = 0.                                                     
             if (base(i).le.4400.) workcr(i) = 0.012*base(i)                    
             if(base(i).le.5600.)  workcr(i) = 51.                              
             if(base(i).lt.10000.)                                              
     &            workcr(i) = max(0.0d0,51. - .012* (base(i)-5600.))            
95        continue                                                              
          if(comnew(2).le.5570.) then                                           
             work = workcr(1)                                                   
          else                                                                  
             work = min(workcr(1),workcr(2))                                    
          endif                                                                 
         endif                                                                  
         if(data(8).gt.0.and.data(8).lt.2) then                                 
          do 96 i = 1,2                                                         
             workcr(i) = 0.                                                     
             if (base(i).lt.6700.) workcr(i) = 0.068*base(i)                    
             if(base(i).lt.11700.and.base(i).ge.6700) workcr(i) = 454.          
             if(base(i).lt.13000.and.base(i).ge.11700)                          
     &           workcr(i) =.086* (base(i)-11700.) + 454.                       
             if(base(i).lt.14600.and.base(i).ge.13000.) workcr(i) = 568.        
             if(base(i).lt.26500.and.base(i).ge.14600.)                         
     &           workcr(i) = 568. - .048*(base(i)-14600.)                       
96        continue                                                              
          if(comnew(2).le.14560.) then                                          
             work = workcr(1)                                                   
          else                                                                  
             work = min(workcr(1),workcr(2))                                    
          endif                                                                 
         endif                                                                  
         if(data(8).gt.1) then                                                  
          do 97 i = 1,2                                                         
             workcr(i) = 0.                                                     
             if (base(i).lt.9400.) workcr(i) = 0.08*base(i)                     
             if(base(i).lt.14400.and.base(i).ge.9400) workcr(i) = 751.          
             if(base(i).lt.16200.and.base(i).ge.14400)                          
     &           workcr(i) =.2* (base(i)-14400.) + 751.                         
             if(base(i).lt.17300.and.base(i).ge.16200) workcr(i) =1127.         
             if(base(i).lt.30100.and.base(i).ge.17300)                          
     &            workcr(i) = 1127. - .088*(base(i)-17300.)                     
97        continue                                                              
          if(comnew(2).le.17280) then                                           
             work = workcr(1)                                                   
          else                                                                  
             work = min(workcr(1),workcr(2))                                    
          endif                                                                 
         endif                                                                  
        else if(law.ge.2019) then                                               
c 2019+                                                                         
          wmax = max(base(1),base(2))                                           
c         write(0,*) 'wmax',wmax                                                
          if(data(8).lt.1) then                                                 
            work = wf0(law)                                                     
            if(base(1).le.w01(law)) work = .039*base(1)                         
            if(mst.eq.2) wbase = wj02(law)                                      
            if(mst.ne.2) wbase = w02(law)                                       
            work = max(0.0d0,work - .02*max(0.0d0,wmax-wbase))                  
          else if(data(8).eq.1) then                                            
            work = wf1(law)                                                     
c            write(0,*) '1 work',work                                           
            if(base(1).le.w11(law)) work = .0935*base(1)                        
c           write(0,*) '2 work',work                                            
            if(mst.eq.2) wbase = wj12(law)                                      
            if(mst.ne.2) wbase = w12(law)                                       
c           write(0,*) 'wbase',wbase                                            
            work = max(0.0d0,work - .06*max(0.0d0,wmax-wbase))                  
c           write(0,*) '3 work',work                                            
                                                                                
          else if(data(8).eq.2) then                                            
            work = wf2(law)                                                     
            if(base(1).le.w21(law)) work = .11*base(1)                          
            if(mst.eq.2) wbase = wj22(law)                                      
            if(mst.ne.2) wbase = w12(law)                                       
            work = max(0.0d0,work - .105*max(0.0d0,wmax-wbase))                 
          else if(data(8).gt.2) then                                            
            work = wf3(law)                                                     
            if(base(1).le.w31(law)) work = .125*base(1)                         
            if(mst.eq.2) wbase = wj22(law)                                      
            if(mst.ne.2) wbase = w12(law)                                       
            work = max(0.0d0,work - .105*max(0.0d0,wmax-wbase))                 
          endif                                                                 
        else if(law.ge.2014.and.law.le.2018) then                               
c 2014-2018 The Minnesota Working Family Credit calculation was simplified      
          wmax = max(base(1),base(2))                                           
          if(data(8).lt.1) then                                                 
            work = wf0(law)                                                     
            if(base(1).le.w01(law)) work = .021*base(1)                         
            if(mst.eq.2) wbase = wj02(law)                                      
            if(mst.ne.2) wbase = w02(law)                                       
            work = max(0.0d0,work - .0201*max(0.0d0,wmax-wbase))                
          else if(data(8).eq.1) then                                            
            work = wf1(law)                                                     
            if(base(1).le.w11(law)) work = .0935*base(1)                        
            if(mst.eq.2) wbase = wj12(law)                                      
            if(mst.ne.2) wbase = w12(law)                                       
            work = max(0.0d0,work - .0602*max(0.0d0,wmax-wbase))                
          else if(data(8).gt.1) then                                            
            work = wf2(law)                                                     
            if(base(1).le.w21(law)) work = .11*base(1)                          
            if(mst.eq.2) wbase = wj22(law)                                      
            if(mst.ne.2) wbase = w12(law)                                       
            work = max(0.0d0,work - .1082*max(0.0d0,wmax-wbase))                
          endif                                                                 
        else if(law.ge.1999.and.law.le.2013) then                               
c Taxpayer with no children                                                     
         if(data(8).lt.1) then                                                  
          wfc00=wfc0(law,2)                                                     
          if(mst.eq.2) then                                                     
           if((law.ge.2002.and.law.le.2011).or.law.eq.2013)                     
     &     wfc00 = wfcj(law,0)                                                  
          endif                                                                 
          do 98 i = 1,2                                                         
             workcr(i) = 0.                                                     
             if (base(i).le.wfc0(law,1)) then                                   
               workcr(i) = rwfc0(law)*base(i)                                   
             else if(base(i).le.wfc00) then                                     
                 workcr(i) = min(wfc00,fc0(law))                                
             else                                                               
                 workcr(i) = max(0.0d0,fc0(law) - rwfc0(law)                    
     &            * (base(i)-wfc00))                                            
             endif                                                              
98        continue                                                              
          if(comnew(2).le.wfc00) then                                           
             work = workcr(1)                                                   
          else                                                                  
             work = min(workcr(1),workcr(2))                                    
          endif                                                                 
         endif                                                                  
c Taxpayer with one child                                                       
         if(data(8).gt.0.and.data(8).lt.2) then                                 
          wfc11 = wfc1(law,4)                                                   
          if(mst.eq.2) then                                                     
           if((law.ge.2002.and.law.le.2011).or.law.eq.2013)                     
     &     wfc11 = wfcj(law,1)                                                  
          endif                                                                 
          do 99 i = 1,2                                                         
             workcr(i) = 0.                                                     
             if (base(i).lt.wfc1(law,1)) workcr(i)=rwfc1(law,1)*base(i)         
             if(base(i).lt.wfc1(law,2).and.base(i).ge.wfc1(law,1))              
     &   workcr(i) = min(wfc11,fc1(law,1))                                      
             if(base(i).lt.wfc1(law,3).and.base(i).ge.wfc1(law,2))              
     &   workcr(i) =rwfc1(law,2)* (base(i)-wfc1(law,2))+ fc1(law,1)             
             if(base(i).lt.wfc11.and.base(i).ge.wfc1(law,3))                    
     &   workcr(i) = fc1(law,2)                                                 
             if(base(i).ge.wfc11)                                               
     &   workcr(i) = max(0.0d0,fc1(law,2) - rwfc1(law,3)                        
     &            * (base(i)-wfc11))                                            
99        continue                                                              
          if(comnew(2).le.wfc11) then                                           
             work = workcr(1)                                                   
          else                                                                  
             work = min(workcr(1),workcr(2))                                    
          endif                                                                 
         endif                                                                  
c Taxpayer with two or more children                                            
         if(data(8).gt.1) then                                                  
          wfc22 = wfc2(law,4)                                                   
          if(mst.eq.2) then                                                     
           if((law.ge.2002.and.law.le.2011).or.law.eq.2013)                     
     &     wfc22 = wfcj(law,2)                                                  
          endif                                                                 
          do 100 i = 1,2                                                        
             workcr(i) = 0.                                                     
             if (base(i).lt.wfc2(law,1))                                        
     &   workcr(i)=rwfc2(law,1)*base(i)                                         
             if(base(i).lt.wfc2(law,2).and.base(i).ge.wfc2(law,1))              
     &   workcr(i) = min(wfc22,fc2(law,1))                                      
             if(base(i).lt.wfc2(law,3).and.base(i).ge.wfc2(law,2))              
     &   workcr(i) =rwfc2(law,2)*                                               
     &         (base(i)-wfc2(law,2))+fc2(law,1)                                 
             if(base(i).lt.wfc22.and.base(i).ge.wfc2(law,3))                    
     &   workcr(i) =fc2(law,2)                                                  
             if(base(i).ge.wfc22)                                               
     &   workcr(i) = max(0.0d0,fc2(law,2) - rwfc2(law,3)                        
     &                      *(base(i)-wfc22))                                   
100       continue                                                              
          if(comnew(2).le.wfc22)then                                            
             work = workcr(1)                                                   
          else                                                                  
             work = min(workcr(1),workcr(2))                                    
          endif                                                                 
         endif                                                                  
        endif                                                                   
      endif                                                                     
      if(data(105).gt.0.d0) work = 0.d0                                         
c      write(0,*) 'work ',int(work)                                             
      earncr = work                                                             
c child care credit: refundable                                                 
      chcr=0.                                                                   
      deps=int(min(data(8),2.0d0))                                                   
      if(deps.gt.0.0d0) then                                                    
       if((hy.le.cymax(law,deps).and.law.le.2016).or.                           
     &    (comnew(2).le.cymax(law,deps).and.law.ge.2017)) then                  
         cost=0.                                                                
        if(law.le.1980) then                                                    
          cost=comnew(53)/2.                                                    
        else if(law.eq.1981) then                                               
          cost=comnew(53)                                                       
        else if(law.eq.1982.or.law.eq.1983) then                                
          cost=.2*comnew(53)                                                    
        else if((law.ge.1984.and.law.le.2012).or.law.ge.2014)   then            
          cost=comnew(53)                                                       
        else if(law.eq.2013) then                                               
c Schedule M1CD 2013                                                            
c Federally, expenses $3,000 for 1 and $6,000 for 2+. The maximum percentage of 
c For Minnesota,  $2,400 for 1 and $4,800 for 2+. The credit is not more than 30
          ncccr = 0                                                             
          if(data(207).gt.0) then                                               
             ncccr = int(min(data(207),2.0d0))                                       
          else                                                                  
            ncccr = int(min(data(8),2.0d0))                                          
          endif                                                                 
          child = min(data(64),2400.0d0*ncccr)                                  
          if(mst.eq.2)                                                          
     &    child = max(0.0d0,min(child,data(85),data(86)))                       
          chr = .01*max(20.0d0,30.-max((agi-10000.)/2000.,0.0d0))               
          cost = chr*child                                                      
        endif                                                                   
        if(law.ge.2017) then                                                    
           over = max(0.d0,comnew(2) - cded(law))                               
        else                                                                    
           over=max(0.0d0,hy-cded(law))                                         
           cost=min(cost,cmax(law,deps))                                        
        endif                                                                   
        if(law.le.1982.or.law.ge.2017) then                                     
          chcr=max(0.0d0,cost-(.05*over))                                       
        else if(law.ge.1983.and.law.le.2016) then                               
          chcr=max(0.0d0,cost-(.052*deps*over))                                 
        else if(law.ge.2017) then                                               
          if(over.le.50000.d0) then                                             
            chcr = cost                                                         
          else                                                                  
            chcr = min(cost,max(0.d0,cmax(law,deps)-(.05*over)))                
          endif                                                                 
        endif                                                                   
       endif                                                                    
      endif                                                                     
c pcred calculation                                                             
      call mncred(data,comnew,law)                                       
                                                                                
c MN has a new refundable credit - an Education credit since 1999.              
      edcred = 0.                                                               
      tuition = data(143) + data(144)                                           
      if(law.ge.2002) tuition = .75*(data(143) + data(144))                     
      if(law.ge.1999.and.law.le.2004) then                                      
        tuit = data(208)*min(1000.0d0,.25*max(0.0d0,37500. - hy))               
        edcred = min(2000.0d0,min(tuition,tuit))                                
      else if(law.ge.2005) then                                                 
        if(data(208).le.1.) prc = .25                                           
        if(data(208).ge.2.) prc = .5                                            
        edcred = min(tuition,                                                   
     &   max(0.0d0,1000.*data(208) - prc*max(0.0d0,hy - 33500.)))               
      endif                                                                     
c 2009 only lower income motor fuels tax credit(refundable)                     
      crfuel = 0.                                                               
      if(law.eq.2009) then                                                      
        if(mst.eq.1) then                                                       
           nfuel = 1                                                            
        else if (mst.eq.4.or.mst.eq.7) then                                     
           nfuel = 3                                                            
        else                                                                    
           nfuel = 2                                                            
        endif                                                                   
        if(taxinc.le.fuel(law,nfuel)/sep) crfuel = 25.d0/sep                    
      endif                                                                     
                                                                                
      statax = max(0.0d0,statax-credit)                                         
                                                                                
      statax = statax - chcr - work - pcred - edcred - crfuel                   
c      write(0,*) '5 statax pcred work',statax,pcred,work                       
                                                                                
      credit = credit + chcr + work + pcred + edcred + crfuel                   
      return                                                                    
      end                                                                       
      subroutine mncred(data,comnew,law)                                 
      implicit double precision (A-H,O-Z)                                       
      common /fed/ zbrack(3,1987:2022),exem(1987:2022)                          
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
c Property Tax Refund -- dependent Subtraction                                  
      dimension dep(0:5,1994:2021),oldep(0:5)                                   
     &,aif2(1989:2021),aifr(1989:2021)                                          
      dimension owner(1989:2021),rrrent(1989:2021)                              
     &,p101(2,17),p201(2,23),p216(2,14),p210(2,22)                              
     &,p2o(2,8),p1o(2,20),p16o(2,8),p10o(2,8)                                   
     &,p1(2,16),p2(2,31),p2eld(2,19),                                           
     &p112r(2,8),p212r(2,23),p116r(2,14),p216r(2,11),p16r(2,10)                 
      dimension p85x(2,11),p85y(2,31),p83(2,34)                                 
     &,p82(2,27),p821(2,21),p822(2,21),p771(2,21),p772(2,21)                    
      dimension p87x1(2,17),p87x2(2,17),p87y(2,26)                              
      dimension p88x(2,33),p88y(2,26)                                           
      dimension p3(2,5)                                                         
      dimension p116(2,10),p110(2,16),p107(2,17)
      double precision maxcrd                                
      data p3/                                                                  
     & 21000.d0,380.d0,22000.d0,364.d0,23000.d0,348.d0,                         
     & 24000.d0,286.d0,25000.d0,268.d0/                                         
      data p110/                                                                
     &  2000.d0, 1560.d0,  4000.d0, 1514.d0,  7000.d0, 1455.d0,                 
     &  9000.d0, 1400.d0, 11000.d0, 1356.d0, 16000.d0, 1245.d0,                 
     & 21000.d0, 1200.d0, 30000.d0, 1145.d0, 40000.d0, 1040.d0,                 
     & 45000.d0,  935.d0, 50000.d0,  835.d0, 55000.d0,  730.d0,                 
     & 58000.d0,  625.d0, 60000.d0,  515.d0, 62000.d0,  420.d0,                 
     & 65000.d0,  300.d0/                                                       
c 2004-2007 homeowners pcred                                                    
      data p107/                                                                
     &  2000.d0, 1225.d0,  4000.d0, 1190.d0,  7000.d0, 1150.d0,                 
     &  9000.d0, 1105.d0, 11000.d0, 1065.d0, 14000.d0, 1022.d0,                 
     & 17000.d0,  980.d0, 21000.d0,  938.d0, 30000.d0,  900.d0,                 
     & 40000.d0,  820.d0, 45000.d0,  735.d0, 50000.d0,  655.d0,                 
     & 55000.d0,  575.d0, 58000.d0,  490.d0, 60000.d0,  405.d0,                 
     & 62000.d0,  330.d0, 65000.d0,  245.d0/                                    
      data p82/                                                                 
     & 3000.d0,.05d0, 3500.d0,.06d0, 4000.d0,.07d0, 4500.d0,.08d0,              
     & 5000.d0,.09d0, 6000.d0,.10d0, 7000.d0,.11d0, 8000.d0,.12d0,              
     & 9000.d0,.13d0,10000.d0,.14d0,11000.d0,.15d0,12000.d0,.16d0,              
     &13000.d0,.17d0,14000.d0,.18d0,15000.d0,.19d0,16000.d0,.20d0,              
     &17000.d0,.21d0,18000.d0,.22d0,19000.d0,.24d0,20000.d0,.26d0,              
     &21000.d0,.28d0,22000.d0,.30d0,23000.d0,.32d0,24000.d0,.34d0,              
     &25000.d0,.36d0,26000.d0,.38d0,  1.e20 ,.40d0/                             
      data p771/                                                                
     & 3000.d0, 10.d0, 3500.d0, 20.d0, 4000.d0, 30.d0, 4500.d0, 40.d0,          
     & 5000.d0, 50.d0, 6000.d0, 70.d0, 7000.d0, 90.d0, 8000.d0,110.d0,          
     & 9000.d0,130.d0,10000.d0,150.d0,11000.d0,170.d0,12000.d0,190.d0,          
     &13000.d0,210.d0,14000.d0,250.d0,15000.d0,300.d0,16000.d0,350.d0,          
     &17000.d0,375.d0,18000.d0,400.d0,19000.d0,425.d0,20000.d0,450.d0,          
     &21000.d0,475.d0/                                                          
      data p772/                                                                
     & 3000.d0, 13.d0, 3500.d0, 25.d0, 4000.d0, 50.d0, 4500.d0, 70.d0,          
     & 5000.d0, 90.d0, 6000.d0,110.d0, 7000.d0,130.d0, 8000.d0,160.d0,          
     & 9000.d0,200.d0,10000.d0,240.d0,11000.d0,280.d0,12000.d0,320.d0,          
     &13000.d0,360.d0,14000.d0,400.d0,15000.d0,440.d0,16000.d0,480.d0,          
     &17000.d0,520.d0,18000.d0,560.d0,19000.d0,600.d0,20000.d0,640.d0,          
     &21000.d0,675.d0/                                                          
      data p83/                                                                 
     & 3000.d0, 13.d0,  3500.d0, 15.d0, 4000.d0, 18.d0, 4500.d0, 20.d0,         
     & 5000.d0, 23.d0,  6000.d0, 40.d0, 7000.d0, 54.d0, 8000.d0, 70.d0,         
     & 9000.d0, 88.d0, 10000.d0,108.d0,11000.d0,130.d0,12000.d0,154.d0,         
     &13000.d0,180.d0, 14000.d0,195.d0,15000.d0,210.d0,16000.d0,225.d0,         
     &17000.d0,240.d0, 18000.d0,255.d0,19000.d0,270.d0,20000.d0,285.d0,         
     &21000.d0,320.d0, 22000.d0,336.d0,23000.d0,352.d0,24000.d0,414.d0,         
     &25000.d0,432.d0, 26000.d0,450.d0,27000.d0,520.d0,28000.d0,540.d0,         
     &29000.d0,560.d0, 30000.d0,580.d0,31000.d0,600.d0,32000.d0,620.d0,         
     &33000.d0,640.d0, 34000.d0,700.d0/                                         
      data p821/                                                                
     & 3000.d0, 10.d0, 3500.d0, 20.d0, 4000.d0, 30.d0, 4500.d0, 40.d0,          
     & 5000.d0, 50.d0, 6000.d0, 70.d0, 7000.d0,100.d0, 8000.d0,130.d0,          
     & 9000.d0,150.d0,10000.d0,180.d0,11000.d0,200.d0,12000.d0,220.d0,          
     &13000.d0,250.d0,14000.d0,300.d0,15000.d0,350.d0,16000.d0,400.d0,          
     &17000.d0,450.d0,18000.d0,500.d0,19000.d0,550.d0,20000.d0,600.d0,          
     &21000.d0,650.d0/                                                          
      data p822/                                                                
     & 3000.d0, 13.d0, 3500.d0, 25.d0, 4000.d0, 50.d0, 4500.d0, 70.d0,          
     & 5000.d0,100.d0, 6000.d0,130.d0, 7000.d0,150.d0, 8000.d0,200.d0,          
     & 9000.d0,250.d0,10000.d0,300.d0,11000.d0,350.d0,12000.d0,400.d0,          
     &13000.d0,450.d0,14000.d0,500.d0,15000.d0,550.d0,16000.d0,600.d0,          
     &17000.d0,650.d0,18000.d0,700.d0,19000.d0,750.d0,20000.d0,800.d0,          
     &21000.d0,850.d0/                                                          
      data p88x/                                                                
     & 3000.d0,.01d0 , 4000.d0,.011d0, 5000.d0,.012d0, 6000.d0,.013d0,          
     & 7000.d0,.014d0, 8000.d0,.015d0, 9000.d0,.016d0,10000.d0,.017d0,          
     &11000.d0,.018d0,12000.d0,.019d0,13000.d0,.020d0,14000.d0,.021d0,          
     &15000.d0,.022d0,16000.d0,.023d0,17000.d0,.024d0,18000.d0,.025d0,          
     &19000.d0,.026d0,20000.d0,.027d0,21000.d0,.028d0,22000.d0,.027d0,          
     &23000.d0,.028d0,24000.d0,.029d0,25000.d0,.030d0,26000.d0,.031d0,          
     &27000.d0,.032d0,28000.d0,.033d0,29000.d0,.034d0,30000.d0,.035d0,          
     &31000.d0,.036d0,32000.d0,.037d0,33000.d0,.038d0,34000.d0,.039d0,          
     &    1e20,.040d0/                                                          
      data p85y/                                                                
     &  3000.d0,.05d0, 3500.d0,.06d0, 4000.d0,.07d0, 4500.d0,.08d0,             
     &  5000.d0,.09d0, 6000.d0,.10d0, 7000.d0,.11d0, 8000.d0,.12d0,             
     &  9000.d0,.13d0,10000.d0,.14d0,11000.d0,.15d0,12000.d0,.16d0,             
     & 13000.d0,.17d0,14000.d0,.18d0,15000.d0,.19d0,16000.d0,.20d0,             
     & 17000.d0,.21d0,18000.d0,.22d0,19000.d0,.23d0,20000.d0,.24d0,             
     & 21000.d0,.25d0,22000.d0,.27d0,23000.d0,.29d0,24000.d0,.31d0,             
     & 25000.d0,.33d0,26000.d0,.35d0,27000.d0,.38d0,28000.d0,.41d0,             
     & 29000.d0,.44d0,30000.d0,.47d0,   1.e20,.50d0  /                          
      data p85x/                                                                
     & 8000.d0,.01d0 , 9000.d0,.011d0,10000.d0,.012d0,11000.d0,.013d0,          
     &12000.d0,.014d0,20000.d0,.015d0,23000.d0,.016d0,26000.d0,.018d0,          
     &31000.d0,.020d0,36000.d0,.022d0,   1.e20,.024d0/                          
      data p87x1/                                                               
     & 8000.d0,.010d0, 9000.d0,.011d0,10000.d0,.0120d0,11000.d0,.013d0,         
     &12000.d0,.014d0,13000.d0,.015d0,14000.d0,.0160d0,15000.d0,.017d0,         
     &16000.d0,.018d0,17000.d0,.019d0,18000.d0,.0195d0,20000.d0,.020d0,         
     &21000.d0,.021d0,24000.d0,.022d0,27000.d0,.0230d0,31000.d0,.024d0,         
     &   1.e20,.025d0/                                                          
      data p87x2/                                                               
     & 8000.d0,.025d0, 9000.d0,.026d0,10000.d0,.027d0 ,11000.d0,.028d0,         
     &12000.d0,.029d0,13000.d0,.030d0,14000.d0,.031d0 ,15000.d0,.032d0,         
     &16000.d0,.033d0,17000.d0,.034d0,18000.d0,.0345d0,20000.d0,.035d0,         
     &21000.d0,.036d0,24000.d0,.037d0,27000.d0,.038d0 ,31000.d0,.039d0,         
     &   1.e20,.040d0/                                                          
      data p87y/                                                                
     & 9000.d0,.10d0,10000.d0,.11d0,11000.d0,.12d0,12000.d0,.13d0,              
     &13000.d0,.14d0,14000.d0,.15d0,15000.d0,.16d0,16000.d0,.17d0,              
     &17000.d0,.18d0,18000.d0,.19d0,19000.d0,.20d0,20000.d0,.22d0,              
     &21000.d0,.24d0,22000.d0,.26d0,23000.d0,.28d0,24000.d0,.30d0,              
     &25000.d0,.32d0,26000.d0,.34d0,27000.d0,.36d0,28000.d0,.38d0,              
     &29000.d0,.40d0,30000.d0,.42d0,31000.d0,.44d0,32000.d0,.46d0,              
     &33000.d0,.48d0,   1.e20,.50d0/                                            
      data p88y/                                                                
     & 9000.d0,.10d0,10000.d0,.12d0,11000.d0,.14d0,12000.d0,.16d0,              
     &13000.d0,.18d0,14000.d0,.20d0,15000.d0,.22d0,16000.d0,.24d0,              
     &17000.d0,.26d0,18000.d0,.28d0,19000.d0,.30d0,20000.d0,.32d0,              
     &21000.d0,.34d0,22000.d0,.36d0,23000.d0,.38d0,24000.d0,.40d0,              
     &25000.d0,.42d0,26000.d0,.44d0,27000.d0,.46d0,28000.d0,.48d0,              
     &29000.d0,.50d0,30000.d0,.52d0,31000.d0,.54d0,32000.d0,.56d0,              
     &33000.d0,.58d0,   1.e20,.60d0/                                            
      data p2eld/                                                               
     & 10000.d0, .05d0, 11000.d0, .06d0, 12000.d0, .07d0,                       
     & 13000.d0, .08d0, 14000.d0, .09d0, 16000.d0, .10d0,                       
     & 18000.d0, .11d0, 20000.d0, .12d0, 21000.d0, .13d0,                       
     & 22000.d0, .15d0, 23000.d0, .18d0, 24000.d0, .21d0,                       
     & 25000.d0, .24d0, 26000.d0, .27d0, 27000.d0, .30d0,                       
     & 28000.d0, .35d0, 29000.d0, .40d0, 30000.d0, .45d0,                       
     &    1.e20, .50d0/                                                         
      data p1/                                                                  
     &  3000.d0,  .005d0,  4000.d0,  .006d0,  5000.d0, .007d0,                  
     &  6000.d0,  .008d0,  7000.d0,  .009d0,  8000.d0, .010d0,                  
     &  9000.d0,  .011d0, 10000.d0,  .012d0, 11000.d0, .013d0,                  
     & 12000.d0,  .014d0, 20000.d0,  .015d0, 23000.d0, .016d0,                  
     & 26000.d0,  .018d0, 31000.d0,  .020d0, 36000.d0, .022d0,                  
     &    1.e20,  .024d0/                                                       
      data p2/                                                                  
     & 3000.d0, .05d0, 3500.d0, .06d0, 4000.d0, .07d0, 4500.d0,.08d0,           
     & 5000.d0, .09d0, 6000.d0, .10d0, 7000.d0, .11d0, 8000.d0,.12d0,           
     & 9000.d0, .13d0,10000.d0, .14d0,11000.d0, .15d0,12000.d0,.16d0,           
     &13000.d0, .17d0,14000.d0, .18d0,15000.d0, .19d0,16000.d0,.20d0,           
     &17000.d0, .21d0,18000.d0, .22d0,19000.d0, .23d0,20000.d0,.24d0,           
     &21000.d0, .25d0,22000.d0, .27d0,23000.d0, .29d0,24000.d0,.31d0,           
     &25000.d0, .33d0,26000.d0, .35d0,27000.d0, .38d0,28000.d0,.41d0,           
     &29000.d0, .44d0,30000.d0, .47d0,   1.e20, .50d0/                          
c 2011-2018 homeowners pcred                                                    
       data p216/                                                               
     & 1000.d0, 1.d0 , 2000.d0, 1.1d0, 3000.d0, 1.2d0, 4000.d0,1.3d0,           
     & 5000.0d0,1.4d0, 7000.d0, 1.5d0, 8000.d0, 1.6d0, 9000.d0,1.7d0,           
     &10000.d0, 1.8d0,11000.d0, 1.9d0,40000.d0, 2.0d0,45000.d0,2.1d0,           
     &50000.0d0,2.2d0,65000.d0, 2.5d0/                                          
      data p116/                                                                
     & 24000.d0, 1600.d0, 35000.d0, 1288.d0, 40000.d0, 1130.d0,                 
     & 45000.d0,  950.d0, 50000.d0,  850.d0, 55000.d0,  750.d0,                 
     & 58000.d0,  600.d0, 60000.d0,  500.d0, 62000.d0,  425.d0,                 
     & 65000.d0,  300.d0/                                                       
c 2013-2018 renters pcred                                                       
       data p216r/                                                              
     & 4000.d0, 1.d0 , 5000.d0, 1.1d0, 7000.d0, 1.2d0, 9000.d0,1.3d0,           
     &11000.0d0,1.4d0,13000.d0, 1.5d0,14000.d0, 1.6d0,15000.d0,1.7d0,           
     &17000.d0, 1.8d0,18000.d0, 1.9d0,35000.d0, 2.0d0/                          
      data p116r/                                                               
     &  4000.d0,1235.d0, 5000.d0,1200.d0, 7000.d0,1175.d0,                      
     & 10000.d0,1100.d0,11000.d0,1075.d0,13000.d0,1050.d0,                      
     & 28000.d0,1020.d0,29000.d0, 925.d0,30000.d0, 835.d0,                      
     & 31000.d0, 707.d0,32000.d0, 617.d0,33000.d0, 557.d0,                      
     & 34000.d0, 305.d0,35000.d0, 125.d0/                                       
      data p16r/                                                                
     &  3000.d0, .05d0, 7000.d0, .1d0, 10000.d0,.15d0,14000.d0,.2d0,            
     & 17000.d0, .25d0,21000.d0, .3d0, 24000.d0,.35d0,28000.d0,.4d0,            
     & 31000.d0, .45d0,35000.d0, .5d0/                                          
c 2012 renters pcred                                                            
      data p112r/                                                               
     & 28000.d0, 995.d0,29000.d0, 900.d0,30000.d0, 800.d0,                      
     & 31000.d0, 700.d0,32000.d0, 600.d0,33000.d0, 500.d0,                      
     & 34000.d0, 300.d0,35000.d0, 100.d0/                                       
      data p212r/                                                               
     & 4000.d0, 1.d0 , 5000.d0, 1.1d0, 7000.d0, 1.2d0, 9000.d0,1.3d0,           
     &11000.0d0,1.4d0,13000.d0, 1.5d0,14000.d0, 1.6d0,15000.d0,1.7d0,           
     &17000.d0, 1.8d0,18000.d0, 1.9d0,19000.d0, 2.0d0,20000.d0,2.2d0,           
     &21000.d0, 2.4d0,22000.d0, 2.6d0,23000.d0, 2.7d0,24000.d0,2.8d0,           
     &25000.d0, 2.9d0,26000.d0, 3.0d0,27000.d0, 3.1d0,28000.d0,3.2d0,           
     &29000.d0, 3.3d0,30000.d0, 3.4d0,35000.d0, 3.5d0/                          
c 2008-2010 homeowners pcred                                                    
       data p210/                                                               
     & 1000.d0, 1.d0 , 2000.d0, 1.1d0, 3000.d0, 1.2d0, 4000.d0,1.3d0,           
     & 5000.0d0,1.4d0, 7000.d0, 1.5d0, 8000.d0, 1.6d0, 9000.d0,1.7d0,           
     &10000.d0, 1.8d0,11000.d0, 1.9d0,12000.d0, 2.0d0,14000.d0,2.1d0,           
     &15000.d0, 2.2d0,16000.d0, 2.3d0,17000.d0, 2.4d0,21000.d0,2.5d0,           
     &24000.d0, 2.6d0,30000.d0, 2.7d0,35000.d0, 2.8d0,40000.d0,3.0d0,           
     &45000.d0, 3.2d0,65000.d0, 3.5d0/                                          
      data p101/                                                                
     & 2000.0d0, 1550.0d0, 4000.0d0, 1500.0d0, 7000.0d0, 1450.0d0,              
     & 9000.0d0, 1400.0d0,11000.0d0, 1350.0d0,14000.0d0, 1300.0d0,              
     &16000.0d0, 1250.0d0,21000.0d0, 1200.0d0,30000.0d0, 1150.0d0,              
     &40000.0d0, 1100.0d0,45000.0d0,  950.0d0,50000.0d0,  850.0d0,              
     &55000.0d0,  750.0d0,58000.0d0,  600.0d0,60000.0d0,  500.0d0,              
     &62000.0d0,  425.0d0,65000.0d0,  300.0d0/                                  
      data p201/                                                                
     &  1000.d0, 1.0d0, 2000.d0, 1.1d0, 3000.d0, 1.2d0, 4000.d0,1.3d0,          
     &  5000.d0, 1.4d0, 7000.d0, 1.5d0, 8000.d0, 1.6d0, 9000.d0,1.7d0,          
     & 10000.d0, 1.8d0,11000.d0, 1.9d0,12000.d0, 2.0d0,14000.d0,2.1d0,          
     & 15000.d0, 2.2d0,16000.d0, 2.3d0,17000.d0, 2.4d0,21000.d0,2.5d0,          
     & 24000.d0, 2.6d0,30000.d0, 2.7d0,35000.d0, 2.8d0,40000.d0,3.0d0,          
     & 45000.d0, 3.2d0,50000.d0, 3.5d0,65000.d0, 4.0d0/                         
      data owner/12*60000.d0,15*65000.d0,64600.d0,65125.d0,65066.d0,            
     & 65020.d0,64940.d0,64962.d0/                                              
      data rrrent /11*28034.d0,28117.d0,26919.d0,26960.d0,34903.d0,             
     &    35118.d0,35100.d0,35139.d0,35045.d0,35124.d0,34911.d0,                
     &    35016.d0,35035.d0,34941.d0,35312.d0,35209.d0,35044.d0,                
     &    35278.d0,35291.d0,35261.d0,35240.d0,35195.d0,35206.d0/                
      data p2o/                                                                 
     &  3000.d0, .15d0, 7000.d0, .2d0, 10000.d0, .25d0, 14000.d0,.3d0,          
     & 17000.d0, .35d0,30000.d0, .4d0, 45000.d0, .45d0, 65000.d0,.5d0/          
      data p1o/                                                                 
     &  1000.d0, 1.2d0, 2000.d0, 1.3d0, 3000.d0, 1.4d0, 4000.d0,1.6d0,          
     &  5000.d0, 1.7d0, 7000.d0, 1.9d0, 8000.d0, 2.1d0, 9000.d0,2.2d0,          
     & 10000.d0, 2.3d0,11000.d0, 2.4d0,12000.d0, 2.5d0,14000.d0,2.6d0,          
     & 15000.d0, 2.8d0,16000.d0, 3.0d0,17000.d0, 3.2d0,21000.d0,3.3d0,          
     & 24000.d0, 3.4d0,35000.d0, 3.5d0,40000.d0, 3.7d0,   1.e20,4.0d0/          
      data p10o/                                                                
     &  3000.d0, .15d0, 7000.d0, .2d0, 10000.d0,.25d0,14000.d0,.3d0,            
     & 17000.d0, .35d0, 30000.d0, .4d0,45000.d0,.45d0,65000.d0,.5d0 /           
      data p16o/                                                                
     &  3000.d0, .15d0, 10000.d0, .2d0, 14000.d0,.25d0,17000.d0,.3d0,           
     & 35000.d0, .35d0, 55000.d0, .4d0, 60000.d0,.45d0,65000.d0,.5d0 /          
      data aif2/                                                                
     &         5*1.0d0, 1.03d0 , 1.06d0 , 1.09d0, 1.12d0  , 1.14d0,             
     &  1.16d0, 1.195d0, 1.233d0 , 1.255d0,   1.279d0, 1.309d0,                 
     &  1.349d0, 1.399d0, 1.429d0, 1.489d0, 1.509d0, 1.519d0,                   
     &  1.549d0, 1.599d0, 1.619d0, 1.649d0, 1.659d0, 1.669d0, 1.699d0,          
     &  1.739d0, 1.769d0, 1.789d0, 1.844d0/                                     
      data aifr/                                                                
     &         5*1.0d0, 1.03d0 , 1.06d0 , 1.09d0, 1.12d0  , 1.14d0,             
     &  1.16d0, 1.195d0, 1.235d0 , 1.259d0,   1.289d0, 1.309d0,                 
     &  1.349d0, 1.399d0, 1.439d0, 1.489d0, 1.519d0, 1.529d0,                   
     &  1.559d0, 1.609d0, 1.619d0, 1.649d0, 1.659d0, 1.669d0, 1.699d0,          
     &  1.739d0, 1.769d0, 1.789d0, 1.844d0/                                     
      data  dep /                                                               
     4       .0d0,3430.0d0, 6615.0d0, 9555.0d0,12250.0d0,14700.0d0,             
     5       .0d0,3500.0d0, 6750.0d0, 9750.0d0,12500.0d0,15000.0d0,             
     6       .0d0,3570.0d0, 6885.0d0, 9945.0d0,12750.0d0,15300.0d0,             
     7       .0d0,3710.0d0, 7155.0d0,10335.0d0,13250.0d0,15900.0d0,             
     8       .0d0,3780.0d0, 7290.0d0,10530.0d0,13500.0d0,16200.0d0,             
     9       .0d0,3850.0d0, 7425.0d0,10725.0d0,13750.0d0,16500.0d0,             
     &       .0d0,3920.0d0, 7560.0d0,10920.0d0,14000.0d0,16800.0d0,             
     1       .0d0,4060.0d0, 7830.0d0,11310.0d0,14500.0d0,17400.0d0,             
     2       .0d0,4200.0d0, 8100.0d0,11700.0d0,15000.0d0,18000.0d0,             
     3       .0d0,4270.0d0, 8235.0d0,11895.0d0,15250.0d0,18300.0d0,             
     4       .0d0,4340.0d0, 8370.0d0,12090.0d0,15500.0d0,18600.0d0,             
     5       .0d0,4480.0d0, 8640.0d0,12480.0d0,16000.0d0,19200.0d0,             
     6       .0d0,4620.0d0, 8910.0d0,12870.0d0,16500.0d0,19800.0d0,             
     7       .0d0,4760.0d0, 9180.0d0,13260.0d0,17000.0d0,20400.0d0,             
     8       .0d0,4900.0d0, 9450.0d0,13650.0d0,17500.0d0,21000.0d0,             
     9       .0d0,5110.0d0, 9855.0d0,14235.0d0,18250.0d0,21900.0d0,             
     &       .0d0,5110.0d0, 9855.0d0,14235.0d0,18250.0d0,21900.0d0,             
     1       .0d0,5180.0d0, 9990.0d0,14430.0d0,18500.0d0,22200.0d0,             
     2       .0d0,5320.0d0,10260.0d0,14820.0d0,19000.0d0,22800.0d0,             
     3       .0d0,5460.0d0,10530.0d0,15210.0d0,19500.0d0,23400.0d0,             
     4       .0d0,5530.0d0,10665.0d0,15405.0d0,19750.0d0,23700.0d0,             
     5       .0d0,5600.0d0,10800.0d0,15600.0d0,20000.0d0,24000.0d0,             
     6       .0d0,5670.0d0,10935.0d0,15795.0d0,20250.0d0,24300.0d0,             
     7       .0d0,5670.0d0,10935.0d0,15795.0d0,20250.0d0,24300.0d0,             
     8       .0d0,5810.0d0,11205.0d0,16185.0d0,20750.0d0,24900.0d0,             
     9       .0d0,5950.0d0,11475.0d0,16575.0d0,21250.0d0,25500.0d0,             
     &       .0d0,6020.0d0,11610.0d0,16770.0d0,21500.0d0,25800.0d0,             
     1       .0d0,6090.0d0,11745.0d0,16965.0d0,21750.0d0,26100.0d0/             
      data oldep /                                                              
     & .0d0,5880.0d0, 9065.0d0,12005.0d0,14700.0d0,17150.0d0/                   
c property tax refund                                                           
      pcred = 0.                                                                
      refo = 0.                                                                 
      thrate = 0.                                                               
      copay = 0.                                                                
      pcredo = 0.                                                               
      pcredr = 0.                                                               
      hhy = max(0.0d0,comnew(2)+data(91)-comnew(79))                            
c      write(0,*) 'law exem',law,exem(law)                                      
c      if(law.ge.2018) exem(law) = 4150.d0                                      
c      write(0,*) 'law exem',law,exem(law)                                      
c add back Capital Loss                                                         
      if(comnew(6).lt.0)                                                        
     & hhy = max(0.0d0,comnew(2)+data(91)-comnew(79)-comnew(6))                 
      if(law.ge.1989) then                                                      
c for years 1989 and on                                                         
        ptxo = data(51)                                                         
        if(law.le.2008.or.law.eq.2010) then                                     
           ptxr= .19*data(160)                                                  
        else if (law.eq.2009) then                                              
           ptxr= .15*data(160)                                                  
        else                                                                    
           ptxr= .17*data(160)                                                  
        endif                                                                   
c subtraction for dependents and for those age 65 or older or disabled          
c This could be in 1993 but I don't have instructions for 1993                  
        if(law.ge.1994) then                                                    
          kid = int(min(5.0d0,data(8)))                                              
          if(data(9)+data(10).gt.0) then                                        
             if(law.eq.1994) then                                               
               hhy=max(0.0d0,hhy-oldep(kid))                                    
             else                                                               
               hhy=max(0.0d0,hhy-dep(kid,law)-exem(law))                        
             endif                                                              
          else                                                                  
             hhy=max(0.0d0,hhy-dep(kid,law))                                    
          endif                                                                 
        endif                                                                   
        if(ptxr.gt.0.and.hhy.le.rrrent(law)*aifr(law)) then                     
         if(law.ge.2013.and.law.le.2018) then                                   
c refr -max refund for renters                                                  
            refr=tablki(p116r,14,hhy/aifr(law),data)*aifr(law)                  
            thrate = tablki(p216r,11,hhy/aifr(law),data)                        
         else                                                                   
            refr=tablki(p112r,8,hhy/aifr(law),data)*aifr(law)                   
            thrate = tablki(p212r,23,hhy/aifr(law),data)                        
         endif                                                                  
c copay - percent paid by claimant                                              
         copay = tablki(p16r,10,hhy/aifr(law),data)                             
         thres = min(ptxr,thrate*hhy/100)                                       
c pcredr - property tax refund for renters                                      
         pcredr = min(refr,max(0.0d0,ptxr - thres)*(1.-copay))                  
         pcredr = max(0.0d0,pcredr)                                             
         else if(ptxo.gt.0..and.hhy.le.owner(law)*aif2(law)) then               
c refo -max refund for homeowners                                               
         if(law.le.2000) then                                                   
           if(hhy.le.58000.0d0*aif2(law)) then                                  
              clawo=max(0.0d0,min(430.0d0*aif2(law),                            
     &         (hhy-57000.0d0*aif2(law))*.143))                                 
           else if(hhy.gt.58000.0d0*aif2(law).and.                              
     &              hhy.le.60000.0d0*aif2(law)) then                            
              clawo=max(0.0d0,min(430.0d0*aif2(law),                            
     &          (hhy-58000.0d0*aif2(law))*.215))                                
           else                                                                 
              clawo=430.0d0*aif2(law)                                           
           endif                                                                
           refo=430.*aif2(law) - clawo                                          
c tablk(p1o,...) is treshold percentage  for homeowners 1989-2000               
           thrate = tablki(p1o,20,hhy/aif2(law),data)                           
         else                                                                   
           if(law.le.2002) then                                                 
             refo=tablki(p101,17,hhy/aif2(law),data)*aif2(law)                  
c tablk(p201...) is treshold percentage  for homeowners 2001+                   
             thrate = tablki(p201,23,hhy/aif2(law),data)                        
           else if (law.ge.2003.and.law.le.2007) then                           
             refo=tablki(p107,17,hhy/aif2(law),data)*aif2(law)                  
             thrate = tablki(p210,22,hhy/aif2(law),data)                        
           else if (law.ge.2008.and.law.le.2010) then                           
             refo=tablki(p110,16,hhy/aif2(law),data)*aif2(law)                  
             thrate = tablki(p210,22,hhy/aif2(law),data)                        
           else                                                                 
             refo=tablki(p116,10,hhy/aif2(law),data)*aif2(law)                  
             thrate = tablki(p216,14,hhy/aif2(law),data)                        
           endif                                                                
         endif                                                                  
c copay - percent paid by claimant                                              
         if(law.le.2002) then                                                   
           copay = tablki(p2o,8,hhy/aif2(law),data)                             
         else if (law.ge.2003.and.law.le.2010) then                             
           copay = tablki(p10o,8,hhy/aif2(law),data)                            
         else                                                                   
           copay = tablki(p16o,8,hhy/aif2(law),data)                            
         endif                                                                  
         thres = min(ptxo,thrate*hhy/100)                                       
         pcredo = min(refo,max(0.0d0,ptxo - thres)*(1.-copay))                  
         pcredo = max(0.0d0,pcredo)                                             
c pcredo - property tax refund for owners                                       
        endif                                                                   
        pcred = pcredo + pcredr                                                 
      else if(law.le.1988) then                                                 
c for years before 1988                                                         
       ptx = data(51) + .2*data(160)                                            
c 1988 and 1987                                                                 
       excess = 0.                                                              
       if((law.ge.1987.and.law.le.1988).and.data(159).lt.35000.0d0) then        
        if(law.eq.1988) then                                                    
          if(ptx.gt.tablki(p88x,33,data(159),data)*data(159))                   
     &     excess = ptx-tablki(p88x,33,data(159),data)*data(159)                
        elseif(law.eq.1987) then                                                
         if(data(8).gt.0.or.data(9).gt.0.or.data(10).gt.0) then                 
          if(ptx.gt.tablki(p87x1,17,data(159),data)*data(159))                  
     &     excess = ptx-tablki(p87x1,17,data(159),data)*data(159)               
         else                                                                   
          if(ptx.gt.tablki(p87x2,17,data(159),data)*data(159))                  
     &     excess = ptx-tablki(p87x2,17,data(159),data)*data(159)               
         endif                                                                  
        endif                                                                   
        if(data(159).lt.10000) then                                             
            maxcrd = 1100.                                                       
        elseif(data(159).ge.10000.and.data(159).lt.17000) then                  
            maxcrd= 1075.                                                       
        elseif(data(159).ge.17000.and.data(159).lt.23000) then                  
            maxcrd= 1050.                                                       
        elseif(data(159).ge.23000.and.data(159).lt.26500) then                  
            maxcrd= 1025.                                                       
        elseif(data(159).ge.26500.and.data(159).lt.27000) then                  
            maxcrd= 1013.                                                       
        elseif(data(159).ge.27000.and.data(159).lt.32500) then                  
            maxcrd= 1000.-.1*(data(159)-27000)                                  
        else                                                                    
            maxcrd= 500.-.2*(data(159)-32000)                                   
        endif                                                                   
        if(law.eq.1988) then                                                    
         pcred = max(0.0d0,                                                     
     &   (1.0d0-tablki(p88y,26,data(159),data))*excess)                         
        elseif(law.eq.1987) then                                                
         pcred = max(0.0d0,                                                     
     &   (1.0d0-tablki(p87y,26,data(159),data))*excess)                         
        endif                                                                   
        if(pcred.gt.maxcrd) pcred = maxcrd                                      
       endif                                                                    
c 1985-1986                                                                     
       if(law.ge.1985.and.law.le.1986) then                                     
        hy85=data(159)                                                          
        if(data(9).gt.0) hy85=max(0.0d0,hy85-2000.0d0)                          
        if(ptx.gt.tablki(p85x,11,hy85,data)*hy85.and.                           
     &                                 hy85.lt.40000)then                       
          excess = ptx-tablki(p85x,11,hy85,data)*hy85                           
          if(hy85.lt.23500) then                                                
            maxcrd= 1125.                                                       
          elseif(hy85.ge.23500.and.hy85.lt.31250) then                          
            maxcrd= 1125.-.0290322*(hy85-23500.0d0)                             
          else                                                                  
            maxcrd= 900.-.1*(hy85-31250.0d0)                                    
          endif                                                                 
          pcred = max(0.0d0,(1-tablki(p85y,31,hy85,data))*excess)               
          if(pcred.gt.maxcrd) pcred = maxcrd                                    
c         pcred = min(maxcrd,pcred)                                             
        endif                                                                   
       endif                                                                    
c 1983-1984                                                                     
c From 1977-1984 the formula required a two step calculation.                   
       if((law.ge.1983.and.law.le.1984).and.data(159).lt.40000.and.             
     &ptx.gt.0.and.ptx.gt.tablki(p1,16,data(159),data)*data(159))then           
          excess = ptx-tablki(p1,16,data(159),data)*data(159)                   
c First Step Credit                                                             
          if(data(159).lt.34000) then                                           
            step1= min(excess,tablki(p83,34,data(159),data))                    
          else                                                                  
            step1 = min(excess,700.0d0-.1*(data(159)-33000.0d0))                
          endif                                                                 
c Second Step Maximum Credit                                                    
          if(data(159).lt.24000) then                                           
            maxcrd= 1125                                                        
          elseif(data(159).ge.24000.and.data(159).lt.25000) then                
            maxcrd= 1105                                                        
          elseif(data(159).ge.25000.and.data(159).lt.26000) then                
            maxcrd= 1080                                                        
          elseif(data(159).ge.26000.and.data(159).lt.27000) then                
            maxcrd= 1050                                                        
          elseif(data(159).ge.27000.and.data(159).lt.28000) then                
            maxcrd= 1020                                                        
          elseif(data(159).ge.28000.and.data(159).lt.29000) then                
            maxcrd= 990                                                         
          elseif(data(159).ge.29000.and.data(159).lt.30000) then                
            maxcrd= 960                                                         
          elseif(data(159).ge.30000.and.data(159).lt.31000) then                
            maxcrd= 930                                                         
          else                                                                  
            maxcrd= 900-.1*(data(159)-31000.0d0)                                
          endif                                                                 
c Full Credit                                                                   
          if(data(9)+data(10).eq.0) then                                        
            pcred = max(0.0d0,                                                  
     &       (1-tablki(p2,31,data(159),data))*max(0.0d0,excess-step1))          
     &       +step1                                                             
          else                                                                  
            pcred = max(0.0d0,                                                  
     &     (1-tablki(p2eld,19,data(159),data))*max(0.0d0,excess-step1))         
     &       +step1                                                             
          endif                                                                 
          if(pcred.gt.maxcrd) pcred = maxcrd                                    
c         pcred = min(maxcrd,pcred)                                             
          if(data(159).ge.33000.and.data(159).lt.36000) then                    
             pcred = max(0.0d0,min(pcred,ptx-.022*data(159)))                   
          else if(data(159).ge.36000.and.data(159).lt.40000) then               
             pcred = max(0.0d0,min(pcred,ptx-.024*data(159)))                   
          endif                                                                 
       endif                                                                    
c 1979-1982                                                                     
       if((law.ge.1979.and.law.le.1982).and.                                    
     &ptx.gt.0.and.ptx.gt.tablki(p82,27,data(159),data)*data(159))then          
          excess = ptx-tablki(p82,27,data(159),data)*data(159)                  
c First Step Credit                                                             
          if(data(159).lt.21000) then                                           
            if(data(9)+data(10).eq.0) then                                      
              step1= min(excess,tablki(p821,21,data(159),data))                 
            else                                                                
              step1= min(excess,tablki(p822,21,data(159),data))                 
            endif                                                               
          else                                                                  
            if(data(9)+data(10).eq.0) then                                      
              step1 = max(0.0d0,min(excess,650-.1*(data(159)-21000)))           
            else                                                                
              step1 = max(0.0d0,min(excess,850-.1*(data(159)-21000)))           
            endif                                                               
          endif                                                                 
c Second Step Maximum Credit                                                    
          if(data(159).lt.28000) then                                           
            maxcrd= 1000                                                        
          elseif(data(159).ge.28000.and.data(159).lt.29000) then                
            maxcrd= 990                                                         
          elseif(data(159).ge.29000.and.data(159).lt.30000) then                
            maxcrd= 960                                                         
          elseif(data(159).ge.30000.and.data(159).lt.31000) then                
            maxcrd= 930                                                         
          else                                                                  
            maxcrd= max(0.0d0,900-.1*(data(159)-31000))                         
          endif                                                                 
c Full Credit                                                                   
          pcred = max(0.0d0,.5*max(0.0d0,excess-step1))+step1                   
          if(pcred.gt.maxcrd) pcred = maxcrd                                    
       endif                                                                    
c 1977-1978                                                                     
       if((law.ge.1977.and.law.le.1978).and.                                    
     &ptx.gt.0.and.ptx.gt.tablki(p82,27,data(159),data)*data(159))then          
          excess = ptx-tablki(p82,27,data(159),data)*data(159)                  
c First Step Credit                                                             
          if(data(159).lt.21000) then                                           
            if(data(9)+data(10).eq.0) then                                      
              step1= min(excess,tablki(p771,21,data(159),data))                 
            else                                                                
              step1= min(excess,tablki(p772,21,data(159),data))                 
            endif                                                               
          else                                                                  
            if(data(9)+data(10).eq.0) then                                      
              step1 = max(0.0d0,min(excess,475-.1*(data(159)-21000)))           
            else                                                                
              step1 = max(0.0d0,min(excess,675-.1*(data(159)-21000)))           
            endif                                                               
          endif                                                                 
c Second Step Maximum Credit                                                    
          if(data(159).lt.28000) then                                           
            maxcrd=  800                                                        
          else                                                                  
            maxcrd= max(0.0d0,800-.1*(data(159)-28000))                         
          endif                                                                 
c Full Credit                                                                   
          if(data(9)+data(10).eq.0) then                                        
           pcred = max(0.0d0,.35*max(0.0d0,excess-step1))+step1                 
          else                                                                  
           pcred = max(0.0d0,.5*max(0.0d0,excess-step1))+step1                  
          endif                                                                 
          if(pcred.gt.maxcrd) pcred = maxcrd                                    
       endif                                                                    
      endif                                                                     
c To qualify for pcred you can't be claimed as a dependent by another taxpayer  
      if(data(105).gt.0.d0) pcred = 0.d0                                        
      pcred = max(0.0d0,pcred)                                                  
                                                                                
      return                                                                    
      end                                                                       
      subroutine crmarr1(data,comnew,taxinc,fedtax,statax,crmar,law)            
      implicit double precision (A-H,O-Z)                                       
      common /fed/ zbrack(3,1987:2022),exem(1987:2022)                          
      dimension crmax1(1999:2021),eam(1999:2021),ceil(1999:2021)                
      dimension data(255),comnew(255)                                           
c  start of earn arrays                                                         
      data eam/14000.d0,  14250.d0,15000.d0,  16000.d0,3*17000.d0,              
     &18000.d0,19000.d0,5*20000.d0,21000.d0,2*22000.d0,3*23000.d0,              
     &2*25000.d0,26000.d0/                                                      
c  start of taxinc arrays                                                       
      data ceil/ 25000.d0,  25680.d0,  26480.d0,2*28000.d0,29000.d0,            
     &  30000.d0,31000.d0,2*32000.d0,3*34000.d0,  35000.d0,36000.d0,            
     &3*37000.d0,2*38000.d0,39000.d0,2*40000.d0/                                
c Maximum of marriage credit                                                    
      data crmax1/  261.d0,  268.d0,276.d0,285.d0,290.d0,296.d0,303.d0,         
     &313.d0,325.d0,332.d0,2*347.d0,352.d0,361.d0,1370.d0,1393.d0,              
     &1415.d0,1421.d0,1433.d0,1462.d0,1508.d0,1533.d0,1548.d0/                  
      mst = int(data(2))                                                             
c 1999 - marriage credit - non refundable                                       
      crmar = 0.                                                                
c total earned income,taxable pensions,taxable SSB,self-employment inc          
c and farm income less the self-employment tax deduction                        
      earn = 0.                                                                 
      if(law.eq.1999.and.mst.eq.2) then                                         
c 1999 "earned income" as wages and SE income                                   
        earn = min(data(85),data(86))+.5*(                                      
     &  max(0.0d0,data(21))+max(0.0d0,data(17))-.5*comnew(175))                 
      else if(law.ge.2000.and.mst.eq.2) then                                    
c 2000+ expansion to include taxable pension and SS income                      
c total earned income,taxable pensions,taxable SSB,self-employment inc          
c and farm income less the self-employment tax deduction                        
        d17 = data(17)+data(211)+data(214)+data(212)+data(215)+data(213)        
        earn = min(data(85),data(86))+.5*(data(20)+data(72)+comnew(79)+         
     &  max(0.0d0,data(21))+max(0.0d0,d17)-.5*comnew(175))                      
      endif                                                                     
c for 1999+                                                                     
      if(law.ge.1999.and.mst.eq.2) then                                         
c one personal exemption and 1/2 of the married-joint stded                     
          if(law.le.2017) then                                                  
            xl10 = exem(law) + zbrack(2,law)/2                                  
          else if(law.eq.2018) then                                             
            xl10 = 10650.d0                                                     
          else if(law.ge.2019) then                                             
            xl10 = 12200.d0                                                     
          endif                                                                 
c computed taxable income of spouse B                                           
          xl11 = max(0.0d0,earn - xl10)                                         
c the tax for computed taxable income of Spouse B                               
c using the rate schedule for SINGLE                                            
          call mnrate(1,xl11,fedtax,law,x1,rt,data)                             
c computed taxable income of spouse A                                           
          xl15 = max(0.0d0,taxinc - xl11)                                       
c the tax for computed taxable income of Spouse A                               
c using the rate schedule for SINGLE                                            
          call mnrate(1,xl15,fedtax,law,x2,rt,data)                             
c Marriage credit                                                               
          eamb = eam(law)                                                       
          cel1 = ceil(law)                                                      
          statm = statax                                                        
          if(taxinc.lt.cel1.or.earn.lt.eamb) statm = 0.                         
          crmar = min(crmax1(law),max(0.0d0,statm-(x1+x2)))                     
      endif                                                                     
      return                                                                    
      end                                                                       
      subroutine mnrate(mst,taxinc,fedtax,law,statax,rate,data)                 
      implicit double precision (A-H,O-Z)                                       
      dimension data(255)                                                       
      dimension surtax(1977:1983)                                               
      dimension tab87s(2,4), tab87j(2,4), tab87h(2,4)                           
      dimension tab88s(2,4), tab88j(2,4), tab88h(2,4)                           
      dimension tab91s(2,3), tab91j(2,3), tab91h(2,3)                           
      dimension tb91s(2,3), tb91j(2,3), tb91h(2,3)                              
      dimension tab99s(2,3), tab99j(2,3), tab99h(2,3)                           
      dimension tab00s(2,3), tab00j(2,3), tab00h(2,3),                          
     & aif00(2000:2012),aif13(2013:2021)                                        
      dimension tab13s(2,4), tab13j(2,4), tab13h(2,4)                           
      dimension tab19s(2,4), tab19j(2,4), tab19h(2,4)                           
      dimension tab77(2,13),tb77(2,13),aif(1977:1998)                           
      dimension tb85am(2,9),tb85bm(2,16),tb85as(2,11),tb85bs(2,11)              
      integer filer,sep                                                         
      data surtax/ 5* 1.0d0, 1.070d0,  1.10d0/                                  
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0,1.067d0,1.0d0          
     & ,1.0165d0,1.0267722d0 /                                                  
      data aif00/                                                               
     &        1.0d0,   1.032d0,  1.065d0,  1.082d0 ,   1.106d0 ,                
     &      1.132d0,   1.167d0,  1.213d0,  1.2407d0,   1.2936d0,                
     &     1.2959d0,   1.315d0,  1.34696d0/                                     
      data aif   /                                                              
     &    2* 1.0d0,   1.1011d0, 1.196d0,  1.306d0,                              
     &     1.332d0,   1.342d0 , 1.379d0,  1.0d0  ,                              
     &     1.037d0,    5*1.0d0, 1.051d0,  1.085d0,                              
     &     1.118d0,   1.1471d0, 1.18d0 ,  1.212d0,                              
     &     1.238d0/                                                             
c tb77 -- base table for years 1977-1984                                        
      data tb77/                                                                
     &           500.0d0,  1.6d0,  1000.0d0,  2.2d0, 2000.0d0,  3.5d0,          
     &          3000.0d0,  5.8d0,  4000.0d0,  7.3d0, 5000.0d0,  8.8d0,          
     &          7000.0d0, 10.2d0,  9000.0d0, 11.5d0,12500.0d0, 12.8d0,          
     &         20000.0d0, 14.0d0, 27500.0d0, 15.0d0,40000.0d0,   .0d0,          
     &             1.e20,   .0d0/                                               
      data tb85bm/                                                              
     &           875.0d0,  1.5d0,  1750.0d0,  2.0d0, 3500.0d0,  2.9d0,          
     &          5375.0d0,  4.8d0,  7000.0d0,  5.9d0, 7125.0d0,  6.1d0,          
     &          8875.0d0,  7.2d0, 12375.0d0,  8.3d0,14000.0d0,  9.3d0,          
     &         16000.0d0, 10.0d0, 21500.0d0, 11.0d0,22125.0d0, 11.3d0,          
     &         25500.0d0, 12.3d0, 28500.0d0, 12.6d0,31750.0d0, 13.7d0,          
     &             1.e20, 14.0d0/                                               
      data tb85am/                                                              
     &          1200.0d0,  1.7d0,  1700.0d0,  2.1d0,  2700.0d0, 2.3d0,          
     &          5600.0d0,  3.3d0,  9100.0d0,  5.3d0, 12600.0d0, 6.8d0,          
     &         17800.0d0,  8.5d0, 30800.0d0,  9.3d0,     1.e20, 9.9d0/          
      data tb85bs/                                                              
     &           700.0d0,  1.3d0,  1400.0d0,  1.9d0,  2800.0d0, 3.2d0,          
     &          4300.0d0,  5.4d0,  5700.0d0,  6.9d0,  7100.0d0, 8.4d0,          
     &          9900.0d0,  9.8d0, 12800.0d0, 11.1d0, 15400.0d0,12.4d0,          
     &         19400.0d0, 13.6d0,     1.e20, 14.0d0/                            
      data tb85as/                                                              
     &           300.0d0,  1.0d0,   600.0d0,  1.6d0,   900.0d0,  1.6d0,         
     &          1300.0d0,  2.1d0,  2000.0d0,  2.7d0,  2800.0d0,  3.7d0,         
     &          4300.0d0,  4.5d0,  6400.0d0,  6.1d0,  9400.0d0,  7.5d0,         
     &         16200.0d0,  9.3d0,     1.e20,  9.9d0/                            
      data tab87s/                                                              
     &          3000.0d0,  4.0d0,   7500.0d0, 6.0d0,  16000.0d0,  8.0d0,        
     &             1.e20,  9.0d0/                                               
      data tab87j/                                                              
     &          4000.0d0,  4.0d0,  11000.0d0, 6.0d0,  21000.0d0,  8.0d0,        
     &             1.e20,  9.0d0/                                               
      data tab87h/3500.d0, 4.d0,9250.d0,6.d0,18500.d0,8.d0,1.e20,9.d0/          
      data tab88s/13000.d0,6.d0,42800.d0,8.d0,93000.d0,8.5d0,1.e20,9.d0/        
      data tab88j/19000.d0,6.d0,75500.d0,8.d0,165000.d0,8.5d0,                  
     & 1.e20,9.d0/                                                              
      data tab88h/                                                              
     &         16000.0d0,  6.0d0, 64300.0d0,  8.0d0, 135000.0d0,  8.5d0,        
     &            1.e20,  9.0d0/                                                
c tb91s,tb91j,tb91h - base for 1991-1998                                        
      data tb91s/                                                               
     &         13700.0d0,  6.0d0, 45000.0d0,  8.0d0,      1.e20,  8.5d0/        
      data tb91j/                                                               
     &         20000.0d0,  6.0d0, 79120.0d0,  8.0d0,      1.e20,  8.5d0/        
      data tb91h/                                                               
     &         16800.0d0,  6.0d0, 67390.0d0,  8.0d0,      1.e20,  8.5d0/        
      data tab99s/                                                              
     &         17250.0d0,  5.5d0, 56680.0d0,  7.25d0,      1.e20, 8.0d0/        
      data tab99j/                                                              
     &         25220.0d0,  5.5d0,100200.0d0,  7.25d0,      1.e20, 8.0d0/        
      data tab99h/                                                              
     &         21240.0d0,  5.5d0, 85350.0d0,  7.25d0,      1.e20, 8.0d0/        
      data tab00s/                                                              
     &         17570.0d0, 5.35d0,  57710.0d0, 7.05d0,     1.e20, 7.85d0/        
      data tab00h/                                                              
     &         21630.0d0, 5.35d0,  86910.0d0, 7.05d0,     1.e20, 7.85d0/        
      data tab00j/                                                              
     &         25680.0d0, 5.35d0, 102030.0d0, 7.05d0,     1.e20, 7.85d0/        
c 2013: a new income tax rate of 9.85%                                          
      data tab13s/                                                              
     & 24210.d0,5.35d0, 79730.d0,7.05d0,150000.d0,7.85d0,1.e20, 9.85d0/         
      data tab13h/                                                              
     & 29880.d0,5.35d0,120070.d0,7.05d0,200000.d0,7.85d0,1.e20, 9.85d0/         
      data tab13j/                                                              
     & 35480.d0,5.35d0,140960.d0,7.05d0,250000.d0,7.85d0,1.e20, 9.85d0/         
c 2019                                                                          
      data tab19s/                                                              
     & 26520.d0,5.35d0, 87110.d0,6.8d0,161720.d0,7.85d0,1.e20, 9.85d0/          
      data tab19h/                                                              
     & 32650.d0,5.35d0,131190.d0,6.8d0,214980.d0,7.85d0,1.e20, 9.85d0/          
      data tab19j/                                                              
     & 38770.d0,5.35d0,154020.d0,6.8d0,269010.d0,7.85d0,1.e20, 9.85d0/          
c      write(0,*) 'in mnrate'                                                   
c regular tax. until 1985 a single schedule with separate                       
c accounting for husbands and wives. in 1985 joint filing is                    
c established and the federal income tax deduction is made                      
c optional.                                                                     
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      filer = 1                                                                 
      if(mst.eq.2.or.mst.eq.5)filer = 2                                         
      if(mst.eq.4.or.mst.eq.7)filer = 3                                         
      if(law.le.1984) then                                                      
        do 9 i=1,13                                                             
        do 8 j=1,2                                                              
          tab77(j,i)=tb77(j,i)                                                  
8       continue                                                                
9       continue                                                                
c top brackets vary from year to year before 1985                               
        if(law.eq.1977) then                                                    
          do 10 i=12,13                                                         
            tab77(2,i)=15.d0                                                    
10        continue                                                              
        else if(law.eq.1978.or.law.eq.1979) then                                
          tab77(2,12)=16.d0                                                     
          tab77(2,13)=17.d0                                                     
        else if(law.ge.1980.and.law.le.1984) then                               
          do 11 i=12,13                                                         
            tab77(2,i)=16.d0                                                    
11        continue                                                              
        endif                                                                   
        call look(tab77,taxinc,13,n,statax,aif(law),0.0d0,rt,data)              
        rate=rt                                                                 
      else if(law.eq.1985.or.law.eq.1986) then                                  
        txinca=taxinc                                                           
        txincb=max(0.0d0,taxinc-fedtax)                                         
        if(filer.eq.1.or.filer.eq.3) then                                       
          call look(tb85as,txinca,11,n,taxa,aif(law),0.0d0,rta,data)            
          call look(tb85bs,txincb,11,n,taxb,aif(law),0.0d0,rtb,data)            
        else if(filer.eq.2) then                                                
          call look(tb85am,txinca,9,n,taxa,aif(law),0.0d0,rta,data)             
          call look(tb85bm,txincb,16,n,taxb,aif(law),0.0d0,rtb,data)            
        endif                                                                   
        if(taxa.lt.taxb) then                                                   
          taxinc=txinca                                                         
          statax=taxa                                                           
          rate=rta                                                              
        else                                                                    
          taxinc=txincb                                                         
          statax=taxb                                                           
          rate=rtb                                                              
        endif                                                                   
      else if(law.eq.1987) then                                                 
       if(filer.eq.1)                                                           
     &  call look(tab87s,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)                
        if(filer.eq.2)                                                          
     &   call look(tab87j,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
        if(filer.eq.3)                                                          
     &   call look(tab87h,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
        rate=rt                                                                 
      else if(law.ge.1988.and.law.le.1990) then                                 
        if(filer.eq.1)                                                          
     &   call look(tab88s,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
        if(filer.eq.2)                                                          
     &   call look(tab88j,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
        if(filer.eq.3)                                                          
     &   call look(tab88h,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
        rate=rt                                                                 
      else if(law.ge.1991.and.law.le.1998) then                                 
c xyz table for years 1991-1998                                                 
        do 13 i=1,3                                                             
        do 12 j=1,2                                                             
          tab91s(j,i)=tb91s(j,i)                                                
          tab91j(j,i)=tb91j(j,i)                                                
          tab91h(j,i)=tb91h(j,i)                                                
12      continue                                                                
13      continue                                                                
        if(filer.eq.1)                                                          
     &   call look(tab91s,taxinc,3,n,statax,aif(law),0.0d0,rt,data)             
        if(filer.eq.2)                                                          
     &   call look(tab91j,taxinc,3,n,statax,aif(law),0.0d0,rt,data)             
        if(filer.eq.3)                                                          
     &   call look(tab91h,taxinc,3,n,statax,aif(law),0.0d0,rt,data)             
        rate=rt                                                                 
      else if(law.eq.1999) then                                                 
        if(mst.eq.1) then                                                       
         call look(tab99s,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)               
        else if(mst.eq.4.or.mst.eq.7) then                                      
         call look(tab99h,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)               
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab99j,taxy,3,n,statax,1.0d00,0.0d0,rt,data)                 
         statax = statax/sep                                                    
        endif                                                                   
        rate=rt                                                                 
      else if(law.ge.2000.and.law.le.2012) then                                 
        if(mst.eq.1) then                                                       
          call look(tab00s,taxinc,3,n,statax,aif00(law),0.0d0,rt,data)          
        else if(mst.eq.4.or.mst.eq.7) then                                      
          call look(tab00h,taxinc,3,n,statax,aif00(law),0.0d0,rt,data)          
        else                                                                    
          taxy = taxinc*sep                                                     
          call look(tab00j,taxy,3,n,statax,aif00(law),0.0d0,rt,data)            
          statax = statax/sep                                                   
        endif                                                                   
        rate=rt                                                                 
      else if(law.ge.2013.and.law.le.2018) then                                 
        if(mst.eq.1)                                                            
     &   call look(tab13s,taxinc,4,n,statax,aif13(law),0.0d0,rt,data)           
        if(filer.eq.2.or.sep.eq.2) then                                         
         taxy = taxinc*sep                                                      
         call look(tab13j,taxy,4,n,statax,aif13(law),0.0d0,rt,data)             
         statax = statax/sep                                                    
        endif                                                                   
        if(filer.eq.3)                                                          
     &   call look(tab13h,taxinc,4,n,statax,aif13(law),0.0d0,rt,data)           
        rate=rt                                                                 
      else if(law.ge.2019) then                                                 
        if(mst.eq.1)                                                            
     &   call look(tab19s,taxinc,4,n,statax,aif13(law),0.0d0,rt,data)           
        if(filer.eq.2.or.sep.eq.2) then                                         
         taxy = taxinc*sep                                                      
         call look(tab19j,taxy,4,n,statax,aif13(law),0.0d0,rt,data)             
         statax = statax/sep                                                    
        endif                                                                   
        if(filer.eq.3)                                                          
     &   call look(tab19h,taxinc,4,n,statax,aif13(law),0.0d0,rt,data)           
        rate=rt                                                                 
      endif                                                                     
c      write(0,*) 'taxinc statax aif13',int(taxinc),int(statax),                
c     &aif13(law)                                                               
      if(law.le.1983) statax=statax*surtax(law)                                 
      return                                                                    
      end                                                                       
c  MISSISSIPPI                                                                  
c  state 25                                                                     
c                                                                               
c  Updated through 2021 (updated 03.15.2022)                                    
      subroutine mstax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/times/zitem,ptax,txrate,h                                          
      dimension data(255),comnew(255)                                           
      dimension xmp(1977:2021,2),old(1977:2021),dep(1977:2021)                  
      dimension aif92(1991:2012),aif13(2013:2021)                               
      dimension tab77(2,2),tab83(2,3),tab18(2,4),tab19(2,4)                     
      dimension tab20(2,4),tab21(2,4),tab22(2,3)                                
      integer sep                                                               
      data aif92/                                                               
     &        1.0d0,  1.0525d0, 1.0845d0, 1.118d0 , 1.147d0 , 1.1795d0,         
     &      1.212d0,  1.2450d0, 1.2660d0, 1.2895d0, 1.3295d0, 1.3730d0,         
     &      1.395d0,  1.4270d0, 1.4595d0, 1.5050d0, 1.5640d0, 1.5995d0,         
     &      1.668d0,2*1.6955d0, 1.7365d0/                                       
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0,4*0.0d0/               
      data xmp/2* 4500.0d0,2*5250.0d0,41*6000.0d0,                              
     &         2* 6500.0d0,2*8000.0d0,17*9500.0d0,10000.0d0,11000.0d0,          
     &        22*12000.0d0/                                                     
      data old/   2*750.0d0, 43*1500.0d0/                                       
      data dep/   2*750.0d0, 43*1500.0d0/                                       
      data tab77/  5000.0d0, 3.0d0,    1.e20, 4.0d0/                            
      data tab83/  5000.0d0, 3.0d0,10000.0d0, 4.0d0,1.e20, 5.0d0/               
      data tab18/  1000.0d0, 0.0d0, 5000.0d0, 3.0d0,10000.d0, 4.0d0,            
     & 1.e20, 5.0d0/                                                            
      data tab19/  2000.0d0, 0.0d0, 5000.0d0, 3.0d0,10000.d0, 4.0d0,            
     & 1.e20, 5.0d0/                                                            
      data tab20/  3000.0d0, 0.0d0, 5000.0d0, 3.0d0,10000.d0, 4.0d0,            
     & 1.e20, 5.0d0/                                                            
      data tab21/  4000.0d0, 0.0d0, 5000.0d0, 3.0d0,10000.d0, 4.0d0,            
     & 1.e20, 5.0d0/                                                            
      data tab22/  5000.0d0, 0.0d0, 10000.d0, 4.0d0, 1.e20, 5.0d0/              
                                                                                
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)                                           
     &  phas92=100000.*aif92(law)/sep                                           
      if(law.ge.2013)                                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c AGI                                                                           
      halfse =.5*comnew(175)                                                    
      if(law.eq.2011.or.law.eq.2012) then                                       
c 2011 and 2012 have 5.65% instead of 7.65%                                     
          if(comnew(175).le.14204.) then                                        
           halfse = .5751*comnew(175)                                           
          else                                                                  
           halfse = .5*comnew(175) + 1067                                       
          endif                                                                 
      endif                                                                     
      agi=comnew(2)+divexc(data,comnew,law)+ halfse                             
      if(law.eq.2017) agi = agi - .17*comnew(175)                               
      if(law.eq.2018) agi = agi - .34*comnew(175)                               
      if(law.ge.2019) agi = agi - .5*comnew(175)                                
c Generally, retirement income, pensions, annuities are not subject to MS Income
c if recipient has met the retirement plan requirements.                        
c Early distributions are not considered retirement income and may be subject to
      retiry = 0.                                                               
c     if(data(9).gt.0) retiry = data(20) + data(72)                             
      retiry = data(20) + data(72)                                              
      if(law.le.1978) retiry = retiry + comnew(84)                              
      if(law.le.1989) then                                                      
        agi=agi-min(retiry,5000.*data(7))                                       
      else if(law.ge.1990.and.law.le.1993) then                                 
        agi=agi-min(retiry,6000.*data(7))                                       
      else if(law.ge.1994) then                                                 
        agi=agi-retiry                                                          
      endif                                                                     
      if(law.le.1978) agi=agi+data(62)-data(23)+data(26)                        
      if(law.le.1979) agi=agi+comnew(12)+comnew(14)+data(30)                    
      agi = agi - data(22)                                                      
      if(law.ge.1982.and.law.le.1986) agi=agi+comnew(32)                        
c SS benefits and pensions are not taxable in MS                                
      if(law.ge.1984)agi=agi-comnew(79)                                         
c 2020 CARES Act                                                                
      if(law.eq.2020) then                                                      
         agi = agi + data(82) - comnew(78)                                      
         if(comnew(26).lt.1.d0) agi = agi + min(300.d0,data(58))                
      endif                                                                     
c Exemptions                                                                    
      if(mst.ne.1) then                                                         
        exemp = xmp(law,2)                                                      
        if(mst.eq.4.or.mst.eq.7)exemp = 8000.                                   
      else                                                                      
        exemp = xmp(law,1)                                                      
      endif                                                                     
      exemp = exemp+(data(8)*dep(law))+((data(9)+data(10))*old(law))            
      if(sep.eq.2) exemp = exemp/2                                              
c Standard deduction                                                            
      txp = data(7)                                                             
      if(law.le.1978)stded = min(750.*txp,.15*max(0.0d0,agi))                   
      if(law.eq.1979)stded = min(1500.*txp,.15*max(0.0d0,agi))                  
      if(law.ge.1980)then                                                       
        stded = 2300.d0                                                         
        if(mst.ne.1) stded = 3400.d0/sep                                        
        if(law.eq.1998.and.(mst.eq.2.or.sep.eq.2)) stded = 4200.d0/sep          
        if(law.ge.1999.and.(mst.eq.2.or.sep.eq.2)) stded = 4600.d0/sep          
      endif                                                                     
c Itemized Deduction                                                            
c State Income Taxes have not been deductible on MS itemized deductions Sched   
c since 1992                                                                    
      if(law.lt.1991) then                                                      
        xitded = comnew(30)                                                     
      else                                                                      
        xitded = max(0.d0,comnew(30)-data(50))                                  
        if(agi.gt.phas92.and.comnew(30).gt.0.and.law.le.2017)                   
     &   xitded = max(0.d0,comnew(30)-comnew(34) -                              
     &   (data(50) - data(50)*comnew(34)/comnew(30)))                           
      endif                                                                     
      if(law.le.1978) then                                                      
        taxded = data(55)+data(52)                                              
        contri = data(58)+data(59)+data(60)-(.2*max(0.0d0,agi))                 
        edical = comnew(20)-max(data(47)+data(48)+data(49)-2000.,0.0d0)         
        xitded = max(0.d0,xitded-taxded-contri-edical)                          
      endif                                                                     
c Tax Calculation                                                               
      ided = int(data(4))                                                            
      if(ided.eq.-2.and.law.eq.1999) xitded=0                                   
      deduc=max(stded,xitded)                                                   
      taxinc=max(agi-deduc-exemp,0.0d0)                                         
c      write(0,*) 'agi deduc exemp',agi,deduc,exemp                             
      if(law.le.1982)                                                           
     &call look(tab77,taxinc,2,n,statax,1.d0,0.0d0,rt,data)                     
      if(law.ge.1983.and.law.le.2017)                                           
     &call look(tab83,taxinc,3,n,statax,1.d0,0.0d0,rt,data)                     
      if(law.eq.2018)                                                           
     &call look(tab18,taxinc,4,n,statax,1.d0,0.0d0,rt,data)                     
      if(law.eq.2019)                                                           
     &call look(tab19,taxinc,4,n,statax,1.d0,0.0d0,rt,data)                     
      if(law.eq.2020)                                                           
     &call look(tab20,taxinc,4,n,statax,1.d0,0.0d0,rt,data)                     
      if(law.eq.2021)                                                           
     &call look(tab21,taxinc,4,n,statax,1.d0,0.0d0,rt,data)                     
      if(law.ge.2022)                                                           
     &call look(tab22,taxinc,3,n,statax,1.d0,0.0d0,rt,data)                     
c      write(0,*) 'taxinc statax',taxinc,statax                                 
      if(mst.eq.2.and.agi.gt.0) then                                            
c for separate returns , filed combined                                         
         agih = min(agi,max(data(85),data(86)) + (agi-data(11))/2.)             
         agiw = agi - agih                                                      
         exemph=exemp*agih/agi                                                  
         exempw=exemp-exemph                                                    
         taxyh1 = max(agih-exemph,0.0d0)                                        
         taxyw1 = max(agiw-exempw,0.0d0)                                        
         deducw = min(taxyw1,deduc*agiw/agi)                                    
         deduch = deduc-deducw                                                  
         taxyh=max(0.0d0,taxyh1-deduch)                                         
         taxyw=max(0.0d0,taxyw1-deducw)                                         
         if(law.le.1982) then                                                   
            call look2(tab77,taxyh,2,n,taxh,1.0d00,0.0d0,rt,data)               
            call look2(tab77,taxyw,2,n,taxw,1.0d00,0.0d0,rt,data)               
         else if(law.ge.1983.and.law.le.2017) then                              
            call look2(tab83,taxyh,3,n,taxh,1.0d00,0.0d0,rt,data)               
            call look2(tab83,taxyw,3,n,taxw,1.0d00,0.0d0,rt,data)               
         else if(law.eq.2018) then                                              
            call look2(tab18,taxyh,4,n,taxh,1.0d00,0.0d0,rt,data)               
            call look2(tab18,taxyw,4,n,taxw,1.0d00,0.0d0,rt,data)               
         else if(law.eq.2019) then                                              
            call look2(tab19,taxyh,4,n,taxh,1.0d00,0.0d0,rt,data)               
            call look2(tab19,taxyw,4,n,taxw,1.0d00,0.0d0,rt,data)               
         else if(law.eq.2020) then                                              
            call look2(tab20,taxyh,4,n,taxh,1.0d00,0.0d0,rt,data)               
            call look2(tab20,taxyw,4,n,taxw,1.0d00,0.0d0,rt,data)               
         else if(law.eq.2021) then                                              
            call look2(tab21,taxyh,4,n,taxh,1.0d00,0.0d0,rt,data)               
            call look2(tab21,taxyw,4,n,taxw,1.0d00,0.0d0,rt,data)               
         else if(law.ge.2022) then                                              
            call look2(tab22,taxyh,3,n,taxh,1.0d00,0.0d0,rt,data)               
            call look2(tab22,taxyw,3,n,taxw,1.0d00,0.0d0,rt,data)               
                                                                                
         endif                                                                  
         statax = min(statax,taxh+taxw)                                         
      endif                                                                     
      return                                                                    
      end                                                                       
c  MISSOURI                                                                     
c  State 26                                                                     
c                                                                               
c  Status: Updated through 2021 (03-15-2022)                                    
      subroutine motax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/times/zitem,ptax,txrate,h                                          
      dimension data(255), comnew(255)                                          
      dimension aif92(1991:2012),aif13(2013:2017),aift(2017:2021)               
      dimension ymax(1977:2021),pmax(1977:2021),ss(1977:2021),                  
     & addm (1977:2021),perc(2007:2021),ssmax(2007:2021)                        
      double precision  motab19(2,9), motab(2,10),magi                          
      integer sep                                                               
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data perc/.2d0,.35d0,.5d0,.65d0,.8d0,10*1.0d0/                            
c ssmax from MO-A part3 section A line 7                                        
      data ssmax/ 32500.d0,3*33703.d0,34141.d0,35234.d0,                        
     &            35939.d0,36442.d0,2*36976.d0,37089.d0,                        
     &            37720.d0,38437.d0,39014.d0,39365.d0/                          
      data aif92/                                                               
     &         1.0d0, 1.0525d0, 1.0845d0, 1.118d0,  1.147d0 ,                   
     &     1.17950d0, 1.2120d0, 1.2450d0, 1.266d0,  1.2895d0,                   
     &     1.32950d0, 1.3730d0, 1.3950d0, 1.427d0,  1.4595d0,                   
     &     1.5050d0 , 1.5640d0, 1.5995d0, 1.668d0,2*1.6955d0,                   
     &     1.7365d0/                                                            
      data motab /  1000.d0, 1.5d0,  2000.d0, 2.d0 ,  3000.d0,                  
     & 2.5d0,  4000.d0, 3.d0, 5000.d0, 3.5d0, 6000.d0, 4.d0,                    
     & 7000.d0, 4.5d0,  8000.d0, 5.d0,   9000.d0, 5.5d0,                        
     &  1.e20, 6.00/                                                            
      data motab19 /  1000.d0, 1.5d0,  2000.d0, 2.d0 ,  3000.d0,                
     & 2.5d0,  4000.d0, 3.d0, 5000.d0, 3.5d0, 6000.d0, 4.d0,                    
     & 7000.d0, 4.5d0,  8000.d0, 5.d0,   1.e20, 5.4d0/                          
      data ss/    965.d0, 1071.d0,  1404.d0, 1588.d0, 1975.d0,                  
     &           2170.d0, 2391.d0,  2533.d0, 2791.d0, 3003.d0,                  
     &           3132.d0, 3380.d0,  3605.d0, 3925.d0, 5123.d0,                  
     &           3411.d0, 3571.d0,  3757.d0, 3794.d0, 3887.d0,                  
     &           4055.d0, 4241.d0,  4501.d0, 4724.d0, 4985.d0,                  
     &           5264.d0, 5394.d0,  5450.d0, 5580.d0, 5840.d0,                  
     &           6000.d0, 6324.d0,2*6621.6d0, 4486.d0,4624.d0,                  
     &           7049.d0, 7254.d0, 2*7347.d0, 7886.d0,7961.d0,                  
     &           8240.d0, 8537.d0,   8614.d0/                                   
      data addm/ 12*500.d0,   33*2000.d0/                                       
      data ymax/   5*8500.d0, 2*10000.d0,  11000.d0,   11500.d0,                
     &              12000.d0,   12500.d0,  13000.d0,   13500.d0,                
     &              14000.d0,   14500.d0,6*15000.d0,10*25000.d0,                
     &           11*27500.d0,   20000.d0,2* 27200.d0/                           
      data pmax/  8*500.d0,  37*750.d0/                                         
      data aift /1.008d0,1.028d0,1.053d0,1.073d0,1.088d0/                       
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rt=0.                                                                     
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)                                           
     &  phas92=100000.*aif92(law)/sep                                           
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c AGI                                                                           
c almost exactly federal definition of agi                                      
      agi=comnew(2)-data(22)                                                    
c Exemptions                                                                    
      ns=1                                                                      
      if(mst.eq.2.or.mst.eq.3.or.mst.eq.6)ns=2                                  
      if(mst.eq.5.and.data(8).ge.1)ns=3                                         
      if(mst.eq.4.or.mst.eq.7)ns=4                                              
      exemp=0.                                                                  
      if(ns.eq.1.or.ns.eq.2) then                                               
       if(law.le.1997) then                                                     
          exemp=data(7)*1200.d0 + data(8)*400.d0                                
       else if(law.eq.1998) then                                                
          exemp=data(7)*1200.d0 + data(8)*1200.d0                               
       else if(law.ge.1999.and.law.le.2017) then                                
          exemp=data(7)*2100.d0 + data(8)*1200.d0                               
       endif                                                                    
      elseif(ns.eq.3.or.ns.eq.4) then                                           
       if(law.le.1997) then                                                     
          exemp=2000.d0 + (data(8)*400.d0)                                      
       else if(law.eq.1998) then                                                
          exemp=2000.d0 + data(8)*1200.d0                                       
       else if(law.ge.1999.and.law.le.2017) then                                
          exemp=3500.d0 + data(8)*1200.d0                                       
       endif                                                                    
      endif                                                                     
      if(law.ge.2018) exemp = 0.d0                                              
c 2017 you qualify for an addit pers exemp of $500(for each qual spouse)        
      if(law.eq.2017.and.data(105).lt.1.d0) then                                
       if(mst.eq.2) then                                                        
c for separate returns, filed combined                                          
          agih = max(data(85),data(86)) + (agi-data(11))/2.                     
          agiw = agi-agih                                                       
          if(agih.lt.20000.d0) exemp = exemp + 500.                             
          if(agiw.lt.20000.d0) exemp = exemp + 500.                             
        else                                                                    
          if(agi.lt.20000.d0) exemp = exemp + 500.                              
        endif                                                                   
      endif                                                                     
c 2007+  Social Security Exemption                                              
      phase = 85000.                                                            
      if(mst.eq.2) phase = 100000.                                              
      if(law.ge.2007) then                                                      
         excess = max(0.0d0,agi - phase)                                        
         ssaxmp = max(0.0d0,perc(law)*comnew(79) - excess)                      
         exemp = exemp  + ssaxmp                                                
      endif                                                                     
      slim = 25000.                                                             
      if(mst.eq.2.or.mst.eq.5.or.mst.eq.3.or.mst.eq.6)                          
     & slim = 32000.d0/sep                                                      
c pension exemp if gov not private pension:assume it is public                  
      scred = 0.                                                                
      if(law.ge.1990.and.data(9).gt.0)then                                      
        magi=agi-comnew(79)                                                     
c MO AGI less federal taxable SSB and less a phaseout                           
        exc = max(0.0d0,magi-phase)                                             
c non-taxable ssb                                                               
        ssbnt = data(91)-comnew(79)                                             
c Taxable pensions from public sources                                          
        pension = data(20)+data(72)                                             
        if(law.le.1998) then                                                    
c we don't know the proportion for splitting pension income b/w h.& w.          
c         if(magi.le.slim)scred=min(1000.*data(7),pension)                      
          if(magi.le.slim)scred=min(1000.d0,pension)                            
        else if(law.ge.1999.and.law.le.2006) then                               
          if(magi - slim.le.6000.*data(7)) scred=min(6000.d0,pension)           
        else if(law.ge.2007) then                                               
          if(law.le.2008) then                                                  
c years 2007 - 2008                                                             
            xlin9 = min(perc(law)*pension,ssmax(law))                           
            xlin10 = max(0.0d0,xlin9 - ssbnt)                                   
            xlin11 = min(6000.0d0,pension)                                      
            xlin12 = max(xlin10,xlin11)                                         
            scred = max(0.0d0,xlin12 - exc)                                     
          else if (law.ge.2009.and.law.le.2013) then                            
c years 2009-2013                                                               
            xlin8 = min(ssmax(law),perc(law)*pension)                           
            xlin9 = min(6000.d0,pension)                                        
            xlin10 = max(xlin8,xlin9)                                           
            xlin12 = max(0.d0,xlin10 - ssaxmp)                                  
            scred = max(0.d0,xlin12 - exc)                                      
          else                                                                  
c years 2014 +                                                                  
            xlin7 = min(ssmax(law),pension)                                     
            xlin9 = max(0.d0,xlin7 - ssaxmp)                                    
            scred = max(0.d0,xlin9 - exc)                                       
          endif                                                                 
        endif                                                                   
        exemp=exemp+scred                                                       
      endif                                                                     
      if(data(105).gt.0.d0) exemp = 0.d0                                        
c Standard Deduction                                                            
      stded=comnew(3)                                                           
c Itemized Deductions                                                           
      if(comnew(26).gt.0.) then                                                 
c Fica is a deduction for MO                                                    
       xitded=max(0.d0,                                                         
     &comnew(30)+min(socsec(data,comnew,law),ss(law)*data(7))-data(50))         
c Self-employment tax                                                           
       septx=.5*comnew(175)                                                     
       if(law.eq.1993)septx=min(11058.*data(7),comnew(175))                     
       if(law.eq.2011.or.law.eq.2012) then                                      
c 2011&2012 has 5.65% instead of 7.65%                                          
          if(comnew(175).le.14204.) then                                        
           septx = .5751*comnew(175)                                            
          else                                                                  
           septx = .5*comnew(175) + 1067                                        
          endif                                                                 
       endif                                                                    
       xitded = max(0.d0,xitded - septx)                                        
c State Tax Declaration Phaseout                                                
       stax= data(50)                                                           
       if(law.ge.1993.and.law.le.2017) then                                     
        xlin4=max(0.0d0,data(49)-.075*comnew(2))                                
        xlin8=data(50)+data(51)+data(46)                                        
        xlin11=data(53)                                                         
        xlin12=data(56)+data(53)+data(57)                                       
        xlin16=data(58)+data(59)+data(60)                                       
        ag = max(0.0d0,comnew(2))                                               
        xlin17=max(0.0d0,data(61)-.1*ag)                                        
        xlin18=data(26)                                                         
        xlin24=max(data(27)+data(63)-.02*ag,0.0d0)                              
        xlin25=data(66)                                                         
        xtot=xlin4+xlin8+xlin12+xlin16+xlin17+xlin18+xlin24+                    
     &   xlin25                                                                 
        xdiff=xtot-xlin4-xlin11-xlin17                                          
        if(xdiff.gt.0.) then                                                    
          xdiff2=comnew(2)-phas92                                               
          if(xdiff2.gt.0.) then                                                 
            xconst=min(.8*xdiff,.03*xdiff2)                                     
            xlin26=xtot-xconst                                                  
            xprop=(xdiff-(xtot-xlin26))/xdiff                                   
            stax=xprop*stax                                                     
          endif                                                                 
        endif                                                                   
       endif                                                                    
       xitded=max(0.d0,xitded - comnew(34) + (data(50)-stax))                   
       ided = int(data(4))                                                           
       if(law.eq.1999.and.ided.eq.-2) xitded=0                                  
       deduc=max(stded,xitded)                                                  
      else                                                                      
        deduc = stded                                                           
      endif                                                                     
c  extra federal tax deductions for non- and itemezers                          
c  subtract other taxes because they are included in comnew(1);                 
c  don't want to double count for itemizers                                     
      if(law.ne.2021) then                                                      
        fedtax=max(0.0d0,comnew(52)-comnew(53)-comnew(54)-data(34)-             
     &  comnew(59)-comnew(81)-comnew(94))                                       
      else                                                                      
        fedtax=max(0.0d0,comnew(52)-comnew(54)-data(34)-comnew(94))             
      endif                                                                     
      if(law.ge.1994.and.law.le.2018)fedtax=min(fedtax,5000*data(7))            
c 2019+ tax year, the federal tax deduction is multiplied by a percentage, based
      if(law.ge.2019) then                                                      
        if(agi.le.25000.d0) then                                                
          rtf = .35d0                                                           
        else if(agi.le.50000.d0) then                                           
          rtf = .25d0                                                           
        else if(agi.le.100000.d0) then                                          
          rtf = .15d0                                                           
        else if(agi.le.125000.d0) then                                          
          rtf = .05d0                                                           
        else                                                                    
          rtf = 0.d0                                                            
        endif                                                                   
        fedtax = rtf*fedtax                                                     
      endif                                                                     
c      write(0,*) 'fedtax agi deduc exemp',fedtax,agi,deduc,exemp               
      deduc=deduc+fedtax                                                        
      taxinc=max(0.0d0,agi-deduc-exemp)                                         
c      write(0,*) 'taxinc',taxinc                                               
                                                                                
      aif = 1.                                                                  
      if(law.ge.2017) aif = aift(law)                                           
      if(law.eq.2018) motab(2,10) = 5.9d0                                       
      if(law.le.2018)                                                           
     & call look(motab,taxinc,10,n,statax,aif,0.0d0,rt,data)                    
      if(law.ge.2019)                                                           
     & call look(motab19,taxinc,9,n,statax,aif,0.0d0,rt,data)                   
      if(mst.eq.2) then                                                         
c for separate returns, filed combined                                          
        agih = max(data(85),data(86)) + (agi-data(11))/2.                       
        agiw = agi-agih                                                         
        if(agi.gt.0) then                                                       
          taxyh = taxinc*agih/agi                                               
          taxyw = taxinc*agiw/agi                                               
          if(law.le.2018) then                                                  
            call look2(motab,taxyh,10,n,taxh,aif,0.0d0,rt,data)                 
            call look2(motab,taxyw,10,n,taxw,aif,0.0d0,rt,data)                 
          else                                                                  
            call look2(motab19,taxyh,9,n,taxh,aif,0.0d0,rt,data)                
            call look2(motab19,taxyw,9,n,taxw,aif,0.0d0,rt,data)                
          endif                                                                 
          statax= min(statax,taxh+taxw)                                         
        endif                                                                   
      endif                                                                     
      if(taxinc.lt.100*aif) statax = 0.                                         
c Property tax credit                                                           
      pcred=0.                                                                  
      ded = 0.                                                                  
      hy1=data(159)                                                             
c married people have preferences                                               
      if(mst.eq.2) then                                                         
       if(law.le.2007) hy1 = max(0.0d0,hy1-addm(law))                           
       if(law.ge.2008.and.data(51).gt.0.) hy1 = max(0.0d0,hy1-4000.)            
       if(law.ge.2008.and.data(160).gt.0.)hy1 = max(0.0d0,hy1-addm(law))        
      endif                                                                     
      if(law.le.1997) then                                                      
        number = 45                                                             
        base = 4300.                                                            
      elseif(law.ge.1998.and.law.le.2007) then                                  
        number = 40                                                             
        base = 13000.                                                           
      else if(law.ge.2008) then                                                 
        number = 45                                                             
        base = 14300.                                                           
      endif                                                                     
      ymax1 = ymax(law)                                                         
      pmax1 = pmax(law)                                                         
      if(law.ge.2008.and.data(51).gt.0.) then                                   
c owners have preferences since 2008                                            
        ymax1 = 30000.                                                          
        pmax1 = 1100.                                                           
        number = 54                                                             
      endif                                                                     
c                                                                               
      ptax=min(data(51)+.2*data(160),pmax(law))                                 
      if(data(9).gt.0..and.hy1.lt.ymax1.and.ptax.gt.0) then                     
         if(hy1.le.base) then                                                   
           pcred = pmax1                                                        
         else                                                                   
           do 70 i=1,number                                                     
             if(law.ge.1998) then                                               
               base = base + 300                                                
             else                                                               
               base = base + 200                                                
             endif                                                              
             if(i.eq.number) base = ymax1                                       
             if(base.le.hy1) then                                               
                 ded = hy1 * .0625*(i+1)/100                                    
                 pcred = max(0.0d0,pmax1 - ded)                                 
             endif                                                              
70         continue                                                             
         endif                                                                  
      endif                                                                     
      if(law.le.1978) pcred=min(pcred,statax)                                   
      credit = pcred                                                            
c  changed for new accounting of prop tax                                       
      statax = statax-credit                                                    
      return                                                                    
      end                                                                       
c  MONTANA                                                                      
c  State 27                                                                     
                                                                                
c  Updated through 2021 (03/15/2022)                                            
      subroutine mttax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/times/zitem,ptax,txrate,h                                          
      dimension data(255),comnew(255),ptab(2,6)                                 
      dimension aif(1977:2004),xmp(1977:2021),surtax(1977:2021),ccr(3)          
      dimension tab(2,10),tbase(2,10),st(1977:2021)                             
      dimension tabs(9,1990:2004)                                               
      dimension tabt1(6,2005:2021),tabt(2,7)                                    
     &,aifret(2010:2021),eicr(2019:2021)                                        
      dimension aif92(1991:2012),tabred(2,12),aif13(2013:2017)                  
      double precision minst(1996:2021)                                         
      integer sep                                                               
      data eicr/3*.03d0/                                                        
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data aifret/                                                              
     &     1.01111d0, 1.04444d0,  1.06388889d0, 1.083d0,2*1.106d0,              
     &     1.1306d0 , 1.1417d0,   1.16111111d0, 1.193d0,1.2139d0,               
     &     1.2222d0/                                                            
      data tabred /                                                             
     &      1999.d0, 0.d0  ,  2999.d0,  .006d0, 3999.d0, .016d0,                
     &      4999.d0, .024d0,  5999.d0,  .028d0, 6999.d0, .032d0,                
     &      7999.d0, .035d0,  8999.d0,  .039d0, 9999.d0, .042d0,                
     &     10999.d0, .045d0, 11999.d0,  .048d0,    1.e20, .05d0/                
                                                                                
      data tabt/0.d0,1.d0,0.d0,2.d0,0.d0,3.d0,0.d0,4.d0,0.d0,5.d0,              
     & 0.d0,6.d0,1.e20,6.9d0/                                                   
      data tabt1 /                                                              
     5 2300.d0,4100.d0,6200.d0, 8400.d0,10800.d0,13900.d0,                      
     6 2400.d0,4300.d0,6500.d0, 8800.d0,11300.d0,14600.d0,                      
     7 2500.d0,4400.d0,6600.d0, 9000.d0,11600.d0,14900.d0,                      
     8 2600.d0,4600.d0,7000.d0, 9500.d0,12200.d0,15600.d0,                      
     9 2600.d0,4500.d0,6900.d0, 9300.d0,12000.d0,15400.d0,                      
     & 2600.d0,4600.d0,6900.d0, 9400.d0,12100.d0,15600.d0,                      
     1 2700.d0,4700.d0,7200.d0, 9700.d0,12500.d0,16000.d0,                      
     2 2700.d0,4800.d0,7300.d0, 9900.d0,12700.d0,16400.d0,                      
     3 2800.d0,4900.d0,7400.d0,10100.d0,13000.d0,16700.d0,                      
     4 2800.d0,5000.d0,7600.d0,10300.d0,13300.d0,17100.d0,                      
     5 2800.d0,5000.d0,7600.d0,10300.d0,13300.d0,17100.d0,                      
     6 2900.d0,5100.d0,7800.d0,10500.d0,13500.d0,17400.d0,                      
     7 2900.d0,5200.d0,7900.d0,10600.d0,13600.d0,17600.d0,                      
     8 3000.d0,5200.d0,8000.d0,10800.d0,13900.d0,17900.d0,                      
     9 3100.d0,5400.d0,8200.d0,11100.d0,14300.d0,18400.d0,                      
     & 3100.d0,5500.d0,8400.d0,11300.d0,14500.d0,18700.d0,                      
     1 3100.d0,5500.d0,8400.d0,11400.d0,14600.d0,18800.d0/                      
      data aif92/                                                               
     &       1.0d0,  1.0525d0, 1.0845d0, 1.118d0 , 1.147d0 , 1.1795d0,          
     &     1.212d0,  1.2450d0, 1.2660d0, 1.2895d0, 1.3295d0, 1.3730d0,          
     &     1.395d0,  1.4270d0, 1.4595d0, 1.5050d0, 1.5640d0, 1.5995d0,          
     &     1.668d0,2*1.6955d0, 1.7365d0/                                        
      data tbase /                                                              
     &      1000.0d0,  2.0d0,  2000.0d0,  3.0d0, 4000.0d0,  4.0d0,              
     &      6000.0d0,  5.0d0,  8000.0d0,  6.0d0,10000.0d0,  7.0d0,              
     &     14000.0d0,  8.0d0, 20000.0d0,  9.0d0,35000.0d0, 10.0d0,              
     &         1.e20, 11.0d0/                                                   
      data tabs/                                                                
     &  1600.d0, 3100.d0,6300.d0, 9400.d0,12600.d0,15700.d0,22000.d0,           
     & 31400.d0,55000.d0,                                                       
     &  1600.d0, 3300.d0,6600.d0, 9900.d0,13200.d0,16400.d0,23000.d0,           
     & 32900.d0,57600.d0,                                                       
     &  1700.d0, 3400.d0,6800.d0,10200.d0,13600.d0,17000.d0,23700.d0,           
     & 33900.d0,59400.d0,                                                       
     &  1700.d0, 3500.d0,7000.d0,10500.d0,14000.d0,17500.d0,24400.d0,           
     & 34900.d0,61100.d0,                                                       
     &      1800.0d0,  3600.0d0,  7200.0d0, 10700.0d0, 14300.0d0,               
     &     17900.0d0, 25100.0d0, 35800.0d0, 62700.0d0,                          
     &      1800.0d0,  3700.0d0,  7400.0d0, 11100.0d0, 14800.0d0,               
     &     18400.0d0, 25800.0d0, 36900.0d0, 64600.0d0,                          
     &      1900.0d0,  3800.0d0,  7600.0d0, 11400.0d0, 15200.0d0,               
     &     19000.0d0, 26500.0d0, 37900.0d0, 66400.0d0,                          
     &      1900.0d0,  3900.0d0,  7800.0d0, 11600.0d0, 15500.0d0,               
     &     19400.0d0, 27200.0d0, 38800.0d0, 67900.0d0,                          
     &      2000.0d0,  3900.0d0,  7900.0d0, 11800.0d0, 15800.0d0,               
     &     19700.0d0, 27600.0d0, 39400.0d0, 69000.0d0,                          
     &      2000.0d0,  4000.0d0,  8000.0d0, 12100.0d0, 16100.0d0,               
     &     20100.0d0, 28200.0d0, 40200.0d0, 70400.0d0,                          
     &      2100.0d0,  4200.0d0,  8300.0d0, 12500.0d0, 16700.0d0,               
     &     20800.0d0, 29200.0d0, 41700.0d0, 73000.0d0,                          
     &      2200.0d0,  4300.0d0,  8600.0d0, 12900.0d0, 17200.0d0,               
     &     21500.0d0, 30200.0d0, 43100.0d0, 75400.0d0,                          
     &      2200.0d0,  4400.0d0,  8700.0d0, 13100.0d0, 17400.0d0,               
     &     21800.0d0, 30500.0d0, 43500.0d0, 76200.0d0,                          
     &      2200.0d0,  4400.0d0,  8900.0d0, 13300.0d0, 17800.0d0,               
     &     22200.0d0, 31100.0d0, 44500.0d0, 77800.0d0,                          
     &      2300.0d0,  4600.0d0,  9200.0d0, 13800.0d0, 18400.0d0,               
     &     22900.0d0, 32100.0d0, 45900.0d0, 80300.0d0/                          
      data xmp/                                                                 
     &         2*650.0d0,  1050.0d0, 1250.0d0,  752.0d0,  940.0d0,              
     &           960.0d0,  1000.0d0, 1040.0d0, 1060.0d0, 1100.0d0,              
     &          1140.0d0,  1200.0d0, 1260.0d0, 1320.0d0, 1360.0d0,              
     &          1400.0d0,  1430.0d0, 1480.0d0, 1520.0d0, 1550.0d0,              
     &          1580.0d0,  1610.0d0, 1670.0d0, 1720.0d0, 1740.0d0,              
     &          1780.0d0,  1840.0d0, 1900.0d0, 1980.0d0, 2040.0d0,              
     &          2140.0d0,  2110.0d0, 2130.0d0, 2190.0d0, 2240.0d0,              
     &          2280.0d0,2*2330.0d0, 2380.0d0, 2400.0d0, 2440.0d0,              
     &          2510.0d0,  2560.0d0, 2580.0d0 /                                 
      data st/                                                                  
     &         2*500.0d0,2*1000.0d0, 1640.0d0, 1760.0d0, 1800.0d0,              
     &          1880.0d0,  1950.0d0, 1990.0d0, 2060.0d0, 2140.0d0,              
     &          2250.0d0,  2360.0d0, 2470.0d0, 2540.0d0, 2620.0d0,              
     &          2770.0d0,  2840.0d0, 2910.0d0, 2960.0d0, 3020.0d0,              
     &          3130.0d0,  3230.0d0, 3260.0d0, 3330.0d0, 3440.0d0,              
     &          3560.0d0,  3710.0d0, 3810.0d0, 4010.0d0, 3950.0d0,              
     &          3990.0d0,2*4110.0d0, 4200.0d0, 4270.0d0,2*4370.0d0,             
     &          4460.0d0,  4510.0d0, 4580.0d0, 4710.0d0,  4790.0d0,             
     &          4830.0d0/                                                       
      data minst/                                                               
     &        2*1260.0d0,  1310.0d0, 1340.0d0, 1390.0d0, 1430.0d0,              
     &          1450.0d0,  1480.0d0, 1530.0d0, 1580.0d0, 1650.0d0,              
     &          1690.0d0,  1780.0d0, 1750.0d0, 1770.0d0, 1820.0d0,              
     &          1860.0d0,  1900.0d0,2*1940.0d0,1980.0d0, 2000.0d0,              
     &          2030.0d0,  2090.0d0,2*2130.0d0/                                 
      data ptab/35000.d0, 1.d0, 37500.d0,  .4d0,  40000.d0, .3d0,               
     &          42500.d0, .2d0, 44999.d0,  .1d0,     1.e20,0.d0/                
      data aif/ 4*1.0d0, 1.1d0 , 1.17d0, 1.2d0, 1.25d0, 2*1.3d0,                
     &          1.37d0, 1.43d0, 1.50d0, 15*1.0d0/                               
      data surtax/4*1.1d0, 6*1.0d0  , 2*1.1d0, 1.0d0,1.05d0,1.0d0,              
     &          1.023d0,   1.047d0,28*1.0d0/                                    
      data ccr/2400.0d0,3600.0d0,4800.0d0/                                      
c indexing covers brackets,exemptions and standard deduction.                   
      rt = 0.                                                                   
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)                                           
     &  phas92=100000.*aif92(law)/sep                                           
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c AGI                                                                           
      agi = comnew(2)                                                           
c 2020 CARES Act unemployment                                                   
      if(law.eq.2020) then                                                      
         agi = agi + data(82) - comnew(78)                                      
      endif                                                                     
c subtr - Montana subtractions                                                  
      subtr = 0.d0                                                              
c Reductions of Income                                                          
c State refund                                                                  
      agi = agi-data(22)                                                        
      subtr = subtr + data(22)                                                  
c Reduction of Income : 40% of capital gains(an installment sale(s) only)       
      if(law.ge.1987.and.law.le.2002) then                                      
         agi = agi-.4*max(.0d0,comnew(6))                                       
         subtr = subtr + .4*max(.0d0,comnew(6))                                 
      endif                                                                     
c Adjustments decreasing income                                                 
c each taxpayer can deduct up to r360 of annuity, pension and so on.            
      if(law.ge.1981.and.law.le.1986) then                                      
         agi=agi-min(360.0d0,data(72))                                          
         subtr = subtr + min(360.0d0,data(72))                                  
      endif                                                                     
c For aged people there is an exclusion up to $800 of interest income           
      excint = 0.                                                               
      if(law.ge.1981) excint=min(data(14),800*data(9))                          
      agi = agi - excint                                                        
      subtr = subtr + excint                                                    
c Exempt Retirement Income                                                      
c The 1991 legislature changed the taxability of all retirement income          
      if(law.ge.1991.and.data(9).gt.0) then                                     
         retexc = 0.                                                            
         retmax = min(3600.0d0,data(20)+data(72))                               
         agiret = 30000.                                                        
         delta = 1800*data(7)                                                   
         if(law.ge.2010) then                                                   
           retmax = min(3600*data(9)*aifret(law),data(20)+data(72))             
           delta = delta * aifret(law)                                          
           agiret = agiret * aifret(law)                                        
         endif                                                                  
c        write(0,*) 'retmax delta agiret',retmax,delta,agiret                   
         xl3 = min(delta,(data(20)+data(72))/data(9))                           
         xl6 = 2*max(0.d0,comnew(2)/data(9) - agiret)                           
c        write(0,*) 'xl3 xl6',xl3,xl6                                           
         retexc = data(9)*max(0.d0,xl3 - xl6)                                   
         if(comnew(2)/data(9).lt.agiret + delta) then                           
            if(comnew(2)/data(9).lt.agiret) then                                
               retexc = retmax                                                  
            else                                                                
               retexc = max(0.0d0,retmax-2*(comnew(2) - agiret))                
            endif                                                               
         endif                                                                  
         agi = max(0.0d0,agi - retexc)                                          
c        write(0,*) 'agi retexc',agi,retexc                                     
         subtr = subtr + retexc                                                 
      endif                                                                     
c Unemployment benefits are not taxable to Montana                              
      if(law.ge.1984)agi = agi-data(82)                                         
c      write(0,*) 'agi after unempl',agi                                        
      subtr = subtr + data(82)                                                  
c Additions to Income                                                           
c Filing separately returns can't claim the marriage deduction.                 
c So this federal deduction becomes an addition to the Montana AGI              
      if(law.ge.1983.and.law.le.1986.and.sep.eq.2) agi = agi+comnew(32)         
c Capital Loss for filing separately                                            
      if(law.ge.1984.and.sep.eq.2.and.comnew(5).lt.0.) then                     
        caplss = max(-1500.d0,comnew(5))                                        
        agi = agi + caplss                                                      
      endif                                                                     
c  social security benefits are taxed on a different agi base                   
      ssagi=0.                                                                  
      ssb = data(91)                                                            
      if(law.ge.1984.and.ssb.gt.0) then                                         
        xl6 = .5*ssb+comnew(2)-comnew(79)+data(41)                              
        xl8 = subtr + comnew(17) - data(156)                                    
c      write(0,*) 'xl6 xl8',xl6,xl8                                             
        if(xl8.le.xl6) then                                                     
          xl9 = xl6 - xl8                                                       
          if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                             
              ssexem=25000.                                                     
              xl12 = 9000.                                                      
          else                                                                  
              ssexem = 32000.d0/sep                                             
              xl12 = 12000.d0/sep                                               
          endif                                                                 
          xl11 = xl9 - ssexem                                                   
          xl13 = max(0.0d0,xl11 - xl12)                                         
          xl14 = min(xl11,xl12)                                                 
          xl15 = .5*xl14                                                        
          xl16 = min(.5*ssb,xl15)                                               
          xl17 = .85*xl13                                                       
          xl18 = xl16+xl17                                                      
          ssagi = min(xl18,.85*ssb)                                             
c        write(0,*) 'xl17 xl18 ssagi',xl17,xl18,ssagi                           
        endif                                                                   
      endif                                                                     
      agi = agi - comnew(79) + ssagi                                            
c      write(0,*) 'agi c79 ssagi',agi,comnew(79),ssagi                          
      subtr = subtr + comnew(79) - ssagi                                        
c Standard Deduction                                                            
c indexed to inflation, but not in the same way as the brackets                 
      txp = data(7)                                                             
      if(mst.eq.4.or.mst.eq.7) txp = 2                                          
      if(law.le.1978) stded = min(500.*txp,.1*max(.0d0,agi))                    
      if(law.eq.1979.or.law.eq.1980)                                            
     & stded=min(1000.*txp,.15*max(.0d0,agi))                                   
      if(law.ge.1981) stded = min(st(law)*txp,.2*max(.0d0,agi))                 
      if(law.ge.1996) stded = max(minst(law)*txp,stded)                         
c Itemized Deduction                                                            
      xitded=max(0.d0,comnew(30)-data(50))                                      
      if(law.le.2004) then                                                      
        xitded=xitded+max(.0d0,comnew(1))                                       
      else                                                                      
c 2005+ - Federal Income Tax Deduction Limitation                               
        if(law.ne.2008)                                                         
     &   xitded=xitded+min(5000.*data(7),max(0.0d0,comnew(1)))                  
c 2008 is different because of Federal Economic Stimulus Package                
       if(law.eq.2008)                                                          
     &   xitded=xitded+min(5000.*data(7),                                       
     &    max(0.0d0,comnew(1)-600*data(7)-300*data(8)))                         
      endif                                                                     
      if(agi.gt.phas92.and.(law.ge.1991.and.law.le.2017)) then                  
          xitemp = comnew(30)-data(50)                                          
          reduce = min(.8*xitemp,.03*(agi-phas92))                              
          if(law.eq.2006.or.law.eq.2007) reduce = 2*reduce/3                    
          if(law.eq.2008.or.law.eq.2009) reduce = reduce/3                      
          if(law.eq.2010.and.law.le.2012) reduce = 0.d0                         
          xitded = xitded-reduce 
      endif                                                                     
                                                                                
c child care expense goes under itemized deduction                              
      ich=0                                                                     
      chexp=0.                                                                  
      if(data(8).gt.0) then                                                     
        ich=int(twn(data(8),1.0d0,3.0d0))                                            
        chexp=min(data(64),ccr(ich))                                            
        chexp=max(0.0d0,chexp-.5*max(0.0d0,agi-18000.))                         
      endif                                                                     
      xitded=xitded+chexp                                                       
c            write(0,*) '3 xitded',xitded                                       
                                                                                
      ided = int(data(4))                                                            
      if(ided.eq.-2.and.law.eq.1999) xitded=0                                   
      deduc=max(stded,xitded)                                                   
                                                                                
c Tax Calculation                                                               
c blindness and age exemptions apply to all years                               
      exemp=(data(7)+data(8)+data(9)+data(10))*xmp(law)                         
      taxinc=max(0.0d0,agi-deduc-exemp)                                         
c      write(0,*) 'agi deduc exemp taxinc',agi,deduc,exemp,taxinc               
      if(law.le.2004) then                                                      
        do 999 i = 1,10                                                         
        do 998 j = 1,2                                                          
          tab(j,i) = tbase(j,i)                                                 
998     continue                                                                
999     continue                                                                
      endif                                                                     
      if(law.ge.1990.and.law.le.2004) then                                      
       do 1000 i=1,9                                                            
       tab(1,i)=tabs(i,law)                                                     
1000   continue                                                                 
      else if(law.ge.2005) then                                                 
       do 1001 i=1,6                                                            
       tabt(1,i) = tabt1(i,law)                                                 
1001   continue                                                                 
      endif                                                                     
      if(law.le.2004) then                                                      
        call look(tab,taxinc,10,n,statax,aif(law),0.0d0,rt,data)                
      else                                                                      
        call look(tabt,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                   
      endif                                                                     
c      write(0,*) 'taxinc,statax',taxinc,statax                                 
                                                                                
      if(mst.eq.2) then                                                         
c for separate returns , filed combined                                         
c       agih = max(data(85),data(86))+ (agi-ssagi-data(11))/2 + ssagih          
c       agiw = agi-agih                                                         
       agih = max(data(85),data(86)) + (agi-data(11))/2.                        
       agiw = agi-agih                                                          
       stdedw = 0                                                               
       stdedh = stded                                                           
       if(law.le.1978) then                                                     
         stdedh= min(500.0d0,.1*max(.0d0,agih))                                 
         stdedw= min(500.0d0,.1*max(.0d0,agiw))                                 
       else if(law.eq.1979.or.law.eq.1980) then                                 
         stdedh=min(1000.0d0,.15*max(.0d0,agih))                                
         stdedw=min(1000.0d0,.15*max(.0d0,agiw))                                
       else if(law.ge.1981) then                                                
         stdh = min(st(law),.2*max(.0d0,agih))                                  
         stdw = min(st(law),.2*max(.0d0,agiw))                                  
         if(law.ge.1996) then                                                   
            stdh = max(minst(law),stdh)                                         
            stdw = max(minst(law),stdw)                                         
         endif                                                                  
         stded = stdh + stdw                                                    
         stdedh = stdh                                                          
         stdedw = stdw                                                          
       endif                                                                    
       xitdh=0.                                                                 
       xitdw=0.                                                                 
       if(xitded.gt.0.and.agi.gt.0) then                                        
c         xitdh= xitded*agih/agi                                                
c         xitdw= xitded*agiw/agi                                                
         xitdh= .5*xitded                                                       
         xitdw= .5*xitded                                                       
       endif                                                                    
       dedh=stdedh                                                              
       dedw=stdedw                                                              
       if(xitded.gt.stded) then                                                 
         dedh=xitdh                                                             
         dedw=xitdw                                                             
       endif                                                                    
       exempw=xmp(law)                                                          
       if(data(9).gt.0.0d0) exempw=2*xmp(law)                                   
       exemph=exemp-exempw                                                      
c        if(agi.gt.0) then                                                      
c         exemph=exemp*agih/agi                                                 
c         exempw=exemp*agiw/agi                                                 
c        endif                                                                  
       taxyh=max(0.0d0,agih-dedh-exemph)                                        
       taxyw=max(0.0d0,agiw-dedw-exempw)                                        
       if(law.le.2004) then                                                     
         call look2(tab,taxyh,10,n,taxh,aif(law),0.0d0,rt,data)                 
         call look2(tab,taxyw,10,n,taxw,aif(law),0.0d0,rt,data)                 
       else                                                                     
         call look2(tabt,taxyh,7,n,taxh,1.0d0,0.0d0,rt,data)                    
         call look2(tabt,taxyw,7,n,taxw,1.0d0,0.0d0,rt,data)                    
       endif                                                                    
       statax=min(statax,taxh+taxw)                                             
      endif                                                                     
      statax=statax*surtax(law)                                                 
c Credits                                                                       
c Elderly Homeowner/Renter Credit                                               
      if(law.eq.1981) then                                                      
          ptax=max(data(51),.15*data(160))                                      
      else                                                                      
          ptax=data(51)+.15*data(160)                                           
      endif                                                                     
      pcred=0.                                                                  
      hy1 = 0.                                                                  
      if(data(9).gt.0) then                                                     
        if(law.ge.1981.and.law.lt.1983) then                                    
         pcred=min(max(ptax-hy*tablki(ptab,6,hy,data),0.0d0),150.0d0)           
        elseif(law.ge.1983) then                                                
         if(law.le.1997) then                                                   
            hy1 = max(0.d0,hy-4000.d0)                                          
         else                                                                   
            hy1 = max(0.d0,hy-6300.d0)                                          
         endif                                                                  
c prc1 -- Household Income Reduction Table                                      
         prc1 = tablki(tabred,12,hy1,data)                                      
         hynet = prc1*hy1                                                       
         if(law.le.1994) then                                                   
            pcred = min(400.d0,max(0.d0,ptax - hynet))                          
         else                                                                   
            pcred = min(1000.d0,max(0.d0,ptax - hynet))                         
c if hy>=35000,a person doesn't qualify for elderly/renter credit in 1998       
            if(law.eq.1998.and.hy.ge.35000) pcred = 0.                          
c prc2 -- Credit Multiplier Table 1999+                                         
            prc2 = tablki(ptab,6,hy,data)                                       
c if hy>=45000,a person doesn't qualify for elderly/renter credit in 1999+      
            if(law.ge.1999) pcred = prc2*pcred                                  
         endif                                                                  
        endif                                                                   
      endif                                                                     
c investment credit recapture                                                   
      if(law.le.1982)crinv=.2*data(33)                                          
      if(law.ge.1983)crinv=.05*data(33)                                         
c energy credit                                                                 
      ecred=data(38)                                                            
c 2005+ - Capital Gains Credit non-refundable                                   
      cgcred = 0.                                                               
      if(law.ge.2005.and.law.le.2006) cgcred = .01*max(0.0d0,comnew(6))         
      if(law.ge.2007) cgcred = .02*max(0.0d0,comnew(6))                         
c total non refundable credits                                                  
      credit=crinv+ecred+cgcred                                                 
c Total tax after credits                                                       
      statax=max(0.0d0,statax-credit)                                           
c 2007 Homeowner Income Tax credit for Property Taxes (refundable)              
      howcrd = 0.                                                               
      if(law.eq.2007.and.data(51).gt.0) howcrd = 140.                           
c 2019+ Montana EITC 3% of the federal EIC (refundable)                         
      earncr = 0.d0                                                             
      if(law.ge.2019) earncr = eicr(law)*comnew(59)                             
c total credit                                                                  
      credit = credit + pcred + howcrd + earncr                                 
c changed for new accounting of property tax credit                             
c property tax credit is refundable                                             
      statax = statax - pcred - howcrd - earncr                                 
c      if(statax.lt.1.) statax=0.                                               
      return                                                                    
      end                                                                       
c  State 28                                                                     
c  NEBRASKA                                                                     
c                                                                               
c   Updated through 2021 (updates 03.15.2022)                                   
      subroutine netax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      dimension rate(1977:1986),cred(1977:2021)                                 
      dimension xmp(1987:1992),arate(1977:2013),                                
     & st(3,2018:2021),addst(3,2018:2021)                                       
      dimension tabs(2,4), tabm(2,4), tabh(2,4), tabj(2,4)                      
      dimension tab87s(2,4), tab87m(2,4), tab87h(2,4), tab87j(2,4)              
      dimension tab89s(2,4), tab89m(2,4), tab89h(2,4), tab89j(2,4)              
      dimension tab90s(2,4), tab90m(2,4), tab90h(2,4), tab90j(2,4)              
      dimension tab91s(2,4), tab91m(2,4), tab91h(2,4), tab91j(2,4)              
      dimension tab93s(2,4),tab93j(2,4),tab93h(2,4)                             
      dimension tab98s(2,4),tab98j(2,4),tab98h(2,4)                             
      dimension tab03s(2,4),tab03j(2,4),tab03h(2,4)                             
      dimension tab06s(2,4),tab06j(2,4),tab06h(2,4)                             
      dimension tab07s(2,4),tab07j(2,4),tab07h(2,4)                             
      dimension tab13s(2,4),tab13j(2,4),tab13h(2,4)                             
      dimension tab14s(2,4),tab14j(2,4),tab14h(2,4)                             
c                                                                               
      dimension sabj(2,4),sabh(2,4),sabs(2,4)                                   
      dimension sab93j(4),sab93h(4),sab93s(4)                                   
      dimension sab94j(4),sab94h(4),sab94s(4)                                   
      dimension sab95j(4),sab95h(4),sab95s(4)                                   
      dimension sab96j(4),sab96h(4),sab96s(4)                                   
      dimension sab97j(4),sab97h(4),sab97s(4)                                   
      dimension sab98j(4),sab98h(4),sab98s(4)                                   
      dimension sab99j(4),sab99h(4),sab99s(4)                                   
      dimension sab00j(4),sab00h(4),sab00s(4)                                   
      dimension sab01j(4),sab01h(4),sab01s(4)                                   
      dimension sab02j(4),sab02h(4),sab02s(4)                                   
      dimension sab03j(4),sab03h(4),sab03s(4)                                   
      dimension sab04j(4),sab04h(4),sab04s(4)                                   
      dimension sab05j(4),sab05h(4),sab05s(4)                                   
      dimension sab06j(4),sab06h(4),sab06s(4)                                   
      dimension sab07j(4),sab07h(4),sab07s(4)                                   
      dimension sab08j(4),sab08h(4),sab08s(4)                                   
      dimension sab09j(4),sab09h(4),sab09s(4)                                   
      dimension sab10j(4),sab10h(4),sab10s(4)                                   
      dimension sab11j(4),sab11h(4),sab11s(4)                                   
      dimension sab12j(4),sab12h(4),sab12s(4)                                   
      dimension sab13j(4),sab13h(4),sab13s(4)                                   
      dimension aif92(1992:2012),aif13(2013:2017),aif14(2014:2021),
     &tinc93(1993:2017)
      data tinc93/17*46750.d0,4*54000.d0,58000.d0,58920.d0,59180.d0,
     &59660.d0/
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.08d0/                       
      data aif14/1.0d0,1.016d0 ,1.02d0, 1.0285d0,1.05d0,1.0767d0,
     & 1.097d0,1.113d0/ 
      data aif92/1.0525d0, 1.0845d0, 1.118d0, 1.147d0,                          
     & 1.1795d0, 1.212d0, 1.245d0,  1.266d0, 1.2895d0,                          
     & 1.3295d0, 1.373d0, 1.395d0,  1.427d0, 1.4595d0,                          
     & 1.505d0 , 1.564d0, 1.5995d0, 1.668d0,2*1.6955d0,                         
     & 1.7365d0/                                                                
      data rate /.18d0,.16d0,.18d0,2*.15d0,.18d0,.2d0,.19d0,.2d0 ,.19d0/        
c The add-on minimum tax and the AMT should be recomputed for all               
c taxable years beginning after                                                 
c December 31, 1978 and continuing through tax year 2013.                       
      data arate/10*.0d0,3*.2205d0,.2401d0,2*.259d0,21*.296d0/                  
c form 1040N                                                                    
      data cred/3*20.d0, 3*28.d0,  21.d0, 9*.0d0,  65.d0, 2*69.d0,              
     &            72.d0,   86.d0,  88.d0,  89.d0,  91.d0,   94.d0,              
     &            97.d0,   99.d0, 101.d0, 103.d0, 106.d0,  111.d0,              
     &           113.d0,2*118.d0, 120.d0, 123.d0, 126.d0,  128.d0,              
     &           130.d0,  131.d0, 132.d0, 134.d0, 137.d0,  140.d0,              
     &           142.d0/                                                        
      data st/                                                                  
     8          6750.d0,13500.d0, 9900.d0,                                      
     9          6900.d0,13800.d0,10100.d0,                                      
     &          7000.d0,14000.d0,10300.d0,                                      
     1          7100.d0,14200.d0,10450.d0/                                      
      data addst/                                                               
     8          1600.d0,1300.d0,1600.d0,                                        
     9          1600.d0,1300.d0,1600.d0,                                        
     &          1650.d0,1350.d0,1650.d0,                                        
     1          1650.d0,1350.d0,1650.d0/                                        
                                                                                
c     the fractions below are multiplied by a primary rate, contained           
c       in the adj array                                                        
c     tab - for years 1988-1992                                                 
c     state taxes review  vol.49 No.50                                          
c           February 9, 1998                                                    
c                                                                               
      data tab87j/3000.d0,2.d0,28000.d0,3.15d0,45000.d0,5.d0,1.e20,             
     & 5.9d0/                                                                   
      data tab87m/1500.d0,2.d0,14000.d0,3.15d0,22500.d0,5.0d0,1.e20,            
     & 5.9d0/                                                                   
      data tab87s/1800.d0,2.d0,16800.d0,3.15d0,27000.d0,5.d0,1.e20,             
     & 5.9d0/                                                                   
      data tab87h/2500.d0,2.d0,23000.d0,3.15d0,38000.d0,5.d0,1.e20,             
     & 5.9d0/                                                                   
      data tab89j/3000.d0,2.d0,28000.d0,3.1d0,45000.d0,4.8d0,1.e20,             
     & 5.9d0/                                                                   
      data tab89m/1500.d0,2.d0,14000.d0,3.1d0,22500.d0,4.8d0,1.e20,             
     & 5.9d0/                                                                   
      data tab89s/1800.d0,2.d0,16800.d0,3.1d0,27000.d0,4.8d0,1.e20,             
     & 5.9d0/                                                                   
      data tab89h/2500.d0,2.d0,23000.d0,3.1d0,38000.d0,4.8d0,1.e20,             
     & 5.9d0/                                                                   
      data tab90j/3000.d0,2.2d0,28000.d0,3.36d0,45000.d0,5.21d0,                
     & 1.e20,6.41d0/                                                            
      data tab90m/1500.d0,2.2d0,14000.d0,3.36d0,22500.d0,5.21d0,                
     & 1.e20, 6.41d0/                                                           
      data tab90s/1800.d0,2.2d0,16800.d0,3.36d0,27000.d0,5.21d0,                
     & 1.e20, 6.41d0/                                                           
      data tab90h/2500.d0,2.2d0,23000.d0,3.36d0,38000.d0,5.21d0,                
     & 1.e20, 6.41d0/                                                           
      data tab91j/3000.d0,2.37d0,28000.d0,3.63d0,45000.d0,5.62d0,               
     & 1.e20, 6.92d0/                                                           
      data tab91m/1500.d0,2.37d0,14000.d0,3.63d0,22500.d0,5.62d0,               
     & 1.e20, 6.92d0/                                                           
      data tab91s/1800.d0,2.37d0,16800.d0,3.63d0,27000.d0,5.62d0,               
     & 1.e20, 6.92d0/                                                           
      data tab91h/2500.d0,2.37d0,23000.d0,3.63d0,38000.d0,5.62d0,               
     & 1.e20, 6.92d0/                                                           
      data tab93s/2400.d0,2.62d0,17000.d0,3.65d0,26500.d0,5.24d0,               
     & 1.e20, 6.99d0/                                                           
      data tab93j/4000.d0,2.62d0,30000.d0,3.65d0,46750.d0,5.24d0,               
     & 1.e20, 6.99d0/                                                           
      data tab93h/3800.d0,2.62d0,24100.d0,3.65d0,35000.d0,5.24d0,               
     & 1.e20, 6.99d0/                                                           
      data tab98s/2400.d0,2.51d0,17000.d0,3.49d0,26500.d0,5.01d0,               
     & 1.e20, 6.68d0/                                                           
      data tab98j/4000.d0,2.51d0,30000.d0,3.49d0,46750.d0,5.01d0,               
     & 1.e20, 6.68d0/                                                           
      data tab98h/3800.d0,2.51d0,24000.d0,3.49d0,35000.d0,5.01d0,               
     & 1.e20, 6.68d0/                                                           
      data tab03s/2400.d0,2.56d0,17000.d0,3.57d0,26500.d0,5.12d0,               
     & 1.e20, 6.84d0/                                                           
      data tab03j/4000.d0,2.56d0,30000.d0,3.57d0,46750.d0,5.12d0,               
     & 1.e20, 6.84d0/                                                           
      data tab03h/3800.d0,2.56d0,24000.d0,3.57d0,35000.d0,5.12d0,               
     & 1.e20, 6.84d0/                                                           
      data tab06s/2400.d0,2.56d0,17500.d0,3.57d0,27000.d0,5.12d0,               
     & 1.e20, 6.84d0/                                                           
      data tab06j/4000.d0,2.56d0,31000.d0,3.57d0,50000.d0,5.12d0,               
     & 1.e20, 6.840d0/                                                          
      data tab06h/3800.d0,2.56d0,25000.d0,3.57d0,35000.d0,5.12d0,               
     & 1.e20, 6.84d0/                                                           
      data tab07s/2400.d0,2.56d0,17500.d0,3.57d0,27000.d0,5.12d0,               
     & 1.e20, 6.84d0/                                                           
      data tab07j/4800.d0,2.56d0,35000.d0,3.57d0,54000.d0,5.12d0,               
     & 1.e20, 6.84d0/                                                           
      data tab07h/4500.d0,2.56d0,28000.d0,3.57d0,40000.d0,5.12d0,               
     & 1.e20, 6.84d0/                                                           
      data tab13s/2400.d0,2.46d0,17500.d0,3.51d0,27000.d0,5.01d0,               
     & 1.e20, 6.84d0/                                                           
      data tab13j/4800.d0,2.46d0,35000.d0,3.51d0,54000.d0,5.01d0,               
     & 1.e20, 6.84d0/                                                           
      data tab13h/4500.d0,2.46d0,28000.d0,3.51d0,40000.d0,5.01d0,               
     & 1.e20, 6.84d0/                                                           
      data tab14s/3000.d0,2.46d0,18000.d0,3.51d0,29000.d0,5.01d0,               
     & 1.e20, 6.84d0/                                                           
      data tab14j/6000.d0,2.46d0,36000.d0,3.51d0,58000.d0,5.01d0,               
     & 1.e20, 6.84d0/                                                           
      data tab14h/5600.d0,2.46d0,28800.d0,3.51d0,43000.d0,5.01d0,               
     & 1.e20, 6.84d0/                                                           
c                                                                               
      data sab93s/108450.0d0,  132450.0d0,  278450.0d0,373450.0d0/              
      data sab93j/108450.0d0,  148450.0d0,  408450.0d0,575950.0d0/              
      data sab93h/108450.0d0,  146450.0d0,  348450.0d0,458450.0d0/              
c                                                                               
      data sab94s/111800.0d0,  135800.0d0,  281800.0d0,376800.0d0/              
      data sab94j/111800.0d0,  151800.0d0,  411800.0d0,579300.0d0/              
      data sab94h/111800.0d0,  149800.0d0,  351800.0d0,461800.0d0/              
c                                                                               
      data sab95s/114700.0d0,  138700.0d0,  284700.0d0,379700.0d0/              
      data sab95j/114700.0d0,  154700.0d0,  414700.0d0,582200.0d0/              
      data sab95h/114700.0d0,  152700.0d0,  354700.0d0,464700.0d0/              
c                                                                               
      data sab96s/117950.0d0,  141950.0d0,  297950.0d0,382950.0d0/              
      data sab96j/117950.0d0,  157950.0d0,  417950.0d0,585450.0d0/              
      data sab96h/117950.0d0,  155950.0d0,  357950.0d0,467950.0d0/              
c                                                                               
      data sab97s/121200.0d0,  145200.0d0,  291200.0d0,386200.0d0/              
      data sab97j/121200.0d0,  161200.0d0,  421200.0d0,575950.0d0/              
      data sab97h/121200.0d0,  159200.0d0,  361200.0d0,471200.0d0/              
c                                                                               
      data sab98s/124500.0d0,  148500.0d0,  294500.0d0,389500.0d0/              
      data sab98j/124500.0d0,  164500.0d0,  424500.0d0,592000.0d0/              
      data sab98h/124500.0d0,  162500.0d0,  364500.0d0,474500.0d0/              
c                                                                               
      data sab99s/126600.0d0,  150600.0d0,  296600.0d0,391600.0d0/              
      data sab99j/126600.0d0,  166600.0d0,  426600.0d0,594100.0d0/              
      data sab99h/126600.0d0,  164600.0d0,  366600.0d0,476600.0d0/              
c                                                                               
      data sab00s/128950.0d0,  152950.0d0,  298950.0d0,393950.0d0/              
      data sab00j/128950.0d0,  168950.0d0,  428950.0d0,596450.0d0/              
      data sab00h/128950.0d0,  166950.0d0,  368950.0d0,478950.0d0/              
c                                                                               
      data sab01s/132950.0d0,  156950.0d0,  302950.0d0,397950.0d0/              
      data sab01j/132950.0d0,  172950.0d0,  432950.0d0,600450.0d0/              
      data sab01h/132950.0d0,  170950.0d0,  372950.0d0,482950.0d0/              
c                                                                               
      data sab02s/137300.0d0,  161300.0d0,  307300.0d0,402300.0d0/              
      data sab02j/137300.0d0,  177300.0d0,  437300.0d0,604800.0d0/              
      data sab02h/137300.0d0,  175300.0d0,  377300.0d0,487300.0d0/              
c                                                                               
      data sab03s/139500.0d0,  163500.0d0,  309500.0d0,404500.0d0/              
      data sab03j/139500.0d0,  179500.0d0,  439500.0d0,607000.0d0/              
      data sab03h/139500.0d0,  177500.0d0,  379500.0d0,489500.0d0/              
c                                                                               
      data sab04s/142700.0d0,  166700.0d0,  312700.0d0,407700.0d0/              
      data sab04j/142700.0d0,  182700.0d0,  442700.0d0,610700.0d0/              
      data sab04h/142700.0d0,  180700.0d0,  382700.0d0,492700.0d0/              
c                                                                               
      data sab05s/145950.0d0,  169950.0d0,  315950.0d0,410950.0d0/              
      data sab05j/145950.0d0,  185950.0d0,  445950.0d0,613450.0d0/              
      data sab05h/145950.0d0,  183950.0d0,  385950.0d0,495950.0d0/              
c                                                                               
      data sab06s/150500.0d0,  174500.0d0,  325500.0d0,420500.0d0/              
      data sab06j/150500.0d0,  190500.0d0,  460500.0d0,650500.0d0/              
      data sab06h/150500.0d0,  188500.0d0,  400500.0d0,500500.0d0/              
c                                                                               
      data sab07s/156400.0d0,  180400.0d0,  331400.0d0,426400.0d0/              
      data sab07j/156400.0d0,  204400.0d0,  506400.0d0,696400.0d0/              
      data sab07h/156400.0d0,  201400.0d0,  436400.0d0,556400.0d0/              
c                                                                               
      data sab08s/159950.0d0,  183950.0d0,  334950.0d0,429950.0d0/              
      data sab08j/159950.0d0,  207950.0d0,  509950.0d0,699950.0d0/              
      data sab08h/159950.0d0,  204950.0d0,  439950.0d0,559950.0d0/              
c                                                                               
      data sab09s/166800.0d0,  190800.0d0,  341800.0d0,436800.0d0/              
      data sab09j/166800.0d0,  214800.0d0,  516800.0d0,706800.0d0/              
      data sab09h/166800.0d0,  211800.0d0,  446800.0d0,566800.0d0/              
c                                                                               
      data sab10s/167100.0d0,  191100.0d0,  342100.0d0,437100.0d0/              
      data sab10j/167100.0d0,  215100.0d0,  517100.0d0,707100.0d0/              
      data sab10h/167100.0d0,  212100.0d0,  447100.0d0,567100.0d0/              
c                                                                               
      data sab11s/169550.0d0,  193550.0d0,  344550.0d0,439550.0d0/              
      data sab11j/169550.0d0,  217550.0d0,  519550.0d0,709550.0d0/              
      data sab11h/169550.0d0,  214550.0d0,  449550.0d0,569550.0d0/              
c                                                                               
      data sab12s/173650.0d0,  197650.0d0,  348650.0d0,443650.0d0/              
      data sab12j/173650.0d0,  221650.0d0,  523650.0d0,713650.0d0/              
      data sab12h/173650.0d0,  218650.0d0,  453650.0d0,573650.0d0/              
c                                                                               
      data sab13s/250000.0d0,  274000.0d0,  425000.0d0,520000.0d0/              
      data sab13j/300000.0d0,  348000.0d0,  650000.0d0,840000.0d0/              
      data sab13h/275000.0d0,  320000.0d0,  555000.0d0,675000.0d0/              
c                                                                               
      data xmp/                                                                 
     &     1100.0d0, 1130.0d0, 1180.0d0,1230.0d0, 1290.0d0, 1360.0d0/           
c---------------------------------------                                        
      sabs(2,1) = 0.                                                            
      sabj(2,1) = 0.                                                            
      sabh(2,1) = 0.                                                            
      if(law.ge.1993.and.law.le.1996) then                                      
        sabs(2,2) =  .437                                                       
        sabs(2,3) =  .334                                                       
        sabs(2,4) =  .175                                                       
        sabj(2,2) =  .437                                                       
        sabj(2,3) =  .334                                                       
        sabj(2,4) =  .175                                                       
        sabh(2,2) =  .437                                                       
        sabh(2,3) =  .334                                                       
        sabh(2,4) =  .175                                                       
      else if (law.ge.1997.and.law.le.2002) then                                
        sabs(2,2) =  .417                                                       
        sabs(2,3) =  .319                                                       
        sabs(2,4) =  .167                                                       
        sabj(2,2) =  .417                                                       
        sabj(2,3) =  .319                                                       
        sabj(2,4) =  .167                                                       
        sabh(2,2) =  .417                                                       
        sabh(2,3) =  .319                                                       
        sabh(2,4) =  .167                                                       
      else if (law.ge.2003.and.law.le.2012) then                                
        sabs(2,2) =  .428                                                       
        sabs(2,3) =  .327                                                       
        sabs(2,4) =  .172                                                       
        sabj(2,2) =  .428                                                       
        sabj(2,3) =  .327                                                       
        sabj(2,4) =  .172                                                       
        sabh(2,2) =  .428                                                       
        sabh(2,3) =  .327                                                       
        sabh(2,4) =  .172                                                       
      else if (law.ge.2013) then                                                
        sabs(2,2) =  .438                                                       
        sabs(2,3) =  .333                                                       
        sabs(2,4) =  .183                                                       
        sabj(2,2) =  .438                                                       
        sabj(2,3) =  .333                                                       
        sabj(2,4) =  .183                                                       
        sabh(2,2) =  .438                                                       
        sabh(2,3) =  .333                                                       
        sabh(2,4) =  .183                                                       
      endif                                                                     
      if(law.eq.1993) then                                                      
        do 1993 j=1,4                                                           
          sabs(1,j)=sab93s(j)                                                   
          sabj(1,j)=sab93j(j)                                                   
          sabh(1,j)=sab93h(j)                                                   
 1993   continue                                                                
      endif                                                                     
      if(law.eq.1994) then                                                      
        do 1994 j=1,4                                                           
          sabs(1,j)=sab94s(j)                                                   
          sabj(1,j)=sab94j(j)                                                   
          sabh(1,j)=sab94h(j)                                                   
 1994   continue                                                                
      endif                                                                     
      if(law.eq.1995) then                                                      
        do 1995 j=1,4                                                           
          sabs(1,j)=sab95s(j)                                                   
          sabj(1,j)=sab95j(j)                                                   
          sabh(1,j)=sab95h(j)                                                   
 1995   continue                                                                
      endif                                                                     
      if(law.eq.1996) then                                                      
        do 1996 j=1,4                                                           
          sabs(1,j)=sab96s(j)                                                   
          sabj(1,j)=sab96j(j)                                                   
          sabh(1,j)=sab96h(j)                                                   
 1996   continue                                                                
      endif                                                                     
      if(law.eq.1997) then                                                      
        do 1997 j=1,4                                                           
          sabs(1,j)=sab97s(j)                                                   
          sabj(1,j)=sab97j(j)                                                   
          sabh(1,j)=sab97h(j)                                                   
 1997   continue                                                                
      endif                                                                     
      if(law.eq.1998) then                                                      
        do 1998 j=1,4                                                           
          sabs(1,j)=sab98s(j)                                                   
          sabj(1,j)=sab98j(j)                                                   
          sabh(1,j)=sab98h(j)                                                   
 1998   continue                                                                
      endif                                                                     
      if(law.eq.1999) then                                                      
        do 1999 j=1,4                                                           
          sabs(1,j)=sab99s(j)                                                   
          sabj(1,j)=sab99j(j)                                                   
          sabh(1,j)=sab99h(j)                                                   
 1999   continue                                                                
      endif                                                                     
      if(law.eq.2000) then                                                      
        do 2000 j=1,4                                                           
          sabs(1,j)=sab00s(j)                                                   
          sabj(1,j)=sab00j(j)                                                   
          sabh(1,j)=sab00h(j)                                                   
 2000   continue                                                                
      endif                                                                     
      if(law.eq.2001) then                                                      
        do 2001 j=1,4                                                           
          sabs(1,j)=sab01s(j)                                                   
          sabj(1,j)=sab01j(j)                                                   
          sabh(1,j)=sab01h(j)                                                   
 2001   continue                                                                
      endif                                                                     
      if(law.eq.2002) then                                                      
        do 2002 j=1,4                                                           
          sabs(1,j)=sab02s(j)                                                   
          sabj(1,j)=sab02j(j)                                                   
          sabh(1,j)=sab02h(j)                                                   
 2002   continue                                                                
      endif                                                                     
      if(law.eq.2003) then                                                      
        do 2003 j=1,4                                                           
          sabs(1,j)=sab03s(j)                                                   
          sabj(1,j)=sab03j(j)                                                   
          sabh(1,j)=sab03h(j)                                                   
 2003   continue                                                                
      endif                                                                     
      if(law.eq.2004) then                                                      
        do 2004 j=1,4                                                           
          sabs(1,j)=sab04s(j)                                                   
          sabj(1,j)=sab04j(j)                                                   
          sabh(1,j)=sab04h(j)                                                   
 2004   continue                                                                
      endif                                                                     
      if(law.eq.2005) then                                                      
        do 2005 j=1,4                                                           
          sabs(1,j)=sab05s(j)                                                   
          sabj(1,j)=sab05j(j)                                                   
          sabh(1,j)=sab05h(j)                                                   
 2005   continue                                                                
      endif                                                                     
      if(law.eq.2006) then                                                      
        do 2006 j=1,4                                                           
          sabs(1,j)=sab06s(j)                                                   
          sabj(1,j)=sab06j(j)                                                   
          sabh(1,j)=sab06h(j)                                                   
 2006   continue                                                                
      endif                                                                     
      if(law.eq.2007) then                                                      
        do 2007 j=1,4                                                           
          sabs(1,j)=sab07s(j)                                                   
          sabj(1,j)=sab07j(j)                                                   
          sabh(1,j)=sab07h(j)                                                   
 2007   continue                                                                
      endif                                                                     
      if(law.eq.2008) then                                                      
        do 2008 j=1,4                                                           
          sabs(1,j)=sab08s(j)                                                   
          sabj(1,j)=sab08j(j)                                                   
          sabh(1,j)=sab08h(j)                                                   
 2008   continue                                                                
      endif                                                                     
      if(law.eq.2009) then                                                      
        do 2009 j=1,4                                                           
          sabs(1,j)=sab09s(j)                                                   
          sabj(1,j)=sab09j(j)                                                   
          sabh(1,j)=sab09h(j)                                                   
 2009   continue                                                                
      endif                                                                     
      if(law.eq.2010) then                                                      
        do 2010 j=1,4                                                           
          sabs(1,j)=sab10s(j)                                                   
          sabj(1,j)=sab10j(j)                                                   
          sabh(1,j)=sab10h(j)                                                   
 2010   continue                                                                
      endif                                                                     
      if(law.eq.2011) then                                                      
        do 2011 j=1,4                                                           
          sabs(1,j)=sab11s(j)                                                   
          sabj(1,j)=sab11j(j)                                                   
          sabh(1,j)=sab11h(j)                                                   
 2011   continue                                                                
      endif                                                                     
c 2012 ---                                                                      
      if(law.eq.2012) then                                                      
        do 2012 j=1,4                                                           
          sabs(1,j)=sab12s(j)                                                   
          sabj(1,j)=sab12j(j)                                                   
          sabh(1,j)=sab12h(j)                                                   
2012   continue                                                                 
      endif                                                                     
c 2013+ ---                                                                     
       if(law.ge.2013.and.law.le.2017) then                                     
        do 2013 j=1,4                                                           
          sabs(1,j)=sab13s(j)*aif13(law)                                        
          sabj(1,j)=sab13j(j)*aif13(law)                                        
          sabh(1,j)=sab13h(j)*aif13(law)                                        
 2013   continue                                                                
      endif                                                                     
c-----------------------------------------------                                
      credit=0.                                                                 
      mst = int(data(2))                                                             
      rt = 0.                                                                   
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012) phas92=100000.*aif92(law)/sep             
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c tax before crdt                                                               
      if(law.le.1986) then                                                      
        fedtax=max(comnew(77),0.0d0)                                            
        statax=max(0.0d0,(rate(law)*fedtax))                                    
        rt=rate(law)*comnew(72)/100.                                            
      else                                                                      
        agi=comnew(2)                                                           
        if(law.ge.1988) agi=agi-data(22)                                        
c Social Security Income in agi for 2015-2020                                   
        if(law.ge.2015.and.law.le.2020) then                                    
          if((mst.eq.2.and.comnew(2).le.58000.d0).or.                           
     &  (mst.ne.2.and.comnew(2).le.43000.d0)) agi = agi - comnew(79)            
        endif                                                                   
c Social Security Income in agi for 2021+                                       
        if(law.ge.2021) then                                                    
          if(mst.eq.2) then                                                     
            if(comnew(2).le.59960.d0)agi=agi-comnew(79)                         
            if(comnew(2).gt.59960.d0)agi=agi-.05*comnew(79)                     
          else                                                                  
            if(comnew(2).le.44460.d0)agi=agi-comnew(79)                         
            if(comnew(2).gt.44460.d0)agi=agi-.05*comnew(79)                     
          endif                                                                 
        endif
        if(law.le.2017) then
          xitded = abs(comnew(24)-data(50))*comnew(26) 
        else
          stit = min(10000.d0/sep,data(50))
          xitded = abs(comnew(24)-stit)*comnew(26) 
        endif
        nfile = int(filing(mst,1.,2.,3.,2.))                                    
        nblind = int(data(09)+data(10))                                              
        if(law.le.2017) then                                                    
           stded = comnew(3)                                                    
        else                                                                    
           stded = st(nfile,law)/sep+addst(nfile,law)*nblind                    
        endif                                                                   
c  std deduction phaseout see instructions p.10,1993                            
c  state inc tax refunds                                                        
c  deduc,state&loc tax flag itmzd                                               
c  zero bracket amt                                                             
        if(law.ge.1993.and.law.le.2017) then                                    
           diff=max(0.0d0,comnew(2)-phas92)                                     
           stded=max(0.0d0,comnew(3)-.1*diff)                                   
c 2003-2006 diff in fed std and NE std                                          
           if(mst.eq.2.or.mst.eq.5.or.mst.eq.3.or.mst.eq.6) then                
              if(law.eq.2003) stded=max(0.0d0,7950.d0/sep-.1*diff)              
              if(law.eq.2004) stded=max(0.0d0,8140.d0/sep-.1*diff)              
              if(law.eq.2005) stded=max(0.0d0,8320.d0/sep-.1*diff)              
              if(law.eq.2006) stded=max(0.0d0,8580.d0/sep-.1*diff)              
           endif                                                                
           if(mst.eq.1.and.law.eq.2005)stded=max(0.0d0,4980-.1*diff)            
           if(mst.eq.1.and.law.eq.2006)stded=max(0.0d0,5130-.1*diff)            
        endif                                                                   
c        if(law.eq.1987)stded=stded-10.                                         
        if(law.ge.2008.and.law.le.2009.and.data(51).gt.0) stded =               
     &          comnew(3) - min(data(51),data(7)*500)                           
c  exemps                                                                       
        if(law.gt.1987) deduc=max(xitded,stded)                                 
        if(law.eq.1987) deduc = max(0.0d0,comnew(24)-data(50)-stded)            
        exemp = 0.                                                              
        if(law.ge.1987.and.law.le.1992) exemp = comnew(68)*xmp(law)             
        taxinc=max(0.0d0,agi - exemp - deduc) 
c	write(0,*) 'taxinc agi exemp deduc',taxinc,agi,exemp,deduc
        if(law.le.1992) then                                                    
          if (law.eq.1987) then                                                 
            if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                           
               taxy = max(0.0d0,taxinc-2600.)                                   
            else if(mst.eq.2) then                                              
               taxy = max(0.0d0,taxinc-3800.)                                   
            else                                                                
               taxy = max(0.0d0,taxinc-1900.)                                   
            endif                                                               
          endif                                                                 
          if (law.eq.1987.or.law.eq.1988) then                                  
             do 2987 i=1,4                                                      
             do 1987 j=1,2                                                      
             tabs(j,i)=tab87s(j,i)                                              
             tabm(j,i)=tab87m(j,i)                                              
             tabj(j,i)=tab87j(j,i)                                              
             tabh(j,i)=tab87h(j,i)                                              
 1987        continue                                                           
 2987        continue                                                           
          endif                                                                 
          if (law.eq.1989) then                                                 
             do 2989 i=1,4                                                      
             do 1989 j=1,2                                                      
             tabs(j,i)=tab89s(j,i)                                              
             tabm(j,i)=tab89m(j,i)                                              
             tabj(j,i)=tab89j(j,i)                                              
             tabh(j,i)=tab89h(j,i)                                              
 1989        continue                                                           
 2989        continue                                                           
          endif                                                                 
          if (law.eq.1990) then                                                 
             do 2990 i=1,4                                                      
             do 1990 j=1,2                                                      
             tabs(j,i)=tab90s(j,i)                                              
             tabm(j,i)=tab90m(j,i)                                              
             tabj(j,i)=tab90j(j,i)                                              
             tabh(j,i)=tab90h(j,i)                                              
 1990        continue                                                           
 2990        continue                                                           
          endif                                                                 
          if (law.eq.1991.or.law.eq.1992) then                                  
             do 2991 i=1,4                                                      
             do 1991 j=1,2                                                      
             tabs(j,i)=tab91s(j,i)                                              
             tabm(j,i)=tab91m(j,i)                                              
             tabj(j,i)=tab91j(j,i)                                              
             tabh(j,i)=tab91h(j,i)                                              
 1991        continue                                                           
 2991        continue                                                           
          endif                                                                 
          if(law.gt.1987) then                                                  
           if(mst.eq.1) then                                                    
            call look(tabs,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)               
           else if(mst.eq.2) then                                               
             call look(tabj,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)              
           else if(mst.eq.3.or.mst.eq.6) then                                   
            call look(tabm,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)               
           else if(mst.eq.4.or.mst.eq.5.or.mst.eq.7) then                       
             call look(tabh,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)              
           endif                                                                
          else if(law.eq.1987) then                                             
           if(mst.eq.1) then                                                    
            call look(tabs,taxy,4,n,statax,1.0d0,0.0d0,rt,data)                 
           else if(mst.eq.2) then                                               
             call look(tabj,taxy,4,n,statax,1.0d0,0.0d0,rt,data)                
           else if(mst.eq.3.or.mst.eq.6) then                                   
            call look(tabm,taxy,4,n,statax,1.0d0,0.0d0,rt,data)                 
           else if(mst.eq.4.or.mst.eq.5.or.mst.eq.7) then                       
             call look(tabh,taxy,4,n,statax,1.0d0,0.0d0,rt,data)                
           endif                                                                
          endif                                                                 
        else  
c 1993+	
          dagi=comnew(2)                                                        
          if(law.ge.1993.and.law.le.1996) then                                  
             do 11 i=1,4                                                        
             do 1 j=1,2                                                         
              tabs(j,i) = tab93s(j,i)                                           
              tabj(j,i) = tab93j(j,i)                                           
              tabh(j,i) = tab93h(j,i)                                           
1            continue                                                           
11           continue                                                           
          else if(law.ge.1997.and.law.le.2002) then                             
             do 21 i=1,4                                                        
             do 2 j=1,2                                                         
              tabs(j,i) = tab98s(j,i)                                           
              tabj(j,i) = tab98j(j,i)                                           
              tabh(j,i) = tab98h(j,i)                                           
2            continue                                                           
21           continue                                                           
          else if(law.ge.2003.and.law.le.2005) then                             
             do 31 i=1,4                                                        
             do 3 j=1,2                                                         
              tabs(j,i) = tab03s(j,i)                                           
              tabj(j,i) = tab03j(j,i)                                           
              tabh(j,i) = tab03h(j,i)                                           
3            continue                                                           
31           continue                                                           
          else if(law.eq.2006) then                                             
             do 41 i=1,4                                                        
             do 4 j=1,2                                                         
              tabs(j,i) = tab06s(j,i)                                           
              tabj(j,i) = tab06j(j,i)                                           
              tabh(j,i) = tab06h(j,i)                                           
4            continue                                                           
41           continue                                                           
          else if(law.ge.2007.and.law.le.2012) then                             
             do 51 i=1,4                                                        
             do 5 j=1,2                                                         
              tabs(j,i) = tab07s(j,i)                                           
              tabj(j,i) = tab07j(j,i)                                           
              tabh(j,i) = tab07h(j,i)                                           
5            continue                                                           
51           continue                                                           
          else if(law.eq.2013) then                                             
             do 61 i=1,4                                                        
             do 6 j=1,2                                                         
              tabs(j,i) = tab13s(j,i)                                           
              tabj(j,i) = tab13j(j,i)                                           
              tabh(j,i) = tab13h(j,i)                                           
6            continue                                                           
61           continue                                                           
          else if(law.ge.2014) then                                             
             do 7 i=1,4                                                         
              tabs(1,i) = tab14s(1,i)*aif14(law)                                
              tabj(1,i) = tab14j(1,i)*aif14(law)                                
              tabh(1,i) = tab14h(1,i)*aif14(law)                                
7            continue                                                           
             do 8 i=1,4                                                         
              tabs(2,i) = tab14s(2,i)                                           
              tabj(2,i) = tab14j(2,i)                                           
              tabh(2,i) = tab14h(2,i)                                            
8            continue                                                           
          endif                                                                 
          if(mst.eq.1) then                                                     
            call look(tabs,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)               
            if(law.le.2017) then                                                
             if(dagi.gt.phas92) then                                            
              if(taxinc.ge.tinc93(law)) then                                          
               call look(sabs,dagi,4,n,surtx,1.0d00,0.0d0,surrt,data)           
               statax=statax+surtx 
               if(dagi.le.sabs(1,4)) then
                  call look(sabs,dagi,4,n,surtx,1.0d00,0.0d0,surrt,data)           
                  statax=statax+surtx  
c                 write(0,*) '33 statax surtx ',statax,surtx
               else                                                               
                  surtx = (sabs(1,4)-sabs(1,3))*sabs(2,4)/100+
     &                  (sabs(1,3)-sabs(1,2))*sabs(2,3)/100+
     &                  (sabs(1,2)-sabs(1,1))*sabs(2,2)/100
                  statax=statax+surtx
c                 write(0,*) '34 statax surtx ',statax,surtx
               endif
              else                                                              
               if(taxinc.lt..1d0*(comnew(2)-phas92))statax = rt*taxinc          
              endif                                                             
             endif                                                              
            endif                                                               
          else if(mst.eq.2.or.mst.eq.3.or.mst.eq.6) then                        
            if(mst.ne.2) then                                                   
              taxy=taxinc*2                                                     
              dagi=comnew(2)*2                                                  
              call look(tabj,taxy,4,n,stax,1.0d0,0.0d0,rt,data)                 
              statax = stax/2                                                   
              if(law.le.2017) then                                              
               if(dagi.gt.phas92) then                                          
                if(taxinc.ge.tinc93(law)) then                                        
                 if(dagi.le.sabj(1,4)) then
                  call look(sabj,dagi,4,n,surtx,1.0d00,0.0d0,surrt,data)           
                  statax=statax+surtx/2  
c                 write(0,*) '33 statax surtx ',statax,surtx
                 else                                                               
                  surtx = (sabj(1,4)-sabj(1,3))*sabj(2,4)/100+
     &                  (sabj(1,3)-sabj(1,2))*sabj(2,3)/100+
     &                  (sabj(1,2)-sabj(1,1))*sabj(2,2)/100
                  statax=statax+surtx/2
c                 write(0,*) '34 statax surtx ',statax,surtx
                 endif
                else                                                            
                 if(taxinc.lt..1d0*(comnew(2)-phas92))statax = rt*taxinc        
                endif                                                           
               endif                                                            
              endif                                                             
            else                                                                
              call look(tabj,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)             
              if(law.le.2017) then                                              
               if(dagi.gt.phas92) then                                          
                if(taxinc.ge.tinc93(law)) then                                        
                 if(dagi.le.sabj(1,4)) then
                  call look(sabj,dagi,4,n,surtx,1.0d00,0.0d0,surrt,data)           
                  statax=statax+surtx  
c                 write(0,*) '33 statax surtx ',statax,surtx
                 else                                                               
                  surtx = (sabj(1,4)-sabj(1,3))*sabj(2,4)/100+
     &                  (sabj(1,3)-sabj(1,2))*sabj(2,3)/100+
     &                  (sabj(1,2)-sabj(1,1))*sabj(2,2)/100
                  statax=statax+surtx
c                 write(0,*) '34 statax surtx ',statax,surtx
                 endif
                else                                                            
                 if(taxinc.lt..1d0*(comnew(2)-phas92))statax = rt*taxinc        
                endif                                                           
               endif                                                            
              endif                                                             
            endif                                                               
          else                                                                  
c hoh
            call look(tabh,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)  
c            write(0,*) '1 taxinc statax',taxinc,statax

            if(law.le.2017) then                                                
             if(dagi.gt.phas92) then  
               if(taxinc.ge.tinc93(law)) then   
                if(dagi.le.sabh(1,4)) then
                 call look(sabh,dagi,4,n,surtx,1.0d00,0.0d0,surrt,data)           
                 statax=statax+surtx  
c                 write(0,*) '33 statax surtx ',statax,surtx
                else                                                               
                 surtx = (sabh(1,4)-sabh(1,3))*sabh(2,4)/100+
     &                  (sabh(1,3)-sabh(1,2))*sabh(2,3)/100+
     &                  (sabh(1,2)-sabh(1,1))*sabh(2,2)/100
                 statax=statax+surtx
c                 write(0,*) '34 statax surtx ',statax,surtx
                endif
               else                                                               
                if(taxinc.lt..1d0*(comnew(2)-phas92))statax = rt*taxinc 
               endif                                                             
             endif                                                              
            endif                                                               
          endif                                                                 
        endif                                                                   
      endif                                                                     
c Nebraska Personal Credit                                                      
      stxcr = 0.                                                                
      if(law.le.1992) then                                                      
        stxcr=cred(law)*(data(7)+data(8))                                       
      elseif(law.ge.1993) then                                                  
        if(law.eq.1993)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,54000.,90000.,                   
     &   75000.,45000.))                                                        
        if (law.eq.1994)                                                        
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,56000.,93000.,                   
     &  78000.,46500.))                                                         
        if (law.eq.1995)                                                        
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,58000.,96000.,                   
     &   80000.,48000.))                                                        
        if (law.eq.1996)                                                        
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,59000.,98000.,                   
     &   82000.,49000.))                                                        
        if(law.eq.1997)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,61000.,101000.,                  
     &   84000.,50500.))                                                        
        if(law.eq.1998)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,62000.,104000.,                  
     &   87000.,52000.))                                                        
        if(law.eq.1999)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,64000.,106000.,                  
     &   88000.,53000.))                                                        
        if(law.eq.2000)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,65000.,107000.,                  
     &   90000.,53500.))                                                        
        if(law.eq.2001)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,67000.,111000.,                  
     &   92000.,55500.))                                                        
        if(law.eq.2002)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,69000.,114000.,                  
     &   95000.,57000.))                                                        
        if(law.eq.2003)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,70000.,116000.,                  
     &   97000.,58000.))                                                        
        if(law.eq.2004)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,72000.,119000.,                  
     &   99000.,59500.))                                                        
        if(law.eq.2005)                                                         
     &   agdiff=max(0.0d0,comnew(2)-filing(mst,73000.,122000.,                  
     &  101000.,61000.))                                                        
c Personal Exemption credit for 2006 will no longer be phased out               
c at higher incomes                                                             
        if(law.ge.2006) agdiff = 0.                                             
        xcred=max(0.0d0,cred(law)-5*(agdiff/(5000.d0/sep)))                     
        stxcr=xcred*comnew(68)                                                  
      endif                                                                     
      ocred=0.                                                                  
c elderly credit                                                                
      if(law.ge.1981.and.law.le.1988) then                                      
        ocred=comnew(54)*.5                                                     
      else if(law.ge.1989) then                                                 
        ocred=comnew(54)                                                        
      endif                                                                     
c res energy credit                                                             
      ecred=0.                                                                  
      if(law.ge.1982.and.law.le.1987)ecred=data(38)                             
c non-refundable credits                                                        
      credit=stxcr+ecred+ocred                                                  
c child care credit nonrefundable until 1998                                    
      chcr=0.                                                                   
      chcref = 0.                                                               
      if(law.ge.1989) chcr=.25*comnew(53)                                       
c refundable child care expenses credit after 1998                              
      if(law.ge.1998.and.comnew(2).le.29000) then                               
         chr = .01*(100.-max(comnew(2)/100 - 220.,0.0d0))                       
         chcref = chr*comnew(53)                                                
         if(chcref.gt.0) chcr = 0.                                              
      endif                                                                     
      if(law.lt.1998.or.comnew(2).gt.29000) credit=credit+chcr                  
c no change 2/13/91                                                             
c some credits can not exceed state tax, other can
c Alternative Minimum Tax Eliminated 2014+
      amt = 0.                                                                  
      if(law.le.2013) amt=arate(law)*(comnew(70)+data(42))                      
      statax=statax+amt                                                         
      statax=max(statax-credit,0.0d0)                                           
c Federal tax liability worksheet (statax after non-ref credits)                
c next line was added on 06.02.2017                                             
      statax = min(comnew(52)+comnew(70),statax)                                
c 2006 a Nebraska Earned Income Credit - refundable                             
      earncr = 0.                                                               
      if(law.eq.2006) earncr = .08*comnew(59)                                   
      if(law.ge.2007) earncr = .1*comnew(59)                                    
      statax=statax - chcref - earncr                                           
      if(law.ge.1998.and.comnew(2).le.29000) credit = credit+chcref             
      credit = credit + earncr                                                  
c only for comparison -- should be the last line before return                  
      if(chcref.gt.0) chcr = chcref                                             
      return                                                                    
      end                                                                       
c  NEW HAMPSHIRE                                                               
c  State 30                                                                    
c                                                                               
c   Updated through 2021                                                        
      subroutine nhtax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(100),comnew(255)                                           
      agi =  data(12)+data(14)                                                  
      stded = 0.                                                                
      if(law.ge.1995) then                                                      
        exemp = data(7)*2400.+(data(9)+data(10))*1200.                          
      else if(law.ge.1981.and.law.le.1994) then                                 
        exemp = (data(7)+data(9)+data(10))*1200.                                
      else                                                                      
        exemp = (data(7)+data(9)+data(10))*600.                                 
      endif                                                                     
      taxinc = max(agi-stded-exemp,0.0d0)                                       
      rt=.05                                                                    
      statax = taxinc * rt                                                      
      pcred = 0.                                                                
      chcr = 0.                                                                 
      credit = 0.                                                               
      comnew(1) = comnew(1)                                                     
      return                                                                    
      end                                                                       
c  NEW JERSEY                                                                   
c  State 31                                                                     
c                                                                               
c  Updated though 2021 (03-15-2022)                                             
      subroutine njtax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
c   different rates apply for commutrs to penn or ny                            
      dimension tab(2,3), tb(2,3),tabown(2,3)                                   
     &,tabs91(2,5),tabm91(2,6),tbs91(2,5),tbm91(2,6)                            
     &,tabs04(2,6),tabm04(2,7)                                                  
     &,tabs09(2,8),tabm09(2,9)                                                  
      dimension excl99(7),excl00(7),excl01(7),excl02(7),excl03(7)               
     &,excl17(7),excl18(7),excl19(7),excl20(7)                                  
      dimension data(255), comnew(255), rat94s(5), rat94m(6)                    
      dimension rat95s(5), rat95m(6), rat96s(5), rat96m(6)                      
      dimension dedmin(1996:2021),procen(1996:2021),amount(1996:2021)           
      dimension eicrt(2000:2021)                                                
c eirt from instructions line 57                                                
      data eicrt/.1d0,.15d0,.175d0,5*.2d0,.225d0,.25d0,5*.2d0,.3d0,             
     & 2*.35d0,.37d0,.39d0,2*.4d0/                                              
      data rat94s/1.9d0,2.375d0,4.75d0 ,6.175d0,6.65d0/                         
      data rat94m/1.9d0,2.375d0,3.325d0,4.75d0 ,6.175d0,6.65d0/                 
      data rat95s/1.7d0,2.125d0,4.25d0 ,6.013d0,6.580d0/                        
      data rat95m/1.7d0,2.125d0,2.975d0,4.25d0 ,6.013d0,6.58d0/                 
      data rat96s/1.4d0,1.75d0 ,3.5d0  ,5.525d0,6.37d0/                         
      data rat96m/1.4d0,1.75d0 ,2.45d0 ,3.5d0  ,5.525d0,6.37d0/                 
      data tb/20000.d0,2.0d0,50000.d0,2.5d0,1.e20,   .0d0/                      
      data tbs91/20000.d0,2.d0,35000.d0,2.5d0,40000.d0,5.d0,                    
     &75000.d0,6.5d0,1.e20,7.d0/                                                
      data tbm91/                                                               
     &   20000.0d0, 2.0d0  ,  50000.0d0 , 2.5d0 , 70000.0d0, 3.5d0,             
     &   80000.0d0, 5.0d0  , 150000.0d0 , 6.5d0,      1.e20, 7.0d0/             
      data tabs04/                                                              
     &   20000.0d0, 1.4d0  ,  35000.0d0,  1.75d0, 40000.0d0, 3.5d0,             
     &   75000.0d0, 5.525d0,  500000.0d0, 6.37d0, 1.e20,     8.97d0/            
      data tabm04/                                                              
     &   20000.0d0, 1.4d0  ,  50000.0d0 , 1.75d0 , 70000.0d0, 2.45d0,           
     &   80000.0d0, 3.5d0  , 150000.0d0 , 5.525d0,500000.0d0, 6.37d0,           
     &       1.e20, 8.97d0/                                                     
c 2009                                                                          
      data tabs09/                                                              
     &   20000.0d0, 1.4d0  ,  35000.0d0 , 1.75d0 , 40000.0d0, 3.5d0,            
     &   75000.0d0, 5.525d0, 400000.0d0 , 6.37d0 ,500000.0d0, 8.0d0,            
     & 1000000.0d0,10.25d0 ,       1.e20,10.75d0/                               
      data tabm09/                                                              
     &   20000.0d0, 1.4d0  ,  50000.0d0 , 1.75d0 , 70000.0d0, 2.45d0,           
     &   80000.0d0, 3.5d0  , 150000.0d0 , 5.525d0,400000.0d0, 6.37d0,           
     &  500000.0d0, 8.0d0  ,1000000.0d0 ,10.25d0 ,     1.e20,10.75d0/           
      data tabown/                                                              
     &   20000.0d0, 3250.0d0,  50000.0d0,  2600.0d0,  1.e20, 1857.0d0/          
      data excl99/                                                              
     &   7500.0d0, 10000.0d0,   5000.0d0, 2*7500.0d0, 5000.0d0,                 
     &   7500.0d0/                                                              
      data excl00/                                                              
     &   9375.0d0, 12500.0d0,   6250.0d0, 2*9375.0d0, 6250.0d0,                 
     &   9375.0d0/                                                              
      data excl01/                                                              
     &  11250.0d0, 15000.0d0,   7500.0d0,2*11250.0d0, 7500.0d0,                 
     &  11250.0d0/                                                              
      data excl02/                                                              
     &  13125.0d0, 17500.0d0,   8750.0d0,2*13125.0d0, 8750.0d0,                 
     &  13125.0d0/                                                              
      data excl03/15000.d0,20000.d0,10000.d0,2*15000.d0,10000.d0,               
     & 15000.d0/                                                                
      data excl17/30000.d0,40000.d0,20000.d0,2*30000.d0,20000.d0,               
     & 30000.d0/                                                                
      data excl18/45000.d0,60000.d0,30000.d0,2*45000.d0,30000.d0,               
     & 45000.d0/                                                                
      data excl19/60000.d0,80000.d0,40000.d0,2*60000.d0,40000.d0,               
     & 60000.d0/                                                                
      data excl20/75000.d0,100000.d0,50000.d0,2*75000.d0,50000.d0,              
     & 75000.d0/                                                                
c dedmin, procen,amount from worksheet H                                        
      data dedmin/2500.d0,5625.d0,20*10000.d0,4*15000.d0/                       
      data procen/.5d0,.75d0,24* 1.0d0/                                         
      data amount/25.d0,37.5d0,24*50.d0/                                        
      rt = 0.                                                                   
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rescr = 0.                                                                
      rded = 0.                                                                 
      pded = 0.                                                                 
      ptax = 0.                                                                 
      if(data(51).gt.0.d0) ptax = ptax + data(51)                               
      if(data(160).gt.0.d0.and.comnew(68).gt.0.d0)                              
     &ptax = ptax + .18 * data(160)                                             
c setting tab, tabs91,tabm91                                                    
      do 101 i=1,3                                                              
      do 100 j=1,2                                                              
        tab(j,i) = tb(j,i)                                                      
100   continue                                                                  
101   continue                                                                  
      do 103 i=1,5                                                              
      do 102 j=1,2                                                              
        tabs91(j,i) = tbs91(j,i)                                                
102   continue                                                                  
103   continue                                                                  
      do 105 i=1,6                                                              
      do 104 j=1,2                                                              
        tabm91(j,i) = tbm91(j,i)                                                
104   continue                                                                  
105   continue                                                                  
c rates for years through 1990                                                  
      if(law.le.1982) then                                                      
        tab(2,3)=2.5                                                            
      else if(law.ge.1983) then                                                 
        tab(2,3)=3.5                                                            
      endif                                                                     
c rate for years 1994 and on                                                    
      if(law.eq.1994) then                                                      
        do 1 i=1,5                                                              
        tabs91(2,i)=rat94s(i)                                                   
1       continue                                                                
        do 2 i=1,6                                                              
        tabm91(2,i)=rat94m(i)                                                   
2       continue                                                                
      else if(law.eq.1995) then                                                 
        do 3 i=1,5                                                              
        tabs91(2,i)=rat95s(i)                                                   
 3      continue                                                                
        do 4 i=1,6                                                              
        tabm91(2,i)=rat95m(i)                                                   
 4      continue                                                                
      else if(law.ge.1996.and.law.le.2003) then                                 
        do 5 i=1,5                                                              
        tabs91(2,i)=rat96s(i)                                                   
 5      continue                                                                
        do 6 i=1,6                                                              
        tabm91(2,i)=rat96m(i)                                                   
 6      continue                                                                
      endif                                                                     
c AGI                                                                           
      subrac=comnew(78)+comnew(79)+data(62)                                     
      d17 = data(17)+data(211)+data(214)+data(212)+data(215)                    
      agi=data(11)+data(12)+data(14)+max(0.0d0,d17)+data(18)+                   
     & data(19)+ data(23)+data(24)+max(0.0d0,comnew(6))+                        
     & max(0.0d0,comnew(8))+data(20)+data(72)+data(27)+                         
     & max(0.0d0,data(21))                                                      
      if(law.lt.1992) agi = agi + subrac                                        
      ti = agi                                                                  
      if(data(9).gt.0.or.data(10).gt.0) then                                    
c pnsion and retirement income exclusion                                        
       pnsion=data(20)+data(72)                                                 
       retiry=data(11)+data(17)+data(75)                                        
       deduct = 0.                                                              
c Pension Exclusion                                                             
       if(law.le.1999) then                                                     
          deduct=excl99(mst)                                                    
       else if(law.eq.2000) then                                                
          deduct=excl00(mst)                                                    
       else if(law.eq.2001) then                                                
          deduct=excl01(mst)                                                    
       else if(law.eq.2002) then                                                
          deduct=excl02(mst)                                                    
       else if(law.ge.2003.and.law.le.2004) then                                
          deduct=excl03(mst)                                                    
       else if(law.ge.2005.and.hy.le.100000) then                               
c Effective for taxable years 2005+ limits for Pension Exclusion and            
c Other Retirement Income Exclusion to taxpayers with income $100,000 and less  
          if(law.lt.2017) deduct=excl03(mst)                                    
          if(law.eq.2017) deduct=excl17(mst)                                    
          if(law.eq.2018) deduct=excl18(mst)                                    
          if(law.eq.2019) deduct=excl19(mst)                                    
          if(law.ge.2020) deduct=excl20(mst)                                    
       endif                                                                    
       agi=agi-twn(pnsion,0.0d0,deduct)                                         
c Other Retirement Income Exclusion                                             
       xtra = max(0.0d0,deduct-pnsion)                                          
       if(retiry.le.3000.) agi = agi - min(xtra,max(0.0d0,agi))                 
c Special Exclusion for taxpayers who cannot receive SS or RR benefits.         
c Since most taxpayers qualify for those benefits,                              
c few taxpayers are eligible to use the special exclusion.                      
c       if(law.ge.2005.and.data(20)+data(72).gt.0.d0.and.                       
c     &           data(91).lt.1.and.ti.le.100000.d0) then                       
c        if(mst.eq.2.or.mst.eq.3.or.mst.eq.6) then                              
c          spmax = 3000.d0                                                      
c        else                                                                   
c          spmax = 6000.d0                                                      
c       endif                                                                   
c        agi = agi - min(data(20)+data(72),spmax)                               
c       endif                                                                   
      endif                                                                     
c NJ doesn't have special treatment of capital gains                            
      agi = agi -comnew(6) + comnew(5)                                          
c No Tax Status                                                                 
      if((law.le.1993.and.agi.le.3000.d0/sep).or.                               
     &   (law.ge.1994.and.law.le.1996.and.agi.lt.7500.d0/sep).or.               
     &   (law.ge.1997.and.law.le.1998.and.agi.le.7500.d0/sep).or.               
     &   (law.eq.1999.and.agi.le.10000.d0/sep)) then                            
           statax=0.                                                            
           taxinc = 0.                                                          
           go to 1000                                                           
      else if(law.eq.2000) then                                                 
       if(mst.eq.1.and.agi.le.10000.d0) then                                    
           statax=0.                                                            
           taxinc = 0.                                                          
           go to 1000                                                           
       else if(mst.ne.1.and.agi.le.15000.d0/sep)then                            
           statax=0.                                                            
           taxinc = 0.                                                          
           go to 1000                                                           
       endif                                                                    
      else if(law.ge.2001) then                                                 
         nts = int(data(7))                                                          
         if (mst.eq.4.or.mst.eq.7) nts=2                                        
         if(agi.le.10000. * nts) then                                           
           statax=0.                                                            
           taxinc = 0.                                                          
           go to 1000                                                           
         endif                                                                  
      endif                                                                     
c Exemptions                                                                    
      if(law.le.1990)exemp=(data(7)+data(8)+data(9)+data(10))*1000.             
      if(law.ge.1991)                                                           
     &         exemp=(data(7)+data(9)+data(10))*1000.+data(8)*1500.             
c Only medical expenses in excess of 2% of income may be deducted               
      edical=max(0.0d0,(data(47)+data(48)+data(49)-.02*max(0.0d0,agi)))         
      taxinc=max(0.0d0,agi-exemp-edical)                                        
c Property tax deduction/credit                                                 
      if(law.ge.1985.and.law.le.1989.and.agi.gt.3000.d0/sep) then               
        floor=tablki(tabown,3,taxinc,data)/sep                                  
        rded=xif(data(160).gt.0.,max(floor*.54,.18*data(160)))                  
     &     *renter(data,comnew)                                                 
        pded=xif(data(51).gt.0.,max(floor, data(51)))                           
        xtra=pded+rded-taxinc                                                   
        if(xtra.gt.0) rescr=.02*xtra                                            
      endif                                                                     
c new homestead property tax rebate implement 1990-1995                         
c but does not offset income tax                                                
      taxinc=max(0.0d0,taxinc-rded-pded)                                        
c      write(0,*) 'agi exemp taxinc rded',agi,exemp,taxinc,rded                                                                                                 
c  State Tax  Calculation                                                       
      if(law.le.1990) then                                                      
        call look(tab,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                   
      else if(law.ge.1991.and.law.le.2003) then                                 
        if(mst.eq.2.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5)then                    
          call look(tabm91,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)              
        else                                                                    
          call look(tabs91,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)              
        endif                                                                   
      else if(law.ge.2004) then                                                 
       if(law.ne.2009) then                                                     
          if(mst.eq.2.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5)then                  
             call look(tabm04,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)           
          else                                                                  
             call look(tabs04,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)           
          endif                                                                 
       else if (law.eq.2009) then                                               
          if(mst.eq.2.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5)then                  
             call look(tabm09,taxinc,9,n,statax,1.0d00,0.0d0,rt,data)           
          else                                                                  
             call look(tabs09,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)           
          endif                                                                 
       endif                                                                    
      endif
1000  rebate = 0.                                                               
      pcred=0.                                                                  
c  Residental Property Tax Credit                                               
      if(law.le.1984) then                                                      
        if(data(160).gt.0) then                                                 
          pcred=65.                                                             
          if(data(9).gt.0.or.data(10).gt.0) pcred = pcred + 35.                 
        endif                                                                   
      else if(law.ge.1985.and.law.le.1989) then                                 
        if(agi.le.3000.d0/sep) then                                             
          if(data(160).gt.0.) pcred=35.                                         
          if(data(51).gt.0.) pcred=65.                                          
        endif                                                                   
c  1990+ Homestead Property Tax Rebate                                          
c There is no tenant rebate application available for 2012+                     
c since tenant rebates for 2009 through 2011 were suspended by the State Budget 
      else if((law.ge.1990.and.law.le.2003).or.                                 
     & ((law.ge.2004.and.law.le.2008).and.data(160).gt.0)) then                 
c  Taxpayers age 65 and over and/or totally or permanently disabled             
        if(data(9)+data(10).gt.0) then                                          
          reb = max(0.0d0,ptax - .05 * agi)                                     
          if(data(51).gt.0) then                                                
            if(agi.le.35000) then                                               
               rebate = max(150.0d0,min(500.0d0,reb))/sep                       
               if(law.ge.2001) rebate=max(150.0d0,min(775.0d0,reb))/sep         
            else if(agi.gt.35000.and.agi.le.70000.) then                        
               if(mst.eq.2.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5) then            
                 rebate = max(150.0d0,min(500.0d0,reb))/sep                     
                 if(law.ge.2001)rebate=max(150.0d0,min(775.0d0,reb))/sep        
               else                                                             
                 rebate = 150.d0/sep                                            
               endif                                                            
            else if(agi.gt.70000.and.agi.le.100000.) then                       
               rebate = 100.d0/sep                                              
            endif                                                               
          else if(data(160).gt.0.d0) then                                       
            if(agi.le.35000.d0) then                                            
               rebate = max(65.0d0,min(500.0d0,reb))/sep                        
               if(law.ge.2001) rebate=max(100.0d0,min(775.0d0,reb))/sep         
            else if(agi.gt.35000.and.agi.le.70000.) then                        
               if(mst.eq.2.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5) then            
                 rebate = max(65.0d0,min(500.0d0,reb))/sep                      
                 if(law.ge.2001) rebate = 100.d0/sep                            
               else                                                             
                 rebate = 65./sep                                               
                 if(law.ge.2001) rebate = 100.d0/sep                            
               endif                                                            
            else if(agi.gt.70000.and.agi.le.100000.) then                       
               if(law.le.1998) then                                             
                 rebate = 35.d0/sep                                             
               else if (law.eq.1999) then                                       
                 rebate = 40.d0/sep                                             
               else if(law.eq.2000) then                                        
                 rebate = 60.d0/sep                                             
               else if(law.ge.2001.and.law.le.2003) then                        
                 rebate =100.d0/sep                                             
               else if(law.ge.2004) then                                        
                 rebate =150.d0/sep                                             
               endif                                                            
            endif                                                               
          endif                                                                 
        else if(data(9)+data(10).lt.1.) then                                    
c Taxpayers under age 65 and not totally and permanently disabled               
          if(data(51).gt.0.and.agi.lt.40000) rebate = 90.d0/sep                 
          if(data(160).gt.0) then                                               
            if(law.le.1998.and.agi.lt.40000) rebate = 30.d0/sep                 
            if(law.eq.1999.and.agi.lt.100000) rebate = 40.d0/sep                
            if(law.eq.2000.and.agi.lt.100000) rebate = 60.d0/sep                
            if(law.ge.2001..and.law.le.2003.and.agi.lt.100000.d0)               
     &    rebate = 100.d0/sep                                                   
            if(law.ge.2004) rebate = 150.d0/sep                                 
          endif                                                                 
        endif                                                                   
      endif                    
c                                                                               
c New in 1996+ Prop. Tax Deduct/Credit which allows either to deduct            
c a portion of prop.taxes or rent or to take a credit against their             
c income tax due.                                                               
c                                                                               
      if(law.ge.1996.and.ptax.gt.2) then                                        
        pded =min(dedmin(law)/sep,procen(law)*ptax)                             
        exemp=(data(7)+data(9)+data(10))*1000.+data(8)*1500.                    
        edical=max(0.0d0,                                                       
     &  (data(47)+data(48)+data(49)-.02*max(0.0d0,agi)))                        
        taxpr = max(0.0d0,agi-exemp-edical-pded)                                
        if(law.le.2003) then                                                    
          if(mst.eq.4.or.mst.eq.2)then                                          
            call look(tabm91,taxpr,6,n,statpr,1.0d00,0.0d0,rt,data)             
          else                                                                  
            call look(tabs91,taxpr,5,n,statpr,1.0d00,0.0d0,rt,data)             
          endif                                                                 
        else if(law.ge.2004) then                                               
          if(law.ne.2009) then                                                  
             if(mst.eq.2.or.mst.eq.4)then                                       
               call look(tabm04,taxpr,7,n,statpr,1.0d00,0.0d0,rt,data)          
             else                                                               
               call look(tabs04,taxpr,6,n,statpr,1.0d00,0.0d0,rt,data)          
             endif                                                              
          else if(law.eq.2009) then                                             
             if(mst.eq.2.or.mst.eq.4)then                                       
               call look(tabm09,taxpr,9,n,statpr,1.0d00,0.0d0,rt,data)          
             else                                                               
               call look(tabs09,taxpr,8,n,statpr,1.0d00,0.0d0,rt,data)          
             endif                                                              
          endif                                                                 
        endif                                                                   
        if((statax-statpr).ge.amount(law)/sep) then                             
           taxinc = taxpr                                                       
           statax = statpr                                                      
        else                                                                    
           if(data(51)+data(160).gt.0.and.taxinc.gt.0)                          
     &     pcred = amount(law)/sep                                              
        endif                                                                   
      endif  
c  changed 2/13/91 for new accounting of pcred                                  
      credit=rescr+pcred    
      statax=max(0.0d0,statax-credit)
      statax = statax - rebate 
c Earned Income Credit since 2000                                               
      earncr = 0.                                                               
      if(agi.le.20000.and.data(8).gt.0.and.law.ge.2000.and.law.le.2006)         
     & earncr = eicrt(law)*comnew(59)                                           
      if(law.ge.2007) earncr = eicrt(law)*comnew(59)                            
      statax = statax - earncr 

      credit = credit + earncr + rebate                                         
c  statax < 0. means you have got a rebate in 1990 - 1995                       
      return                                                                    
      end                                                                       
c  NEW MEXICO                                                                   
c  State 32                                                                     
c                                                                               
c  Updated through 2021 (update 03/18/2022)                                     
      subroutine nmtax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/temp/count                                                         
      dimension data(255), comnew(255)                                          
      dimension food(1977:1989),exlow(2,2006:2021),eicr(2007:2021)              
      double precision low77(0:6,19),low81(0:6,21),low94(0:6,23),               
     & low98(0:6,24),low21(0:6,24),l77(2,19), l81(2,21),l94(2,23),              
     & l98(2,24),l21(2,24),med,medexp,modagi                                    
      integer sep                                                               
      dimension adf(1977:1994), tabs(2,19), tabm(2,19), tabsp(2,19)             
      dimension proptb(2,17),xmp(1977:1999),amed(1977:1994)                     
      dimension tab77m(2,19),tb77sp(2,19),tab77s(2,19)                          
      dimension tab87m(2,7), tab87s(2,7), tab87h(2,7)                           
      dimension eldm85(2,7), eldm87(2,9), elds85(2,7), elds87(2,9)              
      dimension eldp85(2,7), eldp87(2,9), std86(1:7)                            
      dimension std90(1:7), tab94m(2,7), tab94s(2,8), tab94h(2,7)               
      dimension tab95m(2,9), tab95s(2,10), tab95h(2,8),tab95e(2,8)              
      dimension tab96m(2,8), tab98m(2,8), tab98s(2,10), tab98h(2,8)             
      dimension tab03m(2,7), tab03s(2,10), tab03h(2,6)                          
      dimension tab04m(2,5), tab04s(2,6), tab04h(2,5)                           
      dimension tab05m(2,4), tab05s(2,4), tab05h(2,4)                           
      dimension tab06m(2,4), tab06s(2,4)                                        
      dimension tab08m(2,4), tab08s(2,4)                                        
      dimension tab21m(2,5), tab21s(2,5)                                        
                                                                                
      dimension foods(2,4) , foodm(2,4),chlim(1981:2021)                        
c exlow from form PIT-1 line 14 instructions                                    
      data exlow/27110.0d0,40667.0d0,                                           
     7           36667.0d0,55000.0d0,                                           
     8           36667.0d0,55000.0d0,                                           
     9           36667.0d0,55000.0d0,                                           
     &           36667.0d0,55000.0d0,                                           
     1           36667.0d0,55000.0d0,                                           
     2           36667.0d0,55000.0d0,                                           
     3           36667.0d0,55000.0d0,                                           
     4           36667.0d0,55000.0d0,                                           
     5           36667.0d0,55000.0d0,                                           
     6           36667.0d0,55000.0d0,                                           
     7           36667.0d0,55000.0d0,                                           
     8           36667.0d0,55000.0d0,                                           
     9           36667.0d0,55000.0d0,                                           
     &           36667.0d0,55000.0d0,                                           
     1           36667.0d0,55000.0d0/                                           
c eicr from PIT-1 line 25 instructions                                          
      data eicr/.08d0,11*.1d0,2*.17d0,.2d0/                                     
      data tab77m/  2000.0d0, 0.80d0,  4000.0d0, 1.0d0,  6000.0d0,              
     & 1.40d0,  8000.0d0, 1.80d0,                                               
     & 10000.0d0, 2.20d0, 12000.0d0, 2.60d0, 14000.0d0, 3.0d0,                  
     & 16000.0d0, 3.50d0, 20000.0d0, 4.0d0,                                     
     & 24000.0d0, 4.50d0, 28000.0d0, 5.0d0, 32000.0d0, 5.50d0,                  
     & 36000.0d0, 6.0d0, 40000.0d0, 6.50d0,                                     
     & 50000.0d0, 7.0d0, 70000.0d0, 7.50d0,100000.0d0, 8.0d0,                   
     & 200000.0d0, 8.50d0,  1.e20, 9.0d0/                                       
      data tab77s/  1000.0d0, 0.80d0,  2000.0d0, 0.80d0,                        
     & 3000.0d0, 0.90d0,  4000.0d0, 1.10d0,                                     
     & 5000.0d0, 1.30d0,  6000.0d0, 1.50d0,  7000.0d0, 1.80d0,                  
     & 8000.0d0, 2.30d0, 10000.0d0, 2.90d0,                                     
     & 12000.0d0, 3.50d0, 14000.0d0, 4.20d0, 16000.0d0, 4.90d0,                 
     & 18000.0d0, 5.60d0, 20000.0d0, 6.30d0,                                    
     & 25000.0d0, 7.0d0, 35000.0d0, 7.50d0, 50000.0d0, 8.0d0,                   
     & 100000.0d0, 8.50d0, 1.e20,  9.0d0/                                       
      data tb77sp/ 1000.0d0, .80d0,  2000.0d0, 1.0d0,  3000.0d0,                
     & 1.40d0,  4000.0d0, 1.80d0,                                               
     & 5000.0d0, 2.20d0,  6000.0d0, 2.60d0,  7000.0d0, 3.0d0,                   
     & 8000.0d0, 3.50d0, 10000.0d0, 4.0d0,                                      
     & 12000.0d0, 4.50d0, 14000.0d0, 5.0d0, 16000.0d0, 5.50d0,                  
     & 18000.0d0, 6.0d0, 20000.0d0, 6.50d0,                                     
     & 25000.0d0, 7.0d0, 35000.0d0, 7.50d0, 50000.0d0, 8.0d0,                   
     & 100000.0d0, 8.50d0,  1.e20, 9.0d0/                                       
      data tabm/                                                                
     &     2000.0d0, .0d0,  4000.0d0, .0d0,  6000.0d0, .0d0,                    
     &     8000.0d0, .0d0, 10000.0d0, .0d0, 12000.0d0, .0d0,                    
     &    14000.0d0, .0d0, 16000.0d0, .0d0, 20000.0d0, .0d0,                    
     &    24000.0d0, .0d0, 28000.0d0, .0d0, 32000.0d0, .0d0,                    
     &    36000.0d0, .0d0, 40000.0d0, .0d0, 50000.0d0, .0d0,                    
     &    70000.0d0, .0d0,100000.0d0, .0d0,200000.0d0, .0d0,                    
     &        1.e20, .0d0/                                                      
      data tabs/                                                                
     &     1000.0d0, .0d0,  2000.0d0, .0d0,  3000.0d0, .0d0,                    
     &     4000.0d0, .0d0,  5000.0d0, .0d0,  6000.0d0, .0d0,                    
     &     7000.0d0, .0d0,  8000.0d0, .0d0, 10000.0d0, .0d0,                    
     &    12000.0d0, .0d0, 14000.0d0, .0d0, 16000.0d0, .0d0,                    
     &    18000.0d0, .0d0, 20000.0d0, .0d0, 25000.0d0, .0d0,                    
     &    35000.0d0, .0d0, 50000.0d0, .0d0,100000.0d0, .0d0,                    
     &        1.e20, .0d0/                                                      
      data tabsp/                                                               
     &     1000.0d0, .0d0,  2000.0d0, .0d0,  3000.0d0, .0d0,                    
     &     4000.0d0, .0d0,  5000.0d0, .0d0,  6000.0d0, .0d0,                    
     &     7000.0d0, .0d0,  8000.0d0, .0d0, 10000.0d0, .0d0,                    
     &    12000.0d0, .0d0, 14000.0d0, .0d0, 16000.0d0, .0d0,                    
     &    18000.0d0, .0d0, 20000.0d0, .0d0, 25000.0d0, .0d0,                    
     &    35000.0d0, .0d0, 50000.0d0, .0d0,100000.0d0, .0d0,                    
     &        1.e20, .0d0/                                                      
      data tab87m/                                                              
     &     8000.0d0, 2.4d0, 16000.0d0, 3.8d0, 24000.0d0, 4.8d0,                 
     &    36000.0d0, 5.9d0, 48000.0d0, 6.9d0, 64000.0d0, 7.7d0,                 
     &        1.e20, 8.5d0/                                                     
      data tab87h/                                                              
     &     5200.0d0, 1.8d0, 10400.0d0, 3.0d0, 18000.0d0, 4.5d0,                 
     &    28000.0d0, 5.8d0, 40000.0d0, 6.9d0, 52000.0d0, 7.7d0,                 
     &        1.e20, 8.5d0/                                                     
      data tab87s/                                                              
     &     5200.0d0, 1.8d0, 10400.0d0, 3.0d0, 15600.0d0, 4.5d0,                 
     &    23400.0d0, 5.8d0, 31200.0d0, 6.9d0, 41600.0d0, 7.7d0,                 
     &        1.e20, 8.5d0/                                                     
      data tab94m/                                                              
     &     8000.0d0, 2.2d0, 16100.0d0, 3.2d0, 24000.0d0, 4.7d0,                 
     &    36000.0d0, 6.0d0, 48100.0d0, 7.1d0, 64000.0d0, 7.9d0,                 
     &        1.e20, 8.5d0/                                                     
      data tab94s/                                                              
     &     5500.0d0, 1.7d0,  6000.0d0, 2.8d0, 11000.0d0, 3.0d0,                 
     &    16000.0d0, 4.7d0, 27000.0d0, 6.0d0, 31200.0d0, 7.1d0,                 
     &    41600.0d0, 7.9d0,     1.e20, 8.5d0/                                   
      data tab94h/                                                              
     &     7000.0d0, 1.7d0, 14000.0d0, 3.2d0, 20000.0d0, 4.7d0,                 
     &    33000.0d0, 6.0d0, 48100.0d0, 7.1d0, 64000.0d0, 7.9d0,                 
     &        1.e20, 8.5d0/                                                     
c rates for 95-97  for single and head of households are the same               
      data tab95s/                                                              
     &     5000.0d0, 1.7d0,  6000.0d0, 2.5d0, 10000.0d0, 3.2d0,                 
     &    11000.0d0, 3.3d0, 15000.0d0, 4.7d0, 16000.0d0, 4.8d0,                 
     &    26000.0d0, 6.0d0, 42000.0d0, 7.1d0, 65000.0d0, 7.9d0,                 
     &        1.e20, 8.5d0/                                                     
      data tab95h/                                                              
     &     7000.0d0, 1.7d0,  8000.0d0, 3.1d0, 14000.0d0, 3.2d0,                 
     &    20000.0d0, 4.7d0, 33000.0d0, 6.0d0, 56000.0d0, 7.1d0,                 
     &    83000.0d0, 7.9d0,     1.e20, 8.5d0/                                   
      data tab95m/                                                              
     &     7000.0d0, 2.0d0,  8000.0d0, 2.3d0, 16000.0d0, 3.2d0,                 
     &    23000.0d0, 4.7d0, 24000.0d0, 4.8d0, 40000.0d0, 6.0d0,                 
     &    56000.0d0, 7.1d0, 88000.0d0, 7.9d0,     1.e20, 8.5d0/                 
      data tab95e/                                                              
     &     3000.0d0, 2.2d0,  4000.0d0, 2.3d0, 8000.0d0, 3.2d0,                  
     &    12000.0d0, 4.7d0, 20000.0d0, 6.0d0,32000.0d0, 7.1d0,                  
     &    50000.0d0, 7.9d0,     1.e20, 8.5d0/                                   
      data tab96m/                                                              
     &     7000.0d0, 1.7d0,  8000.0d0, 1.8d0, 16000.0d0, 3.2d0,                 
     &    24000.0d0, 4.7d0, 40000.0d0, 6.0d0, 64000.0d0, 7.1d0,                 
     &   100000.0d0, 7.9d0,     1.e20, 8.5d0/                                   
      data tab98s/                                                              
     &     5000.0d0, 1.7d0,  6000.0d0, 2.5d0, 10000.0d0, 3.2d0,                 
     &    11000.0d0, 3.3d0, 15000.0d0, 4.7d0, 16000.0d0, 4.8d0,                 
     &    26000.0d0, 6.0d0, 42000.0d0, 7.1d0, 65000.0d0, 7.9d0,                 
     &        1.e20, 8.2d0/                                                     
      data tab03s/                                                              
     &     1000.0d0, 1.6d0,  5000.0d0, 1.7d0, 6000.0d0, 2.4d0,                  
     &    11000.0d0, 3.2d0, 12000.0d0, 4.6d0,16000.0d0, 4.7d0,                  
     &    26000.0d0, 6.0d0, 27000.0d0, 7.0d0,42000.0d0, 7.1d0,                  
     &        1.e20, 7.7d0/                                                     
      data tab04s/                                                              
     &     5000.0d0, 1.7d0,   6000.0d0, 2.4d0,  11000.0d0, 3.2d0,               
     &    16000.0d0, 4.7d0,  26000.0d0, 6.0d0,      1.e20, 6.8d0/               
      data tab05s/                                                              
     &     5500.0d0,  1.7d0, 11000.0d0, 3.2d0,  16000.0d0, 4.7d0,               
     &        1.e20,  5.7d0/                                                    
      data tab06s/                                                              
     &     5500.0d0,  1.7d0, 11000.0d0, 3.2d0,  16000.0d0, 4.7d0,               
     &        1.e20,  5.3d0/                                                    
      data tab08s/                                                              
     &     5500.0d0, 1.7d0,  11000.0d0, 3.2d0,  16000.0d0, 4.7d0,               
     &        1.e20, 4.9d0/                                                     
      data tab21s/                                                              
     &     5500.0d0, 1.7d0,  11000.0d0, 3.2d0,  16000.0d0, 4.7d0,               
     &   210000.0d0, 4.9d0,    1.e20, 5.9d0/                                    
      data tab98h/                                                              
     &     7000.0d0, 1.7d0,   8000.0d0, 3.1d0,  14000.0d0, 3.2d0,               
     &    20000.0d0, 4.7d0,  33000.0d0, 6.0d0,  56000.0d0, 7.1d0,               
     &    83000.0d0, 7.9d0,      1.e20, 8.2d0/                                  
      data tab03h/                                                              
     &     7000.0d0, 1.7d0,  14000.0d0, 3.2d0, 20000.0d0, 4.7d0,                
     &    33000.0d0, 6.0d0,  53000.0d0, 7.1d0,     1.e20, 7.7d0/                
      data tab04h/                                                              
     &     7000.0d0, 1.7d0,  14000.0d0, 3.2d0, 20000.0d0, 4.7d0,                
     &    33000.0d0, 6.0d0,      1.e20,  6.8d0/                                 
      data tab05h/                                                              
     &     7000.0d0, 1.7d0,  14000.0d0, 3.2d0, 20000.0d0, 4.7d0,                
     &        1.e20, 5.7d0/                                                     
      data tab98m/                                                              
     &     7000.0d0, 1.7d0,   8000.0d0, 1.8d0, 16000.0d0, 3.2d0,                
     &    24000.0d0, 4.7d0,  40000.0d0, 6.0d0, 64000.0d0, 7.1d0,                
     &   100000.0d0, 7.9d0,      1.e20, 8.2d0/                                  
      data tab03m/                                                              
     &     7000.0d0, 1.7d0,   8000.0d0, 3.1d0, 16000.0d0, 3.2d0,                
     &    23000.0d0, 4.7d0,  40000.0d0, 6.0d0, 63000.0d0, 7.1d0,                
     &        1.e20, 7.7d0/                                                     
      data tab04m/                                                              
     &     8000.0d0, 1.7d0,  16000.0d0, 3.2d0, 24000.0d0, 4.7d0,                
     &    40000.0d0, 6.0d0,      1.e20, 6.8d0/                                  
      data tab05m/                                                              
     &     8000.0d0, 1.7d0, 16000.0d0, 3.2d0, 24000.0d0, 4.70d0,                
     &        1.e20, 5.7d0/                                                     
      data tab06m/                                                              
     &     8000.0d0, 1.7d0, 16000.0d0, 3.2d0, 24000.0d0, 4.7d0,                 
     &        1.e20, 5.3d0/                                                     
      data tab08m/                                                              
     &     8000.0d0, 1.7d0, 16000.0d0, 3.2d0, 24000.0d0, 4.7d0,                 
     &     1.e20   , 4.9d0/                                                     
      data tab21m/                                                              
     &     8000.0d0, 1.7d0, 16000.0d0, 3.2d0, 24000.0d0, 4.7d0,                 
     &   315000.0d0, 4.9d0, 1.e20   , 5.9d0/                                    
      data eldm85/                                                              
     &  30000.0d0, 6000.0d0, 33000.0d0, 5000.0d0, 36000.0d0, 4000.0d0,          
     &  39000.0d0, 3000.0d0, 42000.0d0, 2000.0d0, 45000.0d0, 1000.0d0,          
     &      1.e20,     .0d0/                                                    
      data elds85/                                                              
     &  18000.0d0, 6000.0d0, 19500.0d0, 5000.0d0, 21000.0d0, 4000.0d0,          
     &  22500.0d0, 3000.0d0, 24000.0d0, 2000.0d0, 25500.0d0, 1000.0d0,          
     &      1.e20,     .0d0/                                                    
      data eldp85/                                                              
     &  15000.0d0, 6000.0d0, 16500.0d0, 5000.0d0, 18000.0d0, 4000.0d0,          
     &  19500.0d0, 3000.0d0, 21000.0d0, 2000.0d0, 22500.0d0, 1000.0d0,          
     &      1.e20,     .0d0/                                                    
      data eldm87/                                                              
     &   30000.0d0, 8000.0d0, 33000.0d0, 7000.0d0, 36000.0d0, 6000.0d0,         
     &   39000.0d0, 5000.0d0, 42000.0d0, 4000.0d0, 45000.0d0, 3000.0d0,         
     &   48000.0d0, 2000.0d0, 51000.0d0, 1000.0d0,  1.e20,        .0d0/         
      data elds87/                                                              
     &   18000.0d0, 8000.0d0, 19500.0d0, 7000.0d0, 21000.0d0, 6000.0d0,         
     &   22500.0d0, 5000.0d0, 24000.0d0, 4000.0d0, 25500.0d0, 3000.0d0,         
     &   27000.0d0, 2000.0d0, 28500.0d0, 1000.0d0,  1.e20,        .0d0/         
      data eldp87/                                                              
     &   15000.0d0, 8000.0d0, 16500.0d0, 7000.0d0, 18000.0d0, 6000.0d0,         
     &   19500.0d0, 5000.0d0, 21000.0d0, 4000.0d0, 22500.0d0, 3000.0d0,         
     &   24000.0d0, 2000.0d0, 25500.0d0, 1000.0d0,  1.e20,        .0d0/         
      data proptb /                                                             
     &     1000.0d0, 20.0d0, 2000.0d0, 25.0d0, 3000.0d0, 30.0d0,                
     &     4000.0d0, 35.0d0, 5000.0d0, 40.0d0, 6000.0d0, 45.0d0,                
     &     7000.0d0, 50.0d0, 8000.0d0, 55.0d0, 9000.0d0, 60.0d0,                
     &    10000.0d0, 75.0d0,11000.0d0, 90.0d0,12000.0d0,105.0d0,                
     &    13000.0d0,120.0d0,14000.0d0,135.0d0,15000.0d0,150.0d0,                
     &    16000.0d0,180.0d0,  1.e20, 0.0d0/                                     
      data low77/                                                               
     &     501.0d0, 87.0d0,103.0d0,115.0d0,125.0d0,132.0d0,209.0d0,             
     &    1001.0d0,102.0d0,131.0d0,152.0d0,172.0d0,187.0d0,307.0d0,             
     &    1501.0d0, 91.0d0,127.0d0,156.0d0,184.0d0,204.0d0,347.0d0,             
     &    2001.0d0, 68.0d0,111.0d0,146.0d0,183.0d0,209.0d0,362.0d0,             
     &    2501.0d0, 39.0d0, 89.0d0,128.0d0,173.0d0,203.0d0,363.0d0,             
     &    3001.0d0, 10.0d0, 60.0d0,106.0d0,157.0d0,192.0d0,354.0d0,             
     &    3501.0d0,  5.0d0, 29.0d0, 79.0d0,137.0d0,177.0d0,336.0d0,             
     &    4001.0d0,  3.0d0,  5.0d0, 49.0d0,115.0d0,158.0d0,314.0d0,             
     &    4501.0d0,   0.0d0, 4.0d0, 17.0d0, 89.0d0,136.0d0,288.0d0,             
     &    5001.0d0,   0.0d0, 3.0d0,  8.0d0, 62.0d0,113.0d0,255.0d0,             
     &    5501.0d0,   0.0d0, 0.0d0,  4.0d0, 33.0d0, 89.0d0,220.0d0,             
     &    6001.0d0,   0.0d0, 0.0d0,  3.0d0, 13.0d0, 62.0d0,183.0d0,             
     &    6501.0d0,   0.0d0, 0.0d0,  0.0d0,  7.0d0, 34.0d0,143.0d0,             
     &    7001.0d0,   0.0d0, 0.0d0,  0.0d0,  3.0d0, 15.0d0,112.0d0,             
     &    7501.0d0,   0.0d0, 0.0d0,  0.0d0,  0.0d0,  8.0d0, 83.0d0,             
     &    8001.0d0,   0.0d0, 0.0d0,  0.0d0,  0.0d0,  4.0d0, 52.0d0,             
     &    8501.0d0,   0.0d0, 0.0d0,  0.0d0,  0.0d0,  0.0d0, 21.0d0,             
     &    9001.0d0,   0.0d0, 0.0d0,  0.0d0,  0.0d0,  0.0d0,  5.0d0,             
     &       1.e20,    .0d0,  .0d0,   .0d0,   .0d0,   .0d0,   .0d0/             
      data low81/                                                               
     &   501.0d0, 105.0d0, 120.0d0, 130.0d0, 140.0d0, 150.0d0, 230.0d0,         
     &  1001.0d0, 130.0d0, 155.0d0, 180.0d0, 205.0d0, 225.0d0, 325.0d0,         
     &  1501.0d0, 120.0d0, 160.0d0, 195.0d0, 230.0d0, 250.0d0, 355.0d0,         
     &  2001.0d0, 110.0d0, 155.0d0, 190.0d0, 235.0d0, 265.0d0, 370.0d0,         
     &  2501.0d0,  80.0d0, 135.0d0, 180.0d0, 225.0d0, 260.0d0, 375.0d0,         
     &  3001.0d0,  50.0d0, 110.0d0, 160.0d0, 215.0d0, 245.0d0, 365.0d0,         
     &  3501.0d0,  30.0d0,  80.0d0, 135.0d0, 200.0d0, 240.0d0, 345.0d0,         
     &  4001.0d0,  20.0d0,  50.0d0, 105.0d0, 185.0d0, 230.0d0, 320.0d0,         
     &  4501.0d0,  10.0d0,  30.0d0,  75.0d0, 160.0d0, 210.0d0, 290.0d0,         
     &  5001.0d0,   5.0d0,  15.0d0,  50.0d0, 135.0d0, 190.0d0, 270.0d0,         
     &  5501.0d0,   0.0d0,  10.0d0,  30.0d0, 115.0d0, 160.0d0, 230.0d0,         
     &  6001.0d0,   0.0d0,   5.0d0,  15.0d0,  80.0d0, 140.0d0, 190.0d0,         
     &  6501.0d0,   0.0d0,   0.0d0,  10.0d0,  50.0d0, 120.0d0, 150.0d0,         
     &  7001.0d0,   0.0d0,   0.0d0,   5.0d0,  35.0d0,  95.0d0, 120.0d0,         
     &  7501.0d0,   0.0d0,   0.0d0,   0.0d0,  25.0d0,  65.0d0,  90.0d0,         
     &  8001.0d0, 3*0.0d0,  15.0d0,  40.0d0,  60.0d0,                           
     &  8501.0d0, 3*0.0d0,   5.0d0,  25.0d0,  45.0d0,                           
     &  9001.0d0, 4*0.0d0,  15.0d0,  30.0d0,                                    
     &  9501.0d0, 4*0.0d0,   5.0d0,  20.0d0,                                    
     & 10001.0d0, 5*0.0d0,  10.0d0, 1.e20,6*0.0d0/                              
      data low94/                                                               
     &  501.0d0, 120.0d0, 150.0d0, 175.0d0, 200.0d0, 225.0d0, 320.0d0,          
     & 1001.0d0, 135.0d0, 185.0d0, 225.0d0, 265.0d0, 300.0d0, 415.0d0,          
     & 1501.0d0, 135.0d0, 190.0d0, 235.0d0, 290.0d0, 325.0d0, 435.0d0,          
     & 2001.0d0, 135.0d0, 190.0d0, 235.0d0, 290.0d0, 325.0d0, 450.0d0,          
     & 2501.0d0, 135.0d0, 190.0d0, 240.0d0, 290.0d0, 325.0d0, 450.0d0,          
     & 3001.0d0, 135.0d0, 190.0d0, 240.0d0, 290.0d0, 325.0d0, 450.0d0,          
     & 3501.0d0, 135.0d0, 190.0d0, 240.0d0, 290.0d0, 325.0d0, 450.0d0,          
     & 4001.0d0, 135.0d0, 190.0d0, 240.0d0, 300.0d0, 335.0d0, 450.0d0,          
     & 4501.0d0, 135.0d0, 190.0d0, 240.0d0, 300.0d0, 355.0d0, 450.0d0,          
     & 5001.0d0, 115.0d0, 150.0d0, 205.0d0, 300.0d0, 355.0d0, 450.0d0,          
     & 5501.0d0,  95.0d0, 130.0d0, 165.0d0, 260.0d0, 355.0d0, 430.0d0,          
     & 6001.0d0,  75.0d0, 110.0d0, 145.0d0, 220.0d0, 315.0d0, 410.0d0,          
     & 6501.0d0,  55.0d0,  90.0d0, 125.0d0, 180.0d0, 275.0d0, 370.0d0,          
     & 7001.0d0,  35.0d0,  70.0d0, 105.0d0, 140.0d0, 235.0d0, 330.0d0,          
     & 7501.0d0,  15.0d0,  50.0d0,  85.0d0, 120.0d0, 195.0d0, 290.0d0,          
     & 8001.0d0,  10.0d0,  20.0d0,  50.0d0,  80.0d0, 130.0d0, 220.0d0,          
     & 8501.0d0,  10.0d0,  20.0d0,  30.0d0,  60.0d0,  90.0d0, 180.0d0,          
     & 9001.0d0,  10.0d0,  20.0d0,  30.0d0,  40.0d0,  70.0d0, 140.0d0,          
     & 9501.0d0,  10.0d0,  20.0d0,  30.0d0,  40.0d0,  60.0d0, 100.0d0,          
     &10001.0d0,  10.0d0,  20.0d0,  30.0d0,  40.0d0,  50.0d0,  80.0d0,          
     &11501.0d0,  10.0d0,  20.0d0,  30.0d0,  40.0d0,  50.0d0,  60.0d0,          
     &14001.0d0,   5.0d0,  10.0d0,  15.0d0,  20.0d0,  25.0d0,  30.0d0,          
     &            1.e20,   6*0.0d0/                                             
      data low98/                                                               
     &  501.0d0, 120.0d0, 160.0d0, 200.0d0, 240.0d0, 280.0d0, 320.0d0,          
     & 1001.0d0, 135.0d0, 195.0d0, 250.0d0, 310.0d0, 350.0d0, 415.0d0,          
     & 1501.0d0, 135.0d0, 195.0d0, 250.0d0, 310.0d0, 350.0d0, 435.0d0,          
     & 3501.0d0, 135.0d0, 195.0d0, 250.0d0, 310.0d0, 350.0d0, 450.0d0,          
     & 4501.0d0, 135.0d0, 195.0d0, 250.0d0, 310.0d0, 355.0d0, 450.0d0,          
     & 5001.0d0, 125.0d0, 190.0d0, 240.0d0, 305.0d0, 355.0d0, 450.0d0,          
     & 5501.0d0, 115.0d0, 175.0d0, 230.0d0, 295.0d0, 355.0d0, 430.0d0,          
     & 6001.0d0, 105.0d0, 155.0d0, 210.0d0, 260.0d0, 315.0d0, 410.0d0,          
     & 7001.0d0,  90.0d0, 130.0d0, 170.0d0, 220.0d0, 275.0d0, 370.0d0,          
     & 8001.0d0,  80.0d0, 115.0d0, 145.0d0, 180.0d0, 225.0d0, 295.0d0,          
     & 9001.0d0,  70.0d0, 105.0d0, 135.0d0, 170.0d0, 195.0d0, 240.0d0,          
     &10001.0d0,  65.0d0,  95.0d0, 115.0d0, 145.0d0, 175.0d0, 205.0d0,          
     &11001.0d0,  60.0d0,  80.0d0, 100.0d0, 130.0d0, 155.0d0, 185.0d0,          
     &12001.0d0,  55.0d0,  70.0d0,  90.0d0, 110.0d0, 135.0d0, 160.0d0,          
     &14001.0d0,  50.0d0,  65.0d0,  85.0d0, 100.0d0, 115.0d0, 140.0d0,          
     &15001.0d0,  45.0d0,  60.0d0,  75.0d0,  90.0d0, 105.0d0, 120.0d0,          
     &16001.0d0,  40.0d0,  55.0d0,  70.0d0,  85.0d0,  95.0d0, 110.0d0,          
     &17001.0d0,  35.0d0,  50.0d0,  65.0d0,  80.0d0,  85.0d0, 105.0d0,          
     &18001.0d0,  30.0d0,  45.0d0,  60.0d0,  70.0d0,  80.0d0,  95.0d0,          
     &19001.0d0,  25.0d0,  35.0d0,  50.0d0,  60.0d0,  70.0d0,  80.0d0,          
     &20001.0d0,  20.0d0,  30.0d0,  40.0d0,  50.0d0,  60.0d0,  65.0d0,          
     &21001.0d0,  15.0d0,  25.0d0,  30.0d0,  40.0d0,  50.0d0,  55.0d0,          
     &22001.0d0,  10.0d0,  20.0d0,  25.0d0,  35.0d0,  40.0d0,  45.0d0,          
     & 1.e20,6* 0.0d0/                                                          
       data low21/                                                              
     & 1001.0d0, 195.0d0, 260.0d0, 325.0d0, 390.0d0, 455.0d0, 520.0d0,          
     & 1501.0d0, 220.0d0, 315.0d0, 405.0d0, 505.0d0, 570.0d0, 675.0d0,          
     & 2501.0d0, 220.0d0, 315.0d0, 405.0d0, 505.0d0, 570.0d0, 705.0d0,          
     & 7501.0d0, 220.0d0, 315.0d0, 405.0d0, 505.0d0, 570.0d0, 730.0d0,          
     & 8001.0d0, 205.0d0, 310.0d0, 390.0d0, 495.0d0, 575.0d0, 730.0d0,          
     & 9001.0d0, 185.0d0, 285.0d0, 375.0d0, 480.0d0, 575.0d0, 700.0d0,          
     &10001.0d0, 170.0d0, 250.0d0, 340.0d0, 425.0d0, 510.0d0, 665.0d0,          
     &11501.0d0, 145.0d0, 210.0d0, 275.0d0, 360.0d0, 445.0d0, 600.0d0,          
     &13001.0d0, 130.0d0, 185.0d0, 235.0d0, 295.0d0, 365.0d0, 480.0d0,          
     &14501.0d0, 115.0d0, 170.0d0, 220.0d0, 275.0d0, 315.0d0, 390.0d0,          
     &16501.0d0, 105.0d0, 155.0d0, 185.0d0, 235.0d0, 285.0d0, 335.0d0,          
     &18001.0d0, 100.0d0, 130.0d0, 165.0d0, 210.0d0, 250.0d0, 300.0d0,          
     &19501.0d0,  90.0d0, 115.0d0, 145.0d0, 180.0d0, 220.0d0, 260.0d0,          
     &21001.0d0,  80.0d0, 105.0d0, 140.0d0, 165.0d0, 185.0d0, 230.0d0,          
     &23001.0d0,  80.0d0, 105.0d0, 140.0d0, 165.0d0, 185.0d0, 230.0d0,          
     &24501.0d0,  75.0d0, 100.0d0, 120.0d0, 145.0d0, 170.0d0, 195.0d0,          
     &26001.0d0,  65.0d0,  90.0d0, 115.0d0, 140.0d0, 155.0d0, 180.0d0,          
     &27501.0d0,  55.0d0,  80.0d0, 105.0d0, 130.0d0, 140.0d0, 170.0d0,          
     &29501.0d0,  50.0d0,  75.0d0, 100.0d0, 115.0d0, 130.0d0, 155.0d0,          
     &31001.0d0,  40.0d0,  55.0d0,  80.0d0, 100.0d0, 115.0d0, 130.0d0,          
     &32501.0d0,  35.0d0,  50.0d0,  65.0d0,  80.0d0, 100.0d0, 105.0d0,          
     &34001.0d0,  25.0d0,  40.0d0,  50.0d0,  65.0d0,  80.0d0,  90.0d0,          
     &36001.0d0,  15.0d0,  35.0d0,  40.0d0,  55.0d0,  65.0d0,  75.0d0,          
     & 1.e20,6* 0.0d0/                                                          
                                                                                
      data l77/38*0.0d0/                                                        
      data l81/42*0.0d0/                                                        
      data l94/46*0.0d0/                                                        
      data l98/48*0.0d0/                                                        
c      data std84/2230.,3400.,1700.,2230.,3400.,1700.,2230./                    
c      data std85/2390.,3540.,1770.,2390.,3540.,1770.,2390./                    
      data std86/3000.0d0,4000.0d0,2000.0d0,3500.0d0,4000.0d0,                  
     & 2000.0d0,3500.0d0/                                                       
      data std90/3250.0d0,5450.0d0,2725.0d0,4750.0d0,5450.0d0,                  
     & 2725.0d0,4750.0d0/                                                       
      data xmp/2*750.0d0,5*1000.0d0,2*0.0d0,4*2000.0d0,                         
     & 2050.0d0,9*0.0d0/                                                        
      data food/2*0.0d0,2*40.0d0,5*45.0d0,4*52.50d0/                            
      data foods/6000.0d0,52.50d0, 9000.0d0,38.0d0,10500.0d0,                   
     & 14.0d0,1.e20,0.0d0/                                                      
      data foodm/9000.0d0,52.50d0,14000.0d0,38.0d0,16000.0d0,                   
     & 14.0d0,1.e20,0.0d0/                                                      
      data amed/4*5.0d0,9*7.50d0,5*0.0d0/                                       
      data adf/4*1.0d0,.74410d0,.66410d0,4*.8670d0,8*1.0d0/                     
      data chlim/                                                               
     &     9*13936.0d0,   15808.0d0,  5*17680.0d0,  18200.0d0,                  
     &       20137.0d0,10*21424.0d0,    27248.0d0,13*30160.0d0/                 
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      if(law.le.1986) then                                                      
        do 10 i=1,19                                                            
          tabs(2,i)=(nint(10.*tab77s(2,i)*adf(law)))/10.                        
          tabm(2,i)=(nint(10.*tab77m(2,i)*adf(law)))/10.                        
          tabsp(2,i)=(nint(10.*tb77sp(2,i)*adf(law)))/10.                       
10      continue                                                                
        if(law.ge.1983) then                                                    
          tabs(2,14)=5.6                                                        
          tabm(2,14)=5.6                                                        
          tabsp(2,14)=5.6                                                       
        endif                                                                   
      endif                                                                     
c     AGI                                                                       
      agi = comnew(2)-data(22)                                                  
c Social Security Benefits are not taxable in NM 1984-1989                      
      if(law.ge.1984.and.law.le.1989) agi = agi + comnew(79)                    
c Net Capital gains deduction                                                   
      cgded = 0.d0                                                              
      if(comnew(6).gt.0) then                                                   
        if(law.ge.1999.and.law.le.2002) cgded = min(comnew(6),1000.0d0)         
        if(law.eq.2003)cgded = min(comnew(6),max(1000.0d0,.1*comnew(6)))        
        if(law.eq.2004)cgded = min(comnew(6),max(1000.0d0,.2*comnew(6)))        
        if(law.eq.2005)cgded = min(comnew(6),max(1000.0d0,.3*comnew(6)))        
        if(law.eq.2006.or.law.ge.2019)                                          
     &  cgded = min(comnew(6),max(1000.0d0,.4*comnew(6)))                       
        if(law.ge.2007.and.law.le.2018)                                         
     &  cgded = min(comnew(6),max(1000.0d0,.5*comnew(6)))                       
      endif                                                                     
      cgded = cgded/sep                                                         
      agi = agi - cgded                                                         
c Deduction for persons age 65 and older or blind                               
      elded = 0.                                                                
      if(mst.eq.1)mstat=1                                                       
      if(mst.eq.3.or.mst.eq.6)mstat=2                                           
      if(mst.eq.2.or.mst.eq.4.or.mst.eq.5.or.mst.eq.7)mstat=3                   
      if(data(9)+data(10).gt.0.) then                                           
       if(law.ge.1981.and.law.le.1984) then                                     
        elded=6000*data(9)                                                      
       else if(law.eq.1985.or.law.eq.1986) then                                 
        if(mstat.eq.2)elded=tablki(eldp85,7,agi,data)*data(9)                   
        if(mstat.eq.1)elded=tablki(elds85,7,agi,data)*data(9)                   
        if(mstat.eq.3)elded=tablki(eldm85,7,agi,data)*data(9)                   
       else if(law.ge.1987) then                                                
        nold=int(min(data(10)+data(9),data(7)))                                      
        if(mstat.eq.2)elded=tablki(eldp87,9,agi,data)*nold                      
        if(mstat.eq.1)elded=tablki(elds87,9,agi,data)*nold                      
        if(mstat.eq.3)elded=tablki(eldm87,9,agi,data)*nold                      
       endif                                                                    
      endif                                                                     
c itemized Deductions                                                           
      xitded = 0.                                                               
      if(comnew(26).gt.0) then                                                  
        xitded = max(0.d0,                                                      
     &  comnew(24) - min(comnew(24)-comnew(3),data(50)))                        
      endif                                                                     
c Standard Deduction                                                            
      if(law.le.1985.or.law.ge.1991) then                                       
        stded=comnew(3)                                                         
      else if(law.ge.1986.and.law.le.1989) then                                 
        stded=std86(mst)                                                        
      else if(law.eq.1990) then                                                 
        stded=std90(mst)                                                        
      endif                                                                     
      if(law.ge.1982.and.law.le.1985)stded=stded+comnew(81)                     
      deduc = max(xitded,stded)                                                 
c Exemptions                                                                    
      if(law.eq.1984.or.law.eq.1985.or.law.ge.1991) then                        
        exemp=comnew(83)                                                        
      else                                                                      
        exemp=xmp(law)*comnew(68)                                               
      endif                                                                     
c since 2006 low- and middle-income tax exemption (additional)                  
      if(law.ge.2006) then                                                      
        if(mst.eq.1) agilow = exlow(1,law)                                      
        if(mst.ne.1) agilow = exlow(2,law)/sep                                  
        if(comnew(2).le.agilow) then                                            
         if(law.eq.2006)phase = filing(mst,16000.,24000.,24000.,12000.)         
         if(law.ge.2007)phase = filing(mst,20000.,30000.,30000.,15000.)         
         perc  = filing(mst,.15,.1,.1,.2)                                       
         exemp = exemp +                                                        
     &   comnew(68)*max(0.0d0,2500. - perc*max(0.0d0,comnew(2)-phase))          
        endif                                                                   
      endif                                                                     
      if(data(105).gt.0.d0) exemp = 0.d0                                        
c Medical Care Expenses - New in 2000                                           
      med = 0.                                                                  
      if(law.ge.2000) then                                                      
        if(comnew(26).lt.1.0d0) then                                            
          medexp=data(47)+data(48)+data(49)                                     
        else                                                                    
          medexp=data(47)+data(48)+data(49)-comnew(20)                          
        endif                                                                   
        if(medexp.gt.0) then                                                    
           if(mst.eq.4.or.mst.eq.7) then                                        
              if(agi.lt.20000) med=.25*medexp                                   
              if(agi.ge.20000.and.agi.lt.50000) med=.15*medexp                  
              if(agi.ge.50000) med=.1*medexp                                    
           else if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                       
              if(agi.lt.15000) med=.25*medexp                                   
              if(agi.ge.15000.and.agi.lt.35000) med=.15*medexp                  
              if(agi.ge.35000) med=.1*medexp                                    
           else                                                                 
              if(agi.lt.30000) med=.25*medexp                                   
              if(agi.ge.30000.and.agi.lt.70000) med=.15*medexp                  
              if(agi.ge.70000) med=.1*medexp                                    
           endif                                                                
        endif                                                                   
      endif                                                                     
c 2019+ Deduction for Certain Dependents for hoh or joint                       
c Taxable Income                                                                
      cerdep = 0.d0                                                             
      if(law.ge.2019.and.(mst.eq.4.or.mst.eq.7.or.mst.eq.2).                    
     *   and.data(105).le.1.d0) then                                            
         cerdep = 4000.*max(0.0d0,data(8)-1.)                                   
      endif                                                                     
      taxinc = max(0.0d0,agi-elded-deduc-exemp-med-cerdep)                      
c      write(0,*) 'taxinc',taxinc                                               
c Statax Calculation                                                            
c before 1986                                                                   
      if(law.le.1986) then                                                      
        if(mstat.eq.1)                                                          
     &   call look(tabs,taxinc,19,n,statax,1.0d00,0.0d0,rt,data)                
        if(mstat.eq.2)                                                          
     &   call look(tabsp,taxinc,19,n,statax,1.0d00,0.0d0,rt,data)               
        if(mstat.eq.3)                                                          
     &   call look(tabm,taxinc,19,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.le.2005) then                                                 
c 1986 - 2005                                                                   
        if(mst.eq.2.or.mst.eq.3.or.mst.eq.6)mstat=3                             
        if(mst.eq.4.or.mst.eq.7)mstat=2                                         
        if(mst.eq.1)mstat=1                                                     
c single                                                                        
        if(mstat.eq.1) then                                                     
           if(law.ge.1987.and.law.le.1993) then                                 
             call look(tab87s,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)           
           else if(law.eq.1994) then                                            
             call look(tab94s,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)           
           else if(law.ge.1995.and.law.le.1997) then                            
             call look(tab95s,taxinc,10,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.ge.1998.and.law.le.2002) then                            
             call look(tab98s,taxinc,10,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.eq.2003) then                                            
             call look(tab03s,taxinc,10,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.eq.2004) then                                            
             call look(tab04s,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)           
           else if(law.eq.2005) then                                            
             call look(tab05s,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)           
           endif                                                                
c head of household                                                             
        else if(mstat.eq.2) then                                                
           if(law.ge.1987.and.law.le.1993) then                                 
              call look(tab87h,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.eq.1994) then                                            
              call look(tab94h,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.ge.1995.and.law.le.1997) then                            
              call look(tab95h,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.ge.1998.and.law.le.2002) then                            
              call look(tab98h,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.eq.2003) then                                            
              call look(tab03h,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.eq.2004) then                                            
              call look(tab04h,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)          
           else if(law.eq.2005) then                                            
              call look(tab05h,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)          
           endif                                                                
        else                                                                    
c married                                                                       
           taxy=taxinc*sep                                                      
           if(law.ge.1987.and.law.le.1993) then                                 
              call look(tab87m,taxy,7,n,statax,1.0d00,0.0d0,rt,data)            
           else if(law.eq.1994) then                                            
              call look(tab94m,taxy,7,n,statax,1.0d00,0.0d0,rt,data)            
           else if(law.eq.1995) then                                            
              if(sep.lt.2.)then                                                 
                call look(tab95m,taxinc,9,n,statax,1.0d00,0.0d0,rt,data)        
              else                                                              
              call look(tab95e,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)          
              endif                                                             
           else if(law.eq.1996.or.law.eq.1997) then                             
              call look(tab96m,taxy,8,n,statax,1.0d00,0.0d0,rt,data)            
           else if(law.ge.1998.and.law.le.2002) then                            
              call look(tab98m,taxy,8,n,statax,1.0d00,0.0d0,rt,data)            
           else if(law.eq.2003) then                                            
              call look(tab03m,taxy,7,n,statax,1.0d00,0.0d0,rt,data)            
           else if(law.eq.2004) then                                            
              call look(tab04m,taxy,5,n,statax,1.0d00,0.0d0,rt,data)            
           else if(law.eq.2005) then                                            
              call look(tab05m,taxy,4,n,statax,1.0d00,0.0d0,rt,data)            
           endif                                                                
           if(law.ne.1995) statax=statax/sep                                    
        endif                                                                   
      else if (law.ge.2006) then                                                
        if(mst.eq.1) then                                                       
           if(law.eq.2006.or.law.eq.2007) then                                  
             call look(tab06s,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)           
           else if(law.ge.2008.and.law.le.2020) then                            
             call look(tab08s,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)           
           else if(law.ge.2021) then                                            
             call look(tab21s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)           
           endif                                                                
        else                                                                    
           taxy = taxinc*sep                                                    
           if(law.eq.2006.or.law.eq.2007) then                                  
             call look(tab06m,taxy,4,n,statax,1.0d00,0.0d0,rt,data)             
           else if(law.ge.2008.and.law.le.2020) then                            
             call look(tab08m,taxy,4,n,statax,1.0d00,0.0d0,rt,data)             
           else if(law.ge.2021) then                                            
             call look(tab21m,taxy,5,n,statax,1.0d00,0.0d0,rt,data)             
           endif                                                                
           statax = statax/sep                                                  
        endif                                                                   
      endif                                                                     
                                                                                
c  all credits are refundable                                                   
      credit=0.                                                                 
c Low Income Comprehensive Tax Rebate                                           
      ncred=int(min(data(7)+data(8)+data(9)+data(10),6.0d0))                         
      modagi = data(11)+data(91)+data(82)+max(0.0d0,data(17))                   
     &+max(0.0d0,data(70))+max(0.0d0,data(68))+data(12)+data(14)                
     &+max(0.0d0,data(24))+data(23)+data(20)+data(72)+data(19)                  
     &+max(0.0d0,data(211))+max(0.0d0,data(212))+max(0.0d0,data(213))           
     &+max(0.0d0,data(214))+max(0.0d0,data(215))                                
c     actually starts in 1984?                                                  
      if(law.ge.1985)ncred=int(min(ncred+data(9)+data(10),6.0d0))                    
      ycred=0.                                                                  
      if(ncred.gt.0) then                                                       
       if(law.le.1980) then                                                     
c before 1980                                                                   
        do 15 i=1,19                                                            
          l77(1,i)=low77(0,i)                                                   
          l77(2,i)=low77(ncred,i)                                               
15      continue                                                                
        ycred = tablki(l77,19,modagi,data)                                      
c 1981 - 1993                                                                   
       else if(law.ge.1981.and.law.le.1993) then                                
        do 25 i=1,21                                                            
          l81(1,i) = low81(0,i)                                                 
          l81(2,i) = low81(ncred,i)                                             
25      continue                                                                
        ycred = tablki(l81,21,modagi,data)                                      
c 1994 -1997                                                                    
       else if(law.ge.1994.and.law.le.1997) then                                
        do 35 i=1,23                                                            
          l94(1,i) = low94(0,i)                                                 
          l94(2,i) = low94(ncred,i)                                             
35      continue                                                                
        ycred = tablki(l94,23,modagi,data)                                      
c 1998 - 2020                                                                   
       else if(law.ge.1998.and.law.le.2020) then                                
        do 45 i=1,24                                                            
          l98(1,i) = low98(0,i)                                                 
          l98(2,i) = low98(ncred,i)                                             
45      continue                                                                
        ycred = tablki(l98,24,modagi,data)                                      
c 2021+                                                                         
       else if(law.ge.2021) then                                                
        do 55 i=1,24                                                            
          l21(1,i) = low21(0,i)                                                 
          l21(2,i) = low21(ncred,i)                                             
55      continue                                                                
        ycred = tablki(l21,24,modagi,data)                                      
                                                                                
c       write(0,*) '1 ycred modagi',ycred,modagi                                
       endif                                                                    
      endif                                                                     
      if(data(105).gt.0.d0) ycred = 0.d0                                        
c  low income food and medical crdt                                             
      xtra = 0.                                                                 
      if(law.le.1985) then                                                      
        xtra = (food(law)*ncred) + max(amed(law)*ncred,.04*comnew(20))          
      else if(law.ge.1986.and.law.le.1989) then                                 
        if(ycred.gt.0.) xtra = (data(7)+data(8))*food(law)                      
      else if(law.eq.1990) then                                                 
        if(mst.eq.1) then                                                       
          xtra = tablki(foods,4,data(159),data)*(data(7)+data(8))               
        else                                                                    
          xtra = tablki(foodm,4,data(159)/sep,                                  
     &     data)*(data(7)+data(8))                                              
        endif                                                                   
      endif                                                                     
c child day care credit only since 1981                                         
      child=0.                                                                  
      exp=0.                                                                    
      chcr=0.                                                                   
      if(law.ge.1981) then                                                      
       if(modagi.lt.chlim(law)) then                                            
        child = min(data(8),4.0d0)                                              
        exp = min(.4*data(64),480.*child)                                       
        chcr = max(0.0d0,min(1200.0d0,exp)-comnew(53))                          
       endif                                                                    
      endif                                                                     
c  property tax rebate for persons 65 or over                                   
c  with a Modified AGI of $16k or less                                          
      pcred=0.                                                                  
      if(data(9).gt.0..and.modagi.le.16000.) then                               
       pmax=tablki(proptb,17,modagi,data)                                       
       ptax=data(51)+.06*data(160)                                              
       pcred=twn(ptax-pmax,0.0d0,250.d0/sep)                                    
      endif                                                                     
c Since 2007 -- Working families tax credit                                     
      earncr = 0.                                                               
      if(law.ge.2007) earncr = eicr(law)*comnew(59)                             
      credit = ycred + xtra + chcr + pcred + earncr                             
c      write(0,*) 'ycred xtra chcr pcred earncr',ycred,xtra,chcr,               
c     & pcred,earncr                                                            
                                                                                
      statax = statax - credit                                                  
      return                                                                    
      end                                                                       
c  NEW YORK                                                                    
c  state 33                                                                    
c  Updated through 2021 (03/18/2022)                                           
      subroutine nytax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/rates/mrate                                                        
      double precision mrate,famded, lowfam(2,9)                                
      dimension data(255),comnew(255),aif92(1991:2012)                          
      dimension hifam1(2,7), hifam2(2,9), famtab(2,4)                           
c tax rates for NY State Tax                                                    
      dimension tab(2,15), tab86(2,13),chld96(2,12),earate(1994:2021)           
      dimension tb(2,15)                                                        
      dimension tab87m(2,8), tab87s(2,8),tab87h(2,8)                            
      dimension tab88m(2,7), tab88s(2,7), tab88h(2,7), ptab85(2,8)              
      dimension tab89m(2,5), tab89s(2,5), tab89h(2,5)                           
      dimension tab95m(2,4), tab95s(2,7), tab95h(2,4)                           
      dimension tab96m(2,5), tab96s(2,5), tab96h(2,5)                           
      dimension tab97m(2,5), tab97s(2,5), tab97h(2,5)                           
      dimension tab03m(2,6), tab03s(2,6), tab03h(2,6)                           
      dimension tab04m(2,7), tab04s(2,7), tab04h(2,7)                           
      dimension tb04m(2,7), tb04s(2,7), tb04h(2,7)                              
      dimension tab06m(2,5), tab06s(2,5), tab06h(2,5)                           
      dimension tab09m(2,7), tab09s(2,7), tab09h(2,7)                           
      dimension tab12m(2,8), tab12s(2,8), tab12h(2,8)                           
      dimension tab18m(2,8), tab18s(2,8), tab18h(2,8),tab18(2,8)                
      dimension tab21m(2,10), tab21s(2,10), tab21h(2,10),tab21(2,10)            
                                                                                
      dimension pmxt78(2,4), emax78(2,4), ptab78(2,4), etab78(2,4)              
      dimension emax81(2,3), ptab81(2,4), etab81(2,5), ptab82(2,5)              
      dimension ed(2001:2021), perc(2001:2021), aif12(2012:2021)                
      double precision max78(2,3),max80(2,4),max81(2,5),max85(2,6),             
     & max86(2,6),old(2,18),young(2,18)                                         
      dimension stdr(1977:1984),stdmax(1977:1984)                               
      dimension stdm(1977:2021),stds(1977:2021),stdh(1977:2021),                
     & stdd(1987:2021)                                                          
      dimension xded(7),xmp(1977:2021),                                         
     & phitem(2018:2021),phites(2018:2021),phiteh(2018:2021)                    
      dimension htab1(2,5),htabs(2,7),htabm(2,9),htabd(2,4)                     
      integer sep                                                               
      dimension add12(7,2012:2021),rtmax(0:3,2012:2021),ss(2018:2025)           
      data phitem /320000.d0,327750.d0,334000.d0,338850.d0/                     
      data phites /266700.d0,273150.d0,278300.d0,282400.d0/                     
      data phiteh /293350.d0,300450.d0,306150.d0,310600.d0/                     
      data ss/    128400.d0, 135900.d0,142500.d0,148800.d0,155100.d0,           
     & 161700.d0, 168300.d0, 175200.d0/                                         
      data rtmax/                                                               
     2  .0645d0,.0665d0,.0685d0,.0882d0,                                        
     3  .0645d0,.0665d0,.0685d0,.0882d0,                                        
     4  .0645d0,.0665d0,.0685d0,.0882d0,                                        
     5  .0645d0,.0665d0,.0685d0,.0882d0,                                        
     6  .0645d0,.0665d0,.0685d0,.0882d0,                                        
     7  .0645d0,.0665d0,.0685d0,.0882d0,                                        
     8  .0633d0,.0657d0,.0685d0,.0882d0,                                        
     9  .0621d0,.0649d0,.0685d0,.0882d0,                                        
     &  .0609d0,.0641d0,.0685d0,.0882d0,                                        
     1  .0597d0,.0633d0,.0685d0,.0695d0/                                        
c rtmax and add12 from IT-201(Tax Computation Worksheets)                       
      data add12/                                                               
     2  634.0d0, 934.0d0, 1534.0d0, 467.0d0, 867.0d0,675.0d0,1175.0d0,          
     3  652.0d0, 961.0d0, 1578.0d0, 480.0d0, 892.0d0,695.0d0,1209.0d0,          
     4  662.0d0, 976.0d0, 1604.0d0, 487.0d0, 905.0d0,706.0d0,1229.0d0,          
     5  672.0d0, 991.0d0, 1628.0d0, 494.0d0, 919.0d0,716.0d0,1247.0d0,          
     6  677.0d0, 998.0d0, 1640.0d0, 497.0d0, 925.0d0,720.0d0,1255.0d0,          
     7  681.0d0,1004.0d0, 1650.0d0, 500.0d0, 930.0d0,725.0d0,1263.0d0,          
     8  629.0d0,1017.0d0, 1922.0d0, 506.0d0,1109.0d0,729.0d0,1483.0d0,          
     9  577.0d0,1030.0d0, 2193.0d0, 513.0d0,1288.0d0,733.0d0,1703.0d0,          
     &  526.0d0,1043.0d0, 2465.0d0, 519.0d0,1467.0d0,738.0d0,1923.0d0,          
     1  526.0d0,1056.0d0, 2736.0d0, 526.0d0,1646.0d0,742.0d0,2143.0d0/          
                                                                                
      data aif12 /1.0d0,1.025d0,1.0375d0, 1.05d0,1.05625d0,1.075d0,             
     & 4*1.0765d0 /                                                             
      data perc/ .25d0,  .5d0,   .75d0, 18*1.0d0/                               
      data ed/ 50.0d0,100.0d0,150.0d0 , 18*200.0d0/                             
c earate from IT-215                                                            
      data earate/.075d0,.1d0,4*.2d0,.225d0,.25d0,.275d0,19*.3d0/               
      data aif92/                                                               
     &      1.0d0,     1.0525d0, 1.0845d0, 1.118d0 , 1.147d0 , 1.1795d0,        
     &    1.212d0,     1.2450d0, 1.2660d0, 1.2895d0, 1.3295d0, 1.3730d0,        
     &    1.395d0,     1.4270d0, 1.4595d0, 1.5050d0, 1.5640d0, 1.5995d0,        
     &    1.668d0,   2*1.6955d0, 1.7365d0/                                      
      data lowfam/                                                              
     &     31000.0d0,    .0d0, 32000.0d0, 500.0d0, 33000.0d0, 1000.0d0,         
     &     34000.0d0,1500.0d0, 35000.0d0,2000.0d0, 36000.0d0, 2500.0d0,         
     &     37000.0d0,    .0d0, 38000.0d0,    .0d0,     1.e20,   1.e20/          
      data hifam1/                                                              
     &     31000.0d0,3000.0d0, 32000.0d0,2500.0d0, 33000.0d0, 2000.0d0,         
     &     34000.0d0,1500.0d0, 35000.0d0,1000.0d0, 36000.0d0,  500.0d0,         
     &         1.e20,    .0d0/                                                  
      data hifam2/                                                              
     &      31000.0d0,4000.0d0, 32000.0d0,3500.0d0, 33000.0d0, 3000.0d0,        
     &      34000.0d0,2500.0d0, 35000.0d0,2000.0d0, 36000.0d0, 1500.0d0,        
     &      37000.0d0,1000.0d0, 38000.0d0, 500.0d0,     1.e20,     .0d0/        
      data chld96/                                                              
     &      10000.0d0, .3d0  , 10400.0d0, .295d0, 10800.0d0, .285d0,            
     &      11200.0d0, .275d0, 11600.0d0, .265d0, 12000.0d0, .255d0,            
     &      12400.0d0, .245d0, 12800.0d0, .235d0, 13200.0d0, .225d0,            
     &      13600.0d0, .215d0, 13999.0d0, .205d0,     1.e20, .2d0/              
      data tb/                                                                  
     &       1000.0d0,  2.0d0,  3000.0d0,  3.0d0,  5000.0d0,  4.0d0,            
     &       7000.0d0,  5.0d0,  9000.0d0,  6.0d0, 11000.0d0,  7.0d0,            
     &      13000.0d0,  8.0d0, 15000.0d0,  9.0d0, 17000.0d0, 10.0d0,            
     &      19000.0d0, 11.0d0, 21000.0d0, 12.0d0, 23000.0d0, 13.0d0,            
     &      25000.0d0,   .0d0, 30000.0d0,   .0d0,     1.e20,   .0d0/            
      data tab86/                                                               
     &       1000.0d0,  2.0d0,  3000.0d0,  3.0d0,  5000.0d0,  4.0d0,            
     &       7000.0d0,  5.0d0,  9000.0d0,  6.0d0, 11000.0d0,  7.0d0,            
     &      13500.0d0,  8.0d0, 16000.0d0,  9.0d0, 18500.0d0, 10.0d0,            
     &      21000.0d0, 11.0d0, 23500.0d0, 12.0d0, 26000.0d0, 13.0d0,            
     &          1.e20, 13.5d0/                                                  
c 1987                                                                          
      data tab87m/                                                              
     &       1700.0d0,  2.0d0,  5000.0d0,  3.0d0,  8300.0d0,  4.0d0,            
     &      11700.0d0,  5.0d0, 15000.0d0,  6.0d0, 18300.0d0,  7.0d0,            
     &      23300.0d0,  8.0d0,     1.e20,  8.5d0/                               
      data tab87s/                                                              
     &       1000.0d0,  2.0d0,  3000.0d0,  3.0d0,  5000.0d0,  4.0d0,            
     &       7000.0d0,  5.0d0,  9000.0d0,  6.0d0, 11000.0d0,  7.0d0,            
     &      14000.0d0,  8.0d0,     1.e20,  8.5d0/                               
      data tab87h/                                                              
     &       1300.0d0,  2.0d0,  3400.0d0,  3.0d0,  5600.0d0,  4.0d0,            
     &       7800.0d0,  5.0d0, 10100.0d0,  6.0d0, 12400.0d0,  7.0d0,            
     &      15400.0d0,  8.0d0,     1.e20,  8.5d0/                               
c 1988                                                                          
      data tab88m/                                                              
     &      6000.0d0,   3.0d0, 10200.0d0,  4.0d0, 14600.0d0,  5.0d0,            
     &     18800.0d0,   6.0d0, 24800.0d0,  7.0d0, 34000.0d0,  8.0d0,            
     &         1.e20,   8.375d0/                                                
      data tab88s/                                                              
     &      3000.0d0,   3.0d0,  5100.0d0,  4.0d0,  7300.0d0,  5.0d0,            
     &      9400.0d0,   6.0d0, 12400.0d0,  7.0d0, 17000.0d0,  8.0d0,            
     &         1.e20,   8.375d0/                                                
      data tab88h/                                                              
     &      3800.0d0,   3.0d0,  6000.0d0,  4.0d0,  8300.0d0,  5.0d0,            
     &     10500.0d0,   6.0d0, 13600.0d0,  7.0d0, 18300.0d0,  8.0d0,            
     &         1.e20,   8.375d0/                                                
c 1989                                                                          
      data tab89m/                                                              
     &     11000.0d0,   4.0d0, 16000.0d0,  5.0d0, 22000.0d0,  6.0d0,            
     &     26000.0d0,   7.0d0,     1.e20,  7.875d0/                             
      data tab89s/                                                              
     &      5500.0d0,   4.0d0,  8000.0d0,  5.0d0, 11000.0d0,  6.0d0,            
     &     13000.0d0,   7.0d0,     1.e20,  7.875d0/                             
      data tab89h/                                                              
     &      7500.0d0,   4.0d0, 11000.0d0,  5.0d0, 15000.0d0,  6.0d0,            
     &     17000.0d0,   7.0d0,     1.e20,  7.875d0/                             
c 1995                                                                          
      data tab95m/                                                              
     &     13000.0d0,   4.6d0, 19000.0d0,  5.6d0, 25000.0d0,  6.6d0,            
     &         1.e20,   7.59375d0/                                              
      data tab95s/                                                              
     &      6000.0d0,   4.6d0,   7000.0d0, 5.1d0,  9000.0d0,  5.5d0,            
     &     10000.0d0,   6.0d0,  12000.0d0, 6.5d0, 13000.0d0,  7.2d0,            
     &         1.e20,   7.59375d0/                                              
      data tab95h/                                                              
     &     10000.0d0,   4.6d0,  14000.0d0, 5.6d0, 19000.0d0,  6.6d0,            
     &         1.e20,   7.59375d0/                                              
c 1996                                                                          
      data tab96m/                                                              
     &     11000.0d0,   4.0d0,  16000.0d0, 5.0d0, 22000.0d0,  6.0d0,            
     &     26000.0d0,   7.0d0,      1.e20, 7.125d0/                             
      data tab96s/                                                              
     &      5500.0d0,   4.0d0,   8000.0d0, 5.0d0, 11000.0d0,  6.0d0,            
     &     13000.0d0,   7.0d0,      1.e20, 7.125d0/                             
      data tab96h/                                                              
     &      7500.0d0,   4.0d0,  11000.0d0, 5.0d0, 15000.0d0,  6.0d0,            
     &     17000.0d0,   7.0d0,      1.e20, 7.125d0/                             
c 1997                                                                          
      data tab97s/                                                              
     &      8000.0d0,   4.0d0,  11000.0d0, 4.5d0, 13000.0d0,  5.25d0,           
     &     20000.0d0,   5.9d0,      1.e20, 6.85d0/                              
      data tab97m/                                                              
     &     16000.0d0,   4.0d0,  22000.0d0, 4.5d0, 26000.0d0,  5.25d0,           
     &     40000.0d0,   5.9d0,      1.e20, 6.85d0/                              
      data tab97h/                                                              
     &     11000.0d0,   4.0d0,  15000.0d0, 4.5d0, 17000.0d0,  5.25d0,           
     &     30000.0d0,   5.9d0,      1.e20,  6.85d0/                             
c 2003                                                                          
      data tab03s/                                                              
     &      8000.0d0,   4.0d0,  11000.0d0, 4.5d0 , 13000.0d0,  5.25d0,          
     &     20000.0d0,   5.9d0, 100000.0d0, 6.85d0,     1.e20,  7.50d0/          
      data tab03m/                                                              
     &     16000.0d0,   4.0d0,  22000.0d0, 4.5d0 , 26000.0d0,  5.25d0,          
     &     40000.0d0,   5.9d0, 150000.0d0, 6.85d0,     1.e20,  7.50d0/          
      data tab03h/                                                              
     &     11000.0d0,   4.0d0,  15000.0d0, 4.5d0 , 17000.0d0,  5.25d0,          
     &     30000.0d0,   5.9d0, 125000.0d0, 6.85d0,     1.e20,  7.50d0/          
c 2004-2005                                                                     
      data tb04s/                                                               
     &      8000.0d0,   4.0d0,  11000.0d0, 4.5d0 , 13000.0d0,  5.25d0 ,         
     &     20000.0d0,   5.9d0, 100000.0d0, 6.85d0,500000.0d0,  7.375d0,         
     &         1.e20,   7.7d0 /                                                 
      data tb04m/                                                               
     &     16000.0d0,   4.0d0,  22000.0d0, 4.5d0 , 26000.0d0,  5.25d0 ,         
     &     40000.0d0,   5.9d0, 150000.0d0, 6.85d0,500000.0d0,  7.375d0,         
     &         1.e20,   7.7d0 /                                                 
      data tb04h/                                                               
     &     11000.0d0,   4.0d0,  15000.0d0, 4.5d0 , 17000.0d0,  5.25d0 ,         
     &     30000.0d0,   5.9d0, 125000.0d0, 6.85d0,500000.0d0,  7.375d0,         
     &         1.e20,   7.7d0 /                                                 
c 2006                                                                          
      data tab06s/                                                              
     &      8000.0d0,   4.0d0,  11000.0d0, 4.5d0 , 13000.0d0,  5.25d0 ,         
     &     20000.0d0,   5.9d0,      1.e20, 6.85d0/                              
      data tab06m/                                                              
     &     16000.0d0,   4.0d0,  22000.0d0, 4.5d0 , 26000.0d0,  5.25d0 ,         
     &     40000.0d0,   5.9d0,      1.e20, 6.85d0/                              
      data tab06h/                                                              
     &     11000.0d0,   4.0d0,  15000.0d0, 4.5d0 , 17000.0d0,  5.25d0,          
     &     30000.0d0,   5.9d0,      1.e20, 6.85d0/                              
c 2009                                                                          
      data tab09m/                                                              
     &     16000.0d0,   4.0d0,  22000.0d0, 4.5d0 , 26000.0d0,  5.25d0,          
     &     40000.0d0,   5.9d0, 300000.0d0, 6.85d0,500000.0d0, 7.860d0,          
     &         1.e20,   8.97d0/                                                 
      data tab09s/                                                              
     &      8000.0d0,   4.0d0,  11000.0d0, 4.5d0 , 13000.0d0,  5.25d0,          
     &     20000.0d0,   5.9d0, 200000.0d0, 6.85d0,500000.0d0,  7.86d0,          
     &         1.e20,   8.97d0/                                                 
      data tab09h/                                                              
     &     11000.0d0,   4.0d0,  15000.0d0, 4.5d0 , 17000.0d0,  5.25d0,          
     &     30000.0d0,   5.9d0, 250000.0d0, 6.85d0,500000.0d0,  7.86d0,          
     &         1.e20,   8.97d0/                                                 
c 2012                                                                          
      data tab12m/                                                              
     &     16000.d0,   4.0d0 ,  22000.d0, 4.5d0 , 26000.d0,  5.25d0,            
     &     40000.d0,   5.9d0 , 150000.d0, 6.45d0,300000.d0,  6.65d0,            
     &   2000000.d0,   6.85d0,     1.e20,   8.82d0/                             
      data tab12s/                                                              
     &      8000.d0,   4.0d0 ,  11000.d0, 4.5d0 , 13000.d0,  5.25d0,            
     &     20000.d0,   5.9d0 ,  75000.d0, 6.45d0,200000.d0,  6.65d0,            
     &   1000000.d0,   6.85d0,     1.e20, 8.82d0/                               
      data tab12h/                                                              
     &     12000.0d0,   4.0d0 ,  16500.0d0, 4.5d0 , 19500.0d0,  5.25d0,         
     &     30000.0d0,   5.9d0 , 100000.0d0, 6.45d0,250000.0d0,  6.65d0,         
     &   1500000.0d0,   6.85d0,      1.e20,   8.82d0/                           
c 2018-2020                                                                     
      data tab18m/                                                              
     &     17150.d0,   4.0d0 ,  23600.d0, 4.5d0 , 27900.d0,  5.25d0,            
     &     43000.d0,   5.9d0 , 161500.d0, 6.33d0,323200.d0,  6.57d0,            
     &   2155350.d0,   6.85d0,     1.e20, 8.82d0/                               
      data tab18s/                                                              
     &      8500.d0,   4.0d0 ,  11700.d0, 4.5d0 , 13900.d0,  5.25d0,            
     &     21400.d0,   5.9d0 ,  80650.d0, 6.33d0,215400.d0,  6.57d0,            
     &   1077550.d0,   6.85d0,     1.e20, 8.82d0/                               
      data tab18h/                                                              
     &     12800.0d0,   4.0d0 ,  17650.0d0, 4.5d0 , 20900.0d0,  5.25d0,         
     &     32200.0d0,   5.9d0 , 107650.0d0, 6.33d0,269300.0d0,  6.57d0,         
     &   1616450.0d0,   6.85d0,      1.e20,   8.82d0/                           
c 2021+                                                                         
      data tab21m/                                                              
     &     17150.d0,   4.0d0 ,  23600.d0, 4.5d0 , 27900.d0,  5.25d0,            
     &     43000.d0,   5.9d0 , 161500.d0, 5.97d0,323200.d0,  6.33d0,            
     &   2155350.d0,   6.85d0, 5.e6,9.65d0, 25.e6,10.3d0, 1.e20,10.9d0/         
      data tab21s/                                                              
     &      8500.d0,   4.0d0 ,  11700.d0, 4.5d0 , 13900.d0,  5.25d0,            
     &     21400.d0,   5.9d0 ,  80650.d0, 5.97d0,215400.d0,  6.33d0,            
     &   1077550.d0,   6.85d0, 5.e6,9.65d0, 25.e6,10.3d0, 1.e20,10.9d0/         
      data tab21h/                                                              
     &     12800.0d0,   4.0d0,  17650.0d0, 4.5d0 , 20900.0d0,  5.25d0,          
     &     32200.0d0,   5.9d0, 107650.0d0, 5.97d0,269300.0d0,  6.33d0,          
     &   1616450.0d0,  6.85d0, 5.e6,9.65d0, 25.e6,10.3d0, 1.e20,10.9d0/         
                                                                                
      data famtab/                                                              
     &      1000.0d0,   2.0d0 ,   3000.0d0, 3.0d0,   4000.0d0,  4.0d0,          
     &         1.e20,9999.0d0/                                                  
      data htab1/                                                               
     &      5000.0d0,  65.0d0 ,   6000.0d0,50.0d0,   7000.0d0, 40.0d0,          
     &     25000.0d0,  35.0d0 ,      1.e20,  .0d0/                              
      data htabs/                                                               
     &      5000.0d0,  75.0d0 ,   6000.0d0,60.0d0,   7000.0d0, 50.0d0,          
     &     20000.0d0,  45.0d0 ,  25000.0d0,40.0d0,  28000.0d0, 20.0d0,          
     &         1.e20,    .0d0/                                                  
      data htabm/                                                               
     &      5000.0d0,  90.0d0 ,   6000.0d0,75.0d0,   7000.0d0, 65.0d0,          
     &     20000.0d0,  60.0d0 ,  22000.0d0,60.0d0,  25000.0d0, 50.0d0,          
     &     28000.0d0,  40.0d0 ,  32000.0d0,20.0d0,      1.e20,   .0d0/          
      data htabd/                                                               
     &     20000.0d0,  15.0d0 ,  25000.0d0,10.0d0,  32000.0d0,  5.0d0,          
     &         1.e20,    .0d0/                                                  
c  not                                                                          
      data max78/                                                               
     &     21000.0d0,    .0d0 ,  23000.0d0, 1.0d0,      1.e20,  2.0d0/          
      data max80/                                                               
     &     19000.0d0,    .0d0 ,  21000.0d0, 1.0d0,  23000.0d0,  2.0d0,          
     &         1.e20,   3.0d0/                                                  
      data max81/                                                               
     &     17000.0d0,    .0d0 ,  19000.0d0, 1.0d0,  21000.0d0,  2.0d0,          
     &     23000.0d0,   3.0d0 ,      1.e20, 4.0d0/                              
      data max85/                                                               
     &     15000.0d0,    .0d0 ,  17000.0d0,   .5d0, 19000.0d0,  1.5d0,          
     &     21000.0d0,   2.5d0 ,  23000.0d0,  3.5d0,     1.e20,  4.25d0/         
      data max86/                                                               
     &     16000.0d0,    .0d0 ,  18500.0d0,   .5d0, 21000.0d0,  1.5d0,          
     &     23500.0d0,   2.5d0 ,  26000.0d0,  3.5d0,     1.e20,  4.0d0/          
      data xmp/                                                                 
     &     2*650.0d0,  700.0d0,  2* 750.0d0,  3*800.0d0,                        
     &     2*850.0d0,  900.0d0, 34*1000.0d0/                                    
      data stdr/.150d0,3*.160d0,4*.170d0/                                       
c std from IT-201 line 19                                                       
      data stdm/                                                                
     &     1500.0d0, 3*1900.0d0, 4*2000.0d0,   2750.0d0,   3000.0d0,            
     &     5300.0d0,   8500.0d0, 6*9500.0d0,  10800.0d0,  12350.0d0,            
     &  4*13000.0d0,  13400.0d0,  14200.0d0,3*14600.0d0,7*15000.0d0,            
     &    15400.0d0,  15650.0d0,  15850.0d0,  15950.0d0,5*16050.0d0/            
      data stds/                                                                
     &     1000.0d0, 3*1400.0d0, 4*1500.0d0, 2500.0d0, 2600.0d0,                
     &     3600.0d0,   5000.0d0, 6*6000.0d0, 6600.0d0, 7400.0d0,                
     &  16*7500.0d0,   7700.0d0,   7800.0d0, 7900.0d0, 7950.0d0,                
     &   5*8000.0d0/                                                            
      data stdh/                                                                
     &     10*0.0d0,    4600.0d0,   6000.0d0, 6*7000.0d0, 8150.0d0,             
     &    10000.0d0,16*10500.0d0,  10800.0d0,  10950.0d0,11100.0d0,             
     &    11150.0d0, 5*11200.0d0/                                               
      data stdd/                                                                
     &     9*2800.0d0, 2900.0d0, 16*3000.0d0, 3050.0d0,8*3100.0d0/              
      data stdmax/                                                              
     &     2000.0d0,  3*2400.0d0, 4*2500.0d0/                                   
      data pmxt78/  5400.0d0,  20.0d0,  7200.0d0, 15.0d0, 12000.0d0,            
     & 10.0d0,  1.e20, 0.0d0/                                                   
      data emax78/7200.0d0, 200.0d0, 10000.0d0, 40.0d0, 12000.0d0,              
     & 15.0d0,  1.e20, 0.0d0/                                                   
      data ptab78/  5400.0d0,  .050d0, 10000.0d0, .060d0, 12000.0d0,            
     & .070d0,  1.e20,0.0d0/                                                    
      data etab78/3600.0d0,  .040d0,  5400.0d0, .050d0,  7200.0d0,              
     & .060d0,  1.e20,0.0d0/                                                    
      data emax81/7200.0d0, 250.0d0, 13500.0d0,100.0d0,1.e20,0.0d0/             
      data ptab81/  5400.0d0,  .050d0, 10000.0d0, .060d0, 13500.0d0,            
     & .070d0,  1.e20,0.0d0/                                                    
      data etab81/3600.0d0,  .040d0,  5400.0d0, .050d0,  7200.0d0,              
     & .060d0,  13500.0d0,  .070d0, 1.e20,0.0d0/                                
      data ptab82/  3600.0d0,  .040d0,  5400.0d0,.0450d0, 10000.0d0,            
     & .0550d0, 16000.0d0, .0650d0,  1.e20, 0.0d0/                              
      data ptab85/                                                              
     & 3000.d0,.035d0, 5000.d0,.04d0, 7000.d0,.045d0, 9000.d0,.05d0,            
     &11000.d0,.055d0,14000.d0,.06d0,18000.d0,.065d0,   1.e20,0.d0/             
      data xded/ 100000.0d0, 200000.0d0, 100000.0d0,150000.0d0,                 
     & 200000.0d0, 100000.0d0,150000.0d0/                                       
      data old/ 1001.0d0,375.0d0, 2001.0d0,358.0d0, 3001.0d0,341.0d0,           
     & 4001.0d0,324.0d0,                                                        
     &          5001.0d0,307.0d0, 6001.0d0,290.0d0, 7001.0d0,273.0d0,           
     & 8001.0d0,256.0d0,                                                        
     &          9001.0d0,239.0d0,10001.0d0,222.0d0,11001.0d0,205.0d0,           
     & 12001.0d0,188.0d0,                                                       
     &         13001.0d0,171.0d0,14001.0d0,154.0d0,15001.0d0,137.0d0,           
     & 16001.0d0,120.0d0,                                                       
     &         17001.0d0,103.0d0,18001.0d0, 86.0d0/                             
      data young/                                                               
     & 1001.0d0, 75.0d0, 2001.0d0, 73.0d0, 3001.0d0, 71.0d0,                    
     & 4001.0d0, 69.0d0, 5001.0d0, 67.0d0, 6001.0d0, 65.0d0,                    
     & 7001.0d0, 63.0d0, 8001.0d0, 61.0d0, 9001.0d0, 59.0d0,                    
     &10001.0d0, 57.0d0,11001.0d0, 55.0d0,12001.0d0, 53.0d0,                    
     &13001.0d0, 51.0d0,14001.0d0, 49.0d0,15001.0d0, 47.0d0,                    
     &16001.0d0, 45.0d0,17001.0d0, 43.0d0,18001.0d0, 41.0d0/                    
c The federal disability income exclusion figure in to the NY pnsion            
c exclusion, but it's not worth calculating since we have no                    
c SOI variable post-84, when                                                    
      rt = 0.                                                                   
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      agi = comnew(2)                                                           
      if(law.eq.2020) agi = agi + data(82) - comnew(78)                         
      if(comnew(26).eq.0.d0.and.data(58).gt.0.d0) then                          
        if(law.eq.2020) agi = agi + min(300.d0/sep,data(58))                    
        if(law.eq.2021) agi = agi + min(300.d0*data(7),data(58))                
      endif                                                                     
c recomputed federal AGI for NYS EIC                                            
      agieic = agi                                                              
c     write(0,*) '1 agi',agi                                                    
c New York State AGI ----------------                                           
      agi=agi-data(22)-min(data(20)+data(72),data(9)*20000.)                    
      if(law.eq.1977)  agi=agi+(.2*max(0.0d0,comnew(5)))                        
      if(law.ge.1978.and.law.le.1982)agi=agi+(.1*max(0.0d0,comnew(5)))          
      if(law.ge.1984)agi=agi-comnew(79)                                         
c Standard Deduction ----------------                                           
      if(law.le.1984) then                                                      
        if(mst.eq.1)stded=twn(stdr(law)*agi,stds(law),stdmax(law))              
        if(mst.ne.1) then                                                       
          stded=twn(stdr(law)*agi,stdm(law),stdmax(law))                        
          stded=stded/sep                                                       
        endif                                                                   
      else if(law.ge.1985) then                                                 
        if(mst.eq.1.or.sep.eq.2) then                                           
           stded=stds(law)                                                      
        else if(mst.eq.4.or.mst.eq.7) then                                      
           stded=stdh(law)                                                      
        else                                                                    
           stded=stdm(law)                                                      
c          if(law.ge.2001.and.sep.eq.2) stded=6500.                             
        endif                                                                   
      endif                                                                     
c Standard deductions for dependents                                            
      if(law.ge.1987.and.data(105).gt.0.0d0) stded = stdd(law)                  
c Itemized Deductions                                                           
      xitded = 0.                                                               
      agix = max(0.d0,agi)                                                      
      if(comnew(26).gt.0.and.comnew(30).gt.0.and.law.le.2017) then              
        if(law.le.1990) then                                                    
           xitded = max(0.d0,comnew(24) - data(50))                             
        else                                                                    
           xitded = max(0.d0,                                                   
     &     (comnew(30) - data(50))*comnew(24)/comnew(30))                       
        endif                                                                   
      endif                                                                     
      if(law.ge.2018) then                                                      
c 2018+ itemized deductions                                                     
         stmisc = max(0.0d0,data(63)-.02*agix)                                  
         edical = max(0.0d0,data(47)+data(48)+data(49)-.1*agix)                 
         stat  = data(51)+data(54)                                              
         sttax = min(10000.d0/sep,data(51)+data(50)+data(54))                   
         xitded = comnew(30)-comnew(20)+edical+stat+stmisc-sttax                
c 2018+ limitation                                                              
         if(mst.eq.1) then                                                      
            phase = phites(law)                                                 
         else if(mst.eq.4.or.mst.eq.7) then                                     
            phase = phiteh(law)                                                 
         else                                                                   
            phase = phitem(law)/sep                                             
         endif                                                                  
         if(comnew(2).gt.phase) then                                            
          dedphs = min(.8*xitded,.03*(comnew(2)-phase))                         
          xitded = xitded - dedphs                                              
         endif                                                                  
      endif                                                                     
c reduced itemized deducs for high income taxpayers                             
      if(law.ge.1988.and.law.le.1990)then                                       
        reduce = 0.                                                             
        xover = 0.                                                              
        if(agi.gt.100000..and.agi.le.475000)                                    
     &    xover=(twn(agi-xded(mst),0.0d0,50000.0d0))/50000.                     
        if(agi.gt.475000.and.agi.le.525000)xover=(agi-475000.)/50000.           
        if(agi.gt.525000)xover=2.                                               
        if(law.eq.1988)reduce=xover*.1                                          
        if(law.ge.1989)reduce=xover*.25                                         
        xitded=max(0.0d0,xitded-(xitded*reduce))                                
      endif                                                                     
c Itemized deduction adjustment                                                 
      adjust = 0.                                                               
      if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) phasit=100000.                       
      if(mst.eq.4.or.mst.eq.7) phasit=150000.                                   
      if(mst.eq.2.or.mst.eq.5) phasit=200000.                                   
      if(agi.gt.100000.and.agi.le.475000) then                                  
         procen=max(0.0d0,min(50000.0d0,agi-phasit)/50000.)                     
         adjust = .25*xitded*procen                                             
         xitded = max(0.d0,xitded-adjust)                                       
      else if(agi.gt.475000.and.agi.le.525000) then                             
         procen = (agi-475000.)/50000.                                          
         adjust = .25*xitded*procen                                             
         xitded = max(0.d0,xitded-adjust)                                       
      else if(agi.gt.525000) then                                               
         adjust = .5*xitded                                                     
         xitded = max(0.d0,xitded-adjust)                                       
      endif                                                                     
      deduc=max(stded,xitded)                                                   
c Exemptions for Dependents ONLY                                                
      if(law.le.1987) then                                                      
         exemp=comnew(68)*xmp(law)                                              
      else                                                                      
         exemp=data(8)*xmp(law)                                                 
      endif                                                                     
c Taxable Income                                                                
      taxinc=max(0.0d0,agi-deduc-exemp)                                         
c      write(0,*) 'agi deduc exemp taxinc',agi,deduc,exemp,taxinc               
                                                                                
      taxy = taxinc                                                             
c family adjustment; allows deduction of income taxed at usual rates,           
c ONLY for 1985-1986                                                            
      famded = 0.                                                               
      if((mst.eq.2.or.mst.eq.3.or.mst.eq.6).and.                                
     &(law.eq.1985.or.law.eq.1986)) then                                        
c based on combined income of separate filers                                   
        if(mst.ne.2)taxy=taxinc*2.                                              
        if(law.eq.1985) then                                                    
          lowfam(2,7)=1.e20                                                     
          lowfam(2,8)=1.e20                                                     
          if(taxy.le.6000) then                                                 
            famded=max(0.0d0,(.5*taxy)-tablki(lowfam,9,agi,data))               
          else if(taxy.gt.6000.and.taxy.le.36000.) then                         
            famded=tablki(hifam1,7,agi,data)                                    
          endif                                                                 
        else if(law.eq.1986) then                                               
          lowfam(2,7)=1000.                                                     
          lowfam(2,8)=500.                                                      
          if(taxy.le.8000) then                                                 
            famded=max(0.0d0,(.5*taxy)-tablki(lowfam,9,agi,data))               
          else if(taxy.gt.8000.and.taxy.le.38000.) then                         
            famded=tablki(hifam2,9,agi,data)                                    
          endif                                                                 
        endif                                                                   
        if(famded.gt.4000) then                                                 
           write(0,*)'ERROR IN NYTAX, FAM. ADJ. > 4,000'                             
        continue                                                                
        endif                                                                   
        taxinc=max(0.0d0,taxinc-famded)                                         
      endif                                                                     
                                                                                
c                                                                               
c  Real Property Tax deduction ONLY for1979 and aged                            
c  This amount is allowed ONLY if you do not claim the                          
c  Real Property Tax Credit                                                     
      reald=0.                                                                  
      if(law.eq.1979.and.data(9).gt.0.) then                                    
        renttx=0.                                                               
        if(data(160).le.300*12)renttx=.25*data(160)                             
        ptax=0.                                                                 
c  estimated value of property tax to keep home w/in property value limit       
        if(data(51).le.2000)ptax=data(51)                                       
        ptax=max(renttx,ptax)                                                   
       if(data(159).lt.5400)then                                                
          reald=0.                                                              
        else if(data(159).ge.5400.and.data(159).lt.7200) then                   
          if(ptax.gt.(.06*data(159)))reald=450.                                 
        else if(data(159).ge.7200.and.data(159).lt.10000) then                  
          if(ptax.gt.(.06*data(159)))reald=300.                                 
        else if(data(159).ge.10000.and.data(159).lt.12000) then                 
          if(ptax.gt.(.07*data(159)))reald=250.                                 
        else if(data(159).ge.12000) then                                        
          reald=0.                                                              
        endif                                                                   
      taxinc=max(0.0d0,taxinc-reald)                                            
      endif                                                                     
                                                                                
c ------------------                                                            
c     New York State tax calculation                                            
c     marital status for tax rates schedules                                    
      if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)mri=1                                 
      if(mst.eq.4.or.mst.eq.7)mri=2                                             
      if(mst.eq.2.or.mst.eq.5)mri=3                                             
c     The state maximum tax rates were reduced year by year                     
      do 998 i=1,15                                                             
      do 997 j=1,2                                                              
        tab(j,i)=tb(j,i)                                                        
997   continue                                                                  
998   continue                                                                  
      if(law.eq.1977) then                                                      
        tab(2,13)=14.d0                                                         
        tab(2,14)=15.d0                                                         
        tab(2,15)=15.d0                                                         
      else if(law.eq.1978) then                                                 
        tab(2,13)=14.d0                                                         
        tab(2,14)=14.d0                                                         
        tab(2,15)=15.d0                                                         
      else if(law.ge.1979.and.law.le.1984) then                                 
        tab(2,13)=14.d0                                                         
        tab(2,14)=14.d0                                                         
        tab(2,15)=14.d0                                                         
      else if(law.eq.1985) then                                                 
        tab(2,13)=13.75d0                                                       
        tab(2,14)=13.75d0                                                       
        tab(2,15)=13.75d0                                                       
      endif                                                                     
      do 1000 i=1,7                                                             
      do  999 j=1,2                                                             
        tab04m(j,i)=tb04m(j,i)                                                  
        tab04s(j,i)=tb04s(j,i)                                                  
        tab04h(j,i)=tb04h(j,i)                                                  
999   continue                                                                  
1000  continue                                                                  
      if(law.eq.2005) then                                                      
        tab04s(2,6)=7.25d0                                                      
        tab04m(2,6)=7.25d0                                                      
        tab04h(2,6)=7.25d0                                                      
      endif                                                                     
      if(law.le.1985) then                                                      
       call look(tab,taxinc,15,n,statax,1.0d00,0.0d0,rt,data)                   
      else if(law.eq.1986) then                                                 
       call look(tab86,taxinc,13,n,statax,1.0d00,0.0d0,rt,data)                 
      else if(law.eq.1987) then                                                 
       if(mri.eq.1)                                                             
     & call look(tab87s,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)                 
       if(mri.eq.2)                                                             
     & call look(tab87h,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)                 
       if(mri.eq.3)                                                             
     & call look(tab87m,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)                 
      else if(law.eq.1988) then                                                 
       if(mri.eq.1)                                                             
     & call look(tab88s,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                 
       if(mri.eq.2)                                                             
     &  call look(tab88h,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab88m,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.ge.1989.and.law.le.1994) then                                 
       if(mri.eq.1)                                                             
     &  call look(tab89s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.2)                                                             
     &  call look(tab89h,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab89m,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.eq.1995) then                                                 
       if(mri.eq.1)                                                             
     &  call look(tab95s,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.2)                                                             
     &  call look(tab95h,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab95m,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.eq.1996) then                                                 
       if(mri.eq.1)                                                             
     &  call look(tab96s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.2)                                                             
     &  call look(tab96h,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab96m,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.ge.1997.and.law.le.2002) then                                 
       if(mri.eq.1)                                                             
     &  call look(tab97s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.2)                                                             
     &  call look(tab97h,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab97m,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       else if(law.eq.2003) then                                                
       if(mri.eq.1)                                                             
     &  call look(tab03s,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.2)                                                             
     &  call look(tab03h,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab03m,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.ge.2004.and.law.le.2005) then                                 
       if(mri.eq.1)                                                             
     &  call look(tab04s,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.2)                                                             
     &  call look(tab04h,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab04m,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.ge.2006.and.law.le.2008) then                                 
       if(mri.eq.1)                                                             
     &  call look(tab06s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.2)                                                             
     &  call look(tab06h,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab06m,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.ge.2009.and.law.le.2011) then                                 
       if(mri.eq.1)                                                             
     &  call look(tab09s,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.2)                                                             
     &  call look(tab09h,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
       if(mri.eq.3)                                                             
     &  call look(tab09m,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.ge.2012.and.law.le.2017) then                                 
       if(mri.eq.1)                                                             
     &  call look(tab12s,taxinc,8,n,statax,aif12(law),0.0d0,rt,data)            
       if(mri.eq.2)                                                             
     &  call look(tab12h,taxinc,8,n,statax,aif12(law),0.0d0,rt,data)            
       if(mri.eq.3)                                                             
     &  call look(tab12m,taxinc,8,n,statax,aif12(law),0.0d0,rt,data)            
      else if(law.ge.2018.and.law.le.2020) then                                 
       do 2019 i = 1,2                                                          
       do 2018 j = 1,8                                                          
         if(mri.eq.1) then                                                      
            tab18(i,j) = tab18s(i,j)                                            
         else if(mri.eq.2) then                                                 
            tab18(i,j) = tab18h(i,j)                                            
         else if(mri.eq.3) then                                                 
            tab18(i,j) = tab18m(i,j)                                            
         endif                                                                  
         if(law.eq.2019) then                                                   
           tab18(2,5) = 6.21d0                                                  
           tab18(2,6) = 6.49d0                                                  
         endif                                                                  
         if(law.eq.2020) then                                                   
           tab18(2,5) = 6.09d0                                                  
           tab18(2,6) = 6.41d0                                                  
         endif                                                                  
2018   continue                                                                 
2019   continue                                                                 
       call look(tab18,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)                  
      else if(law.ge.2021) then                                                 
       do 2022 i = 1,2                                                          
       do 2021 j = 1,10                                                         
         if(mri.eq.1) then                                                      
            tab21(i,j) = tab21s(i,j)                                            
         else if(mri.eq.2) then                                                 
            tab21(i,j) = tab21h(i,j)                                            
         else if(mri.eq.3) then                                                 
            tab21(i,j) = tab21m(i,j)                                            
         endif                                                                  
2021   continue                                                                 
2022   continue                                                                 
       call look(tab21,taxinc,10,n,statax,1.0d00,0.0d0,rt,data)                 
                                                                                
      endif                                                                     
      if(law.ge.1989.and.law.le.2005) then                                      
        if(agi.gt.100000.and.agi.le.150000) then                                
         if(law.le.2002) then                                                   
          statax = statax +(taxinc * rt - statax) *(agi-100000.)/50000.         
         else                                                                   
          if((mri.eq.1.and.taxinc.le.100000).or.                                
     &       (mri.eq.2.and.taxinc.le.125000).or.                                
     &       mri.eq.3)                                                          
     &statax = statax +(taxinc *.0685 - statax) *(agi-100000.)/50000.           
          if(mri.eq.1.and.taxinc.gt.100000)                                     
     &     statax = statax +397. *(agi-100000.)/50000.                          
          if(mri.eq.2.and.taxinc.gt.125000)                                     
     &     statax = statax +563. *(agi-100000.)/50000.                          
          endif                                                                 
        else if(agi.gt.150000.) then                                            
         if(law.le.2002) then                                                   
          statax = taxinc *rt                                                   
         else                                                                   
          if(agi.le.500000) then                                                
c                                                                               
           if((mri.eq.1.and.taxinc.le.100000).or.                               
     &        (mri.eq.2.and.taxinc.le.125000).or.                               
     &        (mri.eq.3.and.taxinc.le.150000)) statax = taxinc * .0685          
c                                                                               
           if(mri.eq.1.and.taxinc.gt.100000)                                    
     &     statax = 397.+ statax +(taxinc * .075 - statax-397.)                 
     &   *min(50000.0d0,agi - 150000.)/50000.                                   
          if(mri.eq.2.and.taxinc.gt.125000)                                     
     &     statax = 563.+ statax +(taxinc * .075 - statax-563.)                 
     &   *min(50000.0d0,agi - 150000.)/50000.                                   
          if(mri.eq.3.and.taxinc.gt.150000)                                     
     &     statax = 794.+ statax +(taxinc * .075 - statax-794.)                 
     &   *min(50000.0d0,agi - 150000.)/50000.                                   
c                                                                               
         else                                                                   
           statax = taxinc * .077                                               
         endif                                                                  
        endif                                                                   
       endif                                                                    
      endif                                                                     
      if(law.ge.2006.and.law.le.2008) then                                      
          if(agi.gt.100000.and.agi.le.150000) then                              
            excess = taxinc * rt - statax                                       
            ratio = min(50000.0d0,agi-100000)/50000                             
            statax = statax + ratio * excess                                    
         else if(agi.gt.150000) then                                            
            statax = taxinc * rt                                                
         endif                                                                  
      endif                                                                     
      if(law.ge.2009.and.law.le.2011) then                                      
        if(agi.gt.100000.and.agi.le.150000) then                                
c tax computation worksheet 1                                                   
           excess = taxinc * .0685 - statax                                     
           ratio = min(50000.0d0,agi-100000)/50000                              
           statax = statax + ratio * excess                                     
        else if(agi.gt.150000.and.agi.le.500000) then                           
            if(mri.eq.3) then                                                   
               if(taxinc.le.300000) then                                        
c tax computation worksheet 2                                                   
                 statax = taxinc * .0685                                        
               else                                                             
c tax computation worksheet 3                                                   
                 excess = taxinc * .0785 - statax - 794                         
                 ratio = min(50000.0d0,agi-300000)/50000                        
                 statax = statax + ratio * excess + 794                         
               endif                                                            
            else if (mri.eq.1) then                                             
               if(taxinc.le.200000) then                                        
                 statax = taxinc * .0685                                        
               else                                                             
                 excess = taxinc * .0785 - statax - 397                         
                 ratio = min(50000.0d0,agi-300000)/50000                        
                 statax = statax + ratio * excess + 397                         
               endif                                                            
            else if (mri.eq.2) then                                             
               if(taxinc.le.250000) then                                        
                 statax = taxinc * .0685                                        
               else                                                             
                 excess = taxinc * .0785 - statax - 563                         
                 ratio = min(50000.0d0,agi-300000)/50000                        
                 statax = statax + ratio * excess + 563                         
               endif                                                            
            endif                                                               
        else if(agi.gt.500000.and.agi.le.550000) then                           
            if(mri.eq.3) then                                                   
               if(taxinc.le.300000) then                                        
c tax computation worksheet 4                                                   
                 excess = taxinc * .0897 - statax - 794                         
                 ratio = min(50000.0d0,agi-500000)/50000                        
                 statax = statax + ratio * excess + 794                         
               else                                                             
c tax computation worksheet 5                                                   
                 excess = taxinc * .0897 - statax - 3794                        
                 ratio = min(50000.0d0,agi-500000)/50000                        
                 statax = statax + ratio * excess + 3794                        
               endif                                                            
            else if (mri.eq.1) then                                             
               if(taxinc.le.200000) then                                        
                 excess = taxinc * .0897 - statax - 397                         
                 ratio = min(50000.0d0,agi-500000)/50000                        
                 statax = statax + ratio * excess + 397                         
               else                                                             
                 excess = taxinc * .0897 - statax - 2397                        
                 ratio = min(50000.0d0,agi-200000)/50000                        
                 statax = statax + ratio * excess + 2397                        
               endif                                                            
            else if (mri.eq.2) then                                             
               if(taxinc.le.250000) then                                        
                 excess = taxinc * .0897 - statax - 563                         
                 ratio = min(50000.0d0,agi-500000)/50000                        
                 statax = statax + ratio * excess + 563                         
               else                                                             
                 excess = taxinc * .0897 - statax - 3063                        
                 ratio = min(50000.0d0,agi-250000)/50000                        
                 statax = statax + ratio * excess + 3063                        
               endif                                                            
            endif                                                               
        else if(agi.gt.550000) then                                             
c tax computation worksheet 6                                                   
            statax = taxinc * .0897                                             
        endif                                                                   
      endif                                                                     
      if(law.ge.2012) then                                                      
       if(mst.eq.2.or.mst.eq.5) then                                            
c w/s 1-4 for MARRIED filing jointly                                            
        if((agi.gt.100000*aif12(law).and.agi.le.2000000*aif12(law)).            
     &  and.taxinc.le.150000*aif12(law)) then                                   
c tax computation worksheet 1                                                   
          if(agi.ge.100000*aif12(law)+50000) then                               
             statax = taxinc * rtmax(0,law)                                     
          else                                                                  
             excess = taxinc * rtmax(0,law) - statax                            
             ratio = min(50000.0d0,agi-100000*aif12(law))/50000                 
             statax = statax + ratio * excess                                   
          endif                                                                 
        else if((agi.gt.150000*aif12(law).and.agi.le.2000000*aif12(law))        
     &.and.(taxinc.gt.150000*aif12(law).and.taxinc.le.300000*aif12(law))        
     &          ) then                                                          
c tax computation worksheet 2                                                   
               if(agi.ge.150000*aif12(law)+50000) then                          
                 statax = taxinc * rtmax(1,law)                                 
               else                                                             
                 excess = taxinc * rtmax(1,law) - statax - add12(1,law)         
                 ratio = min(50000.0d0,agi-150000*aif12(law))/50000             
                 statax = statax + ratio * excess + add12(1,law)                
               endif                                                            
        else if((agi.gt.300000*aif12(law).and.agi.le.2000000*aif12(law))        
     &  .and.taxinc.gt.300000*aif12(law)) then                                  
c tax computation worksheet 3                                                   
               if(agi.ge.300000*aif12(law)+50000) then                          
                 statax = taxinc * rtmax(2,law)                                 
               else                                                             
                 excess = taxinc * rtmax(2,law) - statax - add12(2,law)         
                 ratio = min(50000.0d0,agi-150000)/50000                        
                 statax = statax + ratio * excess + add12(2,law)                
               endif                                                            
        else if(agi.gt.2000000*aif12(law)) then                                 
c tax computation worksheet 4                                                   
               if(agi.ge.200000*aif12(law)+50000) then                          
                 statax = taxinc * rtmax(3,law)                                 
               else                                                             
                 ratio = min(50000.0d0,agi-150000)/50000                        
                 if(taxinc.le.150000*aif12(law)) then                           
                   excess = taxinc*rtmax(3,law)-statax-add12(1,law)             
                   statax = statax + ratio * excess + add12(1,law)              
                 else if(taxinc.gt.150000*aif12(law).and.                       
     &                   taxinc.lt.300000*aif12(law)) then                      
                   excess = taxinc*rtmax(3,law)-statax-add12(2,law)             
                   statax = statax + ratio * excess + add12(2,law)              
                 else if(taxinc.gt.300000*aif12(law)) then                      
                   excess = taxinc*rtmax(3,law)-statax-add12(3,law)             
                   statax = statax + ratio * excess + add12(3,law)              
                 endif                                                          
               endif                                                            
        endif                                                                   
       else if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                           
c w/s 5-7 for Singles and MARRIED filing separately                             
        if((agi.gt.100000*aif12(law).and.agi.le.1000000*aif12(law)).and.        
     &  taxinc.le.200000*aif12(law)) then                                       
c tax computation worksheet 5                                                   
               if(agi.ge.10000*aif12(law)+50000) then                           
                 statax = taxinc * rtmax(1,law)                                 
               else                                                             
                 ratio = min(50000.0d0,agi-100000*aif12(law))/50000             
                 excess = taxinc * rtmax(1,law) -statax                         
                 statax = statax + ratio * excess                               
               endif                                                            
        else if((agi.gt.200000*aif12(law).and.agi.le.1000000*aif12(law))        
     &  .and.taxinc.gt.200000*aif12(law)) then                                  
c tax computation worksheet 6                                                   
               if(agi.ge.250000) then                                           
                 statax = taxinc * rtmax(2,law)                                 
               else                                                             
                 ratio = min(50000.0d0,agi-100000*aif12(law))/50000             
                 excess = taxinc * rtmax(2,law) -statax - add12(4,law)          
                 statax = statax + ratio * excess  + add12(4,law)               
               endif                                                            
        else if(agi.gt.1000000*aif12(law)) then                                 
c tax computation worksheet 7                                                   
               if(agi.ge.100000*aif12(law) + 500000) then                       
                 statax = taxinc * rtmax(3,law)                                 
               else                                                             
                 ratio = min(50000.0d0,agi-100000*aif12(law))/50000             
                 if(taxinc.le.200000*aif12(law)) then                           
                   excess = taxinc * rtmax(3,law) -statax - add12(4,law)        
                   statax = statax + ratio * excess  + add12(4,law)             
                 else                                                           
                   excess = taxinc * rtmax(3,law) -statax - add12(5,law)        
                   statax = statax + ratio * excess  + add12(5,law)             
                 endif                                                          
               endif                                                            
        endif                                                                   
       else                                                                     
c w/s 8-9 for Head of Households                                                
        if((agi.gt.100000*aif12(law).and.agi.le.1500000*aif12(law)).            
     &  and.taxinc.le.250000*aif12(law)) then                                   
c tax computation worksheet 8                                                   
               if(agi.ge.100000*aif12(law)+50000) then                          
                 statax = taxinc * rtmax(1,law)                                 
               else                                                             
                 ratio = min(50000.0d0,agi-100000*aif12(law))/50000             
                 excess = taxinc * rtmax(1,law) -statax                         
                 statax = statax + ratio * excess                               
               endif                                                            
        else if((agi.gt.250000*aif12(law).and.agi.le.1500000*aif12(law))        
     &  .and.taxinc.gt.250000*aif12(law))  then                                 
c tax computation worksheet 9                                                   
               if(agi.ge.250000*aif12(law)+50000) then                          
                 statax = taxinc * rtmax(2,law)                                 
               else                                                             
                 ratio = min(50000.0d0,agi-100000*aif12(law))/50000             
                 excess = taxinc * rtmax(2,law) -statax - add12(6,law)          
                 statax = statax + ratio * excess + add12(6,law)                
               endif                                                            
        else if(agi.gt.1500000*aif12(law))  then                                
c tax computation worksheet 10                                                  
               if(agi.ge.1500000*aif12(law)+50000) then                         
                 statax = taxinc * rtmax(3,law)                                 
               else                                                             
                 ratio = min(50000.0d0,agi-100000*aif12(law))/50000             
                 if(taxinc.le.250000) then                                      
                   excess = taxinc * rtmax(3,law) -statax - add12(6,law)        
                   statax = statax + ratio * excess + add12(6,law)              
                 else                                                           
                   excess = taxinc*rtmax(3,law)-statax-add12(7,law)             
                   statax = statax + ratio * excess + add12(7,law)              
                 endif                                                          
               endif                                                            
        endif                                                                   
       endif                                                                    
      endif                                                                     
                                                                                
c      write(0,*) 'taxinc statax',taxinc,statax                                 
                                                                                
c     tax on shifted 'family adjustment' income                                 
c The Tax Reform and Reduction Act of 1987 has eliminated the difficult         
c maximum tax and family adjustment calculations                                
c                                                                               
c Family adjustment ONLY for 1985-1986 and for married people :                 
c joint and separate                                                            
      famtax = 0.                                                               
      if(famded.gt.0)                                                           
     & call look(famtab,famded,4,n,famtax,1.0d00,0.0d0,frt,data)                
      statax = statax + famtax                                                  
c Maximum Tax on personal service income  ONLY for 1978-1986                    
      save = 0.                                                                 
      if(law.ge.1978.and.law.le.1986) then                                      
c     psinc - personal service income                                           
        psinc = max(data(94),data(11)+data(17)+data(20)+data(72)+               
     &  .3*(data(75)+data(79)-data(80)),0.0d0)                                  
        psinc = max(0.0d0,psinc-data(26)-comnew(12)-comnew(14))                 
c                                                                               
        percen = 0.                                                             
        if(agi.ne.0) percen = psinc/agi                                         
c     pstinc - Personal Service Taxable income                                  
        pstinc=percen*taxy                                                      
        pstinc=max(0.0d0,pstinc-max(data(81),comnew(36)))                       
c     subtract the 'extra' tax on personal income over a certain level          
        if(law.eq.1978.or.law.eq.1979) then                                     
          call look(max78,pstinc,3,n,save,1.0d00,0.0d0,psrt,data)               
        else if(law.eq.1980) then                                               
          call look(max80,pstinc,4,n,save,1.0d00,0.0d0,psrt,data)               
        else if(law.ge.1981.and.law.le.1984) then                               
          call look(max81,pstinc,5,n,save,1.0d00,0.0d0,psrt,data)               
        else if(law.eq.1985) then                                               
          call look(max85,pstinc,6,n,save,1.0d00,0.0d0,psrt,data)               
        else if(law.eq.1986) then                                               
          call look(max86,pstinc,5,n,save,1.0d00,0.0d0,psrt,data)               
        endif                                                                   
      endif                                                                     
      statax = statax - save                                                    
c     1987-1988 the maximum tax on personl service income is replaced           
c     with an extra tax on unearned income                                      
      unytax = 0.                                                               
      if(law.eq.1987.and.law.eq.1988) then                                      
        unearn=data(12)+data(14)+comnew(5)+data(82)                             
c     unearned income also includes certain lump sum distributions, but         
c       can't measure                                                           
        if(law.eq.1987)pcent=.03                                                
        if(law.eq.1988)pcent=.02                                                
        if((agi.lt.200000.and.sep.ne.2).or.                                     
     &     (agi.lt.150000.and.sep.eq.2)) then                                   
          unytax=(max(0.0d0,(agi - 100000.d0/sep))/100000.)*                    
     &    pcent*unearn                                                          
        else if((agi.ge.200000.and.sep.ne.2).or.                                
     &          (agi.ge.150000.and.sep.eq.2)) then                              
          unytax=pcent*unearn                                                   
        endif                                                                   
        statax = statax + unytax                                                
      endif                                                                     
c WHO MUST FILE? ------------------------                                       
c before 1986                                                                   
      if((law.le.1985).and.                                                     
     & (agi.le.2500*data(7)*sep.or.agi.le.exemp))statax = 0.                    
c for 1986                                                                      
      if((law.eq.1986).and.                                                     
     & ((mst.ne.1.and.agi.le.8000.0d0).or.                                      
     &  (mst.eq.1.and.agi.le.4000.0d0)).or.                                     
     & (agi.le.exemp)) statax = 0.                                              
c for 1987                                                                      
      if((law.eq.1987).and.                                                     
     & ((mst.eq.1.and.int(data(105)).eq.1.and.agi.le.2800.).or.                 
     &  (mst.eq.1.and.int(data(105)).ne.1.and.agi.le.3600.).or.                 
     &  (mst.eq.3..or.mst.eq.6.and.agi.le.2650.0d0).or.                         
     &  ((mst.eq.2..or.mst.eq.4.or.mst.eq.5).and.agi.le.4000.0d0)))             
     &  statax = 0.                                                             
c for 1988 +                                                                    
      if(law.ge.1988) then                                                      
        if(int(data(105)).ne.1.and.agi.le.4000.) statax = 0.                    
        if((int(data(105)).eq.1).and.                                           
     &     (((law.ge.1988.and.law.le.1995).and.agi.le.2800.0d0).or.             
     &      (law.eq.1996.and.agi.le.2900.0d0).or.                               
     &      (law.ge.1997.and.agi.le.3000.0d0)))                                 
     &  statax = 0.                                                             
      endif                                                                     
      taxbc = statax                                                            
c      write(0,*) 'taxbc',statax                                                
                                                                                
c CREDITS                                                                       
c     household credit: not refundable.                                         
      hcred=0.                                                                  
      fedagi = comnew(2)                                                        
      if(int(data(105)).ne.1) then                                              
        if(law.ge.1978.and.law.le.1985) then                                    
         hcred=(tablki(htab1,5,fedagi,data)+xif(law.ge.1982,5.0d0))/sep         
        else if(law.ge.1986) then                                               
          if(mst.eq.1) then                                                     
            hcred = tablki(htabs,7,fedagi,data)                                 
          else                                                                  
            hcred = (tablki(htabm,9,fedagi,data)+                               
     &   (comnew(68) -1)*tablki(htabd,4,fedagi,data))/sep                       
          endif                                                                 
        endif                                                                   
      endif                                                                     
      statax = max(0.0d0,statax - hcred)                                        
c            write(0,*) 'statax hcred',statax,hcred                             
                                                                                
c     ENERGY credit - non refundable                                            
      encred=0.                                                                 
      if(law.eq.1984.or.law.eq.1985)encred=min(data(38),2750.0d0)               
      statax = max(0.0d0,statax - encred)                                       
c CHILD and Dependent Care is refundable in 1977 only and                       
c beginning with tax year 1996                                                  
      if(law.eq.1977) chcr=.2*comnew(176)                                       
      if(law.gt.1977.and.law.le.1995) chcr=min(statax,.2*comnew(176))           
      if(law.eq.1996) then                                                      
        chcr = comnew(176)*tablki(chld96,12,agi,data)                           
      else if(law.eq.1997) then                                                 
        if(agi.le.10000.) then                                                  
          percen = .6                                                           
        else if(agi.gt.10000.and.agi.lt.14000.) then                            
          percen = .595 - .0001*(agi - 10100.)                                  
        else                                                                    
          percen = .2                                                           
        endif                                                                   
        chcr = comnew(176)*percen                                               
      else if(law.eq.1998) then                                                 
        if(agi.le.17000.) then                                                  
          percen = 1.                                                           
        else if(agi.gt.17000.and.agi.lt.30000.) then                            
          percen = .997 - .0000615*(agi - 17100.)                               
        else                                                                    
          percen = .2                                                           
        endif                                                                   
        chcr = comnew(176)*percen                                               
      elseif(law.eq.1999) then                                                  
        if(agi.le.35000.) then                                                  
          percen = 1.                                                           
        else if(agi.gt.35000.and.agi.lt.50000.) then                            
          percen = .997 - .00005*(agi - 35100.)                                 
        else                                                                    
          percen = .2                                                           
        endif                                                                   
        chcr = comnew(176)*percen                                               
      elseif(law.ge.2000) then                                                  
        if(agi.le.25000.) then                                                  
          percen = 1.1                                                          
        else if(agi.gt.25000.and.agi.lt.40000.) then                            
          percen = 1.1 - .0000066*(agi - 25000.)                                
        else if(agi.ge.40000.and.agi.lt.50000.) then                            
          percen = 1.                                                           
        else if(agi.ge.50000.and.agi.lt.65000.) then                            
          percen = 1. - .000053*(agi - 50000.)                                  
        else                                                                    
          percen = .2                                                           
        endif                                                                   
        chcr = comnew(176)*percen                                               
      endif                                                                     
      if(law.eq.1977.or.law.ge.1996) then                                       
         statax = statax - chcr                                                 
      else                                                                      
         statax = max(0.0d0,statax - chcr)                                      
      endif                                                                     
c Real Property Tax Credit - refundable                                         
c elderly have bigger deductions.                                               
      if(law.le.1980) then                                                      
        ptax=.25*data(160)+.5*data(51)                                          
      else                                                                      
        ptax=.25*data(160)+data(51)                                             
      endif                                                                     
      pcred=0.d0                                                                
      if(law.ge.1978.and.law.le.1980.and.hy.le.12000.d0) then                   
       if(law.eq.1979.and.reald.gt.0.d0) then                                   
        pcred = 0.d0                                                            
       else                                                                     
        if(data(9).lt.1.d0) then                                                
          pmax=tablki(pmxt78,4,hy,data)                                         
          pcred=twn(ptax-(hy*tablki(ptab78,4,hy,data)),0.0d0,pmax)              
        else if(data(9).gt.0.d0) then                                           
          pmax=tablki(emax78,4,hy,data)                                         
          pcred=twn(ptax-(hy*tablki(etab78,4,hy,data)),0.0d0,pmax)              
        endif                                                                   
       endif                                                                    
      else if(law.eq.1981.and.hy.le.13500.d0) then                              
        if(data(9).lt.1.d0) then                                                
          pmax=45.d0                                                            
          pcred=twn(ptax-(hy*tablki(ptab81,4,hy,data)),0.0d0,pmax)              
        else if(data(9).gt.0.d0) then                                           
          pmax=tablki(emax81,3,hy,data)                                         
          pcred=twn(ptax-(hy*tablki(etab81,5,hy,data)),0.0d0,pmax)              
        endif                                                                   
      else if(law.ge.1982.and.law.le.1984.and.hy.le.16000.d0) then              
        if(data(9).lt.1.d0) then                                                
          pmax=45.d0                                                            
        else if(data(9).gt.0.d0) then                                           
          if(hy.le.7200.d0) pmax=250.d0                                         
          if(hy.gt.7200.d0) pmax=100.d0                                         
        endif                                                                   
        pcred=twn(ptax-(hy*tablki(ptab82,5,hy,data)),0.0d0,pmax)                
      else if(law.ge.1985.and.hy.le.18000.d0) then                              
       if(data(9).gt.0.d0) pmax=tablki(old,18,hy,data)                          
       if(data(9).lt.1.d0) pmax=tablki(young,18,hy,data)                        
                                                                                
       pcred = max(0.0d0,ptax-hy*tablki(ptab85,8,hy,data))                      
       if(data(51).gt.0.d0) pcred = min(.25*pcred,pmax)                         
       if(data(160).gt.0.d0) pcred = min(.5*pcred,pmax)                         
      endif                                                                     
c Schedule B - to be completed by renters                                       
      if(.25*data(160).gt.350.d0) pcred=0.                                      
c New York State earned income credit - refundable                              
      earncr = 0.                                                               
      if(law.ge.1994.and.law.le.1995)                                           
     & earncr = earate(law)*comnew(59)                                          
      if(law.ge.1996.and.law.le.2019)                                           
     & earncr = max(0.0d0,earate(law)*comnew(59)-min(hcred,taxbc))              
      if(law.ge.2020) then                                                      
        earny = comnew(37)                                                      
        call eitcr(data,law,agieic,earny,eitc,rtbs)                             
c 2021 NYS EIC for individuals with No Qualifying Children                      
        if(law.eq.2021.and.mst.eq.1.and.data(208).lt.1.d0) then                 
          agieic = agieic*.99d0                                                 
          call eitcr(data,2020,agieic,earny,eitc,rtbs)                          
          eitc = 1.01*eitc                                                      
        endif                                                                   
        a = min(hcred,taxbc)                                                    
        b = eitc                                                                
        c = earate(law)                                                         
c       write(0,*) 'a b c',min(hcred,taxbc),eitc,earate(law)                    
        earncr = max(0.0d0,earate(law)*eitc-min(hcred,taxbc))                   
      endif                                                                     
c College Tuition Credit                                                        
      edcred = 0.                                                               
      if(law.ge.2001) then                                                      
        tuit = data(143)+data(144)                                              
        edcred = min(ed(law),perc(law) * tuit)                                  
        if(tuit.ge.5000.) edcred = .04* edcred                                  
      endif                                                                     
c Empire State child credit - refundable                                        
c(new in 2006)                                                                  
      eschcr = 0.d0                                                             
      cphase = 110000.d0/sep                                                    
      if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) cphase = 75000.d0                    
      if(law.ge.2006.and.law.le.2017) then                                      
       if(comnew(2).le.cphase)                                                  
     & eschcr = max(100*data(208),.33*(comnew(93)+comnew(81)))                    
      else if(law.ge.2018.and.data(8).gt.0.d0) then                             
c 2018+ no longer use the amount of federal CTC/ADDCTC                          
        precrd = 1000.d0*data(203)                                              
        fagi = comnew(2)                                                        
c 2020 recomputed federal AGI                                                   
        if(law.eq.2020) fagi=fagi+data(82)-comnew(78)                           
        if (fagi.gt.cphase) then                                                
           excess = fagi - cphase                                               
           reduc = excess*0.05                                                  
           precrd = max(0.0d0,precrd-reduc)                                     
        endif                                                                   
        if(precrd.gt.0) then                                                    
         ctcred=min(precrd,max(0.0d0,comnew(137)-comnew(53)-comnew(54)))        
         fift = .15d0*max(0.0d0,comnew(37) - 3000.d0)                           
         chcr1 = min(precrd-ctcred,fift )                                       
         cssmax = ss(law)                                                       
         ssmtax = .0765*min(cssmax,max(0.0d0,comnew(37)))                       
         if(data(8).gt.2.and.fift.lt.precrd-ctcred)                             
     &chcr1 = min(precrd-ctcred,max(fift,max(0.0d0,ssmtax-comnew(59))))         
         base = chcr1 + ctcred                                                  
         if(comnew(2).gt.cphase) then                                           
          eschcr = data(208)*max(100.d0,.33d0*base/data(8))                     
         else                                                                   
          eschcr = data(208)*.33d0*base/data(8)                                 
         endif                                                                  
        endif                                                                   
      endif                                                                     
      statax = statax - earncr - edcred - eschcr - pcred                        
c      write(0,*) 'statax earncr eschcr',statax,earncr,eschcr                   
c Family Tax Relief Credit-refundable-with a dependent under 17 y.o.            
      famref = 0.                                                               
      if((law.ge.2015..and.law.le.2016).and.statax.ge.0.d0.and.                 
     &(agi.ge.40000.d0.and.agi.le.300000.d0).and.data(208).gt.0.d0) then        
         famref = 350.d0                                                        
         statax = statax - famref                                               
      endif                                                                     
c Total Credits                                                                 
      credit = encred+hcred+pcred+earncr+chcr+edcred+eschcr+famref              
c     Other New York State Taxes (for expl,line41 of IT-201 for 1997)           
c     alternative minimum tax:                                                  
c     xtinc- Total New York tax preference items.                               
c there is a difference between 1994 code and 1997 code for 'xtinc' place       
c this diff gives diff in the results for minimum income tax                    
c    ded - specific deduction                                                   
      ded=5000.d0/sep                                                           
      xtinc=max(0.0d0,data(81)+data(83)                                         
     & +data(88)+data(89)+data(116)-ded-statax)                                 
      statax=statax+.06*xtinc                                                   
      return                                                                    
      end                                                                       
c  NORTH CAROLINA                                                               
c  State 34                                                                     
c                                                                               
c  Updated through 2021 (03/23/2022)                                            
      subroutine nctax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      dimension tab77(2,5), tabs89(2,2), tabh89(2,2), tabm89(2,2)               
      dimension tabs91(2,3), tabh91(2,3), tabm91(2,3)                           
      dimension tabs01(2,4), tabh01(2,4), tabm01(2,4)                           
      dimension tabs07(2,4), tabh07(2,4), tabm07(2,4)                           
      dimension tabs08(2,3), tabh08(2,3), tabm08(2,3)                           
      dimension xemp(1990:1994),xexemp(1995:2013,2),child(1981:2013)            
      dimension xmp(1977:1993),xmp2(1977:1993),xmpc(1977:1993),                 
     & stdm(1989:2021),stds(1989:2021),stdh(1989:2021)                          
      dimension ctc95(1995:2017),exem(1987:2013),eicr(2008:2013),               
     &chdedm(2,6),chdeds(2,6),chdedh(2,6)                                       
      double precision hcred,wcred,lcred                                        
c arrays tab..94 are for the child credit ,                                     
c rates are the result of the sum rates for kids over 7 years old and           
c under 7 years old (.22=.13+.09;.195=.115+.08;.17=.10+.07)                     
      dimension tabm94(2,3),tabs94(2,3),tabh94(2,3),ch95(4),                    
     &chlow(4),chhigh(4),rt14(2014:2021)                                        
      integer ch,sep                                                            
c eic rate for 2008-2013                                                        
      data eicr/.035d0,4*.05d0,.045d0/                                          
c standard deduction for 1989+                                                  
      data stdm/14*5000.d0,5500.d0,10*6000.d0,2*15000.d0,16500.d0,              
     & 2*17500.d0,20000.d0,2*21500.d0/                                          
      data stds/25*3000.d0,2*7500.d0,8250.d0,2*8750.d0,10000.d0,                
     & 2*10750.d0/                                                              
      data stdh/25*4400.d0,2*12000.d0,13200.d0,2*14000.d0,15000.d0,             
     & 2*16125.d0/                                                              
c 2018 new Child deduction                                                      
      data chdedm/40000.d0,2500.d0, 60000.d0,2000.d0,80000.d0,1500.d0,          
     &           100000.d0,1000.d0,120000.d0, 500.d0,   1.e20,0.d0/             
      data chdeds/20000.d0,2500.d0, 30000.d0,2000.d0,40000.d0,1500.d0,          
     &            50000.d0,1000.d0, 60000.d0, 500.d0,   1.e20,0.d0/             
      data chdedh/30000.d0,2500.d0, 45000.d0,2000.d0,60000.d0,1500.d0,          
     &            75000.d0,1000.d0, 90000.d0, 500.d0,   1.e20,0.d0/             
      data rt14 /.058d0,2*.0575d0,2*.05499d0,3*.0525d0/                         
      data exem /                                                               
     &      1900.0d0,1950.0d0,2000.0d0,2050.0d0,  2150.0d0,  2300.0d0,          
     &      2350.0d0,2450.0d0,2500.0d0,2550.0d0,  2650.0d0,  2700.0d0,          
     &      2750.0d0,2800.0d0,2900.0d0,3000.0d0,  3050.0d0,  3100.0d0,          
     &      3200.0d0,3300.0d0,3400.0d0,3500.0d0,2*3650.0d0,  3700.0d0,          
     &      3800.0d0,3900.0d0/                                                  
      data ctc95 /   8*60.0d0,    75.0d0, 14* 100.0d0/                          
      data child / 4*2000.0d0,5*2200.0d0,16*2400.0d0,8*3000.0d0/                
      data tabm94/25000.0d0,  .09d0,  40000.0d0,  .08d0,  1.e20,  .07d0/        
      data tabs94/15000.0d0,  .09d0,  24000.0d0,  .08d0,  1.e20,  .07d0/        
      data tabh94/20000.0d0,  .09d0,  32000.0d0,  .08d0,  1.e20,  .07d0/        
      data ch95/  60000.0d0,  100000.0d0,  80000.0d0,  50000.0d0/               
c new in 2014                                                                   
      data chlow /20000.0d0,  40000.0d0, 32000.0d0,  20000.0d0/                 
      data chhigh/50000.0d0, 100000.0d0, 80000.0d0,  50000.0d0/                 
c                                                                               
      data tab77 /2000.0d0,       3.0d0,   4000.0d0,      4.0d0,                
     &      6000.0d0,       5.0d0,  10000.0d0,      6.0d0,                      
     &         1.e20,       7.0d0 /                                             
      data tabs89/12750.0d0, 6.0d0, 1.e20, 7.0d0/                               
      data tabh89/17000.0d0, 6.0d0, 1.e20, 7.0d0/                               
      data tabm89/21750.0d0, 6.0d0, 1.e20, 7.0d0/                               
      data tabs91/12750.0d0, 6.0d0, 60000.0d0,  7.0d0,  1.e20, 7.75d0/          
      data tabh91/17000.0d0, 6.0d0, 80000.0d0,  7.0d0,  1.e20, 7.75d0/          
      data tabm91/21250.0d0, 6.0d0,100000.0d0,  7.0d0,  1.e20, 7.75d0/          
      data tabs01/12750.0d0, 6.0d0 , 60000.0d0,  7.0d0,                         
     & 120000.0d0, 7.75d0,   1.e20, 8.25d0/                                     
      data tabh01/                                                              
     &     17000.0d0, 6.0d0 , 80000.0d0,  7.0d0, 160000.0d0, 7.75d0,            
     &         1.e20, 8.25d0/                                                   
      data tabm01/                                                              
     &     21250.0d0, 6.0d0 ,100000.0d0,  7.0d0, 200000.0d0, 7.75d0,            
     &         1.e20, 8.25d0/                                                   
      data tabs07/                                                              
     &     12750.0d0, 6.0d0 , 60000.0d0,  7.0d0, 120000.0d0, 7.75d0,            
     &         1.e20, 8.0d0/                                                    
      data tabh07/                                                              
     &     17000.0d0, 6.0d0 , 80000.0d0,  7.0d0, 160000.0d0, 7.75d0,            
     &         1.e20, 8.0d0/                                                    
      data tabm07/                                                              
     &     21250.0d0, 6.0d0 ,100000.0d0,  7.0d0, 200000.0d0, 7.75d0,            
     &         1.e20, 8.0d0/                                                    
      data tabs08/                                                              
     &     12750.0d0, 6.0d0 , 60000.0d0,  7.0d0,      1.e20, 7.75d0/            
      data tabh08/                                                              
     &     17000.0d0, 6.0d0 , 80000.0d0,  7.0d0,      1.e20, 7.75d0/            
      data tabm08/                                                              
     &     21250.0d0, 6.0d0 ,100000.0d0,  7.0d0,      1.e20, 7.75d0/            
      data xmp / 3*2000.0d0, 9*2100.0d0, 5*0.0d0 /                              
      data xmp2/ 3*1000.0d0, 9*1100.0d0, 5*0.0d0 /                              
      data xmpc/ 3*600.0d0,700.0d0,8*800.0d0, 5*0.0d0/                          
      data xemp/ 50.0d0, 150.0d0, 300.0d0, 350.0d0,  450.0d0/                   
      data xexemp/                                                              
     &    250.0d0,    50.0d0,   150.0d0,   200.0d0,   250.0d0, 300.0d0,         
     &    400.0d0,   500.0d0,   550.0d0,   600.0d0,   700.0d0, 800.0d0,         
     &    900.0d0,  1000.0d0,2*1150.0d0,  1200.0d0,2*2500.0d0,                  
     &    500.0d0,   550.0d0,   650.0d0,   700.0d0,  750.0d0, 800.0d0,          
     &    900.0d0,  1000.0d0,  1100.0d0,2*1200.0d0, 1300.0d0,1400.0d0,          
     &   1500.0d0,2*1650.0d0,  1700.0d0,2*2000.0d0/                             
      rt = 0.                                                                   
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
c     AGI                                                                       
      agi=comnew(2)                                                             
      if(law.le.1988)agi=agi+ data(62)                                          
c Social Security Benefits are not taxable in NC                                
      if(law.ge.1984)agi=agi-comnew(79)                                         
      if(law.le.1986) then                                                      
        agi=agi+max(0.0d0,comnew(5)-comnew(6))+max(0.0d0,                       
     &   data(12)-comnew(4))+ (data(82)-comnew(78))                             
        if(law.ge.1983.and.law.le.1986)agi=agi+comnew(32)                       
      endif                                                                     
      if(law.ge.1989) then                                                      
        agi=agi-data(22)                                                        
c        agi=max(0.0d0,agi-min(data(20)+data(72),0.0d0,data(9)*2000.))          
      endif                                                                     
c need to check this see page 8 1991 form??????                                 
c Inna's answer is that calculations of North Car. taxable income               
c have nothing to do with agi (06/22/98)                                        
      if(law.ge.1991) agi=agi-data(56)                                          
      agix = max(0.d0,agi)                                                      
      ch = 0                                                                    
      if(data(8).gt.0.and.data(8).lt.2) ch = 1                                  
      if(data(8).gt.1) ch = 2                                                   
c      STATE TAXES BEFORE 1989                                                  
c      must divide up income, deductions, etc                                   
c      before 1989, no joint filing allowed                                     
c      itemized deductions somewhat different from federal deductions           
      if(law.le.1988) then                                                      
c no carryover contributions allowed                                            
        ag = max(0.0d0,agi)                                                     
        char = min((data(58)+data(59)),.15*ag)                                  
        proper=data(51)+data(53)+data(56)                                       
        health=data(47)+data(48)+data(49)                                       
        casu = data(61)                                                         
        if(law.ge.1983) casu = max(0.0d0,data(61)-.1*ag)                        
        xitded=char+proper+data(57)+casu+                                       
     &          data(62)+data(63)+max(health-.05*ag,0.0d0)                      
       if(law.le.1978) then                                                     
        xitded=xitded+min(data(64),4800.0d0)                                    
       else if(law.eq.1979.or.law.eq.1980) then                                 
        xitded=xitded+min(data(64),ch*2000.d0)                                  
       endif                                                                    
       if(mst.eq.2) then                                                        
c  calculate proportion of income for husbands and wives first                  
c  with the figures given for certain credits; if there is no                   
c  information in these, assign arbitrary fraction.                             
         yh = min(agi,max(data(85),data(86)) + (agi-data(11))/2.)               
         yw = agi - yh                                                          
c  interest exclusion                                                           
          if(law.ge.1980.and.law.le.1982) then                                  
            yh=max(0.0d0,yh-min(100.0d0,data(14)/2))                            
            yw=max(0.0d0,yw-min(100.0d0,data(14)/2))                            
          endif                                                                 
c  have to figure deductions and exemptions separately                          
          xh=.5*xitded                                                          
          xw=.5*xitded                                                          
          eh=xmp2(law)                                                          
          ew=xmp(law)                                                           
          if(data(9).gt.1) then                                                 
            oh=1.                                                               
            ow=1.                                                               
          else if(data(9).gt.0..and.data(9).lt.2.) then                         
            oh=1.                                                               
            ow=0.                                                               
          else                                                                  
            oh=0.                                                               
            ow=0.                                                               
          endif                                                                 
          if(data(10).gt.1.) then                                               
            bh=1.                                                               
            bw=1.                                                               
          else if(data(10).gt.0..and.data(10).lt.2.) then                       
            bh=1.                                                               
            bw=0.                                                               
          else                                                                  
            bh=0.                                                               
            bw=0.                                                               
          endif                                                                 
c  also divided dependent exemptions                                            
          ch=nint(data(8)*.5)                                                   
          cw=data(8)-ch                                                         
          eh=eh+((oh+bh)*xmp(law))+(ch*xmpc(law))                               
          ew=ew+((ow+bw)*xmp(law))+(cw*xmpc(law))                               
          if(law.le.1979) then                                                  
            sth=min(.1*yh,500.0d0)                                              
            stw=min(.1*yw,500.0d0)                                              
          else if(law.ge.1980.and.law.le.1988) then                             
            sth=min(.1*yh,550.0d0)                                              
            stw=min(.1*yw,550.0d0)                                              
          endif                                                                 
c  husband and wife required to deduct the same way                             
          if((xh+xw).gt.(sth+stw))then                                          
            dedh=xh                                                             
            dedw=xw                                                             
          else                                                                  
            dedh=sth                                                            
            dedw=stw                                                            
          endif                                                                 
          taxyh=max(0.0d0,yh-dedh-eh)                                           
          taxyw=max(0.0d0,yw-dedw-ew)                                           
          call look(tab77,taxyh,5,n,staxh,1.0d00,0.0d0,hrt,data)                
          call look(tab77,taxyw,5,n,staxw,1.0d00,0.0d0,wrt,data)                
          taxinc = taxyh+taxyw                                                  
          statax = staxh + staxw                                                
       else                                                                     
          if(law.ge.1980.and.law.le.1982) agi=(max(0.0d0,                       
     &                             agi-min(100.0d0,data(14))))                  
          if(law.le.1979) then                                                  
            stded=min(.1*max(0.0d0,agi),500.0d0)                                
          else                                                                  
            stded=min(.1*max(0.0d0,agi),550.0d0)                                
          endif                                                                 
          deduc=max(stded,xitded)                                               
          exemp=xmp(law)+(data(9)+data(10))*xmp2(law)+                          
     &            (data(8)*xmpc(law))                                           
          taxinc=max(0.0d0,agi-deduc-exemp)                                     
          call look(tab77,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)               
       endif                                                                    
      endif                                                                     
c STATE TAXES AFTER 1989                                                        
c Standard Deduction                                                            
c tax (not agi) calculation changes dramatically in 1989                        
      if(law.ge.1989) then                                                      
        if(mst.eq.1) then                                                       
          stded=stds(law)                                                       
        else if(mst.eq.4.or.mst.eq.7) then                                      
          stded=stdh(law)                                                       
        else                                                                    
          stded=stdm(law)/sep                                                   
        endif                                                                   
c Additions for standard deductions for age 65 or older or blind                
        xndx = 0.                                                               
        if(law.le.2013)                                                         
     &     xndx = (data(9)+data(10))*sorm(mst,750.0d0,600.0d0)                  
        stded = stded+xndx                                                      
c Standard deduction for dependents through 2013                                
        if ((law.ge.1994.and.law.le.2013).and.data(105).gt.0.) then             
         eary = comnew(37)                                                      
         if (law.ge.1998.and.law.le.2011) eary = eary + 250                     
         if (law.ge.2012) eary = eary + 300                                     
         if(mst.eq.1)  then                                                     
            stded = min(stded,max(500.0d0,eary))                                
         else if(mst.eq.4.or.mst.eq.7) then                                     
            stded = min(stded,max(500.0d0,eary))                                
         else                                                                   
            stded = min(stded,max(500.0d0,eary))                                
         endif                                                                  
        endif                                    
c Itemized Deductions                                                           
        if(law.le.2011) then                                                    
          if(comnew(26).gt.0.) then                                             
           deduc = min(data(50),max(comnew(24) - stded,0.0d0))                  
           xitded = deduc                                                       
          else                                                                  
           deduc = max(comnew(3) - stded,0.0d0)                                 
          endif                                                                 
        else if(law.ge.2012.and.law.le.2013) then                               
          if(comnew(26).gt.0) then                                              
            deduc = comnew(24)-min(data(50),max(comnew(24)-stded,0.0d0))        
            xitded = deduc                                                      
          else                                                                  
            deduc = stded                                                       
          endif                                                                 
        else if(law.ge.2014) then                                               
c 2014 N.C. itemized deductions are no longer identical to federal itemized dedu
c and are subject to certain limitations.                                       
          xitded =                                                              
     &    min(20000.0d0,data(56)+data(51))+data(58)+data(59)+data(60)           
c New in 2015: N.C. itemized deductions now include medical and dental expenses.
          if(law.ge.2015.and.law.lt.2020) xitded = xitded + comnew(20)          
          if(law.ge.2020)                                                       
     & xitded = xitded + max(0.d0,data(47)+data(48)+data(49)-.075*agix)         
          deduc = max(stded,xitded)                                             
        endif  

c no exemptions until 1990 and 2014+                                            
        exemp = 0.d0                                                            
        if(law.ge.1990.and.law.le.1994) then                                    
           exemp=comnew(68)*xemp(law)                                           
c        if(comnew(2).gt.comnew(109))exemp = exemp*(1 - comnew(108))            
        elseif(law.ge.1995.and.law.le.2013) then                                
c exemptions with federal AGI less than phaseout (Worksheet A)                  
           exemp = comnew(68)*xexemp(law,1)                                     
c NC phaseout                                                                   
           exmphl = filing(mst,60000.,100000.,80000.,50000.)                    
           if(comnew(2).gt.exmphl) then                                         
c exemptions with federal AGI greater than phaseout (Worksheet B)               
              exemp = comnew(68)*xexemp(law,2)                                  
c Federal exemptions before phaseout                                            
              fedxf = comnew(68) * exem(law)                                    
c a taxpayer is required to complete the Deduct for Exempt W/sheet(fed)         
              if(fedxf.gt.comnew(83).and.law.ne.2010) then                      
                 exemp = xexemp(law,2)*comnew(83)/exem(law)                     
c 2006-2009 only special rule for 1/3 and 2/3                                   
                 if(law.ge.2006.and.law.le.2009) then                           
                     if (law.eq.2006)                                           
     &        fedphl = filing(mst,150500.,225750.,188150.,112875.)              
                     if(law.eq.2007)                                            
     &        fedphl = filing(mst,156400.,234600.,195500.,117300.)              
                     if(law.eq.2008)                                            
     &        fedphl = filing(mst,159950.,239950.,199950.,119975.)              
                     if(law.eq.2009)                                            
     &        fedphl = filing(mst,166800.,250200.,208500.,125000.)              
                     if(comnew(2).gt.fedphl.and.                                
     &                  comnew(2)-fedphl.le.122500.d0/sep) then                 
                           if(law.eq.2006.or.law.eq.2007)                       
     &                     exemp = .333*comnew(68)*xexemp(law,2)                
                           if(law.eq.2009.or.law.eq.2008)                       
     &                     exemp = .666*comnew(68)*xexemp(law,2)                
                      endif                                                     
                 endif                                                          
              endif                                                             
           endif                                                                
        endif                                                                   
c deduc - additions to a federal taxable income                                 
c because of difference in ded and exp                                          
        deduc = deduc+exemp  

c next line is for taxsim exemption amount                                      
        if(law.le.2011) exemp = comnew(83) - exemp                              
c  if federal taxable income is less than zero, a taxpayer                      
c  is required to enter negative amount                                         
        if(comnew(26).gt.0.) then                                               
          fedinc = comnew(2)-comnew(24)-comnew(83)                              
        else                                                                    
          fedinc = comnew(2)-comnew(3)-comnew(83)                               
c         if(law.eq.2008.and.data(51).gt.0)                                     
c    &fedinc=comnew(2)-(comnew(3)-min(data(51),500*data(7)))-comnew(83)         
        endif                                                                   
        pens = 0.                                                               
c There are no longer deductions for retirement benefits in 2014+               
        if(data(20)+data(72).gt.0.and.law.le.2013) then                         
          pens = data(7)                                                        
          if(data(9).gt.0) pens = data(9)                                       
        endif                                                                   
        taxinc = max(0.0d0,fedinc + deduc - data(22)-comnew(79)                 
     &   - min(data(20)+data(72),pens*2000.))   
c For tax years beginning on or after January 1, 2012 and through December 31,20
c there is a deduction available for taxpayers who include net business income i
c as reported on the North Carolina individual income tax return.               
c The law allows a deduction of up to $50,000 of net business income            
c included in AGI that is not considered passive under the Internal Revenue Code
c In the case of a married couple filing a joint return where both spouses repor
c the maximum dollar amount applies separately to each spouse's net business inc
c not to exceed a total of $100,000.                                            
        adjbus = 0                                                              
        if (law.eq.2012.or.law.eq.2013) adjbus =                                
     &  min(data(7)*50000,max(0.0d0,data(17))+max(0.0d0,data(21)))              
        agi = comnew(2)-data(22)-comnew(79)-                                    
     &  min(data(20)+data(72),pens*2000.)                                       
c 2020 CARES Act                                                                
        if(law.eq.2020) then                                                    
           agi = agi + data(82) - comnew(78)                                    
           if(comnew(26).lt.1.d0) agi = agi + min(300.d0,data(58))              
        endif                                                                   
        if(law.ge.2012)taxinc = max(0.0d0,agi - adjbus - deduc)                 
c 2018+ new Child Deduction                                                     
        chded = 0.                                                              
        if(law.ge.2018) then                                                    
          fedagi = max(0.d0,comnew(2))                                          
          if(mst.eq.2.or.mst.eq.5) then                                         
             chded = tablki(chdedm,6,fedagi,data)*data(208)                     
          else if(mst.eq.4.or.mst.eq.7) then                                    
             chded = tablki(chdedh,6,fedagi,data)*data(208)                     
          else                                                                  
             chded = tablki(chdeds,6,fedagi,data)*data(208)                     
          endif                                                                 
        endif                                                                   
        taxinc = max(0.d0,taxinc - chded)    
        if(law.le.1990) then                                                    
         if(mst.eq.2.or.mst.eq.5) then                                          
           call look(tabm89,taxinc,2,n,statax,1.0d00,-data(2),rt,data)          
         else if(mst.eq.4.or.mst.eq.7) then                                     
           call look(tabh89,taxinc,2,n,statax,1.0d00,0.0d0,rt,data)             
         else if(mst.eq.1) then                                                 
           call look(tabs89,taxinc,2,n,statax,1.0d00,0.0d0,rt,data)             
         else                                                                   
           call look(tabm89,taxinc,2,n,statax,1.0d00,-data(2),rt,data)          
         endif                                                                  
        else if(law.ge.1991.and.law.le.2000) then                               
         if(mst.eq.4.or.mst.eq.7) then                                          
           call look(tabh91,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)             
         else if(mst.eq.1) then                                                 
           call look(tabs91,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)             
         else                                                                   
           tax1 = taxinc * sep                                                  
           call look(tabm91,tax1,3,n,stat1,1.0d00,0.0d0,rt,data)                
           statax = stat1/sep                                                   
         endif                                                                  
        else if(law.ge.2001.and.law.le.2006) then                               
         if(mst.eq.4.or.mst.eq.7) then                                          
           call look(tabh01,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)             
         else if(mst.eq.1) then                                                 
           call look(tabs01,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)             
         else                                                                   
           tax1 = taxinc * sep                                                  
           call look(tabm01,tax1,4,n,stat1,1.0d00,0.0d0,rt,data)                
           statax = stat1/sep                                                   
         endif                                                                  
        else if(law.eq.2007) then                                               
         if(mst.eq.4.or.mst.eq.7) then                                          
           call look(tabh07,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)             
         else if(mst.eq.1) then                                                 
           call look(tabs07,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)             
         else                                                                   
           tax1 = taxinc * sep                                                  
           call look(tabm07,tax1,4,n,stat1,1.0d00,0.0d0,rt,data)                
           statax = stat1/sep                                                   
         endif                                                                  
        else if(law.ge.2008.and.law.le.2013) then                               
         if(mst.eq.4.or.mst.eq.7) then                                          
           call look(tabh08,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)             
         else if(mst.eq.1) then                                                 
           call look(tabs08,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)             
         else                                                                   
           tax1 = taxinc * sep                                                  
           call look(tabm08,tax1,3,n,stat1,1.0d00,0.0d0,rt,data)                
           statax = stat1/sep                                                   
         endif                                                                  
        else if(law.ge.2014) then                                               
c flat 5.8% rate for 2014 and 5.75% rate for 2015 and 2016,5.499% for 2017      
           statax = rt14(law)*taxinc                                            
        endif                                                                   
      endif                                                                     
                                                                                
c income tax surtax -- 2009-2010                                                
      if(law.ge.2009.and.law.le.2010) then                                      
        if(mst.eq.1) then                                                       
          if(taxinc.gt.60000.and.taxinc.le.150000) statax = 1.02*statax         
          if(taxinc.gt.150000) statax = 1.03*statax                             
        else if(mst.eq.4.or.mst.eq.7) then                                      
          if(taxinc.gt.80000.and.taxinc.le.200000) statax = 1.02*statax         
          if(taxinc.gt.200000) statax = 1.03*statax                             
        else                                                                    
          if(taxinc.gt.100000.d0/sep.and.taxinc.le.250000.d0/sep)               
     &    statax = 1.02*statax                                                  
          if(taxinc.gt.250000.d0/sep) statax = 1.03*statax                      
        endif                                                                   
      endif                                                                     
c Credits                                                                       
      credit = 0.                                                               
      lcred = 0.                                                                
      hcred = 0.                                                                
      wcred = 0.                                                                
c first credit to be taken, low income credit through 1988.                     
      if(law.ge.1986.and.law.le.1988) then                                      
        if(mst.ne.2)then                                                        
          if(agi.le.5000)lcred=25.                                              
          if(agi.le.10000.and.agi.gt.5000.)lcred=20.                            
          if(agi.le.15000.and.agi.gt.10000.)lcred=15.                           
          statax=max(statax-lcred,0.0d0)                                        
          credit = credit + lcred                                               
        else if(mst.eq.2)then                                                   
          if(yh.le.5000)hcred=25.                                               
          if(yh.le.10000.and.yh.gt.5000.)hcred=20.                              
          if(yh.le.15000.and.yh.gt.10000.)hcred=15.                             
          staxh=max(staxh-hcred,0.0d0)                                          
          credit = credit + hcred                                               
          if(yw.le.5000)wcred=25.                                               
          if(yw.le.10000.and.yw.gt.5000.)wcred=20.                              
          if(yw.le.15000.and.yw.gt.10000.)wcred=15.                             
          staxw=max(staxw-wcred,0.0d0)                                          
          credit = credit + wcred                                               
        endif                                                                   
      endif                                                                     
c child care credit                                                             
c 2014+-NC no longer allows a tax credit for child care expenses                
      chcr=0.                                                                   
      if(law.ge.1981.and.law.le.1984) then                                      
        chcr=.07*min(ch*child(law),data(64))                                    
      else if(law.ge.1985.and.law.le.1989) then                                 
        chcr=.07*min(ch*child(law),data(64))                                    
      else if(law.ge.1990.and.law.le.2013) then                                 
c for 1990 onward for kids under 7 years old % is higher than for kids over 7   
c Assume kids are over 7 years old                                              
        if(law.ge.1990.and.law.le.1993) then                                    
           chcr = min(ch*child(law),data(64))*.1                                
        else                                                                    
c Credit for Child and Dependent Care Expenses  for 1994 - 2013                 
c for head of household                                                         
           if(mst.eq.4.or.mst.eq.7) then                                        
             chcr = min(ch*child(law),data(64))*                                
     &            tablki(tabh94,3,comnew(2),data)                               
c for single                                                                    
           else if(mst.eq.1) then                                               
             chcr = min(ch*child(law),data(64))*                                
     &                tablki(tabs94,3,comnew(2),data)                           
c for married jointly and separately                                            
           else                                                                 
             chcr = min(ch*child(law),data(64))*                                
     &              tablki(tabm94,3,comnew(2)*sep,data)                         
           endif                                                                
        endif                                                                   
      endif                                                                     
      statax = max(0.0d0,statax - chcr)                                         
      credit = credit + chcr                                                    
c Credit for solar heating, cooling, or hot water systems                       
c This credit was repealed in 1992                                              
      if(law.le.1991) then                                                      
        ecred = min(1000.0d0,.25*data(38))                                      
        if(law.le.1988.and.mst.eq.2) then                                       
            if(staxh.gt.staxw)staxh = max(staxh-chcr,0.0d0)                     
            if(staxw.ge.staxh)staxw = max(staxw-chcr,0.0d0)                     
            if(staxh.gt.staxw)staxh = max(staxh-ecred,0.0d0)                    
            if(staxw.ge.staxh)staxw = max(staxw-ecred,0.0d0)                    
            statax = staxh+staxw                                                
            rt = (hrt+wrt)/2.                                                   
        endif                                                                   
        statax = max(0.0d0,statax-ecred)                                        
        credit = credit + ecred                                                 
      endif 

c  Tax Credit for children 1995-2017 repealed in 2018                           
      chld = 0.                                                                 
      if(law.ge.1995.and.law.le.2017) then                                      
        ind = int(filing(mst,1.,2.,3.,4.))                                      
        if(law.le.2013.and.comnew(2).lt.ch95(ind)) then                             
          if(law.ge.1998) then
             chld = data(208)*ctc95(law)
          else
             chld = data(8)*ctc95(law)
          endif
        endif 
        if(law.ge.2014) then                                                    
          if(comnew(2).le.chlow(ind)) chld = data(208)*125                      
          if(comnew(2).gt.chlow(ind).and.comnew(2).le.chhigh(ind))              
     &    chld = data(208)*ctc95(law)                                           
        endif                                                                   
        statax = max(0.0d0,statax-chld)                                         
        credit = credit + chld                                                  
      endif 

c Credit for charitable contributions since 1997                                
c This credit can be claimed ONLY by taxpayers who claim                        
c the standard deduction on their federal form                                  
c Credit for Charitable contributions for those who do not itemize their        
c deductions no longer in 2014                                                  
      if((law.ge.1997.and.law.le.2013).and.comnew(26).lt.1.) then               
         contr = max(0.0d0,data(58)+data(59) - .02*comnew(2))                   
         if(law.le.1998) then                                                   
            contr = .0275*contr                                                 
         else                                                                   
            contr = .07*contr                                                   
         endif                                                                  
         statax = max(0.0d0,statax - contr)                                     
         credit = credit + contr                                                
      endif                                                                     
c EITC starting 2008 and through 2013                                           
      earncr = 0.                                                               
      if(law.ge.2008.and.law.le.2013) earncr = eicr(law) * comnew(59)           
c new in  2014 -- no longer State Earned Income Tax Credit                      
      statax = statax - earncr                                                  
      credit = credit + earncr 
      return                                                                    
      end                                                                       
c  NORTH DAKOTA                                                                 
c  State 35                                                                     
c                                                                               
c  Updated through 2021 (03/23/2022)                                            
c                                                                               
      subroutine ndtax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/taxpar/dum(3),zbrack(7)                                            
      common/times/zitem,ptax,txrate,h                                          
      dimension data(255),comnew(255)                                           
      dimension tab77(2,7), tab79(2,6), tab83(2,8), tab87(2,8)                  
      dimension tab01s(2,5), tab01h(2,5), tab01m(2,5)                           
c                                                                               
      dimension tab09(2,5)                                                      
      dimension tab09s(4), tab09h(4), tab09m(4)                                 
      dimension tab10s(4), tab10h(4), tab10m(4)                                 
      dimension tab11(2,5)                                                      
      dimension tab11s(4), tab11h(4), tab11m(4)                                 
      dimension tab12s(4), tab12h(4), tab12m(4)                                 
      dimension tab13(2,5)                                                      
      dimension tab13s(4), tab13h(4), tab13m(4)                                 
      dimension tab14s(4), tab14h(4), tab14m(4)                                 
      dimension tab15(2,5)                                                      
      dimension tab15s(4), tab15h(4), tab15m(4)                                 
      dimension tab16s(4), tab16h(4), tab16m(4)                                 
      dimension tab17s(4), tab17h(4), tab17m(4)                                 
      dimension tab18s(4), tab18h(4), tab18m(4)                                 
      dimension tab19s(4), tab19h(4), tab19m(4)                                 
      dimension tab20s(4), tab20h(4), tab20m(4)                                 
      dimension tab21s(4), tab21h(4), tab21m(4)                                 
                                                                                
      dimension xmp(1977:1986), alt(1981:2000),aif(2001:2008)                   
c earmax,timax from Marriage Credit                                             
      dimension crmax(2007:2021),earmax(2007:2021),timax(2007:2021),            
     &ded(2007:2021)                                                            
      double precision medexp                                                   
      data crmax/                                                               
     &     300.0d0,  305.0d0, 2*280.0d0,  234.0d0,  241.0d0, 198.0d0,           
     &     200.0d0,  185.0d0,   186.0d0,  188.0d0,  192.0d0, 195.0d0,           
     &     198.0d0,  201.0d0/                                                   
      data earmax/                                                              
     &   30154.d0, 30854.0d0,  32212.0d0,  32312.0d0,  32776.0d0,               
     &   33575.d0, 34494.0d0,  35045.0d0,  35555.0d0,  35705.0d0,               
     &   35955.d0, 38055.0d0,  38756.0d0,  39430.0d0,  39830.0d0/               
      data timax/                                                               
     &   53254.0d0, 54454.0d0,  56812.0d0,  56912.0d0,  57775.0d0,              
     &   59175.0d0, 60744.0d0,  61950.0d0,  62705.0d0,  63005.0d0,              
     &   63505.0d0, 64755.0d0,  66006.0d0,  67312.0d0,  67812.0d0/              
      data ded/                                                                 
     &    8750.0d0,  8950.0d0, 2*9350.0d0,   9500.0d0,  9750.0d0,               
     &   10000.0d0, 10150.0d0,  10300.0d0,  10350.0d0, 10400.0d0,               
     &   12000.0d0, 12200.0d0,  12400.0d0,  12550.0d0/                          
      data aif/                                                                 
     &       1.0d0, 1.033d0, 1.05d0, 1.073d0, 1.098d0, 1.133d0,                 
     &     1.177d0, 1.203d0/                                                    
      data alt/   2*.075d0, 4*.105d0, 14*.14d0/                                 
      data xmp/   4*750.0d0, 4*1000.0d0, 1040.0d0, 1080.0d0/                    
      data tab77/                                                               
     &    1000.0d0, 1.0d0  ,  3000.0d0,  2.0d0, 5000.0d0, 3.0d0,                
     &    6000.0d0, 3.0d0  ,  7000.0d0,  5.0d0, 8000.0d0, 7.5d0,                
     &       1.e20,10.0d0/                                                      
      data tab79/                                                               
     &    3000.0d0, 1.0d0  ,  5000.0d0,  2.0d0, 8000.0d0, 3.0d0,                
     &   12000.0d0, 4.0d0  , 30000.0d0,  5.0d0,    1.e20, 7.5d0/                
      data tab83/                                                               
     &    3000.0d0, 2.0d0  ,  5000.0d0,  3.0d0,  8000.0d0, 4.0d0,               
     &   15000.0d0, 5.0d0  , 25000.0d0,  6.0d0, 35000.0d0, 7.0d0,               
     &   50000.0d0, 8.0d0  ,  1.e20,  9.0d0/                                    
      data tab87/                                                               
     &    3000.0d0, 2.67d0 ,  5000.0d0,  4.0d0,  8000.0d0, 5.33d0,              
     &   15000.0d0, 6.67d0 , 25000.0d0,  8.0d0, 35000.0d0, 9.33d0,              
     &   50000.0d0,10.67d0 ,     1.e20, 12.0d0/                                 
      data tab01s/                                                              
     &   27050.0d0, 2.1d0  ,  65550.0d0, 3.92d0, 136750.0d0, 4.34d0,            
     &  297350.0d0, 5.04d0 ,      1.e20, 5.54d0/                                
      data tab01h/                                                              
     &   35250.0d0, 2.1d0  ,  93650.0d0, 3.92d0, 151650.0d0, 4.34d0,            
     &  297350.0d0, 5.04d0 ,      1.e20, 5.54d0/                                
      data tab01m/                                                              
     &   45200.0d0, 2.1d0  , 109250.0d0, 3.92d0, 166500.0d0, 4.34d0,            
     &  297350.0d0, 5.04d0 ,      1.e20, 5.54d0/                                
c 2009-2010                                                                     
      data tab09/0.d0,1.84d0,0.d0,3.44d0,0.d0,3.81d0,0.d0,4.42d0,               
     & 1.e20, 4.86d0/                                                           
      data tab09s/33950.d0, 82250.d0,171550.d0,372950.d0/                       
      data tab09h/45500.d0,117450.d 0,190200.d0,372950.d0/                      
      data tab09m/56750.d0,137050.d0,208850.d0,372950.d0/                       
      data tab10s/34000.d0, 82400.d0,171850.d0,373650.d0/                       
      data tab10h/45550.d0,117650.d0,190550.d0,373650.d0/                       
      data tab10m/56850.d0,137300.d0,209250.d0,373650.d0/                       
c 2011-2012                                                                     
      data tab11/0.d0,1.51d0,0.d0,2.82d0,0.d0,3.13d0,0.0d0,3.63d0,              
     & 1.e20, 3.99d0/                                                           
      data tab11s/34500.d0, 83600.d0,174400.d0,379150.d0/                       
      data tab11h/46250.d0,119400.d0,193350.d0,379150.d0/                       
      data tab11m/57700.d0,139350.d0,212300.d0,379150.d0/                       
      data tab12s/35350.d0, 85650.d0,178650.d0,388350.d0/                       
      data tab12h/47350.d0,122300.d0,198050.d0,388350.d0/                       
      data tab12m/59100.d0,142700.d0,217450.d0,388350.d0/                       
c 2013-2014                                                                     
      data tab13/0.d0,1.22d0,0.d0,2.27d0,0.d0, 2.52d0,398350.d0,2.93d0,         
     & 1.e20, 3.22d0/                                                           
      data tab13s/36250.d0, 87850.d0,183250.d0,398350.d0/                       
      data tab13h/48600.d0,125450.d0,203150.d0,398350.d0/                       
      data tab13m/60650.d0,146400.d0,223050.d0,398350.d0/                       
      data tab14s/36900.d0, 89350.d0,186350.d0,405100.d0/                       
      data tab14h/49400.d0,127550.d0,206600.d0,405100.d0/                       
      data tab14m/61700.d0,148850.d0,226850.d0,405100.d0/                       
c 2015-2021                                                                     
      data tab15/0.d0,1.1d0,0.d0,2.04d0,0.d0,2.27d0,0.d0,2.64d0,                
     & 1.e20,2.9d0/                                                             
      data tab15s/37450.d0, 90750.d0,189300.d0,411500.d0/                       
      data tab15h/50200.d0,129600.d0,209850.d0,411500.d0/                       
      data tab15m/62600.d0,151200.d0,230450.d0,411500.d0/                       
      data tab16s/37650.d0, 91150.d0,190150.d0,413350.d0/                       
      data tab16h/50400.d0,130150.d0,210800.d0,413350.d0/                       
      data tab16m/62900.d0,151900.d0,231450.d0,413350.d0/                       
      data tab17s/37950.d0, 91900.d0,190650.d0,416700.d0/                       
      data tab17h/50800.d0,131200.d0,212500.d0,416700.d0/                       
      data tab17m/63400.d0,153100.d0,233350.d0,416700.d0/                       
      data tab18s/38700.d0, 93700.d0,195450.d0,424950.d0/                       
      data tab18h/51850.d0,133850.d0,216700.d0,424950.d0/                       
      data tab18m/64650.d0,156150.d0,237950.d0,424950.d0/                       
      data tab19s/39450.d0, 95500.d0,199250.d0,433200.d0/                       
      data tab19h/52850.d0,136450.d0,220900.d0,433200.d0/                       
      data tab19m/65900.d0,159200.d0,242550.d0,433200.d0/                       
      data tab20s/40125.d0, 97150.d0,202650.d0,440600.d0/                       
      data tab20h/53750.d0,138800.d0,224700.d0,440600.d0/                       
      data tab20m/67050.d0,161950.d0,246700.d0,440600.d0/                       
      data tab21s/40525.d0, 98100.d0,204675.d0,445000.d0/                       
      data tab21h/54300.d0,140200.d0,226950.d0,445000.d0/                       
      data tab21m/67700.d0,163550.d0,249150.d0,445000.d0/                       
                                                                                
c                                                                               
      txp = data(7)                                                             
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      exemp = 0.                                                                
      deduc = 0.                                                                
      stded = 0.                                                                
      xitded = 0.                                                               
      earncr = 0.                                                               
      rt=0                                                                      
c Federal Tax deduction for years =<2000                                        
      fded = 0.                                                                 
c      pcn = 1                                                                  
c      fded=(max(0.0d0,comnew(1)+data(34)-data(44))) * pcn                      
c      if(comnew(2).gt.0.0d0) pcn=twn(agi/comnew(2),0.0d0,1.0d0)                
      if(law.le.2000)                                                           
     & fded = max(0.0d0,comnew(77)-comnew(58)+data(34)+data(39)+data(42)        
     &-comnew(59)+comnew(70))                                                   
c      fded = max(0.0d0,fded) * pcn                                             
                                                                                
c Tax before credits for years 1977-1986                                        
      if(law.le.1986) then                                                      
c  AGI                                                                          
        agi=comnew(2)                                                           
        if(law.le.1980) then                                                    
          agi = agi + (comnew(7)/6.) - xif(law.eq.1980,data(22))                
        else if(law.eq.1981.or.law.eq.1982) then                                
          agi = agi - data(22)                                                  
c  interest exclusion is in addition to federal int/div excl                    
c  can't exclude the same interest twice                                        
          agi = agi - min(data(14),200.0d0*data(7))                             
          if(law.eq.1982) agi = agi + divexc(data,comnew,law)                   
        else if(law.ge.1983) then                                               
          if(law.eq.1985)agi = agi - comnew(79)                                 
          agi=agi-data(22)-min(data(14),300.*txp)                               
        endif                                                                   
c  Itemized Deductions                                                          
        xitded=max(0.0d0,                                                       
     &  comnew(24)+data(47)+data(48)+data(49)-comnew(20))                       
        if(law.le.1980) then                                                    
          if(mst.eq.1.or.mst.eq.7.or.mst.eq.4) then                             
            stded=twn(.16*agi,1700.0d0,2400.0d0)                                
          else                                                                  
            stded=twn(.16*agi,2100.0d0/sep,2800.0d0/sep)                        
          endif                                                                 
        else                                                                    
          stded=comnew(3)                                                       
        endif                                                                   
c must itemize if federal itemizer                                              
        if(comnew (26).gt.0.0d0) then                                           
          deduc = xitded+fded                                                   
        else                                                                    
          deduc = max(stded,xitded)+fded                                        
        endif                                                                   
c Exemptions                                                                    
        exemp=comnew(68)*xmp(law)                                               
        if(mst.eq.2.or.mst.eq.4.or.mst.eq.5.or.mst.eq.7)                        
     &  exemp = exemp + 300.                                                    
        taxinc = max(0.0d0,agi-deduc-exemp)                                     
        if(law.eq.1977) then                                                    
          call look(tab77,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)               
        else if(law.ge.1978.and.law.le.1982) then                               
          call look(tab79,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)               
        else if(law.ge.1983.and.law.le.1986) then                               
          call look(tab83,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)               
        endif                                                                   
c Tax before credits for years 1987-2000                                        
      else if(law.ge.1987.and.law.le.2000) then                                 
c Since 1987 Federal Taxable Income has become a base for imputing              
c North Dakota Taxable Income                                                   
c                                                                               
c addex - additional exemption amount for Married Filing joint or               
c Head of household or Qualifying widow.                                        
        medexp = 0.                                                             
        addex = 0.                                                              
        if(mst.eq.2.or.mst.eq.4.or.mst.eq.5.or.mst.eq.7) addex = 300.           
        if(data(49).gt..075*comnew(2).and.comnew(26).gt.0.0d0)                  
     &     medexp = data(49) - .075*comnew(2)                                   
        taxinc = max(0.0d0,comnew(29)+data(50)-fded-addex-medexp)               
        call look(tab87,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)                 
c Tax before credits for years 2001+                                            
      else if(law.ge.2001) then                                                 
c 30% of the excess of net long-term capital gain over a net short-term capital 
c 2013+, it became 40%                                                          
        gshort = data(68)                                                       
        glong = data(70)                                                        
        fullcg = gshort+glong                                                   
        cgltg = 0.                                                              
        if(fullcg.gt.0.) then                                                   
            if(glong.gt.0..and.gshort.ge.0.) cgltg = glong                      
            if(glong.gt.0..and.gshort.lt.0.) cgltg = fullcg                     
        endif                                                                   
        cgltg = cgltg + data(18)                                                
        if(law.lt.2013) cgexc = .3*max(0.0d0,cgltg)                             
        if(law.ge.2013) cgexc = .4*max(0.0d0,cgltg)                             
c Qualified dividends exclusion                                                 
        qdiv = 0.                                                               
        if(law.ge.2009.and.law.le.2012) qdiv = .3*data(176)                     
        if(law.ge.2013) qdiv = .4*data(176)                                     
        taxinc = max(0.0d0,comnew(29) - cgexc - qdiv)                           
c 2019-20 taxable ssb deductible if fed agi le 50k or 100k for married          
        if((law.ge.2019.and.law.le.2020).and.comnew(2).le.50000.d0*txp)         
     &  taxinc = max(0.d0,taxinc - comnew(79))                                  
c 2021+ taxable ssb deductible                                                  
        if(law.ge.2021) taxinc = max(0.d0,taxinc - comnew(79))                  
        if(law.le.2008) then                                                    
c 2001-8                                                                        
         if(mst.eq.1) then                                                      
           call look(tab01s,taxinc,5,n,statax,aif(law),0.0d0,rt,data)           
         else if(mst.eq.4.or.mst.eq.7) then                                     
           call look(tab01h,taxinc,5,n,statax,aif(law),0.0d0,rt,data)           
         else                                                                   
          call look(tab01m,taxinc,5,n,statax,aif(law),-data(2),rt,data)         
         endif                                                                  
        else if(law.ge.2009.and.law.le.2010) then                               
c 2009-10                                                                       
         if(law.eq.2009) then                                                   
            do 2009 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab09(1,i) = tab09s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab09(1,i) = tab09h(i)                                          
              else                                                              
                tab09(1,i) = tab09m(i)/sep                                      
              endif                                                             
2009        continue                                                            
         else if(law.eq.2010) then                                              
            do 2010 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab09(1,i) = tab10s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab09(1,i) = tab10h(i)                                          
              else                                                              
                tab09(1,i) = tab10m(i)/sep                                      
              endif                                                             
2010        continue                                                            
         endif                                                                  
         call look(tab09,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.ge.2011.and.law.le.2012) then                               
c 2011-2                                                                        
         if(law.eq.2011) then                                                   
            do 2011 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab11(1,i) = tab11s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab11(1,i) = tab11h(i)                                          
              else                                                              
                tab11(1,i) = tab11m(i)/sep                                      
              endif                                                             
2011        continue                                                            
         else if(law.eq.2012) then                                              
            do 2012 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab11(1,i) = tab12s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab11(1,i) = tab12h(i)                                          
              else                                                              
                tab11(1,i) = tab12m(i)/sep                                      
              endif                                                             
2012        continue                                                            
         endif                                                                  
         call look(tab11,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                 
       else if(law.ge.2013.and.law.le.2014) then                                
c 2013-4                                                                        
         if(law.eq.2013) then                                                   
            do 2013 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab13(1,i) = tab13s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab13(1,i) = tab13h(i)                                          
              else                                                              
                tab13(1,i) = tab13m(i)/sep                                      
              endif                                                             
2013        continue                                                            
         else if(law.eq.2014) then                                              
            do 2014 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab13(1,i) = tab14s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab13(1,i) = tab14h(i)                                          
              else                                                              
                tab13(1,i) = tab14m(i)/sep                                      
              endif                                                             
2014        continue                                                            
         endif                                                                  
         call look(tab13,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.ge.2015) then                                               
c 2015-2020                                                                     
         if(law.eq.2015) then                                                   
            do 2015 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab15(1,i) = tab15s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab15(1,i) = tab15h(i)                                          
              else                                                              
                tab15(1,i) = tab15m(i)/sep                                      
              endif                                                             
2015        continue                                                            
         else if(law.eq.2016) then                                              
            do 2016 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab15(1,i) = tab16s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab15(1,i) = tab16h(i)                                          
              else                                                              
                tab15(1,i) = tab16m(i)/sep                                      
              endif                                                             
2016        continue                                                            
         else if(law.eq.2017) then                                              
            do 2017 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab15(1,i) = tab17s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab15(1,i) = tab17h(i)                                          
              else                                                              
                tab15(1,i) = tab17m(i)/sep                                      
              endif                                                             
2017        continue                                                            
         else if(law.eq.2018) then                                              
            do 2018 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab15(1,i) = tab18s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab15(1,i) = tab18h(i)                                          
              else                                                              
                tab15(1,i) = tab18m(i)/sep                                      
              endif                                                             
2018        continue                                                            
         else if(law.eq.2019) then                                              
            do 2019 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab15(1,i) = tab19s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab15(1,i) = tab19h(i)                                          
              else                                                              
                tab15(1,i) = tab19m(i)/sep                                      
              endif                                                             
2019        continue                                                            
         else if(law.eq.2020) then                                              
            do 2020 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab15(1,i) = tab20s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab15(1,i) = tab20h(i)                                          
              else                                                              
                tab15(1,i) = tab20m(i)/sep                                      
              endif                                                             
2020        continue                                                            
         else if(law.eq.2021) then                                              
            do 2021 i=1,4                                                       
              if(mst.eq.1) then                                                 
                tab15(1,i) = tab21s(i)                                          
              else if(mst.eq.4.or.mst.eq.7) then                                
                tab15(1,i) = tab21h(i)                                          
              else                                                              
                tab15(1,i) = tab21m(i)/sep                                      
              endif                                                             
2021        continue                                                            
                                                                                
         endif                                                                  
         call look(tab15,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                 
        endif                                                                   
      endif                                                                     
      credit = 0                                                                
c  Contribution Credit                                                          
      contcr = 0.                                                               
c  credit is actually allowed only against educational contributions;           
c  I am assuming rational citizens, if they choose to contribute,               
c  they will see it is profitable to give to education.                         
      if(law.le.1999) then                                                      
        contcr = min(.5*(data(58)+data(59)+data(60)),.4*statax)                 
        if(law.le.1980)contcr = min(contcr,100.0d0)                             
        if(law.ge.1981)contcr = min(contcr,250.0d0)                             
      endif                                                                     
      statax = max(0.0d0,statax-contcr-(data(38)/3.5))                          
      credit = credit + contcr + (data(38)/3.5)                                 
c alternate tax calculation  Form 37-S (Short form) 1981-2000                   
c The majority of taxpayers will benefit by using Form 37-S                     
c                                                                               
      if(law.ge.1981.and.law.le.2000) then                                      
c        fedtax = max(0.0d0,comnew(52))*pcn                                     
        fedtax = comnew(52)                                                     
        tax2 = alt(law)*fedtax                                                  
        if(tax2.lt.statax) then                                                 
          statax = tax2                                                         
          rt = alt(law)*comnew(72)/100.                                         
        endif                                                                   
c "Energy Cost Relief Credit" up to a maximum of r100 only                      
c  in 1981 and 1982                                                             
        costcr = 0.                                                             
        if(law.eq.1981.or.law.eq.1982) costcr=twn(statax,0.0d0,100.0d0)         
        statax = max(0.0d0,statax - costcr)                                     
        credit = credit + costcr                                                
      endif                                                                     
c 2007 + Marriage Credit -- non-refundable.                                     
      do 1000 i=1,4                                                             
c Single tax rate schedule                                                      
        if(law.eq.2009) tab09(1,i) = tab09s(i)                                  
        if(law.eq.2010) tab09(1,i) = tab10s(i)                                  
        if(law.eq.2011) tab11(1,i) = tab11s(i)                                  
        if(law.eq.2012) tab11(1,i) = tab12s(i)                                  
        if(law.eq.2013) tab13(1,i) = tab13s(i)                                  
        if(law.eq.2014) tab13(1,i) = tab14s(i)                                  
        if(law.eq.2015) tab15(1,i) = tab15s(i)                                  
        if(law.eq.2016) tab15(1,i) = tab16s(i)                                  
        if(law.eq.2017) tab15(1,i) = tab17s(i)                                  
        if(law.eq.2018) tab15(1,i) = tab18s(i)                                  
        if(law.eq.2019) tab15(1,i) = tab19s(i)                                  
        if(law.eq.2020) tab15(1,i) = tab20s(i)                                  
        if(law.eq.2021) tab15(1,i) = tab21s(i)                                  
c add tab22s when it is available                                               
1000    continue                                                                
c      write(0,*) ((tab15(k,m),k=1,2),m=1,5)                                    
      if(law.ge.2007.and.mst.eq.2) then                                         
          if(taxinc.gt.timax(law).and.min(data(86),data(85)).                   
     &    gt.earmax(law)) then                                                  
             taxin3 = max(0.0d0,min(data(85),data(86))-ded(law))                
             if(law.le.2008)                                                    
     &  call look(tab01s,taxin3,5,n,tax3,aif(law),0.0d0,rt3,data)               
             if(law.eq.2009.or.law.eq.2010)                                     
     &  call look(tab09,taxin3,5,n,tax3,1.0d0,0.0d0,rt3,data)                   
             if(law.eq.2011.or.law.eq.2012)                                     
     &  call look(tab11,taxin3,5,n,tax3,1.0d0,0.0d0,rt3,data)                   
             if(law.eq.2013.or.law.eq.2014)                                     
     &  call look(tab13,taxin3,5,n,tax3,1.0d0,0.0d0,rt3,data)                   
             if(law.ge.2015)                                                    
     &  call look(tab15,taxin3,5,n,tax3,1.0d0,0.0d0,rt3,data)                   
             taxin4 = max(taxinc - taxin3,0.0d0)                                
             if(law.le.2008)                                                    
     &  call look(tab01s,taxin4,5,n,tax4,aif(law),0.0d0,rt4,data)               
             if(law.eq.2009.or.law.eq.2010)                                     
     &  call look(tab09,taxin4,5,n,tax4,1.0d0,0.0d0,rt4,data)                   
             if(law.eq.2011.or.law.eq.2012)                                     
     &  call look(tab11,taxin4,5,n,tax4,1.0d0,0.0d0,rt4,data)                   
             if(law.eq.2013.or.law.eq.2014)                                     
     &  call look(tab13,taxin4,5,n,tax4,1.0d0,0.0d0,rt4,data)                   
             if(law.ge.2015)                                                    
     &  call look(tab15,taxin4,5,n,tax4,1.0d0,0.0d0,rt4,data)                   
             crdmar = max(0.0d0,statax - tax3 -tax4)                            
             crdmar = min(crmax(law),crdmar)                                    
             credit = credit + crdmar                                           
             statax = max(0.0d0,statax - crdmar)                                
          endif                                                                 
      endif                                                                     
c 2021-22 not refundable tax relief income tax credit for ND residents          
      if(law.eq.2021.or.law.eq.2022) then                                       
        relief = 350.d0*txp                                                     
        statax = max(0.0d0,statax - relief)                                     
        credit = credit + relief                                                
      endif                                                                     
      return                                                                    
      end                                                                       
c  OHIO                                                                         
c  State 36                                                                     
c                                                                               
c  Updated through 2021 (03/24/2022)                                            
c                                                                               
      subroutine ohtax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/times/z,p,txrate,h                                                 
      common/x/ct                                                               
      dimension data(255),comnew(255),tab(2,8),tab77(2,6)                       
      dimension tab83(8,8),sentab(2,6),tab93(2,9),tab96(2,9),tab97(2,9)         
     &,tab98(2,9),tab99(2,9),tab00(2,9),tab01(2,9),tab05(2,9),tab06(2,9)        
     &,tab07(2,9),tab08(2,9),tab11(2,9),tab13(2,9),tab16(2,9)                   
     &,rt13(9),rt14(9),rt15(9),bus15(2,6)                                       
     &,pc15(2015:2021),ph15(2015:2021),eicr(2013:2021)                          
     &,aif(2008:2012),xmp(1977:2021),exmp(2014:2021,2)                          
     &,tab17(2,8),tab18(2,8),tab19(2,6),tab20(2,6),tab21(2,5)                   
c eicr from line 13 instructions                                                
      data eicr/.05d0,5*.1d0,3*.3d0/                                            
      data pc15/.75d0, 6*1.d0/                                                  
      data ph15/187500.d0,6*250000.d0/                                          
      data exmp/                                                                
     1    2*2200.0d0, 2250.0d0,2300.d0,2*2350.0d0,2*2400.d0,                    
     2    2*1950.0d0, 2000.0d0,2050.d0,2*2100.0d0,2*2150.d0/                    
c xmp line 4 Ohio IT 1040                                                       
      data xmp /                                                                
     & 19* 650.0d0, 750.d0, 850.0d0, 950.0d0, 1050.0d0,  1100.0d0,              
     &    1150.0d0,1200.d0,1250.0d0,1300.0d0, 1350.0d0,  1400.0d0,              
     &    1450.0d0,1500.d0,1550.0d0,1600.0d0, 1650.0d0,4*1700.0d0,              
     &    1750.0d0,1800.d0,2*1850.0d0,2*1900.d0/                                
      data aif /2*1.0d0,1.010d0,1.0d0,1.02d0/                                   
      data bus15/5200.0d0, .495d0, 10400.0d0, .990d0, 15650.0d0,1.98d0,         
     &          20900.0d0,2.476d0, 41700.0d0,2.969d0,     1.e20,3.0d0/          
      data tab77 /                                                              
     &     5000.0d0, .5d0,  10000.0d0,  1.0d0, 15000.0d0,  2.0d0,               
     &    20000.0d0,2.50d0, 40000.0d0,  3.0d0,     1.e20,  3.5d0/               
c                       1982,    1983, 1984,  1985,  1986,  1987,  1988         
      data tab83/                                                               
     & 5000.0d0, .625d0, .9165d0, .95d0, .903d0, .855d0, .751d0, .743d0,        
     &10000.0d0,1.25d0 ,1.833d0 ,1.9d0 ,1.805d0,1.71d0 ,1.502d0,1.486d0,        
     &15000.0d0,2.5d0  ,3.666d0 ,3.8d0 ,3.61d0 ,3.42d0 ,3.004d0,2.972d0,        
     &20000.0d0,3.125d0,4.5825d0,4.75d0,4.513d0,4.275d0,3.755d0,3.715d0,        
     &40000.0d0,3.75d0 ,5.499d0 ,5.7d0 ,5.415d0,5.13d0 ,4.506d0,4.457d0,        
     &80000.0d0,4.375d0,6.4155d0,6.65d0,6.318d0,5.985d0,5.257d0,5.201d0,        
     &100000.0d0, 5.0d0,7.332d0 ,7.6d0 ,7.22d0 ,6.84d0 ,6.008d0,5.943d0,        
     &1.e20,    6.25d0 ,9.165d0 ,9.5d0 ,9.025d0,8.55d0 ,6.9d0  ,6.9d0/          
      data tab/                                                                 
     &  5000.0d0,  0.0d0,  10000.0d0, 0.0d0,  15000.0d0, 0.0d0,                 
     &  20000.0d0, 0.0d0,  40000.0d0, 0.0d0,  80000.0d0, 0.0d0,                 
     & 100000.0d0, 0.0d0,  1.e20, 0.0d0/                                        
      data tab93/                                                               
     &     5000.0d0, .0d0  ,  10000.0d0,  .0d0  , 15000.0d0,  .0d0,             
     &    20000.0d0, .0d0  ,  40000.0d0,  .0d0  , 80000.0d0,  .0d0,             
     &   100000.0d0, .0d0  , 200000.0d0,  .0d0  ,     1.e20, 7.5d0/             
      data tab96/                                                               
     &     5000.0d0, .693d0,  10000.0d0, 1.387d0, 15000.0d0, 2.775d0,           
     &    20000.0d0,3.469d0,  40000.0d0, 4.162d0, 80000.0d0, 4.857d0,           
     &   100000.0d0,5.55d0 , 200000.0d0, 6.444d0,     1.e20, 7.004d0/           
      data tab97/                                                               
     &     5000.0d0, .713d0,  10000.0d0, 1.426d0, 15000.0d0, 2.853d0,           
     &    20000.0d0,3.566d0,  40000.0d0, 4.279d0, 80000.0d0, 4.993d0,           
     &   100000.0d0,5.706d0, 200000.0d0, 6.624d0,     1.e20, 7.201d0/           
      data tab98/                                                               
     &     5000.0d0, .673d0,  10000.0d0, 1.347d0, 15000.0d0, 2.694d0,           
     &    20000.0d0,3.368d0,  40000.0d0, 4.040d0, 80000.0d0, 4.715d0,           
     &   100000.0d0,5.388d0, 200000.0d0, 6.255d0,     1.e20, 6.799d0/           
      data tab99/                                                               
     &     5000.0d0, .716d0,  10000.0d0, 1.432d0, 15000.0d0, 2.864d0,           
     &    20000.0d0,3.58d0 ,  40000.0d0, 4.295d0, 80000.0d0, 5.012d0,           
     &   100000.0d0,5.727d0, 200000.0d0, 6.65d0 ,     1.e20, 7.228d0/           
      data tab00/                                                               
     &     5000.0d0, .691d0,  10000.0d0, 1.383d0, 15000.0d0, 2.766d0,           
     &    20000.0d0,3.458d0,  40000.0d0, 4.148d0, 80000.0d0, 4.841d0,           
     &   100000.0d0,5.531d0, 200000.0d0, 6.422d0,     1.e20, 6.980d0/           
      data tab01/                                                               
     &     5000.0d0, .743d0,  10000.0d0, 1.486d0, 15000.0d0, 2.972d0,           
     &    20000.0d0,3.715d0,  40000.0d0, 4.457d0, 80000.0d0, 5.201d0,           
     &   100000.0d0,5.943d0, 200000.0d0, 6.9d0  ,     1.e20, 7.50d0/            
      data tab05/                                                               
     &     5000.0d0, .712d0,  10000.0d0, 1.424d0, 15000.0d0, 2.847d0,           
     &    20000.0d0,3.559d0,  40000.0d0, 4.270d0, 80000.0d0, 4.983d0,           
     &   100000.0d0,5.693d0, 200000.0d0, 6.610d0,     1.e20, 7.185d0/           
      data tab06/                                                               
     &     5000.0d0, .681d0,  10000.0d0, 1.361d0, 15000.0d0, 2.722d0,           
     &    20000.0d0,3.403d0,  40000.0d0, 4.083d0, 80000.0d0, 4.764d0,           
     &   100000.0d0,5.444d0, 200000.0d0, 6.32d0 ,     1.e20, 6.870d0/           
      data tab07/                                                               
     &     5000.0d0, .649d0,  10000.0d0, 1.299d0, 15000.0d0, 2.598d0,           
     &    20000.0d0,3.247d0,  40000.0d0, 3.895d0, 80000.0d0, 4.546d0,           
     &   100000.0d0,5.194d0, 200000.0d0, 6.031d0,     1.e20, 6.555d0/           
      data tab08/                                                               
     &     5000.0d0, .618d0,  10000.0d0, 1.236d0, 15000.0d0, 2.473d0,           
     &    20000.0d0,3.091d0,  40000.0d0, 3.708d0, 80000.0d0, 4.327d0,           
     &   100000.0d0,4.945d0, 200000.0d0, 5.741d0,     1.e20, 6.24d0/            
      data tab11/                                                               
     &     5100.0d0, .587d0,  10200.0d0,  1.174d0, 15350.0d0, 2.348d0,          
     &    20450.0d0,2.935d0,  40850.0d0,  3.521d0, 81650.0d0, 4.109d0,          
     &   102100.0d0,4.695d0, 204200.0d0,  5.451d0,     1.e20, 5.925d0/          
      data tab13/                                                               
     &     5200.0d0, .0d0,  10400.0d0,  .0d0, 15650.0d0, .0d0,                  
     &    20900.0d0, .0d0,  41700.0d0,  .0d0, 83350.0d0, .0d0,                  
     &   104250.0d0, .0d0, 208500.0d0,  .0d0,     1.e20, .0d0/                  
      data tab16/                                                               
     &     5200.0d0, .0d0,  10500.0d0,  .0d0, 15800.0d0, .0d0,                  
     &    21100.0d0, .0d0,  42100.0d0,  .0d0, 84200.0d0, .0d0,                  
     &   105300.0d0, .0d0, 210600.0d0,  .0d0,     1.e20, .0d0/                  
                                                                                
      data rt13/ .537d0, 1.074d0, 2.148d0,2.686d0, 3.222d0, 3.760d0,            
     &          4.296d0, 4.988d0, 5.421d0/                                      
      data rt14/ .528d0, 1.057d0, 2.113d0,2.642d0, 3.169d0, 3.698d0,            
     &          4.226d0, 4.906d0, 5.333d0/                                      
      data rt15/ .495d0,  .990d0, 1.98d0,2.476d0, 2.969d0, 3.465d0,             
     &          3.960d0, 4.597d0, 4.997d0/                                      
      data tab17/                                                               
     &    10650.d0, 0.742d0, 16000.d0, 1.98d0 , 21350.d0, 2.476d0,              
     &    42650.d0, 2.969d0, 85300.d0, 3.465d0,106650.d0, 3.960d0,              
     &   213350.d0, 4.597d0,    1.e20, 4.997d0/                                 
      data tab18/                                                               
     &    10850.d0, 0.742d0, 16300.d0, 1.98d0 , 21750.d0, 2.476d0,              
     &    43450.d0, 2.969d0, 86900.d0, 3.465d0,108700.d0, 3.960d0,              
     &   217400.d0, 4.597d0,    1.e20, 4.997d0/                                 
      data tab19/                                                               
     &    21750.d0, 1.427d0, 43450.d0, 2.85d0, 86900.d0, 3.326d0,               
     &   108700.d0, 3.802d0, 217400.d0, 4.413d0,  1.e20, 4.797d0/               
      data tab20/                                                               
     &    22150.d0, 1.427d0, 44250.d0, 2.85d0, 88450.d0, 3.326d0,               
     &   110650.d0, 3.802d0, 221300.d0, 4.413d0,  1.e20, 4.797d0/               
      data tab21/                                                               
     &    25000.d0, 1.385d0, 44250.d0, 2.765d0, 88450.d0,3.226d0,               
     &   110650.d0, 3.668d0,    1.e20, 3.99d0/                                  
      data sentab/500.0d0, 0.0d0, 1500.0d0, 25.0d0, 3000.0d0,                   
     & 50.0d0, 5000.0d0, 80.0d0, 8000.0d0, 130.0d0, 1.e20, 200.0d0/             
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
c AGI                                                                           
      agi = comnew(2)                                                           
c state y tx refunds and disability are always subtracted from agi              
      agi = agi - data(22)-comnew(82)                                           
      if(law.le.1982.and.data(9).gt.0) then                                     
        agi=agi-min(data(20)+data(72),4000.0d0)                                 
      endif                                                                     
      if(law.ge.1980) agi = agi-xjobs(data,law)                                 
      if(law.ge.1984) agi = agi-comnew(79)                                      
c For tax year 2015, the business income deduction at 75%, continuing           
      businc = 0.                                                               
      statb = 0.                                                                
      if(law.ge.2015) then                                                      
c        busded = pc15(law)*(max(0.0d0,data(17))+max(0.0d0,data(21))+           
c     & max(0.0d0,comnew(8)))                                                   
         busded = pc15(law)*(max(0.0d0,data(17))+max(0.0d0,data(21)))           
        busded = min(busded,ph15(law)/sep)                                      
        agi = agi - busded                                                      
        businc = max(0.0d0,data(17))+max(0.0d0,data(21)) -  busded              
c taxable business income                                                       
        businc = max(0.0d0,businc)                                              
        call look(bus15,businc,6,n,statb,1.0d00,0.0d0,rt,data)                  
      endif                                                                     
c  Exemptions; no deductions                                                    
      if(law.le.1995) then                                                      
       exemp = xmp(law)*(data(7)+data(8))                                       
      else if(law.eq.1996) then                                                 
       exemp = xmp(law)*data(7) + 850.*data(8)                                  
      else if(law.eq.1997) then                                                 
       exemp = xmp(law)*data(7) + 1050.*data(8)                                 
      else if(law.eq.1998) then                                                 
       exemp = xmp(law)*data(7) + 1050.*data(8)                                 
      else                                                                      
       exema = xmp(law)                                                         
       if(law.ge.2014) then                                                     
         if(agi.le.40000) exema = exmp(law,1)                                   
         if(agi.gt.40000.and.agi.le.80000) exema = exmp(law,2)                  
       endif                                                                    
       exemp = exema*(data(7) + data(8))                                        
      endif                                                                     
      if(data(105).gt.0.d0) exemp = 0.d0                                        
c Taxable Income                                                                
      taxinc = max(0.0d0,agi - businc - exemp)                                  
c Low Income Tax Credit 2005-2016 : taxpayers                                   
c whose Ohio taxable income is less than or equal  $10000 owe no tax            
      statax = 0.                                                               
      if((law.ge.2005..and.law.le.2016).and.taxinc.le.10000) return             
      credit = 0.                                                               
c Credits from Schedule B                                                       
      regcr=0.                                                                  
c energy credit                                                                 
      ecred=0.                                                                  
      if(law.le.1985)ecred=min(1000.0d0,data(38))                               
c child care credit : updated through 2018                                      
      chcr=0.                                                                   
      if(law.ge.1989.and.law.le.1992.and.agi.lt.30000.) then                    
        chcr = min(comnew(176)*.25,360.0d0)                                     
      else if(law.ge.1993.and.law.le.1996.and.agi.lt.40000) then                
        if(agi.lt.20000.) then                                                  
          chcr=comnew(176)*.35                                                  
        else                                                                    
          chcr=comnew(176)*.25                                                  
        endif                                                                   
      else if(law.ge.1997.and.agi.lt.40000) then                                
        if(agi.lt.20000) then                                                   
          chcr = comnew(176)                                                    
        else                                                                    
          chcr = comnew(176)*.25                                                
        endif                                                                   
      endif                                                                     
c retirement income credit & senior citizen' credit                             
      snrcr=0.                                                                  
      retcr=0.                                                                  
      if(data(9).gt.0.) then                                                    
        if(law.le.1982)snrcr=25.                                                
        if(law.ge.1983.and.taxinc.le.100000.d0) then                            
          snrcr=50.                                                             
          retcr=tablki(sentab,6,data(20)+data(72),data)                         
          if(law.ge.1990) retcr=min(200.0d0,retcr)                              
        endif                                                                   
      endif                                                                     
      regcr=ecred+chcr+snrcr+retcr                                              
      credit = regcr                                                            
c exemption credit - nonrefundable                                              
      excred = 0.                                                               
      if((law.ge.1983.and.law.le.2012).or.                                      
     &   (law.ge.2013.and.taxinc.lt.30000.0d0))                                 
     &    excred = 20.*(data(7) + data(8))                                      
      credit = credit+excred                                                    
      if(law.ge.1982.and.law.le.1995) then                                      
        do 20 i=1,8                                                             
          if(law.eq.1982)tab(2,i)=tab83(2,i)                                    
          if(law.eq.1983)tab(2,i)=tab83(3,i)                                    
          if(law.eq.1984)tab(2,i)=tab83(4,i)                                    
          if(law.eq.1985)tab(2,i)=tab83(5,i)                                    
          if(law.eq.1986)tab(2,i)=tab83(6,i)                                    
          if(law.eq.1987)tab(2,i)=tab83(7,i)                                    
          if(law.ge.1988.and.law.le.1992)tab(2,i)=tab83(8,i)                    
          if(law.ge.1993.and.law.le.1995)tab93(2,i)=tab83(8,i)                  
20      continue                                                                
      endif                                                                     
      dedy=0.                                                                   
      dedtx=0.                                                                  
      y=taxinc                                                                  
      if(law.le.1981) then                                                      
c years before 1982                                                             
        call look(tab77,taxinc,6,n,statax,1.0d00,0.0d0,rt,data)                 
        statax = max(0.0d0,statax-regcr)                                        
        call ohjoin(data,statax,comnew,law,businc)                              
c 1982                                                                          
      else if(law.eq.1982) then                                                 
        call look(tab,taxinc,8,n,statax,1.0d00,0.0d0,rt,data)                   
        statax = max(0.0d0,statax-regcr)                                        
        call ohjoin(data,statax,comnew,law,businc)                              
c          two extra deduction yield different results; must calculate          
c           both ways                                                           
      else if(law.ge.1983.and.law.le.1988) then                                 
c 1983 - 1988                                                                   
c   method 1                                                                    
        dedy=350*(data(7)+data(8))                                              
        y=max(0.0d0,y-dedy)                                                     
        call look(tab,y,8,n,stax1,1.0d00,0.0d0,rt,data)                         
c       dedy=int(dedy*txrate)                                                   
        if(law.eq.1983)stax1 = stax1-regcr                                      
        if(law.ne.1983)stax1 = max(0.0d0,stax1-regcr)                           
c         this is calculated after credits are subtracted                       
        call ohjoin(data,statax,comnew,law,businc)                              
        statax = stax1                                                          
c         method 2                                                              
        dedtx=20.*(data(7)+data(8))                                             
        call look(tab,taxinc,8,n,stax2,1.0d00,0.0d0,rt2,data)                   
        if(law.eq.1983)stax2 = stax2-regcr-dedtx                                
        if(law.ne.1983)stax2 = max(0.0d0,stax2-regcr-dedtx)                     
        call ohjoin(data,statax,comnew,law,businc)                              
        if(stax2.lt.stax1) then                                                 
           statax = stax2                                                       
           rt = rt2                                                             
        endif                                                                   
        statax = max(0.0d0,statax - excred)                                     
      else                                                                      
        if(law.ge.1989.and.law.le.1992) then                                    
          call look(tab,taxinc,8,n,statax,1.d0,0.d0,rt,data)                    
        else if(law.ge.1993.and.law.le.1995) then                               
          call look(tab93,taxinc,9,n,statax,1.d0,0.0d0,rt,data)                 
        else if(law.eq.1996) then                                               
          call look(tab96,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.1997) then                                               
          call look(tab97,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.1998) then                                               
          call look(tab98,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.1999) then                                               
          call look(tab99,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.2000) then                                               
          call look(tab00,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.ge.2001.and.law.le.2004) then                               
          call look(tab01,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.2005) then                                               
          call look(tab05,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.2006) then                                               
          call look(tab06,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.2007) then                                               
          call look(tab07,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.ge.2008.and.law.le.2010) then                               
          call look(tab08,taxinc,9,n,statax,aif(law),0.d0,rt,data)              
        else if(law.ge.2011.and.law.le.2012) then                               
          call look(tab11,taxinc,9,n,statax,aif(law),0.d0,rt,data)              
        else if(law.ge.2013.and.law.le.2015) then                               
          do 2013 i=1,9                                                         
            if(law.eq.2013) tab13(2,i) = rt13(i)                                
            if(law.eq.2014) tab13(2,i) = rt14(i)                                
            if(law.eq.2015) tab13(2,i) = rt15(i)                                
2013      continue                                                              
          call look(tab13,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.2016) then                                               
          do 2016 i=1,9                                                         
            if(law.eq.2016) tab16(2,i) = rt15(i)                                
2016      continue                                                              
          call look(tab16,taxinc,9,n,statax,1.d0,0.d0,rt,data)                  
        else if(law.eq.2017) then                                               
          call look(tab17,taxinc,8,n,statax,1.d0,0.d0,rt,data)                  
          if(taxinc.le.10650.d0) statax = 0.                                    
        else if(law.eq.2018) then                                               
          call look(tab18,taxinc,8,n,statax,1.d0,0.d0,rt,data)                  
          if(taxinc.le.10850.d0) statax = 0.                                    
        else if(law.eq.2019) then                                               
          call look(tab19,taxinc,6,n,statax,1.d0,0.d0,rt,data)                  
          if(taxinc.le.21750.d0) statax = 0.                                    
        else if(law.eq.2020) then                                               
          call look(tab20,taxinc,6,n,statax,1.d0,0.d0,rt,data)                  
          if(taxinc.le.22150.d0) statax = 0.                                    
        else if(law.eq.2021) then                                               
          call look(tab21,taxinc,5,n,statax,1.d0,0.d0,rt,data)                  
c the smallest rate is not 0%                                                   
          if(taxinc.le.25000.d0) statax = 0.                                    
        endif                                                                   
        statax = statax + statb                                                 
        statax = max(0.0d0,statax - regcr)                                      
        statax = max(0.0d0,statax - excred)                                     
c Starting 2013 nonrefundable EITC                                              
        earncr = 0.                                                             
        if(law.ge.2013) earncr = eicr(law)*comnew(59)                           
        if(law.le.2018) then                                                    
         if(taxinc+businc.gt.20000.0d0) earncr = min(earncr,.5*statax)          
        endif                                                                   
        credit = credit+ earncr                                                 
c OH Joint credit                                                               
c it is important to subtract 'earncr' after 'ohjoin' calculations              
c (based on TaxACT test in 2015)                                                
        if(mst.eq.2) call ohjoin(data,statax,comnew,law,businc)                 
        statax = max(0.0d0,statax - earncr)                                     
      endif                                                                     
      return                                                                    
      end                                                                       
      subroutine ohjoin(data,statax,comnew,law,businc)                          
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      double precision jcred                                                                
      dimension data(255),comnew(255),crtab(2,3),crt83(2,6),crt84(2,4)          
      data crtab/ 10000.,.2,20000.,.12,1.e20,.05/                               
      data crt83/ 10000.,.2,20000.,.16,25000.,.12,50000.,.1,                    
     &            75000.,.07,1.e20,.06/                                         
      data crt84/ 25000.,.2,50000.,.15,75000.,.1,1.e20,.05/                     
c in order to receive two-earner joint deduction, each spouse                   
c must have earned income of at least $500.                                     
      xlind = data(11)+data(23)+data(17)+data(20)+data(72)+                     
     & data(21)+comnew(78)-comnew(17)                                           
      hagi = data(85) + .5*(xlind-data(11))                                     
      wagi = xlind - hagi                                                       
      if(hagi.ge.500.and.wagi.ge.500.and.comnew(37).ge.1000) then               
       if(law.lt.1983)jcred=                                                    
     &  max(0.0d0,tablki(crtab,3,taxinc,data)*statax)                           
       if(law.eq.1983)jcred=                                                    
     &  max(0.0d0,tablki(crt83,6,taxinc,data)*statax)                           
       if(law.ge.1984)jcred=                                                    
     &  max(0.0d0,tablk(crt84,4,taxinc+businc,data)*statax)                     
       if(law.ge.1989)jcred=min(jcred,650.d0)                                     
       statax=max(0.0d0,statax-jcred)                                           
      endif                                                                     
      return                                                                    
      end                                                                       
c  OKLAHOMA                                                                     
c  State 37                                                                     
c                                                                               
c  Updated through 2021 (03-25-2022)                                            
      subroutine oktax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/x/ct                                                               
      common/times/z,p,txrate,h                                                 
      dimension data(255),comnew(255),ded(2,2007:2021)                          
      double precision fedtax, five                                             
      integer sep                                                               
      dimension                                                                 
     & tabs79(2,18),tabm79(2,18),                                               
     & tabs77(2,7) ,tabh77(2,7) ,tabm77(2,7),                                   
     & tss90(2,8)  ,tmm90(2,8)  ,                                               
     & tss99(2,8)  ,tmm99(2,8)  ,                                               
     & tabs88(2,11),tabm88(2,11),                                               
     & tabs90(2,11),tabm90(2,11),                                               
     & ymax(1977:2021),  sale(1999:2021,2)                                      
      dimension tss04(2,8),tmm04(2,8)                                           
      dimension tss56(2,8),tmm56(2,8)                                           
      dimension tss07(2,7),tmm07(2,7)                                           
      dimension tss08(2,7),tmm08(2,7)                                           
      dimension tss09(2,7),tmm09(2,7)                                           
      dimension tss12(2,7),tmm12(2,7)                                           
      dimension tss16(2,6),tmm16(2,6)                                           
c ded from schedule 511-e                                                       
      data ded/                                                                 
     7         4125.d0, 2750.d0,                                                
     8         4875.d0, 3250.d0,                                                
     9         6325.d0, 4250.d0,                                                
     &         8400.d0, 5700.d0,                                                
     1         8500.d0, 5800.d0,                                                
     2         8700.d0, 5950.d0,                                                
     3         8950.d0, 6100.d0,                                                
     4         9100.d0, 6200.d0,                                                
     5         9250.d0, 6300.d0,                                                
     6         9300.d0, 6300.d0,                                                
     7         9350.d0, 6350.d0,                                                
     8         9350.d0, 6350.d0,                                                
     9         9350.d0, 6350.d0,                                                
     &         9350.d0, 6350.d0,                                                
     1         9350.d0, 6350.d0/                                                
      data sale/                                                                
     1     15000.d0,  30000.d0,  20000.d0,  15000.d0, 12000.d0,                 
     1     15000.d0,17*20000.d0,                                                
     2     20000.d0,2*50000.d0, 30000.d0,   12000.d0, 30000.d0,                 
     2  17*50000.d0/                                                            
      data tabs77/                                                              
     &     1000.d0, .5d0, 2500.d0, 1.d0, 3750.d0, 2.d0,                         
     &     5000.d0, 3.d0, 6250.d0, 4.d0, 7500.d0, 5.d0,                         
     &        1.e20,6.d0/                                                       
      data tabh77/                                                              
     &     1500.0d0, .5d0, 3750.0d0, 1.0d0, 5625.0d0, 2.0d0,                    
     &     7500.0d0,3.0d0, 9375.0d0, 4.0d0,11250.0d0, 5.0d0,                    
     &        1.e20,6.0d0/                                                      
      data tabm77/                                                              
     &     2000.0d0, .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                    
     &    10000.0d0,3.0d0,12500.0d0, 4.0d0,15000.0d0, 5.0d0,                    
     &        1.e20,6.0d0/                                                      
      data tss90/                                                               
     &     1000.0d0, .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                    
     &     4900.0d0,3.0d0, 6200.0d0, 4.0d0, 7700.0d0, 5.0d0,                    
     &    10000.0d0,6.0d0,    1.e20, 7.0d0/                                     
      data tmm90/                                                               
     &     2000.0d0, .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                    
     &     9800.0d0,3.0d0,12200.0d0, 4.0d0,15000.0d0, 5.0d0,                    
     &    21000.0d0,6.0d0,    1.e20, 7.0d0/                                     
      data tss99/                                                               
     &     1000.0d0, .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                    
     &     4900.0d0,3.0d0, 6200.0d0, 4.0d0, 7700.0d0, 5.0d0,                    
     &    10000.0d0,6.0d0,    1.e20, 6.75d0/                                    
      data tss04/                                                               
     &     1000.0d0, .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                    
     &     4900.0d0,3.0d0, 6200.0d0, 4.0d0, 7700.0d0, 5.0d0,                    
     &    10000.0d0,6.0d0,    1.e20,7.0d0/                                      
      data tss56/                                                               
     &     1000.0d0, .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                    
     &     4900.0d0,3.0d0, 6200.0d0, 4.0d0, 7700.0d0, 5.0d0,                    
     &    10000.0d0,6.0d0,    1.e20, 6.65d0/                                    
      data tmm99/                                                               
     &     2000.0d0, .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                    
     &     9800.0d0,3.0d0,12200.0d0, 4.0d0,15000.0d0, 5.0d0,                    
     &    21000.0d0,6.0d0,    1.e20, 6.75d0/                                    
      data tmm04/                                                               
     &     2000.0d0,  .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                   
     &     9800.0d0, 3.0d0,12200.0d0, 4.0d0,15000.0d0, 5.0d0,                   
     &    21000.0d0, 6.0d0,    1.e20, 7.0d0/                                    
      data tmm56/                                                               
     &     2000.0d0, .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                    
     &     9800.0d0,3.0d0,12200.0d0, 4.0d0,15000.0d0, 5.0d0,                    
     &    21000.0d0,6.0d0,    1.e20, 6.65d0/                                    
      data tss07/                                                               
     &     1000.0d0,  .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                   
     &     4900.0d0, 3.0d0, 7200.0d0, 4.0d0, 8700.0d0, 5.0d0,                   
     &        1.e20, 6.25d0/                                                    
      data tss08/                                                               
     &     1000.0d0, .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                    
     &     4900.0d0,3.0d0, 7200.0d0, 4.0d0, 8700.0d0, 5.0d0,                    
     &        1.e20,5.65d0/                                                     
      data tss09/                                                               
     &     1000.0d0, .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                    
     &     4900.0d0,3.0d0, 7200.0d0, 4.0d0, 8700.0d0, 5.0d0,                    
     &        1.e20,5.5d0/                                                      
      data tss12/                                                               
     &     1000.0d0, .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                    
     &     4900.0d0,3.0d0, 7200.0d0, 4.0d0, 8700.0d0, 5.0d0,                    
     &        1.e20,5.25d0/                                                     
      data tss16/                                                               
     &     1000.0d0, .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.d0,                     
     &     4900.0d0,3.0d0, 7200.0d0, 4.0d0,    1.e20, 5.d0/                     
      data tmm07/                                                               
     &     2000.0d0,  .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                   
     &     9800.0d0, 3.0d0,12200.0d0, 4.0d0,15000.0d0, 5.0d0,                   
     &        1.e20, 6.25d0/                                                    
      data tmm08/                                                               
     &     2000.0d0,  .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                   
     &     9800.0d0, 3.0d0,12200.0d0, 4.0d0,15000.0d0, 5.0d0,                   
     &        1.e20, 5.65d0/                                                    
      data tmm09/                                                               
     &     2000.0d0, .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                    
     &     9800.0d0,3.0d0,12200.0d0, 4.0d0,15000.0d0, 5.0d0,                    
     &        1.e20,5.5d0/                                                      
      data tmm12/                                                               
     &     2000.0d0, .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                    
     &     9800.0d0,3.0d0,12200.0d0, 4.0d0,15000.0d0, 5.0d0,                    
     &        1.e20,5.25d0/                                                     
      data tmm16/                                                               
     &     2000.0d0, .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.d0,                     
     &     9800.0d0,3.0d0,12200.0d0, 4.0d0,    1.e20, 5.d0/                     
      data tabs79/                                                              
     &     1000.0d0,  .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                   
     &     5000.0d0, 3.0d0, 6250.0d0, 4.0d0, 7500.0d0, 5.0d0,                   
     &     9250.0d0, 6.0d0,11250.0d0, 7.0d0,13250.0d0, 8.0d0,                   
     &    15250.0d0, 9.0d0,17500.0d0,10.0d0,21000.0d0,11.0d0,                   
     &    27000.0d0,12.0d0,33000.0d0,13.0d0,39000.0d0,14.0d0,                   
     &    43000.0d0,15.0d0,49000.0d0,16.0d0,    1.e20,17.0d0/                   
      data tabm79/                                                              
     &     2000.0d0,  .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                   
     &     9000.0d0, 3.0d0,10500.0d0, 4.0d0,12000.0d0, 5.0d0,                   
     &    13500.0d0, 6.0d0,15000.0d0, 7.0d0,17000.0d0, 8.0d0,                   
     &    23000.0d0, 9.0d0,29000.0d0,10.0d0,38000.0d0,11.0d0,                   
     &    48000.0d0,12.0d0,58000.0d0,13.0d0,69000.0d0,14.0d0,                   
     &    81000.0d0,15.0d0,94000.0d0,16.0d0,    1.e20,17.0d0/                   
      data tabs88/                                                              
     &     1000.0d0,  .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                   
     &     5000.0d0, 3.0d0, 6250.0d0, 4.0d0, 7500.0d0, 5.0d0,                   
     &     9250.0d0, 6.0d0,11250.0d0, 7.0d0,13250.0d0, 8.0d0,                   
     &    15250.0d0, 9.0d0,    1.e20,10.0d0/                                    
      data tabm88/                                                              
     &     2000.0d0,  .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                   
     &     9000.0d0, 3.0d0,10500.0d0, 4.0d0,12000.0d0, 5.0d0,                   
     &    13500.0d0, 6.0d0,15000.0d0, 7.0d0,17000.0d0, 8.0d0,                   
     &    23000.0d0, 9.0d0,    1.e20,10.0d0/                                    
      data tabs90/                                                              
     &     1000.0d0,  .5d0, 2500.0d0, 1.0d0, 3750.0d0, 2.0d0,                   
     &     4900.0d0, 3.0d0, 6100.0d0, 4.0d0, 7500.0d0, 5.0d0,                   
     &     9000.0d0, 6.0d0,10500.0d0, 7.0d0,12500.0d0, 8.0d0,                   
     &    16000.0d0, 9.0d0,    1.e20,10.0d0/                                    
      data tabm90/                                                              
     &     2000.0d0,  .5d0, 5000.0d0, 1.0d0, 7500.0d0, 2.0d0,                   
     &     8900.0d0, 3.0d0,10400.0d0, 4.0d0,12000.0d0, 5.0d0,                   
     &    13250.0d0, 6.0d0,15000.0d0, 7.0d0,18000.0d0, 8.0d0,                   
     &    24000.0d0, 9.0d0,    1.e20,10.0d0/                                    
      data ymax/                                                                
     &   3*6600.0d0, 4*7200.0d0, 5*8500.0d0, 8*10000.0d0,25*12000.0d0/          
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rt=0.                                                                     
c     AGI                                                                       
      agi=comnew(2)+divexc(data,comnew,law)                                     
c Taxable state or local income tax refunds may be deductible 2017+             
      if(law.ge.2017) agi = agi - data(22)                                      
c Comments for interest and dividend deduction are given after                  
c testing Taxcut and DC test                                                    
c      if(law.le.1987) then                                                     
c          agi=agi-twn(data(12)+data(14),0.0d0,100*data(7))                     
c      elseif(law.ge.1988) then                                                 
c          agi=agi-twn(data(14),0.0d0,100*data(7))                              
c      endif                                                                    
      if(law.ge.1978)agi=agi-min(100.*data(7),data(65))                         
      if(law.ge.1981.and.law.le.1986)agi=agi-comnew(81)                         
c Social Security Benefits are not taxable Oklahoma                             
      if(law.ge.1985)agi=agi-comnew(79)                                         
c      write(0,*) '1 agi c79',agi,comnew(79)                                    
c Private Pension/Retirement exclusion                                          
      penmax = 0.                                                               
      n7 = int(data(7))                                                              
      if(data(20)+data(72).gt.0.) then                                          
       if(law.le.2006.and.agi.le.25000.*data(9)) then                           
         if(law.le.1998) penmax = 2200.*data(9)                                 
         if(law.gt.1998.and.law.le.1999) penmax = 3300.*data(9)                 
         if(law.eq.2000) penmax = 4400.*data(9)                                 
         if(law.ge.2001.and.law.le.2004) penmax = 5500.*data(9)                 
         if(law.eq.2005) penmax = 7500.*data(9)                                 
         if(law.ge.2006) penmax =10000.*data(9)                                 
       else if(law.eq.2007) then                                                
         if((n7.eq.1.and.agi.le.50000).or.(n7.eq.2.and.agi.le.100000))          
     &    penmax =10000.*data(9)                                                
       else if(law.eq.2008) then                                                
         if((n7.eq.1.and.agi.le.62500).or.(n7.eq.2.and.agi.le.125000))          
     &    penmax =10000.*data(9)                                                
       else if(law.eq.2009) then                                                
          if(agi.le.100000*n7) penmax = 10000.*data(9)                          
       else if(law.ge.2010) then                                                
          penmax = 10000.*n7                                                    
       endif                                                                    
       pended = min(penmax,data(20)+data(72))                                   
       agi = max(agi-pended,0.0d0)                                              
      endif                                                                     
c      write(0,*) '2 agi pended ',agi,pended                                    
c 2005+ capital gain deduction                                                  
c      if(law.ge.2005) agi = agi - max(0.0d0,comnew(6))                         
c 2009 unemployment compensation is taxed in full                               
      if(law.eq.2009) agi = agi - comnew(78) + data(82)                         
c Exemptions                                                                    
      if(law.le.1981) then                                                      
          exemp=(data(7)+data(8)+data(9)+data(10))*750.d0                       
       elseif(law.ge.1982.and.law.le.1986) then                                 
          exemp=(data(7)+data(8)+data(9)+data(10))*1000.d0                      
       elseif(law.ge.1987) then                                                 
          exemp=(data(7)+data(8)+data(10))*1000.d0                              
          old=0.                                                                
          if((mst.eq.2.or.mst.eq.3.or.mst.eq.5.or.mst.eq.6).and.                
     &      comnew(2).le.25000.d0/sep) old=1.                                   
          if(mst.eq.1.and.comnew(2).le.15000) old=1.                            
          if((mst.eq.4.or.mst.eq.7).and.comnew(2).le.19000)old=1.               
          exemp = exemp + (data(9)*old*1000.d0)                                 
      endif                                                                     
      if(data(105).gt.0.d0) exemp = 0.d0                                        
c Federal Tax deduction                                                         
      fedtax=0.                                                                 
      if(law.le.1978) then                                                      
          five=max(0.0d0,comnew(1)-500.)                                        
          if(five.gt.0.) then                                                   
             fedtax=500. + (five*.05)                                           
          else                                                                  
             fedtax=max(0.0d0,comnew(52))                                       
          endif                                                                 
          fedtax=min(fedtax,1700.0d0)                                           
      elseif(law.ge.1979.and.law.le.2005) then                                  
c          fedtax=max(0.0d0,comnew(52)-comnew(175)+data(34))                    
           fedtax = max(0.0d0,comnew(1))                                        
      endif                                                                     
c     Deductions                                                                
      if(law.le.2005) then                                                      
        stded=twn(.15*agi,1000.d0/sep,2000.d0/sep)                              
      elseif(law.eq.2006) then                                                  
        if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                               
          stded = 2000.                                                         
        else                                                                    
          stded = 3000.                                                         
        endif                                                                   
      elseif(law.ge.2007) then                                                  
        if(mst.eq.4.or.mst.eq.7) then                                           
          stded = ded(1,law)                                                    
        else                                                                    
          stded = ded(2,law)*data(7)                                            
        endif                                                                   
      endif                                                                     
      perc1 = 1.                                                                
      perc2 = 1.                                                                
c New in 2006: a second tax table has been eliminated                           
      if(law.le.2005) then                                                      
        xitded = (comnew(30)-comnew(34))*comnew(26)                             
        deduc=max(xitded,stded)                                                 
        taxya=max(0.0d0,agi-perc1*(deduc+exemp))                                
        if(comnew(2).gt.0) perc2 = min(1.0d0,max(0.0d0,agi/comnew(2)))          
        taxyb=max(0.0d0,taxya-perc2*fedtax)                                     
        if(law.le.1978) then                                                    
          taxinc=taxyb                                                          
          if(mst.eq.2.or.mst.eq.5) then                                         
              call look(tabm77,taxyb,7,n,statax,1.0d00,0.0d0,rt,data)           
            elseif(mst.eq.4.or.mst.eq.7) then                                   
              call look(tabh77,taxyb,7,n,statax,1.0d00,0.0d0,rt,data)           
            else                                                                
              call look(tabs77,taxyb,7,n,statax,1.0d00,0.0d0,rt,data)           
          endif                                                                 
        elseif(law.ge.1979.and.law.le.1987) then                                
          if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                             
              call look(tabs77,taxya,7,n,stax1,1.0d00,0.0d0,rt,data)            
              call look(tabs79,taxyb,18,n,stax2,1.0d00,0.0d0,rt2,data)          
          else                                                                  
              call look(tabm77,taxya,7,n,stax1,1.0d00,0.0d0,rt,data)            
              call look(tabm79,taxyb,18,n,stax2,1.0d00,0.0d0,rt2,data)          
          endif                                                                 
          if(stax2.lt.stax1) then                                               
            statax = stax2                                                      
            taxinc=taxyb                                                        
            rt=rt2                                                              
          else                                                                  
            taxinc=taxya                                                        
            statax = stax1                                                      
          endif                                                                 
        elseif(law.ge.1988.and.law.le.1989) then                                
          if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                             
              call look(tabs77,taxya,7,n,stax1,1.0d00,0.0d0,rt,data)            
              call look(tabs88,taxyb,11,n,stax2,1.0d00,0.0d0,rt2,data)          
          else                                                                  
              call look(tabm77,taxya,7,n,stax1,1.0d00,0.0d0,rt,data)            
              call look(tabm88,taxyb,11,n,stax2,1.0d00,0.0d0,rt2,data)          
          endif                                                                 
          if(stax2.lt.stax1) then                                               
            statax = stax2                                                      
            taxinc=taxyb                                                        
            rt=rt2                                                              
          else                                                                  
            taxinc=taxya                                                        
            statax = stax1                                                      
          endif                                                                 
        else                                                                    
          if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                             
              if(law.le.1998) then                                              
                 call look(tss90,taxya,8,n,stax1,1.0d00,0.0d0,rt,data)          
              elseif (law.ge.1999.and.law.le.2002) then                         
                 call look(tss99,taxya,8,n,stax1,1.0d00,0.0d0,rt,data)          
              elseif (law.eq.2004) then                                         
                 call look(tss04,taxya,8,n,stax1,1.0d00,0.0d0,rt,data)          
              else if(law.eq.2003.or.law.eq.2005.or.law.eq.2006) then           
                 call look(tss56,taxya,8,n,stax1,1.0d00,0.0d0,rt,data)          
              endif                                                             
              call look(tabs90,taxyb,11,n,stax2,1.0d00,0.0d0,rt2,data)          
          else                                                                  
              if(law.le.1998) then                                              
                 call look(tmm90,taxya,8,n,stax1,1.0d00,0.0d0,rt,data)          
              else if(law.ge.1999.and.law.le.2002) then                         
                 call look(tmm99,taxya,8,n,stax1,1.0d00,0.0d0,rt,data)          
              else if(law.eq.2004) then                                         
                 call look(tmm04,taxya,8,n,stax1,1.0d00,0.0d0,rt,data)          
              else if(law.eq.2003.or.law.eq.2005.or.law.eq.2006) then           
                 call look(tmm56,taxya,8,n,stax1,1.0d00,0.0d0,rt,data)          
              endif                                                             
              call look(tabm90,taxyb,11,n,stax2,1.0d00,0.0d0,rt2,data)          
          endif                                                                 
          if(stax2.lt.stax1) then                                               
              rt=rt2                                                            
              taxinc=taxyb                                                      
              statax = stax2                                                    
          else                                                                  
              taxinc=taxya                                                      
              statax = stax1                                                    
          endif                                                                 
        endif                                                                   
      else if (law.ge.2006) then                                                
       xitded = comnew(24)                                                      
       if(law.le.2015) then                                                     
          deduc = max(stded,xitded)                                             
       else                                                                     
          deduc = stded                                                         
          if(comnew(26).gt.0.d0.and.comnew(30).gt.0.d0) then                    
c 2016+ Federal itemized deductions must be adjusted by adding back             
c "state and local sales or income taxes" to arrive at Oklahoma itemized deducti
             xitded = comnew(24)                                                
             if(law.le.2017.and.data(50).gt.0)xitded=max(0.d0,xitded-           
     &         (data(50) - data(50)*comnew(34)/comnew(30)))                     
c 2018+ Oklahoma itemized deductions will be capped at $17,000,                 
c excluding char contr and med expenses which are not subject to 17k cap.       
c If you claimed itemized deductions on your Federal return,                    
c you must claim itemized deductions on your Oklahoma return.                   
c This is true even if the OK itemized ded are less than the Oklahoma stded     
             if(law.ge.2018) then                                               
               sttax = min(10000.d0/sep,data(51)+data(50)+data(54))             
               stt = min(data(50),sttax - (data(51)+data(54)))                  
               if(comnew(30)-stt-comnew(20)-comnew(23).gt.17000.d0) then        
                 xitded = 17000.d0 + comnew(20) +comnew(23)                     
               else                                                             
                 xitded = comnew(30) - stt                                      
               endif                                                            
             endif                                                              
             deduc = xitded                                                     
           endif                                                                
       endif                                                                    
       taxinc = 0.                                                              
       if(comnew(2).gt.0) taxinc=max(0.0d0,agi-deduc-exemp)                     
c       write(0,*) 'taxinc agi deduc exemp',taxinc,agi,deduc,exemp              
c  taxinc=max(0.0d0,agi-(deduc+exemp)*agi/comnew(2))                            
       if(mst.eq.1.or.mst.eq.3.or.mst.eq.6) then                                
        if(law.eq.2006)then                                                     
         call look(tss56,taxinc,8,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.eq.2007) then                                               
         call look(tss07,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.eq.2008) then                                               
         call look(tss08,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.ge.2009.and.law.le.2011) then                               
         call look(tss09,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.ge.2012.and.law.le.2015) then                               
         call look(tss12,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.ge.2016) then                                               
         call look(tss16,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                 
        endif                                                                   
       else                                                                     
        if(law.eq.2006)then                                                     
         call look(tmm56,taxinc,8,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.eq.2007) then                                               
         call look(tmm07,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.eq.2008) then                                               
         call look(tmm08,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.ge.2009.and.law.le.2011) then                               
         call look(tmm09,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.ge.2012.and.law.le.2015) then                               
         call look(tmm12,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)                 
        else if(law.ge.2016) then                                               
         call look(tmm16,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                 
        endif                                                                   
       endif                                                                    
      endif                                                                     
c      write(0,*) 'taxinc taxbc',taxinc,statax                                  
c Credits                                                                       
c Child Care Credit   2008+(child care/child tax credit)                        
      chcr=0.                                                                   
      if(law.le.2007) then                                                      
        chcr=.2*perc2*min(comnew(53),max(0.0d0,comnew(52)-data(34)))            
      else if(law.ge.2008.and.comnew(2).le.100000.and.                          
     &       comnew(2).gt.0.and.agi.ge.0)then                                   
        perc = min(1.d0,agi/comnew(2))                                          
c chcare the credit for child care expenses allowed by the IRS                  
        chcare = min(comnew(53),max(0.0d0,comnew(52)-data(34)))                 
c chtax the child tax credit allowed by the IRS                                 
        if(law.ne.2021) then                                                    
          chtax = min(comnew(81)+comnew(93),                                    
     &    max(0.0d0,comnew(52)-data(34)-comnew(53))+comnew(93))                 
        else                                                                    
          chtax = min(comnew(81),                                               
     &    max(0.0d0,comnew(52)-data(34)-comnew(53))+comnew(93))                 
        endif                                                                   
        chcr = max(.2*chcare,.05*chtax)*perc                                    
      endif                                                                     
c Solar Energy Credit                                                           
c what about solar energy credit?                                               
c only one Form 508 for 1995 and instrcns for this credit in the booklet 1990.  
      ecred = 0.                                                                
      if(law.le.1994) then                                                      
        ecred = min(3500.0d0,.35*data(38))                                      
      elseif(law.ge.1995) then                                                  
        ecred = min(7500.0d0,.3*min(25000.0d0,data(38)))                        
      endif                                                                     
c  Credit for property tax relief                                               
      pcred=0.                                                                  
c OK total gross household income includes federal EIC                          
      hhy = hy + comnew(59)                                                     
      if(hhy.lt.ymax(law).and.(data(9).gt.0.or.data(10).gt.0))                  
     &   pcred=min(max(0.0d0,data(51)-.01*hhy),200.0d0)                         
c  EITC - allowed in 2002                                                       
      earncr = 0                                                                
      if(law.ge.2002.and.comnew(2).gt.0)                                        
     & earncr=.05*comnew(59)*agi/comnew(2)                                      
c  Sales tax credit for those who have agi<12000.                               
      scred = 0.                                                                
      if(((law.ge.1990.and.law.le.1998).or.law.eq.2003)                         
     & .and.hy.lt.12000) scred = 40.* (data(7)+data(8))                         
      num = 1                                                                   
      if(data(8).gt.0.or.data(9).gt.0.or.data(10).gt.0) num = 2                 
      if((law.ge.1999.and.law.le.2002).or.law.ge.2004) then                     
        hhy = data(159)+comnew(59)                                              
        if(num.eq.1) then                                                       
           if(hhy.le.sale(law,num)) scred = 40.* data(7)                        
        else                                                                    
           if(hhy.le.sale(law,num)) scred = 40.*(data(7)+data(8))               
        endif                                                                   
c       write(0,*) 'hhy num sale scred',hhy,num,sale(law,num),scred             
      endif                                                                     
      if(data(105).gt.0.d0) scred = 0.d0                                        
      credit = chcr + ecred + pcred + scred +earncr                             
                                                                                
      if(law.le.2015) then                                                      
        statax = max(0.0d0,statax-chcr-ecred)-pcred-scred-earncr                
      else                                                                      
c 2016+ earncr is non-refundable                                                
        statax = max(0.0d0,statax-chcr-ecred-earncr)-pcred-scred                
      endif                                                                     
      return                                                                    
      end                                                                       
c  OREGON                                                                       
c  State 38                                                                     
c                                                                               
c  Updated through 2021 (03-25-2022)                                            
      subroutine ortax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      common/calc2/polit,ecred,altcr,rcred,wfhdc,famcr,akick
      common/temp/count                                                         
      dimension data(255),comnew(255), aif92(1991:2012),child(1989:2016)        
      dimension tabm77(2,7),tabm82(2,7),tabm87(2,3),tabmin(2,5)                 
      dimension tabs77(2,7),tabs82(2,7),tabs87(2,3),tbase(2,4)                  
      dimension tab05(2,3),tab09(2,5),tab12(2,4),tab20(2,4),tab21(2,4)          
      dimension tab95m(2),tab95s(2),tab00m(2),tab00s(2)                         
      dimension tab94m(2),tab94s(2)                                             
      dimension tab96m(2),tab96s(2),tab97m(2),tab97s(2)                         
      dimension tab98m(2),tab98s(2),tab99m(2),tab99s(2)                         
      dimension tab01m(2),tab01s(2)                                             
      dimension tabs(2,3),tabm(2,3)                                             
      dimension wfei(1997:2015),wfdiv(1997:2015)                                
      dimension xmp(1977:1982),fed(1977:2021),xcred(1983:2021),                 
     &xcrmin(2007:2012)                                                         
      dimension surtax(1977:2021),old(1:7)                                      
      dimension stand(1:7), stand02(1:7),aifst(2002:2021)                       
      dimension unex(1:7), care(2,1:7),aif13(2013:2017),t12(2,2011:2019)        
     &,t05(2,2004:2007),t09(2,2008:2010),tm13(3,2013:2019)                      
      dimension fam97(8,6),aifam(1997:2015),fam(2,7),                           
     & povert(2,2016:2021),perc16(23,2),agimax(2,2016:2021),                    
     & eicr(1997:2021)                                                          
      integer sep,qual,sing                                                     
      double precision kicker                                                   
      data eicr/11*.05d0,6*.06d0,6*.08d0,2*.09d0/                               
      data povert/                                                              
     6 11800.d0,4160.d0,                                                        
     7 12060.d0,4180.d0,                                                        
     8 12140.d0,4320.d0,                                                        
     9 12490.d0,4420.d0,                                                        
     & 12760.d0,4480.d0,                                                        
     1 12880.d0,4540.d0/                                                        
c agimax,povert are on schdule OR-WFHDC                                         
       data agimax/                                                             
     6 48060.d0,12420.d0,                                                       
     7 48720.d0,12540.d0,                                                       
     8 49380.d0,12960.d0,                                                       
     9 50730.d0,13260.d0,                                                       
     & 51720.d0,13440.d0,                                                       
     1 52260.d0,13620.d0/                                                       
                                                                                
      data perc16/                                                              
     1  .00d0, .10d0, .20d0, .30d0, .40d0, .50d0, .60d0, .70d0, .80d0,          
     1  .90d0,1.10d0,1.20d0,1.30d0,1.40d0,1.50d0,1.60d0,2.00d0,2.10d0,          
     1 2.20d0,2.30d0,2.40d0,2.60d0,3.00d0,                                      
     2  .05d0, .05d0, .10d0, .20d0, .30d0, .35d0, .40d0, .45d0, .50d0,          
     2  .55d0, .50d0, .45d0, .39d0, .33d0, .28d0, .25d0, .22d0, .20d0,          
     2  .15d0, .10d0, .05d0, .04d0, .00d0/                                      
      data t12/                                                                 
     1         3150.0d0,7950.0d0,                                               
     2         3250.0d0,8150.0d0,                                               
     3         3300.0d0,8250.0d0,                                               
     4         3350.0d0,8400.0d0,                                               
     5         3350.0d0,8400.0d0,                                               
     6         3350.0d0,8450.0d0,                                               
     7         3400.0d0,8500.0d0,                                               
     8         3450.0d0,8700.0d0,                                               
     9         3550.0d0,8900.0d0/                                               
                                                                                
      data tm13/                                                                
     3         6500.0d0,16300.0d0,250000.d0,                                    
     4         6700.0d0,16800.0d0,250000.d0,                                    
     5         6700.0d0,16800.0d0,250000.d0,                                    
     6         6700.0d0,16900.0d0,250000.d0,                                    
     7         6800.0d0,17000.0d0,250000.d0,                                    
     8         6900.0d0,17400.0d0,250000.d0,                                    
     9         7100.0d0,17800.0d0,250000.d0/                                    
                                                                                
      data t09/                                                                 
     8         3050.0d0,7600.0d0,                                               
     9         3050.0d0,7650.0d0,                                               
     1         3100.0d0,7750.0d0/                                               
      data t05/                                                                 
     4         2600.0d0,6500.0d0,                                               
     5         2600.0d0,6500.0d0,                                               
     6         2750.0d0,6850.0d0,                                               
     7         2850.0d0,7150.0d0/                                               
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data child/                                                               
     &        14*2400.0d0,14*3000.0d0/                                          
      data aifst/                                                               
     &     1.0d0, 1.02d0  , 1.05d0 , 1.08d0  , 1.122d0, 1.1128d0,               
     &  1.1370d0, 1.1860d0, 1.189d0, 1.2073d0, 1.235d0, 1.2683d0,               
     &  1.2900d0, 1.3079d0, 1.3140243d0, 1.326d0,1.35d0,1.3841d0,               
     &  1.4116d0, 1.43d0/                                                       
      data wfei/                                                                
     &     2*6000.0d0,  6150.0d0,  6300.0d0,  6550.0d0,  6500.0d0,              
     &       6600.0d0,  6750.0d0,  6900.0d0,  7100.0d0,2*7550.0d0,              
     &       7850.0d0,  7900.0d0,  8000.0d0,  8200.0d0,  8400.0d0,              
     &       8550.0d0,  8700.0d0/                                               
      data wfdiv/                                                               
     &       2200.0d0,  2300.0d0,  2350.0d0,  2400.0d0,  2450.0d0,              
     &       2550.0d0,  2600.0d0,  2650.0d0,  2700.0d0,  2800.0d0,              
     &     2*2950.0d0,2*3100.0d0,  3150.0d0,  3200.0d0,  3300.0d0,              
     &       3350.0d0,  3400.0d0/                                               
      data aif92/                                                               
     &     1.0d0,  1.0525d0, 1.0845d0, 1.118d0 , 1.147d0 , 1.1795d0,            
     &  1.2120d0,  1.2450d0, 1.2660d0, 1.2895d0, 1.3295d0, 1.3730d0,            
     &  1.3950d0,  1.4270d0, 1.4595d0, 1.505d0 , 1.564d0 , 1.5995d0,            
     &  1.6680d0,2*1.6955d0, 1.7365d0/                                          
      data aifam/                                                               
     &      1.0d0,  1.025d0 , 1.044d0 , 1.06d0 ,  1.45d0  ,  1.50d0 ,           
     &     1.52d0,  1.570d0 , 1.620d0 , 1.654d0,  1.7215d0,  1.755d0,           
     &  2*1.827d0,  1.840d0 , 1.886d0 , 1.916d0,  1.97d0  ,  2.003d0/           
      data tabm77/                                                              
     &     1000.0d0,  4.0d0,   2000.0d0,  5.0d0, 4000.0d0,  6.0d0,              
     &     6000.0d0,  7.0d0,   8000.0d0,  8.0d0,10000.0d0,  9.0d0,              
     &        1.e20, 10.0d0/                                                    
      data tabs77/                                                              
     &      500.0d0,  4.0d0,   1000.0d0,  5.0d0,  2000.0d0, 6.0d0,              
     &     3000.0d0,  7.0d0,   4000.0d0,  8.0d0,  5000.0d0, 9.0d0,              
     &        1.e20, 10.0d0/                                                    
      data tabm82/                                                              
     &     1000.0d0,  4.2d0,   2000.0d0,  5.3d0,  4000.0d0, 6.5d0,              
     &     6000.0d0,  7.6d0,   8000.0d0,  8.7d0, 10000.0d0, 9.8d0,              
     &        1.e20, 10.8d0/                                                    
      data tabs82/                                                              
     &      500.0d0,  4.2d0,   1000.0d0,  5.3d0,  2000.0d0, 6.5d0,              
     &     3000.0d0,  7.6d0,   4000.0d0,  8.7d0,  5000.0d0, 9.8d0,              
     &        1.e20, 10.8d0/                                                    
c 2004-2008                                                                     
      data tab05/                                                               
     &     0.0d0,  5.0d0,   0.0d0,  7.0d0,  1.e20,  9.0d0/                      
c 2009                                                                          
      data tab09/                                                               
     &      0.0d0, 5.0d0,   0.0d0,  7.0d0, 125000.0d0, 9.0d0,                   
     &    250000.0d0,10.8d0,      1.e20, 11.0d0/                                
c 2012-2019                                                                     
      data tbase/                                                               
     &         0.0d0, 5.0d0,  0.0d0,  7.0d0, 125000.0d0, 9.0d0,                 
     &         1.e20, 9.9d0/                                                    
c 2020                                                                          
      data tab20/                                                               
     &     3600.0d0, 4.75d0,  9050.0d0,  6.75d0, 125000.0d0, 8.75d0,            
     &     1.e20, 9.9d0/                                                        
c 2021                                                                          
      data tab21/                                                               
     &     3650.0d0, 4.75d0,  9200.0d0,  6.75d0, 125000.0d0, 8.75d0,            
     &     1.e20, 9.9d0/                                                        
      data tabm87/                                                              
     &      4200.0d0, 5.0d0,  10300.0d0,  7.0d0,      1.e20, 9.0d0/             
      data tabs87/                                                              
     &      2000.0d0, 5.0d0,   5000.0d0,  7.0d0,      1.e20, 9.0d0/             
      data tab94m/  3900.0d0, 10600.0d0/                                        
      data tab94s/  1800.0d0,   5500.0d0/                                       
      data tab95m/  4300.0d0,  10800.0d0/                                       
      data tab95s/  2150.0d0,   5450.0d0/                                       
      data tab96m/  4400.0d0,  11100.0d0/                                       
      data tab96s/  2250.0d0,   5550.0d0/                                       
      data tab97m/  4500.0d0,  11400.0d0/                                       
      data tab97s/  2350.0d0,   5850.0d0/                                       
      data tab98m/  4600.0d0,  11600.0d0/                                       
      data tab98s/  2400.0d0,   5900.0d0/                                       
      data tab99m/  4700.0d0,  11700.0d0/                                       
      data tab99s/  2400.0d0,   5950.0d0/                                       
      data tab00m/  4800.0d0,  11900.0d0/                                       
      data tab00s/  2400.0d0,   6050.0d0/                                       
      data tab01m/  5000.0d0,  12600.0d0/                                       
      data tab01s/  2500.0d0,   6400.0d0/                                       
c        1      2      3      4      5      6      7     8                      
      data fam97/                                                               
     & 11850.0d0,15900.0d0,20000.0d0,24100.0d0,28150.0d0,32250.0d0,             
     1 36300.0d0,40400.0d0,                                                     
     & 12600.0d0,17000.0d0,21350.0d0,25700.0d0,30000.0d0,34400.0d0,             
     2 38750.0d0,43100.0d0,                                                     
     & 13400.0d0,18050.0d0,22650.0d0,27300.0d0,31900.0d0,36550.0d0,             
     3 41150.0d0,45800.0d0,                                                     
     & 14200.0d0,19100.0d0,24000.0d0,28900.0d0,33800.0d0,38700.0d0,             
     4 43600.0d0,48450.0d0,                                                     
     & 15000.0d0,20150.0d0,25340.0d0,30500.0d0,35650.0d0,40850.0d0,             
     5 46000.0d0,51150.0d0,                                                     
     & 15800.0d0,21200.0d0,26650.0d0,32100.0d0,37550.0d0,43000.0d0,             
     6 48400.0d0,53850.0d0/                                                     
      data fam/                                                                 
     &     .0d0,  .4d0 , .0d0, .36d0,  .0d0, .32d0, .0d0, .24d0,                
     &     .0d0,  .16d0, .0d0, .08d0, 1.e20, .0d0/                              
      data tabmin/                                                              
     &   5000.0d0,  1.0d0,   7000.0d0, 1.5d0,  9000.0d0, 2.0d0,                 
     &  12000.0d0,  2.5d0,      1.e20, 3.0d0/                                   
      data xmp /2*750.0d0,4*1000.0d0/                                           
      data fed /                                                                
     &    2*5000.0d0, 8*7000.0d0, 15*3000.0d0, 3250.0d0, 3500.0d0,              
     &      4000.0d0,   4500.0d0,    5000.0d0, 5500.0d0, 5600.0d0,              
     &    2*5850.0d0,   5950.0d0,    6100.0d0, 6250.0d0, 6350.0d0,              
     &      6450.0d0,   6500.0d0,    6550.0d0, 6650.0d0, 6800.0d0,              
     &      6950.0d0,   7050.0d0/                                               
      data xcred/                                                               
     &     4*85.0d0,  86.0d0,  89.0d0,  94.0d0,  98.0d0, 104.0d0,               
     &      109.0d0, 113.0d0, 116.0d0, 120.0d0, 124.0d0, 128.0d0,               
     &      132.0d0, 134.0d0, 139.0d0, 142.0d0, 145.0d0, 147.0d0,               
     &      151.0d0, 154.0d0, 159.0d0, 165.0d0, 169.0d0, 176.0d0,               
     &      177.0d0, 179.0d0, 183.0d0, 188.0d0, 191.0d0, 194.0d0,               
     &      195.0d0, 197.0d0, 201.0d0, 206.0d0, 2*210.0d0/                      
      data xcrmin/ 55.0d0, 56.0d0,2*58.0d0,59.0d0,60.0d0/                       
      data surtax/8*1.0d0,.9230d0,1.0d00,.8340d0,1.0d0,                         
     & 3*.9020d0,30*1.0d0/                                                      
      data unex/20000.0d0, 25000.0d0, 3*20000.0d0, 0.0d0, 20000.0d0/            
      data stand/1800.0d0, 3000.0d0, 1500.0d0, 2640.0d0, 3000.0d0,              
     & 1500.0d0, 2640.0d0/                                                      
      data stand02/                                                             
     &     1640.0d0, 3280.0d0, 1640.0d0, 2640.0d0, 3280.0d0, 1640.0d0,          
     &     2640.0d0/                                                            
      data old/ 1200.0d0, 2*1000.0d0, 1200.0d0, 2*1000.0d0,1200.0d0/            
      data care/ 5000.0d0, .30d0, 10000.0d0, .150d0, 15000.0d0,                 
     & .080d0, 25000.0d0, .060d0,                                               
     &  35000.0d0, .050d0, 45000.0d0, .040d0, 1.e20, 0.0d0/                     
c                                                                               
c indexing never went into effect.                                              
      rt = 0.                                                                   
      sing = 0                                                                  
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      ided = int(data(4))                                                            
      if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)sing = 1                              
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)                                           
     &    phas92=100000.*aif92(law)/sep                                         
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
      do 1000 i=1,4                                                             
      do  999 j=1,2                                                             
        tab12(j,i) = tbase(j,i)                                                 
999   continue                                                                  
1000  continue                                                                  
c AGI                                                                           
c      agi=comnew(2) - data(22)(i am not sure state tax refund is not taxable 05
      agi=comnew(2)                                                             
      if(law.ge.1982.and.law.le.1986) then                                      
        agi=agi+comnew(32)                                                      
        agi=agi-max(0.0d0,min((comnew(4)+data(14)),100.*data(7)))               
      endif                                                                     
c code follows different federal laws                                           
      if(law.ge.1981.and.law.le.1984) then                                      
        unx=unex(mst)                                                           
        untax=min(.5*max(agi-unx,0.0d0),data(82))                               
        agi=agi+comnew(78)-untax                                                
      endif                                                                     
c Social Security Benefits are not taxable in Oregon                            
      if(law.ge.1984) agi=agi-comnew(79)                                        
      agi=max(agi,0.0d0)                                                        
c federal tax deduction                                                         
      fedtax= max(0.0d0,comnew(52)-data(44)-comnew(58))                         
      if(ided.eq.-2.and.law.eq.1997) fedtax=max(0.0d0,comnew(52))               
      if(law.ge.1980)fedtax=fedtax+data(34)                                     
      if(law.ge.1981)fedtax=fedtax+data(42)                                     
c The tax rebates (economic stimulus payments) from the IRS may reduce          
c 2008 federal tax subtraction.                                                 
      if(law.eq.2008) fedtax =                                                  
     &   max(0.0d0,fedtax - 600*data(7) - 300*data(8))                          
c 2009-2010 please use Making work pay credit                                   
      fedtax = max(0.0d0,fedtax - comnew(94))                                   
c 2020 recovery stimulus credit                                                 
      fedtax = max(0.0d0,fedtax - comnew(186))                                  
c 2021 CTC refundable                                                           
      if(law.eq.2021) fedtax = max(0.0d0,fedtax - comnew(93))                   
c The subtraction is limited by the AGI phaseouts                               
      nlim = 1                                                                  
      if(mst.eq.2.or.mst.eq.5.or.mst.eq.4.or.mst.eq.7) nlim=2                   
      fedlim = fed(law)/sep                                                     
      if(agi.lt.125000.*nlim) then                                              
         fedlim = fedlim                                                        
      else if(agi.lt.130000.*nlim) then                                         
         fedlim = fedlim/1.25                                                   
      else if(agi.lt.135000.*nlim) then                                         
         fedlim = fedlim/1.675                                                  
      else if(agi.lt.140000.*nlim) then                                         
         fedlim = fedlim/2.53                                                   
      else if(agi.lt.145000.*nlim) then                                         
         fedlim = fedlim/5.15                                                   
      else                                                                      
         fedlim = 0.                                                            
      endif                                                                     
      fedtax=twn(fedtax,0.0d0,fedlim)                                           
c      write(0,*) 'fedlim fedtax agi',fedlim,fedtax,agi                         
c Standard Deduction                                                            
      if(law.le.1986) then                                                      
        stded=twn(.13*agi,1050.0d0/sep,1500.0d0/sep)                            
      else if(law.ge.1987.and.law.le.2001) then                                 
        stded=stand(mst)+((data(9)+data(10))*old(mst))                          
        if(data(7).lt.1.)stded=500.0d0                                          
      else if(law.ge.2002) then                                                 
        stded=stand02(mst)*aifst(law)+((data(9)+data(10))*old(mst))             
        if(law.le.2003.and.data(7).lt.1.) then                                  
           stded=max(750.0d0,comnew(37)+250.0d0)                                
        else if(law.ge.2004.and.data(7).lt.1.) then                             
           stded=max(800.0d0,comnew(37)+250.0d0)                                
        endif                                                                   
      endif                                                                     
c State Tax Declaration Phaseout                                                
      tx = 0.d0                                                                 
      if(law.le.2013) then                                                      
        tx=data(50)                                                             
      else if(law.ge.2014.and.law.le.2017) then                                 
        tx = max(data(52),data(50))                                             
      endif                                                                     
      if(law.ge.1991) then                                                      
        ag = max(0.0d0,comnew(2))                                               
        xlin4=max(0.0d0,data(49)-.075*ag)                                       
        if(law.le.2017) then                                                    
          xlin8=tx+data(51)+data(54)                                            
        else                                                                    
          xlin8=min(10000.d0/sep,data(51)+data(54))                             
        endif                                                                   
        xlin11=data(53)                                                         
        xlin12=data(56)+data(53)+data(57)                                       
        xlin16=data(58)+data(59)+data(60)                                       
        xlin17=max(0.0d0,data(61)-.1*ag)                                        
        xlin18=data(26)                                                         
        if(law.le.2017) then                                                    
          xlin24=max(data(27)+data(63)-.02*ag,0.0d0)                            
        else                                                                    
c no misc ded subject to 2% floor in 2018                                       
          xlin24=0.d0                                                           
        endif                                                                   
        xlin25=data(66)                                                         
        xtot=xlin4+xlin8+xlin12+xlin16+xlin17+xlin18+xlin24+                    
     &   xlin25                                                                 
        xdiff=xtot-xlin4-xlin11-xlin17                                          
        if(xdiff.gt.0.d0.and.law.le.2017) then                                  
          xdiff2=comnew(2) - phas92                                             
          if(xdiff2.gt.0.) then                                                 
            xconst=min(.8*xdiff,.03*xdiff2)                                     
            xlin26=xtot-xconst                                                  
            xprop=(xdiff-(xtot-xlin26))/xdiff                                   
            tx=xprop*tx                                                         
          endif                                                                 
        endif                                                                   
      endif                                                                     
      if(law.le.2017) then                                                      
        xitded=max(0.0d0,comnew(30) -comnew(34)- tx)                            
      else                                                                      
        xitded = xtot                                                           
c 2020 cares act                                                                
        if(law.eq.2020.and.comnew(26).lt.1) xitded =                            
     &  xitded - min(300.d0,data(58))                                           
      endif                                                                     
c     Itemized Deductions for old  people                                       
      if((law.ge.1992..and.law.le.2017).and.data(9).gt.0) then                  
        xitded=max(0.0d0,comnew(30)-comnew(34)-comnew(20)+                      
     &   min(data(47)+data(48)+data(49),.075d0*comnew(2)))                      
      endif                                                                     
c      if(ided.eq.-2.and.law.eq.1999) xitded=0.                                 
       if(ided.eq.-2) xitded=0.                                                 
c next line is for dctest                                                       
c      if(agi.le.25000) xitded=0                                                
c                                                                               
      deduc=max(stded,xitded)                                                   
      exemp = 0.                                                                
      if(law.le.1982) exemp=comnew(68)*xmp(law)                                 
      taxinc=max(0.0d0,agi-deduc-exemp-fedtax)                                  
c      write(0,*) 'agi deduc exemp fedtax taxinc',agi,deduc,exemp,              
c     & fedtax,taxinc                                                           
      if(law.ge.1994) then                                                      
         do 22 i=1,2                                                            
         do 20 j=1,3                                                            
         tabm(i,j)=tabm87(i,j)                                                  
         tabs(i,j)=tabs87(i,j)                                                  
20       continue                                                               
22       continue                                                               
         if(law.eq.1994) then                                                   
           do 40 i=1,2                                                          
            tabm(1,i)=tab94m(i)                                                 
            tabs(1,i)=tab94s(i)                                                 
40         continue                                                             
         endif                                                                  
         if(law.eq.1995) then                                                   
           do 50 i=1,2                                                          
            tabm(1,i)=tab95m(i)                                                 
            tabs(1,i)=tab95s(i)                                                 
50         continue                                                             
         endif                                                                  
         if(law.eq.1996) then                                                   
           do 60 i=1,2                                                          
            tabm(1,i)=tab96m(i)                                                 
            tabs(1,i)=tab96s(i)                                                 
60         continue                                                             
         endif                                                                  
         if(law.eq.1997) then                                                   
           do 70 i=1,2                                                          
            tabm(1,i)=tab97m(i)                                                 
            tabs(1,i)=tab97s(i)                                                 
70         continue                                                             
         endif                                                                  
         if(law.eq.1998) then                                                   
           do 80 i=1,2                                                          
            tabm(1,i)=tab98m(i)                                                 
            tabs(1,i)=tab98s(i)                                                 
80         continue                                                             
         endif                                                                  
         if(law.eq.1999) then                                                   
           do 90 i=1,2                                                          
            tabm(1,i)=tab99m(i)                                                 
            tabs(1,i)=tab99s(i)                                                 
90         continue                                                             
         endif                                                                  
         if(law.eq.2000) then                                                   
           do 100 i=1,2                                                         
            tabm(1,i)=tab00m(i)                                                 
            tabs(1,i)=tab00s(i)                                                 
100        continue                                                             
         endif                                                                  
         if(law.ge.2001.and.law.le.2003) then                                   
           do 101 i=1,2                                                         
            tabm(1,i)=tab01m(i)                                                 
            tabs(1,i)=tab01s(i)                                                 
101        continue                                                             
         endif                                                                  
      endif                                                                     
      num = 2                                                                   
      if(sing.eq.1) num = 1                                                     
      if (law.le.1981) then                                                     
         if(sing.eq.0)                                                          
     &    call look(tabm77,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)              
         if(sing.eq.1)                                                          
     &    call look(tabs77,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)              
      else if(law.ge.1982.and.law.le.1986) then                                 
         if(sing.eq.0)                                                          
     &    call look(tabm82,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)              
         if(sing.eq.1)                                                          
     &    call look(tabs82,taxinc,7,n,statax,1.0d00,0.0d0,rt,data)              
      else if(law.ge.1987.and.law.le.1993) then                                 
         if(sing.eq.0)                                                          
     &    call look(tabm87,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)              
         if(sing.eq.1)                                                          
     &    call look(tabs87,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)              
      else if(law.ge.1994.and.law.le.2003) then                                 
         if(sing.eq.0)                                                          
     &    call look(tabm,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                
         if(sing.eq.1)                                                          
     &    call look(tabs,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                
      else if(law.ge.2004.and.law.lt.2008) then                                 
         do 2005 i=1,2                                                          
         tab05(1,i) = t05(i,law)                                                
2005     continue                                                               
         taxy = taxinc/num                                                      
         call look(tab05,taxy,3,n,statx,1.0d00,0.0d0,rt,data)                   
         statax = num * statx                                                   
      else if(law.ge.2008.and.law.lt.2011) then                                 
         do 2009 i=1,2                                                          
         tab09(1,i) = t09(i,law)                                                
2009     continue                                                               
         taxy = taxinc/num                                                      
         call look(tab09,taxy,5,n,statx,1.0d00,0.0d0,rt,data)                   
         statax = num * statx                                                   
      else if(law.ge.2011.and.law.le.2012) then                                 
         do 2012 i=1,2                                                          
         tab12(1,i) = t12(i,law)                                                
2012     continue                                                               
         taxy = taxinc/num                                                      
         call look(tab12,taxy,4,n,statx,1.0d00,0.0d0,rt,data)                   
         statax = num * statx                                                   
      else if(law.ge.2013.and.law.le.2019) then                                 
         do 2013 i=1,2                                                          
         tab12(1,i) = t12(i,law)                                                
2013     continue                                                               
c For filing single or married/RDP filing separately                            
         if(mst.eq.1.or.mst.eq.3.or.mst.eq.6)                                   
     &    call look(tab12,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
         if(mst.eq.2.or.mst.eq.4.or.mst.eq.5.or.mst.eq.7) then                  
c For filing jointly, hoh, or qualifying widow with dependent child             
           do 2014 i=1,3                                                        
           tab12(1,i) = tm13(i,law)                                             
2014       continue                                                             
           call look(tab12,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)              
         endif                                                                  
      else if(law.ge.2020) then                                                 
         taxy = taxinc/num                                                      
         if(law.eq.2020)                                                        
     &   call look(tab20,taxy,4,n,statx,1.0d00,0.0d0,rt,data)                   
         if(law.ge.2021)                                                        
     &   call look(tab21,taxy,4,n,statx,1.0d00,0.0d0,rt,data)                   
         statax = num * statx                                                   
      endif                                                                     
c      write(0,*) 'taxinc statax',taxinc,statax                                 
      altax=0.                                                                  
      if(law.le.1986) then                                                      
        prefs=comnew(36)                                                        
        qual=0                                                                  
        if(prefs.gt.10000.d0/sep) qual=1                                        
        if(agi.gt.20000.d0/sep.and.prefs.gt.3000.d0/sep)qual=1                  
        if(qual.eq.1)                                                           
     &   call look(tabmin,prefs,5,n,altax,1.0d00,0.0d0,art,data)                
      endif                                                                     
      statax=statax+altax                                                       
      statax=max(0.0d0,statax)                                                  
      taxbc = statax 
c      write(0,*) 'taxbc',taxbc
c Credits                                                                       
      txp=data(7)                                                               
      ecred = 0.                                                                
      chcr = 0.                                                                 
      if(law.le.1978) then                                                      
        ecred=.15*comnew(32)                                                    
        chcr=.4*comnew(53)                                                      
      else if(law.ge.1979.and.law.lt.1987) then                                 
        taxmax=max(0.0d0,comnew(1)-comnew(58))                                  
        ecred=min(.15*taxmax,.15*comnew(32))                                    
        chcr=min(.4*taxmax,.4*comnew(53))                                       
      else if(law.ge.1987.and.law.le.2015) then                                 
c child and dependent care credit expired as of January 1, 2016                 
         ecred=.4*comnew(54)                                                    
         if(law.eq.1987.or.law.eq.1988) then                                    
           chcr=.4*comnew(53)                                                   
         else                                                                   
           if(comnew(53).gt.0) then                                             
              y=max(0.0d0,comnew(29))                                           
              chcr=tablki(care,7,y,data)*                                       
     &     min(comnew(37),min(data(64),min(2.0d0,data(8))*child(law)))          
           endif                                                                
         endif                                                                  
      endif                                                                     
      rcred = 0.                                                                
      if(law.ge.1991.and.data(9).gt.0) then                                     
         if(agi.le.(22500.*txp)) then                                           
          rcred=.09*(min(data(20)+data(72),max(0.0d0,max((7500.*txp)-           
     &    comnew(84),0.0d0)-max(data(159)-(15000.*txp),0.0d0))))                
         endif                                                                  
         if(law.eq.1994.and.comnew(84).gt.(7500.*txp))rcred=0.                  
      endif                                                                     
      polit=0.                                                                  
      if(law.ge.1978.and.law.le.1986) then                                      
        polit=min(.5*comnew(25),25.*data(7))                                    
      else if(law.ge.1987) then                                                 
        polit=min(data(35),50.*data(7))                                         
      endif                                                                     
      altcr=min(data(38),1000.0d0)                                              
c Exemption Credit                                                              
      gcred = 0.                                                                
      ngcred = int(txp)                                                              
      if(mst.eq.4.or.mst.eq.7.or.mst.eq.5) ngcred = 2                           
      if((law.ge.1983.and.law.le.2012).or.(law.ge.2013.and.                     
     & comnew(2).le.100000*ngcred)) gcred = xcred(law)*comnew(68)               
c Exemption Credit Phaseout since 2007 and through 2012                         
      if(law.ge.2007.and.law.le.2012) then                                      
        phasa = aif92(law) * 100000                                             
        if(mst.eq.4.or.mst.eq.7) then                                           
          phasa = 1.25 * phasa                                                  
        else if(mst.eq.2.or.mst.eq.5.or.sep.eq.2) then                          
          phasa = 1.5 * phasa/sep                                               
        endif                                                                   
        if(comnew(2).gt.phasa) then                                             
c Minimum credit                                                                
          gcrmin = xcrmin(law) * comnew(68)                                     
          nl4 = int((comnew(2) - phasa)/(2500.d0/sep) + 1)                      
          xl5 = nl4 * 0.02                                                      
          gcred = max(gcrmin,gcred * (1-xl5))                                   
        endif                                                                   
      endif                                                                     
c Earned Income Credit   (non-refundable, since 2006 is refundable)             
      earncr = 0.                                                               
      if(law.ge.1997) earncr = eicr(law)*comnew(59)                             
c Working Family Child Care Credit(refundable)                                  
      numhh = int(max(1.0d0,min(8.0d0,comnew(68))))                                  
c WFC expired as of January 1, 2016                                             
      famcr = 0.                                                                
      if(law.ge.1997.and.law.le.2015.and.sep.eq.1) then                         
        if(comnew(37).ge.wfei(law).and.                                         
     &       data(12)+data(14)+max(0.0d0,comnew(6)).lt.wfdiv(law)) then         
        do 1 i=1,6                                                              
          fam(1,i) = 0.                                                         
          if(law.ge.1997) fam(1,i) = fam97(numhh,i)*aifam(law)                  
1       continue                                                                
        famcr = data(64) * tablki(fam,7,comnew(2),data)                         
       endif                                                                    
      endif                                                                     
c WFHDC is a new refundable credit in 2016+                                     
      wfhdc = 0.                                                                
      num = int(comnew(68))                                                          
      if(law.ge.2016.and.numhh.gt.1.and.num.gt.1) then                          
        ncccr = int(min(data(8),2.0d0))                                              
        expens = min(data(64),12000.0d0*ncccr)                                  
        expens = min(expens,comnew(37))                                         
        if(mst.eq.2)                                                            
     &  expens = max(0.0d0,min(expens,data(85),data(86)))                       
        pov = povert(1,law) + povert(2,law)*(num-1)                             
        base = max(0.d0,agi)                                                    
        if(base.lt.agimax(1,law)+agimax(2,law)*(numhh-2)) then                  
         do 111 k=1,21                                                          
           if(base.gt.perc16(k,1)*pov.and.base.le.perc16(k+1,1)*pov)then        
             wfhdc = perc16(k,2)*expens                                         
             perc = perc16(k,2)                                                 
           endif                                                                
111      continue                                                               
        endif                                                                   
      endif                                                                     
      if(law.le.2005) then                                                      
      credit=polit+ecred+chcr+altcr+gcred+rcred+earncr                          
      else                                                                      
      credit=polit+ecred+chcr+altcr+gcred+rcred                                 
      endif                                                                     
      statax=max(0.0d0,statax-credit)                                           
      statax=statax-famcr-wfhdc                                                 
      credit = credit + famcr + wfhdc                                           
      if(law.ge.2006) then                                                      
          statax = statax - earncr                                              
          credit = credit + earncr                                              
      endif                                                                     
c      write(0,*)'statax gcred earncr credit',statax,gcred,earncr,credit        
                                                                                
      if(statax.gt.0) statax=statax*surtax(law)                                 
c The Oregon surplus credit (kicker) -- refundable                              
c Every two years, the Oregon DAS determines whether there is                   
c a surplus and the amount to be returned to taxpayers as a kicker              
      kicker = 0.d0                                                             
      if(law.eq.2017.or.law.eq.2015) kicker = .056*taxbc                        
      if(law.eq.2019) akick = .17171*taxbc                                     
c No kicker credit is available for tax year 2020                               
      statax = statax - akick                                                  
      credit = credit + akick                                                  
      return                                                                    
      end                                                                       
c  PENNSYLVANIA                                                                
c  State 39                                                                    
c  Updated through 2021 (04-05-2022)                                           
c                                                                               
      subroutine patax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255)                                           
      dimension rate(1977:2021)                                                 
      data rate/                                                                
     &    .02d0,5*.022d0 ,   .0245d0,  .024d0,.0235d0, .0216d0,4*.021d0,        
     &   .026d0,  .0295d0,11*.0280d0,18*.0307d0/                                
      rt=rate(law)                                                              
      mst = int(data(2))                                                             
      nkid = int(data(8))                                                            
c AGI                                                                           
c no capital losses allowed                                                     
c PA allows a full pension income exclusion                                     
c data(20) and data(72) are excluded from AGI for seniors                       
       d17 = data(17)+data(211)+data(214)+data(212)+data(215)                   
       agi=data(11)+data(12)+data(14)+max(0.d0,d17)+max(0.d0,data(18))+         
     & max(0.d0,data(19))+max(0.d0,comnew(5))+comnew(8)+                        
     & max(0.d0,data(21))+max(0.d0,data(24))                                    
       if(data(9).eq.0) agi = agi + data(20) + data(72)                         
c law allows deduction of emp bus exp for all years; TAXSIM                     
c variable does not begin until 1979                                            
      if(law.ge.1979)agi=agi-data(27)                                           
      if(law.ge.1982)agi=agi-data(26)                                           
      taxinc=max(0.0d0,agi)                                                     
      statax = taxinc * rt                                                      
c       write(0,*) 'taxinc',taxinc                                              
c Forgiveness Credit                                                            
      eligy=taxinc+data(23)                                                     
c     Can't determine if there are two earners in the family; count             
c     the spouse as a dependent, figuring if he/she weren't, the couple         
c     would still derive financial benefit by filing separately.                
      if(law.le.1994) then                                                      
        ntxp = int(data(7))-1                                                        
        dep1 = 0.                                                               
        dep2 = 0.                                                               
        if(ntxp.eq.0)then                                                       
         if(nkid.eq.1) then                                                     
          dep1 = 1.                                                             
          dep2 = 0.                                                             
         else if(nkid.ge.2) then                                                
          dep1 = 1.                                                             
          dep2 = nkid-1.                                                        
         endif                                                                  
        else if(ntxp.gt.0) then                                                 
         dep1 = 1.                                                              
         dep2 = nkid                                                            
        endif                                                                   
      else if(law.ge.1995) then                                                 
         dep1 = data(7)                                                         
         dep2 = nkid                                                            
      endif                                                                     
c     Determine if filer is independent                                         
      if(law.le.1986) then                                                      
         allow=3000.+(dep1*1200.)+(dep2*750.)                                   
      else if(law.eq.1987) then                                                 
         allow=4500.+(dep1*1500.)+(dep2*1000.)                                  
      else if(law.ge.1988.and.law.le.1993) then                                 
         allow=6300.+(dep1*1500.)+(dep2*1000.)                                  
      else if(law.eq.1994) then                                                 
        if(mst.ne.2) then                                                       
         allow=6300.+3000.*data(8)                                              
        else                                                                    
c Joint claim for tax forgiveness                                               
         allow=9300.+3000.*data(8)                                              
        endif                                                                   
      else if(law.ge.1995.and.law.le.1996) then                                 
         allow = 6300.+(dep1-1+dep2)*3000.                                      
      else if(law.eq.1997) then                                                 
         allow = 6300.*dep1+dep2*4000.                                          
      else if(law.eq.1998) then                                                 
       if(mst.ne.2) then                                                        
         allow = 6500.*(dep1+min(1.0d0,dep2))+max(0.0d0,dep2-1)*6000.           
       else                                                                     
         allow = 6500.*dep1+dep2*6000.                                          
       endif                                                                    
      else if(law.eq.1999) then                                                 
         allow = 6500.*(dep1+dep2)                                              
      elseif(law.eq.2000) then                                                  
         allow = 6500.*dep1+7500.*dep2                                          
      elseif(law.eq.2001) then                                                  
         allow = 6500.*dep1+8500.*dep2                                          
      elseif(law.ge.2002.and.law.le.2003) then                                  
         allow = 6500.*dep1+9000.*dep2                                          
      elseif(law.ge.2004) then                                                  
         allow = 6500.*dep1+9500.*dep2                                          
      endif                                                                     
      remain= max(0.0d0,eligy-allow)                                            
      if(law.le.1997) then                                                      
         perc = max(0.0d0,1. -remain/1000.)                                     
      else                                                                      
         perc = max(0.0d0,1. -remain/2500.)                                     
      endif                                                                     
      credit = statax * perc                                                    
      statax = statax - credit                                                  
      return                                                                    
      end                                                                       
c  RHODE ISLAND                                                                
c  State 40                                                                    
c                                                                               
c  Updated through 2021 (04-05-2022)                                           
      subroutine ritax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,             
     &earncr,credit,rt                                                          
      dimension data(255),comnew(255),rate(1977:2000),aif(2002:2021)            
      dimension tabs77(2,6),tabm77(2,5),tabs84(2,6),tabm84(2,5)                 
      dimension tabs88(2,5),tabm88(2,5),tabs99(2,5),tabm99(2,5)                 
      dimension tabs98(2,5),tabm98(2,5),tabs97(2,5),tabm97(2,5)                 
      dimension tab01s(2,5),tab01h(2,5),tab01m(2,5)                             
      dimension tab02s(2,5),tab02h(2,5),tab02m(2,5)                             
      dimension tab11(2,3)                                                      
      dimension stnds(2003:2021),stndm(2003:2021),stndh(2003:2021)              
      dimension stndd(2003:2010),olds(2003:2010),oldm(2003:2010),               
     & ptr(1977:2021)                                                           
      dimension eicpr(2003:2021),phase(3,2003:2010),excl(3,2003:2010)           
      dimension brack(3,2003:2009),flrate(2006:2010),xmp(2011:2021),            
     & aif16(2016:2021),aif17(2017:2021)                                        
      double precision ltg                                                      
      integer sep                                                               
      data aif16/1.d0,1.0195d0,1.0445d0,1.054d0,1.0795d0,1.112d0/               
      data aif17/1.d0,1.024d0 ,1.0435d0,1.0585d0,1.0905d0/                      
      data xmp/3500.0d0,3650.0d0,3750.0d0, 3800.0d0, 3850.0d0,                  
     & 2*3900.0d0,4000.0d0,4100.0d0,4150.0d0,4250.0d0/                          
      data flrate/.08d0,.075d0,.07d0,.065d0,.06d0/                              
      data phase/                                                               
     3     112500.0d0,150000.0d0,112500.0d0,                                    
     4     112500.0d0,150000.0d0,112500.0d0,                                    
     5     115050.0d0,153450.0d0,115050.0d0,                                    
     6     118850.0d0,158200.0d0,118850.0d0,                                    
     7     123250.0d0,164350.0d0,123250.0d0,                                    
     8     126100.0d0,168150.0d0,126100.0d0,                                    
     9     131450.0d0,175300.0d0,131450.0d0,                                    
     &     131700.0d0,175650.0d0,131700.0d0 /                                   
      data brack/                                                               
     3      28400.0d0, 47450.0d0, 38050.0d0,                                    
     4      29050.0d0, 48500.0d0, 38900.0d0,                                    
     5      29700.0d0, 49650.0d0, 39800.0d0,                                    
     6      30650.0d0, 51200.0d0, 41050.0d0,                                    
     7      31850.0d0, 53150.0d0, 42650.0d0,                                    
     8      32550.0d0, 54400.0d0, 43650.0d0,                                    
     9      33950.0d0, 56700.0d0, 45500.0d0/                                    
      data excl /                                                               
     3     35750.0d0,49000.0d0,35750.0d0,                                       
     4     35750.0d0,49000.0d0,35750.0d0,                                       
     5     36550.0d0,50100.0d0,36550.0d0,                                       
     6     37700.0d0,51650.0d0,37700.0d0,                                       
     7     39150.0d0,53700.0d0,39150.0d0,                                       
     8     40050.0d0,54900.0d0,40050.0d0,                                       
     9     41750.0d0,57250.0d0,41750.0d0,                                       
     &     41850.0d0,57350.0d0,41850.0d0/                                       
      data eicpr/                                                               
     &       2*.05d0,    .1d0,   9*.15d0,.1d0,.125d0,5*.15d0/                   
      data stnds/                                                               
     &     4750.0d0,  4850.0d0,  5000.0d0,  5150.0d0,  5350.0d0,                
     &     5450.0d0,2*5700.0d0,  7500.0d0,  7800.0d0,  8000.0d0,                
     &     8100.0d0,  8275.0d0,  8300.0d0,  8375.0d0,  8525.0d0,                
     &     8750.0d0,  8900.0d0,  9050.0d0/                                      
      data stndh/                                                               
     &     7000.0d0,  7150.0d0,  7300.0d0,  7550.0d0,  7850.0d0,                
     &     8000.0d0,  8350.0d0,  8400.0d0, 11250.0d0, 11700.0d0,                
     &    12000.0d0, 12200.0d0, 12400.0d0, 12450.0d0, 12550.0d0,                
     &    12800.0d0, 13100.0d0, 13350.0d0, 13550.0d0/                           
      data stndm/                                                               
     &     7950.0d0,  8150.0d0,  8300.0d0,  8600.0d0,  8900.0d0,                
     &     9100.0d0,  9500.0d0,  9550.0d0, 15000.0d0, 15600.0d0,                
     &    16000.0d0, 16250.0d0, 16550.0d0, 16600.0d0, 16750.0d0,                
     &    17050.0d0, 17500.0d0, 17800.0d0, 18100.0d0/                           
      data stndd/                                                               
     &      750.0d0, 2*800.0d0, 2*850.0d0, 900.0d0,2*950.0d0/                   
      data olds /                                                               
     &     1150.0d0,  1200.0d0,2*1250.0d0,1300.0d0, 1350.0d0,                   
     &   2*1400.0d0/                                                            
      data oldm /                                                               
     &    2*950.0d0,2*1000.0d0,2*1050.0d0,2*1100.0d0/                           
      data aif/                                                                 
     &     1.0d0, 1.016d0, 1.0385d0, 1.063d0, 1.0966d0,                         
     &   1.138d0, 1.165d0, 1.2147d0, 1.216d0, 1.0d0,                            
     &   1.039d0, 1.066d0, 1.084d0 , 1.101d0, 1.1063636d0,                      
     &   1.115d0, 1.1372d0,1.16454545455d0,1.1868571d0,1.203d0/                 
      data ptr/                                                                 
     &    2*150.d0, 5*175.d0, 13*200.d0, 9*250.d0, 8*300.d0,                    
     &      305.d0,   320.d0,    335.d0,   350.d0,   365.d0,                    
     &      385.d0,   400.d0,    415.d0/                                        
      data rate/                                                                
     &     4*.19d0, .1924d0,  .219d0 ,  .2675d0, .255d0, .2315d0,               
     &     .2221d0, .2346d0,4*.2296d0,6*.2750d0, .270d0, .2650d0,               
     &      .260d0/                                                             
      data tabs77/                                                              
     &              1000.0d0, .03d0,  1500.0d0, .04d0,  2000.0d0, .05d0,        
     &              2500.0d0, .06d0,  8000.0d0, .07d0,  1.e20, .0d0/            
      data tabm77/                                                              
     &              1500.0d0, .03d0,  2000.0d0, .04d0,  2500.0d0, .05d0,        
     &              8000.0d0, .06d0,  1.e20, .0d0/                              
      data tabs84/                                                              
     &              1200.0d0, .03d0,  2000.0d0, .04d0,  2500.0d0, .05d0,        
     &              3000.0d0, .06d0, 11000.0d0, .07d0,  1.e20, .0d0/            
      data tabm84/                                                              
     &              2000.0d0, .03d0,  2500.0d0, .04d0,  3000.0d0, .05d0,        
     &             12500.0d0, .06d0,     1.e20, .0d0/                           
      data tabs88/                                                              
     &              4000.0d0, .03d0,  6000.0d0, .04d0,  8000.0d0, .05d0,        
     &             12500.0d0, .06d0,     1.e20, .0d0/                           
      data tabm88/                                                              
     &              4000.0d0, .03d0,  6000.0d0, .04d0, 11000.0d0, .05d0,        
     &             12500.0d0, .06d0,     1.e20, .0d0/                           
      data tabs97/                                                              
     &              4000.0d0, .03d0,  6000.0d0, .04d0,  8000.0d0, .05d0,        
     &             18000.0d0, .06d0,     1.e20, .0d0/                           
      data tabm97/                                                              
     &              4000.0d0, .03d0,  6000.0d0, .04d0, 11000.0d0, .05d0,        
     &             18000.0d0, .06d0,     1.e20, .0d0/                           
      data tabs98/                                                              
     &              6000.0d0, .03d0,  9000.0d0, .04d0, 12000.0d0, .05d0,        
     &             25000.0d0, .06d0,     1.e20, .0d0/                           
      data tabm98/                                                              
     &              6000.0d0, .03d0,  9000.0d0, .04d0, 15000.0d0, .05d0,        
     &             25000.0d0, .06d0,     1.e20, .0d0/                           
      data tabs99/  6000.d0,.03d0,9000.d0,.04d0,12000.d0,.05d0,                 
     &             30000.d0,.06d0,  1.e20,0.d0/                                 
      data tabm99/  6000.d0,.03d0,9000.d0,.04d0,15000.0d0,.05d0,                
     &             30000.d0,.06d0,  1.e20,0.d0/                                 
      data tab01s/                                                              
     &      27050.0d0,3.825d0,  65550.0d0,7.14d0  , 136750.0d0,7.905d0,         
     &     297350.0d0,9.180d0,      1.e20,10.098d0/                             
      data tab01h/                                                              
     &      36250.0d0,3.825d0,  93650.0d0,7.14d0  , 151650.0d0,7.905d0,         
     &     297350.0d0,9.18d0 ,      1.e20,10.098d0/                             
      data tab01m/                                                              
     &      45200.0d0,3.825d0, 109250.0d0,7.14d0  , 166500.0d0,7.905d0,         
     &     297350.0d0,9.18d0 ,      1.e20,10.098d0/                             
      data tab02s/                                                              
     &      27950.0d0,3.750d0,  67700.0d0,7.0d0  , 141250.0d0,7.75d0,           
     &     307050.0d0,9.0d0  ,      1.e20,9.9d0/                                
      data tab02h/                                                              
     &      37450.0d0,3.750d0,  96700.0d0,7.0d0  , 156600.0d0,7.75d0,           
     &     307050.0d0,9.0d0  ,      1.e20,9.90d0/                               
      data tab02m/ 46700.d0,3.75d0,112850.d0,7.d0,171950.d0,7.75d0,             
     &            307050.d0,9.0d0 ,    1.e20,9.9d0/                             
      data tab11/55000.d0,3.75d0,125000.d0,4.75d0,1.e20, 5.99d0/                
      mst=int(data(2))                                                               
      nfile=int(filing(mst,1.,2.,3.,2.))                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
c 2016+ modification worksheet: Taxable Social Security Income                  
c DECREASING FEDERAL AGI                                                        
      agi=comnew(2)                                                             
      if(law.ge.2016.and.comnew(79).gt.0.d0.and.data(9).gt.0.d0) then           
         if(mst.eq.5) then                                                      
           if(agi.lt.100000*aif16(law))agi = agi - comnew(79)                   
         else if(mst.eq.2.and.agi.lt.100000*aif16(law)) then                    
           if(data(9).eq.1.d0) then                                             
              agi = agi - .5*comnew(79)                                         
           else                                                                 
              agi = agi - comnew(79)                                            
           endif                                                                
         else if(mst.eq.1.or.mst.eq.4.or.mst.eq.4.or.sep.eq.2) then             
           if(agi.lt.80000*aif16(law)) agi = agi - comnew(79)                   
         endif                                                                  
      endif                                                                     
      if(law.ge.2017) then                                                      
c 2017 taxable retirement income up to $15k                                     
         fagi = 80000.d0*aif17(law)                                             
         if(mst.eq.2.or.mst.eq.5.or.mst.eq.3.or.mst.eq.6)                       
     &   fagi = 100000.d0*aif17(law)/sep                                        
         if(comnew(2).le.fagi)                                                  
     &   agi = agi - min(data(9)*15000.d0,data(20)+data(72))                    
      endif                                                                     
c 2009 unemployment compensation is taxed in full                               
      if(law.eq.2009) agi = agi - comnew(78) + data(82)                         
c 2020 CARES Act                                                                
      if(law.eq.2020) then                                                      
         agi = agi + data(82) - comnew(78)                                      
c        if(comnew(26).lt.1.d0) agi = agi + min(300.d0,data(58))                
      endif                                                                     
      earncr = 0.                                                               
      ltg = max(0.0d0,comnew(6))                                                
      if(law.le.2000) then                                                      
        rt=rate(law)*comnew(72)/100.                                            
c tax before credits less foreign tax credit, credit for child and dependent    
c care expenses, credit for elderly, earned income credit                       
        if(law.ge.1986) then                                                    
c RI allows EITC in 1986                                                        
              fedtax=max(0.0d0,comnew(52)-                                      
     &        data(34)-comnew(53)-comnew(54)-comnew(59))                        
        else                                                                    
              fedtax=max(0.0d0,comnew(52)-                                      
     &        data(34)-comnew(53)-comnew(54))                                   
        endif                                                                   
        statax=rate(law) * fedtax                                               
      else if(law.ge.2001.and.law.le.2010) then                                 
        if(law.le.2002) then                                                    
          taxinc = comnew(29)                                                   
        else                                                                    
          if(mst.eq.1) then                                                     
             stded = stnds(law) + (data(9)+data(10))*olds(law)                  
          elseif(mst.eq.4.or.mst.eq.7) then                                     
             stded = stndh(law) + (data(9)+data(10))*olds(law)                  
          else                                                                  
             stded = stndm(law) + (data(9)+data(10))*oldm(law)                  
          endif                                                                 
          if(data(105).gt.0.0d0) then                                           
              stded=min(stded,max(stndd(law),comnew(37)+250.))                  
          endif                                                                 
          xitded = max(0.d0,comnew(30)-comnew(34))                              
          deduc = max(stded,xitded)                                             
          taxinc = max(0.0d0,agi-deduc-comnew(83))                              
        endif                                                                   
        if(mst.eq.1) then                                                       
          if(law.eq.2001) then                                                  
             call look(tab01s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)           
          else if (law.ge.2002.and.law.le.2010) then                            
             call look(tab02s,taxinc,5,n,statax,aif(law),0.0d0,rt,data)         
          endif                                                                 
        else if(mst.eq.4.or.mst.eq.7) then                                      
          if(law.eq.2001) then                                                  
             call look(tab01h,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)           
          else if (law.ge.2002.and.law.le.2010) then                            
             call look(tab02h,taxinc,5,n,statax,aif(law),0.0d0,rt,data)         
          endif                                                                 
        else                                                                    
          taxy1= taxinc*sep                                                     
          if(law.eq.2001) then                                                  
                call look(tab01m,taxy1,5,n,tax1,1.0d00,0.0d0,rt,data)           
          else if (law.ge.2002.and.law.le.2010) then                            
                call look(tab02m,taxy1,5,n,tax1,aif(law),0.0d0,rt,data)         
          endif                                                                 
          statax = tax1/sep                                                     
        endif                                                                   
c Schedule D Tax Worksheet                                                      
c 2001 and 2002 no code for tax computation                                     
c using maximum capital gains rates because of complexity                       
        tax25 = 0.d0                                                            
        tax50 = 0.d0                                                            
        if(ltg.gt.0.and.law.ge.2003.and.law.le.2009) then                       
           taxnon = max(0.0d0,taxinc - ltg)                                     
           if(mst.eq.1) then                                                    
             call look(tab02s,taxnon,5,n,stanon,aif(law),0.0d0,rt,data)         
           else if(mst.eq.4.or.mst.eq.7) then                                   
             call look(tab02h,taxnon,5,n,stanon,aif(law),0.0d0,rt,data)         
           else                                                                 
             taxn1 = taxnon*sep                                                 
             call look(tab02m,taxn1,5,n,staxn1,aif(law),0.0d0,rt,data)          
             stanon = staxn1/sep                                                
           endif                                                                
           br  = min(taxinc,brack(nfile,law)/sep)                               
           taxbr  = min(taxnon,br)                                              
           taxy25 = br - taxbr                                                  
           tax25 = .025*taxy25                                                  
           taxy50 = min(ltg,taxinc)-taxy25                                      
           tax50  = .05*taxy50                                                  
           taxscd = stanon + tax25 + tax50                                      
           statax = min(taxscd,statax)                                          
        endif                                                                   
      else if(law.ge.2011) then                                                 
c 2011 changes: fewer tax brackets,                                             
c a decrease in the top marginal income tax rate                                
c higher standard deduction mounts for most taxpayers                           
c the elimination of using federal itemized deductions                          
c the elimination of additional st ded schedules                                
        if(mst.eq.1) then                                                       
            stded = stnds(law)                                                  
        elseif(mst.eq.4.or.mst.eq.7) then                                       
            stded = stndh(law)                                                  
        else                                                                    
            stded = stndm(law)                                                  
        endif                                                                   
        exemp = comnew(68)*xmp(law)                                             
        phas11s = 175000*aif(law)                                               
        phas11f = 195000*aif(law)                                               
        if(agi.gt.phas11f) then                                                 
           stded = 0.                                                           
           exemp = 0.                                                           
        else if(agi.gt.phas11s.and.agi.le.phas11f) then                         
           perc = 1                                                             
           xincr = 5000*aif(law)                                                
c discrete phaseout                                                             
           number = int((agi-phas11s)/xincr + 1)                                
           if(number.eq.1) perc = .8                                            
           if(number.eq.2) perc = .6                                            
           if(number.eq.3) perc = .4                                            
           if(number.eq.4) perc = .2                                            
c          perc = max(0.0d0,(10.0d0-2.0d0*number)/10.0d0)                       
           stded = perc*stded                                                   
           exemp = perc*exemp                                                   
c we want to smooth exemption and st. deduction phase-outs                      
           ratio = min(1.0d0,.02*max(0.0d0,agi-phas11s)/xincr)                  
           stded = stded - ratio * stded                                        
           exemp = exemp - ratio * exemp                                        
        endif                                                                   
        deduc = stded/sep                                                       
        taxinc = max(0.0d0,agi-deduc-exemp)                                     
        call look(tab11,taxinc,3,n,statax,aif(law),0.0d0,rt,data)               
      endif                                                                     
c Rhode Island Alternative Minimum tax starts in 2001;                          
c 2011 -- the elimination of AMT                                                
      altax=0.                                                                  
      if((law.ge.2001.and.law.le.2002).and.comnew(70).gt.0.0d0)                 
     & altax=max(0.0d0,.25*comnew(70)-statax+.25*data(34))                      
      if(law.ge.2003.and.law.le.2010) then                                      
        exclnt = max(0.0d0, excl(nfile,law)/sep -                               
     &   .25*max(0.0d0,comnew(69) - phase(nfile,law)/sep))                      
c Number of lines based on Form RI-6251 for the year 2003                       
        alminy = max(0.0d0,comnew(69) - exclnt)                                 
        if(ltg.lt.1) then                                                       
         if(alminy.lt.175000.d0/sep) then                                       
          xline4 = .065*alminy                                                  
         else                                                                   
          xline4 = max(0.0d0,.07*alminy - 875.d0/sep)                           
         endif                                                                  
         xline8 = max(0.0d0,xline4 - .25*data(164))                             
         xline13 = max(0.0d0,statax - .25*data(34))                             
         altax = max(0.0d0,xline8 - xline13 - statax)                           
        else                                                                    
         almnon = max(0.0d0,alminy - ltg)                                       
         if(almnon.lt.175000.d0/sep) then                                       
           amtnon = .065*almnon                                                 
         else                                                                   
           amtnon = max(0.0d0,.07*almnon - 875.d0/sep)                          
         endif                                                                  
         altax = max(0.0d0,amtnon + tax25 + tax50 - statax)                     
        endif                                                                   
      endif                                                                     
      statax=statax+altax                                                       
c since 2006 RI Alternative Flat Tax                                            
c 2011 - the elimination of Alternative flat tax method                         
      if(law.ge.2006.and.law.le.2010) then                                      
        fltax = flrate(law)*max(0.0d0,comnew(2))                                
        statax = min(statax,fltax)                                              
      endif                                                                     
c Credits                                                                       
      crinv=.5*data(33)                                                         
      ecred=twn(.5*data(38),0.0d0,1000.0d0)                                     
      pcred=0.                                                                  
      ptax=0.                                                                   
      frac=0.                                                                   
c credit for child and dependent care expenses                                  
      if(law.ge.2001) then                                                      
         chcr = .25*min(comnew(53),max(0.d0,comnew(52)-data(34)))               
         statax = max(0.d0,statax - chcr)                                       
      endif                                                                     
c property tax relief credit                                                    
      if(data(9).gt.0.) then                                                    
        ptax = data(51)+data(160)*.2                                            
        if(data(7).gt.1..or. data(8).gt.0.) then                                
           if(law.le.1983.and.hy.lt.8000.) then                                 
             frac = tablki(tabm77,5,hy,data)                                    
           else if(law.ge.1984.and.law.le.1987.and.hy.lt.12500.) then           
             frac = tablki(tabm84,5,hy,data)                                    
           else if(law.ge.1988.and.law.le.1996.and.hy.lt.12500.) then           
             frac = tablki(tabm88,5,hy,data)                                    
           else if(law.eq.1997.and.hy.lt.18000.) then                           
             frac = tablki(tabm97,5,hy,data)                                    
           else if(law.eq.1998.and.hy.le.25000.) then                           
             frac = tablki(tabm98,5,hy,data)                                    
           else if(law.ge.1999.and.hy.lt.30000.) then                           
             frac = tablki(tabm99,5,hy,data)                                    
          endif                                                                 
        else if(data(7).lt.2..and.data(7).gt.0..and.data(8).lt.1.) then         
           if(law.le.1983.and.hy.lt.8000) then                                  
             frac = tablki(tabs77,6,hy,data)                                    
           else if(law.ge.1984.and.law.le.1987.and.hy.lt.11000.) then           
             frac = tablki(tabs84,6,hy,data)                                    
           else if(law.ge.1988.and.law.le.1996.and.hy.lt.12500.) then           
             frac = tablki(tabs88,5,hy,data)                                    
           else if(law.eq.1997.and.hy.lt.18000.) then                           
             frac = tablki(tabs97,5,hy,data)                                    
           else if(law.eq.1998.and.hy.lt.25000.) then                           
             frac = tablki(tabs98,5,hy,data)                                    
           else if(law.ge.1999.and.hy.lt.30000.) then                           
             frac = tablki(tabs99,5,hy,data)                                    
          endif                                                                 
        endif                                                                   
        if(frac.gt.0.0d0) pcred=twn(ptax-frac*hy,0.0d0,ptr(law))                
      endif                                                                     
      if(statax.ge.100)statax=twn(statax-crinv,100.0d0,statax)                  
      statax=max(0.0d0,statax-ecred)                                            
c refunds allowed                                                               
c     changed 2/13/91; property tax accounting                                  
c RI Earned Income Credit  2001-2002 - nonrefundable                            
      if(law.eq.2001) earncr=.255*comnew(59)                                    
      if(law.eq.2002) earncr=.25*comnew(59)                                     
      if(law.le.2002) statax = max(0.0d0,statax-pcred-earncr)                   
c 2003-2014, non-ref + refundable part of earncr                                
      if(law.ge.2003) then                                                      
        if(law.le.2014) then                                                    
          earnon =  min(statax,.25*comnew(59))                                  
          earref =  eicpr(law)* (.25*comnew(59)-earnon)                         
          earncr = earnon + earref                                              
        else                                                                    
c 2015 refundable                                                               
          earncr = eicpr(law)*comnew(59)                                        
        endif                                                                   
        statax = statax - earncr - pcred                                        
      endif                                                                     
      if(law.ge.1986.and.law.le.2000) then                                      
        fed = max(0.0d0,comnew(52)-data(34)-comnew(53)-comnew(54))              
        if(fed.gt.comnew(59)) then                                              
           earncr = rate(law)*comnew(59)                                        
        else                                                                    
           earncr = rate(law)*fed                                               
        endif                                                                   
      endif                                                                     
      credit = pcred + ecred + crinv + earncr                                   
      return                                                                    
      end                                                                       
c  SOUTH CAROLINA                                                              
c  State 41                                                                    
c  Updated through 2021 (04-05-2022)                                           
      subroutine sctax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/                                                              
     & hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,earncr,credit,rt
      common /user/ zbrack(3,1987:2023),exem(1987:2023),                        
     &crmax(1987:2023,0:3,1:2),ymax(1987:2023,0:3,1:2),                         
     1rtbase(1987:2023,0:3), rtless(1987:2023,0:3),                             
     2chmax(1998:2023),ealim(2001:2023),cphas(7)                                
      dimension data(255),comnew(255),aif92(1991:2012),aif13(2013:2017)         
      dimension tab(2,6),tab85s(2,11),tab85j(2,7)                               
      dimension tab87(2,5),exs(1985:1986),exj(1985:1986)                        
      dimension aif(1977:2000), gas(1977:1981),tab95(2,6)                       
     &,tab03(2,6),aif02(2002:2021),tab01(2,10)                                  
      dimension tab90(2,6),eicr(2018:2021),earmax(1987:2021),                   
     & xmp(2018:2021)                                                           
      dimension pnsion(1977:2021),pns65(1993:2021),char(1977:1984)              
      double precision irales,keoles                                            
      integer sep                                                               
      data xmp /4110.d0,4190.d0,4260.d0,4300.d0/                                
      data earmax/31*30000.d0,33333.d0,36667.d0,40000.d0,43333.d0/              
      data eicr/.2083d0,.4167d0,.625d0,.833d0/                                  
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data aif02/                                                               
     &    .9625d0,  2*1.d0,  1.025d0,  1.054d0,  1.0708d0, 1.0958d0,            
     &   1.1125d0,1.1417d0,  1.15d0 ,  1.167d0,  1.1875d0,2*1.2d0,              
     &   1.21666d0,1.22083d0,1.2375d0, 3*1.279167d0/                            
      data aif92/1.d0,                                                          
     &           1.0525d0, 1.0845d0, 1.118d0, 1.147d0 , 1.1795d0,               
     &           1.212d0 , 1.245d0 , 1.266d0, 1.2895d0, 1.3295d0,               
     &           1.373d0 , 1.395d0 , 1.427d0, 1.4595d0, 1.505d0 ,               
     &           1.564d0 , 1.5995d0, 1.668d0,2*1.6955d0,1.7365d0/               
      data tab/     2000.0d0, 2.0d0,  4000.0d0, 3.0d0, 6000.0d0,4.0d0,          
     &              8000.0d0, 5.0d0, 10000.0d0, 6.0d0, 1.e20,7.0d0/             
      data tab85s/                                                              
     &     1600.0d0, 2.0d0 , 2600.0d0, 2.5d0, 3600.0d0, 3.0d0,                  
     &     4600.0d0, 3.6d0 , 5600.0d0, 4.0d0, 6600.0d0, 4.6d0,                  
     &     7600.0d0, 5.0d0 , 8600.0d0, 5.5d0, 9600.0d0, 6.0d0,                  
     &    10600.0d0, 6.4d0 ,    1.e20, 7.0d0/                                   
      data tab85j/                                                              
     &     2000.0d0, 2.0d0 , 4000.0d0, 3.0d0, 6000.0d0, 4.0d0,                  
     &     8000.0d0, 5.0d0 ,10000.0d0, 6.0d0,12000.0d0, 6.6d0,                  
     &        1.e20, 7.0d0/                                                     
      data tab87/                                                               
     &     4000.0d0, 3.0d0 ,  6000.0d0, 4.0d0, 8000.0d0, 5.0d0,                 
     &    10000.0d0, 6.0d0 ,     1.e20, 7.0d0/                                  
      data tab90/                                                               
     &     2030.0d0, 2.75d0,  4060.0d0, 3.0d0, 6090.0d0, 4.0d0,                 
     &     8120.0d0, 5.0d0 , 10150.0d0, 6.0d0,    1.e20, 7.0d0/                 
      data tab95/                                                               
     &     2000.0d0, 2.5d0 ,  4000.0d0, 3.0d0, 6000.0d0, 4.0d0,                 
     &     8000.0d0, 5.0d0 , 10000.0d0, 6.0d0,    1.e20, 7.0d0/                 
      data tab01/                                                               
     &     2000.0d0, 2.5d0 ,  3000.0d0, 2.8d0, 4000.0d0, 3.0d0,                 
     &     5000.0d0, 3.2d0 ,  6000.0d0, 4.0d0, 7000.0d0, 4.1d0,                 
     &     9000.0d0, 4.8d0 , 11000.0d0, 5.7d0,13000.0d0, 6.55d0,                
     &        1.e20, 7.0d0/                                                     
      data tab03/                                                               
     &     2400.0d0,  .0d0 ,  4800.0d0, 3.0d0, 7200.0d0, 4.0d0,                 
     &     9600.0d0, 5.0d0 , 12000.0d0, 6.0d0,    1.e20, 7.0d0/                 
      data pnsion/6*0.0d0, 2*1200.0d0, 2100.0d0, 36*3000.0d0/                   
      data pns65 /29*10000.0d0/                                                 
      data char/6*.3d0,.2d0,.1d0/                                               
      data aif/7*1.0d0,1.009d0,6*1.0d0,5*1.111d0,1.125d0,1.14d0,                
     &         3*1.155d0/                                                       
      data gas/3*78.0d0,91.0d0,101.0d0/                                         
      data exs/2400.0d0,2550.0d0/                                               
      data exj/3550.0d0,3700.0d0/                                               
c                                                                               
c brackets, deductions and exemptions are indexed.                              
c                                                                               
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rt=0.                                                                     
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)                                           
     & phas92=100000.*aif92(law)/sep                                            
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c AGI                                                                           
      if(law.le.1984) then                                                      
        agi=comnew(2)+divexc(data,comnew,law)+max(0.0d0,data(82)-               
     &    comnew(78))                                                           
        call sccg(cg,data)                                                      
        agi=agi-max(0.0d0,comnew(6))+max(0.0d0,cg)                              
        if(law.ge.1980)agi=agi-twn(data(38)*1.4,0.0d0,1000.0d0)                 
        if(law.eq.1982) then                                                    
          agi=agi+irales(data,comnew,1980)+keoles(data,comnew,1980)             
        endif                                                                   
        if(law.ge.1982)agi=agi-twn(data(12)+data(14),0.0d0,200.*data(7))        
      else if(law.ge.1985) then                                                 
        agi=comnew(29)                                                          
        agi=agi-xjobs(data,law)                                                 
      endif                                                                     
      agi=agi-data(22)                                                          
c 2009 and 2020 unemployment compensation is taxed in full                      
      if(law.eq.2009.or.law.eq.2020) agi = agi - comnew(78) + data(82)          
      if(comnew(26).eq.0.d0.and.data(58).gt.0.d0) then                          
         if(law.eq.2020) agi = agi + min(300.d0/sep,data(58))                   
         if(law.eq.2021) agi = agi + min(300.d0*data(7),data(58))               
      endif                                                                     
      if(law.ge.1979)agi=agi-disab(data,comnew,law)                             
c retirement exclusion                                                          
      retded = 0.                                                               
      if(law.ge.1983.and.law.le.1992)                                           
     &   retded = twn(data(20)+data(72),0.0d0,pnsion(law) *data(7))             
c ???Since 1993 the algorithm must be :                                         
c 1. if you take up to r3000 exclusion before 65+ you can                       
c    claim this exclusion for the rest of your life                             
c 2. if you take up to r1000 exclusion at 65+.You didn't take                   
c    retirement exclusions before the age of 65.                                
      if(law.ge.1993) then                                                      
         if(data(9).lt.1.)  then                                                
           retded = twn(data(20)+data(72),0.0d0,pnsion(law) *data(7))           
         else if(data(9).gt.0.) then                                            
           retded = twn(data(20)+data(72),0.0d0,pns65(law)*data(7))             
           if(data(9).lt.2.and.data(9).gt.0.and.mst.eq.2)                       
     &      retded = twn(data(20)+data(72),0.0d0,pns65(law)+pnsion(law))        
         endif                                                                  
      endif                                                                     
c      write(0,*) '1 retded',retded                                             
c Age 65 and older deduction since 1997 (other than military income only)       
      if(data(9).gt.0) then                                                     
c         if (law.ge.1997.and.law.le.1998) retded=11500*data(9)                 
         if (law.ge.1999) then                                                  
           retmax = 15000.d0*data(9)                                            
           retd2 = retmax - retded                                              
c         write(0,*) 'retd2',retd2                                              
           retded = retd2 + retded                                              
         endif                                                                  
      endif                                                                     
c      write(0,*) '2 retded',retded                                             
      agi = agi - retded                                                        
c Social Security amount if taxed by Federal                                    
      if(law.ge.1984) agi=agi-comnew(79)                                        
      if(law.le.1983.and.data(9).gt.0) then                                     
        if(data(8).gt.0) then                                                   
          if(agi.le.4000) return                                                
        else                                                                    
          if(agi.le.2800) return                                                
        endif                                                                   
      endif                                                                     
      if(law.le.1984) then                                                      
        ag=max(0.0d0,agi)                                                       
        stded=min(.1*ag*aif(law),aif(law)*500.*data(7))                         
        xitded=max(0.d0,comnew(30)-comnew(34)-comnew(20)-data(50))              
        jlaw=1980                                                               
        call nlaw(data,jlaw)                                                    
        fedtax=comnew(1)                                                        
        call nlaw(data,law)                                                     
        xitded=max(0.d0,xitded-data(60)+twn(fedtax,0.0d0,500.*data(7)))         
c assume 10,000 miles driven per taxpayer                                       
        if(law.le.1981) xitded=xitded + (gas(law)*data(7))                      
        ed=data(47)+data(48)+data(49)                                           
        if(law.le.1982)xitded=xitded+max(0.0d0,ed-ag*.05)                       
        if(law.ge.1983)xitded=xitded+max(0.0d0,ed-ag*.03)                       
        contr=data(58)+data(59)                                                 
        clim=char(law)*ag                                                       
        if(contr.gt.clim)xitded=max(0.d0,xitded-(contr-clim))                   
        chcr=min(data(64),((min(data(8),3.0d0)*1200.)+1200.))                   
        chcr=max(chcr-max(0.0d0,.5*(agi-18000.)),0.0d0)                         
        xitded=xitded+chcr                                                      
        deduc=max(stded,xitded)                                                 
c Exemptions                                                                    
        exemp =  comnew(68)*aif(law)*800.                                       
        if(mst.eq.4.or.mst.eq.7)exemp=exemp+aif(law)*800.                       
        if(mst.eq.5.and.data(8).gt.0)exemp=exemp+aif(law)*800.                  
        taxinc = max(0.0d0,agi - deduc - exemp)                                 
        call look(tab,taxinc,6,n,statax,aif(law),0.0d0,rt,data)                 
        foodcr=0.                                                               
        if(law.eq.1984)foodcr=(data(8)+data(7))*12.5                            
        statax=statax-foodcr                                                    
        credit = foodcr                                                         
      else if(law.ge.1985) then                                                 
        tx = 0.                                                                 
c if you deducted state and local income taxes while itemizing                  
c on your federal return , you are required to add all or part of               
c this amount                                                                   
        if(comnew(26).gt.0.) then                                               
          if(law.le.2017) then                                                  
            tx = data(50)                                                       
            xtot = comnew(24)                                                   
            if(law.ge.1991.and.law.le.2017) then                                
              if(comnew(2).gt.phas92.and.comnew(30).gt.0)                       
     &        tx=data(50)-comnew(34)*data(50)/comnew(30)                        
              tx = min(tx,xtot-comnew(3))                                       
            endif                                                               
          else                                                                  
c 2018+ state tax addback if itemizing on federal return                        
            exc1 = max(0.0d0,comnew(24)-comnew(3))                              
            exc2 = max(0.0d0,10000.d0/sep-data(51)-data(54))                    
            exc3 = min(exc1,exc2)                                               
            tx = min(data(50),exc3)                                             
          endif                                                                 
        endif                                                                   
c Net gain on assets held two or more years has been allowed subtraction        
c since 1990 : 14% in 1990, 29% in 1991-1994 and 44% since 1995                 
        dedgan = 0.                                                             
        if(law.eq.1990) then                                                    
           dedgan = .14 * max(0.0d0,(data(70)- data(88)))                       
        else if(law.ge.1991.and.law.le.1994) then                               
           dedgan = .29 * max(0.0d0,(data(70)-data(88)))                        
           if(law.ge.1993) dedgan = max(0.0d0,dedgan -.29*data(83))             
        else if(law.ge.1995) then                                               
           dedgan = .44 * max(0.0d0,(data(70)-data(88) -data(83)))              
        endif                                                                   
c Married filers claiming standard deduction in 2003                            
c For 2003, this adjustment is necessary due to                                 
c a federal law change not adopted by South Carolina                            
        add = 0.                                                                
        if(law.eq.2003.and.comnew(26).lt.1..and.(mst.eq.2.or.sep.eq.2))         
     &    then                                                                  
          add =  min(comnew(3),max(comnew(2)-comnew(83),0d0))                   
          add =  max(0.0d0,add-7950)/sep                                        
        endif   
c       if(law.ge.2008.and.data(51).gt.0)add = min(500*data(7),data(51))        
c SC Phase-out Adjustment
        adjust = 0.d0
        if(law.le.2017) then
           xl4 = comnew(30)+comnew(68)*exem(law)
           xl7 = comnew(24)+comnew(83)
           adjust =  max(0.0d0,xl4 - xl7)
        endif 
c 2018+ new SC DEPENDENT EXEMPTION (line w of the SC1040) ? $4,110              
c is allowed for each eligible dependent.                                       
        exemp = 0.d0                                                            
        if(law.ge.2018) exemp = xmp(law)*(data(8)+data(210))                    
        taxinc=max(0.0d0,agi+tx-dedgan+add-exemp-adjust)                       
c       write(0,*) 'taxinc agi tx dedgan add exemp adjust',                            
c     & taxinc,agi,tx,dedgan,add,exemp,adjust                                          
        if(law.eq.1985.or.law.eq.1986) then                                     
          if(mst.eq.1) then                                                     
           taxinc = max(0.0d0,taxinc - exs(law))                                
           call look(tab85s,taxinc,11,n,statax,1.0d0,0.0d0,rt,data)             
          else                                                                  
           taxinc = max(0.0d0,taxinc - exj(law)/sep)                            
           call look(tab85j,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)              
          endif                                                                 
        else if(law.ge.1987.and.law.le.1989) then                               
           call look(tab87,taxinc,5,n,statax,aif(law),0.0d0,rt,data)            
        else if(law.eq.1990) then                                               
           call look(tab90,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)               
        else if(law.ge.1991.and.law.le.2000) then                               
           call look(tab95,taxinc,6,n,statax,aif(law),0.0d0,rt,data)            
        else if(law.eq.2001) then                                               
           call look(tab01,taxinc,10,n,statax,1.0d0,0.0d0,rt,data)              
        else if(law.ge.2002) then                                               
           call look(tab03,taxinc,6,n,statax,aif02(law),0.0d0,rt,data)          
        endif                                                                   
c       write(0,*) 'taxinc statax',taxinc,statax                                
                                                                                
c CREDITS !!!                                                                   
c Child and dependent care Credit                                               
        chcr = 0.                                                               
        nccp = int(min(data(8),2.0d0))                                               
        if(sep.eq.1) then                                                       
          if (law.le.1986) then                                                 
            chcr = .07*min(2000.d0*nccp,data(64))                               
          else if(law.ge.1987.and.law.le.2001) then                             
            chcr = .07*min(2400.d0*nccp,data(64))                               
          else if(law.eq.2002) then                                             
            chcr = min(168.d0*nccp,.07*min(3000.d0*nccp,data(64)))              
          else if(law.ge.2003) then                                             
            chcr = min(210.d0*nccp,.07*min(3000.d0*nccp,data(64)))              
          endif                                                                 
        endif                                                                   
c Elderly Credit                                                                
        eldcr = 0.                                                              
        if(law.le.1994) eldcr = min(.2*data(32),300.0d0)                        
c Energy Credit                                                                 
        ecred = 0.                                                              
        if(law.le.1986) ecred = data(38)*1.4                                    
c Two wage earner Credit (married couple)                                       
        twocrd = 0.                                                             
        if(law.ge.1987.and.mst.eq.2) then                                       
         busnes = max(0.0d0,data(17))-.5*comnew(175)+max(0.0d0,data(21))        
         husb = data(85) + .5*busnes                                            
         wife = data(86) + .5*busnes                                            
         if(law.ge.2018) then                                                   
           husb = husb + data(211)+data(214)                                    
           wife = wife + data(212)+data(215)                                    
         endif                                                                  
         earnls = min(husb,wife)                                                
         twocrd = .007*twn(earnls,0.0d0,earmax(law))                            
        endif                                                                   
c 2018+ new SC EITC non-refundable                                              
        earncr = 0.d0                                                           
        if(law.ge.2018) earncr = eicr(law)*comnew(59)                           
c Total non-refundable credits                                                  
        credit = chcr + ecred + twocrd + eldcr + earncr                         
        statax = max(0.0d0,statax-credit)                                       
      endif                                                                     
      return                                                                    
      end                                                                       
c                                                                               
c     no carryovers are allowed; I didn't include the carryover here            
c      because people who had filed sc returns the previous year                
c      would not have a carryover this year                                     
      subroutine sccg(cg,data)                                                  
      implicit double precision (A-H,O-Z)                                       
      dimension data(255)                                                       
      double precision lterm                                                    
      lterm=.5*data(70)                                                         
      cg=lterm+data(68)                                                         
      return                                                                    
      end                                                                       
c  TENNESSEE                                                                    
c  State 43                                                                     
c  Updated through 2021 (04-05-2022)                                            
c  we assume all dividends from out of state.                                   
      subroutine tntax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/                                                              
     & hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,earncr,credit,rt        
      dimension data(255),comnew(255),rate(2016:2021)                           
      data rate/.05d0,.04d0,.03d0,.02d0,.01d0,.0d0/                             
c This line is in here to avoid unused variable error                           
      if(comnew(2).lt.-65435.876) then                                         
         write(0,*) 'unused var'                                                 
      endif                                                                    
      rt=.06                                                                    
      if(law.ge.2016) rt = rate(law)                                            
      mst = int(data(2))                                                             
      agi = data(12)+data(14)                                                   
c     Calculating Taxinc                                                        
      if(law.le.1985) then                                                      
          taxinc=data(12)+data(14)                                              
          statax=rt*taxinc                                                      
          if((mst.ne.2.and.data(9).gt.0.and.data(159).le.6000).or.              
     &       (mst.eq.2.and.data(9).gt.0.and.data(159).le.10000).or.             
     &       (data(10).gt.0).or.(taxinc.le.(25*data(7))))statax=0.              
      else if(law.ge.1986.and.law.le.2020) then                                 
          exemp = 1250*data(7)                                                  
          taxinc=max(0.0d0,data(12)+data(14)-exemp)                             
c if int/div income is received jointly by a blind person and a sighted spouse, 
c only one-half(1/2) of the jointly received income will be exempt from tax.    
c The sighted person is entitled to only a $1,250 exemption on a jointly return 
          if(mst.eq.2.and.data(10).lt.2.0d0.and.data(10).gt.0.0d0) then         
            exemp = 1250                                                        
            taxinc=max(0.0d0,(data(12)+data(14))/2-exemp)                       
          endif                                                                 
          statax=taxinc* rt                                                     
          if(law.le.1999) then                                                  
           if((mst.ne.2.and.data(9).gt.0.and.data(159).lt.9000).or.             
     &       (mst.eq.2.and.data(9).gt.0.and.data(159).lt.15000))                
     &        statax=0.                                                         
          else                                                                  
           if((mst.ne.2.and.data(9).gt.0.and.data(159).lt.16200)                
     &    .or.(mst.eq.2.and.data(9).gt.0.and.data(159).lt.27000))               
     &        statax=0.                                                         
          endif                                                                 
          if(data(10).gt.0.)then                                                
c A person who is legally blind is completely exempt from the tax               
            if(mst.ne.2) statax=0.                                              
            if(mst.eq.2.and.data(10).lt.2.0d0)statax=0.                         
          endif                                                                 
      else                                                                      
c No statax 2021+                                                               
        statax = 0.d0                                                           
      endif                                                                     
      return                                                                    
      end                                                                       
c  UTAH                                                                        
c  State 45                                                                    
c   Updated through 2021 (04-11-2022)                                           
      subroutine uttax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/                                                              
     & hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,earncr,credit,rt        
      dimension data(255),comnew(255),aif92(1991:2007)                          
      dimension tabs(2,7),tabm(2,6),tab82(2,6),tab88(2,6),tabm88(2,6)           
      dimension tab96(2,6),tabm96(2,6),tab97(2,6),tabm97(2,6)                   
      dimension tab01(2,6),tabm01(2,6)                                          
      dimension tab06(2,6),tabm06(2,6),aif08(2008:2021)                         
      dimension pnsion(1977:2007,2),percen(1977:2007),                          
     & xmp(2018:2021),rate(2018:2021)                                           
      data xmp/565.d0,579.d0,590.d0,1750.d0/                                    
      data rate/4*.0495d0/                                                      
      data aif08/1.0d0,1.0426d0,1.0446d0,1.06d0,1.0857d0,1.114d0,               
     &  1.1325d0,1.1504d0,1.1556111d0,1.164833d0,1.188d0,1.21675d0,             
     &  1.2399d0,1.258d0/                                                       
      data aif92/                                                               
     &     1.0d0,  1.0525d0, 1.0845d0, 1.118d0 , 1.1470d0, 1.1795d0,            
     &   1.212d0,  1.245d0 , 1.2660d0, 1.2895d0, 1.3295d0, 1.373d0 ,            
     &   1.395d0,  1.427d0 , 1.4595d0, 1.5050d0, 1.5640d0/                      
      data tabs /                                                               
     &    750.0d0, 2.25d0, 1500.0d0, 3.25d0, 2250.0d0, 4.25d0,                  
     &   3000.0d0, 5.25d0, 3750.0d0, 6.25d0, 4500.0d0, 7.250d0,                 
     &      1.e20, 7.75d0 /                                                     
      data tab82/                                                               
     &    750.0d0, 2.75d0,  1500.0d0, 3.75d0,  2250.0d0, 4.75d0,                
     &   3000.0d0, 5.75d0,  3750.0d0, 6.75d0,     1.e20, 7.75d0/                
      data tabm/                                                                
     &   1500.0d0, 2.75d0,  3000.0d0, 3.75d0,  4500.0d0, 4.75d0,                
     &   6000.0d0, 5.75d0,  7500.0d0, 6.75d0,     1.e20, 7.75d0/                
      data tab88/                                                               
     &    750.0d0, 2.55d0,  1500.0d0, 3.5d0 ,  2250.0d0, 4.4d0,                 
     &   3000.0d0, 5.35d0,  3750.0d0, 6.25d0,     1.e20, 7.2d0/                 
      data tabm88/                                                              
     &   1500.0d0, 2.55d0,  3000.0d0, 3.5d0 ,  4500.0d0, 4.4d0,                 
     &   6000.0d0, 5.35d0,  7500.0d0, 6.25d0,     1.e20, 7.2d0/                 
      data tab96/                                                               
     &    750.0d0, 2.55d0,  1500.0d0, 3.5d0 ,  2250.0d0, 4.4d0,                 
     &   3000.0d0, 5.35d0,  3750.0d0, 6.0d0 ,     1.e20, 7.0d0/                 
      data tabm96/                                                              
     &   1500.0d0, 2.55d0,  3000.0d0, 3.5d0 ,  4500.0d0, 4.4d0,                 
     &   6000.0d0, 5.35d0,  7500.0d0, 6.0d0 ,     1.e20, 7.0d0/                 
      data tab97/                                                               
     &    750.0d0, 2.3d0 ,  1500.0d0, 3.3d0 ,  2250.0d0, 4.2d0,                 
     &   3000.0d0, 5.2d0 ,  3750.0d0, 6.0d0 ,     1.e20, 7.0d0/                 
      data tabm97/                                                              
     &   1500.0d0, 2.3d0 ,  3000.0d0, 3.3d0 ,  4500.0d0, 4.2d0,                 
     &   6000.0d0, 5.2d0 ,  7500.0d0, 6.0d0 ,     1.e20, 7.0d0/                 
      data tab01/                                                               
     &    863.0d0, 2.3d0 ,  1726.0d0, 3.3d0 ,  2588.0d0, 4.2d0,                 
     &   3450.0d0, 5.2d0 ,  4313.0d0, 6.0d0 ,     1.e20, 7.0d0/                 
      data tabm01/                                                              
     &   1726.0d0, 2.3d0 ,  3450.0d0, 3.3d0 ,  5176.0d0, 4.2d0,                 
     &   6900.0d0, 5.2d0 ,  8626.0d0, 6.0d0 ,     1.e20, 7.0d0/                 
      data tab06/                                                               
     &   1000.0d0, 2.3d0 ,  2000.0d0, 3.3d0 ,  3000.0d0, 4.2d0,                 
     &   4000.0d0, 5.2d0 ,  5500.0d0, 6.0d0 ,     1.e20, 6.98d0/                
      data tabm06/                                                              
     &   2000.0d0, 2.3d0 ,  4000.0d0, 3.3d0 ,  6000.0d0, 4.2d0,                 
     &   8000.0d0, 5.2d0 , 11000.0d0, 6.0d0 ,     1.e20, 6.980d0/               
      data pnsion/                                                              
     &   10*4800.0d0,2500.0d0,20*4800.0d0,10*6000.0d0,3600.0d0,6000.0d0,        
     &   19*7500.0d0/                                                           
      data percen/10*1.0d0, .0d0, .33d0,19*.5d0/                                
      rt=0.                                                                     
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      deduc = 0.                                                                
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2007)                                           
     & phas92=100000.*aif92(law)/sep                                            
c Algorithm mirors structure on actual tax form                                 
      agi=comnew(2)                                                             
c Exemptions                                                                    
      if(law.lt.1987) then                                                      
         exemp = 750*comnew(68)                                                 
      else if(law.ge.1988.and.law.le.2017) then                                 
         exemp = comnew(83)*.75d0                                               
      else if(law.ge.2018) then                                                 
         exemp  = data(8)*xmp(law)                                              
      endif                                                                     
      if (law.le.2007) then                                                     
c Deductions                                                                    
         xitded=max(0.0d0,comnew(24)*comnew(26)-data(50))                       
         if(law.le.1986) then                                                   
            stded=twn(.15*agi,1300.d0/sep,2000.d0/sep)*                         
     &      (xif(law.gt.1980,-comnew(26)) + 1.)                                 
         else                                                                   
            if(comnew(26).gt.0.0d0) then                                        
              stded=0                                                           
            else                                                                
              stded=comnew(3)                                                   
            endif                                                               
         endif                                                                  
         deduc=max(xitded,stded)                                                
c Federal Tax deduction                                                         
         fedtax=max(0.0d0,comnew(70)+data(42)+data(39)+comnew(52)-              
     &    comnew(58))*percen(law)                                               
c State Tax refund included in Federal Income                                   
         stref=data(22)                                                         
c Retirement income deduction                                                   
         retded = 0.                                                            
         nold = int(data(9))                                                         
         divren = data(12)+data(14)+data(73)                                    
         retinc = data(20)+data(72)+comnew(79)+divren*min(1.0d0,data(9))        
         if(law.ge.1988) then                                                   
            if(mst.eq.1.or.mst.eq.5) then                                       
               phase = 25000.d0                                                 
            else                                                                
               phase = 32000.d0/sep                                             
            endif                                                               
            ret = max(0.0d0,comnew(2) - phase)                                  
            if(nold.eq.0.and.retinc.gt.0) then                                  
c if a taxpayer or both a taxpayer and his wife are under the age 65,           
c they are eligible for retirement income deduction only if they have           
c qualifying income                                                             
               quainc = min(retinc,pnsion(law,1))                               
               retded = max(0.0d0,-.5*ret + data(7)*quainc)                     
            else if(nold.eq.1) then                                             
               retded = max(0.0d0,-.5*ret + pnsion(law,2))                      
            else if(nold.eq.2) then                                             
               retded = max(0.0d0,-.5*ret + 2*pnsion(law,2))                    
            endif                                                               
c I can't distinguish if one of the spouses is 65 and older and                 
c another one is under 65 with a qualifying income. So I got only               
c a case when one spouse is 65 and older and another without                    
c qualifying income                                                             
         else                                                                   
            divren = data(12)+data(14)+data(73)                                 
            retinc = data(20)+data(72)+comnew(79)+                              
     &       divren*min(1.0d0,data(9))                                          
            if(nold.eq.0) then                                                  
               retded=twn(retinc,0.0d0,data(7)*pnsion(law,1))                   
            else if(nold.eq.1) then                                             
               retded=twn(retinc,0.0d0,pnsion(law,2)+(data(7)-1)                
     &          *pnsion(law,1))                                                 
            else                                                                
               retded=twn(retinc,0.0d0,data(7)*pnsion(law,2))                   
            endif                                                               
         endif                                                                  
c State Tax Declaration Phaseout                                                
         tx=0                                                                   
         if(xitded.gt.stded) then                                               
            if(law.ge.1993) then                                                
               ag=max(0.0d0,comnew(2))                                          
               xlin4=max(0.0d0,data(49)-.075*ag)                                
               xlin8=data(50)+data(51)+data(46)                                 
               xlin11=data(53)                                                  
               xlin12=data(56)+data(53)+data(57)                                
               xlin16=data(58)+data(59)+data(60)                                
               xlin17=max(0.0d0,data(61)-.1*ag)                                 
               xlin18=data(26)                                                  
               xlin24=max(data(27)+data(63)-.02*ag,0.0d0)                       
               xlin25=data(66)                                                  
               xtot=xlin4+xlin8+xlin12+xlin16+xlin17+xlin18+xlin24+             
     &          xlin25                                                          
               xdiff=xtot-xlin4-xlin11-xlin17                                   
               if(xdiff.gt.0.) then                                             
                  xdiff2=comnew(2)-phas92                                       
                  if(xdiff2.gt.0.) then                                         
                     xconst=min(.8*xdiff,.03*xdiff2)                            
                     xlin26=xtot-xconst                                         
                     xprop=(xdiff-(xtot-xlin26))/xdiff                          
                     tx=data(50) - xprop*data(50)                               
                  endif                                                         
               endif                                                            
            endif                                                               
         endif                                                                  
         taxinc=max(0.0d0,agi-retded-stref-fedtax-exemp-deduc+tx)               
         if(mst.eq.2.or.mst.eq.4.or.mst.eq.7.or.mst.eq.5) then                  
           if(law.lt.1988) then                                                 
             call look(tabm,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)              
           else if(law.ge.1988.and.law.le.1995) then                            
             call look(tabm88,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)            
           else if(law.eq.1996) then                                            
             call look(tabm96,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)            
           else if(law.ge.1997.and.law.le.2000) then                            
             call look(tabm97,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)            
           else if(law.ge.2001.and.law.le.2005) then                            
             call look(tabm01,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)            
           else if(law.ge.2006.and.law.le.2007) then                            
             call look(tabm06,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)            
           endif                                                                
         else                                                                   
           if(law.lt.1982) then                                                 
             call look(tabs,taxinc,7,n,statax,1.0d0,0.0d0,rt,data)              
           else if(law.ge.1982.and.law.le.1987) then                            
             call look(tab82,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)             
           else if(law.ge.1988.and.law.le.1995) then                            
             call look(tab88,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)             
           else if(law.eq.1996) then                                            
             call look(tab96,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)             
           else if(law.ge.1997.and.law.le.2000) then                            
            call look(tab97,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)              
           else if(law.ge.2001.and.law.le.2005) then                            
            call look(tab01,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)              
           else if(law.ge.2006.and.law.le.2007) then                            
            call look(tab06,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)              
           endif                                                                
         endif                                                                  
c 2007 alternative single rate tax                                              
         if(law.eq.2007) then                                                   
           stax = max(0.0d0,agi - stref)*.0535                                  
           statax = min(stax,statax)                                            
         endif                                                                  
c  Non-refudable Credits                                                        
c  Credit for energy systems installation                                       
         encr=0.                                                                
         if(law.ge.1980.and.law.le.1985) then                                   
            encr = twn(data(38)*.6,0.0d0,1000.0d0)                              
         else if(law.ge.1986) then                                              
            encr = twn(data(38)*1.4,0.0d0,1500.0d0)                             
         endif                                                                  
         statax = max(0.0d0,statax-encr)                                        
         xcred=0.                                                               
         if(law.eq.1988.and.statax.le.80)                                       
     &     xcred=twn(.125*statax,0.0d0,10.0d0)                                  
         statax = max(0.0d0,statax-xcred)                                       
         credit=encr+xcred                                                      
      else if(law.ge.2008) then                                                 
c 2008+ Utah tax law changed. The dual tax calculation no longer applies        
c  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx                                          
         taxinc = max(0.0d0,agi-data(22))                                       
         rt = .05d0                                                             
         if(law.ge.2018) rt = rate(law)                                         
         statax = rt * taxinc                                                   
c Taxpayer tax credit -- nonrefundable                                          
         deduc = comnew(3)                                                      
         if(comnew(26).gt.0.d0) then                                            
            if(law.le.2017) then                                                
               deduc = max(0.0d0,comnew(24) - data(50))                         
            else if(law.ge.2018) then                                           
c 2018+ state tax addback if itemizing on federal return                        
               sttax = min(10000.d0/sep,data(51)+data(50)+data(54))             
               stt = min(data(50),sttax - (data(51)+data(54)))                  
               deduc = comnew(30) - stt                                         
            endif                                                               
         endif                                                                  
         if(mst.eq.4.or.mst.eq.7) then                                          
            ded = 18000.*aif08(law)                                             
         else                                                                   
            ded = 12000.*aif08(law)*data(7)                                     
         endif                                                                  
         xl16 = .06*(exemp + deduc)                                             
         credtx = max(0.0d0,.06*(exemp + deduc) -                               
     &   .013*max(0.d0,taxinc - ded))                                           
         retcrd = 0.                                                            
         if(data(9).gt.0) then                                                  
           crdmax = 450 * data(9)                                               
           if(mst.eq.1) then                                                    
              phase = 25000.d0                                                  
           else                                                                 
              phase = 32000.d0/sep                                              
           endif                                                                
           phsout = max(0.0d0,agi - phase)*.025                                 
           retcrd = max(0.0d0,crdmax - phsout)                                  
         endif                                                                  
         credit = credtx + retcrd                                               
         statax = max(0.0d0,statax - credit)                                    
      endif                                                                     
      return                                                                    
      end                                                                       
c                                                                               
c  VERMONT                                                                      
c  State 46                                                                     
c  Updated through 2021 (04-14-2022)                                            
c  sales and use tax credit not implemented                                     
c                                                                               
      subroutine vttax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/                                                              
     & hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,earncr,credit,rt        
      dimension data(255),comnew(255),crlw82(11,2),crlw77(11,2)                 
      double precision lowcr                                                    
      dimension yl(1986:2021),young(2000:2021),aif(2002:2008)                   
      dimension tab77(2,7),rate(1977:2000),ntab(1977:2021),tab85(2,9)           
      dimension tab87(2,4), tab86(2,5), phone(1986:2021), tab91(2,3)            
      dimension tab95(2,4), tab01s(2,5), tab01h(2,5),tab01m(2,5)                
      dimension tab98(2,4), tab02s(2,5), tab02h(2,5),tab02m(2,5)                
     &,tab09s(2,5), tab09h(2,5),tab09m(2,5)                                     
     &,tab10s(2,5), tab10h(2,5),tab10m(2,5)                                     
     &,tab18s(2,4), tab18h(2,4),tab18m(2,4)                                     
     &,erate(1988:2021)                                                         
      dimension aif10(2010:2017)                                                
      dimension tab06(2,3),xmp(2018:2021),std(2018:2021),                       
     & aif18(2018:2021),oldstd(2018:2021)                                       
      integer sep                                                               
      data aif18/1.0d0,1.024d0,1.043d0,1.058d0/                                 
      data xmp/4150.d0,4250.d0,2*4350.d0/                                       
      data oldstd/3*1000.d0,1050.d0/                                            
                                                                                
      data std/6000.d0,6200.d0,6250.d0,6350.d0/                                 
      data erate/.23d0,5*.28d0,6*.25d0,18*.32d0,4*.36d0/                        
      data aif10/1.0d0,1.015d0, 1.04d0, 1.066d0, 1.085d0, 1.1015d0,             
     &  1.107d0,1.115d0/                                                        
      data aif / 1.0d0,1.016d0, 1.04d0,1.0630d0,1.09660d0,                      
     & 1.1395348830d0,1.16457960d0/                                             
      data tab77 /                                                              
     &     4000.0d0, .040d0,  8000.0d0, .045d0, 12000.0d0, .05d0,               
     &    16000.0d0, .055d0, 20000.0d0, .060d0, 25000.0d0, .07d0,               
     &        1.e20, .0d0 /                                                     
      data tab85/                                                               
     &     4000.0d0, .035d0,  8000.0d0, .040d0, 12000.0d0, .045d0,              
     &    16000.0d0, .050d0, 20000.0d0, .055d0, 24000.0d0, .06d0 ,              
     &    28000.0d0, .065d0, 32000.0d0, .070d0,     1.e20, .0d0/                
      data tab86/                                                               
     &     4000.0d0, .035d0,  8000.0d0, .040d0, 12000.0d0, .045d0,              
     &    32000.0d0, .050d0,     1.e20, .0d0 /                                  
      data tab87/                                                               
     &     4000.0d0, .035d0,  8000.0d0, .040d0, 12000.0d0, .045d0,              
     &        1.e20, .050d0/                                                    
      data tab95/                                                               
     &     5000.0d0, .035d0, 10000.0d0, .040d0, 15000.0d0, .045d0,              
     &        1.e20, .050d0/                                                    
      data tab98/                                                               
     &     5000.0d0, .035d0, 10000.0d0, .040d0, 25000.0d0, .045d0,              
     &        1.e20, .050d0/                                                    
      data tab06/                                                               
     &    10000.0d0, .020d0, 25000.0d0, .045d0, 1.e20, .05d0/                   
      data tab01s/                                                              
     &    27050.0d0, 3.60d0, 65550.0d0,6.720d0,136750.0d0, 7.440d0,             
     &   297350.0d0, 8.64d0,     1.e20,9.50d0/                                  
      data tab01h/                                                              
     &    36250.0d0, 3.60d0, 93650.0d0,6.720d0,151650.0d0, 7.440d0,             
     &   297350.0d0, 8.64d0,     1.e20,9.50d0/                                  
      data tab01m/                                                              
     &    45200.0d0, 3.6d0 , 109250.0d0,6.720d0,166500.0d0, 7.440d0,            
     &   297350.0d0, 8.64d0, 1.e20, 9.50d0/                                     
      data tab02s/                                                              
     &    27950.0d0, 3.6d0, 67700.0d0, 7.20d0 ,141250.0d0, 8.50d0 ,             
     &   307050.0d0, 9.0d0,    1.e20 , 9.50d0/                                  
      data tab02m/                                                              
     &    46700.0d0, 3.6d0,112850.0d0, 7.20d0,171950.0d0, 8.50d0 ,              
     &   307050.0d0, 9.0d0,    1.e20 , 9.50d0/                                  
      data tab02h/                                                              
     &    37450.0d0, 3.6d0, 96700.0d0, 7.20d0,156600.0d0, 8.50d0 ,              
     &   307050.0d0, 9.0d0,    1.e20 , 9.50d0/                                  
      data tab09s/                                                              
     &    33950.0d0, 3.55d0, 82250.0d0,7.0d0, 171550.0d0, 8.250d0,              
     &   372950.0d0, 8.90d0,    1.e20 ,9.4d0/                                   
      data tab09m/                                                              
     &    56700.0d0, 3.55d0,137050.0d0,7.0d0, 208850.0d0, 8.250d0,              
     &   372950.0d0, 8.90d0,    1.e20 ,9.4d0/                                   
      data tab09h/ 45500.d0, 3.55d0,117450.d0,7.d0  ,190200.d0, 8.25d0,         
     &            372950.d0, 8.9d0 , 1.e20 ,9.4d0/                              
      data tab10s/ 34000.d0, 3.55d0, 82400.d0,6.8d0 ,171850.d0, 7.8d0,          
     &            373650.d0, 8.8d0 , 1.e20 ,8.95d0/                             
      data tab10m/ 56800.d0, 3.55d0,137300.d0,6.8d0 ,209250.d0, 7.8d0,          
     &            373650.d0, 8.8d0 , 1.e20 ,8.95d0/                             
      data tab10h/ 45550.d0, 3.55d0,117650.d0,6.8d0 ,190550.d0, 7.8d0,          
     &            373650.d0, 8.8d0 , 1.e20 ,8.95d0/                             
      data tab18s/ 38700.d0, 3.35d0, 93700.d0,6.6d0 ,195450.d0, 7.6d0,          
     &            1.e20 ,8.75d0/                                                
      data tab18m/ 64600.d0, 3.35d0,156150.d0,6.6d0 ,237950.d0, 7.6d0,          
     &            1.e20 ,8.75d0/                                                
      data tab18h/ 51850.d0, 3.35d0,133850.d0,6.6d0 ,216700.d0, 7.6d0,          
     &            1.e20 ,8.75d0/                                                
c The Vermont legislature reduced each of the income tax rates in               
c the 2009 session, retroactive to January 1,2009                               
c rates:    3.55%,7%,8.25%,8.9%,9.4%                                            
c brackets:  0.,33950.,82250.,171550.,372950.                                   
      data rate/                                                                
     &   2*.25d0,3*.23d0,  .24d0, 2*.26d0, 2*.265d0, .258d0, .23d0,             
     &   2*.25d0,3*.28d0,6*.25d0,   .24d0 /                                     
      data ntab/ 6*6, 2*7, 9, 5, 19*4,16*3/                                     
      data phone/72.d0,2*86.4d0,9*108.d0,4*126.d0,156.d0,4*162.d0,              
     &        5*156.d0,10*111.d0/                                               
      data tab91/3400.d0,28.d0,13100.d0,31.d0,1.e20,34.d0/                      
      data yl/ 4*13000.0d0,14735.0d0,2*15096.0d0,16500.0d0,  17200.0d0,         
     &           17553.0d0,18130.0d0,  18568.0d0,18988.0d0,  19408.0d0,         
     &           19688.0d0,20318.0d0,  20895.0d0,21210.0d0,  21858.0d0,         
     &           22453.0d0,23100.0d0,  23958.0d0,24500.0d0,2*25498.0d0,         
     &           25743.0d0,26478.0d0,  27143.0d0,27528.0d0,2*27898.0d0,         
     &           5*28035.0d0/                                                   
      data young/16875.0d0,17415.0d0,17910.0d0,18180.0d0,  18735.0d0,           
     &           19245.0d0,19800.0d0,20535.0d0,21000.0d0,2*21855.0d0,           
     &           22065.0d0,22695.0d0,23265.0d0,23596.0d0,2*23895.0d0,           
     &           5*24030.0d0/                                                   
      data crlw82/ 52.0d0, 1.0d0,  68.0d0, .90d0,  84.0d0, .80d0,               
     &             99.0d0, .70d0, 115.0d0, .60d0, 130.0d0, .50d0,               
     &            145.0d0, .40d0, 162.0d0, .30d0, 178.0d0, .20d0,               
     &            195.0d0, .10d0,   1.e20, .0d0/                                
      data crlw77/ 50.0d0, 1.0d0,  65.0d0, .90d0,  80.0d0, .80d0,               
     &             95.0d0, .70d0, 110.0d0, .60d0, 125.0d0, .50d0,               
     &            140.0d0, .40d0, 155.0d0, .30d0, 170.0d0, .20d0,               
     &            185.0d0, .10d0,   1.e20, .0d0/                                
c                                                                               
      mst = int(data(2))                                                             
      agi = comnew(2)                                                           
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rt = 0.                                                                   
      if(law.le.2000) then                                                      
       taxinc = max(0.0d0,comnew(28)+comnew(70)+data(39)+data(42)-              
     & comnew(53)- comnew(54)-data(33))                                         
      else if(law.ge.2001.and.law.le.2017) then                                 
c 2001-2017                                                                     
       taxinc=comnew(29)                                                        
       if(law.ge.2002.and.law.le.2007)                                          
     &  taxinc = max(0.0d0,taxinc - .4*max(0.0d0,comnew(6)))                    
c The capital gains exclusion allowed for tax year 2008 is the smaller of       
c 40% of the gain or 40% of the Federal taxable income                          
       if(law.eq.2008.or.law.eq.2009)  taxinc =                                 
     &  max(0.0d0,taxinc - .4*min(max(0.0d0,comnew(6)),comnew(29)))             
       if(law.eq.2010) taxinc =  max(0.0d0,taxinc -                             
     &    min(.4*comnew(29),min(2500.0d0,max(0.0d0,comnew(6)))))                
       if(law.ge.2011) then                                                     
         dflat = min(5000.0d0,max(0.0d0,comnew(6)))                             
c        dperc = .4*max(0.0d0,comnew(6))                                        
         dperc = 0.                                                             
         dgain = max(dflat,dperc)                                               
         taxinc =  max(0.0d0,taxinc - min(.4*comnew(29),dgain))                 
       endif                                                                    
       if(comnew(26).gt.0.d0.and.law.ge.2015) then                              
c 2015-7 state income tax addback                                               
         addd50 = min(comnew(24) - comnew(3),data(50))                          
         taxinc = taxinc + addd50                                               
c 2015-7 addback of itemized deductions comnew(177) = comnew(3)                 
         addit = max(0.d0,                                                      
     &    max(0.0d0,comnew(24) - (comnew(20)+comnew(23)+data(50)))-             
     &    2.5*comnew(177))                                                      
          taxinc = taxinc + addit                                               
       endif                                                                    
c 2017 subtraction -- taxable refunds of state and local income taxes           
       if(law.eq.2017) taxinc = max(0.d0,taxinc - data(22))                     
      else if(law.ge.2018) then                                                 
c tax calculation for 2018+                                                     
c schedule 112 adjustments capital gain exclusion                               
       dedf = min(5000.0d0,max(0.0d0,comnew(6)))                                
       dedp = .4*max(0.0d0,comnew(6))                                           
       dedg = min(.4*comnew(29),max(dedf,dedp))                                 
c ssb exempt from taxation                                                      
       exssb = 0.d0                                                             
       if(comnew(79).gt.0.d0) then                                              
         if(mst.eq.2) then                                                      
          phb = 60000.d0                                                        
         else                                                                   
          phb = 45000.d0                                                        
         endif                                                                  
         exssb = comnew(79) -                                                   
     &   min(max(0.d0,comnew(2)-phb)/10000.d0,1.d0)*comnew(79)                  
       endif                                                                    
       agi = comnew(2) - data(22) - dedg - exssb                                
c 2018+ Exemption                                                               
       exemp = xmp(law)*comnew(68)                                              
c 2018+ Standard Deduction                                                      
       stded = std(law)                                                         
       if(mst.eq.4.or.mst.eq.7) stded = stded*1.5                               
       if(mst.eq.2.or.mst.eq.5) stded = stded*2                                 
c for over 65 y.o./blind                                                        
       stded = stded + oldstd(law)*(data(9)+data(10))                           
       taxinc = max(0.d0,agi - exemp - stded)                                   
      endif                                                                     
      if(law.le.1990.or.(law.ge.1994.and.law.le.2000)) then                     
         statax = taxinc*rate(law)                                              
         rt = rate(law)*comnew(72)/100                                          
      else if(law.ge.1991.and.law.le.1993) then                                 
        call look(tab91,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)                 
      else if(law.eq.2001) then                                                 
        if(mst.eq.1) then                                                       
          call look(tab01s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)              
        else if(mst.eq.4.or.mst.eq.7) then                                      
          call look(tab01h,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)              
        else                                                                    
          taxy = taxinc*sep                                                     
          call look(tab01m,taxy,5,n,statx,1.0d00,0.0d0,rt,data)                 
          statax = statx/sep                                                    
        endif                                                                   
      else if(law.ge.2002.and.law.le.2008) then                                 
        if(mst.eq.1) then                                                       
          call look(tab02s,taxinc,5,n,statax,aif(law),0.0d0,rt,data)            
        else if(mst.eq.4.or.mst.eq.7) then                                      
          call look(tab02h,taxinc,5,n,statax,aif(law),0.0d0,rt,data)            
        else                                                                    
          taxy = taxinc*sep                                                     
          call look(tab02m,taxy,5,n,statx,aif(law),0.0d0,rt,data)               
          statax = statx/sep                                                    
        endif                                                                   
      else if(law.eq.2009) then                                                 
        if(mst.eq.1) then                                                       
          call look(tab09s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)              
        else if(mst.eq.4.or.mst.eq.7) then                                      
          call look(tab09h,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)              
        else                                                                    
          taxy = taxinc*sep                                                     
          call look(tab09m,taxy,5,n,statx,1.0d00,0.0d0,rt,data)                 
          statax = statx/sep                                                    
        endif                                                                   
      else if(law.ge.2010.and.law.le.2017) then                                 
        if(mst.eq.1) then                                                       
          call look(tab10s,taxinc,5,n,statax,aif10(law),0.0d0,rt,data)          
        else if(mst.eq.4.or.mst.eq.7) then                                      
          call look(tab10h,taxinc,5,n,statax,aif10(law),0.0d0,rt,data)          
        else                                                                    
          taxy = taxinc*sep                                                     
          call look(tab10m,taxy,5,n,statx,aif10(law),0.0d0,rt,data)             
          statax = statx/sep                                                    
        endif                                                                   
      else if(law.ge.2018) then                                                 
        if(mst.eq.1) then                                                       
          call look(tab18s,taxinc,4,n,statax,aif18(law),0.0d0,rt,data)          
        else if(mst.eq.4.or.mst.eq.7) then                                      
          call look(tab18h,taxinc,4,n,statax,aif18(law),0.0d0,rt,data)          
        else                                                                    
          taxy = taxinc*sep                                                     
          call look(tab18m,taxy,4,n,statx,aif18(law),0.0d0,rt,data)             
          statax = statx/sep                                                    
        endif                                                                   
c If c2>$150k, enter the amount that is higher:                                 
c 1) 3% of comnew(2) or                                                         
c 2) tax calculated on Vermont Taxable Income applicable rate sch               
        if(comnew(2).gt.150000.d0) statax = max(statax,.03*comnew(2))           
      endif                                                                     
                                                                                
cNon-refundable credits                                                         
c Low Income Credit looks as repealed in 1991                                   
      lowcr = 0.                                                                
      if((law.le.1990.and.law.ge.1982).and.data(159).le.7000.) then             
        lowcr = statax * tablki(crlw82,11,statax,data)                          
      else if(((law.le.1981.and.law.ge.1978).and.data(159).le.7000.).           
     &  or.(law.eq.1977.and.data(9).gt.0.and.data(159).lt.6000.))then           
        lowcr = statax * tablki(crlw77,11,statax,data)                          
      endif                                                                     
c Students who are Vermont Residents. Maximum credit is $10.                    
c The student himself must be a taxpayer                                        
c This credit looks like repealed in 1989                                       
      studcr = 0.                                                               
      if(data(105).lt.1.0d0.and.law.le.1988)studcr = min(10.0d0,statax)         
c Refundable Credits                                                            
c Homeowner or Renter Refund claim                                              
      frac = 0.                                                                 
      ptax = .2*data(160)+data(51)                                              
      pcred = 0.                                                                
      if(law.le.1984.and.data(9).gt.0.) then                                    
          frac = tablki(tab77,ntab(law),data(159),data)                         
          pcred = twn(ptax-frac*data(159),0.0d0,500.0d0)                        
      else if(law.eq.1985.and.data(9).gt.0.) then                               
          frac = tablki(tab85,ntab(law),data(159),data)                         
          pcred = twn(ptax-frac*data(159),0.0d0,750.0d0)                        
      else if(law.eq.1986.and.data(9).gt.0.) then                               
          frac = tablki(tab86,ntab(law),data(159),data)                         
          pcred = twn(ptax-frac*data(159),0.0d0,750.0d0)                        
      else if((law.ge.1987.and.law.le.1990).and.data(9).gt.0.) then             
          frac = tablki(tab87,ntab(law),data(159),data)                         
          ptax = data(51) + .24*data(160)                                       
          if(law.le.1989) then                                                  
            pcred = max(ptax-frac*data(159),0.0d0)                              
          else if(law.eq.1990)then                                              
            pcred = twn(ptax-frac*data(159),0.0d0,2000.0d0)                     
            if(data(159).ge.60001) pcred = 0.                                   
          endif                                                                 
      else if((law.ge.1991.and.law.le.1994).and.data(9).gt.0.) then             
          frac = tablki(tab87,ntab(law),data(159),data)                         
          ptax = data(51) + .20*data(160)                                       
          pcred = twn(ptax-frac*data(159),0.0d0,1350.0d0)                       
          if(data(159).gt.45000.)  pcred = 0.                                   
      else if(law.ge.1995) then                                                 
c Renter's Rebate Claim                                                         
          ptax = .21*data(160)                                                  
          vthy = data(23)+data(11)+data(12)+data(14)+data(82)+                  
     &    max(0.0d0,data(17))+max(0.0d0,comnew(6))+data(20)+data(72)+           
     &    data(91)+max(0.0d0,comnew(8))+max(0.0d0,data(21))+data(22)-           
     &    socsec(data,comnew,law)+max(0.0d0,data(12)+data(14)-10000)            
          if(law.le.1997.and.data(9).gt.0.) then                                
             frac = tablki(tab95,ntab(law),vthy,data)                           
             if(vthy.le.44000.) then                                            
                pcred = twn(ptax-frac*vthy,0.0d0,1500.0d0)                      
             else if(vthy.gt.44000..and.vthy.le.47000.)then                     
                pcred = 1500.-.5*(vthy-44000.)                                  
             endif                                                              
          else if(law.ge.1998) then                                             
c does not have to be over 62 y.o. (?) 1998+                                    
             if(law.le.2005) frac=tablki(tab98,ntab(law),vthy,data)             
             if(law.ge.2006) frac=tablki(tab06,ntab(law),vthy,data)             
             pcred = max(ptax-frac*vthy,0.0d0)                                  
          endif                                                                 
          if(vthy.gt.47000.) pcred = 0.                                         
      endif                                                                     
c old age telephone credit, for young people since 2000                         
      telcr = 0.                                                                
      if(data(9).gt.0) then                                                     
         if(law.ge.1986) then                                                   
           if(data(159).lt.yl(law)) telcr = phone(law)                          
         endif                                                                  
      else                                                                      
         if(law.ge.2000) then                                                   
           if(data(159).lt.young(law)) telcr = phone(law)                       
         endif                                                                  
      endif                                                                     
      if(data(105).gt.0.d0) telcr = 0.d0                                        
c earned income credit                                                          
      earncr = 0.                                                               
      if(law.ge.1988) earncr = erate(law)*comnew(59)                            
      chcr = 0.                                                                 
      chcref = 0.                                                               
c chcr -- non-refundable credit                                                 
c      base = min(comnew(53),max(0.0d0,comnew(52)-data(34)))                    
      base = comnew(53)                                                         
      chcr = .24* base                                                          
      if(law.ge.2003) then                                                      
c 2003+ Low-Income Child and dependent care credit (refundable)                 
        if((mst.eq.2.and.comnew(2).le.39999.d0).or.                             
     &     (mst.ne.2.and.comnew(2).le.29999.d0)) chcref = .5 * base             
        if(chcref.gt.0.d0) chcr = 0.                                            
      endif                                                                     
c 2018+ non-refundable crd 5% of the first $20k of char contr                   
      contr = 0.d0                                                              
      if(law.ge.2018) contr = .05*min(20000.d0,comnew(23))                      
      statax = max(statax-lowcr-studcr-chcr-contr,0.0d0)                        
      statax = statax - pcred  - earncr - telcr - chcref                        
      credit = lowcr+studcr+pcred+telcr+earncr+chcr+chcref+contr                
c only for Child care credit comparasing to have the amount in /calc/           
      if(chcref.gt.0) chcr = chcref                                             
      return                                                                    
      end                                                                       
c  VIRGINIA                                                                     
c  State 47                                                                     
c  Updated through 2021 (2022-04-14)                                            
      subroutine vatax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/                                                              
     & hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,earncr,credit,rt        
      dimension data(255),comnew(255)                                           
      double precision tab(2,4), most(1977:2021), socmax(1977:1994)             
c most(law) has to be updated every year                                        
      dimension aif92(1991:2012),aif13(2013:2017)                               
      dimension oldded(1977:1987), xmp(1977:2021),xph19(7),                     
     & vagis(1977:2004),vagim(1977:2004),vagi(2005:2021)                        
      dimension cli(2000:2021),cli1(2000:2021),aifded(2019:2021)                
                                                                                
      data xph19/271700.d0,326050.d0,163025.d0,298850.d0,326050.d0,             
     &  163025.d0,298850.d0/                                                    
      data aif13/1.0d0,1.0168d0,1.033d0,1.0376d0,1.046d0/                       
      data aifded/2*1.0d0,1.25d0/                                               
                                                                                
      data tab /3000.d0,2.d0,5000.d0,3.d0,0.d0,5.d0,1.e20,5.75d0/               
      data most/10*12000.d0, 14000.d0, 15000.d0, 16000.d0, 32*17000.d0/         
      data vagis/28*5000.d0/                                                    
      data vagim/28*4000.d0/                                                    
      data vagi /3*7000.d0,2*11250.d0,2*11650.d0,10*11950.d0/                   
      data socmax/                                                              
     &     4952.0d0,   5518.0d0, 6640.0d0, 6864.0d0, 8124.0d0, 9035.0d0,        
     &     8508.0d0,   8436.0d0, 8926.0d0, 9120.0d0, 9468.0d0,10056.0d0,        
     &    10788.0d0,5*11100.0d0/                                                
      data oldded/10*400.0d0, 200.0d0/                                          
      data cli /                                                                
     &     8350.0d0, 8590.0d0, 8860.0d0,   8980.0d0, 9310.0d0, 9570.0d0,        
     &     9800.0d0,10210.0d0,10400.0d0,2*10830.0d0,10890.0d0,11170.0d0,        
     &    11490.0d0,11670.0d0,11770.0d0,  11880.0d0,12060.0d0,12140.0d0,        
     &    12490.0d0,12760.0d0,12880.0d0/                                        
      data cli1/                                                                
     &     2900.0d0, 3020.0d0, 3080.0d0,   3140.0d0, 3180.0d0, 3260.0d0,        
     &     3400.0d0, 3480.0d0, 3600.0d0, 2*3740.0d0, 3820.0d0, 3960.0d0,        
     &     4020.0d0, 4060.0d0,2*4160.d0,   4180.0d0, 4320.0d0, 4420.0d0,        
     &     4480.0d0, 4540.0d0/                                                  
      data xmp/   10*600.0d0, 700.0d0, 17*800.0d0,3*900.0d0,14*930.0d0/         
      data aif92/                                                               
     &     1.0d0,  1.0525d0, 1.0845d0, 1.118d0 , 1.147d0 , 1.1795d0,            
     &  1.2120d0,  1.2450d0, 1.2660d0, 1.2895d0, 1.3295d0, 1.3730d0,            
     &  1.3950d0,  1.4270d0, 1.4595d0, 1.505d0 , 1.5640d0, 1.5995d0,            
     &  1.6680d0,2*1.6955d0, 1.7365d0/                                          
      rt = 0.                                                                   
      statax = 0.                                                               
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      phas92=100000.d0/sep                                                      
      if(law.ge.1992.and.law.le.2012)                                           
     & phas92=100000.*aif92(law)/sep                                            
      if(law.ge.2013.and.law.le.2017)                                           
     & phas92 = aif13(law)*250000*filing(mst,1.,1.2,1.1,.6)                     
c     AGI                                                                       
      agi = comnew(2)-data(22)                                                  
c Additional deduction of r400 or $200 for each "65 or over"                    
      if(law.le.1987) agi = agi-oldded(law)*data(9)                             
c Additional deduction of r200 for "blind" exemption                            
      if(law.eq.1987) agi = agi-oldded(law)*data(10)                            
c Two-earner deduction is an addition to Federal AGI                            
      if(law.ge.1982.and.law.le.1986)agi = agi+comnew(32)                       
c Social security benefits in AGI - are not taxable in Virginia                 
      if(law.ge.1984) agi = agi-comnew(79)                                      
c Unemployment Compensation Benefits are not taxable                            
      agi = agi - comnew(78)                                                    
c Who must file                                                                 
      if(law.ge.1979.and.law.le.1986) then                                      
        if(agi.lt.3000) return                                                  
      else if(law.ge.1987.and.law.le.2004) then                                 
        thres = sorm(mst,5000.0d0,8000.0d0)                                     
        if(agi.lt.thres/sep)return                                              
      else if(law.ge.2005) then                                                 
        thres = 7000.*data(7)                                                   
        if(agi.lt.thres/sep)return                                              
      endif                                                                     
c Qualifying Retirement income sutraction for 1989                              
c Age deduction for 1990 and onward                                             
      elder = 0.                                                                
      retiry = data(20)+data(72)                                                
      if(law.ge.1989.and.data(9).ge.1.) then                                    
        if(law.eq.1989) then                                                    
          if(retiry.le.16000.) then                                             
            agi = agi-twn(data(20)+data(72),0.0d0,16000.0d0)                    
          else if(retiry.ge.16001.and.retiry.le.40000) then                     
            agi = agi-twn(((64000-retiry)/6),0.0d0,7992.0d0)                    
          endif                                                                 
        endif                                                                   
        if(law.eq.1990.or.law.eq.1991)                                          
     &     elder = min(comnew(2),12000*data(9))                                 
        if(law.eq.1992) elder = min(comnew(2),12472.0d0)                        
        if(law.eq.1993.or.law.eq.1994)                                          
     &     elder = min(comnew(2),12944.*data(9))                                
        if(law.eq.1995) elder = min(comnew(2),10000.*data(9))                   
        if(law.ge.1996) elder = min(comnew(2),12000.*data(9))                   
        if(law.ge.2004) then                                                    
           if(mst.ne.2) then                                                    
              ylimit = 50000.d0                                                 
           else                                                                 
              ylimit = 75000.d0                                                 
           endif                                                                
           penagi = comnew(2)-comnew(79)                                        
           if(penagi.gt.ylimit) then                                            
             if (penagi - ylimit.gt.elder) then                                 
               elder = 0.                                                       
             else                                                               
               elder = elder - (penagi - ylimit)                                
c               if(data(9).eq.2) elder = elder/2                                
             endif                                                              
           endif                                                                
        endif                                                                   
c       agi = agi+comnew(175)-elder                                             
        agi = agi-elder                                                         
      endif                                                                     
c Standard Deductions                                                           
      if(law.le.1986) then                                                      
        stded = twn(.15*agi, 1300.d0/sep, 2000.d0/sep)                          
      else if(law.eq.1987) then                                                 
        if(mst.eq.2) then                                                       
           stded = 2000.d0                                                      
        else                                                                    
           stded = 1000.d0                                                      
        endif                                                                   
      else if(law.eq.1988) then                                                 
        if(mst.eq.2) then                                                       
           stded = 2700.d0                                                      
        else                                                                    
           stded = 1350.d0                                                      
        endif                                                                   
      else if(law.ge.1989.and.law.le.2004) then                                 
        stded = sorm(mst,3000.0d0,5000.0d0/sep)                                 
      else if(law.ge.2005.and.law.le.2018) then                                 
        stded = 3000.*data(7)                                                   
      else if(law.ge.2019) then                                                 
        stded = 4500.*data(7)                                                   
      endif                                                                     
c Itemized Deductions                                                           
      if(law.le.2017) then                                                      
        xitded = (comnew(24)-data(50))*comnew(26)                               
c     if(law.le.1978)xitded = xitded+(comnew(76)*comnew(26))                    
        ag = max(0.0d0,comnew(2))                                               
        if(comnew(26).gt.0.d0.and.(law.ge.1991.and.law.le.2017)) then           
         if(ag.ge.phas92) then                                                  
          xlin4 = max(0.0d0,data(49)-.075*ag)                                   
          xlin8 = data(50)+data(51)+data(46)                                    
          xlin11 = data(53)                                                     
          xlin12 = data(56)+data(53)+data(57)                                   
          xlin16 = data(58)+data(59)+data(60)                                   
          xlin17 = max(0.0d0,data(61)-.1*ag)                                    
          xlin18 = data(26)                                                     
          xlin24 = max(data(27)+data(63)-.02*ag,0.0d0)                          
          xlin25 = data(66)                                                     
          xtot = xlin4+xlin8+xlin12+xlin16+xlin17+xlin18+xlin24+                
     &     xlin25                                                               
          xdiff = xtot-xlin4-xlin11-xlin17                                      
          if(xdiff.gt.0.) then                                                  
            xdiff2 = ag - phas92                                                
            if(xdiff2.gt.0.) then                                               
              xconst = min(.8*xdiff,.03*xdiff2)                                 
              xlin26 = xtot-xconst                                              
              xprop = (xdiff-(xtot-xlin26))/xdiff                               
              tx = xprop*data(50)                                               
              xitded = max(0.d0,comnew(24)-tx)                                  
            endif                                                               
          endif                                                                 
         endif                                                                  
        endif                                                                   
      endif                                                                     
      if(law.eq.2018.and.comnew(26).gt.0.d0) then                               
        sttax = min(10000.d0/sep,data(51)+data(50)+data(54))                    
        stt = min(data(50),sttax - (data(51)+data(54)))                         
        xitded = comnew(30) - stt                                               
      else if(law.ge.2019.and.comnew(26).gt.0.d0) then                          
         deduc1 = comnew(23)+ data(50)+ data(51)+data(54) + data(56)+           
     &   comnew(97)+data(66)                                                    
c Casuaty or Theft Losses                                                       
         casu = max(0.0d0,data(61)-100.)                                        
         agix = max(0.0d0,agi)                                                  
         casu = max(0.0d0,casu-.1*agix)                                         
         deduc2 = casu+comnew(20)+data(53)                                      
         xitded = deduc1 + deduc2                                               
c         write(0,*) '1 xitded ',xitded                                         
                                                                                
         if(comnew(2).gt.xph19(mst)*aifded(law)) then                           
c item ded for 2019 limitation code.please test. Inna 04.20.2020                
            dlim1 = .03*(comnew(2)-xph19(mst))                                  
            sttax = min(10000.d0/sep,data(50))                                  
            deduc11 = deduc1 - data(50)+ sttax                                  
            dlim2 = .8*max(0.0d0,deduc11)                                       
c 2019 itemized deductions may be limited                                       
            dedphs = min(dlim1,dlim2)                                           
            xitded = xitded - dedphs                                            
            if(deduc1.gt.0.0d0) then                                            
               perc = max(0.0d0,min(1.d0,dedphs/deduc1))                        
               ded50 = sttax*(1-perc)                                           
               xitded = xitded - ded50                                          
            endif                                                               
         else                                                                   
            xitded = xitded -data(50)                                           
         endif                                                                  
c          write(0,*) '2 xitded ',xitded                                        
                                                                                
      endif                                                                     
c Child and Dependent Care expenses                                             
      child = 0.                                                                
      if(law.ge.1979.and.law.le.1982) then                                      
         child = min(data(64),min(data(8),2.0d0)*2000.)                         
      else if(law.gt.1982.and.law.le.2002) then                                 
         child = min(data(64),min(data(8),2.0d0)*2400.)                         
      else if(law.gt.2003) then                                                 
         child = min(data(64),min(data(8),2.0d0)*3000.)                         
      endif                                                                     
      ided = int(data(4))                                                            
      if(ided.eq.-2.and.law.eq.1999) xitded=0                                   
      deduc = max(stded,xitded)+child                                           
c Exemptions                                                                    
      if(law.le.2004) then                                                      
       exemp = (data(7)+data(8)+data(9)+data(10))*xmp(law)                      
      else                                                                      
       exemp = (data(7)+data(8))*xmp(law)+(data(9)+data(10))*800.               
      endif                                                                     
c Taxable Income                                                                
      taxinc = max(0.0d0,agi - deduc - exemp)                                   
c      write(0,*) 'taxinc agi deduc exemp',taxinc,agi,deduc,exemp               
                                                                                
c Calculation of State Tax                                                      
      tab(1,3) = most(law)                                                      
      call look(tab,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)                     
      if(mst.eq.2) then                                                         
        agimod  = agi - data(11)                                                
        agiw = .5*agimod + data(86)                                             
        agih = agi-agiw                                                         
      endif                                                                     
      if(mst.eq.2.and.law.le.1999.and.agi.gt.0) then                            
c for separate returns , filed combined                                         
        xitdh=0.                                                                
        xitdw=0.                                                                
        if(xitded.gt.0) then                                                    
c         xitdh= xitded*agih/agi                                                
         xitdw= xitded*agiw/agi                                                 
         xitdh = xitded - xitdw                                                 
        endif                                                                   
c        dedh=stded*agih/agi                                                    
        dedw = stded*agiw/agi                                                   
        dedh = stded - dedw                                                     
c        exempw = xmp(law)                                                      
        exempw = exemp*agiw/agi                                                 
        exemph = exemp - exempw                                                 
        if(xitded.gt.stded) then                                                
         dedh=xitdh                                                             
         dedw=xitdw                                                             
        endif                                                                   
        taxyw = max(0.0d0,agiw-dedw-exempw)                                     
c        taxyh=max(0.0d0,agih-dedh-exemph)                                      
        taxyh = taxinc - taxyw                                                  
        call look2(tab,taxyh,4,n,taxh,1.0d0,0.0d0,rt,data)                      
        call look2(tab,taxyw,4,n,taxw,1.0d0,0.0d0,rt,data)                      
        statax=min(statax,taxh+taxw)                                            
      endif                                                                     
c      write(0,*) 'statax',statax                                               
c Virginia AGI filing threshold                                                 
      if(law.le.2004) then                                                      
         if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                              
            if(agi.le.vagis(law)) statax = 0.                                   
         else                                                                   
            if(agi.le.vagim(law)*data(7)) statax = 0.                           
         endif                                                                  
      else                                                                      
         if(agi.le.vagi(law)*data(7)) statax= 0.                                
      endif                                                                     
c CREDITS!!!                                                                    
      credit = 0.                                                               
      twocrd = 0.                                                               
c Spouse Tax Adjustment since 2000                                              
c Taxpayer's and spouse AGI have proportions .696:.304                          
      if(law.ge.2000.and.taxinc.gt.3000.and.mst.eq.2) then                      
         othinc = data(12)+data(14)+max(0.0d0,data(17))+comnew(6)+              
     &   data(20)+data(72)+max(0.0d0,comnew(8))+comnew(79)+                     
     &   max(0.0d0,data(21))-.5*comnew(175)                                     
         wife = data(211)+data(212)+data(86) + .5*othinc                        
         husb = data(214)+data(215)+data(85) + .5*othinc                        
         wife = min(wife,husb)                                                  
c Age deduction                                                                 
         agedw = 0.                                                             
         nagew = 0                                                              
         nbliw = 0                                                              
         if(data(9).gt.0) then                                                  
            agedw = 12000.                                                      
            nagew = 1                                                           
         endif                                                                  
         if(data(10).gt.0) nbliw = 1                                            
         taxy23 = max(0.0d0,wife - agedw -.5*comnew(79)-xmp(law)-               
     &   800*(nagew+nbliw))                                                     
         taxy24 = max(0.0d0,taxinc - taxy23)                                    
         taxy25 = taxinc/2                                                      
         taxy26 = min(taxy23,taxy25)                                            
         call look(tab,taxy26,4,n,stat26,1.0d00,0.0d0,rt,data)                  
         taxy27 = max(taxy24,taxy25)                                            
         call look(tab,taxy27,4,n,stat27,1.0d00,0.0d0,rt,data)                  
         twocrd = max(0.d0,statax - stat26 - stat27)                            
         twocrd = min(259.d0,twocrd)                                            
         statax = max(0.d0,statax - twocrd)                                     
      endif                                                                     
c      write(0,*) 'statax twocrd',statax,twocrd                                 
c -- Old Age Credit  was repealed in 1990                                       
      ocred = 0.                                                                
      if(law.le.1989) then                                                      
        resid = max(0.0d0,agi-12000)                                            
        bens = comnew(84)                                                       
        ocred = .05*(max(0.0d0,((socmax(law)*data(9))-bens -resid*2.)))         
        if(law.eq.1989.and.retiry.ge.2000)  ocred = 0.                          
      endif                                                                     
c -- Energy credit for 1983-1986                                                
      encred = 0.                                                               
      if(law.ge.1983.and.law.le.1986) then                                      
        encred = min(data(38)*.6,1000.0d0)                                      
      endif                                                                     
      crlow = 0.                                                                
      earncr = 0.                                                               
c Credit for low income individuals since 2000                                  
      if(law.ge.2000) then                                                      
        if(agi.le.cli(law)+(data(8)+data(7)-1)*cli1(law))                       
     & crlow = 300.* (data(8)+data(7))                                          
        if(law.ge.2006)  then                                                   
          earncr = .2*comnew(59)                                                
          crlow = max(earncr,crlow)                                             
        endif                                                                   
c Low-Income Individuals: You cannot claim the 65 or older or Blind exemptions  
c if you also claimed a Credit for Low-Income Individuals on Line 24 of Form 760
        if(elder.gt.0.d0) crlow = 0.d0                                          
        crlow = min(statax,crlow)                                               
        statax = statax - crlow                                                 
c       write(0,*) 'statax crlow',statax,crlow                                  
      endif                                                                     
      statax = max(statax - ocred - encred,0.0d0)                               
      credit = ocred + encred + twocrd + crlow                                  
      return                                                                    
      end                                                                       
c  WEST VIRGINIA                                                               
c  State 49                                                                    
c  Updated through 2021 (04-14-2022)                                           
      subroutine wvtax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      integer sep                                                               
      common/calc/                                                              
     & hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,earncr,credit,rt        
      dimension data(255),comnew(255)                                           
c      dimension altmin(1977:1998)                                              
      dimension tab77(2,24),tab83h(2,24),tab83(2,24)                            
      dimension tab84(2,17),tab84h(2,18)                                        
      dimension tab87(2,5)                                                      
      dimension xmp(1977:2021),surtax(1983:1985),ssperc(2020:2021)              
     &,pbase(2008:2021),pdep(2008:2021)                                         
      dimension fcp1(2007:2021)                                                 
      dimension fcp2(2007:2021)                                                 
      dimension fcp3(2007:2021)                                                 
      dimension fcp4(2007:2021)                                                 
      dimension fcp5(2007:2021)                                                 
      dimension fcp6(2007:2021)                                                 
      dimension fcp7(2007:2021)                                                 
      dimension fcp8(2007:2021)                                                 
      data ssperc/.35d0,.65d0/                                                  
      data pbase /                                                              
     &    15600.d0, 2*16245.d0, 16335.d0,33510.d0,34470.d0,35010.d0,            
     &    35310.d0,  35640.d0,  36180.d0,36420.d0,37470.d0,38280.d0,            
     &    38649.d0/                                                             
      data pdep /                                                               
     &    5400.d0, 2*5610.d0, 5730.d0,11880.d0,12060.d0,12180.d0,               
     &    12480.d0,  12420.d0, 12540.d0,12960.d0,13260.d0,13440.d0,             
     &    13620.d0/                                                             
      data fcp1/10210.0d0,10400.0d0,2*10830.0d0,10890.0d0,11170.0d0,            
     &          11490.0d0,11670.0d0,  11770.0d0,11880.0d0,12060.0d0,            
     &          12140.0d0,12490.0d0,  12760.0d0, 12880.d0/                      
      data fcp2/13690.0d0,14000.0d0,2*14570.0d0,14710.0d0,15130.0d0,            
     &          15510.0d0,15730.0d0,  15930.0d0,16020.0d0,16240.0d0,            
     &          16460.0d0,16910.0d0,2* 17240.0d0/                               
      data fcp3/17170.0d0,17600.0d0,2*18310.0d0,18530.0d0,19090.0d0,            
     &          19530.0d0,19790.0d0,  20090.0d0,20160.0d0,20420.0d0,            
     &          20780.0d0,21330.0d0,  21720.0d0,21960.0d0/                      
      data fcp4/20650.0d0,21200.0d0,2*22050.0d0,22350.0d0,23050.0d0,            
     &          23550.0d0,23850.0d0,  24250.0d0,24300.0d0,24600.0d0,            
     &          25100.0d0,25750.0d0,  26200.0d0,26500.0d0/                      
      data fcp5/24130.0d0,24800.0d0,2*25790.0d0,28170.0d0,27010.0d0,            
     &          27570.0d0,27910.0d0,  28410.0d0,28440.0d0,28780.0d0,            
     &          29420.0d0,30170.0d0,  30680.0d0,31040.0d0/                      
      data fcp6/27610.0d0,28400.0d0,2*29530.0d0,29990.0d0,30970.0d0,            
     &          31590.0d0,31970.0d0,  32570.0d0,32580.0d0,32960.0d0,            
     &          33740.0d0,34590.0d0,  35160.0d0,35580.0d0/                      
      data fcp7/31090.0d0,32000.0d0,2*33270.0d0,33810.0d0,34930.0d0,            
     &          35610.0d0,36030.0d0,2*36730.0d0,37140.0d0,38060.0d0,            
     &          39010.0d0,39640.0d0,  40120.0d0/                                
      data fcp8/34570.0d0,35600.0d0,2*37010.0d0,37630.0d0,38890.0d0,            
     &          39630.0d0,40090.0d0,2*40890.0d0,41320.0d0,42380.0d0,            
     &          43430.0d0,44120.0d0,  44660.0d0/                                
      data tab77/                                                               
     &      2000.0d0,  2.10d0,   4000.0d0,  2.3d0,  6000.0d0,  2.8d0,           
     2      8000.0d0,  3.20d0,  10000.0d0,  3.5d0, 12000.0d0,  4.0d0,           
     3     14000.0d0,  4.60d0,  16000.0d0,  4.9d0, 18000.0d0,  5.3d0,           
     4     20000.0d0,  5.40d0,  22000.0d0,  6.0d0, 26000.0d0,  6.1d0,           
     5     32000.0d0,  6.50d0,  38000.0d0,  6.8d0, 44000.0d0,  7.2d0,           
     6     50000.0d0,  7.50d0,  60000.0d0,  7.9d0, 70000.0d0,  8.2d0,           
     7     80000.0d0,  8.60d0,  90000.0d0,  8.8d0,100000.0d0,  9.1d0,           
     8    150000.0d0,  9.30d0, 200000.0d0,  9.5d0,     1.e20,  9.6d0 /          
      data tab83/                                                               
     &      2000.0d0,  2.10d0 ,  4000.0d0,  2.3d0  ,  6000.0d0, 2.80d0,         
     &      8000.0d0,  3.20d0 , 10000.0d0,  3.5d0  , 12000.0d0, 4.00d0,         
     &     14000.0d0,  5.12d0 , 16000.0d0,  5.65d0 , 18000.0d0, 6.42d0,         
     &     20000.0d0,  6.90d0 , 22000.0d0,  7.65d0 , 26000.0d0, 8.42d0,         
     &     32000.0d0,  9.50d0 , 38000.0d0, 10.40d0 , 44000.0d0,11.25d0,         
     &     50000.0d0, 11.55d0 , 60000.0d0, 11.65d0 , 70000.0d0,11.80d0,         
     &     80000.0d0, 11.90d0 , 90000.0d0, 11.95d0 ,100000.0d0,12.02d0,         
     &    150000.0d0, 12.025d0,200000.0d0, 12.125d0,     1.e20,12.15d0/         
      data tab83h/                                                              
     7      2000.0d0, 2.10d0 ,   4000.0d0,  2.30d0 ,  6000.0d0, 2.80d0,         
     &      8000.0d0, 3.20d0 ,  10000.0d0,  3.50d0 , 12000.0d0, 3.85d0,         
     &     14000.0d0, 4.67d0 ,  16000.0d0,  5.20d0 , 18000.0d0, 5.90d0,         
     &     20000.0d0, 6.30d0 ,  22000.0d0,  7.05d0 , 26000.0d0, 7.67d0,         
     &     32000.0d0, 8.75d0 ,  38000.0d0,  9.50d0 , 44000.0d0,10.35d0,         
     &     50000.0d0,10.57d0 ,  60000.0d0, 10.67d0 , 70000.0d0,10.82d0,         
     &     80000.0d0,11.90d0 ,  90000.0d0, 11.95d0 ,100000.0d0,12.02d0,         
     &    150000.0d0,12.025d0, 200000.0d0, 12.125d0,     1.e20,12.15d0/         
      data tab84/                                                               
     &      2000.0d0, 2.10d0 ,   4000.0d0,  2.30d0 ,  6000.0d0, 2.8d0,          
     &      8000.0d0, 3.20d0 ,  10000.0d0,  3.50d0 , 12000.0d0, 4.0d0,          
     &     14000.0d0, 5.30d0 ,  16000.0d0,  5.90d0 , 18000.0d0, 6.8d0,          
     &     20000.0d0, 7.40d0 ,  22000.0d0,  8.20d0 , 26000.0d0, 9.2d0,          
     &     32000.0d0,10.50d0 ,  38000.0d0, 11.60d0 , 44000.0d0,12.6d0,          
     &     60000.0d0,12.90d0 ,      1.e20, 13.0d0/                              
      data tab84h/                                                              
     &      2000.0d0, 2.10d0 ,   4000.0d0,  2.30d0 , 6000.0d0, 2.8d0,           
     &      8000.0d0, 3.20d0 ,  10000.0d0,  3.50d0 ,12000.0d0, 3.8d0,           
     &     14000.0d0, 4.70d0 ,  16000.0d0,  5.30d0 ,18000.0d0, 6.1d0,           
     &     20000.0d0, 6.60d0 ,  22000.0d0,  7.40d0 ,26000.0d0, 8.2d0,           
     &     32000.0d0, 9.50d0 ,  38000.0d0, 10.40d0 ,44000.0d0,11.4d0,           
     &     60000.0d0,11.60d0 ,  70000.0d0, 11.70d0 ,    1.e20,13.0d0/           
      data tab87/                                                               
     &     10000.0d0,  3.0d0 ,  25000.0d0,  4.0d0  ,40000.0d0,  4.5d0,          
     &     60000.0d0,  6.0d0 ,      1.e20,  6.5d0/                              
      data xmp   /6*600.0d0,700.0d0,3*800.0d0,35*2000.0d0/                      
      data surtax/ 1.090d0, 1.120d0, 1.060d0/                                   
c      data altmin/6*.0d0, .1875d0, 15*.25d0/                                   
      mst = int(data(2))                                                             
      sep = 1                                                                   
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
      rt = 0.                                                                   
c     AGI                                                                       
      agi = comnew(2)                                                           
c 2earner deduc                                                                 
      if(law.ge.1982.and.law.le.1986)agi = agi+comnew(32)                       
c State Income Tax Refund                                                       
      if(law.ge.1984)agi = agi-data(22)                                         
c ssagi are exempt from state income tax 1984-1986 years only                   
      if(law.ge.1984.and.law.le.1986)agi = agi-comnew(79)                       
      if(law.ge.2020.and.comnew(2).le.50000.d0*data(7)) then                    
         agi = agi - ssperc(law)*comnew(79)                                     
      endif                                                                     
c Senior citizen or disability deduction                                        
      oldded = 0.                                                               
      nold = int(data(9))                                                            
      ti = comnew(65) + comnew(79)                                              
      if(nold.eq.1) then                                                        
         oldded = min(comnew(65),8000.0d0)                                      
c Married couple and only one person is elderly                                 
         if(mst.eq.2) then                                                      
c Consider ssagi is for wife                                                    
           ti50c = 0.                                                           
           tiw = .5*(ti-data(85)-comnew(79))+comnew(79)+data(20)                
           ti50a = tiw + data(86) - ti50c                                       
           ti50b = 8000.                                                        
           ti50d = max(0.0d0,ti50b - ti50c)                                     
           oldded = min(ti50a,ti50d)                                            
         endif                                                                  
      else if (nold.eq.2) then                                                  
         ti50c = 0.                                                             
         timod  = ti - data(11)                                                 
         ti50ah = .5*timod + data(85)- ti50c                                    
         ti50aw = .5*timod + data(86)- ti50c                                    
         ti50b = 8000.                                                          
         ti50d = max(0.0d0,ti50b - ti50c)                                       
         oldded =min(ti50ah,ti50d) + min(ti50aw,ti50d)                          
      endif                                                                     
c disable people                                                                
      if(nold.eq.0.and.comnew(79).gt.0.and.                                     
     & (law.le.1983.and.law.ge.1987)) then                                      
        if(mst.ne.2) then                                                       
          oldded = min(agi,8000.0d0)                                            
        else                                                                    
          agimod = agi - data(11) - comnew(79)                                  
          agih = .5*agimod + data(85) + .5*comnew(79)                           
          agiw = .5*agimod + data(86) + .5*comnew(79)                           
          oldded = min(agih,8000.0d0)+min(agiw,8000.0d0)                        
        endif                                                                   
      endif                                                                     
      agi = max(0.0d0,agi - oldded)                                             
c The standard deduction as well as all itemized deductions have                
c been eliminated since 1987                                                    
c --  Standard Deduction                                                        
      if(law.le.1986) then                                                      
        stded = min(.1*max(0.0d0,agi), 1000.0d0)                                
      else if(law.ge.1987) then                                                 
        stded=0.                                                                
      endif                                                                     
c -- Itemized Deductions                                                        
      if(law.le.1986) then                                                      
c     deduc,other stat&loc tax ,flad for itmzd deduc                            
        xitded=(comnew(24)-data(55))*comnew(26)                                 
      else if(law.ge.1987) then                                                 
        xitded=0.                                                               
      endif                                                                     
      deduc =max(stded,xitded)                                                  
c --                                                                            
c Exemptions                                                                    
      exemp = comnew(68)*xmp(law)                                               
      if(law.ge.1987.and.mst.eq.5) exemp = exemp + xmp(law)                     
      if(law.ge.1987.and.data(105).gt.0.0d0)exemp=500.                          
c Taxable Income                                                                
      taxinc = max(0.0d0,agi - deduc - exemp)                                   
                                                                                
c Low Income Earned Income Exclusion - NEW in 1997                              
      if(law.ge.1997.and.comnew(2).le.10000.d0/sep)                             
     &  taxinc = max(0.0d0,taxinc - min(10000.d0/sep,comnew(37)))               
c      writE(0,*) 'agi deduc exemp taxinc',agi,deduc,exemp,taxinc               
c State Tax Calculation                                                         
      taxy = taxinc                                                             
      if(mst.eq.2.or.mst.eq.5)taxy=taxinc/2.                                    
      if(law.le.1982) then                                                      
        call look(tab77,taxy,24,n,statax,1.0d00,0.0d0,rt,data)                  
        if(mst.eq.2.or.mst.eq.5)statax=statax*2.                                
      else if(law.eq.1983) then                                                 
        if(mst.ne.4.and.mst.ne.7) then                                          
          call look(tab83,taxy,24,n,statax,1.0d00,0.0d0,rt,data)                
          if(mst.eq.2.or.mst.eq.5)statax=statax*2.                              
        else if(mst.eq.4.or.mst.eq.7) then                                      
          call look(tab83h,taxy,24,n,statax,1.0d00,0.0d0,rt,data)               
        endif                                                                   
      else if(law.ge.1984.and.law.le.1986) then                                 
        if(mst.ne.4.and.mst.ne.7) then                                          
          call look(tab84,taxy,17,n,statax,1.0d00,0.0d0,rt,data)                
          if(mst.eq.2.or.mst.eq.5)statax=statax*2.                              
        else if(mst.eq.4.or.mst.eq.7) then                                      
          call look(tab84h,taxy,17,n,statax,1.0d00,0.0d0,rt,data)               
        endif                                                                   
      else if(law.ge.1987) then                                                 
        taxy=taxinc*sep                                                         
        call look(tab87,taxy,5,n,stat,1.0d00,0.0d0,rt,data)                     
        statax = stat/sep                                                       
      endif                                                                     
c      writE(0,*) 'taxbc',statax                                                
c-- Surtax  --                                                                  
      if(law.ge.1983.and.law.le.1985) then                                      
        if(taxinc.gt.10000.*data(7)) statax=surtax(law)*statax                  
      endif                                                                     
      credit=0.                                                                 
      pcred =0.                                                                 
      famcrd =0.                                                                
c Family Tax Credit is a new credit in 2007                                     
      nexemp = int(comnew(68))                                                       
      if(statax.gt.0.and.law.ge.2007.and.nexemp.gt.0) then                      
        if(nexemp.eq.1) fcp = fcp1(law)/sep                                     
        if(nexemp.eq.2) fcp = fcp2(law)/sep                                     
        if(nexemp.eq.3) fcp = fcp3(law)/sep                                     
        if(nexemp.eq.4) fcp = fcp4(law)/sep                                     
        if(nexemp.eq.5) fcp = fcp5(law)/sep                                     
        if(nexemp.eq.6) fcp = fcp6(law)/sep                                     
        if(nexemp.eq.7) fcp = fcp7(law)/sep                                     
        if(nexemp.ge.8) fcp = fcp8(law)/sep                                     
        if(agi.le.fcp) then                                                     
           if(law.eq.2007)famcrd = .5*statax                                    
           if(law.ge.2008)famcrd = statax                                       
        endif                                                                   
        if(law.eq.2007.and.agi.gt.fcp) then                                     
          perc = .01*max(0.0d0,50-5*(agi-fcp)/(300.d0/sep))                     
          famcrd = perc * statax                                                
        else if(law.ge.2008.and.agi.gt.fcp) then  
          perc = .01*max(0.0d0,100-10*(agi-fcp)/(300.d0/sep))  
          famcrd = perc * statax
        endif                                                                   
        if(data(105).gt.0.d0) famcrd = 0.d0                                     
        statax = max(0.d0,statax - famcrd)                                      
      endif                                                                     
c 2008+  Homestead Excess Property tax credit (refundable)                      
      if(law.ge.2008) then                                                      
        xlin4 = comnew(2) + data(91) - comnew(79)                               
        pagi = pbase(law)+data(8)*pdep(law)                                     
        if(mst.eq.2) pagi = pagi + pdep(law)                                    
        if(comnew(2).lt.pagi)                                                   
     &  pcred = min(1000.0d0,max(0.0d0,data(51) - .04*xlin4))                   
      endif                                                                     
      statax = statax - pcred                                                   
      credit = credit + famcrd + pcred                                          
      return                                                                    
      end                                                                       
c  WISCONSIN                                                                    
c  State 50                                                                     
c                                                                               
c   Updated through 2021 (updated 03/07/2022)                                   
      subroutine witax(data,comnew,statax,law)                                  
      implicit double precision (A-H,O-Z)                                       
      common/calc/                                                              
     & hy,rent,agi,exemp,stded,xitded,taxinc,pcred,chcr,earncr,credit,rt        
      real inrst                                                                
      integer sep                                                               
      dimension data(255),comnew(255)                                           
c     tab names denote /S ingle or M arried/,/# of people over 65/,             
c       and the /year/                                                          
      double precision s077(8,11),s177(5,14)                                    
      double precision m077(9,17),m177(5,21),m277(9,17)                         
      dimension s079(3,10),s179(3,14)                                           
      double precision m079(3,12),m179(3,15),m279(3,19),lowinc                  
      dimension dept77(2,7), dept79(2,9), aif(1979:1985),                       
     &chexp(2011:2021),tuiexp(1998:2021),aiftui(1998:2021)                      
      double precision ltg(1977:2021),iratax                                    
      dimension ex(2000:2021),exold(2000:2021),aif01(2001:2004)                 
c     real farmreg(2,9), farmsep(2,9)                                           
      dimension tabj87(2,3),tabp87(2,3),tabs87(2,3)                             
      dimension tabj98(2,3),tabp98(2,3),tabs98(2,3),aif98(1998:1999)            
      dimension tab77(2,15),tab79(2,8)                                          
      dimension tabj86(2,4),tabp86(2,4),tabs86(2,4)                             
      dimension tab(2,8), tb2(2,26)                                             
      dimension tab00s(2,5), tab00j(2,5),tab00n(2,5)                            
      dimension tab01s(2,4), tab01j(2,5),tab01n(2,5)                            
      dimension tab05s(2,4), tab05j(2,4)                                        
      dimension tab06s(2,4), tab06j(2,4)                                        
      dimension tab07s(2,6), tab07j(2,6)                                        
      dimension tab08s(2,5), tab08j(2,5)                                        
      dimension tab09s(2,5), tab09j(2,5)                                        
      dimension tab13s(2,4), tab13j(2,4)                                        
      dimension tab14s(2,4), tab14j(2,4),aif14(2014:2018)                       
      dimension tab19s(2,4), tab19j(2,4)                                        
      dimension tab20s(2,4), tab20j(2,4)                                        
      dimension tab21s(2,4), tab21j(2,4)                                        
                                                                                
                                                                                
      dimension reach(1979:2021), teach(1979:2021), rmax(1979:2021)             
      dimension aifst(2000:2021),alms(1987:2018),almm(1987:2018),               
     &almphs(1987:2018),almphm(1987:2018)                                       
      data tuiexp/7*3000.0d0,4244.0d0,4536.0d0,4843.0d0,5114.0d0,               
     & 2*6000.0d0,6185.0d0,6543.0d0,6943.0d0,6940.0d0,2*6943.0d0,               
     &   6958.0d0,2*6974.d0,6972.d0,6973.d0/                                    
      data aiftui/15*1.0d0,1.017d0,1.0324d0,1.05d0,1.052d0,1.0632d0,            
     &            1.0838d0,1.113d0, 1.1324d0, 1.1473d0/                         
      data chexp/750.0d0,1500.0d0,2250.0d0,8*3000.0d0/                          
      data aif98/1.0d0,1.016d0/                                                 
      data aif14/1.0d0,1.017d0,1.019d0,1.03d0,1.05d0/                           
      data aif19/1.0d0/                                                         
c Standard deduction table                                                      
      data aifst/                                                               
     &       1.0d0, 1.03d0, 1.062d0, 1.082d0, 1.104d0, 1.134d0,                 
     &     1.175d0, 1.22d0, 1.244d0, 1.311d0, 1.292d0, 1.307d0,                 
     &     1.355d0, 1.37d0, 1.4d0  , 1.4236d0,1.d0,1.01d0,1.03d0,               
     &     1.058d0, 1.077d0,1.0905d0/                                           
      data aif01/ 1.d0, 1.0677d0,1.0867d0,1.1105d0/                             
      data ex   /600.d0,21*700.d0/                                              
      data exold/200.d0,21*250.d0/                                              
      data tab77/                                                               
     &     1000.0d0,  3.10d0,  2000.0d0,  3.40d0,  3000.0d0,  3.60d0,           
     &     4000.0d0,  4.80d0,  5000.0d0,  5.40d0,  6000.0d0,  5.90d0,           
     &     7000.0d0,  6.50d0,  8000.0d0,  7.60d0,  9000.0d0,  8.20d0,           
     &    10000.0d0,  8.80d0, 11000.0d0,  9.30d0, 12000.0d0,  9.90d0,           
     &    13000.0d0, 10.50d0, 14000.0d0, 11.10d0,     1.e20, 11.40d0/           
      data tab79/                                                               
     &     3000.0d0,  3.40d0,  6000.0d0,  5.20d0,  9000.0d0,  7.00d0,           
     &    12000.0d0,  8.20d0, 15000.0d0,  8.70d0, 20000.0d0,  9.10d0,           
     &    40000.0d0,  9.50d0,     1.e20, 10.00d0/                               
      data   tab/                                                               
     &0.d0,3.4d0,0.d0,5.2d0,0.d0,7.0d0,0.d0,8.2d0,0.d0,8.7d0,0.d0,9.1d0,        
     &0.d0,9.5d0,0.d0,10.d0/                                                    
      data tabj86/                                                              
     &    10000.0d0,  5.00d0, 20000.0d0, 6.600d0, 40000.0d0,  7.50d0,           
     &        1.e20,  7.90d0/                                                   
      data tabp86/                                                              
     &     5000.0d0,  5.00d0, 10000.0d0, 6.600d0, 20000.0d0,   7.50d0,          
     &        1.e20,  7.90d0/                                                   
      data tabs86/                                                              
     &     7500.0d0,  5.00d0, 15000.0d0, 6.600d0, 30000.0d0,   7.50d0,          
     &        1.e20,  7.90d0/                                                   
      data tabj87/                                                              
     &    10000.0d0,  4.90d0, 20000.0d0, 6.550d0,  1.e20, 6.930d0/              
      data tabp87/                                                              
     &     5000.0d0,  4.90d0, 10000.0d0, 6.550d0,  1.e20, 6.930d0/              
      data tabs87/                                                              
     &     7500.0d0,  4.90d0, 15000.0d0, 6.550d0,  1.e20, 6.930d0/              
      data tabj98/                                                              
     &    10000.0d0,  4.77d0, 20000.0d0, 6.370d0,  1.e20, 6.770d0/              
      data tabp98/                                                              
     &     5000.0d0,  4.77d0, 10000.0d0, 6.370d0,  1.e20, 6.770d0/              
      data tabs98/                                                              
     &     7500.0d0,  4.77d0, 15000.0d0, 6.370d0,  1.e20, 6.770d0/              
      data tab00s/                                                              
     &     5000.0d0,  4.73d0,  8000.0d0, 4.90d0 ,  16000.0d0,6.350d0,           
     &   116891.0d0,  6.55d0,     1.e20, 6.75d0/                                
      data tab00j/                                                              
     &     5000.0d0,  4.73d0, 11000.0d0, 4.85d0 ,  21000.0d0,6.350d0,           
     &   155851.0d0,  6.55d0,     1.e20, 6.75d0/                                
      data tab00n/                                                              
     &     5000.0d0,  4.73d0,  6000.0d0, 5.90d0 ,  11000.0d0,6.350d0,           
     &    77925.5d0,  6.55d0,     1.e20, 6.75d0/                                
      data tab01s/                                                              
     &     8000.0d0,  4.60d0, 16000.0d0, 6.20d0 , 116330.0d0, 6.50d0,           
     &        1.e20,  6.75d0/                                                   
      data tab01j/                                                              
     &    10000.0d0,  4.60d0, 11000.0d0, 5.10d0 ,  22000.0d0, 6.20d0,           
     &   155100.0d0,  6.50d0,     1.e20, 6.75d0/                                
      data tab01n/                                                              
     &     5000.0d0,  4.60d0,  6000.0d0, 5.70d0 , 11000.0d0,  6.20d0,           
     &    77550.0d0,  6.50d0,     1.e20, 6.75d0/                                
      data tab05s/                                                              
     &     8000.0d0,  4.60d0, 18000.0d0, 6.15d0, 132580.0d0,  6.50d0,           
     &        1.e20,  6.75d0/                                                   
      data tab05j/                                                              
     &    12000.0d0,  4.60d0, 24000.0d0, 6.15d0, 176770.0d0,  6.50d0,           
     &        1.e20,  6.75d0/                                                   
c                                                                               
      data tab06s/                                                              
     &     9000.0d0, 4.60d0, 19000.0d0, 6.150d0, 137410.0d0,  6.50d0,           
     &        1.e20, 6.75d0/                                                    
      data tab06j/                                                              
     &    12000.0d0, 4.60d0, 24000.0d0, 6.150d0, 183210.0d0,  6.50d0,           
     &        1.e20, 6.75d0/                                                    
c                                                                               
      data tab07s/1000.d0,4.4d0,9000.d0,4.6d0,11000.d0,5.3d0,                   
     &    19000.d0, 6.15d0,142650.d0, 6.5d0,    1.e20,6.75d0/                   
      data tab07j/1000.d0,4.4d0,12000.d0,4.6d0,13000.d0,5.3d0,                  
     &    25000.0d0, 6.15d0,190210.0d0, 6.50d0, 1.e20, 6.75d0/                  
c                                                                               
      data tab08s/                                                              
     &     1000.0d0, 4.40d0, 10000.0d0, 4.60d0 ,  19000.0d0, 6.150d0,           
     &   145460.0d0, 6.50d0,     1.e20, 6.75d0/                                 
      data tab08j/                                                              
     &     1000.0d0, 4.40d0, 13000.0d0, 4.60d0 ,  27000.0d0, 6.150d0,           
     &   193950.0d0, 6.50d0,     1.e20, 6.75d0/                                 
      data tab09s/                                                              
     &    10220.0d0, 4.60d0, 20440.0d0, 6.150d0, 153280.0d0, 6.50d0,            
     &   225000.0d0, 6.75d0,     1.e20, 7.750d0/                                
      data tab09j/                                                              
     &    13300.0d0, 4.60d0, 27000.0d0, 6.150d0, 199300.0d0, 6.50d0,            
     &   292500.0d0, 6.75d0,     1.e20, 7.750d0/                                
      data tab13s/                                                              
     &    10750.0d0, 4.40d0, 21490.0d0, 5.840d0, 236600.0d0, 6.27d0,            
     &        1.e20, 7.650d0/                                                   
      data tab13j/                                                              
     &    14330.0d0, 4.40d0, 28650.0d0, 5.840d0, 315460.0d0, 6.27d0,            
     &        1.e20, 7.650d0/                                                   
      data tab14s/                                                              
     &    10910.0d0, 4.0d0, 21820.0d0, 5.840d0, 240190.0d0, 6.27d0,             
     &        1.e20, 7.650d0/                                                   
      data tab14j/                                                              
     &    14540.0d0, 4.0d0, 29090.0d0, 5.840d0, 320250.0d0, 6.27d0,             
     &        1.e20, 7.650d0/                                                   
      data tab19s/                                                              
     &    11760.0d0, 3.86d0,23520.0d0, 5.040d0, 258950.0d0, 6.27d0,             
     &        1.e20, 7.650d0/                                                   
      data tab19j/                                                              
     &    15680.0d0, 3.86d0,31360.0d0, 5.040d0, 345270.0d0, 6.27d0,             
     &        1.e20, 7.650d0/                                                   
      data tab20s/                                                              
     &    11970.0d0, 3.54d0,23930.0d0, 4.650d0, 263480.0d0, 6.27d0,             
     &        1.e20, 7.650d0/                                                   
      data tab20j/                                                              
     &    15960.0d0, 3.54d0,31910.0d0, 4.650d0, 351310.0d0, 6.27d0,             
     &        1.e20, 7.650d0/                                                   
      data tab21s/                                                              
     &    12120.0d0, 3.54d0,24250.0d0, 4.650d0, 266930.0d0, 5.3d0,              
     &        1.e20, 7.650d0/                                                   
      data tab21j/                                                              
     &    16160.0d0, 3.54d0,32330.0d0, 4.650d0, 355910.0d0, 5.3d0,              
     &        1.e20, 7.650d0/                                                   
                                                                                
c                                                                               
      data dept77/                                                              
     &    5000.0d0, 800.0d0, 6000.0d0, 700.0d0, 7000.0d0, 600.0d0,              
     &    8000.0d0, 500.0d0, 9000.0d0, 400.0d0, 9669.0d0, 300.0d0,              
     &       1.e20,   0.0d0/                                                    
      data dept79/                                                              
     &    5000.0d0, 800.0d0, 6000.0d0, 700.0d0, 7000.0d0, 600.0d0,              
     &    8000.0d0, 500.0d0, 9000.0d0, 400.0d0,10000.0d0, 300.0d0,              
     &   11000.0d0, 200.0d0,12000.0d0, 100.0d0,    1.e20,   0.0d0/              
      data s077/                                                                
     1 3200.0d0, 2600.0d0, 6*3200.0d0,                                          
     2 3300.0d0, 2500.0d0, 6*3300.0d0,                                          
     3 3400.0d0, 2200.0d0, 3000.0d0, 5*3400.0d0,                                
     4 3500.0d0, 1900.0d0, 2700.0d0, 5*3500.0d0,                                
     5 3600.0d0, 1550.0d0, 2350.0d0,   3150.0d0, 4*3600.0d0,                    
     6 5000.0d0, 1300.0d0, 2100.0d0,   2900.0d0,   3700.0d0, 4500.0d0,          
     & 2*5000.0d0,                                                              
     7 6000.0d0, 1300.0d0, 2000.0d0,   2700.0d0,   3400.0d0, 4100.0d0,          
     & 4800.0d0, 5500.0d0,                                                      
     8 7000.0d0, 1300.0d0, 1900.0d0,   2500.0d0,   3100.0d0, 3700.0d0,          
     & 4300.0d0, 4900.0d0,                                                      
     9 8000.0d0, 1300.0d0, 1800.0d0,   2300.0d0,   2800.0d0, 3300.0d0,          
     & 3800.0d0, 4300.0d0,                                                      
     & 8667.0d0, 1300.0d0, 1700.0d0,   2100.0d0,   2500.0d0, 2900.0d0,          
     & 3300.0d0, 3700.0d0,                                                      
     1    1.e20,7*-3000.0d0/                                                    
      data s177/  4200.0d0, 3450.0d0, 4200.0d0, 4200.0d0, 4200.0d0,             
     &            4300.0d0, 3350.0d0, 4150.0d0, 4300.0d0, 4300.0d0,             
     &            4400.0d0, 3000.0d0, 3800.0d0, 4400.0d0, 4400.0d0,             
     &            4500.0d0, 2650.0d0, 3450.0d0, 4250.0d0, 4500.0d0,             
     &            4600.0d0, 2350.0d0, 3150.0d0, 3950.0d0, 4600.0d0,             
     &            4700.0d0, 2050.0d0, 2850.0d0, 3650.0d0, 4450.0d0,             
     &            4800.0d0, 1700.0d0, 2500.0d0, 3300.0d0, 4100.0d0,             
     &            4900.0d0, 1500.0d0, 2300.0d0, 3100.0d0, 3900.0d0,             
     &            5000.0d0, 1300.0d0, 2100.0d0, 2900.0d0, 3700.0d0,             
     &            6000.0d0, 1300.0d0, 2000.0d0, 2700.0d0, 3400.0d0,             
     &            7000.0d0, 1300.0d0, 1900.0d0, 2500.0d0, 3100.0d0,             
     &            8000.0d0, 1300.0d0, 1800.0d0, 2300.0d0, 2800.0d0,             
     &            8667.0d0, 1300.0d0, 1700.0d0, 2100.0d0, 2500.0d0,             
     &               1.e20,-3000.0d0,-3000.0d0,-3000.0d0,-3000.0d0/             
      data m077/                                                                
     1 5200.0d0, 4000.0d0, 4700.0d0, 6*5200.0d0,                                
     2 5300.0d0, 3900.0d0, 7*5300.0d0,                                          
     3 5400.0d0, 2*3600.0d0, 4300.0d0, 5000.0d0, 4*5400.0d0,                    
     4 5500.0d0, 3300.0d0, 4000.0d0, 4700.0d0, 5400.0d0, 4*5500.0d0,            
     5 5600.0d0, 3000.0d0, 3700.0d0, 4400.0d0, 5100.0d0, 4*5600.0d0,            
     6 5700.0d0, 2750.0d0, 3450.0d0, 4150.0d0, 4850.0d0, 5550.0d0,              
     & 3*5700.0d0,                                                              
     7 5800.0d0, 2500.0d0, 3200.0d0, 3900.0d0, 4600.0d0, 5300.0d0,              
     & 3*5800.0d0,                                                              
     8 5900.0d0, 2300.0d0, 3000.0d0, 3700.0d0, 4400.0d0, 5100.0d0,              
     & 5800.0d0, 2*5900.0d0,                                                    
     9 6000.0d0, 2100.0d0, 2800.0d0, 3500.0d0, 4200.0d0, 4900.0d0,              
     & 5600.0d0, 2*6000.0d0,                                                    
     & 6100.0d0, 1900.0d0, 2500.0d0, 3100.0d0, 3700.0d0, 4300.0d0,              
     & 4900.0d0, 5500.0d0, 6100.0d0,                                            
     1 6200.0d0, 1700.0d0, 2300.0d0, 2900.0d0, 3500.0d0, 4100.0d0,              
     & 4700.0d0, 5300.0d0, 5900.0d0,                                            
     2 6300.0d0, 1550.0d0, 2150.0d0, 2750.0d0, 3350.0d0, 3950.0d0,              
     & 4550.0d0, 5150.0d0, 5750.0d0,                                            
     3 6400.0d0, 1350.0d0, 1950.0d0, 2550.0d0, 3150.0d0, 3750.0d0,              
     & 4350.0d0, 4950.0d0, 5550.0d0,                                            
     4 7000.0d0, 1300.0d0, 1900.0d0, 2500.0d0, 3100.0d0, 3700.0d0,              
     & 4300.0d0, 4900.0d0, 5500.0d0,                                            
     5 8000.0d0, 1300.0d0, 1800.0d0, 2300.0d0, 2800.0d0, 3300.0d0,              
     & 3800.0d0, 4300.0d0, 4800.0d0,                                            
     6 8667.0d0, 1300.0d0, 1700.0d0, 2100.0d0, 2500.0d0, 2900.0d0,              
     & 3300.0d0, 3700.0d0, 4100.0d0,                                            
     7 1.e20,  8* -3000.0d0/                                                    
      data m177/  6200.0d0, 4800.0d0, 5400.0d0, 6000.0d0, 6200.0d0,             
     &            6300.0d0, 4750.0d0, 5350.0d0, 5950.0d0, 6300.0d0,             
     &            6400.0d0, 4450.0d0, 5050.0d0, 5650.0d0, 6250.0d0,             
     &            6500.0d0, 4150.0d0, 4750.0d0, 5350.0d0, 5950.0d0,             
     &            6600.0d0, 3850.0d0, 4450.0d0, 5050.0d0, 5650.0d0,             
     &            6700.0d0, 3600.0d0, 4200.0d0, 4800.0d0, 5400.0d0,             
     &            6800.0d0, 3350.0d0, 3950.0d0, 4550.0d0, 5150.0d0,             
     &            6900.0d0, 3150.0d0, 3750.0d0, 4350.0d0, 4950.0d0,             
     &            7000.0d0, 2950.0d0, 3550.0d0, 4150.0d0, 4750.0d0,             
     &            7100.0d0, 2800.0d0, 3300.0d0, 3800.0d0, 4300.0d0,             
     &            7200.0d0, 2600.0d0, 3100.0d0, 3600.0d0, 4100.0d0,             
     &            7300.0d0, 2450.0d0, 2950.0d0, 3450.0d0, 3950.0d0,             
     &            7400.0d0, 2250.0d0, 2750.0d0, 3250.0d0, 3750.0d0,             
     &            7500.0d0, 2100.0d0, 2600.0d0, 3100.0d0, 3600.0d0,             
     &            7600.0d0, 1950.0d0, 2450.0d0, 2950.0d0, 3450.0d0,             
     &            7700.0d0, 1750.0d0, 2250.0d0, 2750.0d0, 3250.0d0,             
     &            7800.0d0, 1600.0d0, 2100.0d0, 2600.0d0, 3100.0d0,             
     &            7900.0d0, 1450.0d0, 1950.0d0, 2450.0d0, 2950.0d0,             
     &            8000.0d0, 1300.0d0, 1800.0d0, 2300.0d0, 2800.0d0,             
     &            8677.0d0, 1300.0d0, 1700.0d0, 2100.0d0, 2500.0d0,             
     &            1.e20 ,4*-3000.0d0/                                           
       data m277/                                                               
     1 7300.0d0, 5600.0d0, 6100.0d0, 6600.0d0, 7100.0d0,4*7300.0d0,             
     2 7500.0d0, 4950.0d0, 5450.0d0, 5950.0d0, 6450.0d0,  6950.0d0,             
     & 7450.0d0, 7500.0d0, 7500.0d0,                                            
     3 7700.0d0, 4450.0d0, 4950.0d0, 5450.0d0, 5950.0d0,  6450.0d0,             
     & 6950.0d0, 7450.0d0, 7700.0d0,                                            
     4 7900.0d0, 4050.0d0, 4550.0d0, 5050.0d0, 5550.0d0,  6050.0d0,             
     & 6550.0d0, 7050.0d0, 7550.0d0,                                            
     5 8100.0d0, 3650.0d0, 4050.0d0, 4450.0d0, 4850.0d0,  5250.0d0,             
     & 5650.0d0, 6050.0d0, 6450.0d0,                                            
     6 8300.0d0, 3300.0d0, 3700.0d0, 4100.0d0, 4500.0d0,  4900.0d0,             
     & 5300.0d0, 5700.0d0, 6100.0d0,                                            
     7 8500.0d0, 2950.0d0, 3350.0d0, 3750.0d0, 4150.0d0,  4550.0d0,             
     & 4950.0d0, 5350.0d0, 5750.0d0,                                            
     8 8700.0d0, 2600.0d0, 3000.0d0, 3400.0d0, 3800.0d0,  4200.0d0,             
     & 4600.0d0, 5000.0d0, 5400.0d0,                                            
     9 8800.0d0, 2450.0d0, 2850.0d0, 3250.0d0, 3650.0d0,  4050.0d0,             
     & 4450.0d0, 4850.0d0, 5250.0d0,                                            
     & 8900.0d0, 2300.0d0, 2700.0d0, 3100.0d0, 3500.0d0,  3900.0d0,             
     & 4300.0d0, 4700.0d0, 5100.0d0,                                            
     1 9000.0d0, 2150.0d0, 2550.0d0, 2950.0d0, 3350.0d0,  3750.0d0,             
     & 4150.0d0, 4550.0d0, 4950.0d0,                                            
     2 9100.0d0, 2000.0d0, 2300.0d0, 2600.0d0, 2900.0d0,  3200.0d0,             
     & 3500.0d0, 3800.0d0, 4100.0d0,                                            
     3 9300.0d0, 1800.0d0, 2100.0d0, 2400.0d0, 2700.0d0,  3000.0d0,             
     & 3300.0d0, 3600.0d0, 3900.0d0,                                            
     4 9400.0d0, 1700.0d0, 2000.0d0, 2300.0d0, 2600.0d0,  2900.0d0,             
     & 3200.0d0, 3500.0d0, 3800.0d0,                                            
     5 9500.0d0, 1550.0d0, 1850.0d0, 2150.0d0, 2450.0d0,  2750.0d0,             
     & 3050.0d0, 3350.0d0, 3650.0d0,                                            
     6 9670.0d0, 1450.0d0, 1750.0d0, 2050.0d0, 2350.0d0,  2650.0d0,             
     & 2950.0d0, 3250.0d0, 3550.0d0,                                            
     7 1.e20,8*-3000./                                                          
      data s079/3200.0d0, 2600.0d0, 3400.0d0,                                   
     &          3300.0d0, 2500.0d0, 3300.0d0,                                   
     &          5000.0d0, 2300.0d0, 3100.0d0,                                   
     &          6000.0d0, 2300.0d0, 3000.0d0,                                   
     &          7000.0d0, 2300.0d0, 2900.0d0,                                   
     &          8000.0d0, 2300.0d0, 2800.0d0,                                   
     &          9000.0d0, 2300.0d0, 2700.0d0,                                   
     &         11000.0d0, 2300.0d0, 2500.0d0,                                   
     &         12000.0d0, 2300.0d0, 2400.0d0,                                   
     &             1.e20, 2300.0d0, 2300.0d0/                                   
      data s179/4200.0d0, 3450.0d0, 4250.0d0,                                   
     &          4300.0d0, 3350.0d0, 4150.0d0,                                   
     &          4400.0d0, 3000.0d0, 3800.0d0,                                   
     &          4500.0d0, 2650.0d0, 3450.0d0,                                   
     &          4600.0d0, 2350.0d0, 3150.0d0,                                   
     &          5000.0d0, 2300.0d0, 3100.0d0,                                   
     &          6000.0d0, 2300.0d0, 3000.0d0,                                   
     &          7000.0d0, 2300.0d0, 2900.0d0,                                   
     &          8000.0d0, 2300.0d0, 2800.0d0,                                   
     &          9000.0d0, 2300.0d0, 2700.0d0,                                   
     &         10000.0d0, 2300.0d0, 2600.0d0,                                   
     &         11000.0d0, 2300.0d0, 2500.0d0,                                   
     &         12000.0d0, 2300.0d0, 2400.0d0,                                   
     &             1.e20, 2300.0d0, 2300.0d0/                                   
      data m079/5000.0d0, 4000.0d0, 4800.0d0,                                   
     &          5200.0d0, 4000.0d0, 4700.0d0,                                   
     &          5300.0d0, 3900.0d0, 4600.0d0,                                   
     &          5400.0d0, 3600.0d0, 4300.0d0,                                   
     &          6000.0d0, 3400.0d0, 4100.0d0,                                   
     &          7000.0d0, 3400.0d0, 4000.0d0,                                   
     &          8000.0d0, 3400.0d0, 3900.0d0,                                   
     &          9000.0d0, 3400.0d0, 3800.0d0,                                   
     &         10000.0d0, 3400.0d0, 3700.0d0,                                   
     &         11000.0d0, 3400.0d0, 3600.0d0,                                   
     &         12000.0d0, 3400.0d0, 3500.0d0,                                   
     &             1.e20, 3400.0d0, 3400.0d0/                                   
      data m179/5000.0d0, 4800.0d0, 5600.0d0,                                   
     &          6000.0d0, 4800.0d0, 5500.0d0,                                   
     &          6200.0d0, 4800.0d0, 5400.0d0,                                   
     &          6300.0d0, 4750.0d0, 5350.0d0,                                   
     &          6400.0d0, 4450.0d0, 5050.0d0,                                   
     &          6500.0d0, 4150.0d0, 4750.0d0,                                   
     &          6600.0d0, 3850.0d0, 4450.0d0,                                   
     &          6700.0d0, 3600.0d0, 4200.0d0,                                   
     &          7000.0d0, 3400.0d0, 4000.0d0,                                   
     &          8000.0d0, 3400.0d0, 3900.0d0,                                   
     &          9000.0d0, 3400.0d0, 3800.0d0,                                   
     &         10000.0d0, 3400.0d0, 3700.0d0,                                   
     &         11000.0d0, 3400.0d0, 3600.0d0,                                   
     &         12000.0d0, 3400.0d0, 3500.0d0,                                   
     &             1.e20, 3400.0d0, 3400.0d0/                                   
      data m279/5000.0d0, 5700.0d0, 6500.0d0,                                   
     &          6000.0d0, 5700.0d0, 6400.0d0,                                   
     &          7000.0d0, 5700.0d0, 6300.0d0,                                   
     &          7200.0d0, 5700.0d0, 6200.0d0,                                   
     &          7300.0d0, 5600.0d0, 6100.0d0,                                   
     &          7400.0d0, 5300.0d0, 5800.0d0,                                   
     &          7500.0d0, 4950.0d0, 5450.0d0,                                   
     &          7600.0d0, 4650.0d0, 5150.0d0,                                   
     &          7700.0d0, 4450.0d0, 4950.0d0,                                   
     &          7800.0d0, 4200.0d0, 4700.0d0,                                   
     &          7900.0d0, 4050.0d0, 4500.0d0,                                   
     &          8000.0d0, 3850.0d0, 4350.0d0,                                   
     &          8100.0d0, 3650.0d0, 4050.0d0,                                   
     &          8200.0d0, 3450.0d0, 3850.0d0,                                   
     &          9000.0d0, 3400.0d0, 3800.0d0,                                   
     &         10000.0d0, 3400.0d0, 3700.0d0,                                   
     &         11000.0d0, 3400.0d0, 3600.0d0,                                   
     &         12000.0d0, 3400.0d0, 3500.0d0,                                   
     &             1.e20, 3400.0d0, 3400.0d0/                                   
      data aif/ 1.0d0, 1.10d0, 1.20d0, 4*1.30d0 /                               
      data ltg/.5d0, 4*.6d0, .4d0, .2d0, 3*.0d0, 22*.4d0,13*.3d0/               
      data rmax/ 4*149.d0,3*99.d0,158.0d0, 138.0d0, 170.0d0, 9*200.0d0,         
     & 350.0d0,.0d0,22*300.0d0/                                                 
      data teach/ 4*1.2d0,3*1.d0,.785d0, .69d0, .85d0, 9*1.0d0,                 
     & 1.4d0,.0d0,22*1.22d0/                                                    
      data reach/4*2.4d0,3*2.d0,1.58, 1.38, 1.7, 9*2.,2.8,0.,22*2.4/            
c     data farmreg/ 55000.,  1.e20,  75000., 22000., 100000., 17500.,           
c    &             150000., 15000., 200000., 12500., 250000., 10000.,           
c    &             300000.,  7500., 400000.,  5000.,   1.e20,     0./           
c     data farmsep/ 27500.,  1.e20,  37500., 10000.,  50000.,  8750.,           
c    &              75000.,  7500., 100000.,  6250., 125000.,  5000.,           
c    &             150000.,  3750., 200000.,  2500.,   1.e20,     0./           
c     data requ/  9*3200., 14*5200.,                                            
c    &            9*5200., 7200., 5*7560., 8*8900.,                             
c    &            9*1000., 500., 11*510.,2*524./                                
      data tb2/ 52*0.0d0/                                                       
      data alms /9*30000.0d0,6*33750.0d0,3*35750.0d0,40250.0d0,                 
     &11*33750.0d0,54300.0d0,  70300.0d0/                                       
      data almm /9*40000.0d0,6*45000.0d0,3*49000.0d0,58000.0d0,                 
     &11*45000.0d0,84500.0d0, 109400.0d0/                                       
      data almphs /2*112500.0d0,155000.0d0,27*112500.d0,120700.0d0,             
     & 500000.0d0/                                                              
      data almphm /2*150000.0d0,155000.0d0,27*150000.d0,160900.0d0,             
     &1000000.0d0/                                                              
      mst = int(data(2))                                                               
      mar = int(sorm(mst,1.0d0,2.0d0))                                                 
      sep = 1                                                                     
      if(mst.eq.3.or.mst.eq.6) sep = 2                                          
c                                                                               
c only brackets are indexed.  for 1987 on standard deduction also.              
c                                                                               
      if(law.ge.1979.and.law.le.1985) then                                      
       do 20 i=1,8                                                              
        tab(1,i)=tab79(1,i)*aif(law)                                            
20     continue                                                                 
      endif                                                                     
      rt=0.                                                                     
c     AGI                                                                       
      agi=comnew(2)                                                             
      txp=data(7)                                                               
c 2020 CARES Act                                                                
      if(law.eq.2020) agi = agi + data(82) - comnew(78)                         
c 2021 unemplyment compensation subraction worksheet Sch SB                     
      if(law.eq.2021) then                                                      
        xl5 = 12000.d0                                                          
        if(mst.eq.2) xl5 = 18000.d0                                             
        xl7 = max(0.d0,comnew(2)-(xl5+comnew(79)+data(22)))                     
        xl9 = min(data(82),.5*xl7)                                              
        ucsubt = max(0.d0,data(82)-xl9)                                         
        agi = agi - ucsubt                                                      
c      write(0,*) '1 agi ucsubt',agi,ucsubt                                     
                                                                                
      endif                                                                     
c different capital loss rules                                                  
      if(comnew(5).le.0.0d0) then                                               
        if(law.le.1981) then                                                    
c capital losses are deductable in full (vs.50% for fed) up                     
c to r1,000 per taxpayer                                                        
          if(data(68).lt.0.0d0) then                                            
            if(data(70).gt.(-2000*txp).and.data(70).lt.0.0d0) then              
              caplss=max(data(70),-1000*txp)                                    
              agi=agi + min(caplss-.5*data(70),0.0d0)                           
            endif                                                               
          else if(data(68).ge.0.0d0) then                                       
            xnet=data(70)+data(68)                                              
            if(xnet.gt.(-2000*txp).and.xnet.lt.0.0d0)then                       
              caplss=max(xnet,-1000*txp)                                        
              agi=agi + min(caplss-(.5*xnet),0.0d0)                             
            endif                                                               
          endif                                                                 
        else if(law.ge.1987) then                                               
          caplss = abs(comnew(6))                                               
          ag = max(0.0d0,agi)                                                   
          closswi = min(caplss,500.0d0,ag)                                      
          agi = agi + caplss - closswi                                          
        endif                                                                   
      else if(comnew(5).gt.0.0d0) then                                          
c long term gains taxable in full before 1982                                   
         if(law.le.1981) then                                                   
            agi = agi + comnew(7)                                               
         else if(law.eq.1982) then                                              
            agi = agi + 2*comnew(7)/3                                           
         else if(law.eq.1983) then                                              
            agi = agi + comnew(7)/3                                             
         else if(law.ge.1987) then                                              
            capgn = min(comnew(5),data(70))                                     
            capded = ltg(law) * capgn                                           
c agi=agi-(comnew(5)+capded) was before 12.09.2021                              
            agi = agi - capded                                                  
c      write(0,*) '3 agi capded',agi,capded                                     
                                                                                
         endif                                                                  
      endif                                                                     
                                                                                
c State Income Tax Refund                                                       
      if(law.ge.1980)agi=agi-data(22)                                           
c                  write(0,*) '4 agi=',agi                                      
                                                                                
c Two-earner deduction in Federal AGI - an addition for Wisconsin AGI           
      if(law.ge.1982.and.law.le.1986)agi=agi+comnew(32)                         
c Social Security benefits in AGI are not taxable for 1984,1985                 
      if(law.ge.1986.and.law.le.2007.and.data(91).gt.0)                         
     &        agi = agi - max(0.0d0,comnew(79)-data(91)/2)                      
c New for 2008: Social Security benefits are not taxable in WI                  
      if(law.ge.2008) agi = agi - comnew(79)                                    
c                  write(0,*) '5 agi=',agi                                      
                                                                                
c Unemployment compensation (exclude 2020)                                      
      phas = 0.                                                                 
      if(mst.eq.2.or.mst.eq.5) phas = 18000.                                    
      if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) phas = 12000.                        
      if(data(82).gt.0.and.law.ne.2020) agi = agi - data(82) +                  
     & min(data(82),.5*max(0.0d0,comnew(2)-phas-comnew(79)-data(22)))           
c                 write(0,*) '6 agi=',agi                                       
                                                                                
c new in 1998 Tuition Expenses subtraction                                      
      if(law.ge.1998.and.(data(143).gt.0.or.data(144).gt.0)) then               
         tuided = min(tuiexp(law)*data(110),data(143) + data(144))              
         tuiph = 50000.*aiftui(law)                                             
         if(mst.eq.2.or.mst.eq.3.or.mst.eq.6)                                   
     &   tuiph = 80000.*aiftui(law)/sep                                         
         if(comnew(2).gt.tuiph) tuided =                                        
     &   tuided - tuided*(comnew(2)-tuiph)/(10000*aiftui(law)*data(7))          
         agi = agi - tuided                                                     
      endif                                                                     
c new in 2011 Child Care Expenses subtraction                                   
      if(law.ge.2011.and.comnew(53).gt.0) then                                  
         ncccr = int(min(data(8),2.0d0))                                             
         if(data(207).gt.0) ncccr = int(min(data(207),2.0d0))                        
         child = min(data(64),chexp(law)*ncccr)                                 
         if(mst.eq.2) child = max(0.0d0,min(child,data(85),data(86)))           
         agi = agi - child                                                      
      endif                                                                     
c Standard Deduction                                                            
      if(law.le.1978)depadd=tablki(dept77,7,agi,data)                           
      if(law.ge.1979)depadd=tablki(dept79,9,agi,data)                           
      if(law.le.1978) then                                                      
c for years before 1978                                                         
          stded=twn(.15*agi,0.0d0,2000.0d0)+depadd                              
      else if(law.ge.1979.and.law.le.1985) then                                 
c for years 1979 - 1985                                                         
c       get stded from low inc tables                                           
        stded=0.                                                                
      else if(law.ge.1986.and.law.le.1999) then                                 
c for years 1986+                                                               
        if(mar.eq.1) then                                                       
c for single, widowed and head of household                                     
           if(agi.le.7500.) then                                                
              stded = 5200.                                                     
              if(law.eq.1999) stded = 5280.                                     
           else                                                                 
              stded = max(0.0d0,5170.-(agi-7500.)*.12)                          
              if(law.eq.1999) stded = max(0.0d0,5280.-(agi-7500.)*.12)          
           endif                                                                
           if(law.ge.1994.and.(mst.eq.4.or.mst.eq.7)) then                      
c A new "head of household" filing status is available in 1994+                 
             if(agi.le.7500.) then                                              
                stded = 7040.                                                   
                if(law.eq.1999) stded = 7150.                                   
             elseif (agi.gt.7500..and.agi.le.25000.) then                       
                stded = max(0.0d0,6984.-(agi-7500.)*.225)                       
                if(law.eq.1999)stded = max(0.0d0,7121.-(agi-7500.)*.225)        
             else                                                               
                stded = max(0.0d0,3070.-(agi-25000.)*.12)                       
                if(law.eq.1999)stded = max(0.0d0,3181.-(agi-25000.)*.12)        
             endif                                                              
           endif                                                                
        endif                                                                   
        if(mar.eq.2) then                                                       
         if(mst.eq.2) then                                                      
c for married jointly                                                           
          if(law.eq.1986) then                                                  
c for year 1986 only                                                            
             if(agi.le.10000.) then                                             
              stded = 7200.                                                     
             else                                                               
               stded=max(0.0d0,7173.-(agi-10000.)*.128)                         
             endif                                                              
          elseif(law.eq.1987) then                                              
c for year 1987 only                                                            
             if(agi.le.10000.) then                                             
              stded = 7560.                                                     
             else                                                               
               stded=max(0.0d0,7529.-(agi-10000.)*.125)                         
             endif                                                              
          elseif(law.ge.1988) then                                              
c for years 1988+                                                               
             if(agi.le.10000.) then                                             
              stded = 8900.                                                     
              if(law.eq.1999) stded = 9040.                                     
             else                                                               
               stded=max(0.0d0,8851.-(agi-10000.)*.1978)                        
               if(law.eq.1999)stded=max(0.0d0,9022.-(agi-10000.)*.1978)         
             endif                                                              
          endif                                                                 
         endif                                                                  
        if(mst.ne.2) then                                                       
c for married separately                                                        
          if(law.eq.1986) then                                                  
c for year 1986 only                                                            
             if(agi.le.4750.) then                                              
                stded = 3420.                                                   
             elseif(agi.gt.4750.and.agi.le.5500) then                           
                stded = max(0.0d0,3407.-(agi-4750.)*.053)                       
             else                                                               
                stded=max(0.0d0,3367.-(agi-5500.)*.11)                          
             endif                                                              
          else if(law.eq.1987) then                                             
c for year 1987 only                                                            
             if(agi.le.4750.) then                                              
                stded = 3590.                                                   
             elseif(agi.gt.4750.and.agi.le.5500) then                           
                stded = max(0.0d0,3574.-(agi-4750.)*.092)                       
             else                                                               
                stded=max(0.0d0,3528.-(agi-5500.)*.125)                         
             endif                                                              
          elseif(law.ge.1988.and.law.le.1998) then                              
c for years 1988-98                                                             
             if(agi.le.4750.) then                                              
                stded = 4230.                                                   
             elseif(agi.gt.4750.and.agi.le.5500) then                           
                stded = max(0.0d0,4205.-(agi-5000.)*.148)                       
             else                                                               
                stded=max(0.0d0,4131.-(agi-5500.)*.198)                         
             endif                                                              
          elseif(law.eq.1999) then                                              
c for year 1999 separate filing                                                 
             if(agi.le.4830.) then                                              
                stded = 4300.                                                   
             elseif(agi.gt.4830.and.agi.le.5500) then                           
                stded = max(0.0d0,4283.-(agi-4830.)*.132)                       
             else                                                               
                stded=max(0.0d0,4283.-(agi-5500.)*.1978)                        
             endif                                                              
          endif                                                                 
         endif                                                                  
        endif                                                                   
      else if(law.ge.2000) then                                                 
c for year 2000                                                                 
        coeff = aifst(law)                                                      
        if(mst.eq.1) then                                                       
c for single                                                                    
           if(law.lt.2016) then                                                 
             b = 10500*coeff                                                    
             if(agi.le.b) then                                                  
              stded = 7200*coeff                                                
             else                                                               
              stded = max(0.0d0,7200*coeff-(agi-b)*.12)                         
             endif                                                              
           else if(law.ge.2016) then                                            
             b = 14800*coeff                                                    
             c = 100383*coeff                                                   
             if(agi.le.b) then                                                  
               stded = 10270*coeff                                              
             else if(agi.gt.b.and.agi.le.c) then                                
               stded = 10270*coeff - .12*(agi-b)                                
             else                                                               
               stded= 0.                                                        
             endif                                                              
           endif                                                                
        else if(mst.eq.4.or.mst.eq.7) then                                      
c for head of household                                                         
         if(law.le.2015) then                                                   
           b = 10500*coeff                                                      
           c = 30500*coeff                                                      
           if(agi.le.b) then                                                    
              stded = 9300*coeff                                                
           else if (agi.gt.b.and.agi.le.c) then                                 
                stded = max(0.0d0,9300*coeff-(agi-b)*.238)                      
           else                                                                 
                stded = max(0.0d0,4826*coeff-(agi-b)*.12)                       
           endif                                                                
         else if(law.ge.2016) then                                              
           b = 14800*coeff                                                      
           c = 43237*coeff                                                      
           d = 100383*coeff                                                     
           if(agi.le.b) then                                                    
             stded = 13260*coeff                                                
           else if(agi.gt.b.and.agi.le.c) then                                  
             stded = 13260*coeff - .22515*(agi-b)                               
           else if(agi.gt.c.and.agi.lt.d) then                                  
             stded = 10270*coeff - .12*(agi-b)                                  
           else                                                                 
             stded = 0.                                                         
           endif                                                                
         endif                                                                  
        else if(mst.eq.2.or.mst.eq.5) then                                      
c for married jointly                                                           
         if(law.le.2015) then                                                   
           if(agi.lt.14500*coeff) then                                          
              stded = 12970*coeff                                               
           else if(agi.ge.14500*coeff.and.agi.lt.16500*coeff) then              
              stded = 12970*coeff - (agi - 14500*coeff)*.166                    
           else if(agi.ge.16500*coeff.and.agi.lt.80148*coeff) then              
              stded = max(0.0d0,                                                
     &        12638*coeff-.19775*max(0.d0,agi - 16500*coeff))                   
           endif                                                                
         else if(law.ge.2016) then                                              
c The standard deduction is increased for married persons jointly and sep 2016  
           if(agi.lt.21360*coeff) then                                          
              stded = 19010*coeff                                               
           else if(agi.ge.21360*coeff.and.agi.lt.117477*coeff) then             
              stded = 19010*coeff - (agi - 21360*coeff)*.19778                  
           else                                                                 
              stded = 0                                                         
           endif                                                                
         endif                                                                  
        else                                                                    
c for married separately                                                        
         if(law.le.2015) then                                                   
           b = 6920*coeff                                                       
           c = 8000*coeff                                                       
           if(agi.le.b) then                                                    
                stded = 6160*coeff                                              
           elseif(agi.gt.b.and.agi.le.c) then                                   
                stded = max(0.0d0,6160*coeff-(agi-b)*.156)                      
           else                                                                 
                stded = max(0.0d0,4996*coeff-(agi-c)*.198)                      
           endif                                                                
         else if(law.ge.2016) then                                              
           b = 10140*coeff                                                      
           c = 55797*coeff                                                      
           if(agi.le.b) then                                                    
                stded = 9030*coeff                                              
           else if(agi.gt.b.and.agi.le.c) then                                  
                stded = max(0.0d0,9030*coeff-(agi-b)*.19778)                    
           else                                                                 
                stded= 0                                                        
           endif                                                                
         endif                                                                  
        endif                                                                   
      endif                                                                     
c Standard deduction for Dependents                                             
      if(data(105).gt.0.d0) then                                                
        stded = min(stded,max(1050.d0,comnew(37) + 350.d0))                     
      endif                                                                     
c  low income allowance only before 1986                                        
      lowinc = 0.                                                                 
      nold = int(data(9))                                                              
      idep = int(data(8))+2                                                           
      if(law.le.1978)depadd=tablki(dept77,7,agi,data)                           
      if(law.ge.1979)depadd=tablki(dept79,9,agi,data)                           
      if(law.le.1978) then                                                      
        if(mar.eq.1.and.nold.eq.0) then                                         
          lowinc=witab(s077,tb2,8,11,agi,idep,depadd)                           
        else if(mar.eq.1.and.nold.eq.1) then                                    
          lowinc=witab(s177,tb2,5,14,agi,idep,depadd)                           
        else if(mar.eq.2.and.nold.eq.0) then                                    
          lowinc=witab(m077,tb2,9,17,agi,idep,depadd)                           
        else if(mar.eq.2.and.nold.eq.1) then                                    
          lowinc=witab(m177,tb2,5,21,agi,idep,depadd)                           
        else if(mar.eq.2.and.nold.eq.2) then                                    
          lowinc=witab(m277,tb2,9,17,agi,idep,depadd)                           
        endif                                                                   
      else if(law.ge.1979.and.law.le.1985) then                                 
        if(mar.eq.1.and.nold.eq.0) then                                         
          lowinc=witab(s079,tb2,3,10,agi,idep,depadd)                           
        else if(mar.eq.1.and.nold.eq.1) then                                    
          lowinc=witab(s179,tb2,3,14,agi,idep,depadd)                           
        else if(mar.eq.2.and.nold.eq.0) then                                    
          lowinc=witab(m079,tb2,3,12,agi,idep,depadd)                           
        else if(mar.eq.2.and.nold.eq.1) then                                    
          lowinc=witab(m179,tb2,3,15,agi,idep,depadd)                           
        else if(mar.eq.2.and.nold.eq.2) then                                    
          lowinc=witab(m279,tb2,3,19,agi,idep,depadd)                           
        endif                                                                   
      endif                                                                     
      stded=max(stded,lowinc)                                                   
c    Itemized Deductions                                                        
c    become credit after 1986                                                   
      inrst=int(data(56)+data(57))                                                   
      contr=data(58)+data(59)+data(60)                                          
      if(law.le.1985) then                                                      
        xitded=comnew(30)                                                       
c       if(law.le.1983)xitded=xitded+comnew(76)                                 
        if(law.ge.1979.and.law.le.1985) then                                    
          xitded=xitded+min(data(65),100.*txp)                                  
          xitded=max(0.d0,xitded-data(50)-data(51)-data(52)-data(55))           
        endif                                                                   
      else if(law.ge.1986) then                                                 
        health=comnew(20)                                                       
        xitded=health+contr+inrst                                               
        if(law.ge.1987)xitded=xitded+data(26)+                                  
     &          max(0.0d0,data(63)-.02*comnew(2))+data(66)                      
      endif                                                                     
      xitded = max(0.0d0,xitded)                                                
      if(law.le.1985) then                                                      
        deduc = max(xitded,stded)                                               
        taxinc = max(0.0d0,agi-deduc)                                           
      else if(law.ge.1986) then                                                 
        deduc = stded                                                           
        taxinc = max(0.0d0,agi-stded)                                           
      endif                                                                     
c Deduction for Exemptions since 2000                                           
      exemp = 0.d0                                                              
      if(law.ge.2000) exemp=ex(law)*(data(8)+data(7))                           
     &+exold(law)*(data(9)+data(10))                                            
      if(data(105).gt.0.d0) exemp = 0.d0                                        
      taxinc=max(taxinc-exemp,0.0d0)                                            
c      write(0,*) 'taxinc agi stded exemp',taxinc,agi,stded,exemp               
c  joint filing not allowed pre-86                                              
      if(law.le.1978) then                                                      
        call look(tab77,taxinc,15,n,statax,1.0d00,-data(2),rt,data)             
      else if(law.ge.1979.and.law.le.1985) then                                 
        call look(tab,taxinc,8,n,statax,1.0d00,-data(2),rt,data)                
      else if(law.eq.1986) then                                                 
        if(mst.eq.2)                                                            
     &   call look(tabj86,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
        if(mst.eq.3.or.mst.eq.4)                                                
     &   call look(tabp86,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
        if(mar.eq.1)                                                            
     &   call look(tabs86,taxinc,4,n,statax,1.0d00,0.0d0,rt,data)               
      else if(law.ge.1987.and.law.le.1997) then                                 
        if(mst.eq.2)                                                            
     &   call look(tabj87,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)               
        if(mst.eq.3.or.mst.eq.6)                                                
     &   call look(tabp87,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)               
        if(mar.eq.1)                                                            
     &   call look(tabs87,taxinc,3,n,statax,1.0d00,0.0d0,rt,data)               
      else if(law.eq.1998.or.law.eq.1999) then                                  
        if(mst.eq.2)                                                            
     &   call look(tabj98,taxinc,3,n,statax,aif98(law),0.0d0,rt,data)           
        if(mst.eq.3.or.mst.eq.6)                                                
     &   call look(tabp98,taxinc,3,n,statax,aif98(law),0.0d0,rt,data)           
        if(mar.eq.1)                                                            
     &   call look(tabs98,taxinc,3,n,statax,aif98(law),0.0d0,rt,data)           
      else if(law.eq.2000) then                                                 
        if(mst.eq.2)                                                            
     &   call look(tab00j,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)               
        if(mst.eq.3.or.mst.eq.6)                                                
     &   call look(tab00n,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)               
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7)                                    
     &   call look(tab00s,taxinc,5,n,statax,1.0d00,0.0d0,rt,data)               
      else if(law.ge.2001.and.law.le.2004) then                                 
        if(mst.eq.2)                                                            
     &   call look(tab01j,taxinc,5,n,statax,aif01(law),0.0d0,rt,data)           
        if(mst.eq.3.or.mst.eq.6)                                                
     &   call look(tab01n,taxinc,5,n,statax,aif01(law),0.0d0,rt,data)           
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7)                                    
     &   call look(tab01s,taxinc,4,n,statax,aif01(law),0.0d0,rt,data)           
      else if(law.eq.2005) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab05s,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab05j,taxy,4,n,stat,1.0d0,0.0d0,rt,data)                    
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.eq.2006) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab06s,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab06j,taxy,4,n,stat,1.0d0,0.0d0,rt,data)                    
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.eq.2007) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab07s,taxinc,6,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab07j,taxy,6,n,stat,1.0d0,0.0d0,rt,data)                    
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.eq.2008) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab08s,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab08j,taxy,5,n,stat,1.0d0,0.0d0,rt,data)                    
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.ge.2009.and.law.le.2012) then                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab09s,taxinc,5,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab09j,taxy,5,n,stat,1.0d0,0.0d0,rt,data)                    
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.eq.2013) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab13s,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab13j,taxy,4,n,stat,1.0d0,0.0d0,rt,data)                    
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.ge.2014.and.law.le.2018) then                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab14s,taxinc,4,n,statax,aif14(law),0.0d0,rt,data)           
        else                                                                    
         taxy = taxinc*sep                                                      
c inna 04.30.2018 do not change to ,-data(2),                                   
         call look(tab14j,taxy,4,n,stat,1.0d0,0.d0,rt,data)                     
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.eq.2019) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab19s,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab19j,taxy,4,n,stat,1.0d0,0.d0,rt,data)                     
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.eq.2020) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab20s,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab20j,taxy,4,n,stat,1.0d0,0.d0,rt,data)                     
         statax = stat/sep                                                      
        endif                                                                   
      else if(law.eq.2021) then                                                 
        if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                               
         call look(tab21s,taxinc,4,n,statax,1.0d0,0.0d0,rt,data)                
        else                                                                    
         taxy = taxinc*sep                                                      
         call look(tab21j,taxy,4,n,stat,1.0d0,0.d0,rt,data)                     
         statax = stat/sep                                                      
        endif                                                                   
                                                                                
      endif                                                                     
      if(law.eq.1979)statax=statax-min(statax*.16,900.0d0)                      
c 10% surtax in 1983                                                            
      if(law.eq.1983)statax=statax*1.1                                          
c      write(0,*) 'statax',statax                                               
c     Credits                                                                   
c  non-refundable credits, taken pre-amnt, ira tax                              
c 1. Personal exemption credits before year 2000.                               
      exempc = 0.                                                               
      if(law.le.1985) then                                                      
          exempc=(20.*txp) + (5*data(9)) + (20*data(8))                         
          if(mst.eq.4.or.mst.eq.7) exempc = exempc + 20.                        
      elseif(law.gt.1985.and.law.le.1996) then                                  
          exempc=(25*data(9)) + (50*data(8))                                    
      elseif(law.gt.1996.and.law.le.1999) then                                  
         exempc =  50.*data(8)                                                  
         if(data(9).gt.0.0d0) then                                              
           if(mst.eq.1.or.mst.eq.4.or.mst.eq.7) then                            
             if(data(159).le.30000) exempc = exempc + 25.                       
             if(data(159).gt.30000.and.data(159).le.31000)                      
     &         exempc = exempc + 25 - .025*(data(159)-30000)                    
           elseif(mst.eq.2) then                                                
             if(data(159).le.40000) exempc = exempc + 25.*data(9)               
             if(data(159).gt.40000..and.data(159).le.41000.)                    
     &         exempc = exempc + 25.*data(9) - .025*(data(159)-40000.)          
           else                                                                 
             if(data(159).le.20000.) exempc = exempc + 25.                      
             if(data(159).gt.20000..and.data(159).le.21000.)                    
     &         exempc = exempc + 25. - .025*(data(159)-20000.)                  
           endif                                                                
         endif                                                                  
      endif                                                                     
c 2. Wisconsin Itemized deduction credit since 1986                             
      xcred = 0.d0                                                              
      ided = int(data(4))                                                            
      if(law.eq.1999.and.ided.eq.-2) xitded=0                                   
      if(law.ge.1986) xcred = .05*max(0.0d0,xitded - stded)                     
c 3. School Property Tax Credit                                                 
c The School property tax/rent credit is 0 for 1999                             
      spcred = 0.d0                                                             
      if(law.eq.1978) then                                                      
        if(data(160).gt.0.0d0) then                                             
          spcred = 40.d0                                                        
        else                                                                    
          spcred = twn(.1*data(51),40.0d0,100.0d0)                              
        endif                                                                   
      else if(law.ge.1979) then                                                 
c numbers are given if Heat Is Included in Rent                                 
        cmax=rmax(law)/sep                                                      
        if(data(160).gt.0.d0) then                                              
          spcred = min(reach(law)*renter(data,comnew)/100,cmax)                 
        else                                                                    
          spcred = min(teach(law)*data(51)/10,cmax)                             
        endif                                                                   
      endif                                                                     
c      write(0,*) 'teach,d51,spcred',teach(law),data(51),spcred                 
c 4. Child and Dependent Care Credit only for 1984 - 1985                       
      chcr = 0.                                                                 
      if(law.eq.1984.or.law.eq.1985)  chcr=.3*comnew(53)                        
c 5. Working Families Tax Credit depends on WAGI. New in 1998.                  
      wcred = 0.                                                                
      if(law.ge.1998.and.data(105).lt.1.0d0) then                               
         if(agi.le.9000.*data(7)) then                                          
           wcred = statax                                                       
         elseif ((agi.le.10000..and.mst.ne.2).or.                               
     &           (agi.le.19000..and.mst.eq.2))  then                            
           if(mst.eq.2) then                                                    
             eline7 = 19.d0-.001*agi                                            
           else                                                                 
             eline7 = 10.d0-.001*agi                                            
           endif                                                                
           wcred = eline7*max(0.0d0,statax -exempc-xcred-spcred)                
         endif                                                                  
      endif                                                                     
c 6.  Earned Income Credit                                                      
      earncr = 0.d0                                                             
c 1984-1985 Wisconsin EIC - 30% of federal EIC                                  
      ieic = int(data(8))                                                            
      if(law.eq.1984.or.law.eq.1985)  then                                      
         earncr=.3*comnew(59)                                                   
c for 1989-1993 % depends on number of children                                 
      elseif(law.ge.1989) then                                                  
c the number of qualifying children = 1                                         
         earned=comnew(37)                                                      
         if(ieic.eq.1) then                                                     
            if(law.ge.1989.and.law.le.1993) then                                
                    earncr=.05*comnew(59)                                       
c Only in 1994 Schedule EICW exists.                                            
            else if(law.eq.1994) then                                           
               earncr = max(0.0d0,min(.012*earned,92.0d0))                      
               if (agi.gt.12570.or.earned.gt.12570)                             
     &          earncr= max(0.0d0,earncr-.008*(max(agi,earned)-12570))          
                if (mst.eq.3.or.mst.eq.6.or.data(105).gt.0.0d0)earncr=0.        
            elseif(law.ge.1995) then                                            
                    earncr=.04*comnew(59)                                       
            endif                                                               
         elseif(ieic.eq.2) then                                                 
c the number of qualifying children = 2                                         
            if(law.ge.1989.and.law.le.1993) then                                
                    earncr=.25*comnew(59)                                       
            elseif(law.eq.1994) then                                            
               earncr = max(0.0d0,min(.063*earned,499.0d0))                     
               if (agi.gt.12570.or.earned.gt.12570)                             
     &          earncr= max(0.0d0,earncr-.045*(max(agi,earned)-12570))          
                if(mst.eq.3.or.mst.eq.6.or.data(105).gt.0.0d0)earncr=0.         
            elseif(law.eq.1995) then                                            
                    earncr=.16*comnew(59)                                       
            elseif(law.ge.1996.and.law.le.2010) then                            
                    earncr=.14*comnew(59)                                       
            elseif(law.ge.2011) then                                            
                    earncr=.11*comnew(59)                                       
            endif                                                               
         elseif(ieic.ge.3) then                                                 
c the number of qualifying children = 3 and more                                
            if(law.ge.1989.and.law.le.1993) then                                
                    earncr=.75*comnew(59)                                       
            elseif(law.eq.1994) then                                            
               earncr = max(0.0d0,min(.188*earned,1496.0d0))                    
               if (agi.gt.12570.or.earned.gt.12570)                             
     &          earncr= max(0.0d0,earncr-.134*(max(agi,earned)-12570))          
                if (mst.eq.3.or.mst.eq.6.or.data(105).gt.0.0d0)earncr=0.        
            elseif(law.eq.1995) then                                            
                    earncr=.50*comnew(59)                                       
            elseif(law.ge.1996.and.law.le.2010) then                            
                    earncr=.43*comnew(59)                                       
            else                                                                
                    earncr=.34*comnew(59)                                       
            endif                                                               
         endif                                                                  
      endif                                                                     
      credit = xcred+exempc+earncr+chcr+spcred+wcred                            
c for years before 1989 EIC was non-refudable                                   
      if(law.le.1988) statax = max(0.0d0,statax-credit)                         
      if(law.ge.1989)                                                           
     &   statax = max(0.0d0,statax-exempc-xcred-spcred-wcred)                   
c           write(0,*) '1 statax',statax                                        
                                                                                
c Additional Taxes                                                              
c alternative minimum tax                                                       
c Wisconsin eliminates AMT, effective for tax years beginning after December 31,
      amt=0.                                                                    
      if(law.ge.1981.and.law.le.1985.and.xitded.gt.10000) then                  
        xtra=(contr+inrst+data(66)-(.6*max(0.0d0,agi)))                         
        xtra=max(0.0d0,xtra)                                                    
        amt=max(0.0d0,(data(81)+comnew(7)+data(18))+xtra-10000.)*.05            
      else if(law.eq.1986) then                                                 
        amt=max(0.0d0,.55*comnew(70))                                           
      else if(law.ge.1987.and.law.le.2018) then                                 
        alminy=comnew(69)-data(22)-comnew(79)                                   
c unemployment compensation subtraction                                         
        if(data(82).gt.0) alminy = alminy - data(82) +                          
     &  min(data(82),.5*max(0.0d0,comnew(2)-phas-comnew(79)-data(22)))          
c capital gain subtraction                                                      
        if(data(68).ge.0.) then                                                 
         alminy = alminy +(ltg(law)*max(data(70),0.0d0))                        
        else if(data(68).lt.0) then                                             
         alminy = alminy +(ltg(law)*max(data(70)+data(68),0.0d0))               
        endif                                                                   
        if(mar.eq.1) then                                                       
          phsout = .25*max(0.0d0,alminy-almphs(law))                            
          alminy = alminy-max(0.0d0,alms(law)-phsout)                           
        else if(mar.eq.2) then                                                  
          phsout = .25*max(0.0d0,alminy-(almphm(law)/sep))                      
          alminy = alminy-max(0.0d0,almm(law)-phsout)                           
        endif                                                                   
c amt -tentative minimum tax                                                    
        amt = max(0.0d0,alminy*.065 - statax)                                   
        statax = statax + amt                                                   
      endif                                                                     
c 7.  Married couple Credit when both spouses are employed since 1986           
c still non-refundable                                                          
      twocrd=0.                                                                 
      if(mst.eq.2) then                                                         
         earh = max(0.0d0,                                                      
     &   data(85)+data(211)+data(212)+.5*data(17)+.5*data(21))                  
         earw = max(0.0d0,                                                      
     &   data(86)+data(214)+data(215)+.5*data(17)+.5*data(21))                  
         earmin = min(earh,earw)                                                
         if(law.ge.1986.and.law.le.1988) then                                   
           twocrd = .025*min(18000.0d0,earmin)                                  
         else if(law.ge.1989.and.law.le.1997) then                              
           twocrd = .02*min(15000.0d0,earmin)                                   
         else if(law.eq.1998) then                                              
           twocrd = .0217*min(14010.0d0,earmin)                                 
         else if(law.eq.1999) then                                              
           twocrd = .025*min(14000.0d0,earmin)                                  
         else if(law.eq.2000) then                                              
           twocrd = .0275*min(16000.0d0,earmin)                                 
         else if(law.ge.2001) then                                              
           twocrd = .03*min(16000.0d0,earmin)                                   
         endif                                                                  
         credit = credit + twocrd                                               
         statax = max(0.0d0,statax-twocrd)                                      
      endif                                                                     
c alternative minimum tax through 2018                                          
      amt = max(0.0d0,amt - statax)                                             
      statax = statax+amt                                                       
c IRA, other retirement plans, MSA's penalties                                  
      iratax=0.0d0                                                              
      if(law.ge.1984) iratax = .33*data(42)                                     
      statax = statax+iratax                                                    
c  filing requirements Who must file?                                           
c     if(mst.ne.2.and.mst.ne.3.and.mst.ne.6) then                               
c       if(hy.lt.(requ(law,1) + requ(law,3)*data(9)))statax=0.                  
c       return                                                                  
c     else                                                                      
c       if(hy.lt.(requ(law,2) + requ(law,3)*data(9)))statax=0.                  
c       return                                                                  
c     endif                                                                     
c     Refundable Credits                                                        
c  9.  Wisconsin Homestead Credit                                               
      pcred=0.                                                                  
      tablea = 0.                                                               
      if(law.eq.1977.or.law.eq.1978) then                                       
       if(data(159).le.9300.0d0) then                                           
c for year 1977,1978                                                            
        ptax = min(800.0d0,data(51) + data(160)/4)                              
        if(data(159).gt.4000)tablea = (data(159)-4000)*.15                      
        tableb = max(0.0d0,ptax - tablea)                                       
        if(tableb.gt.0.and.tableb.le.15) then                                   
           pcred = tableb*.667                                                  
        else if(tableb.gt.15) then                                              
           pcred = tableb *0.8                                                  
        endif                                                                   
       endif                                                                    
      else if(law.ge.1979.and.law.le.1982) then                                 
       if(data(159).le.14000.0d0) then                                          
c for year 1979-1982                                                            
        ptax = min(1000.0d0,data(51) + data(160)/4)                             
        if(data(159).gt.5000.) tablea = (data(159)-5000)*.111                   
        tableb = max(0.0d0,ptax - tablea)                                       
        if(tableb.gt.0.and.tableb.le.15) then                                   
           pcred = tableb*.667                                                  
        else if(tableb.gt.15) then                                              
           pcred = tableb *0.8                                                  
        endif                                                                   
       endif                                                                    
      else if(law.eq.1983.and.data(159).le.15500.0d0) then                      
c for year 1983                                                                 
        ptax = min(1100.0d0,data(51) + data(160)/5)                             
        if(data(159).gt.7000) tablea = (data(159)-7000)*.1294                   
        tableb = max(0.0d0,ptax - tablea)                                       
        if(tableb.gt.0..and.tableb.le.10.) then                                 
           pcred = tableb*1.1                                                   
        elseif (tableb.le.10.) then                                             
           pcred = tableb *0.8                                                  
        endif                                                                   
      elseif(law.ge.1984.and.law.le.1988.and.data(159).le.16500.0d0)then        
c for years 1984-1988                                                           
        ptax = min(1200.0d0,data(51) + data(160)/4)                             
        if(data(159).gt.7400.) tablea = (data(159)-7400)*.13167                 
        tableb = max(0.0d0,ptax - tablea)                                       
        if(tableb.gt.0..and.tableb.le.10.) then                                 
           pcred = tableb*1.1                                                   
        elseif(tableb.gt.10.) then                                              
           pcred = tableb *0.8                                                  
        endif                                                                   
      else if(law.ge.1989.and.law.le.1990) then                                 
c for year 1989-1990                                                            
        hymod = max(0.0d0,data(159) - 250*data(8))                              
        if(hymod.le.18000.0d0) then                                             
          ptax = min(1350.0d0,data(51) + data(160)/4)                           
          if(hymod.gt.8000.) tablea = (hy-8000.)*.135                           
          tableb = max(0.0d0,ptax - tablea)                                     
          if(tableb.gt.0..and.tableb.le.10.0d0) then                            
             pcred = tableb*1.1                                                 
          elseif (tableb.gt.10.) then                                           
             pcred = tableb *0.8                                                
          endif                                                                 
        endif                                                                   
      else if(law.ge.1991) then                                                 
c for years 1991+                                                               
        if(law.le.2009) then                                                    
          hymod = max(0.0d0,hy - 250.*data(8))                                  
        else                                                                    
          hymod = max(0.0d0,hy - 500.*data(8))                                  
        endif                                                                   
        if((law.le.1998.and.hymod.le.19154.d0).or.                              
     &     (law.eq.1999.and.hymod.le.20290.d0).or.                              
     &     ((law.ge.2000.and.law.le.2009).and.hymod.le.24500.d0).or.            
     &     (law.ge.2010.and.hymod.le.24680.d0)) then                            
          ptax = data(51) + data(160)/4                                         
          pmax = 1450.                                                          
          if(law.ge.2010) pmax = 1460.                                          
          ptax = min(pmax,ptax)                                                 
          if(law.le.1998) tablea = max(0.0d0,hymod-8000.)*.13                   
          if(law.eq.1999) tablea = max(0.0d0,hymod-8000.)*.1177                 
          if(law.eq.2000) tablea = max(0.0d0,hymod-8000.)*.0877                 
          if(law.eq.2001) tablea = max(0.0d0,hymod-8000.)*.08855                
          if(law.eq.2002) tablea = max(0.0d0,hymod-8000.)*.08565                
          if(law.ge.2003.and.law.le.2009)                                       
     &    tablea = max(0.0d0,hymod-8000.)*.08788                                
          if(law.ge.2010) tablea = max(0.0d0,hymod-8060.)*.0878459              
          tableb = max(0.0d0,ptax - tablea)                                     
                                                                                
          if(tableb.gt.0.0d0.and.tableb.le.10.0d0) then                         
            pcred = tableb*1.1                                                  
          elseif(tableb.gt.10.) then                                            
            pcred = tableb *0.8                                                 
          endif                                                                 
        endif                                                                   
      endif                                                                     
      credit = credit + pcred                                                   
      statax = statax - pcred                                                   
c EIC becomes refundable in 1989 onward                                         
      if(law.ge.1989) statax = statax-earncr                                    
      return                                                                    
      end                                                                       
c                                                                               
      double precision function witab(tab,tab2,m,n,y,ndx,depadd)                
      implicit double precision(a-h,o-z)                                        
      dimension tab2(2,n), tab(m,n)                                             
      do 20 i=1,n                                                               
         tab2(1,i)=tab(1,i)                                                     
20    continue                                                                  
      plus=max(0,ndx-m)                                                         
      if(ndx.le.m) then                                                         
          do 22 i=1,n                                                           
            tab2(2,i)=tab(ndx,i)                                                
22        continue                                                              
      elseif(ndx.gt.m) then                                                     
          do 24 i=1,n                                                           
              tab2(2,i)=tab(m,i)                                                
24        continue                                                              
       endif                                                                    
       do 30 j=1,n                                                              
         num=j                                                                  
         if(y.le.tab2(1,j)) go to 40                                            
         witab=0.                                                               
30     continue                                                                 
40     witab=tab2(2,num)+(plus*depadd)                                          
       return                                                                   
       end                                                                      
      block data fedbloc                                                        
      implicit double precision(A-H,O-Z)                                        
      common /fed/ zbrack(3,1987:2022),exem(1987:2022)                          
      data zbrack/ 2540.d0, 3760.d0, 2540.d0, 3000.d0, 5000.d0, 4400.d0,        
     9             3100.d0, 5200.d0, 4550.d0, 3250.d0, 5450.d0, 4750.d0,        
     1             3400.d0, 5700.d0, 5000.d0, 3600.d0, 6000.d0, 5250.d0,        
     3             3700.d0, 6200.d0, 5450.d0, 3800.d0, 6350.d0, 5600.d0,        
     5             3900.d0, 6550.d0, 5750.d0, 4000.d0, 6700.d0, 5900.d0,        
     7             4150.d0, 6900.d0, 6050.d0, 4250.d0, 7100.d0, 6250.d0,        
     9             4300.d0, 7200.d0, 6350.d0, 4400.d0, 7350.d0, 6450.d0,        
     1             4550.d0, 7600.d0, 6650.d0, 4700.d0, 7850.d0, 6900.d0,        
     3             4750.d0, 9500.d0, 7000.d0, 4850.d0, 9700.d0, 7150.d0,        
     5             5000.d0,10000.d0, 7300.d0, 5150.d0,10300.d0, 7550.d0,        
     7             5350.d0,10700.d0, 7850.d0, 5450.d0,10900.d0, 8000.d0,        
     9             5700.d0,11400.d0, 8350.d0, 5700.d0,11400.d0, 8400.d0,        
     1             5800.d0,11600.d0, 8500.d0, 5950.d0,11900.d0, 8700.d0,        
     3             6100.d0,12200.d0, 8950.d0, 6200.d0,12400.d0, 9100.d0,        
     5             6300.d0,12600.d0, 9250.d0, 6300.d0,12600.d0, 9300.d0,        
     7             6350.d0,12700.d0, 9350.d0,12000.d0,24000.d0,18000.d0,        
     9            12200.d0,24400.d0,18350.d0,12400.d0,24800.d0,18650.d0,        
     1            12550.d0,25100.d0,18800.d0,12950.d0,25900.d0,19400.d0/        
      data exem /                                                               
     & 1900.d0,1950.d0,2000.d0,2050.d0,2150.d0,2300.d0,2350.d0,2450.d0,         
     & 2500.d0,2550.d0,2650.d0,2700.d0,2750.d0,2800.d0,2900.d0,3000.d0,         
     & 3050.d0,3100.d0,3200.d0,3300.d0,3400.d0,3500.d0,2*3650.d0,               
     & 3700.d0,3800.d0,3900.d0,3950.d0,4000.d0,2*4050.d0,4150.d0,               
     & 4250.d0,4300.d0,4350.d0,4400.d0/                                         
      end                                                                       
compilation date 07/08/22
      implicit double precision(a-h,o-z)
      parameter(nx=47)
      dimension cccage(1960:2023),eicage(1960:2023),ctcage(1960:2023)
      dimension xc(nx)
      logical last,isexe
      integer list(nx),nuse,isgn
      character*1024 line
cftp  character*64 arg
      character*16 vars(2,nx),dnames(nx)
      common/state/t(12)
      common/calc/s(12)
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)
      common/fsrates/ficar,frate,srate
      common/comexe/isexe
      common/nrecc/nrec
      common/newshr/comnew(255)
      common/comold/d(255)
      common/dindiv/data(255)
      common/xcom/x(nx)
      data cccage/4*12.,8*13.,17*15.,35*13./
      data eicage/15*0.,49*19./
      data ctcage/39*0.,25*17./
      data last/.false./
       data vars/
     &  "taxsimid" ,"P", "year"     ,"P", "state"   ,"P","mstat"   ,"P",
     5  "page"     ,"P", "sage"     ,"P", "depx"    ,"P","dep13"   ,"P",
     9  "dep17"    ,"P", "dep18"    ,"P", "pwages"  ," ","swages"  ," ",   
     3  "dividends","P", "intrec"   ," ", "stcg"    ," ","ltcg"    ," ", 
     7  "otherprop"," ", "nonprop"  ," ", "pensions","P","gssi"    ,"P",
     1  "ui"       ,"P", "transfers","P", "rentpaid","P","proptax" ,"P", 
     5  "otheritem","P", "childcare","P", "mortgage","P","scorp"   ," ",
     9  "pbusinc"  ," ", "pprofinc" ," ", "sbusinc" ," ","sprofinc"," ",
     3  "idtl"     ,"P", "mtr"      ,"P", "pui"     ,"P","sui"     ,"P",
     7  "dep6"     ,"P", "dep19"    ,"P", "opt1"    ,"P","opt1v"   ," ",
     1  "opt2"     ,"P", "opt2v"    ," ", "age1"    ,"P","age2"    ,"P",
     5  "age3"     ,"P", "psemp"    ," ", "ssemp"   ," "/
cftp  call getarg(1,arg)
cftp  if(arg.ne.'') open(5,file=arg)
      nrec = 0
      if(isexe) then
      do 1 i=0,100
         extnd(i) = 0.
1     continue
      do 2 i=1,255
        d(i) =0.d0
        data(i) = 0.d0
        comnew(i) = 0.d0
2     continue 
      else
      do 3 i=1,nx
        x(i) = xc(i)
3     continue
      endif
      data(3) = 1.d0
      data(96) = -1.d0
      mtr = 85
      if(isexe) call begin(line,list,nuse,nx,vars,dnames)
100   continue

c If data is http web form, skip reading values
      if(x(33).ne.5.and.isexe) then
        read(5,'(a)',end=999,err=992) line
        if(line.eq." ") goto 100
        if(line(1:2).eq.'--') goto 999
        if(line(1:3).eq.'eod') goto 999
        read(line,*,end=998,err=993) (x(list(i)),i=1,nuse) 
        if(x(1).lt.0)then
          write(*,*) 'Input line (131 chars):' 
          write(*,*) line(1:131)
          write(*,*) 'Becomes:'
          write(*,*) (i,' ',vars(1,i),"=",int(x(i)),i=1,nx)
        endif
      endif
      nrec=nrec+1
      data(100) = x(1)
      data(70) = 0.d0
      data(101) = x(2)
      lawyr = int(data(101))
      data(103) = x(2)
      data(3) = 1.d0
      data(7) = 1.d0
      data(8) = x(7)
      data(105) = 0.
      if(x(4).eq.1.or.x(4).eq.3) then
        if(x(7).eq.0) then 
           data(2) = 1.d0
        else
           data(2) = 4.d0
        endif
      elseif(x(4).eq.2) then 
         data(2) = 2.d0
         data(7) = 2.d0
      elseif(x(4).eq.33) then
         data(2) = 1.d0
      elseif(x(4).eq.66.or.x(4).eq.6) then 
         data(2) = 6.d0
         data(3) = 2.d0
      elseif(x(4).eq.8) then
         data(2) = 1.d0
         data(7) = 0.d0
         data(105) = 1.d0
      elseif(x(4).eq.0) then
         data(2) = 0.
      elseif(x(4).eq.5) then 
         data(2) = 5.
      else
         write(*,*) 'Bad mstat',x(4),"x=",x
         stop 4
      endif
      data(9) = 0.
      if(x(5).ge.65) data(9) = 1.d0
      if(x(6).ge.65) data(9) = data(9) + 1.d0
      data(205) = max(x(5),x(6))
      data(206) = min(x(5),x(6))
      data(17) = 0.d0
      if(x(11).ge.0) then 
         data(85) = x(11)
      else
         data(17) = x(11)
         data(85) = 0.d0
      endif
      if(x(12).ge.0) then 
         data(86) = x(12)
      else
         data(17) = data(17) + x(12)
         data(86) = 0.d0
      endif
      data(11)  = data(85) + data(86)
      data(17)  = x(46)+x(47)
      data(216) = x(47)
      data(12) = 0.d0
      data(24) = 0.d0
      data(200) = 1.d0
      data(201) = 0.d0
      if(data(11).ne.0) then 
        data(201)=data(86)/data(11)
        data(200) = x(7)/data(11)
      endif
      data(12)  = x(13) + .001d0
      data(176) = data(12)
      data(14)  = x(14)
      data(68)  = x(15)
      data(70)  = x(16)
      data(79)  = x(17)
      data(30)  = -x(18) 
      data(20)  = x(19)
      data(91)  = x(20)
      data(180) = x(36)
      data(82) = max(x(21),x(35)+x(36))
      data(41)  = x(22)
      data(160) = x(23)
      data(51)  = x(24)
      data(54)  = x(25)
      data(64)  = x(26)
      data(56)  = x(27)

      data(207) = x(8)
      data(208) = x(9)
      data(203) = x(10)

      do 6 ii=43,45
         if(x(ii).gt.0) then
           if(x(ii).lt.cccage(lawyr)) data(207)=data(207)+1.
           if(x(ii).lt.eicage(lawyr)) data(208)=data(208)+1.
           if(x(ii).lt.ctcage(lawyr)) data(203)=data(203)+1.
         endif
6     continue

      data(209) = data(8) - data(203)
      data(213) = x(28)
      data(211) = x(29)
      data(212) = x(30)
      data(214) = x(31)
      data(215) = x(32)
      data(210) = x(37)
      if(x(39).gt.0) extnd(int(x(39)))=x(40)
      if(x(41).gt.0) extnd(int(x(41)))=x(42)
      if(extnd(89).gt.0) then 
        data(6) = 0.d0
        data(211) = x(3)
        data(212) = x(23)
        data(160) = 0.d0
        data(79)  = x(17) + data(211) + data(212)
      endif
      idtl = int(x(33))
      if(idtl.ge.10) then
        last=.true.
        idtl=idtl-10
      endif
      if(x(34).ne.0) mtr = int(x(34))
      data(159) = data(11) + data(12)  + data(19)  + data(20)
     &          + data(93) + data(82)  + data(91)  + data(41)
     &          + data(14) + data(211) + data(213) + data(214)
     &          + data(215)
     &          + data(79) + max(data(68)+data(70),0.d0)
      call check(idtl,mtr,x,nx,data,vars)

c FICA tax and rate

      call sstax(data,lawyr)
      fica =  comnew(75)
      if(data(2).eq.0) fica = 0.d0
      if(mtr.eq.85) then
         ficar = comnew(148)
      elseif(mtr.eq.86) then
         ficar = comnew(149)
      elseif(mtr.eq.11) then
         ficar = comnew(150)
      else
         ficar = 0.
      endif
      ficar = ficar*100

c -1 is a special state code meaning do all states

      if(x(3).eq.-1) then
         is=1
         if=51
      elseif(x(3).eq.-3.d0) then
         is=1
         if=10
      else
         is=int(x(3))
         if=is
      endif
      
      diff = .01d0
      if(extnd(52).ne.0d0) diff=extnd(52)
      datmtr = data(mtr)
      data85 = data(85)
      data86 = data(86)
      dat159 = data(159)
      data11 = data(11)
      data(93) = 1.d0
      do 11 istate=is,if
         data(mtr) = datmtr
         data(11) = data85 + data86
         data(85) = data85
         data(86) = data86      
         data(159) = dat159
         data(6) = istate
         call tcalc (data,lawyr)
         if(data(1).lt.-2) then
            write(90,900)(data(i),i=1,210),
     &       (comnew(i),i=1,210)
900      format(21(10f12.2/)///21(10f12.2/)///)
            write(90,*)
     &'hy      rent    agi     exemp   stded   xitded  taxinc  pcred   c
     &hcr    earncr  credit  rt'
            write(90,'(a96)')
            write(90,'(12f8.0)') s
            write(90,'(27/)')
         endif
         do 8 i=1,255
            d(i) = comnew(i)
8        continue
         if(data(100).le.-1) then
            write(*,*) ' data='
            write(*,'(21(10f9.2/)//)') (data(i),i=1,210)
            write(*,*) ' comnew='
            write(*,'(21(10f9.2/)//)') (d(i),i=1,210)
            write(*,'(6f10.2)') s
         endif
         s(1) = dat159
         do 9 i=1,12
            t(i) = s(i)
9        continue
         fold = comnew(1)
         agiold = comnew(2)
         sold = comnew(74)
         if(extnd(89).gt.0) sold=comnew(181)
         frate = 0.
         srate = 0.
         do 10 isgn=1,-1,-2
           if(mtr .ne.0) then 
              if(idtl.eq.5) then
                fdiff = isgn*1.d0
              else
                fdiff = isgn*diff
              endif
            data(mtr) = datmtr + fdiff
            if(mtr.lt.47.or.mtr.gt.63)data(159) = dat159 + fdiff
            if(mtr.eq.11) then
               if(data11.ne.0) then
                  data(85) = data85 + fdiff*(data85/data11)
                  data(86) = data86 + fdiff*(data86/data11)
               else
                  data(85) = fdiff/2.d0
                  data(86) = fdiff/2.d0
               endif
            endif
            data(11) = data(85) + data(86)
            call tcalc(data,lawyr)
            s(1) = data(159)
            fnew  = comnew(1)
            snew  = comnew(74)
            frate =100.d0*(fnew - fold)/fdiff
            srate =100.d0*(snew - sold)/fdiff
            ftan  = comnew(72)
            if(abs(frate).lt.100.and.abs(srate).lt.25) goto 11
         endif
10       continue
11    continue
      srate = twn(srate,-99.d0,999.d0)
      frate = twn(frate,-99.d0,999.d0)
      if(isexe)
     &call out(mtr,idtl,x,fold,sold,fica,frate,srate,ficar,data)
      data(mtr) = datmtr
      if(last) goto 999
      if(idtl.eq.5) goto 999
      goto 100
998   continue
      if(nrec.gt.0) then
      write(*,*)'TAXSIM: I/O conversion error on input for record ' 
     & ,nrec+1
      if(i.ne.nuse)write(*,*)'TAXSIM: ',nuse,' items expected '
     & ,'but',i,'were found. At or near record ',x(1)
      write(*,*) 'TAXSIM:Last good read was record ',data(100),
     & ' state ', data(6), ' for year ',data(101), 'nrec',nrec
      write(*,*) (x(ii),ii=1,nuse)
      endif
992   stop 992
993   stop 993
999   continue
      if(nrec.eq.0) then 
        write(*,*) 'TAXSIM: No records read. Communication problem?' 
      endif
      call stop
      end
      subroutine stop
      common/comexe/isexe
      logical isexe
      if(isexe) then
        stop 
      else
        return
      endif
      end

      subroutine check(idtl,mtr,x,nx,data,vars)
      implicit double precision(a-h,o-z)
      dimension x(nx),data(255)
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)
      common/newshr/comnew(255)
      character*8 mslab(8)
      common/nrecc/nrec
      character*16 vars(2,nx)
      data mslab/'Single','Joint',' ','HoH',3*' ','Separate'/
      if(idtl.eq.5) then
        write(*,*)'NBER TAXSIM Model v35 (07/08/22) With TCJA'
        call statax(data,-99,comnew)

        write(*,*)'State law coded through', lawyr
        write(*,*)'Later state laws extrapolated from',lawyr
         iext1 = int(x(4))
        if(mtr.eq.85) then
          write(*,*) 'Marginal tax rate wrt taxpayer earnings.'
        elseif(mtr.eq.17) then
          write(*,*) 'Marginal tax rate wrt non-wage income.'
        elseif(mtr.eq.86) then
          write(*,*) 'Marginal tax rate wrt spouse earning.'
        elseif(mtr.eq.70) then
          write(*,*) 'Marginal rate wrt long-term gains.'
        elseif(mtr.eq.56) then
          write(*,*) 'Marginal rate wrt Mortgage Interest Paid.'
        elseif(mtr.eq.56) then
          write(*,*) 'Marginal rate wrt Other deductions.'
        else
          write(*,*) 'Marginal rate not requested.'
        endif
      endif
      ierr=0
      if(idtl.lt.0d0.or.idtl.gt.15.d0) then
         write(*,*) 'TAXSIM: Debug Flag out of bounds   : ',idtl
         write(*,*) 'TAXSIM: (should not occur)'
         ierr=1
      endif
      
      if((mtr.lt.11.or.mtr.gt.99).and.mtr.ne.0.d0) then
         write(*,*) 'TAXSIM: Request for marginal rate on a code'
            ierr=2
      endif
      
      if(int(abs(data(2))).ge.7.or.int(abs(data(2))).eq.5) then 
         write(*,*) 'TAXSIM: Bad value for mstat',data(2)
         ierr=3
      endif
      if(extnd(92).eq.0) then
      if(data(207).gt.data(208)) then
         write(*,*) 'TAXSIM: More children under 13 than children',
     & ' under 17',data(207),data(208)
         ierr=5
      endif

      if(data(210).gt.data(207)) then
         write(*,*) 'TAXSIM: More children under 6 than under 13',
     &  data(210),data(207)
        ierr=6
      endif

      if(data(207).gt.data(208)) then
         write(*,*) 'TAXSIM: More children under 13 than under 17',
     &  data(207),data(208)
        ierr=6
      endif

      if(data(208).gt.data(8)) then
         write(*,*) 'TAXSIM: More children under 18 than total ',
     & int(data(207)),int(data(208)),int(data(203)),int(data(8))
         ierr=7
      endif

      if(data(8).gt.15.or.data(208).gt.15) then
         write(*,*) 'TAXSIM: More than 15 dependents:',data(8)
         ierr=8
      endif
      endif
      do 100 ii=43,45
         if(x(ii).lt.0..or.x(ii).gt.114) then 
           write(*,*) 'TAXSIM: Improbable dependent age: ',
     &     'age',ii-42,'=',sngl(x(ii)),'not in 0-114.'
           ierr=42
         endif
100   continue
      if(data(8).ne.int(data(8))) then
         write(*,*) 'TAXSIM: depx must be an integer:',data(8)
         ierr=9
      endif

      if(x(5).lt.0.or.x(5).gt.114) then
         write(*,*) 'TAXSIM: Unbelievable primary age:',x(5)
         ierr=10
      endif

      if(x(6).lt.0.or.x(6).gt.114) then
         write(*,*) 'TAXSIM: Unbelievable spouse age:',x(6)
         ierr=11
      endif

      if(x(3).gt.51.d0.or.x(3).lt.-3.d0) then
         write(*,*) 'TAXSIM: State code must be within  [-3,51].',x(3)
         write(*,*) 'TAXSIM: SOI codes are used, not Census codes.'
         ierr=12
      endif

      if(x(3).ne.int(x(3))) then
         write(*,*) 'TAXSIM: State code must be integer.',x(3)
         ierr=13
      endif

      if(x(2).lt.1960d0.or.x(2).gt.2023d0) then
          write(*,*) 'TAXSIM: Federal tax calculator available', 
     & ' 1960 - 2023 only.'
          ierr=14
      endif

      if(x(2).ne.int(x(2))) then
          write(*,*) 'TAXSIM: Tax law year must be integer.',x(2)
          ierr=15
      endif

      if(data(6).ne.0.d0.and.
     &   (x(2).lt.1977)) then
         write(*,*) 'TAXSIM: State tax calculator available 1977+ only'
         ierr=16
      endif

      if(x(4).ne.2d0) then 
        if(x(11)*x(12).ne.0) then
c        if(x(12)+abs(x(31))+abs(x(32))+x(36).ne.0d0) then
           write(*,*) 'TAXSIM: Secondary wage ',x(12)
           write(*,*) 'TAXSIM: Secondary QBI,SSBI ',x(31),x(32)
           write(*,*) 'TAXSIM: Secondary UI',x(36)
           write(*,*) 'TAXSIM: Non-joint return with spousal income'
           write(*,*) 'TAXSIM: Separate filers report only own income'
           ierr=17
           write(*,*) '11*12',x(11)*x(12),x(11),x(12)
        endif
      endif
      if(x(4).ne.2.d0.and.x(6).gt.0d0) then
         write(*,*) 'TAXSIM: Non-joint return with non-zero sage'
         write(*,*) 'TAXSIM: Ages ',x(6)
         ierr=19
      endif
      do 10 i=4,nx
         if(x(i).lt.0.and.vars(2,i).eq."P") then
            ierr=-1
            goto 17
         endif
10    continue
17    continue
      if(ierr.eq.-1) then
c9     write(*,*) 'TAXSIM: Disallowed negative value:', x(i)            
      write(*,*) 'TAXSIM: Item in error            :',i,vars(1,i),x(i)
      endif
      if(ierr.ne.0) then
c8     write(*,*) 'TAXSIM: Record ID                :',x(1)
      write(*,*) 'TAXSIM: Logical Record Number    :',nrec
      write(*,*) 'TAXSIM: Law Year                 :',x(2)
      write(*,*) 'TAXSIM: State id                 :',x(3)
      write(*,*) 'TAXSIM: Data record, as converted:',
     & (int(x(ii)),ii=1,32)
      write(*,*) 'TAXSIM: Abandoning processing    :',ierr      
      write(*,*) 'TAXSIM: Taxsim35 version of      : 04/04/22'
      endif
      if(idtl.eq.5) then 
        write(*,*)
        write(*,*) 'Input Data:                   '
        write(*,3) '    1. Record ID:            ',  x(1)
        write(*,2) '    2. Tax Year:             ',  x(2)
        write(*,2) '    3. State Code:           ',  x(3)
        ms = int(data(2))
1       format(a31,f11.2,1x,a8)
        write(*,1) '    4. Marital Status:       ',  x(4),mslab(ms)
        write(*,2) '  5-6. Age (Txpyr/Spouse):   ',  x(5),x(6)
        write(*,2) '    7. Dependent Exemptions: ',  x(7)
        write(*,2) ' 8-10. #deps for CCC/EIC/CTC:',  data(207),
     &     data(208),data(203)
        write(*,2) '11-12. Wages (Txpyr/Spouse): ',  x(11),x(12)
        write(*,2) '11a12a Self-employment income:',x(46),x(47)
        if(extnd(89).gt.0) write(*,*) 'Not including business income'
        write(*,2) '   13. Dividend Income:      ',  x(13)
        write(*,2) '   14. Interest Received:    ',  x(14)
        write(*,2) '   15. Short Term Gains:     ',  x(15)
        write(*,2) '   16. Long Term Gains:      ',  x(16)
        write(*,2) '   17. Other Property:       ',  x(17)
        write(*,2) '   18. Other Non-Property:   ',  x(18)
        write(*,2) '   19. Taxable Pensions:     ',  x(19)
        write(*,2) '   20. Gross Social Security:',  x(20)
        write(*,2) '   21. Tot/Txpy/Spouse UI   :',  x(21),x(35),x(36)
        write(*,2) '   22. Non-taxable Transfers:',  x(22)
        write(*,2) '   23. Rent Paid:            ',  x(23)
        write(*,2) '   24. Property Taxes Paid:  ',  x(24)
        write(*,2) '   25. Other Itemized Deds:  ',  x(25)
        write(*,2) '   26. Child Care Expenses:  ',  x(26)
        write(*,2) '   27. Mortgage Interest:    ',  x(27)
        write(*,2) '   28. S-Corp profits:       ',  x(28)
        write(*,2) '29 31. Txpy/Spous QBI w/o PO:',  x(29),x(31)
        write(*,2) '30 32. Txpy/Spouse SSTB w PO:',  x(30),x(32)
        write(*,*) ' '
        if(x(40).gt.0) 
     &  write(*,*) '   40. opt1:                 ',int(x(40)),int(x(41))
        if(x(42).gt.0) 
     &  write(*,*) '   42. opt2:                 ',int(x(42)),int(x(43))
      endif
      if(ierr.ne.0) stop 1
      return
2     format(    a31,4f11.2 )
3     format(    a31,2f13.0 )
      end

      subroutine tcalc(data,lawyr)
      implicit double precision(a-h,o-z)
      dimension data(255)
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)
      common/newshr/comnew(255)

      if(data(2).eq.0.) return
c Compulsory itemization
      if(extnd(51).eq.0.or.extnd(51).eq.2) then
        data(4) = -1
        call tcalc2(data,lawyr)
        taxitm = comnew(1) + comnew(74)
      endif
c Compulsory standard deduction
      if(extnd(51).eq.0.or.extnd(51).eq.1) then
        data(4) = -2
        call tcalc2(data,lawyr)
        taxstd = comnew(1) + comnew(74)
      endif

c If itemization is better, use it
      if(extnd(51).eq.0.d0) then 
        if(taxitm.lt.taxstd) then
           data(04) = -1
           call tcalc2(data,lawyr)
        endif
      endif
      if(data(100).lt.0)write(*,*) 'itm,std',taxitm,taxstd
      return
      end

      subroutine tcalc2(data,lawyr)
      implicit double precision(a-h,o-z)
      common/calc/st(12)
      dimension data(255)
      common/newshr/comnew(255)
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)
      data(50)=0.
      lawst = lawyr + int(extnd(79))
        
c100   format(17(10f8.2/)/18(10f8.2/)////)
      iters=3
      if(extnd(91).ne.0.d0) iters=int(extnd(91))
      do 10 i=1,iters
        if(data(100).lt.0) write(*,*) "interation",i
        call nlaw(data,lawyr)
        comnew(74) = 0.
        do 20 ii=1,12
        st(ii) = 0.
20      continue
        if(data(6).ne.0) then
          call statax(data,lawst,comnew) 
          data(50)=max(saletx(data,lawst),comnew(74),0.d0)
        endif
        if(data(100).le.-3) then 
          write(*,*) 'data and comnew after calculation i=',i
          write(*,1)(data(j),j=1,210),(comnew(j),j=1,180)
          write(*,'(12f10.2)') st
        endif
10    continue
c11    continue
      call sstax(data,lawyr)
      if(data(100).le.-2)write(0,1)(data(i),i=1,210),(comnew(i),i=
     & 1,180)
1     format(21(10f10.2/)///18(10f10.2/)///)
      if(data(100).eq.-19)write(19,*)data
      if(data(100).eq.-19)write(19,*)comnew
      return
      end

      subroutine out(mtr,idtl,x,fold,sold,fica,frate,srate,ficar,data)
      implicit double precision(a-h,o-z)
      dimension data(255),x(27)
      character*20 states(0:55)
      character*30 x0,x1
      character*1024 line
      character*62 lab1
      character*144 lab2
      common/newshr/c(255)
      common/calc/s(12)
      common/state/t(12)
      common/comold/d(255)
      common/nrecc/nrec
      data lab1/    
     & 'taxsimid,year,state,fiitax,siitax,fica,frate,srate,ficar,tfica'/
      data lab2/',v10,v11,v12,v13,v14,v15,v16,v17,v18,v19,v20,v21,v22,v2 
     &3,v24,v25,v26,v27,v28,v29,v30,v31,v32,v33,v34,v35,v36,v37,v38,v39,
     &v40,v41,v42,v43,v44,v45'/
      data states/' ',
     & 'Alabama'       ,'Alaska'        ,'Arizona'     ,'Arkansas', 
     & 'California'    ,'Colorado'      ,'Connecticut' ,'Delaware',
     & 'DC'            ,'Florida'       ,'Georgia'     ,'Hawaii', 
     & 'Idaho'         ,'Illinois'      ,'Indiana'     ,'Iowa',   
     & 'Kansas'        ,'Kentucky'      ,'Louisiana'   ,'Maine', 
     & 'Maryland'      ,'Massachusetts' ,'Michigan'    ,'Minnesota',
     & 'Mississippi'   ,'Missouri'      ,'Montana'     ,'Nebraska',
     & 'Nevada'        ,'New Hampshire' ,'New Jersey'  ,'New Mexico', 
     & 'New York'      ,'North Carolina','NorthDakota' ,'Ohio', 
     & 'Oklahoma'      ,'Oregon'        ,'Pennsylvania','Rhode Island', 
     & 'South Carolina','South Dakota'  ,'Tennessee'   ,'Texas', 
     & 'Utah'          ,'Vermont'       ,'Virginia'    ,'Washington',
     & 'West Virginia' ,'Wisconsin'     ,'Wyoming'     , 4*' '/


      if(data(6).ne.0) then
      s(12) = s(12)* 100.
      t(12) = t(12)*100.
      else
      s(12) = 0.
      t(12) = 0.
      endif
      d148=d(148)*100
      d149=d(149)*100
      tfica=d(190)
      lawyr = int(data(101))
      write(x0,'(f20.0)') x(1)
      lenx1=1
      x1=" "
      do 1 i=1,30
         if(x0(i:i).ne.' ') then 
            x1(lenx1:lenx1)=x0(i:i)
            lenx1=lenx1+1
         endif
1     continue
      if(idtl.eq.0) then
      if(data(1).lt.0) then
       write(*,*) 'x1',x1
       write(*,*) 'lawyr',lawyr
       write(*,*) 'd6',int(data(6))
       write(*,*) 'fold',fold
       write(*,*) 'sold',sold
       write(*,*) 'fica',fica
       write(*,*) 'frate',frate
       write(*,*) 'srate',srate
       write(*,*) 'ficar',ficar
      endif
      if(nrec.eq.1) write(*,"( a62)") lab1
 
      write(line,213) x1(1:lenx1),lawyr,int(data(6)),fold,
     &   sold ,fica ,frate,srate,ficar,tfica," //"
        call putlin(line,1024)
      elseif(idtl.eq.2) then
         if(nrec.eq.1) write(*,"(a206)") lab1//lab2
         write(line,200) x1,int(data(101)),int(data(6)),fold,
     &   sold,fica,frate,srate,ficar,tfica,
     &   d( 2), d(78), d(79), d( 3) ,d(83),
     &   d(39), d(34), d(24), d(29), d(28),
     &   d(174), d(51), d(81), d(93), d(53), 
     &   d(59), d(69), d(70), d(52), d(75),
     &   (s(i ),i=1,12),d(182),d(173),d(180),d(186),
     &   " //"
         len=1024
         call putlin(line,1024)
      elseif(idtl.eq.3) then
         if(nrec.eq.1) write(*,"(a200)") lab1//lab2
         write(*,201)x1 ,int(data(101)),int(data(6)),fold,
     &   sold,fica,frate,srate,ficar,
     &   d( 2), d(78), d(79), d( 3) ,d(83),
     &   d(39), d(34), d(24), d(29), d(28),
     &   d(174), d(51), d(81), d(93), d(53), 
     &   d(59), d(69), d(70), d(52), d(75),
     &   (s(i ),i=1,12),d(182),d(173),d(180),d(186)
        if(data(100).eq.-1) write(*,*) 'd(1)',d(1)
      elseif(idtl.eq.5) then
        write(*,*)  'Basic Output:               '
        write(*,6) '   1. Record ID:                ',  x1
        write(*,3) '   2. Year:                     ',  int(x(2))
        write(*,5) '   3. State (SOI code):         ',  int(data(6)),
     &  states(min(55,int(data(6))))
        write(*,2) '   4. Federal IIT Liability:    ',  fold
        write(*,2) '   5. State IIT Liability:      ',  sold
        write(*,2) '   6. SS Payroll Tax Liability: ',  fica
        if(mtr.eq.85) then
          write(*,*) 'Marginal Rates wrt  Earner'
        elseif(mtr.eq.86) then
          write(*,*) 'Marginal Rates wrt Secondary Earner'
        elseif(mtr.eq.11) then 
          write(*,*) 'Marginal Rates wrt Weighted Average Earnings'
        elseif(mtr.eq.17) then
          write(*,*) 'Marginal Rates wrt Other Income'
        elseif(mtr.eq.70) then
          write(*,*) 'Marginal Rates wrt Long-term Gains.'
        elseif(mtr.eq.56) then
          write(*,*) 'Marginal Rates wrt Mortgage and Other Deductions'
        else
          write(*,*) 'No marginal rates requested'
        endif
        write(*,2) '   7. Federal Marginal Rate:    ',  frate
        write(*,2) '   8. State Marginal Rate:      ',  srate
        if(mtr.eq.11) then
           write(*,2) '   9. Weighted Payroll Tax Rate:',  ficar
        elseif(mtr.eq.85) then
           write(*,2) '   9. Taxpayer SS Rate:         ',  d148
        elseif(mtr.eq.86) then
           write(*,2) '   9. Spouse SS Rate:           ',  d149
        else
           write(*,2) '   9. No SS Tax on Other Income:',  0.
        endif
        write(*,2) ' '
        write(*,*) 'Federal Tax Calculation:              Base        +
     &$1'
        write(*,2) '  10. Federal AGI               ',  d(2),c( 2)
        write(*,2) '  11. UI in AGI 1979+           ',  d(78),c(78)
        write(*,2) '  12. Social Security in AGI 84+',  d(79),c(79)
        write(*,2) '  13. Zero Bracket Amount       ',  d( 3),c( 3)
        write(*,2) '  14. Personal Exemptions       ',  d(83),c(83)
        write(*,2) '  15. Exemption Phaseout 1991+  ',  d(39),c(39)
        write(*,2) '  16. Deduction Phaseout 1991+  ',  d(34),c(34)
        write(*,2) '  17. Deductions allowed        ',  d(24),c(24)
        write(*,2) '      QBI deduction             ',  d(181),c(181)
        write(*,2) '  18. Federal Taxable Income    ',  d(29),c(29)
        write(*,2) '  19. Federal Regular Tax       ',  d(28),c(28)
        if(data(101).eq.2000.)
     &  write(*,21) '      (Excludes 2001 Rate Reduction Credit)'
        if(data(101).eq.2001)
     &  write(*,21) '      (Includes 2001 Rate Reduction Credit)'
        write(*,2) '  20. Exemption Surtax 1988-96  ',  d(174),c(174)
        write(*,2) '  21. General Tax Credit 1975-8 ',  d(51),c(51)
        if(int(data(208)).eq.0) then
        write(*,2) '  22. Child Tax Credit*17/22 98+',  d(81),c(81)
        else
        write(*,2) '  22. Child Tax Credit          ',  d(81),c(81)
        endif
        if(lawyr.eq.2009.or.lawyr.eq.2010) then 
        write(*,2) '      Make Work Pay Crdt 2009-10',  d(94),c(94)
        endif
        write(*,2) '  23  Refundable Part           ',  d(93),c(93)
        write(*,2) '  24. Child Care Credit 1076+   ',  d(53),c(53)
        write(*,2) '  25. Earned Income Credit 1975+',  d(59),c(59)
        write(*,2) '  26. Alternative Min Income:   ',  d(69),c(69)
        write(*,2) '  27. AMT                       ',  d(70),c(70)
        if(lawyr.eq.2006.and.d(86)+c(86).gt.0)
     &  write(*,2) '      Telephone Tax Refund      ',  d(86),c(86)
        write(*,2) '  28. Income Tax Before Credits ',  d(52),c(52)
        write(*,2) '  29. FICA                      ',  d(75),c(75)
        write(*,2) '      Taxpayer share of FICA    ',d(190),c(190)
        if(data(6).ne.0) then
          write(*,2)
          write(*,*) 'State Tax Calculation:      '
          write(*,2) '  30. Household Income          ',t(1), s(1)
          write(*,2) '  31. Imputed Rent              ',t(2),s(2)
          write(*,2) '  32. AGI                       ',t(3),s(3)
          write(*,2) '  33. Exemptions                ',t(4),s(4)
          write(*,2) '  34. Standard Deduction        ',t(5),s(5)
          write(*,2) '  35. Itemized Deductions       ',t(6),s(6)
          write(*,2) '  36. Taxable Income            ',t(7),s(7)
          write(*,2) '  37. Property Tax Credit       ',t(8),s(8)
          write(*,2) '  38. Child Care Credit         ',t(9),s(9)
          write(*,2) '  39. EIC                       ',t(10),s(10)
          write(*,2) '  40. Total Credits             ',t(11),s(11)
          write(*,2) '  41. Bracket Rate              ',t(12),s(12)
          write(*,2) '      State Tax after Credits   ',d(74),c(74)
        endif
        if(lawyr.gt.2018) write(*,*) 'TCJA 2018+'
          write(*,*) ' '
          write(*,2) '  42. QBI Deduction             ',d(181),c(181)

        if(lawyr.ge.2013) then
          write(*,*) 'Additional Medicare Taxes 2013+' 
          write(*,2) '  43. Net Investment Income Tax ',d(173),c(173)
          write(*,2) '  44. Medicare Tax on Earnings  ',d(180),c(180)
        endif
        if(lawyr.eq.2020) then
          write(*,*) 'CARES act 2020 only '  
          write(*,2) '  45. CARES Recovery Rebates    ',d(186),c(186)
        endif
        write(*,*)
        write(*,*) 'Decomposition of Federal Marginal Rate'
        write(*,*) '   (taxpayer earned income)'
        write(*,2)
        write(*,*) 'Regular Income Tax'
        write(*,2) '  Bracket rate from X,Y or Z      ',  d( 66)
        write(*,2) '  Deduction Phaseout:             ',  d(102)
        write(*,2) '  Exemption Phaseout:             ',  d(104)
        write(*,2) '  Social Security Phasein:        ',  d(106)
        write(*,2) '  Child Tax Credit:               ',  d(114)
        write(*,2) '  Child Care Credit:              ',  d(116)
        write(*,2) '  Refundable Part of CTC:         ',  d(144)
        write(*,2) '  Earned Income Credit:           ',  d(118)
        write(*,2) '  Surtax on 15% bracket:          ',  d(130)
        write(*,2) '  Exemption Surtax:               ',  d(132)
        write(*,2) '  Unemployment Insurance:         ',  d(134)
        write(*,2) '  Max Tax on Earned Income:       ',  d(140)
        write(*,2) '  Elderly Credit:                 ',  d( 54)
        write(*,2) '  Dependent Care Credit:          ',  d( 53)
        write(*,2) '  Percentage Std Deduction:       ',  d(138)
        write(*,2) '  Medicare tax on Unearned Income:',  d(167)
        write(*,2) '  Cares Recovery Rebates:         ',  d(187)
        write(*,2)
        write(*,*) 'Alternative Minimum Income Tax  '
        write(*,2) '  AMT Bracket Rate          ', d(99)*100
        write(*,2)'  AMT Phaseout          ',d(99)*100.d0*(d(9)-1.d0)
        write(*,2)
        if(d(119).eq.0) then 
        write(*,*) 'Only Regular Tax Relevant'
        else
        write(*,*) 'Only AMT Rate Relevant'
        endif
        write(*,2) '  Total Marginal Rate:      ', d( 72)
        write(*,2) '  FICA w Medicare (t,s):    ',  d148,d149
      endif

2     format( 3x,a31,f11.2,1x,f11.2)
6     format( 3x,a32,a30)
21    format( 3x,a43)
3     format( 3x,a31,i11)
5     format( 3x,a31,i11,8x,a20)
c212   format(a14,",",2(i8,","),43(f14.2,","),f14.2," ",a2)
213   format(a14,",",2(i8,","),6(f14.2,","),f14.2," ",a2)
200   format(a,",",2(i0 ,","),42( f0 .2,","),f0.2, a2)
201   format(a," ",2(i0 ," "),42( f0 .2," "), f0.2,a2)
c202   format(a,",",2(i0 ,","), 5( f0 .2,","), f0 .0)
      return
      end

       subroutine begin(a,list,nuse,nx,vars,dnames)
      implicit double precision(a-z)
      integer nx,i,j,list(nx),nuse,iostat,isget,ispost
c nnames number of known vars in names
c dnames list of names in data first line
c nlist max number of vars in data
c x(i) = z(list(i)) converts ith data element into appropriate place in x
c z(0) must be zero for this to work for missing data elements
      character*16 dnames(nx)
      character*1024 a,b
      character*16 vars(2,nx)
      character*1 c
      namelist /nml/
     &  taxsim, year  , state , mstat ,   page,
     6  sage  , depx  , dep13 , dep17 ,  dep18,
     1  pwages, swages, divide, intrec,   stcg,
     6  ltcg  , otherp, nonpro, pensio,   gssi,
     2  ui    , transf, rentpa, propta, otheri,
     6  childc, mortga, scorp , pbusin, pprofi,
     3  sbusin, sprofi,   idtl,    mtr,    pui,
     6  sui   , dep6  , dep19 ,   opt1,  opt1v,
     4  opt2  , opt2v , age1  ,   age2,   age3,
     6  psemp , ssemp
        common/xcom/
     &  taxsim, year  , state , mstat ,   page,
     6  sage  , depx  , dep13 , dep17 ,  dep18,
     1  pwages, swages, divide, intrec,   stcg,
     6  ltcg  , otherp, nonpro, pensio,   gssi,
     2  ui    , transf, rentpa, propta, otheri,
     6  childc, mortga, scorp , pbusin, pprofi,
     3  sbusin, sprofi,   idtl,    mtr,    pui,
     6  sui   , dep6  , dep19 ,   opt1,  opt1v,
     4  opt2  , opt2v , age1  ,   age2,   age3,
     6  psemp , ssemp
      data ispost/0/
      b=" "
      do 1 i=1,nx
         dnames(i) = " "
         list(i) = 0
1     continue
      a='                                                  '
      nuse=nx
      i=0
2     continue
      read(5,'(a1024)',end=999,err=998) a
      if(a.eq." ") goto 2

c Skip prelimary data, "get" or "multipart form/data".

      i=index(a,":")+index(a,"essage")+index(a,"---")
c       write(*,*) i
      ispost=max(i,ispost) 
      if(i.gt.0) goto 2
      isget=index(a,"&")
c Write HTTP header, if appropriate
c      write(*,*) a,isget,ispost
      if(ispost+isget.gt.0) then
        write(*,'("Content-Disposition: inline")')
        write(*,'("Content-Type: text/plain; charset=UTF-8"//)')
      endif

c Here for http "get" (will always have ampersands). 
c Collect one data record into namelist.

      if(index(a,'&').gt.0) then 
         b(1:6) = ' $nml '
         do 3 i=1,1017
            b(i+6:i+6)=a(i:i)
            if(a(i:i).eq.'&') b(i+6:i+6)=','
            if(a(i:i).eq.' ') then
              b(i+7:i+7) = '/'
              goto 4
            endif
3        continue
4        continue
         read(b,nml)
         write(*,*) b

      elseif(index(a,"mstat").gt.0.and.index(a,"year").gt.0) then

c Here for CSV file using http "multipart form/data". Collect only
c variable list from first line of csv. Write csv header.

         read(a,*,end=7,iostat=iostat) dnames
7        continue

         do 9 i=1,nx
            if(dnames(i).eq.' ') goto 99
            do 8 j=1,nx
               if(dnames(i).eq.vars(1,j)) list(i) = j
8           continue
            if(list(i).eq.0) then 
               write(*,*) "TAXSIM: ERROR ",dnames(i),
     &         " is not a taxsim35 input variable."

               do 11 j=1,16
                  c=dnames(i)(j:j)
                  if(c.ge.' '.and.c.le.'~') goto 11
                  write(*,*) "TAXSIM: Name with unprintable character"
                  write(*,'(a22,z2)') "TAXSIM: Hex value is:",c
11             continue
               stop 901
             endif
9        continue
c10       continue
99       continue
         nuse = i-1
      else      
         write(*,*) 'TAXSIM: Need at least mstat and year'
         write(*,*) 'a(1:131)='
         write(*,*) a(1:131)
         stop 25
      endif

      return
998   stop 998
999   stop 999
      end
      subroutine putlin(a,n)
      character*1024 a
      character*8 format
      j=0
      do 10 i=1,n
        if(a(i:i).ne." ") then
          if(a(i:i).eq."/") goto 20
          j=j+1
          a(j:j)=a(i:i)
        endif
10      continue
20    continue
      format(1:2)="(a"
      format(7:7)=")"
      write(format(3:6),'(i4)') j
      write(*,format) a(1:j)
      return
      end
      block data dllexe
      implicit double precision(a-h,o-z)
      logical isexe
      common/comdll/dll
      common/comold/d(255)
      common/psubr/dummies(13),extnd(0:100)
      common/dindiv/data(255)
      common/comexe/isexe
      common/newshr/comnew(255)
      data isexe/.true./
      data dummies/13*0./
      data extnd/101*0./
      data comnew/255*0./
      data d/255*0./
      end
c   ****************************************************************************
c                                                                               
c   2018 NEW Tax law (Trump)             !!   setax = comnew(175)  !!           
c   FEDERAL TAX LAW  1960 to 2023           do not rename c150 (Inna 09.07.2016)
c   Modified 06/10/2022  extnd(91)          National Bureau of Economic Research
c   use extnd if you need :23 through 36,62, and 67 (01.01.2022)                
c   12/16/2019 updates for Social Security maximum tax earnings                 
c   03/27/2020 updates for qbi (d211) and sstb (d212)                           
c   01/11/2021 recovery credit (EEPE1 & EEPE2)                                  
c   01/12/2021 2021 tax actual numbers                                          
c   02/04/2021 cash contributions updates for CARES                             
c   03/23/2021 unemployment income exclusion update for 2020                    
c   04/15/2021 < $150k AGI limit for the unemployment compensation exclusion    
c   04/21/2021 exact amounts for QBID phaseouts for 2019(including separate retu
c   05/20/2021 additional part of non-refundable 2021 CTC                       
c   11/14/2021 data(216) se income of Secondary Taxpayer, data(17) total se inco
c   11/18/2021 2022 actual numbers https://taxfoundation.org/2022-tax-brackets/ 
c   11/19/2021 2021 disqualified invest income is up to $10000(from $3650 in 202
c   01/20/2022 2021 Recovery Rebate Credit                                      
c   ****************************************************************************
c                                                                               
      subroutine nlaw(data,lawyr)                                               
      implicit double precision (A-H,O-Z)                                       
      common /newshr/ comnew(255)                                               
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      dimension data(255)                                                       
      integer lawyr                                                             
      do 1 i=1,255                                                              
      comnew(i)=0.                                                              
1     continue                                                                  
      call sstax(data,lawyr)                                                    
      if (lawyr.lt.1960.or.lawyr.gt.2023) then                                  
         write (*,*) 'LAWYR ',lawyr,'  must be in range [1960 .. 2023]'            
        stop 666                                                                
      endif                                                                     
      mstat = int(data(2))                                                           
      if (mstat.lt.1.or.mstat.gt.7) then                                        
        write(*,*) 'Marital Status must be in range [1..7] '                      
        write(*,*) 'Year',data(103),' Value',mst,' Record',data(100)           
      continue                                                                  
      endif                                                                     
c      data(3) = 1.                                                             
c      if(mstat.eq.3.or.mstat.eq.6) data(3) = 2.                                
      i = int(extnd(49))                                                             
      if(i.gt.0) then                                                           
        datai = data(i)                                                         
        data(i) = 0.                                                            
      endif                                                                     
      if (lawyr.le.1976) call law60(data,lawyr)                                 
      if (lawyr.ge.1977.and.lawyr.le.1986) call law79(data,lawyr)               
      if (lawyr.ge.1987.and.lawyr.le.2023) call law87(data,lawyr)               
      if(comnew(29).eq.0.) comnew(100)=0.                                       
      if(i.gt.0) data(i) = datai                                                
c                                                                               
      return                                                                    
      end                                                                       
c                                                                               
c    ******************************************************************         
c      Payroll Tax Calculator for tax Years 1960 to 2013                        
c      Share of husband/wives wages gotten from data(201)                       
c      Payroll tax value returned by comnew(75)                                 
c      Employer contributions are fully borne by employee                       
c    *******************************************************************        
      subroutine sstax(data,lawyr)                                              
      implicit double precision (A-H,O-Z)                                       
      integer sepret                                                            
      dimension data(255)                                                       
      dimension himax(1960:2023),trate(1960:2023)                               
      dimension hrate(1960:2023),strate(1960:2023),shrate(1960:2023)            
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common /xndxac/ xndxa(1981:2023)                                          
      common /ssmaxa/ ssmax(1960:2029)                                          
      common /newshr/ comnew(255)                                               
      common /ssa/                                                              
     &fica,fica1,fica2,oas,oas1, oas2,oasw1,oasw2,oasb1,oasb2,                  
     1c11,c12,hi,hi1,hi2, hiw1,hiw2,hib1,hib2,earn,                             
     2earn1,earn2,smax,hmax,wages, wage1,wage2,owrate,obrate,hwrate,            
     3hbrate                                                                    
                                                                                
      data himax/                                                               
     6   4800.,   4800.,   4800.,   4800.,   4800.,                             
     6   4800.,   6600.,   6600.,   7800.,   7800.,                             
     7   7800.,   7800.,   9000.,  10800.,  13200.,                             
     7  14100.,  15300.,  16500.,  17700.,  22900.,                             
     8  25900.,  29700.,  32400.,  35700.,  37800.,                             
     8  39600.,  42000.,  43800.,  45000.,  48000.,                             
     9  51300., 125000., 130200., 135000.,   9e10 ,                             
     9   9e10 ,   9e10 ,   9e10 ,   9e10 ,   9e10 ,                             
     &   9e10 ,   9e10 ,   9e10 , 21* 9e10/                                     
c                                                                               
c  trate is the total tax rate (OASDI plus HI)                                  
c  hrate is the HI rate                                                         
c  note that in 1984, employer contribution was only 6.7%                       
c                                                                               
      data trate/                                                               
     6  .03000, .03000, .03125, .03625, .03625,                                 
     6  .03625, .04200, .04400, .04400, .04800,                                 
     7  .04800, .05200, .05200, .05850, .05850,                                 
     7  .05850, .05850, .05850, .06050, .06130,                                 
     8  .06130, .06650, .06700, .06700, .07000,                                 
     8  .07050, .07150, .07150, .07510, .07510,                                 
     9  .07650, .07650, .07650, .07650, .07650,                                 
     9  .07650, .07650, .07650, .07650, .07650,                                 
     &  .07650, .07650, .07650, 8*.07650,2*.06650,                              
     & 11*.07650 /                                                              
      data hrate/                                                               
     6  .00000, .00000, .00000, .00000, .00000,                                 
     6  .00000, .00350, .00500, .00600, .00600,                                 
     7  .00600, .00600, .00600, .01000, .00900,                                 
     7  .00900, .00900, .00900, .01000, .01050,                                 
     8  .01050, .01300, .01300, .01300, .01300,                                 
     8  .01350, .01450, .01450, .01450, .01450,                                 
     9  .01450, .01450, .01450, .01450, .01450,                                 
     9  .01450, .01450, .01450, .01450, .01450,                                 
     &  .01450, .01450, .01450, 21*.01450/                                      
c                                                                               
c  Self Employment rates, strate is total tax rate, shrate is HI rate           
c  in 1984-1989, there was a non-refundable credit?                             
c  2.7%(1984), 2.3%(1985) and 2.0%(1986-9)                                      
c                                                                               
      data strate/                                                              
     6 .04500, .04500, .04700, .05400, .05400,                                  
     6 .05400, .06150, .06400, .06400, .06900,                                  
     7 .06900, .07500, .07500, .08000, .07900,                                  
     7 .07900, .07900, .07900, .08100, .08100,                                  
     8 .08100, .09300, .09350, .09350, .11300,                                  
     8 .11800, .12300, .12300, .13020, .13020,                                  
     9 .15300, .15300, .15300, .15300, .15300,                                  
     9 .15300, .15300, .15300, .15300, .15300,                                  
     & .15300, .15300, .15300, 8*.15300,2*.14300,                               
     & 11*.15300/                                                               
      data shrate/                                                              
     6  .00000, .00000, .00000, .00000, .00000,                                 
     6  .00000, .00350, .00500, .00600, .00600,                                 
     7  .00600, .00600, .00600, .01000, .00900,                                 
     7  .00900, .00900, .00900, .01000, .01050,                                 
     8  .01050, .01300, .01300, .01300, .02600,                                 
     8  .02700, .02900, .02900, .02900, .02900,                                 
     9  .02900, .02900, .02900, .02900, .02900,                                 
     9  .02900, .02900, .02900, .02900, .02900,                                 
     &  .02900, .02900, .02900, 21*.02900/                                      
c                                                                               
      mstat = int(data(2))                                                           
      sepret = 1                                                                
      if(mstat.eq.3.or.mstat.eq.6) sepret = 2                                   
      wages = data(11)                                                          
      buscom = max(0.0d0,data(17)) + max(0.d0,data(21))                         
      bus = buscom                                                              
     &  + max(0.d0,data(211)) + max(0.d0,data(212))                             
     &  + max(0.d0,data(214)) + max(0.d0,data(215))                             
                                                                                
      if(mstat.ne.2) then                                                       
        wage1 = wages                                                           
        wage2 = 0.                                                              
        bus1 = bus                                                              
        bus2 = 0.                                                               
      else                                                                      
        wage1 = data(85)                                                        
        wage2 = data(86)                                                        
c data(216) - partner's se income/loss                                          
c data(17) - total se income/loss                                               
c sey2 - partner's se income                                                    
c sey1 - taxpayer's se income                                                   
        sey1 = max(0.d0,data(17)-data(216))                                     
        sey2 = max(0.d0,data(216))                                              
c        sey1 = abs(abs(data(17)) - abs(data(216)))                             
c        sey2 = abs(data(216))                                                  
        bus1  = sey1 + max(0.d0,data(211)) + max(0.d0,data(212))                
        bus2  = sey2 + max(0.d0,data(214)) + max(0.d0,data(215))                
      endif                                                                     
      if(lawyr.ge.1990) then                                                    
         bus = .9235*bus                                                        
         bus1 = .9235*bus1                                                      
         bus2 = .9235*bus2                                                      
      endif                                                                     
      earn = bus + wages                                                        
      earn1 = wage1 + bus1                                                      
      earn2 = wage2 + bus2                                                      
                                                                                
      comnew(182) = earn                                                        
c                                                                               
      oas1 = 0.                                                                 
      oas2 = 0.                                                                 
      hi1 = 0.                                                                  
      hi2 = 0.                                                                  
      smax = ssmax(lawyr)                                                       
      if(lawyr.le.2023) then                                                    
        owrate = 2.*(trate(lawyr)-hrate(lawyr))                                 
        obrate = strate(lawyr)-shrate(lawyr)                                    
        hwrate = 2.*hrate(lawyr)                                                
        hbrate = shrate(lawyr)                                                  
        hmax = himax(lawyr)                                                     
      else                                                                      
        owrate = 2.* (trate(2023)-hrate(2023))                                  
        obrate = (strate(2023)-shrate(2023))                                    
        hwrate = 2.*hrate(2023)                                                 
        hbrate = shrate(2023)                                                   
        hmax = himax(2023)*xndxa(lawyr)/xndxa(2023)                             
      endif                                                                     
                                                                                
c                                                                               
      r1o=0.                                                                    
      r1h=0.                                                                    
      r2o=0.                                                                    
      r2h=0.                                                                    
      if (wage1.ge.smax) then                                                   
         oasw1 = owrate*smax                                                    
         oas1 = oasw1                                                           
      elseif (earn1.ge.smax) then                                               
         oasw1 = owrate*wage1                                                   
         oasb1 = obrate*(smax-wage1)                                            
         oas1 = oasw1+oasb1                                                     
      else                                                                      
         oasw1 = owrate*wage1                                                   
         oasb1 = obrate*bus1                                                    
         oas1 = oasw1+oasb1                                                     
         r1o = owrate                                                           
      endif                                                                     
                                                                                
      if (wage1.ge.hmax) then                                                   
         hiw1 = hwrate*hmax                                                     
         hi1 = hiw1                                                             
      elseif (earn1.ge.hmax) then                                               
         hiw1 = hwrate*wage1                                                    
         hib1 = hbrate*(hmax-wage1)                                             
         hi1 = hiw1+hib1                                                        
      else                                                                      
         hiw1 = hwrate*wage1                                                    
         hib1 = hbrate*bus1                                                     
         r1h = hwrate                                                           
         hi1 = hiw1+hib1                                                        
      endif                                                                     
                                                                                
c                                                                               
      if (wage2.ge.smax) then                                                   
         oasw2 = owrate*smax                                                    
         oas2 = oasw2                                                           
      elseif (earn2.ge.smax) then                                               
         oasw2 = owrate*wage2                                                   
         oasb2 = obrate*(smax-wage2)                                            
         oas2 = oasw2+oasb2                                                     
      else                                                                      
         oasw2 = owrate*wage2                                                   
         oasb2 = obrate*bus2                                                    
         oas2 = oasw2+oasb2                                                     
         r2o = owrate                                                           
      endif                                                                     
      if (wage2.ge.hmax) then                                                   
         hiw2 = hwrate*hmax                                                     
         hi2 = hiw2                                                             
      elseif (earn2.ge.hmax) then                                               
         hiw2 = hwrate*wage2                                                    
         hib2 = hbrate*(hmax-wage2)                                             
         hi2 = hiw2+hib2                                                        
      else                                                                      
         hiw2 = hwrate*wage2                                                    
         hib2 = hbrate*bus2                                                     
         r2h = hwrate                                                           
         hi2 = hiw2+hib2                                                        
      endif                                                                     
c                                                                               
      oas = oas1+oas2                                                           
                                                                                
c Additional Medicare Tax .9% on earned income                                  
      addmtx = 0.                                                               
      if(lawyr.ge.2013) then                                                    
        thres = 200000.d0                                                       
        if(mstat.eq.2.or.sepret.eq.2) thres = 250000.d0/sepret                  
        addmtx = .009*max(0.0d0,wages - thres) +                                
     &  .009*max(0.0d0,bus - max(0.0d0,thres - wages))                          
        if(addmtx.gt.0) then                                                    
             r1h = r1h + .009                                                   
             r2h = r2h + .009                                                   
             hi1 = hi1 + addmtx*(wage1 + bus1)/(wages+bus)                      
             hi2 = hi2 + addmtx*(wage2 + bus2)/(wages+bus)                      
        endif                                                                   
      endif                                                                     
      comnew(180) = addmtx                                                      
      if(comnew(180).gt.0.d0) comnew(185) = .009d0                              
                                                                                
c total SS + Medicare taxes paid by a taxpayer                                  
      ssmed = .5*(oasw2+oasw1+hiw2+hiw1)+oasb2+oasb1+hib2+hib1+addmtx           
      comnew(190) = ssmed                                                       
                                                                                
      hi  = hi1+hi2                                                             
                                                                                
      sur1 = 0.                                                                 
      sur2 = 0.                                                                 
      brk = extnd(37)                                                           
      if(brk.gt.0) then                                                         
         sur1 = owrate*max(0.0d0,earn1-brk)                                     
         sur2 = owrate*max(0.0d0,earn2-brk)                                     
         fica = fica + sur1 + sur2                                              
         if(sur1.gt.0) r1o = owrate                                             
         if(sur2.gt.0) r2o = owrate                                             
      endif                                                                     
      fica1 = oas1+hi1+sur1                                                     
      fica2 = oas2+hi2+sur2                                                     
c      write(0,*) 'oas1+hi1+sur1',oas1,hi1,sur1                                 
c      write(0,*) 'oas2+hi2+sur2',oas2,hi2,sur2                                 
                                                                                
      fica = oas+hi                                                             
      if(fica.le.0) fica = 0.                                                   
      comnew(75)  = fica                                                        
      comnew(148)  = r1o+r1h                                                    
      comnew(149)  = r2o+r2h                                                    
      comnew(150) = 0                                                           
      if(earn.gt.0)                                                             
     & comnew(150) = comnew(148)*earn1/earn + comnew(149)*earn2/earn            
c SE tax calculation based on reported 'wage1','wage2',and 'bus1','bus2'        
c      exwage = max(0.d0,smax-wages)                                            
c      bussst = .124*min(exwage,bus)                                            
c      busmed = .029*bus                                                        
c      setax = bussst + busmed                                                  
      exwag1 = max(0.d0,smax-wage1)                                             
      busss1 = .124*min(exwag1,bus1)                                            
      busmd1 = .029*bus1                                                        
      exwag2 = max(0.d0,smax-wage2)                                             
      busss2 = .124*min(exwag2,bus2)                                            
      busmd2 = .029*bus2                                                        
      busmed = .029*bus                                                         
      if(mstat.eq.2) busmed  = busmd1 + busmd2                                  
      setax = busss1 + busss2 + busmed                                          
c Primary taxpayer Social Security and Medicare taxes                           
      comnew(183) = fica1+busss1+busmd1                                         
c Secondary taxpayer Social Security and Medicare taxes                         
      comnew(184) = fica2+busss2+busmd2                                         
c      write(0,*) 'fica1+busss1+busmd1',fica1,busss1,busmd1                     
c      write(0,*) 'fica2+busss2+busmd2',fica2,busss2,busmd2                     
                                                                                
c Total SE TAXES                                                                
      comnew(175) = setax                                                       
c Self-Employment Income Imputation based on data(43)                           
      if(data(43).gt..153*smax) then                                            
         sey = (data(43) - .124*smax)/(.029*.9235)                              
      else                                                                      
         sey = data(43)/(.153*.9235)                                            
      endif                                                                     
      if(lawyr.eq.2011.or.lawyr.eq.2012) then                                   
        if(data(43).gt..133*smax) then                                          
         sey = (data(43) - .104*smax)/(.029*.9235)                              
       else                                                                     
         sey = data(43)/(.133*.9235)                                            
       endif                                                                    
      endif                                                                     
      comnew(76) = sey                                                          
      return                                                                    
      end                                                                       
c                                                                               
c                                                                               
c    ******************************************************************         
c              1960 to 1979 Law   (1979 law is not used)                        
c    ******************************************************************         
c                                                                               
      subroutine law60(data,lawyr)                                              
      implicit double precision (A-H,O-Z)                                       
      dimension data(255)                                                       
      dimension ebs(1971:1979),ebm(1971:1979),ebh(1971:1979),                   
     & ebsep(1971:1979)                                                         
      dimension eas(1971:1979),eam(1971:1979),eah(1971:1979),                   
     & easep(1971:1979)                                                         
      integer sepret, lawyr                                                     
      double precision kghlim,ira,keogh,ints,iralim,iramax                      
      double precision invest                                                   
      common /newshr/                                                           
     &tax  ,agi,zbr,divall,fullcg, capgn,capded,schede,com09,retlim,            
     1iralim,ira,kghlim,keogh,com15, dislim,adjust,drugs,hins,edical,           
     2cash,asset,char,deduc,polcon, cded,taxy,regtax,taxinc,deducp,             
     3dedint,twoded,almpay,dedphs,exded, pref,earned,psinc,com39,com40,         
     4eacc,eti,etax,avrinc,acgtax,  acgsav,avrtax,calt,com49,altax,             
     5gencr,taxbc,chcr,elder,exagi, edcred,candid,credit,earncr,taxsoi,         
     6eitc,offset,addmin,addtax,ti, rgrate,yad,exemps,alminy,almtax,            
     7com71,rate,com73,statax,fica, com76,pretax,untax,ssagi,excess,            
     8chcred,disab,amex,ssa,com85, c86,capinc,c88,c89,bp,                       
     9 c91, c92, c93, c94, c95, c96, c97, c98,almrat,regrat,                    
     &c101,c102,c103,c104,c105,c106,pira,rira,pdical,rdical,                    
     &pchar,rchar,c113,c114,pchild,rchild,peic,reic,palm,ralm,                  
     &c121,c122,c123,c124,c125,c126,c127,c128,c129,c130,                        
     &c131,c132,punemp,runemp,pold,rold,pzbr,rzbr,petax,retax,                  
     &pgen,rgen,c143,c144,c145,c146,c147,c148,c149,c150,                        
     &c151,c152,c153,taxaft,taxnoa,c156,c157,c158,c159,c160,                    
     &c161,c162,c163,c164,c165,c166,c167,c168,c169,c170,                        
     &c171,c172,c173,c174,c175,c176,zbrst,comadd(78)                            
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      data ebs/6*38000.,2*40200.,41500./                                        
      data ebm/6*52000.,2*55200.,60000./                                        
      data ebh/6*38000.,2*40200.,44700./                                        
      data ebsep/8*26000.,28300./                                               
      data eas/8*13290.,13392./                                                 
      data eam/8*18060.,19678./                                                 
      data eah/8*12240.,13961./                                                 
      data easep/8*9030.,9839./                                                 
c  Marital status and sepret                                                    
      mstat = int(data(2))                                                             
      sepret=1                                                                  
      nfile=2                                                                   
      if(mstat.eq.1) then                                                       
        nfile=1                                                                 
      elseif(mstat.eq.3.or.mstat.eq.6) then                                     
        sepret=2                                                                
      elseif(mstat.eq.4.or.mstat.eq.7) then                                     
        nfile=3                                                                 
      endif                                                                     
c   Taxable income                                                              
      div = data(12)                                                            
      divexc = 50.                                                              
      if(mstat.eq.2) divexc = 2*divexc                                          
      if(lawyr.gt.1964) divexc = 2*divexc                                       
      if(data(176)+data(177).gt.0.0d0) then                                     
        divall = max(0.0d0,data(176)+data(177)-divexc)                          
      else                                                                      
        divall = max(0.0d0,data(12)-divexc)                                     
      endif                                                                     
      ints=data(14)                                                             
c  capgn- taxable capital gains and losses  Schedule D                          
      capded = 0.                                                               
      caprat = .6                                                               
      if(lawyr.lt.1978) caprat = .5d0                                           
      if(lawyr.eq.1978) caprat = .167d0*.6d0+.833d0*.5d0                        
      if(lawyr.ge.1978) clslim = -3000.d0/sepret                                
      if(lawyr.eq.1977) clslim = -2000.d0/sepret                                
      if(lawyr.le.1976.and.lawyr.ge.1971) clslim = -1000.d0/sepret              
      if(lawyr.le.1970) clslim = -1000.d0                                       
      fullcg=data(68)+data(70)                                                  
      capgn = fullcg                                                            
      if(fullcg.gt.0.) then                                                     
        if(data(70).gt.0.) then                                                 
          capded=caprat*data(70)                                                
          if(data(68).lt.0.)                                                    
     &       capded= max(0.0d0,fullcg*caprat)                                   
          capgn=fullcg-capded                                                   
        endif                                                                   
      else                                                                      
        if(lawyr.le.1976) then                                                  
           capgn =max(clslim,fullcg)                                            
        else                                                                    
          if(data(70).lt.0.) capgn = 0.5*fullcg                                 
          if((data(68).lt.0).and.(data(70).lt.0.))                              
     &       capgn=.5*data(70)+data(68)                                         
          capgn = max(clslim,capgn)                                             
        endif                                                                   
      endif                                                                     
c schedule e income                                                             
      schede=data(72)+data(73)+data(74)+data(75)+data(77)+data(79)              
c  ti - total income after exclusions                                           
      ti=divall+capgn+schede+data(11)+ints+data(17)+                            
     &(1.-caprat)*data(18)+                                                     
     &data(19)+data(20)+data(21)+data(22)+data(23)+data(24)                     
      earned = data(11)+max(0.0d0,data(17))                                     
      unearn = ti-earned                                                        
c  Adjustments to income 1960-79                                                
      bus=data(17)+data(75)+data(79)+data(21)                                   
      retlim=max(0.0d0,.15*bus)                                                 
c     kghlim=min(retlim,7500.0d0)*data(7)                                       
      kghlim=7500*data(7)                                                       
      keogh=min(data(28),kghlim)                                                
      ira=0.                                                                    
      busnet=0.                                                                 
      iramax=0.                                                                 
      iralim=0.                                                                 
      if(lawyr.ge.1975) then                                                    
        iramax=3000.d0/sepret                                                   
        busnet=max(0.0d0,bus-keogh)                                             
        iralim=min(data(11)+busnet,iramax)                                      
        ira=min(data(29),iralim)                                                
      endif                                                                     
      preagi = divall+capgn+schede+data(11)+ints+data(17)+(1.-caprat)*          
     & data(18)+ data(19)+data(20)+data(21)+data(22)+data(23)+data(24)-         
     &           (ira+data(26)+data(27)+keogh+data(30)-data(62))                
      exagi  = max(0.0d0,preagi - 15000.)                                       
      untax = 0.                                                                
      dislim = max(0.0d0,5200. - exagi)                                         
      disab  = min(dislim,data(25))                                             
      twoded = 0.                                                               
      if (mstat.eq.2.and.lawyr.ge.1982) then                                    
         wife     =  min(data(85),data(86))                                     
         twoded   =  min(3000.0d0,.1*wife)                                      
         if (lawyr.eq.1982) twoded = min(1500.0d0,.05*wife)                     
      endif                                                                     
      adjust=ira+data(25)+data(26)+data(27)+keogh+data(30)+twoded               
      if(lawyr.ge.1977) adjust = adjust + data(62)                              
c   AGI                                                                         
      agi = ti-adjust                                                           
      agix = max(0.0d0,agi)                                                     
c   Schedule A                                                                  
c medical deductions                                                            
      drugs = max(0.0d0,data(48)-.01*agix)                                      
      hins = min(150.0d0,.5*data(47))                                           
      edical = max(0.0d0,drugs+data(49)-.03*agix)                               
      if (lawyr.ge.1977)                                                        
     &edical = max(0.0d0,drugs+data(49)-.03*agix+data(47)-hins)                 
      edical=edical+hins                                                        
c charity                                                                       
      alim50 = .5*agix                                                          
      if(agi.lt.0) then                                                         
        cash = 0.                                                               
        asset = 0.                                                              
      else                                                                      
        if(cash.gt.alim50) then                                                 
          cash = alim50                                                         
          asset = 0.                                                            
        else                                                                    
          unchar = alim50-cash                                                  
          asset = min(asset,alim50,unchar)                                      
          asset = max(0.0d0,asset)                                              
        endif                                                                   
      endif                                                                     
      char = cash + asset                                                       
c  casualty or theft loss                                                       
      cas = data(61)                                                            
c  political contributions                                                      
      if (lawyr.le.1974) then                                                   
          polcon = min(50.0d0,data(65))                                         
          if(mstat.eq.2) polcon =  min(100.0d0,data(65))                        
      else                                                                      
          polcon = min(100.0d0,data(65))                                        
          if(mstat.eq.2) polcon =  min(200.0d0,data(65))                        
      endif                                                                     
      dedint = data(56)+data(57)                                                
      deduc=edical+polcon+char+data(50)+data(51)+data(52)+                      
     &data(53)+data(54)+data(55)+dedint+                                        
     &cas+data(63)+data(66)                                                     
c      if(lawyr.eq.1973.or.lawyr.eq.1975) deduc = deduc+data(62)                
      if(lawyr.le.1976) deduc = deduc+data(62)                                  
      if(lawyr.le.1975) deduc = deduc+data(64)                                  
c zbr for [1977,1979]                                                           
      if(lawyr.eq.1978.or.lawyr.eq.1977) then                                   
        zbr = 2200.d0                                                           
        if(nfile.eq.2) zbr = 3200.d0/sepret                                     
      endif                                                                     
      if (lawyr.eq.1979) then                                                   
        zbr = 2300.d0                                                           
        if(nfile.eq.2) zbr = 3400.d0/sepret                                     
      endif                                                                     
c Exemptions for 1960-1976                                                      
      exemps=data(7)+data(8)+data(9)+data(10)                                   
      if(mstat.eq.6.and.(lawyr.ge.1969.and.lawyr.le.1971))                      
     & exemps = exemps + 1                                                      
      if((lawyr.le.1978).and.(lawyr.ge.1972)) then                              
        amex=750.*exemps                                                        
      else if(lawyr.eq.1971) then                                               
        amex=675.*exemps                                                        
      else if(lawyr.eq.1970) then                                               
        amex=625.*exemps                                                        
      else if(lawyr.le.1969) then                                               
        amex=600.*exemps                                                        
      else                                                                      
        amex=1000.*exemps                                                       
      endif                                                                     
      if (lawyr.eq.1976) then                                                   
        if(nfile.eq.2) then                                                     
          zbr=max(min(2800.0d0/sepret,.16d0*agix),2100.0d0/sepret)              
        else                                                                    
          zbr=max(min(2400.0d0,.16*agix),1700.0d0)                              
        endif                                                                   
      elseif (lawyr.eq.1975) then                                               
        if(nfile.eq.2)then                                                      
          zbr=max(min(2600.0d0/sepret,.16*agix),1900.0d0/sepret)                
        else                                                                    
          zbr=max(min(2300.0d0,.16*agix),1600.0d0)                              
        endif                                                                   
      elseif((lawyr.le.1974).and.(lawyr.ge.1972)) then                          
        zbr=max(min(2000.0d0/sepret,.15*agix),1300.0d0/sepret)                  
      elseif (lawyr.eq.1971) then                                               
        zbr=max(min(1500.0d0/sepret,.13*agix),1050.0d0/sepret)                  
      elseif (lawyr.le.1970.and.lawyr.ge.1964) then                             
        zbr=max(min(1000.0d0/sepret,.1*agix),min(1000.0d0/sepret,               
     &     200.d0/sepret+100.*exemps))                                          
      elseif (lawyr.le.1963) then                                               
        zbr=min(1000.0d0/sepret,.1*agix)                                        
      endif                                                                     
c zbrst for state purposes                                                      
      zbrst = zbr                                                               
c  deduc calculated to be the greater of total allowed                          
c  itemized deductions or the standard deduction                                
c  data(4) fixes the itemizer status of the individual for marginal             
c  tax rate calculations if the value is -1 or -2                               
      cded = 0.                                                                 
      excess = 0.                                                               
c      if(data(4).eq.-1.) zbr = 0.                                              
c      if(data(4).eq.-2.) deduc = 0.                                            
      taxy=0.                                                                   
      pzbr=0                                                                    
      if (lawyr.ge.1977) then                                                   
        if (deduc.gt.zbr) then                                                  
          cded=1.                                                               
          excess = deduc - zbr                                                  
        endif                                                                   
        add105 = 0.                                                             
        if (data(105).gt.0..and.unearn.ge.1000.) then                           
c subtract ira so that when ira is limited by earnings, tax be smooth           
           tmp105 = earned - ira                                                
           if (cded.gt.0.) tmp105 = max(tmp105,deduc)                           
           add105 = max(0.0d0,zbr-tmp105)                                       
        endif                                                                   
        yad = agi - deduc + zbr                                                 
        taxy = agi - excess - amex + add105                                     
        if(taxy.lt.0) zbr = max(0.0d0,zbr + taxy)                               
        if(taxy.lt.0.and.zbr.gt.0) pzbr=1                                       
        taxy = max(0.0d0,taxy)                                                  
        taxinc = max(0.0d0, agi - excess - zbr - amex)                          
      else                                                                      
        yad = agi - deduc                                                       
        if (deduc.gt.zbr) then                                                  
          cded = 1.                                                             
          taxinc = max(0.0d0,agi-deduc-amex)                                    
        else                                                                    
          deduc=0.                                                              
          cded=0.                                                               
          taxinc = max(0.0d0,agi-zbr-amex)                                      
        endif                                                                   
      endif                                                                     
c                                                                               
      deducp = deduc                                                            
      dedphs = 0.                                                               
      if(lawyr.le.1970.and.sepret.eq.2) then                                    
         nfile1 = 1                                                             
      else                                                                      
         nfile1 = nfile                                                         
      endif                                                                     
c Don't itemize unless this is a benefit                                        
      if(cded.gt.0.and.taxinc.eq.0.and.agi-amex-zbr.le.0) then                  
         cded = 0.                                                              
         deduc= 0.                                                              
         excess =0.                                                             
      endif                                                                     
c  Tax table calls                                                              
      if (lawyr .le. 1963)                                                      
     &    call tax62(regtax,regrat,nfile1,taxinc)                               
      if (lawyr.eq.1964)                                                        
     &    call tax64(regtax,regrat,nfile1,taxinc)                               
      if (lawyr.ge.1965.and.lawyr.le.1970)                                      
     &    call tax70(regtax,regrat,nfile1,taxinc)                               
      if (lawyr.ge.1971.and.lawyr.le.1976)                                      
     &    call tax74(regtax,regrat,nfile1,sepret,taxinc)                        
      if(lawyr.eq.1977.or.lawyr.eq.1978)                                        
     &    call rtax77(regtax,regrat,nfile1,sepret,taxy)                         
      if(lawyr.eq.1979)                                                         
     &    call rtax79(regtax,regrat,nfile1,sepret,taxy)                         
      if(taxinc.eq.0) regrat=0.                                                 
      rgrate   =  regrat*100                                                    
c   Alternative computation of tax (for capital gains)                          
      acgtax = -1.                                                              
      garb=0.                                                                   
      garb1=0.                                                                  
      garb2=0.                                                                  
      if (fullcg.gt.0..and.lawyr.le.1978) then                                  
        cg1 = max(taxinc - capded,0.0d0)                                        
        if (lawyr.eq.1977.or.lawyr.eq.1978) then                                
            cg1 = max(taxy - capded,0.0d0)                                      
            call rtax77(cgtx1,garb1,nfile1,sepret,cg1)                          
        else if(lawyr.ge.1971.and.lawyr.le.1976) then                           
            call tax74   (cgtx1,garb1,nfile1,sepret,cg1)                        
        else if(lawyr.ge.1965.and.lawyr.le.1970) then                           
            call tax70   (cgtx1,garb1,nfile1,cg1)                               
        else if(lawyr.eq.1964) then                                             
            call tax64   (cgtx1,garb1,nfile1,cg1)                               
        else                                                                    
            call tax62   (cgtx1,garb1,nfile1,cg1)                               
        endif                                                                   
        cgtx2 = .5*capded                                                       
        cgtx3 = 0.                                                              
        if(min(data(70),data(68)+data(70)).gt.50000.d0/sepret) then             
         if(lawyr.eq.1970) then                                                 
c year 1970                                                                     
          call tax70(xl32,garb,nfile1,max(taxinc,capded))                       
          call tax70(xl33,garb,nfile1,                                          
     &         max(taxinc - capded + 25000.d0/sepret,0.0d0))                    
          cgtx2 = min(max(0.0d0,xl32 - xl33),                                   
     &               .295*max(0.0d0,                                            
     &           min(data(70),data(68)+data(70))-50000.d0/sepret))              
          call tax70(cgtx1,garb1,nfile1,cg1)                                    
          cgtx3 =  .25*50000.d0/sepret                                          
         else if (lawyr.eq.1971) then                                           
c year 1971                                                                     
          call tax74(xl32,garb,nfile1,sepret,max(taxinc,capded))                
          call tax74(xl33,garb,nfile1,sepret,                                   
     &         max(taxinc - capded + 25000.d0/sepret,0.0d0))                    
          cgtx2 = min(max(0.0d0,xl32 - xl33),                                   
     &               .325*max(0.0d0,                                            
     &       min(data(70),data(68)+data(70))-50000.d0/sepret))                  
          call tax74(cgtx1,garb1,nfile1,sepret,cg1)                             
          cgtx3 =  .25*50000.d0/sepret                                          
         else if (lawyr.ge.1972.and.lawyr.le.1975) then                         
c year 1972-1975                                                                
          call tax74(xl32,garb,nfile1,sepret,max(taxinc,capded))                
          call tax74(xl33,garb,nfile1,sepret,                                   
     &         max(taxinc - capded + 25000.d0/sepret,0.0d0))                    
          cgtx2 = max(0.0d0,xl32 - xl33)                                        
          call tax74(cgtx1,garb1,nfile1,sepret,cg1)                             
          cgtx3 =  .25*50000.d0/sepret                                          
         endif                                                                  
        endif                                                                   
        if(lawyr.ge.1976.and.lawyr.le.1978) then                                
c years 1976-1978                                                               
         if(lawyr.ge.1977) then                                                 
c years 1977-1978                                                               
           if (capded * 2..le.50000.d0/sepret) go to 424                        
           call rtax77(cgtx31,garb,nfile1,sepret,taxinc)                        
           call rtax77(cgtx32,garb2,nfile1,sepret,cg1+25000.d0/sepret)          
c  Computation of cgtx3 in Alternative Tax  1975 (Sch.D)                        
         else                                                                   
c years 1976                                                                    
c Refund half tax on sale of principal residence                                
           subd = data(71)                                                      
           cg3  = max(taxinc,capded)                                            
           if (subd.le.50000.d0/sepret) go to 424                               
           subd = 50000.d0/sepret                                               
           call tax74   (cgtx31,garb,nfile1,sepret,cg3)                         
           call tax74   (cgtx32,garb2,nfile1,sepret,cg1+subd*0.5)               
         endif                                                                  
         cgtx2 = max(12500.0d0/sepret,cgtx2)                                    
         cgtx3  = max(0.0d0,cgtx31 - cgtx32)                                    
        endif                                                                   
 424    acgtax = cgtx1 + cgtx2 + cgtx3                                          
      endif                                                                     
c  Preference Income                                                            
      pref = 0.                                                                 
      if (lawyr.le.1978) then                                                   
        exded  = deduc - edical - data(62)-.6*agi                               
        if (exded.gt.agi*.4) exded = agi *.4                                    
        if (exded.lt.0..or.cded.lt.1.) exded = 0.                               
        pref = capded + data(18)+data(81)+data(82)-data(83)+                    
     &         data(84)-data(87)+exded+data(95)                                 
      endif                                                                     
      pref = max(0.0d0,pref)                                                    
      if (lawyr.eq.1979) then                                                   
        prfded = 0.                                                             
        prfddy = 0.                                                             
        prfded = deduc - edical - data(61) - data(50)                           
        prfddy = agi -   edical - data(61) - data(50)                           
        prfddy = max(0.0d0,prfddy)                                              
        exded  = prfded - .6*prfddy                                             
        if (exded.lt.0..or.cded.lt.1.) exded = 0.                               
      endif                                                                     
c  Maximum tax on earned income, data94 is personal service income              
      etax = -1.                                                                
      if (lawyr.le.1979.and.lawyr.ge.1971) then                                 
        if(mstat.eq.1) then                                                     
           ebot = ebs(lawyr)                                                    
           eacc = eas(lawyr)                                                    
        else if(mstat.eq.2.or.mstat.eq.5) then                                  
           ebot = ebm(lawyr)                                                    
           eacc = eam(lawyr)                                                    
        else if(mstat.eq.4.or.mstat.eq.7) then                                  
           ebot = ebh(lawyr)                                                    
           eacc = eah(lawyr)                                                    
        else                                                                    
           ebot = ebsep(lawyr)                                                  
           eacc = easep(lawyr)                                                  
        endif                                                                   
        psinc = earned + max(0.0d0,data(75))+                                   
     &           data(20)+data(72)-data(138)                                    
        if(agi.gt.0) psinc = twn(psinc,0.0d0,agi)                               
        if (sepret.eq.2) go to 444                                              
        if (agi.ne.0.) go to 4422                                               
        eratio = 1.0                                                            
        go to 4424                                                              
 4422   eratio = min(psinc/agi,1.0d0)                                           
        if (agi.le.0.) go to 444                                                
        if (eratio.le.0..or.agi.le.0.) goto 444                                 
 4424   if(lawyr.le.1976) then                                                  
            eti = taxinc*eratio - (max(0.0d0,pref-30000.))                      
            etinc = eti                                                         
        else if(lawyr.ge.1977.and.lawyr.le.1978) then                           
            eti = taxy*eratio-pref                                              
            etinc = eti - zbr                                                   
        else                                                                    
            eti = taxinc*eratio-pref                                            
            etinc = eti                                                         
        endif                                                                   
        etop = eti - ebot                                                       
        if (etop.le.0.) go to 444                                               
        if (lawyr.ge.1971.or.lawyr.le.1976)                                     
     &  call tax74(partax,z,nfile1,sepret,etinc)                                
        if (lawyr.eq.1977.or.lawyr.eq.1978)                                     
     &  call tax77(etinc,sepret,nfile,z,partax)                                 
        if (lawyr.eq.1979) call tax79(etinc,sepret,nfile,z,partax)              
        if(lawyr.ge.1972) etax = regtax - partax + .5*etop +eacc                
        if(lawyr.eq.1971) etax = regtax - partax + .6*etop +eacc                
      endif                                                                     
 444  continue                                                                  
c   Income Averaging 1960-79                                                    
      if (lawyr.lt.1965)  go to 462                                             
      if (data(96).lt.0.) go to 462                                             
      avrinc = taxinc - .3*data(96)                                             
      if (avrinc.lt.3000.) go to 462                                            
c    Income Averaging  1965 - 1970 only                                         
      if (lawyr.ge.1965.and.lawyr.le.1970) then                                 
        call tax70(atax1,arate1,nfile1,.3*data(96)+.2*avrinc)                   
        call tax70(atax2,arate2,nfile1,.3*data(96))                             
      endif                                                                     
c  Income Averaging 1971 - 1976 only                                            
      if (lawyr.ge.1971.and.lawyr.le.1976) then                                 
        call tax74(atax1,arate1,nfile1,sepret,.3*data(96)+.2*avrinc)            
        call tax74(atax2,arate2,nfile1,sepret,.3*data(96))                      
      endif                                                                     
c  Income Averaging 1977 - 1978 only                                            
      if (lawyr.ge.1977.and.lawyr.le.1978) then                                 
        call rtax77(atax1,arate1,nfile1,sepret,.3*data(96)+.2*avrinc)           
        call rtax77(atax2,arate2,nfile1,sepret,.3*data(96))                     
      endif                                                                     
c  Income Averaging 1979 only                                                   
      if (lawyr.eq.1979) then                                                   
        call rtax79(atax1,arate1,nfile1,sepret,.3*data(96)+.2*avrinc)           
        call rtax79(atax2,arate2,nfile1,sepret,.3*data(96))                     
      endif                                                                     
c                                                                               
      avrtax = 4.*(atax1 - atax2) + atax1                                       
      go to 464                                                                 
 462  avrtax = -1.                                                              
 464  continue                                                                  
c  Combine alternative tax                                                      
c        calt = 0 regtax                                                        
c             = 1 alternative tax on gains                                      
c             = 2 maximum tax                                                   
c             = 3 (1) and (2)                                                   
c             = 4 average tax                                                   
      altax  = regtax                                                           
      calt   = 0.                                                               
      acgsav = 0.                                                               
      if(acgtax.gt.0) then                                                      
        acgsav  =  max(0.0d0,regtax-acgtax)                                     
        altax = regtax-acgsav                                                   
        calt    = 1.                                                            
      endif                                                                     
      if (etax.gt.0) then                                                       
        if (etax.lt.altax) then                                                 
            altax = etax                                                        
            calt  = 2.                                                          
        endif                                                                   
        if (etax.lt.regtax.and.acgsav.gt.0) then                                
            altax = etax - acgsav                                               
            calt  = 3.                                                          
        endif                                                                   
      endif                                                                     
      if (avrtax.gt.-1.and.avrtax.lt.altax) then                                
          altax = avrtax                                                        
          calt  = 4.                                                            
      endif                                                                     
      tax = altax                                                               
c IRA marginal rate                                                             
      rira=0.                                                                   
      pira=0.                                                                   
      if(ira.gt.0.and.data(11)+busnet.lt.iramax.and.                            
     &data(29).gt.iralim) then                                                  
         pira=1.                                                                
         rira = -rgrate                                                         
      endif                                                                     
c Charitable contributions marginal rate                                        
      rchar=0.                                                                  
      pchar=0.                                                                  
      if(cded.gt.0..and.char.gt.0.and.agi.gt.0.) then                           
        if(cash.gt..5*agi) then                                                 
         rchar=.5*rgrate                                                        
         pchar=1.                                                               
        else                                                                    
         if(.5*agi.lt.data(59)+data(60).or.                                     
     &    (unchar.lt.data(59)+data(60).and.unchar.gt.0.))then                   
          rchar=.5*rgrate                                                       
          pchar=1.                                                              
         endif                                                                  
        endif                                                                   
      endif                                                                     
c Marginal rate for zbr for years before 1976                                   
      rzbr=0                                                                    
      if(cded.lt.1.and.calt.ne.2.and.pira.eq.0) then                            
       if (lawyr.eq.1976.and.                                                   
     &     ((nfile.eq.2.and.2800./sepret.gt..16*agix.and.                       
     &   .16*agix.gt.2100./sepret).or.(nfile.ne.2.and.                          
     &   2400.gt..16*agix.and..16*agix.gt.1700))) then                          
            pzbr=1                                                              
            rzbr=rgrate*.16                                                     
       elseif (lawyr.eq.1975.and.                                               
     &     ((nfile.eq.2.and.2600./sepret.gt..16*agix.and.                       
     &   .16*agix.gt.1900./sepret).or.(nfile.ne.2.and.                          
     &   2300.gt..16*agix.and..16*agix.gt.1600))) then                          
            pzbr=1                                                              
            rzbr=rgrate*.16                                                     
       elseif(lawyr.le.1974.and.lawyr.ge.1972.and.                              
     &         2000./sepret.gt..15*agix.and.                                    
     &   .15*agix.gt.1300./sepret) then                                         
            pzbr=1                                                              
            rzbr=rgrate*.15                                                     
       elseif (lawyr.eq.1971.and.                                               
     &         1500./sepret.gt..13*agix.and.                                    
     &   .13*agix.gt.1050./sepret) then                                         
            pzbr=1                                                              
            rzbr=rgrate*.13                                                     
       elseif (lawyr.le.1970.and.lawyr.ge.1964.and.                             
     &         1000./sepret.gt..1*agix.and.                                     
     &   .1*agix.gt.min(1000.0d0/sepret,200./sepret+100.*exemps)) then          
            pzbr=1                                                              
            rzbr=rgrate*.1                                                      
       elseif (lawyr.le.1962.and.1000./sepret.gt..1*agix) then                  
            pzbr=1                                                              
            rzbr=rgrate*.1                                                      
       endif                                                                    
      endif                                                                     
c Medical deduction marginal rate                                               
      pdical=0.                                                                 
      rdical=0.                                                                 
      if(cded.gt.0.) then                                                       
       if(edical-hins.gt.0) then                                                
        pdical=1.                                                               
        if(rate.gt.0.) then                                                     
         rdical=.03*rgrate                                                      
         if(data(48).gt..01*agix) rdical=.04*rgrate                             
        endif                                                                   
       endif                                                                    
      endif                                                                     
      rate=rgrate+rira+rdical-rchar-rzbr                                        
      if(lawyr.le.1981.and.calt.eq.1.and.acgtax.lt.regtax.                      
     & and.pira.eq.0) then                                                      
         rate=garb1*100*(1+pdical*.03-pchar*.5)                                 
         if(lawyr.ge.1977)                                                      
     &    rate=(garb1+garb-garb2)*100*(1+pdical*.03-pchar*.5)                   
      endif                                                                     
c Marginal Tax Rate on Maximum Tax on Earned Income                             
      petax=0                                                                   
      retax=0.                                                                  
      if((calt.eq.2.or.calt.eq.3).and.agi.gt.0) then                            
         petax=1.                                                               
c        f= (taxinc+psinc)/agi -taxinc*psinc/(agi*agi)                          
c        retax=(f*(regrat-z+.5)+(1-f)*regrat)*100                               
c        retax=100*(regrat-z+.5+(agi-psinc)*(agi-taxinc)*(z-.5)/                
c    &(agi*agi))                                                                
         rpref=0.                                                               
         if(lawyr.le.1978.and.exded.gt.0) then                                  
           rpref=-.6                                                            
           if(edical.gt.0) rpref=-.57                                           
           if(exded.gt..4*agi) rpref=.4                                         
         endif                                                                  
         retax=100*(regrat-z+.5+(z-.5)*((agi-psinc)*(agi-taxinc)/               
     &(agi*agi)+rpref))                                                         
c        if(lawyr.eq.1979.and.regrat.eq.z) retax=100*(regrat-z+.5)              
         if(calt.eq.3)                                                          
     &  retax=retax-100*max(0.0d0,regrat-garb1)                                 
         if(pira.eq.0) rate=retax*(1+pdical*.03-pchar*.5)                       
         if(pira.eq.1) rate=retax+rira                                          
      endif                                                                     
c Tax Surcharge                                                                 
      if(lawyr.eq.1968) then                                                    
         tax = 1.075 * tax                                                      
         rate = 1.075 *rate                                                     
      else if(lawyr.eq.1969) then                                               
        tax = 1.1   * tax                                                       
        rate = 1.1  * rate                                                      
      else if(lawyr.eq.1970) then                                               
        tax = 1.025 * tax                                                       
        rate = 1.025 *rate                                                      
      endif                                                                     
      taxbc = tax                                                               
c   General tax credit 1976-1978 or                                             
c   $30 personal exemption credit for 1975                                      
      gencr = 0.                                                                
      if(lawyr.eq.1975) then                                                    
        gencr = 30.*exemps                                                      
      else if(lawyr.ge.1976.and.lawyr.le.1978) then                             
        gencr = max (35.*exemps, min(180.0d0,.02*taxinc))                       
      endif                                                                     
c  Credits                                                                      
c  Child care credit   chr = 20% for 1976-1979                                  
      chcr = 0.                                                                 
      chwage = 0.                                                               
      chmax = 0.                                                                
      ncccr = int(min(data(207),2.0d0))                                              
      if (lawyr.ge.1976) then                                                   
          if (ncccr.eq.1) chmax = 2000.                                         
          if (ncccr.eq.2) chmax = 4000.                                         
          chwage = max(0.0d0,data(11)+data(17))                                 
          if(chwage.le.0) chwage = 0.                                           
          child = min(chmax,chwage,data(64))                                    
          chr = 0.2                                                             
          chcr = child * chr                                                    
      endif                                                                     
c   Limits for elderly                                                          
      exagi=0.                                                                  
      eldlim = 0.                                                               
      if (lawyr.ge.1976) then                                                   
        exagi = agi - 10000./sepret                                             
        if (nfile.eq.2) exagi = agi - 7500.                                     
        if (exagi.lt.0) exagi = 0.                                              
            eldlim = 2500.                                                      
        if(nfile.eq.2.and.data(9).gt.1.and.sepret.eq.1) eldlim = 3750.d0        
        if(nfile.eq.2.and.data(9).eq.1.and.sepret.eq.2) eldlim = 1875.d0        
        eldlim = .15*(eldlim - .5*exagi)                                        
        if (eldlim.lt.0) eldlim = 0.                                            
        elder = min(data(32),eldlim)                                            
      else                                                                      
        elder = data(32)                                                        
      endif                                                                     
c Credit for contributions to candidates for public office                      
      if (lawyr.ge.1972) then                                                   
         canlim =25.d0                                                          
         if(lawyr.eq.1979) canlim = 50.d0                                       
         if (mstat.eq.2.) canlim = 2*canlim                                     
         candid = min(canlim,data(35)/2)                                        
      else                                                                      
         candid = 0.                                                            
      endif                                                                     
c Investment Credit                                                             
      invest =data(33)                                                          
c Foreign Tax Credit                                                            
      forgn = 0.                                                                
      if (lawyr.gt.1962) forgn = data(34)                                       
c Win Credit                                                                    
      win = 0.                                                                  
      if (lawyr.gt.1971)  win =data(36)                                         
c Retirement income credit or Jobs Credit                                       
      if (lawyr.eq.1960.or.lawyr.eq.1969.or.lawyr.eq.1976) then                 
         jobs = 0                                                              
      else                                                                      
         jobs =int(data(37))                                                         
      endif                                                                     
c Residential Energy Credit                                                     
      energy = 0.                                                               
      if (lawyr.gt.1974) energy =data(38)                                       
      credit = chcr+candid+elder+gencr+win+energy+invest+                       
     &         forgn+jobs+data(40)                                              
      if(credit.ge.tax) rate=0.                                                 
      crdnoa = credit                                                           
      if(taxbc.le.crdnoa) crdnoa = taxbc                                        
      credit = max(0.0d0,min(credit,tax))                                       
      tax    = max(0.0d0,tax-credit)                                            
      taxaft = tax                                                              
c Marginal Tax Rate for Child Care Credit                                       
      pchild = 0.                                                               
      rchild = 0.                                                               
      if(chcr.gt.0.and.chwage.lt.chmax.and.chwage.lt.data(64).                  
     & and.tax.gt.0)  then                                                      
         pchild=1                                                               
         rchild=20.                                                             
      endif                                                                     
c  Marginal rate for elderly credit                                             
      pold=0.                                                                   
      rold=0.                                                                   
      if(taxbc.gt.credit.and.eldlim.gt.0.and.eldlim.lt.data(32).                
     &   and.exagi.gt.0) then                                                   
        pold=1.                                                                 
        rold=.15*.5*100                                                         
        if(pira.eq.1) rold=0.                                                   
      endif                                                                     
c Marginal rate for General Tax Credit                                          
      pgen=0                                                                    
      rgen=0                                                                    
      if (lawyr.ge.1976.and.lawyr.le.1978.and.tax.gt.0) then                    
        if(mstat.eq.2.or.mstat.eq.5) then                                       
            if(.02*(taxinc-3200.).lt.180.and.gencr.gt.35.*exemps) then          
               pgen=1                                                           
               rgen=.02*100*(1.-pchar*.5)                                       
            endif                                                               
        else                                                                    
            if(.02*(taxinc-2200.).lt.180.d0/sepret.and.gencr.gt.                
     &  35*exemps) then                                                         
               pgen=1                                                           
               rgen=.02*100*(1.-pchar*.5)                                       
            endif                                                               
        endif                                                                   
      endif                                                                     
      rate=rate+rold-rgen-rchild                                                
c  Earned Income Tax Credit                                                     
      earncr = 0.                                                               
      crmax = 400.                                                              
      ymax = 4000.                                                              
      rtbase = .1                                                               
      rtless = .1                                                               
c     amax = 8000.                                                              
      if(lawyr.eq.1979) then                                                    
         crmax = 500.                                                           
         ymax = 6000.                                                           
         rtbase = .1                                                            
         rtless = .125                                                          
c        amax = 10000.                                                          
      endif                                                                     
      peic=0                                                                    
      reic=0.                                                                   
      if(lawyr.ge.1975) then                                                    
         earncr = min(crmax,rtbase*earned)                                      
         ncr=0                                                                  
         if(earncr.lt.crmax) ncr=1                                              
         if (agi.gt.ymax.or.earned.gt.ymax)                                     
     &  earncr = max(0.0d0,earncr-rtless*(max(earned,agi)-ymax))                
         if (sepret.eq.2.or.data(8).eq.0.or.data(105).gt.0) earncr=0.           
         if(data(202).lt.0) earncr = 0.                                         
         if(earncr.le.0) earncr = 0.                                            
         if(earncr.gt.0..and.earncr.lt.crmax)then                               
            reic=-rtbase                                                        
            peic=1.                                                             
            if((agi.gt.ymax.or.earned.gt.ymax).and.earncr.gt.0) then            
              if(ncr.eq.1)reic=-rtbase+rtless                                   
              if(ncr.eq.0)reic=rtless                                           
              if(agi.gt.earned) then                                            
                if(ncr.eq.1)reic=(-rtbase+rtless)*(1+.5*punemp)                 
                if(ncr.eq.0)reic=rtless*(1+.5*punemp)                           
              endif                                                             
            endif                                                               
         endif                                                                  
         reic=reic*100                                                          
      endif                                                                     
      rate=rate+reic                                                            
c  Minimum tax 1970-79                                                          
      almtax = 0.                                                               
      addmin = 0.                                                               
      if(taxbc.le.chcr + candid + elder) then                                   
         credm = chcr + candid + elder - taxbc                                  
      else                                                                      
         credm = 0.                                                             
      endif                                                                     
c      credm  = chcr + candid + elder + data(38)                                
      if(lawyr.le.1975) then                                                    
       offset = 30000.d0/sepret+                                                
     &      tax+data(39)+data(40)+data(42)+data(80)-credit                      
       addmin = max(0.0d0,(data(81)+ capgn - offset)*.10-credm-gencr)           
      else                                                                      
       offset = .5*(tax+data(39)+data(40)+data(42) - credit)                    
       if (offset.lt.10000./sepret) offset= 10000./sepret                       
       if(lawyr.le.1978) then                                                   
         addmin = max(0.0d0,(data(81) + capgn - offset)*.15 - credm)            
       else                                                                     
c Capital Gains are preferance items for the AMT since 1979                     
         addmin = max(0.0d0,(data(81) - offset)*.15 - credm)                    
       endif                                                                    
      endif                                                                     
      ralm=0.                                                                   
      palm=0.                                                                   
      if (lawyr.ge.1979) then                                                   
            alminy = agi-amex-excess-zbr+capded+(1.-caprat)*                    
     &                  data(18)+data(116)                                      
            almtax = .1*(max(alminy-20000./sepret,0.0d0))+                      
     &               .1*(max(alminy-60000./sepret,0.0d0))+                      
     &               .05*(max(alminy-100000./sepret,0.0d0))                     
           almtax = max(0.0d0,almtax-data(39)-addmin-tax)                       
           almtax = max(0.0d0,almtax - data(34))                                
           if(almtax.gt.0) palm=1.                                              
           tax = tax+almtax+addmin                                              
           almrat=0.0d0                                                         
           if(almtax.gt.0..and.alminy.gt.20000/sepret) almrat=.1d0              
           if(almtax.gt.0..and.alminy.gt.60000/sepret) almrat=.2d0              
           if(almtax.gt.0..and.alminy.gt.100000/sepret) almrat=.25d0            
           ralm=almrat*100                                                      
           if(pira.eq.1) ralm=0                                                 
           if(taxy.eq.0.and.excess.gt.0.and.zbr.gt.0) ralm=0.                   
           if(pdical.eq.1) then                                                 
               rdical=.03*almrat                                                
               if(data(48).gt..01*agix) rdical=.04*almrat                       
           endif                                                                
           if(palm.gt.0.and.(rate.eq.0.or.addmin.eq.0.or.                       
     & (addmin.gt.0.and.offset.eq.10000/sepret)))  rate=ralm+reic               
           if(palm.gt.0.and.addmin.gt.0.and.offset.gt.10000/sepret)             
     &rate=ralm+100*rdical                                                      
           if(palm.gt.0.and.pchar.gt.0) rate=.5*ralm                            
           if(pzbr.gt.0.and.palm.gt.0) rate=reic                                
      endif                                                                     
      if (lawyr.ge.1969.and.lawyr.le.1978) tax = tax + addmin                   
      if (lawyr.ge.1969.and.lawyr.le.1979.and.addmin.gt.0.                      
     & and.almtax.lt.1) then                                                    
        if(offset.gt.10000/sepret) rate=rate-rate*.5*.15                        
        if(chcr.gt.0) rate=rate-rchild                                          
      endif                                                                     
c     almtax = max(0.0d0,tax - taxaft)                                          
      almpay = 0.                                                               
      if (almtax.gt.0.) almpay = 1.                                             
c  taxsoi is the SOI definition of Total Tax, it does not include the           
c  refundable portion of the EITC                                               
      eitc = earncr                                                             
      if (tax.lt.eitc) then                                                     
         if (tax.gt.0.) eitc = tax                                              
         if (tax.le.0.) eitc = 0.                                               
      endif                                                                     
      taxsoi = taxaft - eitc                                                    
      taxnoa = taxbc - crdnoa - earncr                                          
      tax = tax - earncr                                                        
      pretax = max(regtax,altax,almtax,avrtax,(tax+eitc+credit))                
      if(palm.gt.0) ralm = ralm - rgrate                                        
      return                                                                    
      end                                                                       
c    ***************************************************************************
c             1979 to 1986 Law                                                  
c    ***************************************************************************
c                                                                               
      subroutine law79(data,lawyr)                                              
      implicit double precision (A-H,O-Z)                                       
      dimension data(255)                                                       
      double precision ints,iramax,iralim,ira,keogh,kghmax,kghlim               
      double precision jobs,invest,uxemp1(7),uxemp2(7)                          
      integer nfile,lawyr,datayr,sepret                                         
      dimension ebs(1977:1981),ebm(1977:1981),ebh(1977:1981),                   
     & ebsep(1977:1981)                                                         
      dimension eas(1977:1981),eam(1977:1981),eah(1977:1981),                   
     & easep(1977:1981)                                                         
      logical in                                                                
      common /xndxac/ xndxa(1981:2023)                                          
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common /newshr/                                                           
     &tax,agi,zbr,divall,fullcg,capgn,capded,schede,c09,retlim,                 
     1iralim,ira,kghlim,keogh,c15,dislim,adjust,drugs,hins,edical,              
     2cash,asset,char,deduc,polcon, cded,taxy,regtax,taxinc,deducp,             
     3dedint,twoded,almpay,dedphs,exded, pref,earned,psinc,com39,com40,         
     4eacc,eti,etax,avrinc,acgtax, acgsav,avrtax,calt,com49,altax,              
     5gencr,taxbc,chcr,elder,exagi, edcred,candid,credit,earncr,taxsoi,         
     6eitc,offset,addmin,addtax,ti, rgrate,yad,exemps,alminy,almtax,            
     7c71,rate,com73,statax,fica, c76,pretax,untax,ssagi,excess,                
     8chcred,disab,amex,ssa,c85, c86,capinc,c88,c89,bp,                         
     9 c91, c92, c93, c94, c95, c96, c97,c98,almrat,regrat,                     
     &c101,c102,c103,c104,pssa,rssa,pira,rira,pdical,rdical,                    
     &pchar,rchar,c113,c114,pchild,rchild,peic,reic,palm,ralm,                  
     &c121,c122,c123,c124,pcasu,rcasu,pdisab,rdisab,c129,c130,                  
     &c131,c132,punemp,runemp,pold,rold,c137,c138,petax,retax,                  
     &c141,c142,c143,c144,c145,c146,c147,c148,c149,c150,                        
     &c151,c152,c153,c154,taxnoa,c156,c157,c158,c159,c160,                      
     &c161,c162,c163,c164,c165,c166,c167,c168,c169,c170,                        
     &c171,c172,c173,c174,c175,c176,zbrst,comadd(78)                            
      data uxemp1   /20000.,25000.,3*20000.,0.,20000./                          
      data uxemp2   /12000.,18000.,3*12000.,0.,12000./                          
      data ebs/2*40200.,3*41500./                                               
      data ebm/2*55200.,3*60000./                                               
      data ebh/2*40200.,3*44700./                                               
      data ebsep/2*26000.,3*28300./                                             
      data eas/2*13290.,3*13392./                                               
      data eam/2*18060.,3*19678./                                               
      data eah/2*12240.,3*13961./                                               
      data easep/2*9030.,3*9839./                                               
      gencr = 0.                                                                
      xndx = 1.                                                                 
      if (lawyr.eq.1985) xndx = 1.04                                            
      if (lawyr.eq.1986) xndx = 1.08                                            
      if (lawyr.eq.1987) xndx = 1.10                                            
      if (lawyr.eq.1988) xndx = 1.14                                            
      if (lawyr.eq.1989) xndx = 1.24                                            
      datayr = int(data(103))                                                   
c  Marital status and sepret                                                    
      mstat = int(data(2))                                                             
      sepret=1                                                                  
      if(mstat.eq.3.or.mstat.eq.6) sepret=2                                     
      nfile = int(filing(mstat,1.,2.,3.,2.))                                    
c                                                                               
      ints = data(14)                                                           
      if (lawyr.eq.1981) then                                                   
         divexc = 200.                                                          
         if (mstat.eq.2.) divexc = 400.                                         
      else if(lawyr.eq.1979) then                                               
         divexc = data(13)                                                      
      else                                                                      
         divexc = 100.                                                          
         if (mstat.eq.2.) divexc = 200.                                         
      endif                                                                     
      if(lawyr.eq.1981) then                                                    
        if(data(176) + data(177).gt.0) then                                     
           divall = max(0.d0,data(176) + data(177) + ints - divexc)             
        else                                                                    
           divall = max(0.0d0,data(12) + ints - divexc)                         
        endif                                                                   
        ints = 0.                                                               
      else                                                                      
        if(data(176) + data(177).gt.0) then                                     
           divall = max(0.d0,data(176) + data(177) - divexc)                    
        else                                                                    
           divall = max(0.0d0,data(12) - divexc)                                
        endif                                                                   
      endif                                                                     
c                                                                               
c     Capital gains                                                             
c                                                                               
      caprat = .6d0                                                             
      if (lawyr.le.1977) caprat = .5d0                                          
      clslim = 2000./sepret                                                     
      if (lawyr.ge.1978) clslim =  3000./sepret                                 
      fullcg = data(68)+data(70)                                                
c      if(datayr.gt.1986.and.datayr.lt.1989) fullcg=fullcg+data(90)             
      capgn = fullcg                                                            
      if (fullcg.gt.0.) then                                                    
         capded = caprat*min(max(0.0d0,data(70)),fullcg)                        
         capgn = fullcg-capded                                                  
      else                                                                      
         if (data(68).ge.0.) capgn = .5*fullcg                                  
         if (data(70).ge.0.) capgn = fullcg                                     
         if (data(68).lt.0..and.data(70).lt.0.)                                 
     &      capgn = data(68)+.5*data(70)                                        
         capgn = max(-clslim,capgn)                                             
         capded = 0.                                                            
      endif                                                                     
c                                                                               
c     Adjustments                                                               
c                                                                               
      kghmax = 7500.                                                            
      if (in(lawyr,1982,1983)) kghmax = 15000.                                  
      if (lawyr.ge.1984) kghmax = 30000.                                        
c     bus = data(17)+data(75)+data(79)                                          
      bus = data(17)+max(0.0d0,data(75))+max(0.0d0,data(79))+                   
     &max(0.d0,data(21))                                                        
      retlim = max(0.0d0,.15*bus)                                               
      kghlim = min(retlim,kghmax)*data(7)                                       
      keogh = min(data(28),kghlim)                                              
      iramax = 3000./sepret                                                     
      if (lawyr.ge.1981) iramax = 4000./sepret                                  
      if (nfile.ne.2) iramax = iramax/2.                                        
      busnet = max(0.0d0,bus-keogh)                                             
      iralim = min(data(11)+busnet,iramax)                                      
      ira = min(data(29),iralim)                                                
c                                                                               
      schede = data(73)+data(74)+data(75)+data(76)+                             
     &         data(77)+data(78)+data(79)                                       
      preagi = divall+capgn+schede+data(11)+ints+data(17)+data(18)+             
     &            data(19)+data(20)+data(21)+data(22)+data(23)+                 
     &            data(24)-(ira+data(26)+data(27)+keogh+data(30)-               
     &            data(62))+data(72)                                            
      disab = data(25)                                                          
      exagi = preagi-15000.                                                     
      if (exagi.lt.0.) exagi = 0.                                               
      dislim = 5200.-exagi                                                      
      if (dislim.lt.0.) dislim = 0.                                             
      if (disab.gt.dislim) disab = dislim                                       
c                                                                               
      twoded = 0.                                                               
      if (lawyr.ge.1982.and.mstat.eq.2) then                                    
         wife = max(0.0d0,min(data(85),data(86)))                               
         twoded = min(3000.0d0,.1*wife)                                         
         if (lawyr.eq.1982) twoded = min(1500.0d0,.05*wife)                     
      endif                                                                     
      adjust = disab+ira+data(26)+data(27)+keogh+data(30)+data(62)+             
     &      twoded                                                              
c                                                                               
      ti = divall+schede+data(11)+ints+data(17)+((1.-caprat)*                   
     &            data(18))+data(19)+data(20)+data(21)+data(22)+                
     &            data(23)+data(24)+data(72)                                    
      earned =  max(0.0d0,data(11)+data(17)+data(21))                           
      if (capgn.lt.0.) capgn = -min(-capgn,max(ti,0.0d0))                       
      unearn = ti-earned+capgn                                                  
      agi = ti-adjust+capgn                                                     
c                                                                               
c     Unemployment compensation                                                 
c                                                                               
      uxemp = uxemp1(mstat)                                                     
      if (lawyr.ge.1982) uxemp = uxemp2(mstat)                                  
      untax = min(.5*max(data(82)+agi-uxemp,0.0d0),data(82))                    
      if (lawyr.le.1978) untax = 0.                                             
      agi = agi+untax                                                           
c                                                                               
c     Ssa in agi                                                                
c                                                                               
      ssagi = 0.                                                                
      ssa = max(0.0d0,data(91))                                                 
      ssbase = 0.                                                               
      if (lawyr.ge.1984.and.ssa.gt.0.) then                                     
         ssbase = agi+.5*ssa+twoded                                             
         ssexcl = filing(mstat,25000.,32000.,25000.,0.)                         
         if(extnd(17).ne.0.0d0) ssexcl =                                        
     &    filing(mstat,25000.,32000.,25000.,0.)*xndxa(lawyr)/xndxa(1984)        
         ssbase = max(0.0d0,ssbase-ssexcl)                                      
         ssagi = min(.5*ssa,.5*ssbase)                                          
         agi = agi+ssagi                                                        
      endif                                                                     
c Itemized deductions                                                           
      agix = max(0.0d0,agi)                                                     
c Medical                                                                       
      drugs = data(48)-.01*agix                                                 
      if (drugs.lt.0.) drugs = 0.                                               
      hins = .5*data(47)                                                        
      if (hins.gt.150.) hins = 150.                                             
      if (lawyr.le.1982) edical = drugs+data(47)-hins+data(49)-.03*agix         
      if (lawyr.ge.1983) edical = drugs+data(47)+data(49)-.05*agix              
      if (edical.lt.0.) edical = 0.                                             
      if (lawyr.le.1982) edical = edical+hins                                   
c Charity                                                                       
      unchar = 0.                                                               
      cash = data(58)                                                           
      asset = data(59)+data(60)                                                 
      if (agi.lt.0.) then                                                       
         cash = 0.                                                              
         asset = 0.                                                             
      else                                                                      
         if (cash.gt..5*agi) then                                               
            cash = .5*agi                                                       
            asset = 0.                                                          
         else                                                                   
            unchar = .5*agi - cash                                              
            asset = min(asset,.5*agi,unchar)                                    
            asset = max(0.0d0,asset)                                            
         endif                                                                  
      endif                                                                     
      char = cash+asset                                                         
c Political Contributions                                                       
      polcon = min(100.0d0,data(65))                                            
      if (mstat.eq.2.) polcon =min(200.0d0,data(65))                            
      if (lawyr.ge.1979) polcon = 0.                                            
c Casualty or Theft Losses                                                      
      casu = max(0.0d0,data(61)-100.)                                           
      if(lawyr.ge.1983) casu = max(0.0d0,casu-.1*agix)                          
      deduc = edical+polcon+data(50)+data(51)+data(52)+                         
     &            data(53)+data(54)+data(55)+data(56)+data(57)+                 
     &            casu+data(63)+data(66)                                        
      if (lawyr.le.1981) deduc = deduc+char                                     
      zbr = 2300.*xndx                                                          
      if (nfile.eq.2) zbr = (3400.*xndx)/sepret                                 
      if (lawyr.le.1978) zbr = 2200.                                            
      if (lawyr.le.1978.and.nfile.eq.2) zbr = 3200./sepret                      
c zbrst for state purposes                                                      
      zbrst = zbr                                                               
c Non-itemizer deduction for charitable contributions                           
c 1979-1981   no above the line contributions allowed                           
c 1982-1983   25% up to first $100 ($50 if sepret)                              
c 1984        25% up to first $300 ($150 if sepret)                             
c 1985        50% with no limit                                                 
c 1986        100%                                                              
c  Difference3                                                                  
c                                                                               
      cded = 0.                                                                 
      excess = 0.                                                               
      charni = 0.                                                               
      if (in(lawyr,1982,1983))                                                  
     &    charni = .25*min(100.0d0/sepret,char)                                 
      if (lawyr.eq.1984)                                                        
     &    charni = .25*min(300.0d0/sepret,char)                                 
      if (lawyr.eq.1985) charni = .5*char                                       
      if(extnd(55).gt.0) charni = 0.                                            
      if (lawyr.eq.1986) charni = char                                          
c     if(data(4).eq.-1) zbr = 0.                                                
c     if(data(4).eq.-2) deduc = 0.                                              
      deducp = deduc                                                            
      if (lawyr.le.1981) then                                                   
        if (deduc.gt.zbr) then                                                  
          cded = 1.                                                             
          excess = deduc-zbr                                                    
        else                                                                    
          deduc = 0.                                                            
        endif                                                                   
      else                                                                      
        if((deduc+char.gt.zbr+charni.and.data(4).ge.0).or.data(4).eq.-1)        
     &    then                                                                  
           cded = 1.                                                            
           deduc = deduc + char                                                 
           deducp = deduc                                                       
           excess = deduc - zbr                                                 
           charni = 0.                                                          
        else                                                                    
          char = charni                                                         
          deduc = 0.                                                            
        endif                                                                   
      endif                                                                     
      dedphs = 0.                                                               
c  dependent limitations                                                        
      add105 = 0.                                                               
      if (data(105).gt.0..and.unearn.ge.1000..and.cded.gt.0.) then              
         tmp105 = earned - ira                                                  
         tmp105 = max(tmp105,deduc)                                             
         add105 = max(0.0d0,zbr-tmp105)                                         
      endif                                                                     
      exemps = data(7)+data(8)+data(9)+data(10)                                 
      amex = 750.*exemps                                                        
      if (lawyr.ge.1979) amex = 1000.*exemps*xndx                               
      taxy = agi-excess-amex-charni+add105                                      
      taxinc = agi-excess-amex-zbr-charni+add105                                
      if (taxy.lt.0.) taxy = 0.                                                 
      if (taxinc.lt.0.) taxinc = 0.                                             
c Don't itemize unless this is a benefit...                                     
      if(cded.gt.0.and.taxinc.eq.0.and.agi-amex-zbr-charni.le.0) then           
         cded = 0                                                               
         deduc= 0                                                               
         char = charni                                                          
         excess=0.                                                              
      endif                                                                     
c     Regular tax                                                               
      if (lawyr.le.1978) call tax77(taxinc,sepret,nfile,regrat,regtax)          
      if (in(lawyr,1979,1981))                                                  
     &   call tax79(taxy,sepret,nfile,regrat,regtax)                            
      if (lawyr.eq.1982) call tax82(taxy,sepret,nfile,regrat,regtax)            
      if (lawyr.eq.1983) call tax83(taxy,sepret,nfile,regrat,regtax)            
      if (lawyr.ge.1984) call tax84(taxy,sepret,nfile,regrat,regtax)            
c Rate Reduction Credit for 1981                                                
      if (lawyr.eq.1981) then                                                   
         regtx1 = regtax                                                        
         regtax = .9875*regtax                                                  
         rgrate = .9875*regrat                                                  
      endif                                                                     
      tax = regtax                                                              
      rgrate = regrat*100                                                       
c SS benefits marginal rate                                                     
      pssa=0.                                                                   
      rssa=0.                                                                   
      if(ssagi.gt.0.and.ssa.gt.ssbase.and.                                      
     &agi+.5*ssa+twoded.gt.filing(mstat,25000.,32000.,25000.,0.)) then          
        pssa=1.                                                                 
        rssa=.5*rgrate                                                          
      endif                                                                     
c Unemployment compensation marginal rate                                       
      runemp=0.                                                                 
      punemp=0.                                                                 
      if(untax.gt.0.and.untax.lt.data(82))then                                  
       punemp=1.                                                                
       runemp=.5*rgrate                                                         
      endif                                                                     
c IRA marginal rate                                                             
      rira=0.                                                                   
      pira=0.                                                                   
      if(ira.gt.0.and.data(11)+busnet.lt.iramax.and.                            
     &data(29).ge.iralim) then                                                  
         pira=1.                                                                
         rira = -rgrate                                                         
      endif                                                                     
c marginal rate on agi changes                                                  
      ragi=rgrate                                                               
c Medical deduction marginal rate                                               
      pdical=0.                                                                 
      rdical=0.                                                                 
      if(lawyr.le.1982.and.edical-hins.gt.0.) then                              
        pdical=1.                                                               
        if(rgrate.gt.0.and.cded.gt.0.and.pira.eq.0) then                        
         rdical=.03*rgrate                                                      
         if(data(48).gt..01*agix) rdical=.04*rgrate                             
        endif                                                                   
      elseif(lawyr.ge.1983.and.edical.gt.0.) then                               
        pdical=1.                                                               
        if(rgrate.gt.0.and.cded.gt.0.and.pira.eq.0) then                        
         rdical=.05*rgrate                                                      
         if(data(48).gt..01*agix) rdical=.06*rgrate                             
        endif                                                                   
      endif                                                                     
c Charitable contributions marginal rate                                        
      rchar=0.                                                                  
      pchar=0.                                                                  
      if(cded.gt.0..and.char.gt.0.and.agi.gt.0.) then                           
        if(data(58).gt..5*agi) then                                             
         rchar=.5*rgrate                                                        
         pchar=1.                                                               
        else                                                                    
         if(.5*agi.lt.data(59)+data(60).or.                                     
     &    (unchar.lt.data(59)+data(60).and.unchar.gt.0.))then                   
          rchar=.5*rgrate                                                       
          pchar=1.                                                              
         endif                                                                  
        endif                                                                   
      endif                                                                     
c Disability marginal rate                                                      
      pdisab=0.                                                                 
      rdisab=0.                                                                 
      if(disab.gt.0.and.disab.lt.data(25).and.exagi.gt.0)then                   
         pdisab=1.                                                              
         rdisab=rgrate                                                          
      endif                                                                     
c Casualty marginal rate                                                        
      pcasu = 0.                                                                
      rcasu = 0.                                                                
      if(lawyr.ge.1983.and.data(61)-100.gt..1*agix) pcasu = 1.                  
      if(pcasu.eq.1.) rcasu = .1*rgrate                                         
      rate = rgrate+rira+runemp+rssa+rdical-rchar-rcasu+rdisab                  
      addtax=0.                                                                 
c   Alternative computation of tax (for capital gains)                          
      acgtax = -1.                                                              
      garb=0.                                                                   
      garb1=0.                                                                  
      garb2=0.                                                                  
      if (fullcg.gt.0..and.lawyr.le.1978) then                                  
         cg1 = taxinc-capded                                                    
         if (cg1.lt.0.) cg1 = 0.                                                
         call tax77(cg1,sepret,nfile,garb1,cgtx1)                               
         cgtx2 = 0.5*capded                                                     
         cgtx3 = 0.                                                             
         if (capded*2.0.le.50000./sepret) goto 424                              
         subd = data(71)                                                        
         if (subd.lt.50000./sepret) subd = 50000./sepret                        
         if (subd.ge.capded*2.) goto 424                                        
         cgtx2 = 0.25*subd                                                      
         cg3 = taxinc                                                           
         if (capded.gt.taxinc) cg3 = capded                                     
         call tax77(cg3,sepret,nfile,garb,cgtx31)                               
         call tax77(cg1+subd*0.5,sepret,nfile,garb2,cgtx32)                     
         cgtx3 = cgtx31-cgtx32                                                  
424      acgtax = cgtx1+cgtx2+cgtx3                                             
      endif                                                                     
      if(lawyr.eq.1981.and.min(data(70),data(68)+data(70)).gt.0) then           
        cg1 = max(0.0d0,taxy - .4*min(data(70),data(68)+data(70)))              
        call tax79(cg1,sepret,nfile,garb,cgtx1)                                 
        cgtx1 = .9875*cgtx1                                                     
        cgtx2 = .2*min(data(70),data(68)+data(70))                              
        acgtax = cgtx1+cgtx2                                                    
      endif                                                                     
c     Preference income                                                         
      pref = 0.                                                                 
      prfded = 0.                                                               
      prfddy = 0.                                                               
      exded = 0.                                                                
      if (cded.gt.0.) then                                                      
         if (lawyr.le.1978) then                                                
            exded = max(0.0d0,deduc-edical-data(61)-.60*agi)                    
            if (exded.gt.agi*.4) exded = agi*.4                                 
            pref = capded+data(18)+data(81)+data(82)+data(83)+                  
     &             data(84)+data(11)+data(87)+exded                             
            pref = max(0.0d0,pref)                                              
         else                                                                   
            prfded = max(0.0d0,deduc-edical-data(61)-data(50))                  
            prfddy = max(0.0d0,agi-edical-data(61)-data(50))                    
            exded = max(0.0d0,prfded-0.6*prfddy)                                
            pref = max(0.0d0,data(164))                                         
         endif                                                                  
      endif                                                                     
c Maximum tax on earned income                                                  
      etax = -1.                                                                
      if (lawyr.le.1981) then                                                   
         if(mstat.eq.1) then                                                    
           ebot = ebs(lawyr)                                                    
           eacc = eas(lawyr)                                                    
         else if(mstat.eq.2.or.mstat.eq.5) then                                 
           ebot = ebm(lawyr)                                                    
           eacc = eam(lawyr)                                                    
         else if(mstat.eq.4.or.mstat.eq.7) then                                 
           ebot = ebh(lawyr)                                                    
           eacc = eah(lawyr)                                                    
         else                                                                   
           ebot = ebsep(lawyr)                                                  
           eacc = easep(lawyr)                                                  
         endif                                                                  
         psinc = earned + max(0.0d0,data(75))+                                  
     &           data(20)+data(72)-data(138)                                    
         if(agi.gt.0) psinc = twn(psinc,0.0d0,agi)                              
         if (sepret.eq.2) goto 444                                              
         if (agi.ne.0.) goto 4422                                               
         eratio = 1.0                                                           
         goto 4424                                                              
4422     eratio = min(psinc/agi,1.0d0)                                          
         if (eratio.le.0..or.agi.le.0.) goto 444                                
4424     if(lawyr.ge.1979) then                                                 
            eti = taxy*eratio-pref                                              
         else                                                                   
            eti = taxinc*eratio-pref                                            
         endif                                                                  
         etop = eti - ebot                                                      
         if (etop.le.0.) go to 444                                              
         if (lawyr.le.1978) call tax77(eti,sepret,nfile,z,partax)               
         if (in(lawyr,1979,1981))                                               
     &      call tax79(eti,sepret,nfile,z,partax)                               
         if(lawyr.eq.1981) then                                                 
           etax = .9875*(regtx1-partax+eacc) + .5*etop                          
         else                                                                   
           etax = regtax-partax+eacc + .5*etop                                  
         endif                                                                  
         if(capgn.gt.0.and.lawyr.gt.1981) then                                  
           etax = max(0.0d0,.5*(min(cg1,eti)-ebot))+                            
     &            cgtx2+.9875*(eacc+max(0.0d0,cgtx1-partax))                    
         endif                                                                  
      endif                                                                     
444   continue                                                                  
c                                                                               
c     Income averageing                                                         
c     Data(96): sum of taxinc for base period (4 years previous to 1984)        
c     .3 is equal to 120%/4                                                     
c     .3*data(96) is 120% of average income in base period                      
c     avrinc      is excess of this period income over base                     
c     atax1       is tax on base plus .2 of excess for this year                
c     atax2       is tax on base income                                         
c     4*(atax1-atax2) is tax on excess spread over 4 years                      
      if (data(96).lt.0.) goto 462                                              
      avrinc = taxinc-0.3*data(96)                                              
      if (lawyr.ge.1979) avrinc = taxy-0.3*data(96)                             
      if (avrinc.le.3000.) goto 462                                             
      if (lawyr.le.1978) then                                                   
         call tax77(0.3*data(96)+0.2*avrinc,sepret,nfile,arate1,atax1)          
         call tax77(0.3*data(96),sepret,nfile,arate2,atax2)                     
      endif                                                                     
      if (in(lawyr,1979,1981)) then                                             
         call tax79(0.3*data(96)+0.2*avrinc,sepret,nfile,arate1,atax1)          
c Rate Reduction Credit for 1981                                                
         if (lawyr.eq.1981) atax1 = .9875*atax1                                 
         call tax79(0.3*data(96),sepret,nfile,arate2,atax2)                     
c Rate Reduction Credit for 1981                                                
         if (lawyr.eq.1981) atax2 = .9875*atax2                                 
      endif                                                                     
      if (lawyr.eq.1982) then                                                   
         call tax82(0.3*data(96)+0.2*avrinc,sepret,nfile,arate1,atax1)          
         call tax82(0.3*data(96),sepret,nfile,arate2,atax2)                     
      endif                                                                     
      if (lawyr.eq.1983) then                                                   
         call tax83(0.3*data(96)+0.2*avrinc,sepret,nfile,arate1,atax1)          
         call tax83(0.3*data(96),sepret,nfile,arate2,atax2)                     
      endif                                                                     
      if (lawyr.ge.1984) then                                                   
         call tax84(0.3*data(96)+0.2*avrinc,sepret,nfile,arate1,atax1)          
         call tax84(0.3*data(96),sepret,nfile,arate2,atax2)                     
      endif                                                                     
      avrtax = 4.*(atax1-atax2)+atax1                                           
      goto 464                                                                  
462   avrtax = -1.                                                              
464   continue                                                                  
c                                                                               
c   Combine alternative taxes -- amended 2/27/98 by Dan Feenberg                
c   Select the lowest among the following 5 alternative taxes                   
c        calt = 0 regtax                                  comnew(28)            
c        calt = 1 alternative tax on gains     (acgtax)   comnew(45)            
c        calt = 2 maximum tax on earned income (etax)     comnew(43)            
c        calt = 3 (1) and (2)                  (altax3)   comnew(46)            
c        calt = 4 average tax                  (avrtax)   comnew(47)            
c        calt (combined alternative taxes indicator)      comnew(48)            
c        altax (combined alternative taxes)               comnew(50)            
c                                                                               
      altax = regtax                                                            
      calt = 0.                                                                 
      acgsav = 0.                                                               
      if(acgtax.gt.0) then                                                      
c        acgsav = max(0.0d0,regtax-acgtax)                                      
c        altax = regtax - acgsav                                                
         altax = min(acgtax,altax)                                              
         calt = 1                                                               
      endif                                                                     
      if(etax.gt.0) then                                                        
        if(etax.lt.altax) then                                                  
           altax = etax                                                         
           calt = 2                                                             
        endif                                                                   
        if(etax.lt.regtax.and.acgsav.gt.0) then                                 
           altax = etax - acgsav                                                
           calt = 3                                                             
        endif                                                                   
      endif                                                                     
      if(avrtax.gt.-1..and.avrtax.lt.altax) then                                
         altax = avrtax                                                         
         calt = 4                                                               
      endif                                                                     
      taxbc = altax                                                             
      if(lawyr.le.1981.and.calt.eq.1.and.acgtax.lt.regtax.                      
     & and.pira.eq.0) rate=garb*100*(1+pdical*.03-pchar*.5+punemp*.5)           
c Marginal Tax Rate on Maximum Tax on Earned Income                             
      petax=0                                                                   
      retax=0.                                                                  
      if((calt.eq.2.or.calt.eq.3).and.agi.gt.0) then                            
         petax=1.                                                               
         retax=100*(regrat-z+.5+(z-.5)*(agi-psinc)*(agi-taxinc)/                
     &(agi*agi))                                                                
         if(calt.eq.3)                                                          
     &  retax=retax-100*max(0.0d0,regrat-garb1)                                 
         if(pira.eq.0) rate=retax+pdical*rdical-pchar*.5*retax                  
         if(pira.eq.1.0d0) rate=retax+rira                                      
      endif                                                                     
c Child care credit                                                             
      ncccr = int(min(data(207),2.0d0))                                              
      if(lawyr.le.1981) then                                                    
        chmax=2000.*ncccr                                                       
      else                                                                      
        chmax=2400.*ncccr                                                       
      endif                                                                     
      chwage = max(0.0d0,data(11)+data(17))                                     
      if(chwage.le.0) chwage = 0.                                               
      child = min(chmax,chwage,data(64))                                        
      chr = 0.2                                                                 
      if(lawyr.ge.1982) chr =max(.2d0,.3-max((agi-8000.)/200000.,0.0d0))        
      chcr = child*chr                                                          
c Indicator for Child Care Credit Phaseout                                      
      pchild = 0.                                                               
      rchild=0.                                                                 
      if(child.gt.0) pchild = 1.                                                
      if(chr.gt..2.and.chr.lt..3.and.pchild.eq.1) rchild=child/2000.            
      if(chwage.lt.chmax.and.chwage.lt.data(64).and.pchild.eq.1) then           
       if(chr.lt..3) then                                                       
         rchild=-(rchild+20.)                                                   
       else                                                                     
         rchild=-30.                                                            
       endif                                                                    
      endif                                                                     
c Limits for elderly                                                            
      exagi = agi-10000./sepret                                                 
      if (nfile.ne.2) exagi = agi-7500.                                         
      if (exagi.lt.0.) exagi = 0.                                               
      eldlim = 2500.                                                            
      if (nfile.eq.2) then                                                      
         eldlim = 3750.                                                         
         if (int(data(9)).eq.1) eldlim = 2500.                                  
         if (sepret.eq.2) eldlim = 1875.                                        
      endif                                                                     
      if (lawyr.ge.1984) eldlim = 2.*eldlim                                     
      eldlim = .15*(eldlim-(.5*exagi+data(91)-ssagi))                           
      if (eldlim.lt.0.) eldlim = 0.                                             
      elder = min(eldlim,data(32))                                              
c     Polical campaign credit                                                   
      canlim = 25.                                                              
      if (lawyr.ge.1979) canlim = 50.                                           
      if (mstat.eq.2) canlim = 2.*canlim                                        
      candid = min(canlim,data(35)/2.)                                          
      if (polcon.eq.0.) candid = min(canlim,(data(65)+data(35))/2.)             
      invest = data(33)                                                         
      jobs = data(37)                                                           
      energy = data(38)                                                         
      if (lawyr.le.1983) then                                                   
         credit = chcr+candid+elder+data(36)+energy+invest+                     
     &            data(34)+jobs+data(40)                                        
      else                                                                      
         credit = chcr+elder+data(34)+energy+candid+data(40)+invest+jobs        
      endif                                                                     
      crdnoa = credit                                                           
      if(taxbc.le.crdnoa) crdnoa = taxbc                                        
c  Marginal rate for elderly credit                                             
      pold=0.                                                                   
      rold=0.                                                                   
      if(taxbc.gt.credit.and.eldlim.gt.0.and.eldlim.lt.data(32).                
     & and.rate.gt.0) then                                                      
        pold=1.                                                                 
        rold=.15*.5*100                                                         
        if(pdisab.gt.0) rold=2*.15*.5*100                                       
      endif                                                                     
      rate=rate+rold+rchild                                                     
      if(taxbc.le.credit) rate=0.                                               
      credit = min(credit,taxbc)                                                
      tax = taxbc-credit                                                        
      taxaft = tax                                                              
c     Earned income credit                                                      
      earncr = 0.                                                               
      peic=0                                                                    
      reic=0.                                                                   
      if(lawyr.ge.1975) then                                                    
        if (lawyr.le.1978) then                                                 
         crmax = 400.                                                           
         ymax = 4000.                                                           
         rtbase = .1                                                            
         rtless = .1                                                            
         amax = 8000.                                                           
        else if (lawyr.ge.1979.and.lawyr.le.1984) then                          
         crmax = 500.                                                           
         ymax = 6000.                                                           
         rtbase = .1                                                            
         rtless = .125                                                          
         amax = 10000.                                                          
        else if (lawyr.ge.1985) then                                            
         crmax = 550.                                                           
         ymax = 6500.                                                           
         rtbase = .11                                                           
         rtless = .1222                                                         
         amax = 11000.                                                          
        endif                                                                   
        if(max(agi,earned).le.amax) then                                        
           earncr =  min(crmax,rtbase*earned)                                   
           if(max(agi,earned).gt.ymax)                                          
     &       earncr = max(0.0d0,earncr - rtless*(max(agi,earned)-ymax))         
        endif                                                                   
        ncr=0                                                                   
        if(earncr.lt.crmax) ncr=1                                               
        if (sepret.eq.2.or.data(8).eq.0.or.data(105).gt.0) earncr=0.            
        if(data(202).lt.0.or.data(197).lt.0.) earncr = 0.                       
        if(earncr.le.0) earncr = 0.                                             
        if(earncr.gt.0..and.earncr.lt.crmax)then                                
          reic=-rtbase                                                          
          peic=1.                                                               
          if((agi.gt.ymax.or.earned.gt.ymax).and.earncr.gt.0) then              
           if(ncr.eq.1)reic=-rtbase+rtless                                      
           if(ncr.eq.0)reic=rtless                                              
           if(agi.gt.earned) then                                               
            if(ncr.eq.1)reic=(-rtbase+rtless)*(1+.5*pssa+.5*punemp)             
            if(ncr.eq.0)reic=rtless*(1+.5*pssa+.5*punemp)                       
           endif                                                                
          endif                                                                 
        endif                                                                   
        reic=reic*100                                                           
        if(credit.lt.taxbc) then                                                
         rate=rate+reic                                                         
        else                                                                    
         rate=reic                                                              
        endif                                                                   
      endif                                                                     
c     Alternative Minimum tax                                                   
      almtax = 0.                                                               
      almrat = 0.                                                               
      addmin = 0.                                                               
      if (lawyr.le.1981) then                                                   
         offset = .5*(tax+data(39)+data(40)+data(42))                           
         if (offset.lt.10000./sepret) offset = 10000./sepret                    
         if(taxbc.le.chcr + candid + elder + data(38)) then                     
            credm = chcr + candid + elder +data(38)- taxbc                      
         else                                                                   
            credm = 0.                                                          
         endif                                                                  
c        credm  = chcr + candid + elder + data(38)                              
         if(data(155).gt.0)addmin = max(0.0d0,(data(81)-offset)*                
     &    .15-credm)                                                            
         if (lawyr.ge.1979) then                                                
           alminy = agi-amex-excess-zbr+capded+(1.-caprat)*                     
     &                  data(18)+data(116)                                      
           almtax = .1*(max(alminy-20000./sepret,0.0d0))+                       
     &              .1*(max(alminy-60000./sepret,0.0d0))+                       
     &              .05*(max(alminy-100000./sepret,0.0d0))                      
                                                                                
           almtax = max(0.0d0,almtax-data(39)-addmin-tax)                       
           almtax = max(0.0d0,almtax - data(34))                                
           tax = tax+almtax+addmin                                              
           if(almtax.gt.0) then                                                 
              if(alminy.gt.20000/sepret) almrat=.1d0                            
              if(alminy.gt.60000/sepret) almrat=.2d0                            
              if(alminy.gt.100000/sepret) almrat=.25d0                          
           endif                                                                
           rach=0.                                                              
           raed=0.                                                              
           raira=0.                                                             
           if(cded.lt.1.and.taxinc.eq.0.                                        
     & and.((asset.gt.0.and.asset.lt.data(59)+data(60)).or.                     
     & data(58).gt..5*agi.and.agi.gt.0)) rach=-.5*almrat                        
           if(pdical.eq.1.and.cded.lt.1.and.taxinc.eq.0) then                   
              raed=.03*almrat                                                   
              if(data(48).gt..01*agix) raed=.04*almrat                          
           endif                                                                
c          if(iralim.gt.0.and.taxinc.eq.0) raira=-almrat                        
           almrat=almrat+rach+raed+raira                                        
         else                                                                   
           tax = tax+addmin                                                     
         endif                                                                  
         if(addmin.gt.0.and.data(81).gt.offset.and.                             
     &  offset.gt.10000/sepret) rate=rate*(1-.15*.5)                            
      endif                                                                     
      if (lawyr.eq.1982) then                                                   
         offset = .5*(tax+data(39)+data(40)+data(42))                           
         if (offset.lt.10000./sepret) offset = 10000./sepret                    
         if(taxbc.le.chcr + candid + elder + data(38)) then                     
            credm = chcr + candid + elder +data(38)- taxbc                      
         else                                                                   
            credm = 0.                                                          
         endif                                                                  
c         credm = chcr+candid+elder+data(38)                                    
         if(data(155).gt.0) then                                                
          addmin = max(0.0d0,(data(81)-offset)*.15)                             
          addmin = max(0.0d0,addmin - min(.15*data(116),addmin))                
          addmin = max(0.0d0,addmin-credm)                                      
          if(addmin.gt.0.and.data(81).gt.offset.and.                            
     &  offset.gt.10000/sepret) rate=rate*(1-.15*.5)                            
         endif                                                                  
         tax = tax+addmin                                                       
         alminy = agi - excess - zbr - amex + capded + exded                    
         almtax = .1*(max(alminy-20000./sepret,0.0d0))+                         
     &            .1*(max(alminy-60000./sepret,0.0d0))                          
         almtax=max(0.0d0,almtax-taxaft-addmin-data(39))                        
         tax=tax+almtax                                                         
         almr=0.                                                                
         if(almtax.gt.0..and.alminy.gt.20000/sepret) almr=.1                    
         if(almtax.gt.0..and.alminy.gt.60000/sepret) almr=.2                    
         pexc = 0.                                                              
         if(excess.gt.0) pexc = 1.                                              
         pexded=0.                                                              
         if(exded.gt.0.and.prfddy.gt.0) pexded = 1.                             
         almrat=almr*(1-pexc*(pchar*.5-pdical*.03)                              
     &         +pexded*(pchar*.5-.6*(1+pdical*.03)))                            
         if(zbr.gt.0)  almrat=almrat-almr*(1+pdical*.03)                        
      endif                                                                     
      if (lawyr.ge.1983) then                                                   
         if(mstat.eq.1.or.mstat.eq.4.or.mstat.eq.7) then                        
          offset = 30000.                                                       
         else                                                                   
          offset = 40000./sepret                                                
         endif                                                                  
         if(cded.gt.0) then                                                     
           prfded = max(0.0d0,edical-.05*agix)+char+data(61)+data(116)          
         else                                                                   
           prfded = data(116)                                                   
           if(lawyr.eq.1986) prfded = charni+data(116)                          
         endif                                                                  
         pref = capded+data(81)+(1.-caprat)*max(0.0d0,data(18))                 
         if(fullcg.lt.0) pref = fullcg-capgn+data(81)+                          
     & (1.-caprat)*max(0.0d0,data(18))                                          
         alminy = max(0.0d0,agi-prfded+pref)                                    
         almtax = .2*max(0.0d0,alminy-offset)                                   
         if(almtax.gt.0) almrat=.2d0                                            
         if(cded.lt.1.and.zbr.gt.0) almrat = 0.                                 
         if ((almtax-data(34)).gt.tax.and.almtax.gt.0.) then                    
            tax = almtax -min(almtax,data(34))                                  
         endif                                                                  
      endif                                                                     
      if(lawyr.ge.1983) almtax = max(0.0d0,tax-taxaft)                          
      palm=0                                                                    
      ralm=0.                                                                   
      if(almtax.gt.0) palm= 1                                                   
      if(palm.gt.0.) then                                                       
        ralm=almrat*(1+.5*pssa)*100                                             
        if(punemp+pssa.le.0.and.pira.gt.0.and.pchar+pdical.le.0..and.           
     &   cded.gt.0) ralm=0.                                                     
        rate=ralm+reic                                                          
        if(zbr.gt.0.and.lawyr.lt.1982)then                                      
              rate=0.                                                           
              if(peic.eq.1) rate=reic                                           
        endif                                                                   
        if(zbr.eq.0)rate=ralm+reic                                              
        if(cded.gt.0.and.char.gt.0.and.agi.gt.0.and.lawyr.ne.1982)then          
         if(data(58).gt..5*agi)  rate=.5*rate                                   
         if(data(58).lt..5*agi.and.                                             
     &      (.5*agi.lt.data(59)+data(60).or.                                    
     &        (unchar.lt.data(59)+data(60).and.unchar.gt.0.)))                  
     &     rate=.5*rate                                                         
        endif                                                                   
      endif                                                                     
      if(palm.gt.0.and.cded.gt.0..and.pdical.gt.0.and.agi.gt.0.) then           
          if(lawyr.ge.1983) then                                                
             if(data(48).lt..01*agix) rate=rate*(1+.05)                         
             if(data(48).gt..01*agix) rate=rate*(1+.06)                         
          else                                                                  
             if(data(48).lt..01*agix) rate=rate*(1+.03)                         
             if(data(48).gt..01*agix) rate=rate*(1+.04)                         
          endif                                                                 
      endif                                                                     
      if(palm.gt.0.and.pira.gt.0) rate=reic                                     
      if(palm.gt.0.and.punemp.gt.0.and.agi.gt.0.) rate=1.5*ralm                 
c  taxsoi is the SOI definition of Total Tax, it does not include the           
c  refundable portion of the EITC                                               
      eitc = earncr                                                             
      if (tax.lt.eitc) then                                                     
         if (tax.gt.0.) eitc = tax                                              
         if (tax.le.0.) eitc = 0.                                               
      endif                                                                     
      taxsoi = taxaft - eitc                                                    
      taxnoa = taxbc - crdnoa - earncr                                          
      tax = tax - earncr                                                        
      pretax = max(regtax,altax,almtax,avrtax,(tax+eitc+credit))                
      if(palm.gt.0) ralm = ralm - rgrate                                        
      return                                                                    
      end                                                                       
c ******************************************************************************
c ******************************************************************************
c   Tax years 1986-2023, includes changes in the Tax Reform Acts of             
c   1986 and 97. (updated 04/15/21)                                             
c   diff between fed21a.for & fed21b.for: < $150k AGI limit for the unemployment
c   compensation exclusion                                                      
c   lawend = 2021                                                               
c ******************************************************************************
c ******************************************************************************
c                                                                               
      subroutine law87(data,lawyr)                                              
      implicit double precision (A-H,O-Z)                                       
      common /xndxac/ xndxa(1981:2023)                                          
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common /alm/ almsp,almr1,almr2                                            
      common /ssmaxa/ ssmax(1960:2029)                                          
      common /user/ zbrack(3,1987:2023),exem(1987:2023),                        
     &crmax(1987:2023,0:3,1:2),ymax(1987:2023,0:3,1:2),                         
     1rtbase(1987:2023,0:3), rtless(1987:2023,0:3),                             
     2chmax(1998:2023),ealim(2001:2023),cphas(7)                                
      common /newshr/                                                           
     &tax,agi,zbr,divall,fullcg,  capgn,capded,schede,coeff,retlim,             
     1iralim,ira,kghlim,keogh,ltg, dislim,adjust,drugs,hins,edical,             
     2cash,asset,char,deduc,polcon, cded,taxy,regtax,taxinc,deducp,             
     3dedint,twoded,almpay,dedphs,exded, pref,earny,psinc,exphs,exclnt,         
     4eacc,eti,etax,avrinc,acgtax, acgsav,avrtax,calt,excl,altax,               
     5gencr,taxbc,chcr,elder,exagi, edcred,candid,credit,earncr,taxsoi,         
     6eitc,offset,addmin,addtax,ti, rgrate,yad,exemps,alminy,almtax,            
     7addprf,rate,chr,statax,fica,c76,pretax,untax,ssagi,excess,                
     8chcred,disab,amex,ssa,tax2, telcr,capinc,tamt1,tamt2,bp,                  
     9dagidw,hoperf,chcr1,wpaycr,dyeic,tenpct,misc,alminc,almrat,regrat,        
     &pded,rded,pexem,rexem,pssa,rssa,pira,rira,pdical,rdical,                  
     &pchar,rchar,pcht,rcht,pchild,rchild,peic,reic,palm,ralm,                  
     &prent,rrent,pmisc,rmisc,pcasu,rcasu,pdisab,rdisab,psave,rsave,            
     &pxmp,rxmp,c133,c134,pold,rold,taxbca,xl38,xl39,xl40,                      
     &amtnon,oldcr,paddcr,raddcr,pedu,redu,xitamt,hope,life,c150,               
     &rent,ymod,taxng,taxaft,taxnoa,taxnon,sch10,sch20,sch25,pdedy,             
     &bppamt,bppeic,crdlst,pwpay,rwpay,pmcare,rmcare,xl46,xl47,amtr5,           
     &amtr15,amtr25,dicare,tax3,setax,chcrbc,zbrst,taxltg,disqy,addmtx,         
     &dedbus,ssearn,sstax1,sstax2,rmear,cares,rcare,eicme,addamt,ssmed,         
     &comadd(65)                                                                
c 09.07.2016 please do not change the name c150 in law87                        
      dimension data(255),eapct(2001:2023),exclds(1990:2023)                    
      dimension bbrack(3,1987:2023),almsep(1990:2023),amtsep(1990:2023)         
      dimension pinta(1987:1991),dstded(1987:2023),almspf(2013:2023)            
      dimension phas(1991:2012),zbrmin(1987:2023),                              
     & phctcm(2018:2023),phctch(2018:2023)                                      
      dimension edphls(1998:2023),edphhs(1998:2023),hopelm(1998:2023)           
      dimension edphlm(1998:2023),edphhm(1998:2023),uithrs(1987:2023)           
c pass-through income deduction threshold                                       
      dimension phin(2018:2023,2),phout(2018:2023,2)                            
      double precision iramax,iralim,ira,keogh,kghmax,kghlim,misc,ltg           
      double precision life,hope,newcr                                          
      integer datayr,sepret,amtage(1990:2023)                                   
      logical in                                                                
      data eapct/3*.10d0,20*.150d0/                                             
      data phctch/6*200000.d0/                                                  
      data phctcm/6*400000.d0/                                                  
      data phin/                                                                
     1   157500.d0,160700.d0,163300.d0,164900.d0,2*170050.d0,                   
     2   315000.d0,321400.d0,326600.d0,329800.d0,2*340100.d0/                   
      data phout/                                                               
     1   207500.d0,210700.d0,213300.d0,3*214900.d0,                             
     2   415000.d0,421400.d0,426600.d0,3*429800.d0/                             
      data zbrmin/4*500.d0,550.d0,5*600.d0,650.d0,3*700.d0,                     
     & 3*750.d0,2*800.d0,2*850.d0,  900.d0,4*950.d0,2*1000.d0,                  
     & 4*1050.d0, 5*1100.d0/                                                    
      data pinta    /.65,.40,.20,.10,.00/                                       
      data almspf    /179500.d0,182500.d0,185400.d0,186300.d0,187800.d0,        
     &                191100.d0,194800.d0,197900.d0,199900.d0,                  
     &              2*206100.d0/                                                
      data dstded   /4*500.d0,550.d0,3*600.d0,3*650.d0,3*700.d0,                
     &  3*750.d0,2*800.d0,3*850.d0,900.d0,3*950.d0,2*1000.d0,4*1050.d0,         
     &  5*1100.d0/                                                              
      data phas  /100000.,105250.,108450.,111800.,114700.,117950.,              
     &            121200.,124500.,126600.,128950.,132950.,137300.,              
     &            139500.,142700.,145950.,150500.,156400.,159950.,              
     &         2* 166800.,2*169550./                                            
      data bbrack /750., 600., 750., 750., 600., 750., 750., 600., 750.,        
     &             800., 650., 800., 850., 650., 850., 900., 700., 900.,        
     &             900., 700., 900., 950., 750., 950., 950., 750., 950.,        
     &            1000., 800.,1000.,1000., 800.,1000.,1050., 850.,1050.,        
     &            1050., 850.,1050.,1100., 850.,1100.,1100., 900.,1100.,        
     &            1150., 900.,1150.,1150., 950.,1150.,1200., 950.,1200.,        
     &            1250.,1000.,1250.,1250.,1000.,1250.,1300.,1050.,1300.,        
     &            1350.,1050.,1350.,1400.,1100.,1400.,1400.,1100.,1400.,        
     &            1450.,1150.,1450.,1450.,1150.,1450.,1500.,1200.,1500.,        
     &            1550.,1200.,1550.,1550.,1250.,1550.,1550.,1250.,1550.,        
     &            1550.,1250.,1550.,1600.,1300.,1600.,1650.,1300.,1650.,        
     &            1650.,1300.,1650.,1700.,1350.,1700.,1700.,1350.,1700.,        
     &            1700.,1350.,1700./                                            
      data edphls /4*40000.d0,2*41000.d0,42000.d0,43000.d0,45000.d0,            
     &    47000.d0,  48000.d0,2*50000.d0,51000.d0,52000.d0,53000.d0,            
     &    54000.d0,2*55000.d0,  56000.d0,57000.d0,58000.d0,4*59000.d0/          
      data edphhs /4*50000.d0, 2*51000.d0,52000.d0,53000.d0,55000.d0,           
     &    57000.d0,  58000.d0, 2*60000.d0,61000.d0,62000.d0,63000.d0,           
     &    64000.d0,2*65000.d0,   66000.d0,67000.d0,68000.d0,4*69000.d0/         
      data edphlm /4*80000.d0,   82000.d0,   83000.d0,   85000.d0,              
     &    87000.d0,  90000.d0,   94000.d0,   96000.d0,2*100000.d0,              
     &   102000.d0, 104000.d0,  107000.d0,  108000.d0,2*110000.d0,              
     &   112000.d0, 114000.d0,  116000.d0, 4*118000.d0/                         
      data edphhm /4*100000.d0, 102000.d0,  103000.d0,  105000.d0,              
     &   107000.d0,  110000.d0, 114000.d0,  116000.d0,2*120000.d0,              
     &   122000.d0,  124000.d0, 127000.d0,  128000.d0,  130000.d0,              
     &   131000.d0,  132000.d0, 134000.d0,  136000.d0,4*138000.d0/              
      data hopelm/8*1000.d0,2*1100.d0,1200.d0,2*2500.d0,13*2000.d0/             
      data exclds /6*1000.d0,2*1300.d0,5000.d0,5100.d0,5200.d0,5350.d0,         
     &       5500.d0,5600.d0,  5750.d0,5850.d0,6050.d0,6250.d0,6400.d0,         
     &     2*6700.d0,6800.d0,  6950.d0,7150.d0,7250.d0,7400.d0,7400.d0,         
     &       7500.d0,7600.d0,  7700.d0,7800.d0,3*7900.d0/                       
      data almsep/                                                              
     &     3* 20000.d0, 8* 22500.d0, 2* 24500.d0, 3* 29000.d0,                  
     &        31275.d0,    33125.d0,    34975.d0,    35475.d0,                  
     &        36225.d0,    37225.d0,    39375.d0,    40400.d0,                  
     &        41050.d0,    41700.d0,    41900.d0,    42250.d0,                  
     &        54700.d0,    55850.d0,    56700.d0, 3* 57300.d0/                  
      data amtsep/                                                              
     &     3*155000.d0, 8*165000.d0, 2*173000.d0, 3*191000.d0,                  
     &       200100.d0,   207500.d0,   214900.d0,   216900.d0,                  
     &       219900.d0,   223900.d0,   232500.d0,   238550.d0,                  
     &       242450.d0,   246250.d0,   247450.d0,   249450.d0,                  
     &       718800.d0,   733700.d0, 4*745200.d0/                               
c      data amtage /16*14,2*18,14*24/                                           
      data amtage /16*14,2*18,10*24,6*0/                                        
      data uithrs /22*0.d0,2400.d0,10*0.d0,10200.d0,3*0.d0/                     
c Public Law 116-94, Div O, section 501, suspended the special exemption limit  
c that would have applied in 2019 (and retroactively in 2018) to certain childre
c please change lawend to 2023 when 2023 update comes up                        
      lawend = lawyr                                                            
      if(lawyr.gt.2022) lawend = 2022                                           
      gencr = 0.                                                                
      xndx = xndxa(lawyr)                                                       
      datayr = int(data(103))                                                   
      blind = data(09)+data(10)                                                 
c  Function Filing: the format is Filing(MSTAT,V1,V2,V3,V4)                     
c  Where MSTAT is data(2)                                                       
c       V1    is the value of Filing if single                                  
c       V2    is the value of Filing if filing jointly                          
c       V3    is the value of Filing if head of household                       
c       V4    is the value of Filing if filing separately                       
c                                                                               
c  Marital status and sepret                                                    
      mstat = int(data(2))                                                             
      sepret=1                                                                  
      if(mstat.eq.3.or.mstat.eq.6) sepret=2                                     
      nfile = int(filing(mstat,1.,2.,3.,2.))                                    
      if(lawyr.le.lawend) then                                                  
        exema  = exem(lawyr)                                                    
        zbrmia = zbrmin(lawyr)                                                  
        zbr= zbrack(nfile,lawyr)/sepret+bbrack(nfile,lawyr)*blind               
c if you paid real estate taxes in 2008 or in 2009                              
       if(lawyr.eq.2008.or.lawyr.eq.2009)                                       
     &  zbr = zbr + min(data(51),data(7)*500.)                                  
c 2009 and 2010 additional Motor Vehicle Tax paid                               
       if((lawyr.ge.2009.and.lawyr.le.2010).and.data(55).gt.0)                  
     &  zbr = zbr + data(55)                                                    
        if(lawyr.ge.1998) hplm = hopelm(lawyr)                                  
        if(lawyr.ge.1991.and.lawyr.le.2012) phasa  = phas(lawyr)                
        dstdea = dstded(lawyr)                                                  
        if(lawyr.ge.1990) exds = exclds(lawyr)                                  
        if(lawyr.ge.1990) almspr = almsep(lawyr)                                
        if(lawyr.ge.1990) amtsp = amtsep(lawyr)                                 
      else                                                                      
        exema  = exem(lawend)*xndx/xndxa(lawend)                                
        zbrmia = zbrmin(lawend)*xndx/xndxa(lawend)                              
        zbr=(zbrack(nfile,lawend)/sepret+bbrack(nfile,lawend)*blind)*           
     &     xndx/xndxa(lawend)                                                   
        dstdea = dstded(lawend)*xndx/xndxa(lawend)                              
        hplm = hopelm(lawend)*xndx/xndxa(lawend)                                
        exds = exclds(lawend)*xndx/xndxa(lawend)                                
        almspr = almsep(lawend)*xndx/xndxa(lawend)                              
        amtsp = amtsep(lawend)*xndx/xndxa(lawend)                               
      endif                                                                     
      capded = 0.                                                               
c  Income terms used in imputation modules (see taxsim.ndx)                     
c  Long Term CAPITAL GAINS                                                      
c  1987-1996 gains treated as ordinary income, 28% top rate                     
c  1997-2000 20% maximum rate after 5/3/97 (10% for 15% bracket)                
c  Beginning 2001, 18% maximum rate (8% for 15% bracket) for assets             
c  held 5 years or more                                                         
c  For 1997, 1/3 of LTG changed to short to reflect transition year             
c  and holding period of 18 months after Jun97; ignore collectibles             
c                                                                               
      gshort = data(68)                                                         
      glong = data(70)                                                          
      fullcg = gshort+glong                                                     
      if(lawyr.ge.1997) fullcg = fullcg + data(18)                              
      capgn = fullcg                                                            
      capgn = max(capgn,-3000.0d0/sepret)                                       
      ltg = 0.                                                                  
      if(lawyr.ge.1997.and.fullcg.gt.0.) then                                   
         if(glong+data(18).gt.0..and.gshort.ge.0.) ltg = glong+data(18)         
         if(glong+data(18).gt.0..and.gshort.lt.0.) ltg = fullcg                 
      endif                                                                     
c HDP                                                                           
      if(data(176)+data(177).gt.0) then                                         
        divall = data(12)                                                       
        divq = data(12) - data(177)                                             
        divo = data(177)                                                        
      else                                                                      
        divall = data(12)                                                       
        divq = .67*data(12)                                                     
        divo = .33*data(12)                                                     
      endif                                                                     
      if(lawyr.ge.2003) then                                                    
        if(ltg.ge.0.0d0) then                                                   
          ltg = ltg + divq                                                      
        else                                                                    
          ltg = divq                                                            
        endif                                                                   
      endif                                                                     
c  Schedule E is given without rent income or loss here                         
      schede = data(74)+data(75)+data(76)+data(77)+data(78)+data(79)            
     & +data(213)                                                               
      rent = data(73)                                                           
      if(rent.ge.0) schede = schede+rent                                        
c extnd(86) : use data(142) instead of schede                                   
      if(extnd(86).gt.0.0d0) then                                               
         schede = data(142)                                                     
         rent = 0.                                                              
      endif                                                                     
      untax = data(82)                                                          
c Unemployment compensation exclusion -- ARRA 2009                              
      if(lawyr.eq.2009.and.extnd(44).eq.0.and.untax.gt.0)                       
     & untax = max(0.0d0,untax -uithrs(lawyr))                                  
      d17 = data(17)+data(211)+data(214)+data(212)+data(215)+data(213)          
      ti = capgn+data(11)+divall+data(14)+data(20)+                             
     & data(22)+data(23)+data(72)+schede+(d17-data(213))+                       
     & data(21)+data(24)+data(19)                                               
      if(lawyr.ne.2020) ti = ti + untax                                         
c  Keoughs & ira                                                                
c  next 2 c lines is for heritage                                               
      retlim = max(0.0d0,.15*(d17+data(76)+data(21))) +                         
     & .15*max(data(145)-data(114),0.0d0)                                       
      kghmax = 30000.*data(7)                                                   
      keogh = min(retlim,kghmax,data(28))                                       
      if(extnd(86).gt.0.0d0)  keogh = data(28)                                  
      ira = 0.                                                                  
      iramax = 2000.                                                            
      if(lawyr.ge.2002.and.lawyr.le.2004) iramax = 3000.                        
      if(lawyr.ge.2005.and.lawyr.le.2007) iramax = 4000.                        
      if(lawyr.ge.2008.and.(lawyr.le.2012.or.extnd(2).eq.1))                    
     & iramax = 5000.                                                           
      if(lawyr.ge.2013.and.lawyr.le.2015) iramax = 5500.                        
      if(lawyr.gt.2015) iramax = 5500*xndxa(lawyr)/xndxa(2015)                  
c for joint returns                                                             
      if(mstat.eq.2) then                                                       
        if(lawyr.le.1996) then                                                  
          wife =min(data(119),data(120))                                        
          husb =max(data(119),data(120),data(11)+d17-wife)                      
          husmax = min(husb,iramax)                                             
          wifmax = min(wife,iramax)                                             
          if (wifmax.lt.250.) wifmax = 250.                                     
          iramax = husmax + wifmax                                              
        else                                                                    
          iramax = data(7)*iramax                                               
        endif                                                                   
      endif                                                                     
      ira = min(iramax,data(29))                                                
c Other adjustments                                                             
      exagi = max(0.0d0,ti-15000.)                                              
      dislim = 5200.-exagi                                                      
      if (dislim.lt.0.) dislim = 0.                                             
      disab = min(data(25),dislim)                                              
      pdisab =0.                                                                
      if(disab.lt.data(25).and.dislim.gt.0) pdisab=1.                           
      amov = 0.                                                                 
      if(lawyr.ge.1994) amov = data(26)                                         
      if(extnd(87).gt.0) setax = data(43)                                       
c Earned income                                                                 
      earny = max(0.0d0,data(11) + (d17-data(213)) + data(21)-.5*setax)         
      if(lawyr.eq.2011.or.lawyr.eq.2012) then                                   
c 2011-2012 -- 5.65% instead of 7.65%                                           
          if(setax.le..133*ssmax(lawyr)) then                                   
           earny=max(0.0d0,                                                     
     &     data(11)+(d17-data(213))+data(21)-.5751*setax)                       
          else                                                                  
           earny = max(0.0d0,data(11) + (d17-data(213)) + data(21)-             
     &     .5*setax-.133*.0751*ssmax(lawyr))                                    
          endif                                                                 
      endif                                                                     
      earned = earny                                                            
c Total adjustments                                                             
      adjust = disab+keogh+data(30)+data(62)+data(124)+amov+data(27)            
      if(lawyr.ge.1990.and.lawyr.ne.2011.and.lawyr.ne.2012)                     
     & adjust = adjust+.5*setax                                                 
      if(lawyr.eq.2011.or.lawyr.eq.2012) then                                   
c 2011-2012 -- 5.65% instead of 7.65%                                           
          if(setax.le..133*ssmax(lawyr)) then                                   
           adjust = adjust + .5751*setax                                        
          else                                                                  
           adjust = adjust + .5*setax + .133*.0751*ssmax(lawyr)                 
          endif                                                                 
      endif                                                                     
      agi = ti-adjust                                                           
c rate (such as .2 times secondary earnings) (extnd(69))                        
c maximum earning eligible for deduction     (extnd(70))                        
c rate of clawback per 1000 of AGI           (extnd(71))                        
c threshold to start clawback                (extnd(72))                        
      twoded = 0.                                                               
      if (mstat.eq.2) then                                                      
         wife = max(0.d0,min(data(85),data(86)))                                
         sed1 = max(0.d0,                                                       
     &   extnd(69)-max(0.d0,extnd(71)*(agi-extnd(72))/1e3))                     
         twoded = max(0.d0,sed1*min(wife,extnd(70)))                            
      endif                                                                     
      adjust = adjust + twoded                                                  
      agi = agi - twoded                                                        
c Passive loss limitations apply only to rental losses                          
c Non-rental losses are considered allowable if reported by the SOI             
c Pensions in AGI:  data(20)+data(72)   Total pensions:  data(139), not used    
c Rental loss phaseout                                                          
      prent=0.                                                                  
      if(rent.lt.0) then                                                        
         phase1 = 100000./sepret                                                
         phase2 = 150000./sepret                                                
         if(agi.lt.phase1)  rent = max(-25000.0d0/sepret,rent)                  
         if (agi.ge.phase2) rent = 0.                                           
         if (agi.lt.phase2.and.agi.ge.phase1) then                              
c rent = rent*(phase2-agi)/(50000./sepret) -- old calculations                  
c form 8582 Passive activity loss limitations (Part II)                         
            excess = phase2 - agi                                               
            alimit = min(.5*excess,25000.d0/sepret)                             
            arent = -rent                                                       
c 'arent' and 'alimit' are positive amounts                                     
            rent = -min(arent,alimit)                                           
            prent=1                                                             
         endif                                                                  
         if(extnd(58).gt.0) prent = 0                                           
         ti = ti + rent                                                         
         agi = agi + rent                                                       
         schede = schede + rent                                                 
      endif                                                                     
c Phaseout of ira                                                               
      phaira = filing(mstat,25000.,40000.,25000.,20000.)*xndx                   
      if(lawyr.eq.1997) phaira=filing(mstat,35000.,50000.,35000.,35000.)        
      if(lawyr.eq.1998) phaira=filing(mstat,40000.,60000.,40000.,40000.)        
      if(lawyr.eq.1999) phaira=filing(mstat,41000.,61000.,41000.,41000.)        
      if(lawyr.eq.2000) phaira=filing(mstat,42000.,62000.,42000.,42000.)        
      if(lawyr.eq.2001) phaira=filing(mstat,43000.,63000.,43000.,43000.)        
      if(lawyr.eq.2002) phaira=filing(mstat,44000.,64000.,44000.,44000.)        
      if(lawyr.eq.2003) phaira=filing(mstat,50000.,70000.,50000.,50000.)        
      if(lawyr.eq.2004) phaira=filing(mstat,55000.,75000.,55000.,55000.)        
      if(lawyr.eq.2005) phaira=filing(mstat,60000.,80000.,60000.,60000.)        
      if(lawyr.eq.2006) phaira=filing(mstat,60000.,85000.,60000.,85000.)        
      if(lawyr.eq.2007)phaira=filing(mstat,62000.,103000.,62000.,62000.)        
      if(lawyr.eq.2008)phaira=filing(mstat,63000.,105000.,63000.,63000.)        
      if(lawyr.eq.2009)phaira=filing(mstat,65000.,105000.,65000.,65000.)        
      if(lawyr.eq.2010)phaira=filing(mstat,66000.,109000.,66000.,66000.)        
      if(lawyr.eq.2011)phaira=filing(mstat,66000.,110000.,66000.,66000.)        
      if(lawyr.eq.2012)phaira=filing(mstat,68000.,112000.,68000.,68000.)        
      if(lawyr.eq.2013)phaira=filing(mstat,69000.,115000.,69000.,69000.)        
      if(lawyr.eq.2014)phaira=filing(mstat,70000.,116000.,70000.,70000.)        
      if(lawyr.ge.2015.and.lawyr.le.2016)                                       
     &                 phaira=filing(mstat,71000.,118000.,71000.,71000.)        
      if(lawyr.ge.2017) then                                                    
      phaira=filing(mstat,71000.,118000.,71000.,71000.)*xndx/xndxa(2016)        
      endif                                                                     
      range = 10000.                                                            
      agira=agi                                                                 
      if (agi.gt.phaira) then                                                   
         agira=agi                                                              
         ira = ira*(1.-(agi-phaira)/range)                                      
         if (ira.lt.0.) ira = 0.                                                
      endif                                                                     
      if(extnd(86).gt.0.0d0)  ira = data(29)                                    
      agi = agi - ira                                                           
      adjust = adjust + ira                                                     
c SSB in agi                                                                    
      ssa = max(0.0d0,data(91))                                                 
      ssagi = 0.                                                                
      pssa=0.                                                                   
      if (ssa.gt.0.) then                                                       
         ymod = agi+data(41)+.5*ssa                                             
         if(lawyr.eq.2020) ymod = ymod + data(82)                               
         ssexcl = filing(mstat,25000.,32000.,25000.,0.)                         
         if(extnd(17).ne.0.0d0) ssexcl =                                        
     &    filing(mstat,25000.,32000.,25000.,0.)*xndxa(lawyr)/xndxa(1984)        
         if (lawyr.le.1993) ssagi = min(ssa,max(0.0d0,ymod-ssexcl))*.5          
         if (lawyr.ge.1994) then                                                
             xlin9 = max(0.0d0,ymod-ssexcl)                                     
             xlin11 = max(0.0d0,xlin9 -                                         
     &       filing(mstat,9000.,12000.,9000.,0.))                               
             xlin13 = .5 *                                                      
     &        min(xlin9,filing(mstat,9000.,12000.,9000.,0.))                    
             xlin14 = min(xlin13, .5*ssa)                                       
            ssagi = min(.85*ssa, xlin14 + .85*xlin11)                           
c Next formulas have economics sense                                            
c           ssexcl1 =  ssexcl+filing(mstat,9000.,12000.,9000.,0.)               
c           if(ymod.ge.ssexcl.and.ymod.le.ssexcl1) then                         
c            ssagi = .5*(ymod-ssexcl,ssa)                                       
c           else if(ymod.gt.ssexcl1) then                                       
c            ssagi = min(.85*(ymod-ssexcl1)+.5(ssexcl1-ssexcl),.85*ssa)         
c           endif                                                               
         endif                                                                  
         if(extnd(86).gt.0.0d0.and.sepret.eq.2) ssagi = data(92)                
         agi = agi + ssagi                                                      
         ti = ti + ssagi                                                        
         if(lawyr.ge.1994) then                                                 
           if(ssagi.gt.0.and..85*ssa.gt.xlin14 + .85*xlin11) pssa = 1           
         else                                                                   
           if(ssa.gt.ymod-ssexcl.and.ymod.gt.ssexcl) pssa=1                     
         endif                                                                  
      endif                                                                     
      pssa1=0.                                                                  
      pssa2=0.                                                                  
      if(pssa.eq.1.and.lawyr.ge.1994) then                                      
       if(xlin9.gt.filing(mstat,9000.,12000.,9000.,0.))then                     
          pssa1=1                                                               
       else if(xlin9.lt.filing(mstat,9000.,12000.,9000.,0.).and.                
     &   xlin13.lt..5*ssa) then                                                 
          pssa2=1.                                                              
        endif                                                                   
      endif                                                                     
      if(lawyr.le.1993) pssa2=pssa                                              
      dagidw = 1. + pssa1*.85 + pssa2*.5 + pdisab                               
     &+ prent*abs(max(data(73),-25000.0d0/sepret))/(50000.0d0/sepret)           
c 2020 CARES has $10200 unemployment exemption for a taxpayer(and spouse) if mod
      if(lawyr.eq.2020.and.untax.gt.0.d0) then                                  
        if(agi.lt.150000.d0) then                                               
           exclw = min(data(180),uithrs(lawyr))                                 
           exclh = max(0.d0,min(untax - data(180),uithrs(lawyr)))               
           excl = exclw + exclh                                                 
           untax = untax - excl                                                 
        endif                                                                   
        agi = agi + untax                                                       
        ti = ti + untax                                                         
      endif                                                                     
      agix = max(0.0d0,agi)                                                     
c Itemized Deductions                                                           
c Charitable contributions                                                      
      pchar=0.                                                                  
      pchar1=0.                                                                 
      pchar2=0.                                                                 
      cash = data(58)                                                           
      asset = data(59)+data(60)                                                 
      alim50 = .5*agix                                                          
c For 2020-21, a temporary suspension of certain limitations that apply to cash 
      if(lawyr.eq.2020.or.lawyr.eq.2021) alim50 = 1.e20                         
      unchar = 0.                                                               
      if (agi.lt.0.) then                                                       
         cash = 0.                                                              
         asset = 0.                                                             
      else                                                                      
         if (cash.gt.alim50) then                                               
            cash = alim50                                                       
            asset = 0.                                                          
            pchar1=1                                                            
         else                                                                   
            unchar = alim50 - cash                                              
            if(asset.gt..3*agi.and.unchar.gt..3*agi) pchar2=1                   
            if(unchar.lt.asset.and.unchar.lt..3*agi) pchar1=1                   
c            asset = min(asset,.3*agi,unchar)                                   
c            asset = max(0.0d0,asset)                                           
         endif                                                                  
      endif                                                                     
      asset = min(.3*agix,asset)                                                
      char = min(alim50,cash+asset)                                             
      char = max(0.0d0,char)                                                    
      pchar=pchar1+pchar2                                                       
c Miscelleneous deduction                                                       
      misc = data(63)                                                           
      misc = max(0.0d0,misc-.02*agix)                                           
c TCJA eliminates misc ded subject to 2% floor                                  
      if(lawyr.ge.2018.and.lawyr.le.2025) misc = 0.d0                           
      pmisc=0                                                                   
      if(misc.gt.0) pmisc=1                                                     
c Medical Deduction                                                             
      edical = data(47)+data(48)+data(49)                                       
      if((lawyr.ge.2013.and.lawyr.le.2016).and.data(9).lt.1) then               
         edical = max(0.0d0,edical-.1*agix)                                     
      else if(lawyr.le.2018) then                                               
         edical = max(0.0d0,edical-.075*agix)                                   
      else                                                                      
         edical = max(0.0d0,edical-.1*agix)                                     
      endif                                                                     
c Casuaty or Theft Losses                                                       
      casu = max(0.0d0,data(61)-100.)                                           
      casu = max(0.0d0,casu-.1*agix)                                            
      if(lawyr.eq.2009) casu = max(0.0d0,data(61)-max(500.0d0,.1*agix))         
c Interest deduction                                                            
      persin = min(data(57),2000.0d0)                                           
      if (datayr.ge.1987) persin=data(121)                                      
      if (lawyr.ge.1987.and.lawyr.lt.1991) then                                 
         persin = pinta(lawyr)*persin                                           
      else                                                                      
         persin = 0.                                                            
      endif                                                                     
      busint = max(0.0d0,data(57)-persin)                                       
      xid = max(0.0d0,divall+data(14)+capgn)                                    
      dedint = min(xid,busint)                                                  
      xmov = data(26)                                                           
      if (lawyr.ge.1994) xmov = 0                                               
      if(lawyr.le.2017) then                                                    
         sttax = data(50)                                                       
         if(lawyr.ge.2004.and.lawyr.le.2013) sttax = max(sttax,data(52))        
         deduc1 = char+sttax+data(51)+data(54)+data(56)+                        
     &   misc+busint+persin+data(66)+xmov                                       
      else                                                                      
c 2018+ state and local taxes and Real estate property taxes                    
c and Personal property taxes are now capped at $10K on Sch A                   
c         sttax = min(10000.d0/sepret,data(51)+data(50)+data(54))               
c         deduc1 = sttax + data(56)+char+busint+persin+data(66)                 
         sttax=data(51)+data(50)+data(54)                                       
         stxlim= 10000.d0/sepret                                                
         if(extnd(8).gt. 0) stxlim=extnd(8)/sepret                              
         if(extnd(8).eq.-1) stxlim=0                                            
         sttax=min(stxlim,sttax)                                                
         deduc1 = sttax + data(56)+char+busint+persin+data(66)                  
      endif                                                                     
c Motor Vehicle tax is a part of itemized deductions                            
      if(lawyr.eq.2009.or.lawyr.eq.2010) deduc1 = deduc1+data(55)               
      dedint = data(56)+busint+persin                                           
      deduc2 = casu+edical+data(53)                                             
c      write(16,*) 'deduc1 deduc2 in fed',deduc1,deduc2                         
                                                                                
c deducp - total amount of item. deductions before phaseout.                    
c Needed for state tax calculator                                               
      deducp = deduc1+deduc2                                                    
c Deductions phase-out indicator                                                
      pded = 0.                                                                 
      dedphs = 0.                                                               
      dlim1 = 0.                                                                
      dlim2 = 0.                                                                
      if (lawyr.ge.1991.and.lawyr.le.2017) then                                 
c Pease Limitations; no limitations 2018+                                       
         if(lawyr.le.2012) then                                                 
            phase = phasa/sepret                                                
         else if (lawyr.eq.2013) then                                           
            phase = filing(mstat,250000.,300000.,275000.,150000.)               
         else if (lawyr.eq.2014) then                                           
            phase = filing(mstat,254200.,305050.,279650.,152525.)               
         else if (lawyr.eq.2015) then                                           
            phase = filing(mstat,258250.,309900.,284050.,154950.)               
         else if (lawyr.eq.2016) then                                           
            phase = filing(mstat,259400.,311300.,285350.,155650.)               
         else if (lawyr.eq.2017) then                                           
            phase = filing(mstat,261500.,313800.,287650.,156900.)               
         endif                                                                  
         dlim1 = .03*max(0.0d0,agi-phase)                                       
         dlim2 = .8*max(0.0d0,deduc1-data(57)-data(168))                        
         if(lawyr.eq.2006.or.lawyr.eq.2007)then                                 
            dlim1 = 2*dlim1/3                                                   
            dlim2 = 2*dlim2/3                                                   
         endif                                                                  
         if(lawyr.eq.2008.or.lawyr.eq.2009) then                                
            dlim1 = dlim1/3                                                     
            dlim2 = dlim2/3                                                     
         endif                                                                  
         if(lawyr.ge.2010.and.lawyr.le.2012) then                               
            dlim1 = 0.                                                          
            dlim2 = 0.                                                          
         endif                                                                  
         dedphs = min(dlim1,dlim2)                                              
         deduc1 = deduc1 - dedphs                                               
c       write(16,*) 'deduc1 after phaseout in fed',deduc1                       
                                                                                
         if(dedphs.gt.0.and.dedphs.lt.dlim2) pded = 1                           
         if(dedphs.gt.0.and.dedphs.lt.dlim2) pdedy = 1                          
         if((pchar.eq.1.or.pmisc.eq.1).and.dedphs.eq.dlim2.                     
     &    and.dedphs.gt.0) pded=1                                               
      endif                                                                     
      deduc = max(0.0d0,deduc1+deduc2)                                          
c MSF wants a limit for itemized deductions                                     
      if(extnd(61).gt.0) deduc = min(deduc,extnd(61))                           
      if(lawyr.le.lawend) then                                                  
       c141 = zbrack(1,lawyr)                                                   
       if(gjtrra.ne.0.0d0.and.(mstat.eq.2.or.sepret.eq.2)) then                 
        if(lawyr.eq.2003) zbr= 7950.d0/sepret+bbrack(nfile,lawyr)*blind         
        if(lawyr.eq.2004) zbr= 8100.d0/sepret+bbrack(nfile,lawyr)*blind         
       endif                                                                    
      else                                                                      
       c141 = zbrack(1,lawend) *xndx/xndxa(lawend)                              
      endif                                                                     
c   Zero bracket amount, includes calculations for dependent returns            
      earnkd = data(11)+max(0.0d0,d17-data(124))                                
      if(lawyr.ge.1998.and.lawyr.le.2005) earnkd = earnkd+250.                  
      if(lawyr.ge.2006.and.lawyr.le.2012) earnkd = earnkd+300.                  
      if(lawyr.ge.2013) earnkd = earnkd+350.                                    
      if (data(105).gt.0.)zbr = min(zbr,max(zbrmia,earnkd))                     
      if(extnd(39).gt.0.) then                                                  
       if(mstat.eq.1.or.mstat.eq.3.or.mstat.eq.6)zbr = zbr + extnd(39)          
       if(mstat.eq.2.or.mstat.eq.5) zbr = zbr + 2*extnd(39)                     
       if(mstat.eq.4.or.mstat.eq.7) zbr = zbr + 1.5*extnd(39)                   
      endif                                                                     
      if(extnd(42).gt.0.and.extnd(43)-extnd(42).gt.0) zbr =                     
     & zbr*(1-twn((agi-extnd(42)/extnd(43)-extnd(42)),0.0d0,1.0d0))             
c zbrst for state purposes                                                      
      zbrst = zbr                                                               
c  Itemized Deductions                                                          
      cded = 0.                                                                 
      yad = agi                                                                 
      excess = 0.                                                               
      if(data(4).eq.-1.or.data(4).eq.3) zbr = 0.                                
      if(data(4).eq.-2.or.data(4).eq.3) deduc = 0.                              
      if(data(4).eq.1.and.sepret.eq.2) zbr = 0.                                 
      if(data(4).eq.2.and.sepret.eq.2) then                                     
         deduc = 0.                                                             
         deducp = 0                                                             
      endif                                                                     
      zbr = max(0.0d0,zbr+extnd(75))                                            
      cas = 0.d0                                                                
c 2021 take up to $300 ($600 for joint) cash contributions if stded             
      if(lawyr.eq.2021) cas = min(300.d0*data(7),data(58))                      
      if ((deduc.gt.zbr+cas.and.data(4).ge.0).or.data(4).eq.-1) then            
         cded = 1.                                                              
         yad = yad-deduc+zbr+cas                                                
         excess = deduc-zbr-cas                                                 
      else if(data(4).eq.-3) then                                               
c Always take deductions as max(item,zbr+cas) if data(4)=-3                     
         ded = max(deduc,zbr+cas)                                               
         if(ded.ne.zbr+cas) then                                                
           cded = 1.                                                            
         else                                                                   
           cded = 0.                                                            
         endif                                                                  
         yad = agi-ded+zbr+cas                                                  
      else                                                                      
         deduc = 0.                                                             
         yad = yad-cas                                                          
      endif                                                                     
c 2020 take up to $300/sepret cash contributions if you take stded              
      if(cded.eq.0.and.lawyr.eq.2020.and.data(58).gt.0.d0) then                 
         agi  = agi - min(300.d0/sepret,data(58))                               
         yad = yad - min(300.d0/sepret,data(58))                                
      endif                                                                     
      exemps = data(7)+data(8)                                                  
c No exemption for dependent returns                                            
      xmp = 1 + data(08)                                                        
c extnd(74) -- no exemption for a spouse                                        
      if(mstat.eq.2) xmp = xmp + (1-extnd(74))                                  
c      xmp = data(07)+data(08)                                                  
      amex = exema*xmp                                                          
      if(extnd(85).gt.0) then                                                   
         amex = max(0.0d0,amex - data(7)*exema)                                 
         exemps = exemps - data(7)                                              
      endif                                                                     
      if(lawyr.ge.2018) amex = 0.                                               
c Exemption phaseout                                                            
      ratio = 0.                                                                
      exmphl = 0.                                                               
      if (in(lawyr,1991,1996)) then                                             
         exmphl =                                                               
     &     filing(mstat,100000.,150000.,125000.,75000.)*xndx/1.143              
         if (agi.gt.exmphl) then                                                
           ratio = 0.02*max(0.0d0,(agi-exmphl)/(2500./sepret))                  
           amex = max(amex*(1.-ratio),0.0d0)                                    
         endif                                                                  
      elseif (lawyr.ge.1997.and.lawyr.le.2017)then                              
         if (lawyr.le.1998)                                                     
     &exmphl = filing(mstat,124500.,186800.,155650.,93400.)                     
         if (lawyr.eq.1999)                                                     
     &exmphl = filing(mstat,126600.,189950.,158300.,94975.)                     
         if (lawyr.eq.2000)                                                     
     &exmphl = filing(mstat,128950.,193400.,161150.,96700.)                     
         if (lawyr.eq.2001)                                                     
     &exmphl = filing(mstat,132950.,199450.,166200.,99725.)                     
         if (lawyr.eq.2002)                                                     
     &exmphl = filing(mstat,137300.,206000.,171650.,103000.)                    
         if (lawyr.eq.2003)                                                     
     &exmphl = filing(mstat,139500.,209250.,174400.,104625.)                    
         if (lawyr.eq.2004)                                                     
     &exmphl = filing(mstat,142700.,214050.,178350.,107025.)                    
         if (lawyr.eq.2005)                                                     
     &exmphl = filing(mstat,145950.,218950.,182450.,109475.)                    
         if (lawyr.eq.2006)                                                     
     &exmphl = filing(mstat,150500.,225750.,188150.,112875.)                    
         if(lawyr.eq.2007)                                                      
     &exmphl = filing(mstat,156400.,234600.,195500.,117300.)                    
         if(lawyr.eq.2008)                                                      
     &exmphl = filing(mstat,159950.,239950.,199950.,119975.)                    
         if(lawyr.eq.2009.or.lawyr.eq.2010)                                     
     &exmphl = filing(mstat,166800.,250200.,208500.,125000.)                    
         if(lawyr.eq.2011.or.lawyr.eq.2012)                                     
     &exmphl = filing(mstat,169550.,254350.,211950.,127300.)                    
         if(lawyr.eq.2013)                                                      
     &exmphl = filing(mstat,250000.,300000.,275000.,150000.)                    
         if(lawyr.eq.2014)                                                      
     &exmphl = filing(mstat,254200.,305050.,279650.,152525.)                    
          if(lawyr.eq.2015)                                                     
     &exmphl = filing(mstat,258250.,309900.,284050.,154950.)                    
          if(lawyr.eq.2016)                                                     
     &exmphl = filing(mstat,259400.,311300.,285350.,155650.)                    
          if(lawyr.eq.2017)                                                     
     &exmphl = filing(mstat,261500.,313800.,287650.,156900.)                    
         if (agi.gt.exmphl) then                                                
          if(lawyr.ge.2010.and.lawyr.le.2012) then                              
             ratio=0.                                                           
          else                                                                  
             ratio = min(1.0d0,.02*max(0.0d0,agi-exmphl)/(2500/sepret))         
          endif                                                                 
          amphs =  ratio * amex                                                 
          if(lawyr.le.2005.or.lawyr.ge.2011) then                               
            amphs =  ratio * amex                                               
          else if(lawyr.eq.2006.or.lawyr.eq.2007) then                          
            amphs =  ratio * amex * 2/3                                         
          else if(lawyr.eq.2008.or.lawyr.eq.2009) then                          
            amphs =  ratio * amex * 1/3                                         
          endif                                                                 
c a flag to turn off the personal exemptions phaseout                           
          if(extnd(14).eq.2.0d0) amphs = 0.                                     
          amex = amex - amphs                                                   
         endif                                                                  
      endif                                                                     
      if (data(105).gt.0.) then                                                 
         amex = 0.d0                                                            
         exemps = 0.d0                                                          
      endif                                                                     
      exphs=exema*xmp-amex                                                      
c a flag to turn off the personal exemption                                     
      if(extnd(14).eq.1.0d0) amex = 0.                                          
      pexem = 0.                                                                
      if(amex.gt.0.and.exphs.gt.0.and.agi-exmphl.le.122500/sepret)              
     & pexem=1.                                                                 
c taxable income                                                                
      if (data(105).eq.0.) then                                                 
        taxin1 = yad-amex-zbr                                                   
      else                                                                      
        if (lawyr.le.1997) then                                                 
           taxin1 = agi-max(deduc,min(zbr,max(dstdea,earned)))                  
        elseif (in(lawyr,1998,2000)) then                                       
         taxin1 = agi-max(deduc,min(zbr,max(dstdea,earned+250.)))               
        elseif (in(lawyr,2001,2005)) then                                       
           depstd = dstdea                                                      
           taxin1 = agi-max(deduc,min(zbr,max(depstd,earned+250.)))             
        elseif (in(lawyr,2006,2012)) then                                       
           depstd = dstdea                                                      
           taxin1 = agi-max(deduc,min(zbr,max(depstd,earned+300.)))             
        else                                                                    
           depstd = dstdea                                                      
           taxin1 = agi-max(deduc,min(zbr,max(depstd,earned+350.)))             
                                                                                
        endif                                                                   
      endif                                                                     
      taxinc = max(0.0d0,taxin1)                                                
      dedbus = 0.d0                                                             
c 2018+ pass-through income qualifies for 20% deduction                         
      if(lawyr.ge.2018) then                                                    
        nunmar = 1                                                              
        if(data(2).eq.2) nunmar = 2                                             
        if(lawyr.le.lawend) then                                                
             phin1 = phin(lawyr,nunmar)                                         
             phout1 = phout(lawyr,nunmar)                                       
             if(lawyr.eq.2019.and.sepret.eq.2) then                             
               phin1 = 160725.d0                                                
               phout1 = 210725.d0                                               
             endif                                                              
        else                                                                    
             phin1 = phin(lawend,nunmar)*xndx/xndxa(lawend)                     
             phout1 = phout(lawend,nunmar)*xndx/xndxa(lawend)                   
        endif                                                                   
        cgain = max(0.d0,capgn)+data(176)                                       
        sstbde = 0.d0                                                           
        qbided = 0.d0                                                           
c QBI  w/o phase-out                                                            
        d211 = max(0.0d0,data(211))+max(0.0d0,data(214))                        
c SSTB w phase out                                                              
        d212 = max(0.0d0,data(212))+max(0.0d0,data(215))                        
c       write(0,*) 'd212',d212                                                  
c                                                                               
        if(d212.gt.0.d0.or.data(213).gt.0.d0) then                              
c data(213) S-Corp income                                                       
           sstb = data(213)                                                     
           if(d212.gt.0.d0) then                                                
              ratio = d212/(d211+d212)                                          
              sstb = sstb + max(0.d0,d212 - .5*setax*ratio)                     
           endif                                                                
c           write(0,*) 'sstb',sstb                                              
c           write(0,*) 'taxinc phin1 phout1',taxinc,phin1,phout1                
c  sstb specified service trade or business                                     
c  where principal asset is the reputation or skill                             
           perc1 = min(1.d0,max(0.d0,(taxinc - phin1)/(phout1 - phin1)))        
           perc2 = 1-perc1                                                      
           sstb = sstb*perc2                                                    
c           write(0,*) 'perc1 perc2 sstb',perc1,perc2,sstb                      
                                                                                
           sstbde = .2*sstb                                                     
c          write(0,*) '1 sstbde',sstbde                                         
           sstbde = sstbde*perc2                                                
c          write(0,*) '2 sstbded',sstbde                                        
        endif                                                                   
        if(d211.gt.0.d0) then                                                   
c  qbi  all other pass-through businesses                                       
           ratio = d211/(d211+d212)                                             
           qbi = max(0.d0,d211 - .5*setax*ratio)                                
c          write(0,*) d211,setax,ratio                                          
           qbided = .2d0*qbi                                                    
        endif                                                                   
        dedbus = min(sstbde+qbided,.2*max(0.d0,taxinc - cgain))                 
c        write(0,*) sstbde,qbided,taxinc,cgain                                  
        taxinc = max(0.d0, taxinc - dedbus)                                     
c        write(0,*) dedbus, taxinc                                              
      endif                                                                     
c Don't itemize unless this is a benefit                                        
      if((cded.gt.0.and.taxinc.eq.0.and.agi-amex-zbr.lt.0).or.                  
     &             data(4).eq.-2)then                                           
         cded = 0.                                                              
         deduc= 0.                                                              
         edical = 0.                                                            
      endif                                                                     
c  surtax on 15% rate savings, only for 1988-90                                 
c  difference4                                                                  
      rsave = 0.                                                                
      psave = 0.                                                                
      tax2 = 0.                                                                 
      saving = 0.                                                               
      if (in(lawyr,1988,1990)) then                                             
         phase = filing(mstat,43150.,71900.,61650.,35950.)*xndx                 
         if (taxinc.gt.phase) then                                              
            saving = filing(mstat,2320.5,3867.5,3107.0,3867.5)*xndx             
            tax2 = .05*(taxinc-phase)                                           
            rsave = .05*dagidw                                                  
            if (tax2.gt.saving) then                                            
               tax2 = saving                                                    
               rsave = 0.                                                       
            endif                                                               
         endif                                                                  
         if(rsave.gt.0) psave = 1.                                              
      endif                                                                     
c                                                                               
c     Exemption surtax, only for 1988-1996                                      
c                                                                               
c  difference5                                                                  
      tax3 = 0.                                                                 
      rxmp = 0.                                                                 
      pxmp = 0.                                                                 
      if (in(lawyr,1988,1996)) then                                             
         phase = filing(mstat,89560.,149250.,123790.,113300.)*xndx              
         if (taxinc.gt.phase) then                                              
            tax3 = .05*(taxinc-phase)                                           
            rxmp = .05*dagidw                                                   
            if (tax3.ge.amex*.28) then                                          
              rxmp = 0.                                                         
              if(pexem.eq.1)                                                    
     &    rxmp=-.28*.02*exema*xmp/(2500./sepret)*dagidw                         
            endif                                                               
            if (tax3.gt.amex*.28) tax3 = amex*.28                               
         endif                                                                  
         if(rxmp.ne.0) pxmp = 1.                                                
      endif                                                                     
c                                                                               
c Regular tax.  Use taxin3 to avoid changing the value of taxinc                
c during tax table calculations.                                                
c                                                                               
      brac15=0.                                                                 
      surtax = 0.                                                               
      taxin3 = taxinc                                                           
      tax11=0.                                                                  
      if (lawyr.eq.1987) then                                                   
         call tax87(taxin3,sepret,nfile,regrat,tax11,data)                      
         regtax=tax11                                                           
      elseif   (in(lawyr,1988,1990)) then                                       
         call tax88(taxin3,sepret,nfile,regrat,tax11)                           
         regtax=tax11                                                           
      elseif (in(lawyr,1991,1992)) then                                         
         call tax91(taxin3,sepret,nfile,regrat,tax11,data,regtax)               
      elseif(lawyr.eq.1993) then                                                
         data68=data(68)                                                        
         data70=data(70)                                                        
         data(68)=0.                                                            
         data(70)=0.                                                            
         call tax93                                                             
     &(taxin3,sepret,nfile,regrat,tax11,data,tax36,surtax,short,regtax)         
         data(68)=data68                                                        
         data(70)=data70                                                        
         call tax93                                                             
     &(taxin3,sepret,nfile,regrat,tax11,data,tax36,surtax,short,regtax)         
      elseif(in(lawyr,1994,1996)) then                                          
         call tax94                                                             
     & (taxin3,sepret,nfile,regrat,tax11,data,tax36,surtax,short,lawyr,         
     & regtax)                                                                  
      elseif(in(lawyr,1997,2000)) then                                          
         call tax97                                                             
     &   (taxin3,sepret,nfile,regrat,tax11,data,lawyr,brac15,                   
     &                  regtax,taxng,taxltg,ltg)                                
      elseif(lawyr.ge.2001) then                                                
        if(egtrra.eq.1.0d0) then                                                
         call tax01                                                             
     &   (lawyr,taxin3,sepret,nfile,regrat,tax11,data,brac15,                   
     &       regtax,taxng,taxltg,ltg,sch10,sch20,sch25,addtax)                  
        else                                                                    
         call tax97                                                             
     &   (taxin3,sepret,nfile,regrat,tax11,data,lawyr,brac15,                   
     &                  regtax,taxng,taxltg,ltg)                                
        endif                                                                   
      endif                                                                     
c                                                                               
      taxbc = max(0.0d0,tax11+tax2+tax3)                                        
      if(lawyr.ge.2000) taxbc = taxbc + data(46)                                
c      write(0,*) 'taxinc taxbc',taxinc,taxbc                                   
      if(taxin1.lt.0) regrat=0.                                                 
      rgrate = regrat*100                                                       
c rexem- additional rate because of exemptions phaseout                         
      rexem= 0.                                                                 
      if(pexem.eq.1.) rexem =                                                   
     &  dagidw*rgrate*.02*exema*xmp/(2500./sepret)                              
c      write(*,*) 'rexem dagidw rgrate .02*exema*xmp/(2500./sepret)',           
c     &rexem, dagidw, rgrate, .02*exema*xmp/(2500./sepret)                      
c rded- additional rate because of itemized deduction phaseout                  
      rded = 0.                                                                 
      pded1=0                                                                   
      pded2=0                                                                   
      if(pded.eq.1.and.cded.gt.0) rded = .03*rgrate                             
      if(pded.eq.1.and.cded.gt.0.and.dedphs.eq.dlim2.and.pchar2.eq.1)           
     & then                                                                     
        rded=.3*.8*rgrate                                                       
        pded1=1                                                                 
      endif                                                                     
      if(pded.eq.1.and.cded.gt.0.and.dedphs.eq.dlim2.and.pchar1.eq.1)           
     &  then                                                                    
         rded=.5*.8*rgrate                                                      
         pded2=1                                                                
      endif                                                                     
      if(lawyr.eq.2006.or.lawyr.eq.2007) then                                   
        rded = .66*rded                                                         
        rexem = .66*rexem                                                       
      else if(lawyr.eq.2008.or.lawyr.eq.2009) then                              
        rded = .33*rded                                                         
        rexem = .33*rexem                                                       
      else if(lawyr.eq.2010) then                                               
        rded = 0.                                                               
        rexem = 0.                                                              
      endif                                                                     
c rcasu -additional rate because of casualty and theft losses                   
      rcasu = 0.                                                                
      pcasu = 0.                                                                
      if(data(61)-100.gt..1*agix.and.cded.gt.0) pcasu = 1                       
      if(pcasu.eq.1)  rcasu = .1*rgrate*dagidw                                  
c rdical -additional rate because of medical expenses amount                    
      rdical = 0.                                                               
      pdical = 0.                                                               
      if(data(47)+data(48)+data(49).gt.0.075*agix.and.cded.gt.0) then           
        pdical = 1                                                              
        rdical = .075*rgrate*dagidw                                             
      endif                                                                     
c rchar - additional rate because of charitable contributions                   
      rchar = 0.                                                                
      if(cded.gt.0) then                                                        
        if(pchar1.eq.1)  then                                                   
         rchar=.5*rgrate*dagidw                                                 
        elseif(pchar2.eq.1) then                                                
         rchar=.3*rgrate*dagidw                                                 
        endif                                                                   
      endif                                                                     
c rmisc -additional rate because of miscelleneous deductions                    
      rmisc=0                                                                   
      if(cded.gt.0.and.pmisc.eq.1) rmisc=.02*rgrate*dagidw                      
c Marginal rate for disability                                                  
      rdisab =0.                                                                
      if(pdisab.eq.1)  rdisab=rgrate                                            
      ddeddw=0                                                                  
      if(cded.gt.0)                                                             
     &ddeddw=(pdical*.075+.1*pcasu+.02*pmisc-.5*pchar1-.3*pchar2+               
     &.03*pded+.3*.8*pded1+.5*.8*pded2)*dagidw                                  
c                                                                               
c Alternative Minimum Tax                                                       
c TRA2001 provides for an additional $2000 in pers against the AMT              
c which we add to excl                                                          
c                                                                               
c  no regular tax, only amt                                                     
      if(extnd(16).gt.0.and.lawyr.ge.2000) taxbc = 0.                           
      amtpi2=amtpi**(lawyr-2001.0d0)                                            
      almtax = 0.                                                               
      if(lawyr.gt.lawend) then                                                  
         excl = filing(mstat,75900.,118100.,75900.,59050.)*                     
     & xndx/xndxa(lawend)                                                       
      else if(lawyr.eq.2022) then                                               
         excl = filing(mstat,75900.,118100.,75900.,59050.)                      
      else if(lawyr.eq.2021) then                                               
         excl = filing(mstat,73600.,114600.,73600.,57300.)                      
      else if(lawyr.eq.2020) then                                               
         excl = filing(mstat,72900.,113400.,72900.,56700.)                      
      else if(lawyr.eq.2019) then                                               
         excl = filing(mstat,71700.,111700.,71700.,55850.)                      
      else if(lawyr.eq.2018) then                                               
         excl = filing(mstat,70300.,109400.,70300.,54700.)                      
      else if(lawyr.eq.2017) then                                               
         excl = filing(mstat,54300.,84500.,54300.,42250.)                       
      else if(lawyr.eq.2016) then                                               
         excl = filing(mstat,53900.,83800.,53900.,41900.)                       
      else if(lawyr.eq.2015) then                                               
         excl = filing(mstat,53600.,83400.,53600.,41700.)                       
      else if(lawyr.eq.2014) then                                               
         excl = filing(mstat,52800.,82100.,52800.,41050.)                       
      else if(lawyr.eq.2013) then                                               
         excl = filing(mstat,51900.,80800.,51900.,40400.)                       
      else if(lawyr.eq.2012) then                                               
         excl = filing(mstat,50600.,78750.,50600.,39375.)                       
      else if(lawyr.eq.2011) then                                               
         excl = filing(mstat,48450.,74450.,48450.,37225.)                       
      else if(lawyr.eq.2010) then                                               
         excl = filing(mstat,47450.,72450.,47450.,36225.)                       
      else if(lawyr.eq.2009) then                                               
         excl = filing(mstat,46700.,70950.,46700.,35475.)                       
      else if(lawyr.eq.2008) then                                               
         excl = filing(mstat,46200.,69950.,46200.,34975.)                       
      else if(lawyr.eq.2007) then                                               
         excl = filing(mstat,44350.,66250.,44350.,33125.)                       
      else if(lawyr.eq.2006) then                                               
         excl = filing(mstat,42500.,62550.,42500.,31275.)                       
      else if(lawyr.ge.2003.and.lawyr.le.2005) then                             
         excl = filing(mstat,40250.,58000.,40250.,29000.)                       
      else if(lawyr.ge.2001.and.lawyr.le.2002) then                             
         excl = filing(mstat,35750.,49000.,35750.,24500.)                       
      else if(lawyr.ge.1993.and.lawyr.le.2000) then                             
         excl = filing(mstat,33750.,45000.,33750.,22500.)                       
      else                                                                      
         excl = filing(mstat,30000.,40000.,30000.,20000.)                       
      endif                                                                     
      if(gjtrra.ne.0.0d0.and.(lawyr.eq.2003.or.lawyr.eq.2004))                  
     &    excl = filing(mstat,35750.,49000.,35750.,24500.)                      
c AMT Exclusion Base Phaseout                                                   
      phase = filing(mstat,112500.,150000.,112500.,75000.)                      
      if(lawyr.eq.2013)                                                         
     & phase = filing(mstat,115400.,153900.,115400.,76950.)                     
      if(lawyr.eq.2014)                                                         
     & phase = filing(mstat,117300.,156500.,117300.,78250.)                     
      if(lawyr.eq.2015)                                                         
     & phase = filing(mstat,119200.,158900.,119200.,79450.)                     
      if(lawyr.eq.2016)                                                         
     & phase = filing(mstat,119700.,159700.,119700.,79850.)                     
      if(lawyr.eq.2017)                                                         
     & phase = filing(mstat,120700.,160900.,120700.,80450.)                     
      if(lawyr.eq.2018)                                                         
     & phase = filing(mstat,500000.,1000000.,500000.,500000.)                   
      if(lawyr.eq.2019)                                                         
     & phase = filing(mstat,510300.,1020600.,510300.,510300.)                   
      if(lawyr.eq.2020)                                                         
     & phase = filing(mstat,518400.,1036800.,518400.,518400.)                   
      if(lawyr.eq.2021)                                                         
     & phase = filing(mstat,523600.,1047200.,523600.,523600.)                   
      if(lawyr.eq.2022)                                                         
     & phase = filing(mstat,539900.,1079800.,539900.,539900.)                   
      if(lawyr.gt.lawend)                                                       
     & phase = filing(mstat,539900.,1079800.,539900.,539900.)*                  
     & xndx/xndxa(lawend)                                                       
      if(lawyr.lt.2018) then                                                    
           xitamt = deducp -                                                    
     &    (data(50)+data(51)+misc+min(.025*agix,edical)+data(54))               
      else                                                                      
c 2018+ for itemizers, only state and local taxes and foreign income taxes      
c need to be adjusted                                                           
           xitamt = deducp - sttax                                              
      endif                                                                     
      if(cded.gt.0) then                                                        
        if(lawyr.lt.1990) then                                                  
          addprf = data(50) + data(51) + misc + edical + data(54)               
     &     - data(22) +  data(81) + amex                                        
          if(lawyr.le.1987) addprf = addprf + .4*data(121)                      
          alminy = max(0.0d0,agi - deduc - amex + data(116) + addprf)           
        else                                                                    
          if(lawyr.le.2017) then                                                
            addprf = data(50)+data(51)+misc+data(54)-data(22)+data(81)          
          else                                                                  
            addprf = sttax - data(22)+data(81)                                  
          endif                                                                 
          if(lawyr.le.2012.or.                                                  
     &    (lawyr.ge.2013.and.lawyr.le.2016.and.data(9).gt.0))                   
     &     addprf = addprf+min(.025*agix,edical)                                
c         if(lawyr.gt.2005) addprf = addprf - misc                              
          if(lawyr.ge.1991.and.lawyr.le.1992) addprf = addprf + dedphs          
          alminy = max(0.0d0,agi - deducp +data(116)+ addprf)                   
          if(data(4).eq.-1.d0.and.deducp.eq.0.d0)                               
     &    alminy = max(0.0d0,agi-data(153)+data(116)+ addprf)                   
        endif                                                                   
        if(almst.eq.1.0d0) alminy = alminy - data(50)                           
      else                                                                      
        if(lawyr.le.1990) then                                                  
         if(data(4).ne.3) then                                                  
          addprf = zbr + amex + data(81) - data(22)                             
          alminy = max(0.0d0,agi - zbr - amex + data(116) + addprf)             
         else                                                                   
          addprf = data(81) + amex                                              
          alminy = max(0.0d0,                                                   
     &    agi - data(153)  - deducp - amex + data(116)  + addprf)               
         endif                                                                  
        else                                                                    
         if(data(4).eq.3.0d0.or.data(4).eq.-1.0d0) then                         
          addprf = data(81)                                                     
c          alminy = max(0.0d0,agi -deducp -data(153)+data(116) +addprf)         
          alminy = max(0.0d0,agi - data(153) + data(116) + addprf)              
         else                                                                   
          if(almzbr.eq.1) then                                                  
            addprf = - data(22)+data(81)                                        
          else                                                                  
            addprf = zbr - data(22)+data(81)                                    
          endif                                                                 
          alminy = max(0.0d0,agi + data(116)+ addprf)                           
          if (data(4).eq.1.and.taxinc.eq.0.and.xitamt.gt.0)                     
     &    alminy = max(0.0d0,agi-xitamt-data(22)+data(81)+data(116))            
         endif                                                                  
        endif                                                                   
      endif                                                                     
c Alternative tax net operating loss deduction                                  
      if(data(116).gt.0) then                                                   
       if(lawyr.le.1993.and.lawyr.ne.1989.and.lawyr.ne.1988) then               
            alminy = alminy - min(.9*alminy,data(116))                          
       else if (lawyr.eq.1989.or.lawyr.eq.1988) then                            
            alminy = max(0.0d0,alminy - data(166))                              
       endif                                                                    
      endif                                                                     
c Separate return: additional income 1990 +                                     
      if(lawyr.ge.1990) then                                                    
        if(sepret.eq.2)                                                         
     &  alminy = alminy + min(almspr,.25*max(0.0d0,alminy-amtsp))               
      endif                                                                     
      if(almnpx.eq.1.0d0) alminy=max(0.0d0,alminy-amex)                         
      if(extnd(68).ne.0) alminy = max(0.0d0,alminy + extnd(68))                 
c QBI deduction starts in 2018                                                  
      if(lawyr.ge.2018) alminy=max(0.0d0,alminy-dedbus)                         
      pref = max(0.0d0,addprf-zbr)                                              
c Exclusion Phase-out                                                           
      phaout = .25*max(0.0d0,alminy-phase)                                      
      exclnt = max(0.0d0,excl-phaout)                                           
      if(lawyr.ge.1990) then                                                    
        if(lawyr.le.lawend)  then                                               
          nagep = amtage(lawyr)                                                 
        else                                                                    
          nagep = amtage(lawend)                                                
        endif                                                                   
        n205 = int(data(205))                                                        
        if(n205.gt.0) then                                                      
c reported older taxpayer age                                                   
           if(n205.lt.nagep)                                                    
     &     exclnt = max(0.0d0,min(exclnt,exds+earned))                          
        else                                                                    
c not reported primary taxpayer age but is a dependent                          
           if(data(105).gt.0.0d0)                                               
     &     exclnt = max(0.0d0,min(exclnt,exds+earned))                          
        endif                                                                   
      endif                                                                     
      alminc = max(0.0d0,alminy-exclnt)                                         
      almsp = 175000.0d0                                                        
      if(lawyr.ge.2013.and.lawyr.le.lawend) then                                
         almsp = almspf(lawyr)                                                  
      elseif (lawyr.gt.lawend) then                                             
         almsp = almspf(lawend)*xndx/xndxa(lawend)                              
      endif                                                                     
      if (lawyr.ge.1997) then                                                   
c        g1250 = 0.                                                             
c        if(data(115).gt.0) g1250 = data(115)                                   
c         cglong = max(0.0d0,ltg - g1250)                                       
         cglong =                                                               
     &   max(0.0d0,ltg-data(138)-data(115)-max(0.0d0,data(117)))                
         if(alminc-cglong.gt.almsp/sepret) then                                 
            almrat = almr2                                                      
            almbak = (almr2-almr1)*almsp/sepret                                 
            if(lawyr.ge.2001) then                                              
              almrat = almr2*amtmul                                             
              almbak = (almr2-almr1)*almsp*amtmul/sepret                        
            endif                                                               
         else                                                                   
            almrat = almr1                                                      
            if(lawyr.ge.2001) almrat = almr1*amtmul                             
            almbak = 0.                                                         
         endif                                                                  
      else if(lawyr.ge.1993.and.lawyr.le.1996) then                             
         if(alminc.gt.almsp/sepret) then                                        
            almrat = almr2                                                      
            almbak = (almr2-almr1)*almsp/sepret                                 
         else                                                                   
            almrat = almr1                                                      
            almbak = 0.                                                         
         endif                                                                  
      elseif(lawyr.eq.1991.or.lawyr.eq.1992) then                               
         almrat=.24d0                                                           
         almbak = 0.                                                            
      else                                                                      
         almrat=.21d0                                                           
         almbak = 0.                                                            
      endif                                                                     
      almrat = almrat*(1+extnd(77)/100)                                         
c                                                                               
c  Starting in 1997, tax capital gains for purposes of the minimum tax          
c  at no more than 20%.  We ignore the 10% rate due to complexity and           
c  low probability that anyone will benefit from this rate                      
c                                                                               
      if (lawyr.le.1996) then                                                   
         tamt = almrat*alminc-almbak                                            
      elseif (lawyr.ge.1997) then                                               
        if(ltg.gt.1) then                                                       
         xl37 = max(0.0d0,data(176)-data(138))+ ltg - data(176) -               
     &          min(data(115)+data(117),ltg - data(176))                        
         xl38 = data(115)                                                       
         xl39 = min(xl37+xl38,                                                  
     &   max(0.0d0,data(176)-data(138))+ ltg - data(176))                       
c        xl37 = max(0.0d0,ltg-data(138)-data(115))                              
c        xl37 = ltg - max(0.0d0,min(data(115),capgn))                           
c        xl38 = data(198)+data(115)                                             
c        xl39 = min(xl37+xl38,ltg)                                              
         xl40 = min(alminc,xl39)                                                
         xl41 = alminc - xl40                                                   
         amtnon = xl41                                                          
         if(lawyr.le.2000) then                                                 
c line-by-line 2000Form6251                                                     
            xl20d = ltg                                                         
            xl21d = data(138)                                                   
            xl22d = max(0.0d0,xl20d - xl21d)                                    
            xl23d = max(0.0d0,data(68) + data(117))                             
            xl24d = max(0.0d0,min(data(117),xl23d))                             
            xl25d = data(115)                                                   
            xl26d = xl24d + xl25d                                               
            xl27d = max(0.0d0,xl22d - xl26d)                                    
            xl28d = max(0.0d0,taxinc - xl27d)                                   
            xl29d = min(brac15,taxinc)                                          
            xl30d = min(xl28d,xl29d)                                            
            xl31d = max(0.0d0,taxinc - xl22d)                                   
            xl32d = max(xl30d,xl31d)                                            
            xl34d = xl29d                                                       
            xl35d = xl30d                                                       
            xl36d = xl34d - xl35d                                               
            xl29 = alminc                                                       
            xl30 = xl27d                                                        
            xl31 = xl25d                                                        
            xl32 = xl30 + xl31                                                  
            xl33 = xl22d                                                        
            xl34 = min(xl32,xl33)                                               
            if(data(18).gt.0.0d0) then                                          
              amtnon = max(0.0d0,alminc - data(18))                             
            else                                                                
              amtnon = max(0.0d0,alminc - xl34)                                 
            endif                                                               
         endif                                                                  
         if(amtnon.le.almsp/sepret) then                                        
           tamt1 = almr1*amtnon                                                 
         else                                                                   
           tamt1 = almr2*amtnon - almbak                                        
         endif                                                                  
c rates on capital gains in amt taxable income                                  
         cgrat1 = .1*amtmul                                                     
         cgrate = .2*amtmul                                                     
c the Tax Increase Prevention and Reconciliation Act of 2005                    
         if(lawyr.ge.2003) then                                                 
           cgrat1 = .05*amtmul                                                  
           if(lawyr.ge.2008) cgrat1 = 0.                                        
           cgrate = .15*amtmul                                                  
         endif                                                                  
         xl43 = brac15                                                          
c line14 from sch D worksheet                                                   
          if(data(138).gt.1.0d0) then                                           
            xl2d = data(176)                                                    
            xl3d = data(138)                                                    
c            xl4 = max(0.0d0,data(176)-data(138))+                              
c     &   max(0.0d0,min(data(70),data(70)+data(68))-data(185))                  
            xl4d = 0                                                            
            xl5d = max(0.0d0,xl3d - xl4d)                                       
            xl6d = max(0.0d0,xl2d - xl5d)                                       
            xl7d = min(data(70),data(70)+data(68))+data(18)                     
            xl8d = min(xl3d,xl4d)                                               
            xl9d = max(0.0d0,xl7d-xl8d)                                         
            xl10d = xl6d + xl9d                                                 
          else                                                                  
            xl6d = data(176)                                                    
            xl9d = ltg - xl6d                                                   
            xl10d = ltg                                                         
          endif                                                                 
          xl11d = max(0.0d0,data(115))                                          
          xl12d = min(xl11d,xl9d)                                               
          xl13d = xl10d - xl12d                                                 
          xl14d = max(0.0d0,taxinc - xl13d)                                     
         xl44 =  xl14d                                                          
         xl45 = max(0.0d0,xl43 - xl44)                                          
         xl46 = min(xl37,alminc)                                                
         xl47 = min(xl45,xl46)                                                  
c        write(0,*) 'xl47',xl47                                                 
         amtr5 = cgrat1*xl47                                                    
         amtr15 = cgrate*(xl46 - min(xl45,xl46))                                
c         amtr25 = .25*(min(ltg,alminc) - xl46)                                 
         amtr25 = .25*(alminc-amtnon-xl47-(xl46 - min(xl45,xl46)))              
         if(lawyr.le.2000) then                                                 
            xl37 = xl36d                                                        
            xl38 = min(alminc,xl30,xl37)                                        
            amtr5 = cgrat1*xl38                                                 
            xl40 = min(alminc,xl30)                                             
            xl41 = xl38                                                         
            xl42 = xl40 - xl41                                                  
            amtr15 = cgrate*xl42                                                
            xl44 = alminc                                                       
            xl45 = amtnon +xl38 + xl42                                          
            xl46 = max(0.0d0,xl44 - xl45)                                       
            amtr25 = .25*xl46                                                   
         endif                                                                  
         if(taxinc.le.0.0d0) amtr25 = 0.                                        
         tamt2 = amtr5 + amtr15 + amtr25                                        
c xxxxxxxxxxxxxxxx                                                              
c        if(lawyr.ge.2013) tamt2 = tamt2 + addtax                               
         if(lawyr.ge.2013.and.ltg.gt.0.d0) then                                 
          if(nfile.eq.1) then                                                   
            if(lawyr.eq.2013)topbrk = 400000.d0                                 
            if(lawyr.eq.2014)topbrk = 406750.d0                                 
            if(lawyr.eq.2015)topbrk = 413200.d0                                 
            if(lawyr.eq.2016)topbrk = 415050.d0                                 
            if(lawyr.eq.2017)topbrk = 418400.d0                                 
            if(lawyr.eq.2018)topbrk = 425800.d0                                 
            if(lawyr.eq.2019)topbrk = 434550.d0                                 
            if(lawyr.eq.2020)topbrk = 441450.d0                                 
            if(lawyr.eq.2021)topbrk = 445850.d0                                 
            if(lawyr.ge.2022)topbrk = 459750*xndx/xndxa(2022)                   
          else if(nfile.eq.3) then                                              
            if(lawyr.eq.2013)topbrk = 425000.d0                                 
            if(lawyr.eq.2014)topbrk = 432200.d0                                 
            if(lawyr.eq.2015)topbrk = 439000.d0                                 
            if(lawyr.eq.2016)topbrk = 441000.d0                                 
            if(lawyr.eq.2017)topbrk = 444550.d0                                 
            if(lawyr.eq.2018)topbrk = 452400.d0                                 
            if(lawyr.eq.2019)topbrk = 461700.d0                                 
            if(lawyr.eq.2020)topbrk = 469050.d0                                 
            if(lawyr.eq.2021)topbrk = 473750.d0                                 
            if(lawyr.ge.2022)topbrk = 488500*xndx/xndxa(2022)                   
          else                                                                  
            if(lawyr.eq.2013)topbrk = 450000.d0/sepret                          
            if(lawyr.eq.2014)topbrk = 457600.d0/sepret                          
            if(lawyr.eq.2015)topbrk = 464850.d0/sepret                          
            if(lawyr.eq.2016)topbrk = 466950.d0/sepret                          
            if(lawyr.eq.2017)topbrk = 470700.d0/sepret                          
            if(lawyr.eq.2018)topbrk = 479000.d0/sepret                          
            if(lawyr.eq.2019)topbrk = 488850.d0/sepret                          
            if(lawyr.eq.2020)topbrk = 496600.d0/sepret                          
            if(lawyr.eq.2021)topbrk = 501600.d0/sepret                          
            if(lawyr.ge.2022)topbrk =(517200.d0/sepret)*xndx/                   
     &       xndxa(2022)                                                        
          endif                                                                 
c amt income calculation (form 6251)                                            
          schd7 = max(0.0d0, taxinc - ltg)                                      
          almcg = min(alminc,ltg)                                               
          part15 = max(0.d0,brac15 - schd7)                                     
          alm0 = min(almcg,part15)                                              
          alm15 = min(almcg - alm0,max(0.d0,topbrk - schd7 - part15))           
          alm20 = max(0.d0,almcg - (alm0+alm15))                                
          alm25 = max(0.d0,alminc-(amtnon+alm0+alm15+alm20))                    
c amt tax calculation with ltg income (form 6251)                               
          amtr5 = cgrat1*alm0                                                   
          amtr15 = cgrate*alm15                                                 
          amtr20 = .2*alm20                                                     
          amtr25 = .25*alm25                                                    
          tamt2a = amtr5+amtr15+amtr20+amtr25                                   
c additional amt (5%) -- addamt                                                 
          amtra = cgrate*(alm15+alm20)                                          
          addamt = .05*alm20                                                    
          tamt2 = tamt2+addamt                                                  
         endif                                                                  
c xxxxxxxxxxxx                                                                  
         tamt = tamt1 + tamt2                                                   
        else                                                                    
         if(alminc.le.almsp/sepret) then                                        
           tamt1 = almr1*alminc                                                 
         else                                                                   
           tamt1 = almr2*alminc - almbak                                        
         endif                                                                  
         tamt2 = 0.                                                             
         tamt = tamt1 + tamt2                                                   
        endif                                                                   
      endif                                                                     
      if(lawyr.le.1993) then                                                    
         amtftc = data(34)                                                      
      else                                                                      
         amtftc = data(163)                                                     
      endif                                                                     
      almtax = max(0.0d0,tamt - amtftc - max(taxbc-data(34),0.0d0))             
      if(extnd(50).gt.0) almtax = 0.                                            
      almpay = 0.                                                               
      if (almtax.gt.0.) almpay = 1.                                             
      if(lawyr.le.1999)taxbca = taxbc                                           
      if(lawyr.ge.2000)taxbca = taxbc + almtax                                  
      bpamt = 0.                                                                
      if(almtax.gt.0) then                                                      
         if(alminc.le.almsp) then                                               
            bpamt = alminc                                                      
         else                                                                   
            bpamt = alminc - almsp                                              
         endif                                                                  
      endif                                                                     
      bppamt = taxinc - (alminc - bpamt)                                        
c Credits                                                                       
c Child care credit                                                             
      ncccr = int(min(data(207),2.0d0))                                              
      if(lawyr.le.2002) then                                                    
        child = min(data(64),2400.0d0*ncccr)                                    
      else if(lawyr.ge.2003.and.lawyr.le.2020) then                             
        child = min(data(64),3000.0d0*ncccr)                                    
      else if(lawyr.ge.2021) then                                               
        child = min(data(64),8000.0d0*ncccr)                                    
      endif                                                                     
c      if(mstat.eq.2)                                                           
c     &child = max(0.0d0,min(child,data(85),data(86)))                          
      if(mstat.ne.2) then                                                       
         child = max(0.0d0,min(child,earny))                                    
      else                                                                      
         earnww = max(0.d0,earny - data(85) - data(86))                         
         earnh = data(85) + earnww/2                                            
         earnw = data(86) + earnww/2                                            
c qbi for primary taxpayer and spouse separate                                  
c        if(d17.gt.0.and.lawyr.ge.2018) then                                    
         if(d17-data(213).gt.0.d0) then                                         
             setaxh = setax*(data(211) + data(212))/d17                         
             setaxw = setax*(data(214) + data(215))/d17                         
             seleft = setax - setaxh - setaxw                                   
             earnww = max(0.0d0,data(17)+data(21)-.5*seleft)                    
             earnh = max(0.0d0,data(85)+data(211)+data(212)-.5*setaxh)          
     &+earnww/2                                                                 
             earnw = max(0.0d0,data(86)+data(214)+data(215)-.5*setaxw)          
     &+earnww/2                                                                 
         endif                                                                  
         child = max(0.0d0,min(child,earnh,earnw))                              
      endif                                                                     
      chr = 0.                                                                  
      if(lawyr.le.2002) then                                                    
        chr = .01*max(20.0d0,30.-max((agi-10000.)/2000.,0.0d0))                 
      else if(lawyr.ge.2003.and.lawyr.le.2020) then                             
        chr = .01*max(20.0d0,35.-max((agi-15000.)/2000.,0.0d0))                 
      else if(lawyr.ge.2021) then                                               
        if(agi.le.125000.d0) then                                               
           chr = .5                                                             
        else if(agi.le.183000.d0) then                                          
           chr = .01*(50.-max((agi-125000.)/2000.,0.0d0))                       
        else if(agi.le.400000.d0) then                                          
           chr = .2d0                                                           
        else if(agi.le.438000.d0) then                                          
           chr = .01*(20.-max((agi-400000.)/2000.,0.0d0))                       
        endif                                                                   
      endif                                                                     
c 2021 chcr is refundable                                                       
      chcr = chr*child                                                          
c      write(0,*) 'agi chcr chr child',agi,chcr,chr,child                       
                                                                                
c Indicator for Child Care Credit Phaseout!                                     
      pchild = 0.                                                               
      rchild=0.                                                                 
      if(chr.gt..2.and.chr.lt..3.and.chcr.gt.0.and.                             
     & (lawyr.le.2002.or.lawyr.ge.2013)) pchild = 1.                            
      if(chr.gt..2.and.chr.lt..35.and.chcr.gt.0.and.                            
     & (lawyr.gt.2002.and.lawyr.lt.2013)) pchild = 1.                           
      if(pchild.eq.1) rchild = 100*.01*dagidw*child/2000.                       
      chcr = max(0.0d0,1 - extnd(57))*chcr                                      
      rfchcr = 0                                                                
      if(extnd(73).gt.0) then                                                   
        rfchcr = chcr                                                           
        chcr = 0                                                                
      endif                                                                     
      if(child.gt.0.and.chcr.gt.0) then                                         
        if(extnd(57).gt.0.and.extnd(57).lt.1) then                              
         pchild = 1                                                             
         rchild = 100*(1 - extnd(57))*dagidw                                    
        else if(extnd(57).eq.1) then                                            
         pchild = 0                                                             
         rchild = 0                                                             
        endif                                                                   
      endif                                                                     
c Elder credit                                                                  
c      elder = data(32)                                                         
      elder = 0.                                                                
      pold=0.                                                                   
      rold=0.                                                                   
      if(data(9).gt.0) then                                                     
       exagi = max(0.0d0,agi-10000/sepret)                                      
       eldlim = 7500/sepret                                                     
       if(data(9).eq.1.0d0.and.sepret.ne.2) then                                
         exagi = max(0.0d0,agi-7500)                                            
         eldlim = 5000.                                                         
       endif                                                                    
       elder = .15*max(0.0d0,eldlim-(.5*exagi+data(91)-ssagi))                  
      endif                                                                     
c    EARNED INCOME TAX CREDIT                                                   
      call eitcr(data,lawyr,agi,earny,earncr,rtbs    )                          
c  New credits from TRA97                                                       
c   Child Tax Credit, Additional Child Tax Credit, and Education Credits        
c   Child Tax Credit is $400 per child in 1998, $500 per child in 1999          
c      children under 17 are imputed based on figures from the SOI and          
c      and the Statistical Abstract of the US                                   
c   chpute = under 17 year old dependents                                       
c   Education credit                                                            
c      educred incorporates non-refundability and stacking rules                
c      (older credits applied first, child tax & education credits last)        
c   Nonrefundability limits are apportioned evenly between Child and            
c   Education credits whenever stacking becomes an issue.                       
      chcred = 0.                                                               
      edcred = 0.                                                               
c Phase-out indicator for Child Tax Credit                                      
      pcht = 0.                                                                 
      rcht = 0.                                                                 
      chcr1 = 0.                                                                
      ctcred = 0.                                                               
      paddcr = 0.                                                               
      life = 0.                                                                 
      hope = 0.                                                                 
      precrd = 0.                                                               
      famcr = 0.                                                                
      if (lawyr.ge.1998) then                                                   
         xlin10 = max(0.0d0,taxbca-chcr-elder)                                  
         if(lawyr.eq.2021) xlin10 = max(0.0d0,taxbca-elder)                     
         ideps = int(data(208))                                                      
         if(egtrra.eq.0) then                                                   
           precrd = 500*ideps                                                   
         else                                                                   
c Accelerated Increase in Child Tax Credit                                      
           chcmax=chmax(lawyr)                                                  
c maximum child tax credit is $800 for each kid after 2010                      
           if(extnd(7).eq.1.and.lawyr.ge.2010) chcmax = 800.                    
           if(gjtrra.ne.0.0d0) then                                             
              if(lawyr.eq.2003.or.lawyr.eq.2004) chcmax = 600.                  
           endif                                                                
           precrd = chcmax*ideps                                                
         endif                                                                  
c TCJA 2018+ $500 credit for qualifying                                         
c dependents other than qualifying children                                     
         if(lawyr.ge.2018) then                                                 
           odcred = 500*max(0.d0,data(8)-ideps)                                 
           if(lawyr.le.2020) precrd = precrd + odcred                           
           if(lawyr.ge.2021) then                                               
c 2021 Biden's American Rescue Plan Act                                         
c data(210) - number of children under 6 y.o.                                   
c ideps-data(210) - number of children between 6 y.o. and 17 y.o.               
             ccrmax = data(210)*3600 + (ideps-data(210))*3000                   
                                                                                
             crmx17 = ccrmax - ideps*2000.d0                                    
             crfile = filing(mstat,6250.,12500.,4375.,6250.)                    
             crmx17 = min(crmx17,crfile)                                        
c            write(0,*) 'ccrmax crmx17',ccrmax,crmx17                           
                                                                                
c phaseouts                                                                     
             thresh = filing(mstat,75000.,150000.,112500.,75000.)               
             ccr17 = ccrmax - min(crmx17,.05*max(0.d0,agi - thresh))            
c            write(0,*) 'ccrmax ccr17',ccrmax,ccr17                             
                                                                                
c marginal tax rate for 2021 additional part of CTC                             
             if(ccr17.gt.0.and.ccr17.lt.crmx17) then                            
                rcht = .05                                                      
                pcht = 1.                                                       
             endif                                                              
             precrd = odcred + ccr17                                            
c                write(0,*) '0 precrd ',precrd                                  
           endif                                                                
         endif                                                                  
         cphase = cphas(mstat)                                                  
c 2018+ new phaseout CTC starts with agi > $400,000 for joints                  
c and $200,000 for all other taxpayers, 440k and 240k for 2021                  
         if(lawyr.ge.2018) then                                                 
          cphase = phctch(lawyr)                                                
          if(mstat.eq.2) cphase = phctcm(lawyr)                                 
         endif                                                                  
c         precrd = phaser(agi,cphase,.05d0,precrd)                              
                                                                                
                                                                                
         if (agi.gt.cphase) then                                                
           excess = agi-cphase                                                  
           reduc = (excess/1000.)*50.                                           
           precrd = max(0.0d0,precrd-reduc)                                     
         endif                                                                  
c                write(0,*) '1 precrd ',precrd                                  
         if(precrd.gt.0.and.precrd.lt.xlin10) then                              
             pcht = 1.d0                                                        
             rcht = .05d0                                                       
         endif                                                                  
         if(lawyr.ne.2021) then                                                 
           ctcred = min(precrd,xlin10)                                          
         else                                                                   
           ctcred = precrd                                                      
         endif                                                                  
c        write(0,*) 'ctcred',ctcred                                             
c 2021 CTC is refundable and does not depend on taxbc                           
c Additional Child Tax Credit                                                   
         cssmax = ssmax(lawyr)                                                  
         ssmtax = .0765*min(cssmax,ssearn)                                      
c        ssmtax = .0765*min(cssmax,max(0.0d0,earned))                           
         if(lawyr.eq.2011.or.lawyr.eq.2012)                                     
     &   ssmtax = .0565*min(cssmax,ssearn)                                      
c     &   ssmtax = .0565*min(cssmax,max(0.0d0,earned))                          
         if (ideps.gt.2) then                                                   
            if(lawyr.ge.1998.and.lawyr.le.2000) then                            
              xline5 = max(0.0d0,ssmtax-earncr)                                 
              xline8 = max(0.0d0,precrd-ctcred)                                 
              chcr1 = min(xline5,xline8)                                        
            endif                                                               
         endif                                                                  
         if(chcr1.gt.0) then                                                    
           if(chcr1.eq.xline8) raddcr = rgrate                                  
         endif                                                                  
         chcred = ctcred                                                        
         chcred = (1-extnd(15))*chcred                                          
c        write(0,*) '1 chcred',int(chcred)                                      
c Education Credit                                                              
         if(lawyr.eq.1998)  then                                                
           edcred = data(143)+.2*data(144)                                      
         else if(lawyr.ge.1999) then                                            
           xlim = 10000.                                                        
           if(lawyr.le.2002) xlim = 5000.                                       
           life = .2*min(data(144),xlim)                                        
c           if(data(110).gt.0.and.                                              
c     &            (lawyr.le.2008.or.lawyr.gt.2017)) then                       
c             if(data(143)/data(110).le.hplm) then                              
c                hope = data(143)                                               
c             else                                                              
c                colc = min(2*hplm*data(110),data(143))                         
c                cold = min(hplm*data(110),colc)                                
c                hope = .5*(colc + cold)                                        
c             endif                                                             
c           endif                                                               
c ARRA 2009 - American Opportunity Credit                                       
c           if(lawyr.ge.2009.and.lawyr.le.2017) hope = data(143)                
           hope = data(143)                                                     
           if(sepret.eq.2) then                                                 
c You cannot claim edcred if filing status is married filing separately         
              hope = 0.                                                         
              life = 0.                                                         
           endif                                                                
           hoperf = 0.                                                          
           if(lawyr.ge.2009.and.data(158).gt.0.0d0) hoperf = .4*hope            
           hope = hope - hoperf                                                 
           edcred = hope + life                                                 
           if(life.eq.0.0d0) hope = edcred                                      
           if(hope.eq.0.0d0) life = edcred                                      
         endif                                                                  
         phase1 = edphls(lawend)*xndxa(lawyr)/xndxa(lawend)                     
         phase2 = edphhs(lawend)*xndxa(lawyr)/xndxa(lawend)                     
         if(mstat.eq.2) then                                                    
           phase1 = edphlm(lawend)*xndxa(lawyr)/xndxa(lawend)                   
           phase2 = edphhm(lawend)*xndxa(lawyr)/xndxa(lawend)                   
         endif                                                                  
         pedu = 0.                                                              
         redu = 0.                                                              
         if(lawyr.le.2008) then                                                 
           if (agi.ge.phase2) edcred = 0.                                       
           if (agi.gt.phase1.and.agi.lt.phase2.and.edcred.gt.0) then            
             pedu = 1.                                                          
             redu = 100*edcred/(10000.*data(07))                                
             edcred = edcred*(phase2-agi)/(10000.*data(07))                     
           endif                                                                
         else                                                                   
c ARRA 2009+ phaseouts only for American Opportunity Credit(refundable)         
c reflects lines from 2009 form 8863                                            
           hoptot = hope + hoperf                                               
           phaseh = 90000.                                                      
           if(mstat.eq.2) phaseh = 180000.                                      
           delta = 10000*data(7)                                                
           phash1 = phaseh - delta                                              
           excess = phaseh - agi                                                
           if(excess.le.0.0d0) then                                             
              hope = 0                                                          
              hoperf = 0                                                        
              life = 0                                                          
              edcred = 0                                                        
           else                                                                 
              if(excess.ge.delta) then                                          
                 pcnt = 1.                                                      
              else                                                              
                 pcnt = excess/delta                                            
              endif                                                             
              hope = hoptot*pcnt                                                
              if (agi.gt.phash1.and.agi.lt.phaseh.and.hope.gt.0) then           
                pedu = 1.                                                       
                redu = 100*hope/delta                                           
              endif                                                             
              if(data(158).gt.0.0d0) hoperf = .4*hope                           
              hope = hope - hoperf                                              
           endif                                                                
c Phaseouts for the Lifetime Learning Credit (non-refundable) 2009+             
           excess = phase2 - agi                                                
           if(excess.le.0.0d0) then                                             
              life = 0                                                          
           else                                                                 
              if(excess.ge.delta) then                                          
                 pcnt = 1.                                                      
              else                                                              
                 pcnt = excess/delta                                            
              endif                                                             
              life = life*pcnt                                                  
              if (agi.gt.phase1.and.agi.lt.phase2.and.life.gt.0) then           
                pedu = 1.                                                       
                redu = 100*life/delta                                           
              endif                                                             
           endif                                                                
           edcred = hope+life                                                   
         endif                                                                  
c  Stacking Credits: old credits first, child and education credits last        
c           oldcr =                                                             
c     &    chcr+elder+data(33)+data(35)+data(37)+data(38)+data(40)              
         oldcr = elder+data(35)+data(38)+data(40)+data(37)                      
         if(lawyr.ne.2021) oldcr = chcr+oldcr                                   
         if(lawyr.eq.2021)  then                                                
            newcr = edcred+famcr                                                
         else                                                                   
            newcr = edcred+chcred+famcr                                         
         endif                                                                  
         totcr = newcr+oldcr                                                    
         if (taxbca.ge.oldcr.and.taxbca.lt.totcr) then                          
c tax after old ref + child + life credits                                      
           taxtmp = max(0.0d0,taxbca-totcr)                                     
c           edcred = taxbca - taxtmp                                            
         endif                                                                  
      endif                                                                     
c total non-refundable credits                                                  
      chcrbc = chcr                                                             
      avail = taxbc                                                             
      if(lawyr.ge.2000) avail = avail + almtax                                  
      if(lawyr.ne.2021) then                                                    
        chcr = min(chcr,avail)                                                  
        avail = max(0.0d0,avail - chcr - elder - data(34))                      
      endif                                                                     
      if(lawyr.ge.1998)  then                                                   
         edcred = min(avail,edcred)                                             
         avail = avail - edcred                                                 
      endif                                                                     
      avail = max(0.0d0,avail - data(38) - data(35) - data(40))                 
      credit = oldcr + edcred + famcr                                           
      if(lawyr.ge.1998.and.lawyr.ne.2021)  then                                 
         chcred = min(avail,chcred)                                             
         avail = avail - chcred                                                 
         credit = credit + chcred                                               
      endif                                                                     
c                                                                               
      if(lawyr.ge.2000) then                                                    
        crdlst = max(0.0d0,credit - taxbc - almtax)                             
      else                                                                      
        crdlst = max(0.0d0,chcr + elder + precrd - taxbc)                       
      endif                                                                     
c Phase-out Indicator for SS Benefits                                           
      rssa=0.                                                                   
      if(pssa.eq.1) then                                                        
         if(lawyr.ge.1994.and.peic.gt.0.d0) then                                
            if(reic.ne.rtbs) then                                               
               if(pssa1.eq.1)  then                                             
                  rssa= .85*rgrate                                              
               else if(pssa2.eq.1) then                                         
                  rssa=.5*rgrate                                                
               endif                                                            
            else                                                                
               if(pssa1.eq.1) then                                              
                  rssa= .85*(rgrate-reic)+reic                                  
               else if(pssa2.eq.1) then                                         
                  rssa=.5*(rgrate-reic)+reic                                    
               endif                                                            
            endif                                                               
         else                                                                   
           rssa=.5*rgrate                                                       
         endif                                                                  
      endif                                                                     
c Phase out indicator for elderly credit                                        
      if(exagi.gt.0.and.elder.gt.0) then                                        
        pold=1.                                                                 
        rold=max(0.0d0,.15*dagidw*(50-rssa))                                    
      endif                                                                     
c Phase-out Indicator for Rental Loss                                           
      rrent=0.                                                                  
       if(prent.eq.1.)                                                          
     & rrent= abs(max(data(73),-25000.0d0/sepret))/(50000.0d0/sepret)*          
     & (rgrate-reic)+reic                                                       
c Phase-out Indicator for ira                                                   
       pira = 0                                                                 
       rira=0.                                                                  
       if(agira.gt.phaira.and.data(29).gt.0.and.ira.gt.0) then                  
         pira = 1                                                               
         rira= min(iramax,data(29))/range*rgrate                                
         if(peic.gt.0.0d0) then                                                 
           if(reic.ne.rtbs)                                                     
     & rira = min(iramax,data(29))/range*(rgrate-reic)+reic                     
         endif                                                                  
       endif                                                                    
       if(extnd(58).gt.0) then                                                  
         pira = 0                                                               
         rira = 0.                                                              
       endif                                                                    
c                                                                               
      rrate = rssa+rira+rrent+rchild+rold+rdisab                                
     &+rgrate+rdical+(rsave+rxmp)*100+rded+rexem                                
     &-rchar+rcasu+rmisc+redu                                                   
      rate = rrate + reic + rcht                                                
c Phase-out indicator for Almtax                                                
      palm = 0.                                                                 
      ralm = 0.                                                                 
      if(almtax.gt.0.and.data(105).ne.1) then                                   
         coeff=1.                                                               
         if(exclnt.gt.0.and.phaout.gt.0) coeff=1.25                             
         if(lawyr.ge.1997.and.alminc.lt.ltg) almrat = 0.                        
         ralm=coeff*almrat*100*dagidw                                           
         if(cded.gt.0) then                                                     
          ralm=coeff*100*almrat*(dagidw+ddeddw-.02*pmisc*dagidw)                
          if(lawyr.gt.1993.or.lawyr.lt.1989)                                    
     & ralm=coeff*100*almrat*(dagidw+ddeddw-.02*pmisc*dagidw-                   
     & (.03*pded+.3*.8*pded1+.5*.8*pded2)*dagidw)                               
          if(pdical.eq.1) then                                                  
            if(.025*agix.lt.edical) then                                        
             ralm=ralm+coeff*.025*dagidw*100*almrat                             
            else                                                                
             ralm=ralm-coeff*.075*dagidw*100*almrat                             
            endif                                                               
          endif                                                                 
         endif                                                                  
         if(taxbca.lt.credit) ralm=ralm-                                        
     & rgrate*(dagidw-.5*pchar1-.3*pchar2)-rded-rmisc-rexem                     
         if(lawyr.ge.1997.and.ltg.gt.alminc+100.) then                          
            if(amtr25.gt.0) then                                                
               ralm = .25*coeff*100*dagidw                                      
            else if(amtr15.gt.0.and.amtr25.eq.0) then                           
               ralm = cgrate*coeff*100*dagidw                                   
            else if(amtr5.gt.0.and.amtr15.eq.0.and.amtr25.eq.0) then            
               ralm = cgrat1*coeff*100*dagidw                                   
            endif                                                               
         endif                                                                  
         if(lawyr.ge.1998.and.tamt.eq.0) ralm= rcht + rchild + rold             
         if(pchar1.eq.1.and.rgrate.eq.0) ralm=ralm*(1-pchar1*.5)                
         ralm = ralm - rrate                                                    
         if(ralm.gt.0) palm = 1.                                                
         rate = ralm + reic + rcht + rrate                                      
      endif                                                                     
c  Starting in 2001, the Child Tax Credit is refundable to the extent           
c  of 10 percent of earned income in excess of $10,000                          
      earnch = max(0.0d0,earned)                                                
      if (lawyr.ge.2001.and.lawyr.ne.2021) then                                 
        earlim = ealim(lawyr)                                                   
c 2019 through 2023 eapct set to 2018 value. Please fix when actual numbers come
        tenpct = eapct(lawyr)*max(0.0d0,earnch - earlim)                        
        if(lawyr.le.2017) then                                                  
           chcr1 = min(precrd-chcred,tenpct)                                    
           if(ideps.gt.2.and.tenpct.lt.precrd-chcred)                           
     &chcr1 = min(precrd-chcred,max(tenpct,max(0.0d0,ssmtax-earncr)))           
        endif                                                                   
        if(lawyr.ge.2018.and.lawyr.ne.2021) then                                
          refch = 1400.d0                                                       
          if(lawyr.eq.2022) refch = 1500.d0                                     
          xl5 = min(precrd - chcred,refch*ideps)                                
          xl8 = tenpct                                                          
          if(ideps*refch.lt.4200.d0) then                                       
             chcr1 = min(xl5,xl8)                                               
          else                                                                  
            if(xl8.lt.xl5) then                                                 
             xl14 = max(xl8,max(0.0d0,ssmtax-earncr))                           
             chcr1 = min(xl5,xl14)                                              
            else                                                                
             chcr1 = xl5                                                        
            endif                                                               
          endif                                                                 
        endif                                                                   
        raddcr = 0.                                                             
        chcr1 = (1 - extnd(15))*chcr1                                           
        if(chcr1.gt.0) then                                                     
         if(chcr1.eq.precrd-chcred.and.chcred.gt.0) then                        
          raddcr = rgrate                                                       
          if(lawyr.ge.2000.and.almtax.gt.0.and.ralm.gt.0) raddcr = ralm         
          if(chcred.eq.xlin10)  raddcr = raddcr + rchild                        
          if(pcht.eq.1.or.(precrd.lt.ideps*chcmax.and.agi.gt.cphase))           
     &    raddcr = raddcr + 5.                                                  
         else if(chcr1.lt.precrd-chcred) then                                   
          raddcr = - eapct(lawyr)*100                                           
         else if(chcr1.eq.ssmtax-earncr) then                                   
          raddcr = -7.65 - reic                                                 
          if(lawyr.eq.2011.or.lawyr.eq.2012) raddcr = -5.65 - reic              
         endif                                                                  
         paddcr = 1                                                             
         rate=rate+raddcr                                                       
        endif                                                                   
      endif                                                                     
      if(lawyr.eq.2021) chcr1 = chcred                                          
c 2009-2010 Making Work Pay and Government Retiree Credits                      
c(refundable line 63 of 2009 Form 1040)                                         
      wpaycr = 0                                                                
      pwpay = 0                                                                 
      rwpay = 0                                                                 
      if((lawyr.eq.2009.or.lawyr.eq.2010).and.                                  
     &data(105).lt.1.and.earny.gt.0.and.agi.lt.95000*data(7)) then              
         crwpay = 400.                                                          
         wpaycr = max(0.0d0,min(crwpay*data(7),.062*earny) -                    
     &   .02*max(0.0d0,agi-data(7)*75000))                                      
         if(wpaycr.gt.0.and.agi.gt.data(7)*75000) then                          
           rwpay = 2.                                                           
           pwpay = 1                                                            
           rate = rate + rwpay                                                  
         endif                                                                  
c        if(data(91).gt.0.and.earnch.eq.0.)                                     
         if(data(91).gt.0)                                                      
     & wpaycr = max(0.0d0,wpaycr - min(data(91),data(7)*250))                   
      endif                                                                     
      credit = credit+data(34)                                                  
c            write(0,*) '3 credit', int(credit)                                 
                                                                                
c Credit if no AMT                                                              
      crdnoa =credit                                                            
      if(taxbc.le.crdnoa) crdnoa = taxbc                                        
c      if(extnd(15).ne.0.0d0) chcr1 = 0.                                        
      taxnoa = taxbc-crdnoa-earncr-chcr1-hoperf-wpaycr-rfchcr                   
c 2021 Child and Dependent care credit is refundable                            
      if(lawyr.eq.2021) taxnoa = taxnoa - chcr                                  
c      write(0,*) 'taxnoa taxbc crdnoa chcr1 chcr earncr',                      
c     & taxnoa,taxbc,crdnoa,chcr1,chcr,earncr                                   
      pmcare = 0                                                                
      rmcare = 0                                                                
      if(lawyr.ge.2000) then                                                    
         dicare = 0.                                                            
c 2013+ Additional Medicare tax on "unearned" Investment Income                 
         if(lawyr.ge.2013) then                                                 
           thres = 200000.d0                                                    
           if(mstat.eq.2.or.sepret.eq.2) thres = 250000.d0/sepret               
           if(agi.gt.thres) then                                                
c when d213 is available, schede won't include d213.                            
c  So leave only 'schede' then(06.18.2019)                                      
              dinc=max(0.0d0,data(14)+data(12)+capgn+schede-data(213))          
c The NIIT allows state and local income taxes attributable to                  
c the investment income to be deducted                                          
              if(lawyr.le.2017) then                                            
                  expnse = data(50)*min(1.d0,dinc/agi)                          
              else                                                              
                  expnse = min(data(50),10000.d0/sepret)*                       
     &            min(1.d0,dinc/agi)                                            
              endif                                                             
              dinc = max(0.0d0,dinc - expnse)                                   
              dicare = .038*min(dinc,agi-thres)                                 
              if(agi-thres.lt.dinc) then                                        
                  pmcare = 1.d0                                                 
                  rmcare = 3.8d0                                                
              endif                                                             
              rate = rate + rmcare + rmear                                      
           endif                                                                
           taxnoa = taxnoa + dicare                                             
         endif                                                                  
         taxaft = max(0.0d0,taxbc+almtax+dicare-credit)                         
      else                                                                      
         taxaft = max(0.0d0,taxbc-credit)                                       
      endif                                                                     
      if(crdlst.gt.0.or.                                                        
     & (lawyr.le.1999.and.precrd.gt.0.and.                                      
     &   precrd+chcr+elder+edcred+data(34).ge.taxbc).or.                        
     & (lawyr.ge.2000.and.lawyr.ne.2021.and.precrd.gt.0.and.                    
     &   precrd+chcr+elder+edcred+data(34).ge.taxbca).or.                       
     & (lawyr.eq.2021.and.                                                      
     &   elder+edcred+data(34).ge.taxbca)) then                                 
         if(lawyr.ge.2000) credit = taxbca                                      
c        write(0,*) '4 credit', int(credit)                                     
         if(lawyr.lt.2000) credit = taxbc                                       
         if(dagidw.ne.0.and.reic.gt.0) reic = reic/dagidw                       
         if(lawyr.ge.2000) rate = reic + raddcr + rdical                        
         if(lawyr.lt.2000) rate = reic + raddcr + ralm                          
      endif                                                                     
c data(182)  - first time home buyer credit                                     
      tax = taxaft - earncr - chcr1 - hoperf - wpaycr - rfchcr                  
     &      - data(182)                                                         
c 2021 Child and Dependent care credit is refundable                            
      if(lawyr.eq.2021) tax = tax - chcr                                        
c      write(0,*) 'tax taxaft chcr1 earncr chcr',                               
c     & tax,taxaft,chcr1,earncr,chcr                                            
c 2006 Refundable Credit for Federal Telephone Excise Tax Paid                  
      telcr = 0.                                                                
      if(lawyr.eq.2006.and.exemps.gt.0)telcr = 10*(min(exemps,4.0d0)+2.)        
      tax = tax - telcr                                                         
c 2020-1 Refundable Recovery Rebate Credit                                      
      cares = 0.d0                                                              
      rcare = 0.d0                                                              
      eip1 = 0.d0                                                               
      eip2 = 0.d0                                                               
      eip3 = 0.d0                                                               
      if(lawyr.ge.2020.and.data(105).lt.1.d0) then                              
        ncare = 1                                                               
        if(mstat.eq.2) ncare = 2                                                
        phcare = 75000.d0 * ncare                                               
        if(mstat.eq.4.or.mstat.eq.7) phcare = 75000.d0*1.5                      
        if(lawyr.eq.2020) then                                                  
          eip1 = 1200.d0*ncare + 500*data(207)                                  
          eip2 =  600.d0*ncare + 600*data(207)                                  
          if(agi.gt.phcare) then                                                
            eip1 = max(0.0d0,eip1 - .05*(agi - phcare))                         
            eip2 = max(0.0d0,eip2 - .05*(agi - phcare))                         
            if(eip1+eip2.gt.0.d0) rcare = .05                                   
          endif                                                                 
        endif                                                                   
        if(lawyr.eq.2021) then                                                  
          phmax = 80000.d0*ncare                                                
          if(mstat.eq.4.or.mstat.eq.7) phmax = 80000.d0*1.5                     
          if(agi.lt.phmax) then                                                 
            eip3 = 1400.d0*ncare + 1400.d0*data(8)                              
            if(agi.gt.phcare) then                                              
              rcare = (phmax-agi)/(phmax-phcare)                                
              eip3 = eip3*rcare                                                 
            endif                                                               
          endif                                                                 
        endif                                                                   
        if(extnd(22).eq.0.) then                                                
           cares = eip1 + eip2 + eip3                                           
           rate = rate + rcare                                                  
        endif                                                                   
      endif                                                                     
      tax = tax - cares                                                         
c      write(0,*) 'tax cares',tax,cares                                         
c  taxsoi is the SOI definition of Total Tax, it does not include the           
c  refundable portion of the EITC                                               
c  data46 is computed other taxes, a residual                                   
c (earncr-eitc) refundable part of Earned Income Credit                         
      eitc = earncr                                                             
      if (taxaft.le.eitc) eitc = taxaft                                         
      taxsoi = taxaft - eitc                                                    
c      taxsoi = taxaft - eitc + rrcred                                          
      pretax = max(regtax,almtax,(tax+credit+eitc+chcr1))                       
      if(lawyr.eq.2021)                                                         
     & pretax = max(regtax,almtax,(tax+credit+eitc+chcr1+chcr))                 
      crdnon=credit                                                             
      taxnon=max(0.0d0,taxbc+almtax-crdnon)                                     
      if(extnd(53).eq.data(100).and.data(100).ne.0) call prntdc(data)           
      return                                                                    
      end                                                                       
      subroutine prntdc(d)                                                      
      implicit double precision(a-h,o-z)                                        
      dimension d(255)                                                          
      common/newshr/c(255)                                                      
      common/calc/st(12)                                                        
      save krec                                                                 
      data krec/0/                                                              
      krec = krec + 1                                                           
      write(15,200) (i,i=1,10)                                                  
      do 10 i=0,18                                                              
          write(15,100) i,(int(d(i*10+j)),j=1,10),i*10                          
10    continue                                                                  
      write(15,'(////)')                                                        
      write(15,200) (i,i=1,10)                                                  
      do 20 i=0,18                                                              
        write(15,100)i,(int(c(i*10+j)),j=1,10),i*10                               
20    continue                                                                  
       write(15,300) (int(st(i)),i=1,12)                                         
c      if(krec.ge.10) stop 10                                                   
100   format(i4,10i8,i4,'-')                                                    
200   format(4x,10i8/)                                                          
300   format('  st',12i8,31(/))                                                 
      return                                                                    
      end                                                                       
c                                                                               
c   ****************************************************************************
c     TAX TABLE COMPUTATIONS and XYZ TAX TABLES 1960 to 2001                    
c   ****************************************************************************
c                                                                               
c   Calculate regular taxes 1960-63                                             
c                                                                               
      subroutine tax62(tax,rate,nfile,taxinc)                                   
      implicit double precision (A-H,O-Z)                                       
      common /tab62/ toptab(77),tmrtab(77),acctab(78),ibeg(3)                   
      itab=ibeg(nfile)                                                          
      faster=taxinc                                                             
  10  itab=itab+1                                                               
      if(faster.le.toptab(itab)) go to 100                                      
      go to 10                                                                  
  100 continue                                                                  
      rate = tmrtab(itab)                                                       
      tax = acctab(itab)+(faster-toptab(itab-1))*rate                           
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c   Calculate regular taxes 1964                                                
c                                                                               
      subroutine tax64(tax,rate,nfile,taxinc)                                   
      implicit double precision (A-H,O-Z)                                       
      common /tab64/ toptab(91),tmrtab(91),acctab(92),ibeg(3)                   
      itab=ibeg(nfile)                                                          
      faster=taxinc                                                             
  10  itab=itab+1                                                               
      if(faster.le.toptab(itab)) go to 100                                      
      go to 10                                                                  
  100 continue                                                                  
      rate=tmrtab(itab)                                                         
      tax=acctab(itab)+(faster-toptab(itab-1))*rate                             
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c   Calculate regular taxes 1965-1970                                           
c                                                                               
      subroutine tax70(tax,rate,nfile,taxinc)                                   
      implicit double precision (A-H,O-Z)                                       
      common /tab70/ toptab(86),tmrtab(86),acctab(87),ibeg(3)                   
      itab=ibeg(nfile)                                                          
      faster=taxinc                                                             
  10  itab=itab+1                                                               
      if(faster.le.toptab(itab)) go to 100                                      
      go to 10                                                                  
  100 continue                                                                  
      rate=tmrtab(itab)                                                         
      tax=acctab(itab)+(faster-toptab(itab-1))*rate                             
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c   Calculate regular taxes 1971-1976                                           
c                                                                               
      subroutine tax74(tax,rate,nfile,sepret,taxinc)                            
      implicit double precision (A-H,O-Z)                                       
      common /tab74/ toptab(86),tmrtab(86),acctab(87),ibeg(3)                   
      integer sepret                                                            
      itab=ibeg(nfile)                                                          
      faster=taxinc*sepret                                                      
  10  itab=itab+1                                                               
      if(faster.le.toptab(itab)) go to 100                                      
      go to 10                                                                  
  100 continue                                                                  
      rate=tmrtab(itab)                                                         
      tax=(acctab(itab)+(faster-toptab(itab-1))*rate)/sepret                    
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c   Calculate regular taxes 1977-78                                             
c                                                                               
      subroutine rtax77(tax,rate,nfile,sepret,taxinc)                           
      implicit double precision (A-H,O-Z)                                       
      common /l6077/ toptab(89),tmrtab(89),acctab(90),ibeg(3)                   
      integer sepret                                                            
      itab=ibeg(nfile)                                                          
      faster=taxinc*sepret                                                      
  10  itab=itab+1                                                               
      if(faster.le.toptab(itab)) go to 100                                      
      go to 10                                                                  
  100 continue                                                                  
      rate=tmrtab(itab)                                                         
      tax=(acctab(itab)+(faster-toptab(itab-1))*rate)/sepret                    
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c   Calculate regular taxes 1979                                                
c                                                                               
      subroutine rtax79(tax,rate,nfile,sepret,taxinc)                           
      implicit double precision (A-H,O-Z)                                       
      common /l6079/ toptab(52),tmrtab(52),acctab(53),ibeg(3)                   
      integer sepret                                                            
      itab=ibeg(nfile)                                                          
      faster=taxinc*sepret                                                      
  10  itab=itab+1                                                               
      if(faster.le.toptab(itab)) go to 100                                      
      go to 10                                                                  
  100 continue                                                                  
      rate=tmrtab(itab)                                                         
      tax=(acctab(itab)+(faster-toptab(itab-1))*rate)/sepret                    
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c    Second set of Tax table lookup for 1977 and 1978                           
c                                                                               
      subroutine tax77 (taxinc,sepret,nfile,rate,tax)                           
      implicit double precision (A-H,O-Z)                                       
      common /tab77/  ibeg(3),iend(3),toptab(83),tmrtab(83),                    
     &                     acctab(83)                                           
      integer sepret                                                            
      ttax = 0.                                                                 
      atab = 0.                                                                 
      btab = 0.                                                                 
      faster = taxinc*sepret                                                    
      itab = ibeg(nfile) - 1                                                    
10    itab = itab+1                                                             
      atab = toptab(itab)                                                       
      if (faster.le.atab) goto 200                                              
      trate = tmrtab(itab)                                                      
      ttax = ttax+trate*(atab-btab)                                             
      btab = atab                                                               
      goto 10                                                                   
200   continue                                                                  
      rate = tmrtab(itab)                                                       
      tax = (ttax+rate*(faster-btab))/sepret                                    
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c     Tax table lookup for 1979-1981                                            
c                                                                               
      subroutine tax79(taxinc,sepret,nfile,rate,tax)                            
      implicit double precision (A-H,O-Z)                                       
      common /tab79/  toptab(52),tmrtab(52),acctab(53),ibeg(3)                  
      integer sepret                                                            
      faster = taxinc*sepret                                                    
      itab = ibeg(nfile)                                                        
10    itab = itab+1                                                             
      if (faster.le.toptab(itab)) goto 200                                      
      goto 10                                                                   
200   continue                                                                  
      rate = tmrtab(itab)                                                       
      tax = (acctab(itab)+rate*(faster-toptab(itab-1)))/sepret                  
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c     Tax table lookup for 1982                                                 
c                                                                               
      subroutine tax82(taxinc,sepret,nfile,rate,tax)                            
      implicit double precision (A-H,O-Z)                                       
      common /tab82/  toptab(43),tmrtab(43),acctab(44),ibeg(3)                  
      integer sepret                                                            
      faster = taxinc*sepret                                                    
      itab = ibeg(nfile)                                                        
10    itab = itab+1                                                             
      if (faster.le.toptab(itab)) goto 200                                      
      goto 10                                                                   
200   continue                                                                  
      rate = tmrtab(itab)                                                       
      tax = (acctab(itab)+rate*(faster-toptab(itab-1)))/sepret                  
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c     Tax table lookup for 1983                                                 
c                                                                               
      subroutine tax83(taxinc,sepret,nfile,rate,tax)                            
      implicit double precision (A-H,O-Z)                                       
      common /tab83/  toptab(46),tmrtab(46),acctab(47),ibeg(3)                  
      integer sepret                                                            
      faster = taxinc*sepret                                                    
      itab = ibeg(nfile)                                                        
10    itab = itab+1                                                             
      if (faster.le.toptab(itab)) goto 200                                      
      goto 10                                                                   
200   continue                                                                  
      rate = tmrtab(itab)                                                       
      tax = (acctab(itab)+rate*(faster-toptab(itab-1)))/sepret                  
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c     Tax table lookup for 1984-1986                                            
c                                                                               
      subroutine tax84(taxinc,sepret,nfile,rate,tax)                            
      implicit double precision (A-H,O-Z)                                       
      common /tab84/  toptab(49),tmrtab(49),acctab(50),ibeg(3)                  
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      integer sepret                                                            
      faster = taxinc*sepret                                                    
      itab = ibeg(nfile)                                                        
10    itab = itab+1                                                             
      if (faster.le.xndx*toptab(itab)) goto 200                                 
      goto 10                                                                   
200   continue                                                                  
      rate = tmrtab(itab)                                                       
      tax = (xndx*acctab(itab)+rate*(faster-xndx*toptab(itab-1)))/              
     &            sepret                                                        
      if(tax.le.0) rate=0.                                                      
      return                                                                    
      end                                                                       
c                                                                               
c     Tax table lookup for 1987 incorporates 28% max rate on gains.             
c                                                                               
      subroutine tax87(taxinc,sepret,nfile,rate,tax,data)                       
      implicit double precision (A-H,O-Z)                                       
      dimension data(255)                                                       
      common /tab87/  toptab(18),tmrtab(18),acctab(19),ibeg(3)                  
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      double precision cgflag                                                   
      integer sepret                                                            
      itab = ibeg(nfile)                                                        
      ttab = toptab(itab+3)/sepret                                              
      cglong = min(data(70),data(68)+data(70))                                  
      cglong = max(cglong,0.0d0)                                                
c                                                                               
      if (taxinc.ge.ttab.and.taxinc-cglong.le.ttab) then                        
c                                                                               
c     Tax on income up to 28% bracket plus 28% of excess.                       
c                                                                               
         rate = tmrtab(itab)                                                    
         t28 = (taxinc-ttab)                                                    
         tax = acctab(itab+4)/sepret+.28*t28                                    
         if(t28.gt.0.and.rate.eq.0) rate=.28                                    
      else                                                                      
c                                                                               
c     Tax on non-cg income plus 28% of cg income.                               
c                                                                               
         if (taxinc.lt.ttab) then                                               
            faster = taxinc*sepret                                              
            cgflag = 0.                                                         
         else                                                                   
            faster = (taxinc-cglong)*sepret                                     
            cgflag = 1.                                                         
         endif                                                                  
10       itab = itab+1                                                          
         if (faster .le. toptab(itab)) goto 200                                 
         goto 10                                                                
200      continue                                                               
         rate = tmrtab(itab)                                                    
         tax = (acctab(itab)+rate*(faster-toptab(itab-1)))/                     
     &               sepret                                                     
         if (tax.le.0.) rate = 0.                                               
         tax = tax+.28*cglong*cgflag                                            
         if(cglong.gt.0.and.rate.eq.0) rate=.28                                 
      endif                                                                     
      return                                                                    
      end                                                                       
c                                                                               
c     Tax table lookup for 1988 to 1990                                         
c                                                                               
      subroutine tax88(taxinc,sepret,nfile,rate,tax)                            
      implicit double precision (A-H,O-Z)                                       
      common /tab88/   toptab(9),tmrtab(9),acctab(10),ibeg(3)                   
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      integer sepret                                                            
      faster = taxinc*sepret                                                    
      itab = ibeg(nfile)                                                        
10    itab = itab+1                                                             
      if (faster.le.xndx*toptab(itab)) goto 200                                 
      goto 10                                                                   
200   continue                                                                  
      rate = tmrtab(itab)                                                       
      tax = (xndx*acctab(itab)+rate*(faster-xndx*toptab(itab-1)))/              
     &            sepret                                                        
      if (tax.le.0.) rate = 0.                                                  
      return                                                                    
      end                                                                       
c                                                                               
c     Tax table lookup for 1991 incorporates 28% max rate on gains.             
c                                                                               
      subroutine tax91(taxinc,sepret,nfile,rate,tax,data,regtax)                
      implicit double precision (A-H,O-Z)                                       
      dimension data(255)                                                       
      common /tab91/  toptab(12),tmrtab(12),acctab(13),ibeg(3)                  
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common /xndxac/ xndxa(1981:2023)                                          
                                                                                
      common /newshr/ comnew(255)                                               
      integer sepret                                                            
      itab = ibeg(nfile)                                                        
      bot28 = toptab(itab+1)/sepret                                             
      top28 = toptab(itab+2)/sepret                                             
      acc = 0                                                                   
c                                                                               
c index to 1991 levels                                                          
c                                                                               
      pcglg=0                                                                   
c      blowup = xndx/1.124                                                      
      blowup = xndx/xndxa(1991)                                                 
                                                                                
      cglong = min(data(70),data(68)+data(70))/blowup                           
      taxin2 = taxinc/blowup                                                    
      taxin3 = taxin2                                                           
      faster = taxin3*sepret                                                    
                                                                                
                                                                                
101   itab = itab+1                                                             
      if (faster .le. toptab(itab)) goto 100                                    
      acc = acc+tmrtab(itab)*(toptab(itab)-toptab(itab-1))                      
      goto 101                                                                  
100   continue                                                                  
      rate = tmrtab(itab)                                                       
      regtax = (acc+rate*(faster-toptab(itab-1)))/sepret                        
                                                                                
      regtax = regtax*blowup                                                    
                                                                                
      if (regtax.le.0.) rate = 0.                                               
      acc=0.                                                                    
      itab = ibeg(nfile)                                                        
      if(data(70).gt.0..and.cglong.gt.0..                                       
     &               and.taxin2.gt.top28) then                                  
        taxin3 = max(taxin2-cglong,bot28)                                       
        faster = taxin3*sepret                                                  
        pcglg=1                                                                 
10      itab = itab+1                                                           
        if (faster .le. toptab(itab)) goto 200                                  
        acc = acc+tmrtab(itab)*(toptab(itab)-toptab(itab-1))                    
        goto 10                                                                 
200     continue                                                                
        rate = tmrtab(itab)                                                     
        tax = (acc+rate*(faster-toptab(itab-1)))/sepret                         
        excess = taxin2 - taxin3                                                
        tax = tax+.28*excess                                                    
        if(excess.gt.0.and.pcglg.gt.0.and.taxin2-cglong.lt.bot28)               
     &  rate=.28                                                                
        tax = tax*blowup                                                        
        if (tax.le.0.) rate = 0.                                                
      else                                                                      
        tax=regtax                                                              
      endif                                                                     
      return                                                                    
      end                                                                       
c                                                                               
c   ****************************************************************************
c    Clinton tax increases for tax year 1993                                    
c   ****************************************************************************
c                                                                               
      subroutine tax93                                                          
     &(taxinc,sepret,nfile,regrat,tax,data,tax36,surtax,short,regtax)           
      implicit double precision (A-H,O-Z)                                       
      dimension data(255)                                                       
      common /tab93/ toptab(18),tmrtab(18),acctab(19),ibeg(3)                   
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common /newshr/ comnew(255)                                               
      integer sepret                                                            
      acc = 0.                                                                  
      cglong = min(data(70),data(68)+data(70))                                  
      itab = ibeg(nfile)                                                        
      bot28 = toptab(itab+1)                                                    
      top28 = toptab(itab+2)                                                    
      taxin2=taxinc                                                             
      pcglg=0.                                                                  
      taxin3 = taxin2                                                           
      faster = taxin3*sepret                                                    
101   itab = itab+1                                                             
      if (faster .le. toptab(itab)) goto 100                                    
         rate=tmrtab(itab)                                                      
         acc=acc+rate*(toptab(itab)-toptab(itab-1))                             
         goto 101                                                               
100      continue                                                               
      regrat = tmrtab(itab)                                                     
      regtax = (acc+regrat*(faster-toptab(itab-1)))/sepret                      
c                                                                               
      acc=0.                                                                    
      itab = ibeg(nfile)                                                        
      if(data(70).gt.0..and.cglong.gt.0..and.                                   
     &    taxin2*sepret.gt.top28) then                                          
        taxin3 = max(taxin2-cglong,bot28)                                       
        faster = (taxin3)*sepret                                                
        pcglg=1.                                                                
10      itab = itab+1                                                           
        if (faster .le. toptab(itab)) goto 200                                  
        rate=tmrtab(itab)                                                       
        acc=acc+rate*(toptab(itab)-toptab(itab-1))                              
        goto 10                                                                 
200     continue                                                                
        rate = tmrtab(itab)                                                     
        taxncg = (acc+rate*(faster-toptab(itab-1)))/sepret                      
        excess = taxin2 - taxin3                                                
        tax = taxncg+.28*excess                                                 
        if(excess.gt.0.and.pcglg.gt.0.and.taxin2-cglong.lt.bot28)               
     &  rate=.28                                                                
        if (tax.le.0.) rate = 0.                                                
      else                                                                      
        tax=regtax                                                              
      endif                                                                     
      tax36 = 0.                                                                
      surtax = 0.                                                               
      itab = ibeg(nfile)                                                        
      itab = itab+1                                                             
      taxnbk = (faster-toptab(itab-1))/sepret                                   
      if(mod(itab,6).eq.4.or.mod(itab,6).eq.5) then                             
         short = (toptab(itab)-faster)/sepret                                   
      else                                                                      
         short = 0.                                                             
      endif                                                                     
      along=toptab(itab)-faster                                                 
      if(data(70).gt.0..and.cglong.gt.0..and.taxin2.gt.top28) then              
         if(along.eq.0) along=34000                                             
      endif                                                                     
      tax36=0.                                                                  
      surtax=0.                                                                 
      if(mod(itab,6).eq.5) then                                                 
         tax36 = .05*taxnbk                                                     
         surtax = 0.                                                            
      elseif(mod(itab,6).eq.0) then                                             
         tax36 = .05*(faster-toptab(itab-2))/sepret                             
         surtax = .036*taxnbk                                                   
      else                                                                      
         tax36=0.                                                               
         surtax=0.                                                              
      endif                                                                     
      if (tax.le.0.) rate = 0.                                                  
      return                                                                    
      end                                                                       
c                                                                               
c   ****************************************************************************
c    Clinton tax increases for years beginning in 1994                          
c   ****************************************************************************
c                                                                               
      subroutine tax94                                                          
     &(taxinc,sepret,nfile,rate,tax,data,tax36,surtax,short,lawyr,              
     & regtax)                                                                  
      implicit double precision (A-H,O-Z)                                       
      dimension data(255), ibeg(3),toptab(18),tmrtab(18)                        
      common /tab94/ top94(18),tmr94(18),ibeg94(3)                              
      common /tab95/ top95(18),tmr95(18),ibeg95(3)                              
      common /tab96/ top96(18),tmr96(18),ibeg96(3)                              
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common /newshr/ comnew(255)                                               
      integer sepret                                                            
      acc = 0.                                                                  
      cglong = 0.                                                               
      if (data(70).gt.0.)                                                       
     &    cglong = max(0.0d0,min(data(70),data(68)+data(70)))                   
c                                                                               
      if (lawyr.eq.1994) then                                                   
         do 11 i=1,3                                                            
         ibeg(i) = ibeg94(i)                                                    
11       continue                                                               
         do 12 i=1,18                                                           
         toptab(i) = top94(i)                                                   
         tmrtab(i) = tmr94(i)                                                   
12       continue                                                               
      elseif (lawyr.eq.1995) then                                               
         do 21 i=1,3                                                            
         ibeg(i) = ibeg95(i)                                                    
21       continue                                                               
         do 22 i=1,18                                                           
         toptab(i) = top95(i)                                                   
         tmrtab(i) = tmr95(i)                                                   
22       continue                                                               
      elseif (lawyr.eq.1996) then                                               
         do 31 i=1,3                                                            
         ibeg(i) = ibeg96(i)                                                    
31       continue                                                               
         do 32 i=1,18                                                           
         toptab(i) = top96(i)                                                   
         tmrtab(i) = tmr96(i)                                                   
32       continue                                                               
      endif                                                                     
c                                                                               
      itab = ibeg(nfile)                                                        
      bot28 = toptab(itab+1)                                                    
      top28 = toptab(itab+2)                                                    
      taxin3 = 0                                                                
      excess = 0.                                                               
      faster =taxinc*sepret                                                     
10    itab = itab+1                                                             
      if (faster.le.toptab(itab)) goto 200                                      
      rate=tmrtab(itab)                                                         
      acc=acc+rate*(toptab(itab)-toptab(itab-1))                                
      goto 10                                                                   
200   continue                                                                  
      rate = tmrtab(itab)                                                       
      regtax = (acc+rate*(faster-toptab(itab-1)))/sepret                        
      regrat = rate                                                             
      tax = regtax                                                              
      acc = 0.                                                                  
      if(cglong.gt.0) then                                                      
         itab = ibeg(nfile)                                                     
         bot28 = toptab(itab+1)                                                 
         top28 = toptab(itab+2)                                                 
         taxin3 =max(bot28/sepret,taxinc-cglong)                                
         faster = taxin3*sepret                                                 
         excess=max(0.0d0,taxinc - taxin3)                                      
101      itab = itab+1                                                          
         if (faster.le.toptab(itab)) goto 2001                                  
         rate=tmrtab(itab)                                                      
         acc=acc+rate*(toptab(itab)-toptab(itab-1))                             
         goto 101                                                               
2001     continue                                                               
         rate = tmrtab(itab)                                                    
         if((acc+rate*(faster-toptab(itab-1)))/sepret+.28*excess.lt.            
     & regtax) then                                                             
          tax=(acc+rate*(faster-toptab(itab-1)))/sepret+.28*excess              
          if(bot28/sepret.gt.taxinc-cglong) rate=0.28                           
         endif                                                                  
      endif                                                                     
      tax36 = 0.                                                                
      surtax = 0.                                                               
      short = 0.                                                                
      taxnbk = (faster-toptab(itab-1))/sepret                                   
      if(mod(itab,6).eq.4.or.mod(itab,6).eq.5) then                             
         short = (toptab(itab)-faster)/sepret                                   
      endif                                                                     
      along=toptab(itab)-faster                                                 
      if(data(70).gt.0.and.cglong.gt.0.and.taxinc*sepret.gt.top28) then         
         if(along.eq.0) along=34000                                             
      endif                                                                     
      if(mod(itab,6).eq.5) then                                                 
         tax36 = .05*taxnbk                                                     
         surtax = 0.                                                            
      elseif(mod(itab,6).eq.0) then                                             
         tax36 = .05*(faster-toptab(itab-2))/sepret                             
         surtax = .0360*taxnbk                                                  
      endif                                                                     
c      if (tax.le.0.) rate = 0.                                                 
      return                                                                    
      end                                                                       
c                                                                               
c   ****************************************************************************
c      TRA97                                                                    
c   ****************************************************************************
c                                                                               
      subroutine tax97 (taxinc,sepret,nfile,rate,tax,data,lawyr,brac15,         
     &                  regtax,taxng,taxltg,ltg)                                
      implicit double precision (A-H,O-Z)                                       
      double precision ltg                                                      
      dimension data(255), ibeg(3),toptab(18),tmrtab(18)                        
      common /tab97/ top97(18),tmr97(18),ibeg97(3)                              
      common /tab98/ top98(18),tmr98(18),ibeg98(3)                              
      common /tab99/ top99(18),tmr99(18),ibeg99(3)                              
      common /tab00/ top00(18),tmr00(18),ibeg00(3)                              
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common/newshr/comnew(255)                                                 
      common /xndxac/ xndxa(1981:2023)                                          
      integer sepret                                                            
      acc = 0.                                                                  
      cglong = max(0.0d0,ltg-data(115)-data(138))                               
      taxin9 = max(0.0d0,taxinc-cglong)                                         
c                                                                               
      if (lawyr.eq.1997) then                                                   
         do 11 i=1,3                                                            
         ibeg(i) = ibeg97(i)                                                    
11       continue                                                               
         do 12 i=1,18                                                           
         toptab(i) = top97(i)                                                   
         tmrtab(i) = tmr97(i)                                                   
12       continue                                                               
      elseif (lawyr.eq.1998) then                                               
         do 21 i=1,3                                                            
         ibeg(i) = ibeg98(i)                                                    
21       continue                                                               
         do 22 i=1,18                                                           
         toptab(i) = top98(i)                                                   
         tmrtab(i) = tmr98(i)                                                   
22       continue                                                               
      elseif (lawyr.eq.1999) then                                               
         do 31 i=1,3                                                            
         ibeg(i) = ibeg99(i)                                                    
31       continue                                                               
         do 32 i=1,18                                                           
         toptab(i) = top99(i)                                                   
         tmrtab(i) = tmr99(i)                                                   
32       continue                                                               
      elseif (lawyr.eq.2000.or.egtrra.ne.1) then                                
         do 41 i=1,3                                                            
         ibeg(i) = ibeg00(i)                                                    
41       continue                                                               
         do 42 i=1,18                                                           
         toptab(i) = top00(i)*xndxa(lawyr)/xndxa(2000)                          
         tmrtab(i) = tmr00(i)                                                   
42       continue                                                               
      endif                                                                     
                                                                                
      last1 = ibeg(1) + ibeg(3) - ibeg(2) - 1                                   
      tmrtab(last1) = tmrtab(last1) + extnd(18)                                 
      tmrtab(ibeg(1)-1)  = tmrtab(ibeg(1)-1) + extnd(18)                        
      tmrtab(ibeg(3)-1)  = tmrtab(ibeg(3)-1) + extnd(18)                        
                                                                                
      mstat = int(data(2))                                                           
      if(mstat.eq.1) then                                                       
           brac15=toptab(14)                                                    
      else if(mstat.eq.4.or.mstat.eq.7) then                                    
           brac15=toptab(8)                                                     
      else                                                                      
           brac15=toptab(2)/sepret                                              
      endif                                                                     
      itab = ibeg(nfile)                                                        
      faster = taxinc*sepret                                                    
101   itab = itab+1                                                             
      if (faster.le.toptab(itab)) goto 100                                      
      rate = tmrtab(itab)                                                       
      acc = acc+rate*(toptab(itab)-toptab(itab-1))                              
      goto 101                                                                  
100   continue                                                                  
      regrat = tmrtab(itab)                                                     
      regtax = (acc+regrat*(faster-toptab(itab-1)))/sepret                      
      bp = toptab(itab-1)                                                       
      if(regtax.le.0) regrat=0.                                                 
c                                                                               
      acc = 0.                                                                  
      itab = ibeg(nfile)                                                        
      faster = taxin9*sepret                                                    
10    itab = itab+1                                                             
      if (faster.le.toptab(itab)) goto 200                                      
      rate = tmrtab(itab)                                                       
      acc = acc+rate*(toptab(itab)-toptab(itab-1))                              
      goto 10                                                                   
200   continue                                                                  
      rate = tmrtab(itab)                                                       
      taxng = (acc+rate*(faster-toptab(itab-1)))/sepret                         
                                                                                
      if(taxng.le.0) rate=0.                                                    
      bpng = toptab(itab-1)                                                     
c                                                                               
c  if rate eq .15, then taxin9 is below the 15% bracket                         
c                                                                               
      taxltg = 0.                                                               
      if(cglong.gt.0) then                                                      
        taxltg=.1*(max(0.0d0,min(taxinc,brac15/sepret)-taxin9))+                
     & .2*(min(taxinc,cglong)-max(0.0d0,min(taxinc,brac15/sepret)               
     &-taxin9))+.25*data(115)                                                   
      endif                                                                     
c calculations line-by-line Schedule D for the year 1999                        
      if(ltg.gt.0) then                                                         
c data18 is non-schedule D capital gains in agi                                 
         xlin20 = ltg                                                           
         xlin21 = data(138)                                                     
         xlin22 = max(0.0d0,xlin20-xlin21)                                      
         xlin23 = max(0.0d0,data(68)+data(117))                                 
         xlin24 = max(0.0d0,min(data(117),xlin23))                              
         xlin25 = data(115)                                                     
         xlin26 = xlin25 + xlin24                                               
         xlin27 = max(0.0d0,xlin22-xlin26)                                      
         xlin28 = max(0.0d0,taxinc-xlin27)                                      
         xlin29 = min(brac15,taxinc)                                            
         xlin30 = min(xlin28,xlin29)                                            
         xlin31 = max(0.0d0,taxinc-xlin22)                                      
         xlin32 = max(xlin30,xlin31)                                            
         if(ltg.eq.data(18).and.data(18).gt.0) then                             
c Capital gain tax worksheet                                                    
           w3 = max(0.0d0,taxinc - data(18))                                    
           xlin32 = w3                                                          
         endif                                                                  
         acc = 0.                                                               
         itab = ibeg(nfile)                                                     
         faster = xlin32*sepret                                                 
1000     itab = itab+1                                                          
         if (faster.le.toptab(itab)) goto 2000                                  
         rate = tmrtab(itab)                                                    
         acc = acc+rate*(toptab(itab)-toptab(itab-1))                           
         goto 1000                                                              
2000     continue                                                               
         rate = tmrtab(itab)                                                    
         taxng = (acc+rate*(faster-toptab(itab-1)))/sepret                      
         if(taxng.le.0) rate=0.                                                 
         bpng = toptab(itab-1)                                                  
         xlin36 = max(0.0d0,xlin29-xlin28)                                      
         if(ltg.eq.data(18).and.data(18).gt.0) then                             
c Capital gain tax worksheet (page 33 2000 form 1040 instructions)              
           w5 = min(brac15,taxinc)                                              
           if(w3.ge.w5) then                                                    
              w7 = 0.                                                           
           else                                                                 
              w6 = w3                                                           
              w7 = max(0.0d0,w5 - w6)                                           
           endif                                                                
           xlin37 = w7                                                          
         endif                                                                  
         schd10 = .1*xlin36                                                     
         xlin38 = min(taxinc,xlin27)                                            
         xlin40 = xlin38 - xlin36                                               
         if(ltg.eq.data(18).and.data(18).gt.0) then                             
c Capital gain tax worksheet (page 33 2000 form 1040 instructions)              
           if(data(18).eq.w7) then                                              
             w11 = 0.                                                           
           else                                                                 
             w9 = min(taxinc,data(18))                                          
             w11 = max(0.0d0,w9 - w7)                                           
           endif                                                                
           xlin40 = w11                                                         
         endif                                                                  
         schd20 = .2*xlin40                                                     
         xlin42 = min(xlin22,xlin25)                                            
         xlin43 = xlin22 + xlin32                                               
         xlin45 = max(0.0d0,xlin43-taxinc)                                      
         xlin46 = max(0.0d0,xlin42-xlin45)                                      
         schd25 = .25*xlin46                                                    
         xlin49 = xlin32+xlin36+xlin40+xlin46                                   
         xlin50 = taxinc-xlin49                                                 
         schd28 = .28*xlin50                                                    
         if(ltg.eq.data(18).and.data(18).gt.0) then                             
c Capital gain tax worksheet (page 33 2000 form 1040 instructions)              
           schd28 = 0                                                           
         endif                                                                  
         taxltg = schd10 + schd20 + schd25 + schd28                             
      endif                                                                     
      if(regtax.lt.taxng+taxltg) then                                           
         tax = regtax                                                           
      else                                                                      
         tax = taxng+taxltg                                                     
         bp = bpng                                                              
      endif                                                                     
c     comnew(96) =regtax-tax                                                    
      comnew(90) = bp                                                           
c                                                                               
      return                                                                    
      end                                                                       
c                                                                               
c                                                                               
c   ****************************************************************************
c      TRA2001                                                                  
c   ****************************************************************************
c                                                                               
      subroutine tax01 (lawyr,taxinc,sepret,nfile,rate,tax,data,brac15,         
     &                  regtax,taxng,taxltg,ltg,sch10,sch20,sch25,              
     &                  addtax)                                                 
      implicit double precision (A-H,O-Z)                                       
      double precision ltg                                                      
      dimension data(255)                                                       
      common /tab01/ top01(21),tmr01(21),ibeg01(3)                              
      common /tab02/ top02(21),tmr02(21),ibeg02(3)                              
      common /tab03/ top03(21),tmr03(21),ibeg03(3)                              
      common /tab04/ top04(21),tmr04(21),ibeg04(3)                              
      common /tab05/ top05(21),tmr05(21),ibeg05(3)                              
      common /tab06/ top06(21),tmr06(21),ibeg06(3)                              
      common /tab07/ top07(21),tmr07(21),ibeg07(3)                              
      common /tab08/ top08(21),tmr08(21),ibeg08(3)                              
      common /tab09/ top09(21),tmr09(21),ibeg09(3)                              
      common /tab10/ top10(21),tmr10(21),ibeg10(3)                              
      common /tab11/ top11(21),tmr11(21),ibeg11(3)                              
      common /tab12/ top12(21),tmr12(21),ibeg12(3)                              
      common /tab13/ top13(24),tmr13(24),ibeg13(3)                              
      common /tab14/ top14(24),tmr14(24),ibeg14(3)                              
      common /tab15/ top15(24),tmr15(24),ibeg15(3)                              
      common /tab16/ top16(24),tmr16(24),ibeg16(3)                              
      common /tab17/ top17(24),tmr17(24),ibeg17(3)                              
      common /tab18/ top18(24),tmr18(24),ibeg18(3)                              
      common /tab19/ top19(24),tmr19(24),ibeg19(3)                              
      common /tab20/ top20(24),tmr20(24),ibeg20(3)                              
      common /tab21/ top21(24),tmr21(24),ibeg21(3)                              
      common /tab22/ top22(24),tmr22(24),ibeg22(3)                              
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common /newshr/comnew(255)                                                
      common /cgrt/ cgrat1,cgrate                                               
      common /xndxac/ xndxa(1981:2023)                                          
      dimension ibeg(3),toptab(24),tmrtab(24)                                   
      integer sepret                                                            
      at28 = 0.                                                                 
      x2012 = 1.973                                                             
      x2013 = 2.0223                                                            
      nmax = 21                                                                 
      if(lawyr.ge.2013) nmax = 24                                               
      if(lawyr.eq.2001) then                                                    
         do 11 i=1,3                                                            
         ibeg(i) = ibeg01(i)                                                    
11       continue                                                               
         do 12 i=1,21                                                           
         toptab(i) = top01(i)                                                   
         tmrtab(i) = tmr01(i)                                                   
12       continue                                                               
      else if(lawyr.eq.2002) then                                               
         do 21 i=1,3                                                            
         ibeg(i) = ibeg02(i)                                                    
21       continue                                                               
         do 22 i=1,21                                                           
         toptab(i) = top02(i)                                                   
         tmrtab(i) = tmr02(i)                                                   
22       continue                                                               
      else if(lawyr.eq.2003) then                                               
         do 31 i=1,3                                                            
         ibeg(i) = ibeg03(i)                                                    
31       continue                                                               
         do 32 i=1,21                                                           
         toptab(i) = top03(i)                                                   
         tmrtab(i) = tmr03(i)                                                   
32       continue                                                               
      elseif(lawyr.eq.2004) then                                                
         do 41 i=1,3                                                            
         ibeg(i) = ibeg04(i)                                                    
41       continue                                                               
         do 42 i=1,21                                                           
         toptab(i) = top04(i)                                                   
         tmrtab(i) = tmr04(i)                                                   
42       continue                                                               
      elseif(lawyr.eq.2005) then                                                
         do 51 i=1,3                                                            
         ibeg(i) = ibeg05(i)                                                    
51       continue                                                               
         do 52 i=1,21                                                           
         toptab(i) = top05(i)                                                   
         tmrtab(i) = tmr05(i)                                                   
52       continue                                                               
      elseif(lawyr.eq.2006) then                                                
         do 61 i=1,3                                                            
         ibeg(i) = ibeg06(i)                                                    
61       continue                                                               
         do 62 i=1,21                                                           
         toptab(i) = top06(i)                                                   
         tmrtab(i) = tmr06(i)                                                   
62       continue                                                               
      elseif(lawyr.eq.2007) then                                                
         do 71 i=1,3                                                            
         ibeg(i) = ibeg07(i)                                                    
71       continue                                                               
         do 72 i=1,21                                                           
         toptab(i) = top07(i)                                                   
         tmrtab(i) = tmr07(i)                                                   
72       continue                                                               
      elseif(lawyr.eq.2008) then                                                
         do 81 i=1,3                                                            
         ibeg(i) = ibeg08(i)                                                    
81       continue                                                               
         do 82 i=1,21                                                           
         toptab(i) = top08(i)                                                   
         tmrtab(i) = tmr08(i)                                                   
82       continue                                                               
      elseif(lawyr.eq.2009) then                                                
         do 83 i=1,3                                                            
         ibeg(i) = ibeg09(i)                                                    
83       continue                                                               
         do 84 i=1,21                                                           
         toptab(i) = top09(i)                                                   
         tmrtab(i) = tmr09(i)                                                   
84       continue                                                               
      elseif(lawyr.eq.2010) then                                                
         do 85 i=1,3                                                            
         ibeg(i) = ibeg10(i)                                                    
85       continue                                                               
         do 86 i=1,21                                                           
         toptab(i) = top10(i)                                                   
         tmrtab(i) = tmr10(i)                                                   
86       continue                                                               
      elseif(lawyr.eq.2011) then                                                
          do 91 i=1,3                                                           
          ibeg(i) = ibeg11(i)                                                   
91        continue                                                              
          do 92 i=1,21                                                          
          toptab(i) = top11(i)                                                  
          tmrtab(i) = tmr11(i)                                                  
92        continue                                                              
      elseif(lawyr.eq.2012) then                                                
          do 95 i=1,3                                                           
          ibeg(i) = ibeg12(i)                                                   
95        continue                                                              
          do 96 i=1,21                                                          
          toptab(i) = top12(i)                                                  
          tmrtab(i) = tmr12(i)                                                  
96        continue                                                              
      elseif(lawyr.eq.2013) then                                                
          do 901 i=1,3                                                          
          ibeg(i) = ibeg13(i)                                                   
901       continue                                                              
          do 902 i=1,24                                                         
          toptab(i) = top13(i)                                                  
          tmrtab(i) = tmr13(i)                                                  
902       continue                                                              
      elseif(lawyr.eq.2014) then                                                
c Federal Individual Income Tax Rates for 2014                                  
          do 911 i=1,3                                                          
          ibeg(i) = ibeg14(i)                                                   
911       continue                                                              
          do 912 i=1,24                                                         
          toptab(i) = top14(i)                                                  
          tmrtab(i) = tmr14(i)                                                  
912       continue                                                              
      elseif(lawyr.eq.2015) then                                                
c Federal Individual Income Tax Rates for 2015                                  
          do 921 i=1,3                                                          
          ibeg(i) = ibeg15(i)                                                   
921       continue                                                              
          do 922 i=1,24                                                         
          toptab(i) = top15(i)                                                  
          tmrtab(i) = tmr15(i)                                                  
922       continue                                                              
      elseif(lawyr.eq.2016) then                                                
          do 931 i=1,3                                                          
          ibeg(i) = ibeg16(i)                                                   
931       continue                                                              
          do 932 i=1,24                                                         
          toptab(i) = top16(i)                                                  
          tmrtab(i) = tmr16(i)                                                  
932       continue                                                              
      elseif(lawyr.eq.2017) then                                                
c Federal Individual Income Tax Rates for 2017                                  
          do 941 i=1,3                                                          
          ibeg(i) = ibeg17(i)                                                   
941       continue                                                              
          do 942 i=1,24                                                         
          toptab(i) = top17(i)                                                  
          tmrtab(i) = tmr17(i)                                                  
942       continue                                                              
      elseif(lawyr.eq.2018) then                                                
c Federal Individual Income Tax Rates for 2018                                  
          do 951 i=1,3                                                          
          ibeg(i) = ibeg18(i)                                                   
951       continue                                                              
          do 952 i=1,24                                                         
          toptab(i) = top18(i)                                                  
          tmrtab(i) = tmr18(i)                                                  
952       continue                                                              
      elseif(lawyr.eq.2019) then                                                
c Federal Individual Income Tax Rates for 2019                                  
          do 961 i=1,3                                                          
          ibeg(i) = ibeg19(i)                                                   
961       continue                                                              
          do 962 i=1,24                                                         
          toptab(i) = top19(i)                                                  
          tmrtab(i) = tmr19(i)                                                  
962       continue                                                              
      elseif(lawyr.eq.2020) then                                                
c Federal Individual Income Tax Rates for 2020                                  
          do 971 i=1,3                                                          
          ibeg(i) = ibeg20(i)                                                   
971       continue                                                              
          do 972 i=1,24                                                         
          toptab(i) = top20(i)                                                  
          tmrtab(i) = tmr20(i)                                                  
972       continue                                                              
      elseif(lawyr.eq.2021) then                                                
c Federal Individual Income Tax Rates for 2021                                  
          do 981 i=1,3                                                          
          ibeg(i) = ibeg21(i)                                                   
981       continue                                                              
          do 982 i=1,24                                                         
          toptab(i) = top21(i)                                                  
          tmrtab(i) = tmr21(i)                                                  
982       continue                                                              
      elseif(lawyr.ge.2022) then                                                
c Federal Individual Income Tax Rates for 2022+                                 
          do 991 i=1,3                                                          
          ibeg(i) = ibeg22(i)                                                   
991       continue                                                              
          do 992 i=1,24                                                         
          toptab(i) = top22(i)*xndxa(lawyr)/xndxa(2022)                         
          tmrtab(i) = tmr22(i)*(1+extnd(76)/100)                                
992       continue                                                              
          do 1001 j = 0,2                                                       
          tmrtab(6+8*j) = tmrtab(6+8*j) + extnd(63)                             
          tmrtab(7+8*j) = tmrtab(7+8*j) + extnd(64)                             
          tmrtab(8+8*j) = tmrtab(8+8*j) + extnd(65)                             
1001      continue                                                              
c extnd(45) - the top rate is extnd(45)                                         
          if(extnd(45).gt.0) then                                               
           do 934 j= 1,nmax                                                     
           tmrtab(j) = min(extnd(45),tmrtab(j))                                 
934        continue                                                             
          endif                                                                 
      endif                                                                     
      if(extnd(46).gt.0) then                                                   
        if(lawyr.ge.2013) then                                                  
c extnd(46) adds a little to the 3 top bracket rates 2013+                      
           do 905 j= 0,2                                                        
             tmrtab(6+8*j) = tmrtab(6+8*j) + extnd(46)                          
             tmrtab(7+8*j) = tmrtab(7+8*j) + extnd(46)                          
             tmrtab(8+8*j) = tmrtab(8+8*j) + extnd(46)                          
905        continue                                                             
        else                                                                    
c extnd(46) adds a little to the 2 top bracket rates 2001-2012                  
           do 906 j= 0,2                                                        
             tmrtab(6+7*j) = tmrtab(6+7*j) + extnd(46)                          
             tmrtab(7+7*j) = tmrtab(7+7*j) + extnd(46)                          
906        continue                                                             
        endif                                                                   
      endif                                                                     
c 15% rate bracket for joint returns as percentage of 15% for singles           
c added 10/01/2007                                                              
      last1 = ibeg(1) + ibeg(3) - ibeg(2) - 1                                   
      last2 = last1 - 1                                                         
      tmrtab(last1) = tmrtab(last1) + extnd(18)                                 
      tmrtab(last2) = tmrtab(last2) + extnd(19)                                 
      tmrtab(ibeg(1)-1)  = tmrtab(ibeg(1)-1) + extnd(18)                        
      tmrtab(ibeg(1)-2)  = tmrtab(ibeg(1)-2) + extnd(19)                        
      tmrtab(ibeg(3)-1)  = tmrtab(ibeg(3)-1) + extnd(18)                        
      tmrtab(ibeg(3)-2)  = tmrtab(ibeg(3)-2) + extnd(19)                        
c extnd(59) - Marty wants to simulate the effect of a 20% reduction in the brack
c rates(No change in capital gains or AMT)                                      
       do 359 i = 1,nmax                                                        
          tmrtab(i) = (1-extnd(59))*tmrtab(i)                                   
359    continue                                                                 
c extnd(60) - Marty wants to subtract a fixed number of                         
c percentage points from the tax rate                                           
      do 360 i = 1,nmax                                                         
          tmrtab(i) = max(0.0d0,tmrtab(i) - extnd(60))                          
360   continue                                                                  
      if(extnd(48).gt.0.and.lawyr.eq.2005) then                                 
c extnd48 changes the top rate a little for the year 2005                       
          do 999 j= 0,2                                                         
          tmrtab(7+7*j) = tmrtab(7+7*j) + extnd(48)                             
999       continue                                                              
      endif                                                                     
c     cglong = max(0.0d0,ltg-data(138)-data(115))                               
      cglong = max(0.0d0,ltg-data(115))                                         
      taxin9 = max(0.0d0,taxinc-cglong)                                         
c !!! it is important to have cglong formula for 2013+ and high taxinc !!!      
      taxltg = 0.                                                               
      sch10 = 0                                                                 
      sch20 = 0                                                                 
      sch25 = 0                                                                 
      sch28 = 0                                                                 
      r10 = 0.                                                                  
      r20 = 0.                                                                  
c Regular Tax calculation                                                       
      acc = 0.                                                                  
      itab = ibeg(nfile)                                                        
      itab0 = itab+1                                                            
      faster = taxinc*sepret                                                    
101   itab = itab+1                                                             
      if (faster.le.toptab(itab)) goto 100                                      
      rate = tmrtab(itab)*ratmul                                                
      acc = acc+rate*(toptab(itab)-toptab(itab-1))                              
      goto 101                                                                  
100   continue                                                                  
      regrat = tmrtab(itab)*ratmul                                              
      regtax = (acc+regrat*(faster-toptab(itab-1)))/sepret                      
      bp = toptab(itab-1)                                                       
      if(taxinc.eq.0.0d0) regrat = tmrtab(itab0)*ratmul                         
      if(regtax.le.0.0d0) regtax = 0.                                           
      comnew(153) = regrat*100                                                  
      tax = regtax                                                              
c brac15 definition                                                             
      if(nfile.eq.1) then                                                       
          brac15 = toptab(17)                                                   
          if(lawyr.ge.2013.and.lawyr.le.2017) brac15 = toptab(19)               
          if(lawyr.eq.2018) brac15 = 38600.d0                                   
          if(lawyr.eq.2019) brac15 = 39375.d0                                   
          if(lawyr.eq.2020) brac15 = 40000.d0                                   
          if(lawyr.eq.2021) brac15 = 40400.d0                                   
          if(lawyr.ge.2022) brac15 = 41675*xndx/xndxa(2022)                     
      else if(nfile.eq.3) then                                                  
          brac15 = toptab(10)                                                   
          if(lawyr.ge.2013.and.lawyr.le.2017) brac15 = toptab(11)               
          if(lawyr.eq.2018) brac15 = 51700.d0                                   
          if(lawyr.eq.2019) brac15 = 52750.d0                                   
          if(lawyr.eq.2020) brac15 = 53600.d0                                   
          if(lawyr.eq.2021) brac15 = 54100.d0                                   
          if(lawyr.ge.2022) brac15 = 55800*xndx/xndxa(2022)                     
      else                                                                      
          if(lawyr.le.2017) brac15 = toptab(3)/sepret                           
          if(lawyr.eq.2018) brac15 = 77200.d0/sepret                            
          if(lawyr.eq.2019) brac15 = 78750.d0/sepret                            
          if(lawyr.eq.2020) brac15 = 80000.d0/sepret                            
          if(lawyr.eq.2021) brac15 = 80800.d0/sepret                            
          if(lawyr.ge.2022) brac15 = (83350.d0/sepret)*xndx/xndxa(2022)         
      endif                                                                     
c Capital Gain rates definition                                                 
      cgrat1 = .1*cgmul                                                         
      cgrate = .2*cgmul                                                         
c Tax Increase Prevention and reconciliation Act of 2005                        
      if(lawyr.ge.2003) then                                                    
           cgrat1 = .05*cgmul                                                   
           if(lawyr.ge.2008) cgrat1 = 0.                                        
           cgrate = .15*cgmul                                                   
      endif                                                                     
c 2001 and 2002 tax special tax calculation                                     
      if(lawyr.le.2002) then                                                    
         xl4 = max(0.0d0,ltg - data(138))                                       
         xl5 = max(0.0d0,data(68)+data(117))                                    
         xl6 = max(0.0d0,min(xl5,data(117)))                                    
         xl9 = max(0.0d0,xl4-xl6-data(115))                                     
         xl10 = max(0.0d0,taxinc - xl9)                                         
         xl12 = min(xl10,brac15)                                                
         xl13 = max(0.0d0,taxinc - xl4)                                         
         taxin9 = max(xl12,xl13)                                                
c taxng calculation                                                             
         acc = 0.                                                               
         itab = ibeg(nfile)                                                     
         faster = taxin9*sepret                                                 
10       itab = itab+1                                                          
         if (faster.le.toptab(itab)) goto 200                                   
         rate = tmrtab(itab)*ratmul                                             
         if(rate.ge..27.and.rate.le..29)                                        
     &   at28 = (faster-toptab(itab-1))/sepret                                  
         acc = acc+rate*(toptab(itab)-toptab(itab-1))                           
         goto 10                                                                
200      continue                                                               
         rate = tmrtab(itab)*ratmul                                             
         taxng = (acc+rate*(faster-toptab(itab-1)))/sepret                      
         bpng = toptab(itab-1)                                                  
         if(taxin9.le.0) rate = 0.                                              
         if(taxng.le.0) taxng = 0.                                              
c  if rate eq .15, then taxin9 is below the 15% bracket                         
         xl16 = max(0.0d0,brac15-xl12)                                          
         sch10 = cgrat1*xl16                                                    
         xl22 = min(taxinc,xl9)                                                 
         xl24 = max(0.0d0,xl22 - xl16)                                          
         sch20 = cgrate*xl24                                                    
         xl26 = min(xl4,data(115))                                              
         xl27 = xl4+taxin9                                                      
         xl29 = max(0.0d0,xl27-taxinc)                                          
         xl30 = max(0.0d0,xl26-xl29)                                            
         sch25 = .25*xl30                                                       
         xl33 = taxinc-(taxin9+xl16+xl24+xl30)                                  
         sch28 = .28*max(0.0d0,xl33)                                            
         taxltg=sch10+sch20+sch25+sch28                                         
      endif                                                                     
      if(lawyr.eq.2003) then                                                    
c line-by-line 2003 sch D calculations                                          
         xl1 = taxinc                                                           
         xl6 = data(176)                                                        
         xl9 = max(0.0d0,comnew(6))                                             
         xl10 = ltg                                                             
         xl11 = max(0.0d0,data(115)+data(117))                                  
         xl12 = min(xl9,xl11)                                                   
         xl13 = xl10 - xl12                                                     
         xl14 = max(0.0d0,xl1 - xl13)                                           
         xl15 = min(taxinc,brac15)                                              
         xl16 = min(xl14,xl15)                                                  
         xl17 = max(0.0d0,xl1 - xl10)                                           
         xl18 = max(xl16,xl17)                                                  
         xl19 = xl15 - xl16                                                     
         xl20 = xl6                                                             
         xl21 = min(xl19,xl20)                                                  
         sch5 = .05*xl21                                                        
         xl23 = xl19 - xl21                                                     
         sch10 = .1*xl23                                                        
         xl29 = min(xl1,xl13)                                                   
         xl31 = max(0.0d0,xl29 - xl19)                                          
         xl32 = data(176)                                                       
         xl34 = xl32 - xl21                                                     
         xl35 = min(xl31,xl34)                                                  
         sch15 = .15*xl35                                                       
         xl37 = xl31 - xl35                                                     
         sch20 = .2*xl37                                                        
         xl39 = min(xl9,max(0.0d0,data(115)))                                   
         xl40 = xl10 + xl18                                                     
         xl41 = xl1                                                             
         xl42 = max(0.0d0,xl40 - xl41)                                          
         xl43 = max(0.0d0,xl39 - xl42)                                          
         sch25 = .25*xl43                                                       
         xl46 = xl1 - xl18 - xl19 - xl31 - xl43                                 
         sch28 = .28*xl46                                                       
         taxltg = sch5+sch10+sch15+sch20+sch25+sch28                            
c non-gain taxable income for 2003                                              
         faster = xl18*sepret                                                   
         acc = 0.                                                               
         itab = ibeg(nfile)                                                     
2003     itab = itab+1                                                          
         if (faster.le.toptab(itab)) goto 203                                   
         rate = tmrtab(itab)*ratmul                                             
         acc = acc+rate*(toptab(itab)-toptab(itab-1))                           
         goto 2003                                                              
203      continue                                                               
         rate = tmrtab(itab)*ratmul                                             
         taxng = (acc+rate*(faster-toptab(itab-1)))/sepret                      
         bpng = toptab(itab-1)                                                  
         if(faster.le.0) rate = 0.                                              
         if(taxng.le.0) taxng = 0.                                              
      endif                                                                     
      if(lawyr.ge.2004) then                                                    
c line-by-line calculations for the year 2004                                   
         if(data(138).gt.1.0d0) then                                            
            xl2 = data(176)                                                     
            xl3 = data(138)                                                     
c            xl4 = max(0.0d0,data(176)-data(138))+                              
c     &  max(0.0d0,min(data(70),data(70)+data(68))-data(185))                   
            xl4 = 0                                                             
            xl5 = max(0.0d0,xl3 - xl4)                                          
            xl6 = max(0.0d0,xl2 - xl5)                                          
            xl7 = min(data(70),data(70)+data(68))+data(18)                      
            xl8 = min(xl3,xl4)                                                  
            xl9 = max(0.0d0,xl7-xl8)                                            
c           xl10 = xl6 + xl9                                                    
         else                                                                   
            xl6 = data(176)                                                     
            xl9 = max(0.0d0,ltg - xl6)                                          
c            xl10 = ltg                                                         
         endif                                                                  
         xl10 = xl6 + xl9                                                       
         xl11 = max(0.0d0,data(115)+data(117))                                  
         xl12 = min(xl11,xl9)                                                   
         xl13 = xl10 - xl12                                                     
         xl14 = max(0.0d0,taxinc - xl13)                                        
         xl15 = brac15                                                          
         xl16 = min(xl15,taxinc)                                                
         xl17 = min(xl14,xl16)                                                  
         xl18 = max(0.0d0,taxinc-xl10)                                          
         xl19 = max(xl18,xl17)                                                  
         xl20 = xl16 - xl17                                                     
         sch10 = cgrat1*xl20                                                    
         xl21 = min(taxinc,xl13)                                                
         xl22 = xl20                                                            
         xl23 = max(0.0d0,xl21 - xl22)                                          
         sch20 = cgrate*xl23                                                    
         xl25 = min(xl9,data(115))                                              
         xl26 = xl10 + xl19                                                     
         xl27 = taxinc                                                          
         xl28 = max(0.0d0,xl26 - xl27)                                          
         xl29 = max(0.0d0,xl25 - xl28)                                          
         sch25 = .25*xl29                                                       
         xl31 =  xl19 + xl20 + xl23 + xl29                                      
         xl32 = taxinc - xl31                                                   
         sch28 = .28*xl32                                                       
         taxltg = sch10 + sch20 +sch25 + sch28                                  
         faster = xl19*sepret                                                   
         acc = 0.                                                               
         itab = ibeg(nfile)                                                     
c non-gain taxable income for 2004                                              
1000     itab = itab+1                                                          
         if (faster.le.toptab(itab)) goto 201                                   
         rate = tmrtab(itab)*ratmul                                             
         acc = acc+rate*(toptab(itab)-toptab(itab-1))                           
         goto 1000                                                              
201      continue                                                               
         rate = tmrtab(itab)*ratmul                                             
         taxng = (acc+rate*(faster-toptab(itab-1)))/sepret                      
         bpng = toptab(itab-1)                                                  
         if(faster.le.0) rate = 0.                                              
         if(taxng.le.0) taxng = 0.                                              
      endif                                                                     
      if (min(taxinc,brac15).gt.taxin9) then                                    
           if(taxinc.lt.brac15.and.taxin9.lt.1.) r10 = .1                       
           if(taxinc.gt.brac15.and.taxin9.gt.0.) r10 = -.1                      
      endif                                                                     
      if (min(taxinc,cglong).gt.max(0.0d0,                                      
     &              min(taxinc,brac15)-taxin9)) then                            
            if(min(taxinc,brac15) - taxin9.le.0.) then                          
              if(taxinc.lt.cglong) r20 = cgrate                                 
            else                                                                
              if(taxinc.gt.cglong) then                                         
               if(taxinc.gt.brac15.and.taxin9.gt.0.) r20=cgrate                 
               if(taxinc.lt.brac15.and.taxin9.le.0.) r20=-cgrate                
              else                                                              
               if(taxinc.gt.brac15.and.taxin9.gt.0.) r20=2*cgrate               
               if(taxinc.gt.brac15.and.taxin9.lt.1.) r20=cgrate                 
               if(taxinc.lt.brac15.and.taxin9.gt.0.) r20=cgrate                 
              endif                                                             
            endif                                                               
      endif                                                                     
      rate = max(rate,max(r10,r20))                                             
      addtax = 0.                                                               
      if(lawyr.ge.2013.and.cglong.gt.0) then                                    
        if(nfile.eq.1) then                                                     
          if(lawyr.le.2017) topbrk = toptab(23)                                 
          if(lawyr.eq.2018)topbrk = 425800.d0                                   
          if(lawyr.eq.2019)topbrk = 434550.d0                                   
          if(lawyr.eq.2020)topbrk = 441450.d0                                   
          if(lawyr.eq.2021)topbrk = 445850.d0                                   
          if(lawyr.ge.2022)topbrk = 459650*xndx/xndxa(2022)                     
        else if(nfile.eq.3) then                                                
          if(lawyr.le.2017)topbrk = toptab(15)                                  
          if(lawyr.eq.2018)topbrk = 452400.d0                                   
          if(lawyr.eq.2019)topbrk = 461700.d0                                   
          if(lawyr.eq.2020)topbrk = 469050.d0                                   
          if(lawyr.eq.2021)topbrk = 473750.d0                                   
          if(lawyr.ge.2022)topbrk = 488500*xndx/xndxa(2022)                     
        else                                                                    
          if(lawyr.le.2017)topbrk = toptab(7)/sepret                            
          if(lawyr.eq.2018)topbrk = 479000.d0/sepret                            
          if(lawyr.eq.2019)topbrk = 488850.d0/sepret                            
          if(lawyr.eq.2020)topbrk = 496600.d0/sepret                            
          if(lawyr.eq.2021)topbrk = 501600.d0/sepret                            
          if(lawyr.ge.2022)topbrk = (517200.d0/sepret)*xndx/xndxa(2022)         
        endif                                                                   
        if(taxin9.gt.topbrk) then                                               
           addtax = .05*cglong                                                  
        else if (taxinc.gt.topbrk) then                                         
           addtax = .05*min(taxinc-topbrk,cglong)                               
        endif                                                                   
        taxltg = taxltg + addtax                                                
        if(addtax.gt.0) rate = rate + .05                                       
      endif                                                                     
      if(regtax.le.taxng+taxltg) then                                           
         tax = regtax                                                           
      else                                                                      
         tax = taxng+taxltg                                                     
         bp = bpng                                                              
      endif                                                                     
      if(extnd(66).gt.0) then                                                   
        tax = regtax                                                            
        rate = regrat                                                           
      endif                                                                     
      comnew(96) = regtax-tax                                                   
      comnew(90) = bp                                                           
      comnew(152) = at28                                                        
      return                                                                    
      end                                                                       
c                                                                               
c   ****************************************************************************
c    Estate Tax Imputation = comnew(201)                                        
c   ****************************************************************************
c      combined estate and gift taxes imputed to capital income over            
c      $30,000  only for those 65 and over                                      
c      1985=6.422, 1986=6.658, 1987=7.493, 1988=7.594, 1989=8.745               
c      1990=11.500, 1991=11.138, 1992=11.143, 1993=12.577, 1994=15.225          
c      NOTE this module is calibrated only for actual year data 1985-94         
c                                                                               
      subroutine estate(data,lawyr)                                             
      implicit double precision (A-H,O-Z)                                       
      common /newshr/ comnew(255)                                               
      dimension data(255),factor(1985:1994)                                     
      double precision muni,inter                                               
      data factor /0.18778,0.14226,0.20178,0.19880,0.19890,                     
     *             0.12190,0.11285,0.12272,0.13201,0.15536/                     
c                                                                               
      if (lawyr.lt.1985.or.lawyr.gt.1994) then                                  
         comnew(201) = 0.                                                       
         return                                                                 
      endif                                                                     
      inter = data(14)                                                          
      rent = data(73)                                                           
      royal = data(74)                                                          
      div = data(12)                                                            
      muni = data(41)                                                           
      gains = data(68)+data(70)+data(18)+data(19)                               
      trust = data(77)                                                          
      part = data(75)                                                           
      scorp = data(79)                                                          
      capinc = div+muni+gains+trust+part+scorp+inter+rent+royal                 
      egtax = 0.                                                                
      if (capinc.ge.30000.) egtax = factor(lawyr)*(capinc-30000.)               
      if (data(9).lt.1.) egtax = 0.                                             
      comnew(201) = egtax                                                       
      return                                                                    
      end                                                                       
c                                                                               
c   *******************************************************************         
c    Corporate Tax Imputation  (comnew202 is the imputed CIT)                   
c   *******************************************************************         
c                                                                               
c      based on the Feldstein/Jung algorithm                                    
c      AT THIS TIME, tested only 1985 and 1991                                  
c      x1 to x4 have been recalculated by Dan Feenberg from 1985-1994           
c      x1 (not used) reduction in dividends caused by CIT, per $ of dvds        
c      x2 (not used) reduction in retained earnings per dollar of dvds          
c      x3  additional corporate tax liability per $ of double precision int inc 
c      x4  additional corporate tax liability per $ of dividends and ren        
c      expect (not used) is the avrg inflation rate over the prior 5 yrs        
c      Actual CIT in billions, Fiscal year                                      
c        1985=61.33, 1986=63.14, 1987=83.93, 1988=94.51, 1989=103.3             
c        1990=93.51, 1991=98.09, 1992=100.3, 1993=117.5, 1994=140.4             
c                                                                               
      subroutine cit(data,lawyr)                                                
      implicit double precision (A-H,O-Z)                                       
      common /newshr/ comnew(255)                                               
      common /misc/ inreal,x1,x2                                                
      dimension data(255),x(4,1985:1994)                                        
      dimension expect(1985:1994),rint(1985:1994),pint(1985:1994)               
      double precision inreal,intnet                                            
c                                                                               
c  x1,x2,x3,x4 for 1985 to 1994                                                 
c                                                                               
      data x / 0.491, 0.226, 0.127, 0.605,                                      
     6         0.449, 0.206, 0.150, 0.601,                                      
     7         0.573, 0.394, 0.171, 0.804,                                      
     8         0.571, 0.393, 0.167, 0.830,                                      
     9         0.466, 0.321, 0.149, 0.640,                                      
     *         0.411, 0.283, 0.146, 0.602,                                      
     1         0.350, 0.240, 0.602, 0.338,                                      
     2         0.343, 0.236, 0.117, 0.386,                                      
     3         0.339, 0.233, 0.121, 0.397,                                      
     4         0.397, 0.273, 0.130, 0.436/                                      
      data expect / 5.48, 3.81, 3.32, 3.50, 3.60,                               
     *              3.97, 4.44, 4.31, 4.08, 3.63/                               
      data rint / 6.22, 5.72, 5.89, 6.08, 6.18,                                 
     *              6.24, 5.97, 5.64, 5.34, 5.86/                               
      data pint /12.57,13.34,13.28,13.30,13.42,                                 
     *             13.32,13.17,12.92,12.79,12.77/                               
c                                                                               
      if (lawyr.lt.1985.or.lawyr.gt.1994) then                                  
         comnew(202) = 0.                                                       
         return                                                                 
      endif                                                                     
      recrat = (rint(lawyr)-expect(lawyr))/rint(lawyr)                          
      payrat = (pint(lawyr)-expect(lawyr))/pint(lawyr)                          
      recint = data(14)+data(41)                                                
      payint = data(56)+data(57)                                                
      intnet = recint-payint                                                    
c                                                                               
c   net real interest calculation ala Jun/Feldstein                             
c                                                                               
      recvd = recrat*recint/(.82)                                               
      payed = payrat*payint/(.82)                                               
      inreal = recvd-payed                                                      
c                                                                               
      div = data(12)                                                            
      x1 = x(1,lawyr)                                                           
      x2 = x(2,lawyr)                                                           
      x3 = x(3,lawyr)                                                           
      x4 = x(4,lawyr)                                                           
c                                                                               
c  Retax is picked up from the CEX (data160) for non-itemizers                  
c                                                                               
      retax = data(51)                                                          
      deduc = data(48)+data(49)+data(50)+data(51)+data(52)+                     
     *        data(53)+data(54)+data(55)+data(56)+data(57)+                     
     *        data(58)+data(59)+data(60)+data(61)+data(63)+                     
     *        data(65)+data(66)                                                 
      if (deduc.lt.2000..and.data(51).lt.1.) retax = data(160)                  
      tax3 = x3*div                                                             
      tax4 = x4*(intnet+0.8407*retax)                                           
      citax = tax3+tax4                                                         
      comnew(202) = citax                                                       
c                                                                               
      return                                                                    
      end                                                                       
                                                                                
      subroutine eitcr(data,lawyr,agi,earny,earncr,rtbs)                        
      implicit double precision (A-H,O-Z)                                       
      common /newshr/ comnew(255)                                               
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      common /xndxac/ xndxa(1981:2023)                                          
      common /user/ zbrack(3,1987:2023),exem(1987:2023),                        
     &crmax(1987:2023,0:3,1:2),ymax(1987:2023,0:3,1:2),                         
     1rtbase(1987:2023,0:3), rtless(1987:2023,0:3),                             
     2chmax(1998:2023),ealim(2001:2023),cphas(7)                                
      dimension data(255),dy(1996:2023)                                         
c                                                                               
c    ***************************************************************************
c       EITC   Earned Income Tax Credit Parameters                              
c       crmax :  maximum eitc (adjusted for inflation)                          
c       ymax  :  beginning of eitc phaseout   (2001 levels are 2000 levels      
c       rtbase:  phasein rate = rtbase         adjusted by assumed inflation    
c       rtless:  phaseout rate = rtless        of 2 percent)                    
c    ***************************************************************************
c     (&=zero dependents,  1=one dependent,  2=two plus dependents)             
c                                                                               
      dimension  crmaxa(0:3,1:2),   ymaxa(0:3,1:2)                              
      dimension rtb(1987:2023,0:3), rtl(1987:2023,0:3)                          
      dimension amax(1987:2023,0:3,1:2)                                         
      dimension amaxa(0:3,1:2)                                                  
      dimension amax01(37),amax11(37),amax21(37),amax31(37),                    
     & amax02(37),amax12(37),amax22(37),amax32(37)                              
      double precision modagi                                                   
      equivalence (amax01,amax(1987,0,1))                                       
      equivalence (amax11,amax(1987,1,1))                                       
      equivalence (amax21,amax(1987,2,1))                                       
      equivalence (amax31,amax(1987,3,1))                                       
      equivalence (amax02,amax(1987,0,2))                                       
      equivalence (amax12,amax(1987,1,2))                                       
      equivalence (amax22,amax(1987,2,2))                                       
      equivalence (amax32,amax(1987,3,2))                                       
c                                                                               
      data amax01/                                                              
     &     0.d0,    0.d0,    0.d0,    0.d0,     0.d0,    0.d0,    0.d0,         
     &  9000.d0, 9234.d0, 9677.d0, 9770.d0, 10030.d0,10195.d0,10300.d0,         
     & 10710.d0,11060.d0,11233.d0,11490.d0, 11750.d0,12120.d0,12590.d0,         
     & 12880.d0,13440.d0,13460.d0,13740.d0, 13980.d0,14340.d0,14590.d0,         
     & 14820.d0,14880.d0,15010.d0,15270.d0, 15570.d0,15820.d0,21430.d0,         
     & 2*16480.d0/                                                              
      data amax11/                                                              
     1 15432.d0,18576.d0,19340.d0,20264.d0,21250.d0,22370.d0,23050.d0,          
     1 23755.d0,24396.d0,25078.d0,25750.d0,26473.d0,26928.d0,27413.d0,          
     1 28281.d0,29201.d0,29666.d0,30338.d0,31030.d0,32001.d0,33241.d0,          
     1 33995.d0,35463.d0,35535.d0,36132.d0,36920.d0,37870.d0,38511.d0,          
     1 39131.d0,39296.d0,39617.d0,40320.d0,41094.d0,41756.d0,42158.d0,          
     1 2*43492.d0/                                                              
      data amax21/                                                              
     2 15432.d0,18576.d0,19340.d0,20264.d0,21250.d0,22370.d0,23050.d0,          
     2 25296.d0,26673.d0,28495.d0,29290.d0,30095.d0,30590.d0,31152.d0,          
     2 32121.d0,33178.d0,33692.d0,34458.d0,35263.d0,36348.d0,37783.d0,          
     2 38646.d0,40295.d0,40363.d0,41044.d0,41952.d0,43038.d0,43756.d0,          
     2 44454.d0,44648.d0,45007.d0,45802.d0,46703.d0,47440.d0,47915.d0,          
     2 2*49399.d0/                                                              
      data amax31/                                                              
     3 15432.d0,18576.d0,19340.d0,20264.d0,21250.d0,22370.d0,23050.d0,          
     3 25296.d0,26673.d0,28495.d0,29290.d0,30095.d0,30590.d0,31152.d0,          
     3 32121.d0,33178.d0,33692.d0,34458.d0,35263.d0,36348.d0,37783.d0,          
     3 38646.d0,43279.d0,43352.d0,43998.d0,45060.d0,46227.d0,46997.d0,          
     3 47747.d0,47955.d0,48340.d0,49194.d0,50162.d0,50594.d0,51464.d0,          
     3 2*53059.d0/                                                              
      data amax02/                                                              
     &     0.d0,    0.d0,      0.d0,    0.d0,    0.d0,    0.d0,    0.d0,        
     &  9000.d0, 9234.d0,   9677.d0, 9770.d0,10030.d0,10195.d0,10300.d0,        
     & 10710.d0,12060.d0,  12233.d0,12490.d0,13750.d0,14120.d0,14590.d0,        
     & 15880.d0,18440.d0,2*18470.d0,19190.d0,19680.d0,20020.d0,20330.d0,        
     & 20430.d0,20600.d0,  20950.d0,21370.d0,21710.d0,27380.d0,                 
     & 2*22610.d0/                                                              
      data amax12/                                                              
     1 15432.d0,18576.d0,19340.d0,20264.d0,21250.d0,22370.d0,23050.d0,          
     1 23755.d0,24396.d0,25078.d0,25760.d0,26473.d0,26910.d0,27450.d0,          
     1 28281.d0,30201.d0,30666.d0,31338.d0,33030.d0,34001.d0,35241.d0,          
     1 36995.d0,40463.d0,40545.d0,41132.d0,42130.d0,43210.d0,43941.d0,          
     1 44651.d0,44846.d0,45207.d0,46010.d0,46884.d0,47646.d0,48108.d0,          
     1 2*49622.d0/                                                              
      data amax22/                                                              
     2 15432.d0,18576.d0,19340.d0,20264.d0,21250.d0,22370.d0,23050.d0,          
     2 25296.d0,26673.d0,28495.d0,29290.d0,30095.d0,30590.d0,31152.d0,          
     2 32121.d0,34178.d0,34692.d0,35458.d0,37263.d0,38348.d0,39783.d0,          
     2 41646.d0,45295.d0,45373.d0,46044.d0,47162.d0,48378.d0,49186.d0,          
     2 49974.d0,50198.d0,50597.d0,51492.d0,52493.d0,53330.d0,53865.d0,          
     2 2*55529.d0/                                                              
      data amax32/                                                              
     3 15432.d0,18576.d0,19340.d0,20264.d0,21250.d0,22370.d0,23050.d0,          
     3 25296.d0,26673.d0,28495.d0,29290.d0,30095.d0,30590.d0,31152.d0,          
     3 32121.d0,34178.d0,34692.d0,35458.d0,37263.d0,38348.d0,39783.d0,          
     3 41646.d0,48279.d0,48352.d0,48998.d0,50270.d0,51567.d0,52427.d0,          
     3 53267.d0,53505.d0,53930.d0,54884.d0,55952.d0,56844.d0,57414.d0,          
     3 2*59187.d0/                                                              
       data dy /2200.d0,2250.d0,2300.d0,2350.d0,2400.d0,2450.d0,2550.d0,        
     & 2600.d0,2650.d0,2700.d0,2800.d0,2900.d0,2950.d0,2*3100.d0,               
     & 3150.d0,3200.d0,3300.d0,3350.d0,2*3400.d0,3450.d0,3500.d0,               
     & 3600.d0,3650.d0,3*10000.d0/                                              
      lawend = lawyr                                                            
      if(lawyr.gt.2022) lawend = 2022                                           
c  Marital status and sepret                                                    
      mstat = int(data(2))                                                             
      sepret=1                                                                  
      if(mstat.eq.3.or.mstat.eq.6) sepret=2                                     
c actual normal numbers for EITC                                                
      if(lawyr.le.lawend) then                                                  
         if(lawyr.ge.1996) dylim = dy(lawyr)                                    
         do 997 i=0,3                                                           
         do 996 j=1,2                                                           
          crmaxa(i,j) = crmax(lawyr,i,j)                                        
          ymaxa(i,j) = ymax(lawyr,i,j)                                          
          amaxa (i,j) = amax (lawyr,i,j)                                        
          rtb(lawyr,i) = rtbase(lawyr,i)                                        
          rtl(lawyr,i) = rtless(lawyr,i)                                        
996      continue                                                               
997      continue                                                               
      else                                                                      
         dylim = dy(lawend)*xndxa(lawyr)/xndxa(lawend)                          
         do 999 i=0,3                                                           
         do 998 j=1,2                                                           
          crmaxa(i,j) = crmax(lawend,i,j)*xndxa(lawyr)/xndxa(lawend)            
          ymaxa (i,j) = ymax (lawend,i,j)*xndxa(lawyr)/xndxa(lawend)            
          amaxa (i,j) = amax (lawend,i,j)*xndxa(lawyr)/xndxa(lawend)            
          rtb(lawyr,i) = rtbase(lawyr,i)                                        
          rtl(lawyr,i) = rtless(lawyr,i)                                        
998      continue                                                               
999      continue                                                               
      endif                                                                     
c    EARNED INCOME TAX CREDIT                                                   
c    crmaxa = credit max      ymaxa = beginning of phaseout range               
c    rtbase = credit rate    rtless = phaseout rate                             
c    ieic = 0, 1, or 2 dependents.                                              
c    after 1999, income limits are indexed by 3% but rates are left unchanged   
c    data106 is children at home, data107 is children away from home            
c    AGI and EARNED are limited by amax for eligibility of EIC                  
      earncr = 0.                                                               
c Indicator for EIC Phase-out                                                   
      peic = 0.                                                                 
      reic = 0                                                                  
      am = 0.                                                                   
      ym = 0.                                                                   
      dep = 2.                                                                  
      if(lawyr.ge.2009) dep = 3.                                                
      ieic = int(max(0.0d0,                                                     
     & min(data(8)-data(209),data(8)-data(107)-data(108),dep)))                 
      if(lawyr.ge.1994) ieic = int(min(dep,data(203)))                               
c Number of earners: separate returns and dependent returns -- no EIC.          
      nearn=0                                                                   
      if (data(7).eq.1.and.sepret.eq.1) nearn=1                                 
      if (mstat.eq.2) nearn=2                                                   
      modagi = agi                                                              
      if(comnew(6).lt.0.and.lawyr.le.2002) modagi = modagi - comnew(6)          
      if(comnew(8).lt.0.and.lawyr.le.2002) modagi = modagi - comnew(8)          
      d17 = data(17)+data(211)+data(214)+data(212)+data(215)+data(213)          
      if(lawyr.eq.1997.and.d17.lt.0) modagi = modagi - .5*d17                   
      if(lawyr.gt.1997.and.d17.lt.0.and.lawyr.le.2002)                          
     & modagi = modagi - .75*d17                                                
      if(nearn.eq.0) then                                                       
         earncr = 0.d0                                                          
      else if (nearn.gt.0) then                                                 
c EITC parameters                                                               
         rtbs = rtb(lawyr,ieic)                                                 
         rtlw = rtl(lawyr,ieic)                                                 
         ym = ymaxa(ieic,nearn)                                                 
         crm = crmaxa(ieic,nearn)                                               
         am = amaxa(ieic,nearn)                                                 
c Earned Income for EITC purposes is earny                                      
         if(extnd(89).gt.0) earny = data(98)                                    
         earncr=min(rtbs*earny,crm)                                             
c        write(0,*) '1 fed earncr rtbs earny crm',earncr,rtbs,earny,crm         
         if(earncr.lt.crm.and.max(modagi,earny).lt.ym) then                     
           peic = 1.                                                            
           reic = -rtbs*comnew(91)                                              
         endif                                                                  
                                                                                
         if (modagi.gt.ym.or.earny.gt.ym) then                                  
            eicpo =  rtlw*max(0.0d0,max(modagi,earny)- ym)                      
            earncr= min(earncr,max(0.0d0,crm - eicpo))                          
c        write(0,*) '2 fed earncr',earncr                                       
                                                                                
            if(earncr.gt.0) then                                                
              peic = 1.                                                         
              reic = rtlw*comnew(91)                                            
            endif                                                               
         endif                                                                  
         reic=reic*100                                                          
         if (lawyr.le.1993.and.ieic.eq.0) then                                  
          earncr = 0.                                                           
         else                                                                   
           if (modagi.gt.ym+crm/rtlw.or.earny.gt.ym+crm/rtlw)earncr=0.          
         endif                                                                  
         if ((modagi.gt.am+20.or.earny.gt.am+20).and.earncr.gt.10) then         
c        stop 144                                                               
         endif                                                                  
         if(earncr.le.0) earncr = 0.                                            
                                                                                
         if(lawyr.lt.1994.and.data(8).eq.0) earncr = 0.                         
         if(data(202).lt.0.or.data(197).lt.0.) earncr = 0.                      
         if(data(105).gt.0.and.lawyr.ge.1991) earncr = 0.                       
c Separate returns are not eligible for EIC                                     
c 2021 you may qualify for EITC if filing sepatate                              
         if(sepret.eq.2.and.lawyr.ne.2021) earncr = 0.                          
c Disqualified Income for years 1997+                                           
         if(lawyr.ge.1996) then                                                 
          disqy =  max(0.0d0,comnew(6))+comnew(4)+data(14)+                     
     &    max(0.0d0,data(73))+max(0.0d0,data(74))+max(0.0d0,data(75))+          
     &    max(0.0d0,data(76))+max(0.0d0,data(77))+max(0.0d0,data(78))+          
     &    max(0.0d0,data(79))+max(0.0d0,data(19))                               
          dyeic = 0.                                                            
          if(disqy.gt.dylim) then                                               
c extnd(56) turns off the smoothing of the EIC with respect to property income  
             if(extnd(56).gt.0) then                                            
               earncr = 0.                                                      
             else                                                               
               earncr = max(0.0d0,earncr-(disqy-dylim))                         
             endif                                                              
             dyeic = 1.                                                         
          endif                                                                 
         endif                                                                  
c Childless people over 65 y.o. are not eligible for the EITC                   
c (if joint -- both should be aged )                                            
c 2021: you no longer need to be under age 65 to claim the EIC w/o a qualifying 
         if(data(9).ge.data(7).and.ieic.eq.0.and.lawyr.ne.2021)                 
     &   earncr = 0.                                                            
c extnd(13) is in use for webcalc to turn off the EITC                          
         if(extnd(13).ne.0.0d0) earncr = 0.                                     
c 2020 Maine eic eligibility includes childless people 18-24 y.o.               
         comnew(188) = earncr                                                   
c if agep is reported                                                           
c Childless people younger than 25 y.o. are not eligible for the EITC           
c n205 -- the age of the older taxpayer                                         
c n206 -- the age of the younger taxpayer                                       
         n205 = int(data(205))                                                       
         n206 = int(data(206))                                                       
         if(lawyr.ge.2021) then                                                 
           if(((n205.lt.19.and.n205.gt.0).or.                                   
     &         (n206.lt.19.and.n206.gt.0)).and.ieic.eq.0) earncr = 0            
         else                                                                   
           if(((n205.lt.25.and.n205.gt.0).or.                                   
     &         (n205.gt.65.and.n206.lt.25.and.n206.gt.0))                       
     &         .and.lawyr.ge.1994.and.ieic.eq.0) earncr = 0                     
         endif                                                                  
         comnew(117) = peic                                                     
         comnew(118) = reic                                                     
      endif                                                                     
      bpeic = max(0.0d0,earny-am)                                               
      if(earncr.gt.0) then                                                      
          if(earny.gt.0.and.earny.le.crm/rtbs) then                             
             bpeic = earny                                                      
          else if(earny.gt.crm/rtbs.and.earny.le.ym) then                       
             bpeic = earny - crm/rtbs                                           
          else if(earny.gt.ym.and.earny.le.am) then                             
             bpeic = earny - ym                                                 
          endif                                                                 
      endif                                                                     
      bppeic = comnew(29) - (earny - bpeic)                                     
      comnew(162) = bppeic                                                      
      return                                                                    
      end                                                                       
c                                                                               
c   ****************************************************************************
c    Functions                                                                  
c   ****************************************************************************
c                                                                               
c  phaser returns the phased out amount of amax                                 
c                                                                               
      double precision function phaser(agi,thresh,rpd,crmax)                    
      implicit double precision(A-H,O-Z)                                        
      common /dindiv/ data(255)                                                 
      excess = max(0.d0,agi - thresh)                                           
      reduc = excess*rpd                                                        
      phaser = max(0.d0,crmax - reduc)                                          
      return                                                                    
      end                                                                       
c                                                                               
c  twn returns upper bound, lower bound or actual value ("a")                   
c  if actual value falls between the two bounds                                 
c                                                                               
      double precision function twn(a,amin,amax)                                
      implicit double precision(A-H,O-Z)                                        
      common /dindiv/ data(255)                                                 
      if (amin.gt.amax) then                                                    
        write(6,100) a,amin,amax,data(100),data(6)                                
      continue                                                                  
      endif                                                                     
100   format(' Error in TWN',5G12.5)                                            
      twn = max(amin,min(amax,a))                                               
      return                                                                    
      end                                                                       
c                                                                               
c    this function rounds down to next lowest $50                               
c                                                                               
      double precision function trunc(value,modder)                             
      implicit double precision(A-H,O-Z)                                        
      double precision value,modder                                             
      trunc = value-mod(value,modder)                                           
      return                                                                    
      end                                                                       
c                                                                               
c     This function returns appropriate values based on marital status.         
c     First variable is MARITAL STATUS [data(02]                                
c     Second variable is value for filing as a SINGLE                           
c     Third variable is value for filing JOINTLY                                
c     Fourth variable is value for filing as HEAD of HOUSEHOLD                  
c     Fifth variable is value for filing MARRIED but SEPARATELY                 
c                                                                               
      double precision function filing(mstat,single,joint,hoh,separ)            
      implicit double precision (A-H,O-Z)                                       
      real single,joint,hoh,separ                                               
      integer mstat                                                             
      filing = single                                                           
      if (mstat.eq.2.or.mstat.eq.5) filing = joint                              
      if (mstat.eq.4.or.mstat.eq.7) filing = hoh                                
      if (mstat.eq.3.or.mstat.eq.6) filing = separ                              
      return                                                                    
      end                                                                       
c                                                                               
c     In(lawyr,year1,year2) returns a value of .true. if the year               
c     Contained in LAWYR is between year1 and year2, INCLUSIVE.                 
c     Year1 must be smaller than year2.                                         
c                                                                               
      logical function in(lawyr,year1,year2)                                    
      integer year1,year2,lawyr                                                 
      in = .false.                                                              
      if (lawyr.ge.year1.and.lawyr.le.year2) in = .true.                        
      return                                                                    
      end                                                                       
c                                                                               
c   ****************************************************************************
c    Miscellaneous Subroutines                                                  
c   ****************************************************************************
c                                                                               
c   This subroutine is necessary since V94, the table generator, uses           
c   it to call nlaw, the federal law routine.                                   
c                                                                               
      subroutine newtax(data,lawyr)                                             
      implicit double precision (A-H,O-Z)                                       
      dimension data(255)                                                       
      double precision data                                                     
      call nlaw(data,lawyr)                                                     
      return                                                                    
      end                                                                       
c                                                                               
c   These subroutines prevent error messages in some earlier programs           
c                                                                               
      subroutine behave                                                         
      return                                                                    
      end                                                                       
      subroutine setup                                                          
      return                                                                    
      end                                                                       
      subroutine setage                                                         
      return                                                                    
      end                                                                       
      subroutine lawus                                                          
      return                                                                    
      end                                                                       
c                                                                               
c  Tax table lookups for 1993 and 1994 are done in the main subroutine          
c  Block data containing tax table information                                  
c  Check second block77 and block79                                             
c                                                                               
      block data bl62                                                           
      implicit double precision (A-H,O-Z)                                       
      common /tab62/ toptab(77),tmrtab(77),acctab(78),ibeg(3)                   
      data ibeg /1,26,51/                                                       
      data toptab /0.,2000.,4000.,6000.,8000.,10000.,                           
     &               12000.,14000.,16000.,18000.,20000.,                        
     &               22000.,26000.,32000.,38000.,                               
     &               44000.,50000.,60000.,70000.,80000.,                        
     &               90000.,100000.,150000.,200000.,1.e29,                      
     &        0.,4000.,8000.,12000.,16000.,20000.,24000.,                       
     &               28000.,32000.,36000.,                                      
     &               40000.,44000.,52000.,64000.,76000.,88000.,                 
     &               100000.,120000.,140000.,160000.,180000.,200000.,           
     &               300000.,400000.,1.e29,                                     
     &        0.,2000.,4000.,6000.,8000.,10000.,12000.,                         
     &               14000.,16000.,18000.,20000.,22000.,24000.,                 
     &               28000.,32000.,38000.,44000.,50000.,                        
     &               60000.,70000.,80000.,90000.,                               
     &               100000.,150000.,200000.,                                   
     &               300000.,1.e29/                                             
      data tmrtab  / 0.,.2,.22,.26,.3,                                          
     &                  .34,.38,.43,.47,.5 ,.53,                                
     &              .56,.59,.62,.65,.69,.72,.75,                                
     &              .78,.81,.84,.87,.89,.9 ,.91,                                
     &          0.,.2 ,.22,.26,.3 ,.34,                                         
     &              .38,.43,.47,.5 ,.53,.56,                                    
     &              .59,.62,.65,.69,.72,.75,                                    
     &              .78,.81,.84,.87,.89,.9 ,.91,                                
     &          0.,.2 ,.21,.24,.26,.3 ,                                         
     &              .32,.36,.39,.42,.43,.47,                                    
     &              .49,.52,.54,.58,                                            
     &              .62,.66,.68,.71,.74,.76,                                    
     &              .8 ,.83,.87,.9 ,.91/                                        
      data acctab /0.0,                                                         
     &                0.,400., 840.,1360.,1960.,2640.,                          
     &                  3400.,4260.,5200.,6200.,7260.,                          
     &                  8380.,10740.,14460.,18360.,22500.,                      
     &                  26820.,34320.,42120.,50220.,58620.,67320.,              
     &                  111820.,156820,1.e29,                                   
     &                0.,800.,1680.,2720.,3920.,5280.,6800.,                    
     &                  8520.,10400.,12400.,                                    
     &                 14520.,16760.,21480.,28920.,36720.,45000.,               
     &                 53640.,68640.,84240.,100440.,117240.,134640.,            
     &                 223640.,313640.,1.e29,                                   
     &                0.,400.,820.  ,1300.,1820.,2420.,3060.,                   
     &                  3780.,4560 .,5400.,6260.,7200.,8180.,                   
     &                 10260.,12420.,15900.,19620.,23580.,                      
     &                 30380.,37480.,44880.,52480.,                             
     &                 60480.,101980.,145480.,                                  
     &                 235480.,1.e29/                                           
      end                                                                       
c                                                                               
      block data bl64                                                           
      implicit double precision (A-H,O-Z)                                       
      common /tab64/ toptab(91),tmrtab(91),acctab(92),ibeg(3)                   
      data ibeg /1,28,55/                                                       
      data toptab  /0.,500.,1000.,1500.,2000.,4000.,                            
     &                6000.,8000.,10000.,12000.,14000.,                         
     &                16000.,18000.,20000.,22000.,26000.,32000.,                
     &                38000.,44000.,50000.,60000.,70000.,80000.,                
     &                90000.,100000.,200000.,1.e29,                             
     &              0.,1000.,2000.,3000.,4000.,8000.,12000.,                    
     &               16000.,20000.,24000.,28000.,32000.,36000.,                 
     &               40000.,44000.,52000.,64000.,76000.,88000.,                 
     &               100000.,120000.,140000.,160000.,180000.,200000.,           
     &               400000.,1.e29,                                             
     &              0.,1000.,2000.,4000.,6000.,8000.,10000.,12000.,             
     &               14000.,16000.,18000.,20000.,22000.,24000.,26000.,          
     &               28000.,32000.,36000.,38000.,40000.,44000.,50000.,          
     &               52000.,60000.,64000.,70000.,76000.,80000.,88000.,          
     &               90000.,100000.,120000.,140000.,160000.,180000.,            
     &               200000.,1.e29/                                             
      data tmrtab /0.,.16,.165,.175,.18,.2,.235,.27,.305,                       
     &                 .34,.375,.41, .445,.475,.505,                            
     &                .535,.56,.585,.61,.635,.66,.685,.71,                      
     &                .735,.75,.765,.77,                                        
     &              0.,.16,.165,.175,.18,.2,.235,.27,.305,.34,                  
     &                .375,.41,.445,.475,.505,.535,.56,                         
     &                .585,.61,.635,.66,.685,.71,.735,.75,                      
     &                .765,.77,                                                 
     &              0.,.16,.175,.19,.22,.23,.27,.29,                            
     &                .32,.34,.375,.39,.425,.435,.455,.47,                      
     &                .485,.515,.53,.54,.56,.585,.595,                          
     &                .61,.62,.635,.65,.66,.67,.69,.695,                        
     &                .71,.725,.74,.75,.755,.77/                                
                                                                                
      data acctab /0.0,                                                         
     &                0.,80., 162.5,250.,340.,740.,                             
     &                  1210.,1750.,2360.,3040.,3790.,                          
     &                  4610.,5500.,6450.,7460.,9600.,                          
     &                  12960.,16470.,20130.,23940.,30540.,37390.,              
     &                  44490.,51840,59340.,135840.,1.e29,                      
     &                0.,160.,325.,500.,680.,1480.,2420.,                       
     &                  3500.,4720.,6080.,7580.,9220.,                          
     &                 11000.,12900.,14920.,19200.,25920.,32940.,               
     &                 40260.,47880.,61080.,74780.,88980.,103680.,              
     &                 118680.,271680.,1.e29,                                   
     &                0.,160.,335.,715.,1155.,1615.,2155.,                      
     &                  2735.,3375.,4055.,4805.,5585.,6435.,                    
     &                  7305.,8215.,9155.,11095.,13155.,14215.,                 
     &                 15295.,17535.,21045.,22235.,                             
     &                 27115.,29595.,33405.,37305.,39945.,45305.,               
     &                 46685.,53635.,67835.,82335.,97135.,112135.,              
     &                 127235.,1.e29/                                           
      end                                                                       
                                                                                
c                                                                               
      block data bl70                                                           
      implicit double precision (A-H,O-Z)                                       
      common /tab70/ toptab(86),tmrtab(86),acctab(87),ibeg(3)                   
      data ibeg /1,27,53/                                                       
      data toptab  /0.,500.,1000.,1500.,2000.,                                  
     &                4000.,6000.,8000.,10000.,12000.,14000.,16000.,            
     &               18000.,20000.,22000.,                                      
     &               26000.,32000.,38000.,44000.,50000.,                        
     &               60000.,70000.,80000.,90000.,100000.,1.e29,                 
     &          0.,1000.,2000.,3000.,4000.,8000.,12000.,16000.,20000.,          
     &               24000.,28000.,32000.,36000.,40000.,44000.,52000.,          
     &               64000.,76000.,88000.,100000.,120000.,140000.,              
     &               160000.,180000.,200000.,1.e29,                             
     &          0.,1000.,2000.,4000.,6000.,8000.,10000.,12000.,14000.,          
     &                16000.,18000.,20000.,22000.,24000.,26000.,                
     &               28000.,32000.,36000.,38000.,40000.,44000.,                 
     &               50000.,52000.,64000.,70000.,76000.,80000.,                 
     &               88000.,100000.,120000.,140000.,160000.,180000.,            
     &               1.e29/                                                     
      data tmrtab /0.,.14,.15,.16,.17,.19,.22,.25,.28,.32,                      
     &                .36,.39,.42,.45,.48,.5,.53,.55,                           
     &                .58,.6,.62,.64,.66,.68,.69,.7,                            
     &             0.,.14,.15,.16,.17,.19,.22,.25,.28,.32,.36,                  
     &                .39,.42,.45,.48,.5,.53,.55,.58,.6,                        
     &                .62,.64,.66,.68,.69,.7,                                   
     &             0.,.14,.16,.18,.2,.22,.25,.27,                               
     &                .31,.32,.35,.36,.4,.41,.43,.45,                           
     &                .46,.48,.5,.52,.53,.55,.56,.58,.59,.61,                   
     &                .62,.63,.64,.66,.67,.68,.69,.7/                           
                                                                                
      data acctab /0.0,                                                         
     &                0.,70., 145.,225.,310.,690.,                              
     &                  1130.,1630.,2190.,2830.,3550.,                          
     &                  4330.,5170.,6070.,7030.,9030.,                          
     &                 12210.,15510.,18990.,22590.,28790.,35190.,               
     &                 41790.,48590.,55490.,1.e29,                              
     &                0.,140.,290.,450.,620.,1380.,2260.,                       
     &                  3260.,4380.,5660.,7100.,8660.,                          
     &                 10340.,12140.,14060.,18060.,24420.,31020.,               
     &                 37980.,45180.,57580.,70380.,83580.,97180.,               
     &                 110980.,1.e29,                                           
     &                0.,140.,300.,660.,1060.,1500.,2000.,                      
     &                  2540.,3160.,3800.,4500.,5220.,6020.,                    
     &                  6840.,7700.,8600.,10440.,12360.,13360.,                 
     &                 14400.,16520.,19820.,20940.,                             
     &                 27900.,31440.,35100.,37580.,42620.,50300.,               
     &                 63500.,76900.,90500.,104300.,                            
     &                 1.e29/                                                   
      end                                                                       
c                                                                               
      block data bl74                                                           
      implicit double precision (A-H,O-Z)                                       
      common /tab74/ toptab(86),tmrtab(86),acctab(87),ibeg(3)                   
      data ibeg /1,27,53/                                                       
      data toptab  /0.,500.,1000.,1500.,2000.,                                  
     &                4000.,6000.,8000.,10000.,12000.,14000.,16000.,            
     &               18000.,20000.,22000.,                                      
     &               26000.,32000.,38000.,44000.,50000.,                        
     &               60000.,70000.,80000.,90000.,100000.,1.e29,                 
     &            0.,1000.,2000.,3000.,4000.,8000.,12000.,16000.,20000.,        
     &               24000.,28000.,32000.,36000.,40000.,44000.,52000.,          
     &               64000.,76000.,88000.,100000.,120000.,140000.,              
     &               160000.,180000.,200000.,1.e29,                             
     &            0.,1000.,2000.,4000.,6000.,8000.,10000.,12000.,14000.,        
     &                16000.,18000.,20000.,22000.,24000.,26000.,                
     &               28000.,32000.,36000.,38000.,40000.,44000.,                 
     &               50000.,52000.,64000.,70000.,76000.,80000.,                 
     &               88000.,100000.,120000.,140000.,160000.,180000.,            
     &               1.e29/                                                     
      data tmrtab /0.,.14,.15,.16,.17,.19,.21,.24,.25,.27,                      
     &                 .29,.31,.34,.36,.38,.4,.45,.5,                           
     &                 .55,.6,.62,.64,.66,.68,.69,.7,                           
     &           0.,.14,.15,.16,.17,.19,.22,.25,.28,.32,.36,                    
     &                .39,.42,.45,.48,.5,.53,.55,.58,.6,                        
     &                .62,.64,.66,.68,.69,.7,                                   
     &           0.,.14,.16,.18,.19,.22,.23,.25,.27,.28,                        
     &              .31,.32,.35,.36,.38,.41,.42,.45,.48,                        
     &              .51,.52,.55,.56,.58,.59,.61,.62,.63,.64,                    
     &              .66,.67,.68,.69,.7/                                         
      data acctab /0.0,                                                         
     &                0.,70., 145.,225.,310.,690.,                              
     &                  1110.,1590.,2090.,2630.,3210.,                          
     &                  3830.,4510.,5230.,5990.,7590.,                          
     &                 10290.,13290.,16590.,20190.,26390.,32790.,               
     &                 39390.,46190.,53090.,1.e29,                              
     &                0.,140.,290.,450.,620.,1380.,2260.,                       
     &                  3260.,4380.,5660.,7100.,8660.,                          
     &                 10340.,12140.,14060.,18060.,24420.,31020.,               
     &                 37980.,45180.,57580.,70380.,83580.,97180.,               
     &                 110980.,1.e29,                                           
     &                0.,140.,300.,660.,1040.,1480.,1940.,                      
     &                  2440.,2980.,3540.,4160.,4800.,5500.,                    
     &                  6220.,6980.,7800.,9480.,11280.,12240.,                  
     &                 13260.,15340.,18640.,19760.,                             
     &                 26720.,30260.,33920.,36400.,41440.,49120.,               
     &                 62320.,75720.,89320.,103120.,                            
     &                 1.e29/                                                   
c                                                                               
      end                                                                       
c                                                                               
      block data bloc77                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab77/ ibeg(3),iend(3),toptab(83),tmrtab(83),acctab(83)           
      data ibeg /1,26,51/                                                       
      data iend /25,50,83/                                                      
      data toptab /500.,1000.,1500.,2000.,4000.,6000.,8000.,                    
     &               10000.,12000.,14000.,16000.,18000.,20000.,                 
     &               22000.,26000.,32000.,38000.,44000.,50000.,                 
     &               60000.,70000.,80000.,90000.,100000.,1.e29,                 
     &               1000.,2000.,3000.,4000.,8000.,12000.,16000.,               
     &               20000.,24000.,28000.,32000.,36000.,40000.,                 
     &               44000.,52000.,64000.,76000.,88000.,100000.,                
     &               120000.,140000.,160000.,180000.,200000.,                   
     &               1.e29,1000.,2000.,4000.,6000.,8000.,10000.,                
     &               12000.,14000.,16000.,18000.,20000.,22000.,                 
     &               24000.,26000.,28000.,32000.,36000.,38000.,                 
     &               40000.,44000.,50000.,52000.,64000.,70000.,                 
     &               76000.,80000.,88000.,100000.,120000.,                      
     &               140000.,160000.,180000.,1.e29/                             
      data tmrtab/0.14,0.15,0.16,0.17,0.19,0.21,0.24,0.25,0.27,0.29,            
     *0.31,0.34,0.36,0.38,0.40,0.45,0.50,0.55,0.60,0.62,0.64,0.66,0.68,         
     *0.69,0.70,                                                                
     *0.14,0.15,0.16,0.17,0.19,0.22,0.25,0.28,0.32,0.36,0.39,0.42,0.45,         
     *0.48,0.50,0.53,0.55,0.58,0.60,0.62,0.64,0.66,0.68,0.69,0.70,              
     *0.14,0.16,0.18,0.19,0.22,0.23,0.25,0.27,0.28,0.31,0.32,0.35,0.36,         
     *0.38,0.41,0.42,0.45,0.48,0.51,0.52,0.55,0.56,0.58,0.59,0.61,0.62,         
     *0.63,0.64,0.66,0.67,0.68,0.69,0.70/                                       
      data acctab/0.,70.,145.,225.,310.,690.,1110.,1590.,2090.,2630.,           
     *3210.,3830.,4510.,5230.,5990.,7590.,10290.,13290.,16590.,20190.,          
     *26390.,32790.,39390.,46190.,53090.,                                       
     *0.,140.,290.,450.,620.,1380.,2260.,3260.,4380.,5660.,7100.,8660.,         
     *10340.,12140.,14060.,18060.,24420.,31020.,37980.,45180.,57580.,           
     *70380.,83580.,97180.,110980.,                                             
     *0.,140.,300.,660.,1040.,1480.,1940.,2440.,2980.,3540.,4160.,4800.,        
     *5500.,6220.,6980.,7800.,9480.,11280.,12240.,13260.,15340.,18640.,         
     *19760.,26720.,30260.,33920.,36400.,41440.,49120.,62320.,75720.,           
     *89320.,103120./                                                           
c                                                                               
      end                                                                       
c                                                                               
      block data bloc79                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab79/ toptab(52),tmrtab(52),acctab(53),ibeg(3)                   
      data ibeg /35,1,18/                                                       
      data toptab /                                                             
     1 .0,3400.,5500.,7600.,11900.,16000.,20200.,24600.,29900.,35200.,          
     2 45800.,60000.,85600.,109400.,162400.,215400.,1.e29,                      
     3 .0,2300.,4400.,6500.,8700.,11800.,15000.,18200.,23500.,                  
     4 28800.,34100.,44700.,60600.,81800.,108300.,161300.,1.e29,                
     5 .0,2300.,3400.,4400.,6500.,8500.,10800.,12900.,15000.,18200.,            
     6 23500.,28800.,34100.,41500.,55300.,81800.,108300.,1.e29/                 
      data tmrtab   /                                                           
     1 2*0.,.14,.16,.18,.21,.24,.28,.32,.37,.43,.49,.54,.59,.64,.68,.7,         
     2 2*.0,.14,.16,.18,.22,.24,.26,.31,.36,.42,.46,.54,.59,.63,.68,.70,        
     3 2*0.,.14,.16,.18,.19,.21,.24,.26,.30,.34,.39,.44,.49,.55,.63,            
     4 .68,.70/                                                                 
      data acctab   /0.0,                                                       
     1 2*0.,294.,630.,1404.,2265.,3273.,4505.,6201.,8162.,12720.,               
     2 19678.,33502.,47544.,81464.,117504.,999.e29,                             
     3 2*0.,294.,630.,1026.,1708.,2476.,3308.,4951.,6859.,9085.,13961.,         
     4 22547.,35055.,51750.,87790.,999.e29 ,                                    
     5 2*0.,154.,314.,692.,1072.,1555.,2059.,2605.,3565.,5367.,                 
     6 7434.,9766.,13392.,20982.,37677.,55697.,999.e29/                         
c                                                                               
      end                                                                       
c                                                                               
      block data bl77                                                           
      implicit double precision (A-H,O-Z)                                       
      common /l6077/ toptab(89),tmrtab(89),acctab(90),ibeg(3)                   
      data ibeg /1,28,55/                                                       
      data toptab /0.,2200.,2700.,3200.,3700.,                                  
     &                4200.,6200.,8200.,10200.,12200.,14200.,16200.,            
     &               18200.,20200.,22200.,                                      
     &               24200.,28200.,34200.,40200.,46200.,                        
     &               52200.,62200.,72200.,82200.,92200.,                        
     &               102200,1.e29,                                              
     &          0.,3200.,4200.,5200.,6200.,7200.,11200.,15200.,19200.,          
     &               23200.,27200.,31200.,35200.,39200.,43200.,47200.,          
     &               55200.,67200.,79200.,91200.,103200.,123200.,               
     &               143200.,163200.,183200.,203200.,1.e29,                     
     &          0.,2200.,3200.,4200.,6200.,8200.,10200.,12200.,14200.,          
     &                16200.,18200.,20200.,22200.,24200.,26200.,                
     &               28200.,30200.,34200.,38200.,40200.,                        
     &               42200.,46200.,52200.,54200.,66200.,72200.,                 
     &               78200.,82200.,90200.,102200.,122200.,142200.,              
     &               162200.,182200.,1.e29/                                     
      data tmrtab /2*0.,.14,.15,.16,.17,.19,.21,.24,.25,.27,                    
     &                .29,.31,.34,.36,.38,.4,.45,.5,                            
     &                .55,.6,.62,.64,.66,.68,.69,.7,                            
     &              2*0.,.14,.15,.16,.17,.19,.22,.25,.28,.32,.36,               
     &                .39,.42,.45,.48,.5,.53,.55,.58,.6,                        
     &                .62,.64,.66,.68,.69,.7,                                   
     &              2*0.,.14,.16,.18,.19,.22,.23,.25,.27,.28,                   
     &                   .31,.32,.35,.36,.38,.41,.42,.45,.48,                   
     &                  .51,.52,.55,.56,.58,.59,.61,.62,.63,.64,                
     &                  .66,.67,.68,.69,.7/                                     
      data acctab /0.0,                                                         
     &               2*0.,70., 145.,225.,310.,690.,                             
     &                  1110.,1590.,2090.,2630.,3210.,                          
     &                  3830.,4510.,5230.,5990.,7590.,                          
     &                 10290.,13290.,16590.,20190.,26390.,32790.,               
     &                 39390.,46190.,53090.,1.e29,                              
     &               2*0.,140.,290.,450.,620.,1380.,2260.,                      
     &                  3260.,4380.,5660.,7100.,8660.,                          
     &                 10340.,12140.,14060.,18060.,24420.,31020.,               
     &                 37980.,45180.,57580.,70380.,83580.,97180.,               
     &                 110980.,1.e29,                                           
     &               2*0.,140.,300.,660.,1040.,1480.,1940.,                     
     &                  2440.,2980.,3540.,4160.,4800.,5500.,                    
     &                  6220.,6980.,7800.,9480.,11280.,12240.,                  
     &                 13260.,15340.,18640.,19760.,                             
     &                 26720.,30260.,33920.,36400.,41440.,49120.,               
     &                 62320.,75720.,89320.,103120.,                            
     &                 1.e29/                                                   
c                                                                               
      end                                                                       
c                                                                               
      block data bl79                                                           
      implicit double precision (A-H,O-Z)                                       
      common /l6079/ toptab(52),tmrtab(52),acctab(53),ibeg(3)                   
      data ibeg /1,19,36/                                                       
      data toptab /0.,2300.,3400.,4400.,6500.,8500.,                            
     &                10800.,12900.,15000.,18200.,23500.,                       
     &                28800.,34100.,41500.,55300.,81800.,108300.,               
     &               1.e29,                                                     
     &             0.,3400.,5500.,7600.,11900.,16000.,20200.,                   
     &               24600.,29900.,35200.,45800.,60000.,85600.,                 
     &               109400.,162400.,215400.,1.e29,                             
     &             0.,2300.,4400.,6500.,8700.,11800.,15000.,18200.,             
     &              23500.,28800.,34100.,44700.,                                
     &               60600.,81800.,108300.,161300.,1.e29/                       
      data tmrtab /2*0.,.14,.16,.18,.19,.21,.24,.26,                            
     &                .30,.34,.39,.44,.49,.55,                                  
     &                .63,.68,.7,                                               
     &              2*0.,.14,.16,.18,.21,.24,.28,.32,.37,                       
     &                .43,.49,.54,.59,.64,.68,.7,                               
     &              2*0.,.14,.16,.18,.22,.24,.26,                               
     &                .31,.36,.42,.46, .54,.59,.63,.68,.7/                      
      data acctab /0.0,                                                         
     &               2*0.,154., 314.,692.,1072.,1555.,                          
     &                   2059.,2605.,3565.,5367.,7434.,                         
     &                   9766.,13392.,20982.,37677.,55697., 1.e29,              
     &               2*0.,294.,630.,1404.,2265.,3273.,4505.,                    
     &                   6201.,8162.,12720.,19678.,33502.,                      
     &                   47544.,81464.,117504., 1.e29,                          
     &               2*0.,294.,630.,1026.,1708.,2476.,3308.,                    
     &                   4951.,6859.,9085.,13961.,22547.,35055.,                
     &                  51750.,87790., 1.e29/                                   
c                                                                               
      end                                                                       
c                                                                               
      block data bloc82                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab82/  toptab(43),tmrtab(43),acctab(44),ibeg(3)                  
      data ibeg /29,1,15/                                                       
      data toptab /                                                             
     1 .0,3400.,5500.,7600.,11900.,16000.,20200.,24600.,29900.,35200.,          
     2 45800.,60000.,85600.,1.e29,                                              
     3 .0,2300.,4400.,6500.,8700.,11800.,15000.,18200.,23500.,                  
     4 28800.,34100.,44700.,60600.,1.e29,                                       
     5 .0,2300.,3400.,4400.,6500.,8500.,10800.,12900.,15000.,18200.,            
     6 23500.,28800.,34100.,41500.,1.e29/                                       
      data tmrtab   /                                                           
     1 2*0.,.12,.14,.16,.19,.22,.25,.29,.33,.39,.44,.49,.50,                    
     2 2*0.,.12,.14,.16,.20,.22,.23,.28,.32,.38,.41,.49,.50,                    
     3 2*0.,.12,.14,.16,.17,.19,.22,.23,.27,.31,.35,.40,.44,.50/                
      data acctab   /0.0,                                                       
     1 2*0.,252.,546.,1234.,2013.,2937.,4037.,5574.,7323.,11457.,17705.,        
     2 30249.,999.e29,                                                          
     3 2*0.,252.,546.,898.,1518.,2222.,2958.,4442.,6138.,8152.,12498.,          
     4 20289.,999.e29,                                                          
     5 2*0.,132.,272.,608.,948.,1385.,1847.,2330.,3194.,4837.,6692.,            
     6 8812.,12068.,999.e29/                                                    
c                                                                               
      end                                                                       
c                                                                               
      block data bloc83                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab83/ toptab(46),tmrtab(46),acctab(47),ibeg(3)                   
      data ibeg /31,1,16/                                                       
      data toptab /                                                             
     1 .0,3400.,5500.,7600.,11900.,16000.,20200.,24600.,29900.,35200.,          
     2 45800.,60000.,85600.,109400.,.999e29,                                    
     3 .0,2300.,4400.,6500.,8700.,11800.,15000.,18200.,23500.,                  
     4 28800.,34100.,44700.,60600.,81800.,999.e29,                              
     5 .0,2300.,3400.,4400.,6500.,8500.,10800.,12900.,15000.,18200.,            
     6 23500.,28800.,34100.,41500.,55300.,999.e29/                              
      data tmrtab /                                                             
     1 2*0.,.11,.13,.15,.17,.19,.23,.26,.30,.35,.40,.44,.48,.5,                 
     2 2*0.,.11,.13,.15,.18,.19,.21,.25,.29,.34,.37,.44,.48,.50,                
     3 2*0.,.11,.13,.15,.15,.17,.19,.21,.24,.28,.32,.36,.40,.45,.50/            
      data acctab /0.0,                                                         
     1 2*0.,231.,504.,1149.,1846.,2644.,3656.,5034.,6624.,10334.,16014.,        
     2 27278.,38702.,999.e29,                                                   
     3 2*0.,231.,504.,834.,1392.,2000.,2672.,3997.,5534.,7336.,11258.,          
     4 18254.,28430.,999.e29,                                                   
     5 2*0.,121.,251.,566.,866.,1257.,1656.,2097.,2865.,4349.,6045.,            
     6 7953.,10913.,17123.,999.e29/                                             
c                                                                               
      end                                                                       
c                                                                               
      block data bloc84                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab84/ toptab(49),tmrtab(49),acctab(50),ibeg(3)                   
      data ibeg /33,1,17/                                                       
      data toptab /                                                             
     1 .0,3400.,5500.,7600.,11900.,16000.,20200.,24600.,29900.,35200.,          
     2 45800.,60000.,85600.,109400.,162400.,1.e29,                              
     3 .0,2300.,4400.,6500.,8700.,11800.,15000.,18200.,23500.,                  
     4 28800.,34100.,44700.,60600.,81800.,108300.,1.e29,                        
     5 .0,2300.,3400.,4400.,6500.,8500.,10800.,12900.,15000.,18200.,            
     6 23500.,28800.,34100.,41500.,55300.,81800.,1.e29/                         
      data tmrtab   /                                                           
     1 2*0.d0,.11d0,.12d0,.14d0,.16d0,.18,.22,.25,.28,.33,.38,.42,.45,          
     $ 0.49,0.50,                                                               
     2 2*0.,.11,.12,.14,.17,.18,.20,.24,.28,.32,.35,.42,.45,                    
     $ 0.48,0.50,                                                               
     3 2*0.,.11,.12,.14,.15,.16,.18,.20,.23,.26,.30,.34,.38,.42,                
     $ 0.48,0.50/                                                               
      data acctab   /0.0,                                                       
     1 2*0.,231.,483.,1085.,1741.,2497.,3465.,4790.,6274.,9772.,15168.,         
     2 25920.,36630.,62600.,1.e29,                                              
     3 2*0.,231.,483.,791.,1318.,1894.,2534.,3806.,5290.,6986.,10696.,          
     4 17374.,26914.,39634.,1.e29,                                              
     5 2*0.,121.,241.,535.,835.,1203.,1581.,2001.,2737.,4115.,5705.,            
     6 7507.,10319.,16115.,28835.,1.e29/                                        
c                                                                               
      end                                                                       
c                                                                               
      block data bloc87                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab87/ toptab(18),tmrtab(18),acctab(19),ibeg(3)                   
      data ibeg /13,1,7/                                                        
      data toptab /                                                             
     1 0.,3000.,28000.,45000.,90000.,1.e29,                                     
     3 0.,2500.,23000.,38000.,80000.,1.e29,                                     
     5 0.,1800.,16800.,27000.,54000.,1.e29/                                     
      data tmrtab /                                                             
     1 0.d0,.11d0,.15d0,.28d0,.35d0,.385d0,                                     
     2 0.d0,.11d0,.15d0,.28d0,.35d0,.385d0,                                     
     3 0.d0,.11d0,.15d0,.28d0,.35d0,.385d0/                                     
      data acctab /0.0,                                                         
     1 0.,330,4080.,8840.,24590.,1.e29,                                         
     3 0.,275,3350.,7550.,22250.,1.e29,                                         
     5 0.,198,2448.,5304.,14754.,1.e29/                                         
c                                                                               
      end                                                                       
c                                                                               
      block data bloc88                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab88/ toptab(9),tmrtab(9),acctab(10),ibeg(3)                     
      data ibeg /7,1,4/                                                         
      data toptab /                                                             
     1 0.,29750.,1.e29,                                                         
     3 0.,23900.,1.e29,                                                         
     5 0.,17850.,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.15d0,.28d0,                                                        
     2 0.d0,.15d0,.28d0,                                                        
     3 0.d0,.15d0,.28d0/                                                        
      data acctab /0.0,                                                         
     1 0.,4462.5,1.e29,                                                         
     3 0.,3585.,1.e29,                                                          
     5 0.,2677.5,1.e29/                                                         
c                                                                               
      end                                                                       
c                                                                               
      block data bloc91                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab91/  toptab(12),tmrtab(12),acctab(13),ibeg(3)                  
      data ibeg /9,1,5/                                                         
      data toptab /                                                             
     1 0.,34000.,82150.,1.e29,                                                  
     2 0.,27300.,70450.,1.e29,                                                  
     3 0.,20350.,49300.,1.e29/                                                  
      data tmrtab   /                                                           
     1 0.,.15d0,.28d0,.31d0,                                                    
     2 0.,.15d0,.28d0,.31d0,                                                    
     3 0.,.15d0,.28d0,.31d0/                                                    
      data acctab   /0.0,                                                       
     1 0.,5100,18582,1.e29,                                                     
     2 0.,4095.,16177,1.e29,                                                    
     3 0.,3052.5,11158.5,1.e29/                                                 
c                                                                               
      end                                                                       
c                                                                               
c     Tax table lookup Clinton 17 Feb 1993 plan                                 
c     This table is used only for 1993, because some brackets are               
c     indexed and some are not.                                                 
c                                                                               
      block data bloc93                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab93/ toptab(18),tmrtab(18),acctab(19),ibeg(3)                   
      data ibeg /13,1,7/                                                        
      data toptab  /                                                            
     1 0.,36900.,89150.,140000.,250000.,1.e29,                                  
     2 0.,29600.,76400.,127500.,250000.,1.e29,                                  
     3 0.,22100.,53500.,115000.,250000.,1.e29/                                  
      data tmrtab /                                                             
     1 0.,.15d0,.28d0,.31d0,.36d0,.396d0,                                       
     2 0.,.15d0,.28d0,.31d0,.36d0,.396d0,                                       
     3 0.,.15d0,.28d0,.31d0,.36d0,.396d0/                                       
      data acctab /0.0,                                                         
     1 0.,5100.,18582.,32775.,68962.,1.e29,                                     
     2 0.,4095.,16177.,26914.,71326.,1.e29,                                     
     3 0.,3052.5,11158.5,19670.,74280.,1.e29/                                   
c                                                                               
      end                                                                       
c                                                                               
      block data bloc94                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab94/ toptab(18),tmrtab(18),ibeg(3)                              
      data ibeg /13,1,7/                                                        
      data toptab /                                                             
     1 0.,38000.,91850.,140000.,250000.,1.e29,                                  
     2 0.,30500.,78700.,127500.,250000.,1.e29,                                  
     3 0.,22750.,55100.,115000.,250000.,1.e29/                                  
      data tmrtab /                                                             
     1 0.,.15d0,.28d0,.31d0,.36d0,.396d0,                                       
     2 0.,.15d0,.28d0,.31d0,.36d0,.396d0,                                       
     3 0.,.15d0,.28d0,.31d0,.36d0,.396d0/                                       
      end                                                                       
c                                                                               
      block data bloc95                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab95/ toptab(18),tmrtab(18),ibeg(3)                              
      data ibeg /13,1,7/                                                        
      data toptab /                                                             
     1 0.,39000.,94250.,143600.,256500.,1.e29,                                  
     2 0.,31250.,80750.,130800.,256500.,1.e29,                                  
     3 0.,23350.,56550.,117950.,256500.,1.e29/                                  
      data tmrtab /                                                             
     1 0.,.15d0,.28d0,.31d0,.36d0,.396d0,                                       
     2 0.,.15d0,.28d0,.31d0,.36d0,.396d0,                                       
     3 0.,.15d0,.28d0,.31d0,.36d0,.396d0/                                       
      end                                                                       
c                                                                               
      block data bloc96                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab96/ toptab(18),tmrtab(18),ibeg(3)                              
      data ibeg /13,1,7/                                                        
      data toptab /                                                             
     1 0.,40100.,96900.,147700.,263750.,1.e29,                                  
     2 0.,32150.,83050.,134500.,263750.,1.e29,                                  
     3 0.,24000.,58150.,121300.,263750.,1.e29/                                  
      data tmrtab /                                                             
     1 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     2 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     3 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0/                                     
      end                                                                       
c                                                                               
c  tax brackets for 1997                                                        
c                                                                               
      block data bloc97                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab97/ toptab(18),tmrtab(18),ibeg(3)                              
      data ibeg /13,1,7/                                                        
      data toptab /                                                             
     1 0.,41200.,99600.,151750.,271050.,1.e29,                                  
     2 0.,33050.,85350.,138200.,271050.,1.e29,                                  
     3 0.,24650.,59750.,124650.,271050.,1.e29/                                  
      data tmrtab /                                                             
     1 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     2 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     3 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0/                                     
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets for 1998                                                        
c                                                                               
      block data bloc98                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab98/ toptab(18),tmrtab(18),ibeg(3)                              
      data ibeg /13,1,7/                                                        
      data toptab /                                                             
     1 0.,42350.,102300.,155950.,278450.,1.e29,                                 
     2 0.,33950., 87700.,142000.,278450.,1.e29,                                 
     3 0.,25350., 61400.,128100.,278450.,1.e29/                                 
      data tmrtab /                                                             
     1 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     2 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     3 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0/                                     
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets for 1999                                                        
c                                                                               
      block data bloc99                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab99/ toptab(18),tmrtab(18),ibeg(3)                              
      data ibeg /13,1,7/                                                        
      data toptab /                                                             
     1 0.,43050.,104050.,158550.,283150.,1.e29,                                 
     2 0.,34550., 89150.,144400.,283150.,1.e29,                                 
     3 0.,25750., 62450.,130250.,283150.,1.e29/                                 
      data tmrtab /                                                             
     1 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     2 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     3 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0/                                     
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets for 2000                                                        
c                                                                               
      block data bloc00                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab00/ toptab(18),tmrtab(18),ibeg(3)                              
      data ibeg /13,1,7/                                                        
      data toptab /                                                             
     1 0.,43850.,105950.,161450.,288350.,1.e29,                                 
     2 0.,35150., 90800.,147050.,288350.,1.e29,                                 
     3 0.,26250., 63550.,132600.,288350.,1.e29/                                 
      data tmrtab /                                                             
     1 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     2 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0,                                     
     3 0.d0,.15d0,.28d0,.31d0,.36d0,.396d0/                                     
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2001                                                            
c                                                                               
      block data bloc01                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab01/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.,12000.,45200.,109250.,166500.,297350.,1.e29,                          
     2 0.,10000.,36250., 93650.,151650.,297350.,1.e29,                          
     3 0., 6000.,27050., 65550.,136750.,297350.,1.e29/                          
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.275d0,.305d0,.355d0,.391d0,                            
     2 0.d0,.10d0,.15d0,.275d0,.305d0,.355d0,.391d0,                            
     3 0.d0,.10d0,.15d0,.275d0,.305d0,.355d0,.391d0/                            
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2002                                                            
c                                                                               
      block data bloc02                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab02/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.d0,12000.d0,46700.d0,112850.d0,171950.d0,307050.d0,1.e29,              
     2 0.d0,10000.d0,37450.d0, 96700.d0,156600.d0,307050.d0,1.e29,              
     3 0.d0, 6000.d0,27950.d0, 67700.d0,141250.d0,307050.d0,1.e29/              
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.27d0,.30d0,.35d0,.386d0,                               
     2 0.d0,.10d0,.15d0,.27d0,.30d0,.35d0,.386d0,                               
     3 0.d0,.10d0,.15d0,.27d0,.30d0,.35d0,.386d0/                               
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2003                                                            
c                                                                               
      block data bloc03                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab03/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.d0,14000.d0,56800.d0,114650.d0,174700.d0,311950.d0,1.e29,              
     2 0.d0,10000.d0,38050.d0, 98250.d0,159100.d0,311950.d0,1.e29,              
     3 0.d0, 7000.d0,28400.d0, 68800.d0,143500.d0,311950.d0,1.e29/              
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2004                                                            
c                                                                               
      block data bloc04                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab04/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.d0,14300.d0,58100.d0,117250.d0,178650.d0,319100.d0,1.e29,              
     2 0.d0,10200.d0,38900.d0,100500.d0,162700.d0,319100.d0,1.e29,              
     3 0.d0, 7150.d0,29050.d0, 70350.d0,146750.d0,319100.d0,1.e29/              
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2005                                                            
c                                                                               
      block data bloc05                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab05/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.d0,14600.d0,59400.d0,119950.d0,182800.d0,326450.d0,1.e29,              
     2 0.d0,10450.d0,39800.d0,102800.d0,166450.d0,326450.d0,1.e29,              
     3 0.d0, 7300.d0,29700.d0, 71950.d0,150150.d0,326450.d0,1.e29/              
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2006                                                            
c                                                                               
      block data bloc06                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab06/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.,15100.d0,61300.d0,123700.d0,188450.d0,336550.d0,1.e29,                
     2 0.,10750.d0,41050.d0,106000.d0,171650.d0,336550.d0,1.e29,                
     3 0., 7550.d0,30650.d0, 74200.d0,154800.d0,336550.d0,1.e29/                
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2007                                                            
c                                                                               
      block data bloc07                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab07/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.,15650.d0,63700.d0,128500.d0,195850.d0,349700.d0,1.e29,                
     2 0.,11200.d0,42650.d0,110100.d0,178350.d0,349700.d0,1.e29,                
     3 0., 7825.d0,31850.d0, 77100.d0,160850.d0,349700.d0,1.e29/                
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2008                                                            
c                                                                               
      block data bloc08                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab08/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.,16050.d0,65100.d0,131450.d0,200300.d0,357700.d0,1.e29,                
     2 0.,11450.d0,43650.d0,112650.d0,182400.d0,357700.d0,1.e29,                
     3 0., 8025.d0,32550.d0, 78850.d0,164550.d0,357700.d0,1.e29/                
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c                                                                               
c  tax brackets 2009                                                            
c                                                                               
      block data bloc09                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab09/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.d0,16700.d0,67900.d0,137050.d0,208850.d0,372950.d0,1.e29,              
     2 0.d0,11950.d0,45500.d0,117450.d0,190200.d0,372950.d0,1.e29,              
     3 0.d0, 8350.d0,33950.d0, 82250.d0,171550.d0,372950.d0,1.e29/              
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c                                                                               
c                                                                               
c  tax brackets 2010                                                            
c                                                                               
      block data bloc10                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab10/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.d0,16750.d0,68000.d0,137300.d0,209250.d0,373650.d0,1.e29,              
     2 0.d0,11950.d0,45550.d0,117650.d0,190550.d0,373650.d0,1.e29,              
     3 0.d0, 8375.d0,34000.d0, 82400.d0,171850.d0,373650.d0,1.e29/              
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2011                                                            
c                                                                               
      block data bloc11                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab11/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.d0,17000.d0,69000.d0,139350.d0,212300.d0,379150.d0,1.e29,              
     2 0.d0,12150.d0,46250.d0,119400.d0,193350.d0,379150.d0,1.e29,              
     3 0.d0, 8500.d0,34500.d0, 83600.d0,174400.d0,379150.d0,1.e29/              
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2012                                                            
c                                                                               
      block data bloc12                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab12/ toptab(21),tmrtab(21),ibeg(3)                              
      data ibeg /15,1,8/                                                        
      data toptab /                                                             
     1 0.d0,17400.d0,70700.d0,142700.d0,217450.d0,388350.d0,1.e29,              
     2 0.d0,12400.d0,47350.d0,122300.d0,198050.d0,388350.d0,1.e29,              
     3 0.d0, 8700.d0,35350.d0, 85650.d0,178650.d0,388350.d0,1.e29/              
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,                                
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0/                                
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2013                                                            
c                                                                               
      block data bloc13                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab13/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,17850.d0,72500.d0,146400.d0,223050.d0,398350.d0,                    
     1 450000.d0,1.e29,                                                         
     2 0.d0,12750.d0,48600.d0,125450.d0,203150.d0,398350.d0,                    
     2 425000.d0,1.e29,                                                         
     3 0.d0, 8925.d0,36250.d0, 87850.d0,183250.d0,398350.d0,                    
     3 400000.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0/                         
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2014                                                            
c                                                                               
      block data bloc14                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab14/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,18150.d0,73800.d0,148850.d0,226850.d0,405100.d0,                    
     1 457600.d0,1.e29,                                                         
     2 0.d0,12950.d0,49400.d0,127550.d0,206600.d0,405100.d0,                    
     2 432200.d0,1.e29,                                                         
     3 0.d0, 9075.d0,36900.d0, 89350.d0,186350.d0,405100.d0,                    
     3 406750.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0/                         
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2015                                                            
c                                                                               
      block data bloc15                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab15/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,18450.d0,74900.d0,151200.d0,230450.d0,411500.d0,                    
     1 464850.d0,1.e29,                                                         
     2 0.d0,13150.d0,50200.d0,129600.d0,209850.d0,411500.d0,                    
     2 439000.d0,1.e29,                                                         
     3 0.d0, 9225.d0,37450.d0, 90750.d0,189300.d0,411500.d0,                    
     3 413200.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0/                         
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2016                                                            
c                                                                               
      block data bloc16                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab16/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,18550.d0,75300.d0,151900.d0,231450.d0,413350.d0,                    
     1 466950.d0,1.e29,                                                         
     2 0.d0,13250.d0,50400.d0,130150.d0,210800.d0,413350.d0,                    
     2 441000.d0,1.e29,                                                         
     3 0.d0, 9275.d0,37650.d0, 91150.d0,190150.d0,413350.d0,                    
     3 415050.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0/                         
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2017                                                            
c                                                                               
      block data bloc17                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab17/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,18650.d0,75900.d0,153100.d0,233350.d0,416700.d0,                    
     1 470700.d0,1.e29,                                                         
     2 0.d0,13350.d0,50800.d0,131200.d0,212500.d0,416700.d0,                    
     2 444550.d0,1.e29,                                                         
     3 0.d0, 9325.d0,37950.d0, 91900.d0,191650.d0,416700.d0,                    
     3 418400.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     2 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0,                         
     3 0.d0,.10d0,.15d0,.25d0,.28d0,.33d0,.35d0,.396d0/                         
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2018                                                            
c                                                                               
      block data bloc18                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab18/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,19050.d0,77400.d0,165000.d0,315000.d0,400000.d0,                    
     1 600000.d0,1.e29,                                                         
     2 0.d0,13600.d0,51800.d0, 82500.d0,157500.d0,200000.d0,                    
     2 500000.d0,1.e29,                                                         
     3 0.d0, 9525.d0,38700.d0, 82500.d0,157500.d0,200000.d0,                    
     3 500000.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     2 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     3 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0/                          
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2019                                                            
c                                                                               
      block data bloc19                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab19/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,19400.d0,78950.d0,168400.d0,321450.d0,408200.d0,                    
     1 612350.d0,1.e29,                                                         
     2 0.d0,13850.d0,52850.d0, 84200.d0,160700.d0,204100.d0,                    
     2 510300.d0,1.e29,                                                         
     3 0.d0, 9700.d0,39475.d0, 84200.d0,160725.d0,204100.d0,                    
     3 510300.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     2 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     3 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0/                          
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2020                                                            
c                                                                               
      block data bloc20                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab20/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,19750.d0,80250.d0,171050.d0,326600.d0,414700.d0,                    
     1 622050.d0,1.e29,                                                         
     2 0.d0,14100.d0,53700.d0, 85500.d0,163300.d0,207350.d0,                    
     2 518400.d0,1.e29,                                                         
     3 0.d0, 9875.d0,40125.d0, 85525.d0,163300.d0,207350.d0,                    
     3 518400.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     2 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     3 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0/                          
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2021                                                            
c                                                                               
      block data bloc21                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab21/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,19900.d0,81050.d0,172750.d0,329850.d0,418850.d0,                    
     1 628300.d0,1.e29,                                                         
     2 0.d0,14200.d0,54200.d0, 86350.d0,164900.d0,209400.d0,                    
     2 523600.d0,1.e29,                                                         
     3 0.d0, 9950.d0,40525.d0, 86375.d0,164925.d0,209425.d0,                    
     3 523600.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     2 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     3 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0/                          
c                                                                               
      end                                                                       
c                                                                               
c  tax brackets 2022                                                            
c                                                                               
      block data bloc22                                                         
      implicit double precision (A-H,O-Z)                                       
      common /tab22/ toptab(24),tmrtab(24),ibeg(3)                              
      data ibeg /17,1,9/                                                        
      data toptab /                                                             
     1 0.d0,20550.d0,83550.d0,178150.d0,340100.d0,431900.d0,                    
     1 647850.d0,1.e29,                                                         
     2 0.d0,14650.d0,55900.d0, 89050.d0,170050.d0,215950.d0,                    
     2 539900.d0,1.e29,                                                         
     3 0.d0,10275.d0,41775.d0, 89075.d0,170050.d0,215950.d0,                    
     3 539900.d0,1.e29/                                                         
      data tmrtab /                                                             
     1 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     2 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0,                          
     3 0.d0,.10d0,.12d0,.22d0,.24d0,.32d0,.35d0,.37d0/                          
c                                                                               
      end                                                                       
c                                                                               
c  initialization comnew                                                        
c                                                                               
      block data comout                                                         
      implicit double precision (A-H,O-Z)                                       
      common /newshr/ comnew(255)                                               
      data comnew/255*1.0d0/                                                    
c                                                                               
      end                                                                       
c                                                                               
c                                                                               
c  initialization xndxa                                                         
c                                                                               
      block data xndx                                                           
      implicit double precision (A-H,O-Z)                                       
      common /xndxac/ xndxa(1981:2023)                                          
c                                                                               
c 12.03.2018 2018+ inflation rate 2.5%                                          
        data xndxa /  .768d0, .815d0, .842d0, .879d0, .910d0, .927d0,           
     &        2*1.d0,1.041d0,1.091d0,1.144d0,1.204d0,1.241d0,1.279d0,           
     &       1.312d0,1.347d0,1.360d0,1.397d0,1.420d0,1.446d0,1.504d0,           
     &       1.554d0,1.579d0,1.620d0,1.660d0,1.702d0,1.744d0,1.788d0,           
     &       1.832d0,1.878d0,1.925d0,1.954d0,1.979d0,2.046d0,2.120d0,           
     &       2.196d0,2.276d0,2.3329d0,2.3912225d0,2.451003d0,2.512278d0,        
     &   2.5750849d0,2.639462d0/                                                
      end                                                                       
c                                                                               
c                                                                               
c  initialization ssmax                                                         
c                                                                               
      block data ssm                                                            
      implicit double precision (A-H,O-Z)                                       
      common /ssmaxa/ ssmax(1960:2029)                                          
      data ssmax/                                                               
     6   4800.d0,   4800.d0,   4800.d0,   4800.d0,   4800.d0,                   
     6   4800.d0,   6600.d0,   6600.d0,   7800.d0,   7800.d0,                   
     7   7800.d0,   7800.d0,   9000.d0,  10800.d0,  13200.d0,                   
     7  14100.d0,  15300.d0,  16500.d0,  17700.d0,  22900.d0,                   
     8  25900.d0,  29700.d0,  32400.d0,  35700.d0,  37800.d0,                   
     8  39600.d0,  42000.d0,  43800.d0,  45000.d0,  48000.d0,                   
     9  51300.d0,  53400.d0,  55500.d0,  57600.d0,  60600.d0,                   
     9  61200.d0,  62700.d0,  65400.d0,  68400.d0,  72600.d0,                   
     &  76200.d0,  80400.d0,  84900.d0,  87000.d0,  87900.d0,                   
     &  90000.d0,  94200.d0,  97500.d0, 102000.d0, 106800.d0,                   
     & 106800.d0, 106800.d0, 110100.d0, 113700.d0, 117000.d0,                   
     & 118500.d0, 118500.d0, 127200.d0, 128400.d0, 132900.d0,                   
     & 137700.d0, 142800.d0, 147000.d0, 153600.d0, 159300.d0,                   
     & 165300.d0, 171300.d0, 177300.d0, 183600.d0, 190200.d0/                   
c actual numbers through 2022. Please update 2023+ when it is available.        
c Inna's note from 03.21.2022                                                   
      end                                                                       
c                                                                               
c                                                                               
c  initialization amtpi                                                         
c                                                                               
      block data amptpi                                                         
      implicit double precision (A-H,O-Z)                                       
      common /psubr/ xndx,amtpi,almnpx,egtrra,almzbr,almst,enders,              
     &gjtrra,ratmul,cgmul,amtmul,tipra,wilhlc,extnd(0:100)                      
      data xndx/0.0d0/                                                          
      data amtpi/1.0d0/                                                         
      data almnpx/0.0d0/                                                        
      data egtrra/1.0d0/                                                        
      data almzbr/1.0d0/                                                        
      data almst/0.0d0/                                                         
c  initialization The President Tax Cut 2003                                    
c enders - continue gjtrra                                                      
      data enders/0.0d0/                                                        
      data gjtrra/0.0d0/                                                        
      data ratmul/1.0d0/                                                        
      data cgmul/1.0d0/                                                         
      data amtmul/1.0d0/                                                        
      data tipra/1.0d0/                                                         
c wilhlc for Mark Wilhelm                                                       
      data wilhlc/0.0d0/                                                        
      data extnd /101*0.0d0/                                                    
      end                                                                       
c                                                                               
c  parameter initialization for AMT                                             
c                                                                               
      block data almdat                                                         
      implicit double precision (A-H,O-Z)                                       
      common /alm/ almsp,almr1,almr2                                            
      data almsp/175000.0d0/                                                    
c almr1 - lower rate                                                            
      data almr1/.260d0/                                                        
c almr2 - higher rate                                                           
      data almr2/.280d0/                                                        
c                                                                               
      end                                                                       
c                                                                               
      block data params                                                         
      implicit double precision(A-H,O-Z)                                        
      common /user/ zbrack(3,1987:2023),exem(1987:2023),                        
     &crmax(1987:2023,0:3,1:2),ymax(1987:2023,0:3,1:2),                         
     1rtbase(1987:2023,0:3), rtless(1987:2023,0:3),                             
     2chmax(1998:2023),ealim(2001:2023),cphas(7)                                
      data zbrack/ 2540.d0, 3760.d0, 2540.d0, 3000.d0, 5000.d0, 4400.d0,        
     9             3100.d0, 5200.d0, 4550.d0, 3250.d0, 5450.d0, 4750.d0,        
     1             3400.d0, 5700.d0, 5000.d0, 3600.d0, 6000.d0, 5250.d0,        
     3             3700.d0, 6200.d0, 5450.d0, 3800.d0, 6350.d0, 5600.d0,        
     5             3900.d0, 6550.d0, 5750.d0, 4000.d0, 6700.d0, 5900.d0,        
     7             4150.d0, 6900.d0, 6050.d0, 4250.d0, 7100.d0, 6250.d0,        
     9             4300.d0, 7200.d0, 6350.d0, 4400.d0, 7350.d0, 6450.d0,        
     1             4550.d0, 7600.d0, 6650.d0, 4700.d0, 7850.d0, 6900.d0,        
     3             4750.d0, 9500.d0, 7000.d0, 4850.d0, 9700.d0, 7150.d0,        
     5             5000.d0,10000.d0, 7300.d0, 5150.d0,10300.d0, 7550.d0,        
     7             5350.d0,10700.d0, 7850.d0, 5450.d0,10900.d0, 8000.d0,        
     9             5700.d0,11400.d0, 8350.d0, 5700.d0,11400.d0, 8400.d0,        
     1             5800.d0,11600.d0, 8500.d0, 5950.d0,11900.d0, 8700.d0,        
     3             6100.d0,12200.d0, 8950.d0, 6200.d0,12400.d0, 9100.d0,        
     5             6300.d0,12600.d0, 9250.d0, 6300.d0,12600.d0, 9300.d0,        
     7             6350.d0,12700.d0, 9350.d0,12000.d0,24000.d0,18000.d0,        
     9            12200.d0,24400.d0,18350.d0,12400.d0,24800.d0,18650.d0,        
     1            12550.d0,25100.d0,18800.d0,12950.d0,25900.d0,19400.d0,        
     3            12950.d0,25900.d0,19400.d0/                                   
      data exem /                                                               
     & 1900.d0,1950.d0,2000.d0,2050.d0,2150.d0,2300.d0,2350.d0,2450.d0,         
     & 2500.d0,2550.d0,2650.d0,2700.d0,2750.d0,2800.d0,2900.d0,3000.d0,         
     & 3050.d0,3100.d0,3200.d0,3300.d0,3400.d0,3500.d0,2*3650.d0,               
     & 3700.d0,3800.d0,3900.d0,3950.d0,4000.d0,2*4050.d0,6*0.d0/                
      data crmax/                                                               
     &     0.d0,   0.d0,   0.d0,   0.d0,   0.d0,   0.d0,   0.d0, 306.d0,        
     &   314.d0, 323.d0, 332.d0, 341.d0, 347.d0, 353.d0, 364.d0, 376.d0,        
     &   382.d0, 390.d0, 399.d0, 412.d0, 428.d0, 438.d0, 457.d0, 457.d0,        
     &   464.d0, 475.d0, 487.d0, 496.d0, 503.d0, 506.d0, 510.d0, 519.d0,        
     &   529.d0, 538.d0,1502.d0,2*560.d0,                                       
     1   851.d0, 874.d0, 910.d0, 953.d0,1192.d0,1324.d0,1434.d0,2038.d0,        
     1  2094.d0,2152.d0,2210.d0,2271.d0,2312.d0,2353.d0,2428.d0,2506.d0,        
     1  2547.d0,2604.d0,2662.d0,2747.d0,2853.d0,2917.d0,3043.d0,3050.d0,        
     1  3094.d0,3169.d0,3250.d0,3305.d0,3359.d0,3373.d0,3400.d0,3461.d0,        
     1  3526.d0,3584.d0,3618.d0,2*3733.d0,                                      
     2   851.d0, 874.d0, 910.d0, 953.d0,1235.d0,1384.d0,1511.d0,2528.d0,        
     2  3110.d0,3556.d0,3656.d0,3756.d0,3816.d0,3888.d0,4008.d0,4140.d0,        
     2  4204.d0,4300.d0,4400.d0,4536.d0,4716.d0,4824.d0,5028.d0,5036.d0,        
     2  5112.d0,5236.d0,5372.d0,5460.d0,5548.d0,5572.d0,5616.d0,5716.d0,        
     2  5828.d0,5920.d0,5980.d0,2*6164.d0,                                      
     3   851.d0, 874.d0, 910.d0, 953.d0,1235.d0,1384.d0,1511.d0,2528.d0,        
     3  3110.d0,3556.d0,3656.d0,3756.d0,3816.d0,3888.d0,4008.d0,4140.d0,        
     3  4204.d0,4300.d0,4400.d0,4536.d0,4716.d0,4824.d0,5657.d0,5666.d0,        
     3  5751.d0,5891.d0,6044.d0,6143.d0,6242.d0,6269.d0,6318.d0,6431.d0,        
     3  6557.d0,6660.d0,6728.d0,2*6935.d0,                                      
     &     0.d0,   0.d0,   0.d0,   0.d0,   0.d0,   0.d0,   0.d0, 306.d0,        
     &   314.d0, 323.d0, 332.d0, 341.d0, 347.d0, 353.d0, 364.d0, 376.d0,        
     &   382.d0, 390.d0, 399.d0, 412.d0, 428.d0, 438.d0, 457.d0, 457.d0,        
     &   464.d0, 475.d0, 487.d0, 496.d0, 503.d0, 506.d0, 510.d0, 519.d0,        
     &   529.d0, 538.d0,1502.d0,2*560.d0,                                       
     1   851.d0, 874.d0, 910.d0, 953.d0,1192.d0,1324.d0,1434.d0,2038.d0,        
     1  2094.d0,2152.d0,2210.d0,2271.d0,2312.d0,2353.d0,2428.d0,2506.d0,        
     1  2547.d0,2604.d0,2662.d0,2747.d0,2853.d0,2917.d0,3043.d0,3050.d0,        
     1  3094.d0,3169.d0,3250.d0,3305.d0,3359.d0,3373.d0,3400.d0,3461.d0,        
     1  3526.d0,3584.d0,3618.d0,2*3733.d0,                                      
     2   851.d0, 874.d0, 910.d0, 953.d0,1235.d0,1384.d0,1511.d0,2528.d0,        
     2  3110.d0,3556.d0,3656.d0,3756.d0,3816.d0,3888.d0,4008.d0,4140.d0,        
     2  4204.d0,4300.d0,4400.d0,4536.d0,4716.d0,4824.d0,5028.d0,5036.d0,        
     2  5112.d0,5236.d0,5372.d0,5460.d0,5548.d0,5572.d0,5616.d0,5716.d0,        
     2  5828.d0,5920.d0,5980.d0,2*6164.d0,                                      
     3   851.d0, 874.d0, 910.d0, 953.d0,1235.d0,1384.d0,1511.d0,2528.d0,        
     3  3110.d0,3556.d0,3656.d0,3756.d0,3816.d0,3888.d0,4008.d0,4140.d0,        
     3  4204.d0,4300.d0,4400.d0,4536.d0,4716.d0,4824.d0,5657.d0,5666.d0,        
     3  5751.d0,5891.d0,6044.d0,6143.d0,6242.d0,6269.d0,6318.d0,6431.d0,        
     3  6557.d0,6660.d0,6728.d0,2*6935.d0/                                      
      data ymax/  7*0.d0, 5000.d0, 5150.d0, 5300.d0, 5450.d0, 5600.d0,          
     &  5700.d0, 5800.d0, 5950.d0, 6050.d0, 6240.d0, 6390.d0, 6550.d0,          
     &  6740.d0, 7000.d0, 7160.d0, 7470.d0, 7480.d0, 7590.d0, 7750.d0,          
     &  7970.d0,  8110.d0, 8250.d0,8270.d0,8340.d0,8490.d0,8650.d0,             
     &  8790.d0,11610.d0,2*8790.d0,                                             
     1   6920.d0, 9840.d0,10240.d0,10730.d0,11250.d0,11840.d0,12200.d0,         
     1  11000.d0,11290.d0,11610.d0,11930.d0,12260.d0,12460.d0,12690.d0,         
     1  13090.d0,13520.d0,13730.d0,14040.d0,14370.d0,14810.d0,15390.d0,         
     1  15740.d0,16420.d0,16460.d0,16690.d0,17100.d0,                           
     1  17530.d0,17830.d0,18150.d0,18190.d0,18340.d0,18660.d0,19030.d0,         
     1  19330.d0,19520.d0,2*20130.d0,                                           
     2   6920.d0, 9840.d0,10240.d0,10730.d0,11250.d0,11840.d0,12200.d0,         
     2  11000.d0,11290.d0,11610.d0,11930.d0,12260.d0,12460.d0,12690.d0,         
     2  13090.d0,13520.d0,13730.d0,14040.d0,14370.d0,14810.d0,15390.d0,         
     2  15740.d0,16420.d0,16460.d0,16690.d0,17100.d0,                           
     2  17530.d0,17830.d0,18150.d0,18190.d0,18340.d0,18660.d0,19030.d0,         
     2  19330.d0,19520.d0,2*20130.d0,                                           
     3   6920.d0, 9840.d0,10240.d0,10730.d0,11250.d0,11840.d0,12200.d0,         
     3  11000.d0,11290.d0,11610.d0,11930.d0,12260.d0,12460.d0,12690.d0,         
     3  13090.d0,13520.d0,13730.d0,14040.d0,14370.d0,14810.d0,15390.d0,         
     3  15740.d0,16420.d0,16460.d0,16690.d0,17100.d0,                           
     3  17530.d0,17830.d0,18150.d0,18190.d0,18340.d0,18660.d0,19030.d0,         
     3  19330.d0,19520.d0,2*20130.d0,                                           
     &  7*0.d0, 5000.d0, 5150.d0, 5300.d0, 5450.d0, 5600.d0, 5700.d0,           
     & 5800.d0, 5950.d0, 7050.d0, 7240.d0, 7390.d0, 8550.d0, 8750.d0,           
     & 9000.d0,10160.d0,12470.d0,12490.d0,12590.d0,13000.d0,13310.d0,           
     &13540.d0,13750.d0,13820.d0,13930.d0,14170.d0,14450.d0,14680.d0,           
     &17550.d0,2*14680.d0,                                                      
     1 6920.d0, 9840.d0,10240.d0,10730.d0,11250.d0,11840.d0,12200.d0,           
     111000.d0,11300.d0,11650.d0,11950.d0,12300.d0,12500.d0,12700.d0,           
     113090.d0,14520.d0,14730.d0,15040.d0,16400.d0,16850.d0,17390.d0,           
     118740.d0,21420.d0,21460.d0,21690.d0,22300.d0,22870.d0,23260.d0,           
     123650.d0,23740.d0,23930.d0,24350.d0,24820.d0,25220.d0,25470.d0,           
     1 2*26260.d0,                                                              
     2 6920.d0, 9840.d0,10240.d0,10730.d0,11250.d0,11840.d0,12200.d0,           
     211000.d0,11300.d0,11650.d0,11950.d0,12300.d0,12500.d0,12700.d0,           
     213090.d0,14520.d0,14730.d0,15040.d0,16370.d0,16810.d0,17390.d0,           
     218740.d0,21420.d0,21460.d0,21690.d0,22300.d0,22870.d0,23260.d0,           
     223650.d0,23740.d0,23930.d0,24350.d0,24820.d0,25220.d0,25470.d0,           
     2 2*26260.d0,                                                              
     3 6920.d0, 9840.d0,10240.d0,10730.d0,11250.d0,11840.d0,12200.d0,           
     311000.d0,11300.d0,11650.d0,11950.d0,12300.d0,12500.d0,12700.d0,           
     313090.d0,14520.d0,14730.d0,15040.d0,16370.d0,16810.d0,17390.d0,           
     318740.d0,21420.d0,21460.d0,21790.d0,22300.d0,22870.d0,23260.d0,           
     323650.d0,23740.d0,23930.d0,24350.d0,24820.d0,25220.d0,25470.d0,           
     3 2*26260.d0/                                                              
c           1      2      3      4      5      6      7      8                  
      data rtbase/                                                              
c          1     2     3     4     5     6     7     8     9    10              
     &.00d0,.00d0,.00d0,.00d0,.00d0,.00d0,.00d0,.0765d0,.0765d0,.0765d0,        
     &.0765d0,.0765d0,.0765d0,.0765d0,20*.0765d0,.153d0,2*.0765d0,              
     1.14d0,.14d0,.14d0,.14d0,.167d0,.176d0,.185d0,.26d0,.34d0,.34d0,           
     1.34d0,.34d0,.34d0,.34d0,23*.34d0,                                         
     2.14d0,.14d0,.14d0,.14d0,.1703d0,.184d0,.195d0,.3d0,.36d0,.4d0,            
     2.4d0,.4d0,.4d0,.4d0,23*.4d0,                                              
     3.14d0,.14d0,.14d0,.14d0,.1703d0,.184d0,.195d0,.3d0,.36d0,.4d0,            
     3.4d0,.4d0,.4d0,.4d0,8*.4d0,15*.45d0 /                                     
      data rtless/                                                              
c          1     2     3     4     5     6     7     8     9    10              
     & .0d0,.0d0,.0d0,.0d0,.0d0,.0d0,.0d0,.0765d0,.0765d0,.0765d0,              
     & .0765d0,.0765d0,.0765d0,.0765d0,20*.0765d0,.153d0,02*.0765d0,            
     1 .1d0,.1d0,.1d0,.1d0,.1193d0,.1257d0,.1321d0,.1598d0,.1598d0,             
     1 .1598d0,.1598d0,.1598d0,.1598d0,.1598d0,23*.1598d0,                      
     2 .1d0,.1d0,.1d0,.1d0,.1236d0,.1314d0,.1393d0,.1768d0,.2022d0,             
     2 .2106d0,.2106d0,.2106d0,.2106d0,.2106d0,23*.2106d0,                      
     3 .1d0,.1d0,.1d0,.1d0,.1236d0,.1314d0,.1393d0,.1768d0,.2022d0,             
     3 .2106d0,.2106d0,.2106d0,.2106d0,.2106d0,23*.2106d0/                      
      data chmax /400.d0,2*500.d0,2*600.d0,15*1000.d0,6*2000.d0/                
      data ealim/10000.d0,10350.d0,10500.d0,10750.d0,11000.d0,11300.d0,         
     & 11750.d0,8500.d0,9*3000.d0,6*2500.d0/                                    
      data cphas /                                                              
     &75000.d0,110000.d0,55000.d0,75000.d0,110000.d0,55000.d0,75000.d0/         
      end                                                                       
                                                                                
      function saletx(data,lawyr)                                               
c from http://www.nber.org/~taxsim/salestax                                     
c for years past LASTYR, use LASTYR and deflate data                            
      implicit double precision(a-h,o-z)                                        
       parameter (LASTYR=2015)                                                  
      common/newshr/comnew(255)                                                 
      common/xndxac/xndxa(1981:2023)                                            
      dimension data(255)                                                       
      dimension x(1:3,1:51,2004:LASTYR)                                         
      data x/                                                                   
     &  1.912,.3941,.2443,  0.000,.0000,.0000,  1.698,.4311,.1692,              
     &  2.394,.3854,.2375,  1.843,.4253,.1918,  0.847,.4440,.1828,              
     &  1.668,.4363,.1914,  0.000,.0000,.0000,  1.520,.4482,.1931,              
     &  1.942,.4236,.1862,  1.098,.4635,.2000,  1.901,.4079,.2418,              
     &  2.122,.4079,.2422,  2.564,.3791,.2583,  1.733,.4404,.1933,              
     &  1.403,.4531,.1886,  2.162,.3996,.2430,  1.569,.4464,.1952,              
     &  1.167,.4419,.1892,  1.079,.4724,.1828,  0.763,.4960,.2126,              
     &  1.166,.4688,.1729,  1.909,.4144,.1735,  1.704,.4444,.1766,              
     &  2.592,.3826,.2427,  2.044,.3922,.2453,  0.000,.0000,.0000,              
     &  1.477,.4499,.1842,  1.229,.4717,.2169,  0.000,.0000,.0000,              
     &  1.419,.4558,.2049,  2.156,.3949,.2328,  1.036,.4596,.2181,              
     &  1.463,.4338,.1706,  1.379,.4510,.1799,  1.698,.4407,.1721,              
     &  2.161,.3814,.2379,  0.000,.0000,.0000,  1.038,.4845,.2021,              
     &  1.212,.4726,.1735,  2.183,.3943,.2369,  1.369,.4418,.2713,              
     &  2.779,.3620,.2415,  1.748,.4386,.1834,  2.086,.3945,.2463,              
     &  0.787,.5013,.2050,  1.714,.4080,.2462,  1.970,.4191,.1698,              
     &  2.521,.3863,.2382,  1.276,.4625,.1806,  2.063,.3946,.2445,              
     &  0.929,.4717,.2670,  0.000,.0000,.0000, -0.457,.6164,.2063,              
     &  0.963,.5146,.2610, -0.395,.6166,.2154, -0.640,.5619,.1993,              
     & -0.505,.6187,.1759,  0.000,.0000,.0000, -0.696,.6228,.1946,              
     & -0.260,.6002,.2291, -0.252,.5621,.1844,  0.600,.5149,.2637,              
     &  1.247,.4712,.2691, -0.189,.5963,.2226,  0.334,.5440,.2118,              
     & -0.324,.5981,.2075,  0.919,.5033,.2789,  0.231,.5519,.2032,              
     & -0.570,.6000,.1944, -0.795,.6151,.2213, -0.447,.5993,.2145,              
     & -0.495,.5946,.1822, -0.196,.5953,.2153, -0.403,.6106,.1952,              
     &  1.122,.5142,.2607,  0.024,.5441,.2170,  0.000,.0000,.0000,              
     & -0.244,.5992,.1993, -0.107,.5945,.2082,  0.000,.0000,.0000,              
     & -0.490,.6164,.1838, -0.285,.5982,.2045, -0.603,.6033,.2097,              
     & -0.381,.5879,.2284, -0.355,.5923,.2238, -0.063,.5852,.2085,              
     &  0.470,.5278,.2553,  0.000,.0000,.0000, -0.379,.6032,.1980,              
     & -0.263,.6053,.1921,  0.815,.5052,.2817,  0.549,.5159,.2663,              
     &  0.912,.5288,.2566, -0.158,.6017,.2103,  0.775,.5083,.2696,              
     & -1.467,.6759,.1696,  0.071,.5493,.2109,  0.015,.5893,.2130,              
     &  0.966,.5147,.2571, -0.348,.6006,.1972,  0.572,.5112,.2693,              
     &  0.793,.4898,.2324,  0.000,.0000,.0000, -0.543,.6345,.1111,              
     &  0.731,.5456,.1861, -0.220,.6224,.1087, -0.738,.5783,.1347,              
     & -0.584,.6375,.0790,  0.000,.0000,.0000, -0.871,.6481,.0852,              
     & -0.456,.6300,.1274, -0.307,.5736,.1299,  0.405,.5441,.1804,              
     &  0.952,.5025,.2207,  0.042,.5909,.1379,  0.298,.5553,.1507,              
     & -0.450,.6219,.1035,  0.637,.5388,.2040,  0.148,.5666,.1467,              
     & -0.694,.6233,.0893, -0.890,.6362,.0950, -0.388,.6061,.1125,              
     & -0.530,.6074,.0921, -0.276,.6135,.1121, -0.429,.6291,.0826,              
     &  0.982,.5352,.1956, -0.111,.5659,.1580,  0.000,.0000,.0000,              
     & -0.372,.6231,.0906, -0.198,.6135,.1072,  0.000,.0000,.0000,              
     & -0.268,.6141,.0946, -0.433,.6255,.0935, -0.838,.6247,.1026,              
     & -0.357,.5972,.1275, -0.464,.6138,.1216, -0.320,.6171,.0978,              
     &  0.262,.5567,.1813,  0.000,.0000,.0000, -0.340,.6097,.1078,              
     & -0.170,.6067,.1044,  0.518,.5409,.1941,  0.341,.5450,.1900,              
     &  0.811,.5487,.1817, -0.279,.6248,.1088,  0.511,.5418,.1984,              
     & -1.319,.6764,.0411,  0.339,.5378,.1816, -0.161,.6180,.1045,              
     &  0.739,.5453,.1825, -0.502,.6266,.0949, -0.164,.5804,.1510,              
     &  0.969,.4679,.3092,  0.000,.0000,.0000,  0.126,.5648,.2314,              
     &  1.176,.4953,.2678,  0.249,.5704,.2308, -0.605,.5587,.2386,              
     &  0.239,.5547,.1953,  0.000,.0000,.0000, -0.021,.5631,.2097,              
     &  0.293,.5513,.2567, -0.158,.5546,.2228,  1.006,.4822,.2827,              
     &  1.295,.4774,.3015,  0.477,.5446,.2404,  0.510,.5347,.2342,              
     &  0.394,.5370,.2277,  1.234,.4805,.2872,  0.376,.5420,.2305,              
     & -0.009,.5514,.2139, -0.299,.5713,.2294,  0.063,.5598,.2255,              
     & -0.126,.5640,.2092,  0.181,.5670,.2160,  0.041,.5760,.1996,              
     &  1.531,.4807,.2809,  0.218,.5260,.2708,  0.000,.0000,.0000,              
     &  0.364,.5511,.2045,  0.331,.5583,.2134,  0.000,.0000,.0000,              
     &  0.479,.5486,.1979,  0.372,.5467,.2104, -0.093,.5500,.1977,              
     &  0.162,.5401,.2354,  0.072,.5569,.2414,  0.280,.5556,.2047,              
     &  0.703,.5092,.2810,  0.000,.0000,.0000,  0.029,.5714,.1965,              
     &  0.316,.5620,.1795,  0.608,.5302,.2516,  0.959,.4823,.2830,              
     &  1.371,.4895,.2794,  0.527,.5433,.2336,  0.640,.5190,.2471,              
     & -0.323,.5844,.1463,  0.442,.5248,.2623,  0.523,.5508,.2144,              
     &  1.073,.5049,.2538,  0.287,.5481,.2056, -0.021,.5499,.2247,              
     &  0.970,.4714,.2756,  0.000,.0000,.0000, -0.010,.5798,.1826,              
     &  0.779,.5309,.2131,  0.089,.5889,.1813, -0.639,.5654,.1930,              
     &  0.032,.5772,.1448,  0.000,.0000,.0000, -0.305,.5887,.1646,              
     &  0.022,.5793,.2038, -0.128,.5530,.1886,  0.934,.4941,.2344,              
     &  1.310,.4790,.2694,  0.338,.5591,.1968,  0.618,.5362,.2000,              
     &  0.164,.5697,.1906,  1.148,.4888,.2655,  0.399,.5404,.2005,              
     & -0.205,.5729,.1692, -0.477,.5900,.1718,  0.121,.5726,.1678,              
     & -0.257,.5762,.1482,  0.127,.5721,.1765, -0.145,.5965,.1474,              
     &  1.448,.4906,.2493, -0.054,.5634,.1972,  0.000,.0000,.0000,              
     &  0.188,.5678,.1708,  0.231,.5696,.1736,  0.000,.0000,.0000,              
     &  0.104,.5843,.1481,  0.264,.5583,.1655, -0.403,.5809,.1502,              
     &  0.454,.5250,.2202, -0.051,.5704,.1913,  0.107,.5720,.1680,              
     &  0.714,.5114,.2476,  0.000,.0000,.0000,  0.012,.5722,.1629,              
     &  0.526,.5343,.1650,  0.144,.5739,.1718,  0.823,.4985,.2475,              
     &  1.125,.5156,.2322,  0.254,.5709,.1914,  0.598,.5235,.2214,              
     & -0.243,.5646,.1394,  0.281,.5201,.2269,  0.270,.5728,.1760,              
     &  0.826,.5264,.2153,  0.089,.5681,.1720, -0.299,.5788,.1741,              
     &  0.568,.5108,.2045,  0.000,.0000,.0000, -0.278,.6095,.0996,              
     &  0.434,.5662,.1407, -0.162,.6257,.0943, -0.936,.5996,.0975,              
     & -0.207,.6043,.0806,  0.000,.0000,.0000, -0.757,.6386,.0673,              
     & -0.343,.6217,.1086, -0.562,.5963,.1000,  0.724,.5176,.1736,              
     &  0.795,.5287,.2045,  0.012,.5843,.1283,  0.402,.5645,.1195,              
     &  0.074,.5924,.1155,  0.825,.5231,.2047, -0.243,.6061,.1184,              
     & -0.662,.6187,.0994, -0.988,.6430,.0752, -0.221,.5996,.1120,              
     & -0.579,.6093,.0775, -0.207,.5988,.1093, -0.322,.6201,.0836,              
     &  1.094,.5288,.1827, -0.424,.5929,.1433,  0.000,.0000,.0000,              
     & -0.057,.5963,.1030, -0.088,.5970,.1087,  0.000,.0000,.0000,              
     & -0.307,.6263,.0762, -0.126,.5972,.1062, -0.799,.6228,.0717,              
     & -0.023,.5782,.1141, -0.520,.6067,.1504, -0.181,.6034,.0931,              
     &  0.230,.5580,.1869,  0.000,.0000,.0000, -0.339,.6089,.0808,              
     &  0.207,.5678,.0940,  0.032,.5905,.0944,  0.552,.5281,.1836,              
     &  0.809,.5421,.1801,  0.096,.5915,.1228,  0.162,.5682,.1583,              
     & -0.953,.6350,.0557, -0.190,.5665,.1522, -0.141,.6152,.1085,              
     &  0.325,.5748,.1507, -0.165,.5967,.1061, -0.726,.6224,.1007,              
     &  1.831,.3944,.2779,  0.000,.0000,.0000,  0.804,.5145,.2235,              
     &  1.273,.4827,.2433,  1.089,.5111,.2085,  0.587,.4580,.2023,              
     &  0.774,.5094,.1974,  0.000,.0000,.0000,  0.313,.5340,.2138,              
     &  0.908,.5071,.2191,  0.903,.4592,.1981,  1.501,.4426,.2700,              
     &  0.962,.5044,.2395,  2.163,.4064,.2809,  1.580,.4492,.2147,              
     &  1.470,.4479,.2129,  1.738,.4444,.2972,  1.319,.4605,.2094,              
     &  0.503,.5078,.2135,  0.248,.5253,.2089,  1.255,.4624,.2006,              
     &  1.210,.4597,.1618,  1.264,.4621,.1981,  0.806,.5153,.2084,              
     &  1.954,.4461,.2819,  1.016,.4584,.2421,  0.000,.0000,.0000,              
     &  0.843,.5073,.2254,  1.496,.4527,.1944,  0.000,.0000,.0000,              
     &  0.935,.5090,.1983,  0.714,.5044,.2302,  0.421,.5071,.2071,              
     &  1.289,.4731,.2534,  1.057,.4613,.2266,  0.872,.5021,.2097,              
     &  1.317,.4570,.2817,  0.000,.0000,.0000,  0.788,.5024,.1965,              
     &  1.515,.4446,.1861,  0.960,.4996,.2164,  1.339,.4511,.2907,              
     &  2.171,.4151,.2651,  0.998,.5025,.2376,  1.201,.4694,.2633,              
     &  1.096,.4462,.1428,  1.187,.4385,.2388,  0.929,.5118,.2360,              
     &  1.306,.4806,.2622,  0.829,.5003,.2274,  0.459,.5093,.2190,              
     &  1.572,.4186,.2361,  0.000,.0000,.0000,  0.606,.5387,.1454,              
     &  1.000,.5077,.1668,  0.653,.5450,.1288,  0.316,.4831,.1429,              
     &  0.556,.5395,.1206,  0.000,.0000,.0000,  0.261,.5423,.1028,              
     &  0.592,.5371,.1321,  0.559,.4910,.1474,  1.175,.4739,.2031,              
     &  1.870,.4304,.2327,  1.319,.4621,.1639,  1.349,.4729,.1524,              
     &  0.565,.5424,.1543,  1.783,.4489,.2379,  0.867,.5032,.1434,              
     &  0.163,.5397,.1264,  0.192,.5309,.1105,  0.602,.5265,.1501,              
     &  0.843,.4881,.1070,  0.888,.4959,.1398,  0.369,.5571,.1195,              
     &  1.810,.4611,.2176,  0.697,.4898,.1791,  0.000,.0000,.0000,              
     &  0.569,.5332,.1448,  1.058,.4924,.1364,  0.000,.0000,.0000,              
     &  0.547,.5461,.1037,  0.393,.5508,.1006,  0.072,.5401,.1097,              
     &  1.105,.4818,.1904,  0.849,.4804,.1673,  0.562,.5317,.1282,              
     &  1.189,.4695,.2232,  0.000,.0000,.0000,  0.502,.5283,.1082,              
     &  1.204,.4738,.1200,  0.644,.5296,.1366,  1.154,.4695,.2243,              
     &  1.593,.4752,.1993,  0.708,.5310,.1540,  0.998,.4898,.1900,              
     &  0.629,.4891,.0679,  0.918,.4618,.1819,  0.547,.5480,.1402,              
     &  1.104,.5015,.1967,  0.536,.5288,.1417,  0.127,.5418,.1270,              
     &  1.629,.4168,.2130,  0.000,.0000,.0000,  0.908,.5175,.1088,              
     &  1.239,.4907,.1341,  1.005,.5134,.0979,  0.322,.4842,.1315,              
     &  1.128,.5009,.1098,  0.000,.0000,.0000,  0.525,.5206,.1007,              
     &  0.969,.5081,.1055,  0.586,.4907,.1286,  1.590,.4404,.1904,              
     &  1.910,.4291,.2153,  1.179,.4776,.1376,  1.382,.4720,.1405,              
     &  1.053,.5042,.1206,  1.960,.4380,.2096,  1.041,.4891,.1301,              
     &  0.539,.5104,.1013,  0.414,.5154,.1011,  0.889,.5040,.1195,              
     &  1.004,.4740,.1183,  1.039,.4846,.1208,  1.010,.5043,.0972,              
     &  2.095,.4409,.1884,  0.766,.4854,.1590,  0.000,.0000,.0000,              
     &  0.958,.5040,.1113,  1.293,.4738,.1174,  0.000,.0000,.0000,              
     &  1.099,.5000,.0924,  1.153,.4857,.1069,  0.575,.4964,.0979,              
     &  1.224,.4684,.1612,  0.787,.4872,.1497,  0.963,.5009,.1025,              
     &  1.428,.4544,.1914,  0.000,.0000,.0000,  1.047,.4801,.1085,              
     &  1.380,.4592,.1246,  1.091,.4954,.1023,  1.441,.4490,.1953,              
     &  1.831,.4582,.1728,  1.105,.5004,.1235,  1.291,.4687,.1604,              
     &  1.027,.4507,.1033,  0.858,.4688,.1704,  1.044,.5082,.1134,              
     &  1.239,.4906,.1416,  0.914,.4997,.1160,  0.570,.5069,.1006,              
     &  1.233,.4510,.2339,  0.000,.0000,.0000, -0.351,.6169,.1507,              
     &  0.379,.5680,.1592,  0.067,.5958,.1345, -0.085,.5182,.1586,              
     &  0.190,.5805,.1397,  0.000,.0000,.0000, -0.618,.6186,.1187,              
     &  0.007,.5899,.1387,  0.035,.5382,.1536,  0.171,.5630,.2236,              
     &  1.558,.4602,.2324,  0.862,.5037,.1647,  0.934,.5108,.1597,              
     &  0.010,.5922,.1600,  1.214,.5025,.2270,  0.539,.5312,.1586,              
     & -0.404,.5915,.1283, -0.636,.6063,.1241, -0.105,.5865,.1543,              
     &  0.420,.5273,.1247,  0.539,.5273,.1478, -0.166,.6062,.1179,              
     &  1.311,.5088,.2072,  0.227,.5311,.1901,  0.000,.0000,.0000,              
     & -0.108,.5948,.1499,  0.845,.5113,.1445,  0.000,.0000,.0000,              
     & -0.010,.5955,.1096, -0.743,.6476,.1632, -0.530,.5928,.1094,              
     &  0.431,.5360,.1867,  0.408,.5212,.1675,  0.029,.5813,.1287,              
     &  0.710,.5161,.2058,  0.000,.0000,.0000, -0.119,.5807,.1237,              
     &  0.808,.5112,.1266,  0.033,.5849,.1433,  0.679,.5160,.2122,              
     &  0.981,.5312,.1907,  0.127,.5834,.1602,  0.466,.5395,.1842,              
     &  0.361,.5110,.0945,  0.599,.4952,.1825,  0.106,.5885,.1462,              
     &  0.065,.5881,.1649,  0.014,.5761,.1451, -0.361,.5868,.1299,              
     &  1.228,.4514,.2332,  0.000,.0000,.0000, -0.357,.6174,.1505,              
     &  0.368,.5690,.1592,  0.056,.5968,.1347, -0.082,.5180,.1578,              
     &  0.178,.5815,.1396,  0.000,.0000,.0000, -0.626,.6194,.1180,              
     & -0.004,.5908,.1392,  0.026,.5391,.1523,  0.161,.5639,.2237,              
     &  1.555,.4607,.2314,  0.857,.5042,.1647,  0.928,.5114,.1589,              
     & -0.001,.5932,.1601,  1.206,.5032,.2270,  0.534,.5318,.1577,              
     & -0.410,.5921,.1277, -0.639,.6066,.1246, -0.109,.5870,.1539,              
     &  0.415,.5278,.1243,  0.534,.5278,.1469, -0.171,.6067,.1174,              
     &  1.303,.5097,.2070,  0.220,.5318,.1892,  0.000,.0000,.0000,              
     & -0.118,.5956,.1502,  0.839,.5119,.1439,  0.000,.0000,.0000,              
     & -0.023,.5967,.1094, -0.757,.6489,.1633, -0.542,.5938,.1097,              
     &  0.423,.5367,.1866,  0.402,.5217,.1668,  0.020,.5822,.1289,              
     &  0.706,.5165,.2055,  0.000,.0000,.0000, -0.130,.5818,.1233,              
     &  0.805,.5115,.1262,  0.021,.5860,.1433,  0.666,.5172,.2122,              
     &  0.973,.5320,.1904,  0.116,.5844,.1605,  0.460,.5401,.1839,              
     &  0.355,.5116,.0940,  0.592,.4960,.1813,  0.096,.5895,.1459,              
     &  0.057,.5888,.1649,  0.003,.5771,.1451, -0.368,.5874,.1301,              
     &  1.228,.4514,.2332,  0.000,.0000,.0000, -0.357,.6174,.1505,              
     &  0.368,.5690,.1592,  0.056,.5968,.1347, -0.082,.5180,.1578,              
     &  0.178,.5815,.1396,  0.000,.0000,.0000, -0.626,.6194,.1180,              
     & -0.004,.5908,.1392,  0.026,.5391,.1523,  0.161,.5639,.2237,              
     &  1.555,.4607,.2314,  0.857,.5042,.1647,  0.928,.5114,.1589,              
     & -0.001,.5932,.1601,  1.206,.5032,.2270,  0.534,.5318,.1577,              
     & -0.410,.5921,.1277, -0.639,.6066,.1246, -0.109,.5870,.1539,              
     &  0.415,.5278,.1243,  0.534,.5278,.1469, -0.171,.6067,.1174,              
     &  1.303,.5097,.2070,  0.220,.5318,.1892,  0.000,.0000,.0000,              
     & -0.118,.5956,.1502,  0.839,.5119,.1439,  0.000,.0000,.0000,              
     & -0.023,.5967,.1094, -0.757,.6489,.1633, -0.542,.5938,.1097,              
     &  0.423,.5367,.1866,  0.402,.5217,.1668,  0.020,.5822,.1289,              
     &  0.706,.5165,.2055,  0.000,.0000,.0000, -0.130,.5818,.1233,              
     &  0.805,.5115,.1262,  0.021,.5860,.1433,  0.666,.5172,.2122,              
     &  0.973,.5320,.1904,  0.116,.5844,.1605,  0.460,.5401,.1839,              
     &  0.355,.5116,.0940,  0.592,.4960,.1813,  0.096,.5895,.1459,              
     &  0.057,.5888,.1649,  0.003,.5771,.1451, -0.368,.5874,.1301               
     & /                                                                        
      saletx = 0.                                                               
      is = int(data(6))                                                              
      iy = lawyr                                                                
      if(is.gt.51) return                                                       
      if(is.eq.0..or.iy.lt.2004) return                                         
      if(iy.gt.LASTYR) then                                                     
         iy = LASTYR                                                            
      else                                                                      
         iy = lawyr                                                             
      endif                                                                     
      hy = comnew(2)+data(91)-comnew(79)+data(41)                               
      dhy = (xndxa(iy)/xndxa(lawyr))*hy                                         
      if(hy.gt.0.and.data(7)+data(8).gt.0.) then                                
        saletx = exp(x(1,is,iy)+x(2,is,iy)*log(dhy)+                            
     &                x(3,is,iy)*log(data(8)+data(7)))                          
        saletx = saletx*xndxa(lawyr)/xndxa(iy)                                  
       else                                                                     
        saletx = 0.                                                             
       endif                                                                    
      return                                                                    
      end                                                                       
